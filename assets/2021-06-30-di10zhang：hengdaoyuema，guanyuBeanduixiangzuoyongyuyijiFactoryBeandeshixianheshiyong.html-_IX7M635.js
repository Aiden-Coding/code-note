import{_ as e,r as p,o as c,c as o,a as n,b as s,d as t,e as l}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"ã€Šspring-æ‰‹æ’¸ä¸“æ ã€‹ç¬¬-10-ç« -æ¨ªåˆ€è·ƒé©¬-å…³äºbeanå¯¹è±¡ä½œç”¨åŸŸä»¥åŠfactorybeançš„å®ç°å’Œä½¿ç”¨",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ã€Šspring-æ‰‹æ’¸ä¸“æ ã€‹ç¬¬-10-ç« -æ¨ªåˆ€è·ƒé©¬-å…³äºbeanå¯¹è±¡ä½œç”¨åŸŸä»¥åŠfactorybeançš„å®ç°å’Œä½¿ç”¨","aria-hidden":"true"},"#"),s(" ã€ŠSpring æ‰‹æ’¸ä¸“æ ã€‹ç¬¬ 10 ç« ï¼šæ¨ªåˆ€è·ƒé©¬ï¼Œå…³äºBeanå¯¹è±¡ä½œç”¨åŸŸä»¥åŠFactoryBeançš„å®ç°å’Œä½¿ç”¨")],-1),r=n("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=n("br",null,null,-1),v={href:"https://mp.weixin.qq.com/s/npVKYqHVTDgYWa2Jq8PB-A",target:"_blank",rel:"noopener noreferrer"},m=l(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>è€å¸æœºï¼Œä½ çš„ç –æ€ä¹ˆæ¬çš„é‚£ä¹ˆå¿«ï¼Ÿ</code></p><p>æ˜¯æœ‰åŠ²ï¼Ÿæ˜¯æŠ€å·§ï¼Ÿæ˜¯åé—¨ï¼Ÿæ€»ä¹‹ï¼Œé‚£ä¸ªè€å¸æœºçš„ä»£ç æ€»æ˜¯å¯ä»¥å¾ˆå¿«çš„å®Œæˆäº§å“æ¯æ¬¡æ–°å¢çš„éœ€æ±‚ï¼Œå°±åƒä»–ä¿©æ˜¯ä¸€å®¶ä¼¼çš„ï¼è€Œä½ å°±ä¸ä¸€æ ·äº†ï¼Œä¸åªäº§å“ç»ç†è¿˜æœ‰è¿è¥ã€æµ‹è¯•çš„å°å§å§ï¼Œéƒ½å¾—ç»™ä½ ä¹°åƒçš„ï¼Œæ±‚ç€ä½ èµ¶ç´§æŠŠBugä¿®ä¿®ï¼Œå¦åˆ™éƒ½æ¥ä¸åŠä¸Šçº¿äº†ã€‚</p><p>é‚£ä¸ºå•¥åˆ«äººçš„ä»£ç æ€»æ˜¯å¯ä»¥å¾ˆå¿«çš„æ‰©å±•æ–°åŠŸèƒ½ï¼Œè€Œä½ çš„ä»£ç ä»æ¥ä¸èƒ½è¢«é‡æ„åªèƒ½è¢«é‡å†™ï¼Œå°éœ€æ±‚å°æ”¹ã€å¤§éœ€æ±‚å¤§æ”¹ï¼Œæ²¡éœ€æ±‚å‘¢ï¼Ÿæ²¡éœ€æ±‚è‡ªå·±è·‘ç€è·‘ç€ä¹Ÿèƒ½å´©æºƒï¼ŒåŠå¤œè¢«è¿ç»´è–…èµ·æ¥ï¼šâ€œä½ è¿™æ€ä¹ˆåˆæœ‰æ•°æ®åº“æ…¢æŸ¥è¯¢ï¼ŒæŠŠåˆ«äººä¸šåŠ¡éƒ½æ‹–æ‹‰èƒ¯äº†ï¼â€</p><p><em>æœ‰äººè¯´30å²çš„äººéƒ½ï¼Œè¿˜å’Œåˆšæ¯•ä¸šçš„åšä¸€æ ·çš„æ´»ï¼Œæ˜¯æ²¡è¿›æ­¥çš„ï¼</em> è¿™å¤ªæ‰¯æ·¡äº†ï¼ŒåŒæ ·æ˜¯åŒæ ·çš„æ´»ï¼Œä½†åšå‡ºæ¥çš„ç»“æœå¯ä¸ä¸€å®šæ˜¯ä¸€æ ·çš„ï¼Œæœ‰äººèƒ½ç”¨<code>ifelse</code>æŠŠäº§å“åŠŸèƒ½å‡‘å‡ºæ¥ï¼Œä¹Ÿæœ‰äººå¯ä»¥æŠŠéœ€æ±‚æ‹†è§£æˆå„ä¸ªåŠŸèƒ½æ¨¡å—ï¼Œå®šä¹‰æ¥å£ã€æŠ½è±¡ç±»ã€å®ç°å’Œç»§æ‰¿ï¼Œè¿ç”¨è®¾è®¡æ¨¡å¼æ„å»ºå‡ºä¸€å¥—æ–°å¢éœ€æ±‚æ—¶å€™èƒ½å¿«é€Ÿå®ç°ï¼Œå‡ºç°é—®é¢˜èƒ½å‡†ç¡®å®šä½çš„ä»£ç é€»è¾‘ã€‚è¿™å°±åƒæœ‰äººé—®ï¼šâ€œæ ‘ä¸Šæœ‰ååªé¸Ÿï¼Œä¸€æªæ‰“æ­»ä¸€åªï¼Œè¿˜æœ‰å‡ åªï¼Ÿâ€ï¼Œä½ ä¼šæƒ³åˆ°ä»€ä¹ˆï¼Ÿæªå£°å¤§å—ã€é¸Ÿç¬¼äº†å—ã€é¸Ÿè¢«ç»‘æ ‘ä¸Šäº†å—ã€æœ‰é¸Ÿæ®‹ç–¾çš„å—ã€é¸Ÿè¢«æ‰“æ­»äº†å—ã€æ‰“é¸Ÿçš„äººçœ¼ç›å¥½ä½¿å—ã€ç®—è‚šå­é‡Œæ€€å­•çš„é¸Ÿå—ã€æ‰“é¸ŸçŠ¯æ³•å—ã€è¾¹ä¸Šæ ‘è¿˜æœ‰å…¶ä»–é¸Ÿå—ç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯ä¸€ä¸ªèŒä¸šæŠ€æœ¯äººåœ¨ä¸€ä¸ªè¡Œä¸šç£¨ç»ƒå‡ºæ¥çš„ç»éªŒï¼Œä¸æ˜¯1å¤©2å¤©çœ‹å‡ æœ¬ä¹¦ï¼Œåˆ·å‡ ä¸ªæ´—è„‘æ–‡ç« èƒ½å¸æ”¶çš„ã€‚</p><h2 id="äºŒã€ç›®æ ‡" tabindex="-1"><a class="header-anchor" href="#äºŒã€ç›®æ ‡" aria-hidden="true">#</a> äºŒã€ç›®æ ‡</h2><p>äº¤ç»™ Spring ç®¡ç†çš„ Bean å¯¹è±¡ï¼Œä¸€å®šå°±æ˜¯æˆ‘ä»¬ç”¨ç±»åˆ›å»ºå‡ºæ¥çš„ Bean å—ï¼Ÿåˆ›å»ºå‡ºæ¥çš„ Bean å°±æ°¸è¿œæ˜¯å•ä¾‹çš„å—ï¼Œæ²¡æœ‰å¯èƒ½æ˜¯åŸå‹æ¨¡å¼å—ï¼Ÿ</p><p>åœ¨é›†åˆ Spring æ¡†æ¶ä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„ MyBatis æ¡†æ¶ä¸­ï¼Œå®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯å¯ä»¥æ»¡è¶³ç”¨æˆ·ä¸éœ€è¦å®ç° Dao æ¥å£ç±»ï¼Œå°±å¯ä»¥é€šè¿‡ xml æˆ–è€…æ³¨è§£é…ç½®çš„æ–¹å¼å®Œæˆå¯¹æ•°æ®åº“æ‰§è¡Œ CRUD æ“ä½œï¼Œé‚£ä¹ˆåœ¨å®ç°è¿™æ ·çš„ ORM æ¡†æ¶ä¸­ï¼Œæ˜¯æ€ä¹ˆæŠŠä¸€ä¸ªæ•°æ®åº“æ“ä½œçš„ Bean å¯¹è±¡äº¤ç»™ Spring ç®¡ç†çš„å‘¢ã€‚</p><p>å› ä¸ºæˆ‘ä»¬åœ¨ä½¿ç”¨ Springã€MyBatis æ¡†æ¶çš„æ—¶å€™éƒ½å¯ä»¥çŸ¥é“ï¼Œå¹¶æ²¡æœ‰æ‰‹åŠ¨çš„å»åˆ›å»ºä»»ä½•æ“ä½œæ•°æ®åº“çš„ Bean å¯¹è±¡ï¼Œæœ‰çš„ä»…ä»…æ˜¯ä¸€ä¸ªæ¥å£å®šä¹‰ï¼Œè€Œè¿™ä¸ªæ¥å£å®šä¹‰ç«Ÿç„¶å¯ä»¥è¢«æ³¨å…¥åˆ°å…¶ä»–éœ€è¦ä½¿ç”¨ Dao çš„å±æ€§ä¸­å»äº†ï¼Œé‚£ä¹ˆè¿™ä¸€è¿‡ç¨‹æœ€æ ¸å¿ƒå¾…è§£å†³çš„é—®é¢˜ï¼Œå°±æ˜¯éœ€è¦å®ŒæˆæŠŠå¤æ‚ä¸”ä»¥ä»£ç†æ–¹å¼åŠ¨æ€å˜åŒ–çš„å¯¹è±¡ï¼Œæ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚è€Œä¸ºäº†æ»¡è¶³è¿™æ ·çš„ä¸€ä¸ªæ‰©å±•ç»„ä»¶å¼€å‘çš„éœ€æ±‚ï¼Œå°±éœ€è¦æˆ‘ä»¬åœ¨ç°æœ‰æ‰‹å†™çš„ Spring æ¡†æ¶ä¸­ï¼Œæ·»åŠ è¿™ä¸€èƒ½åŠ›ã€‚</p><h2 id="ä¸‰ã€æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€æ–¹æ¡ˆ" aria-hidden="true">#</a> ä¸‰ã€æ–¹æ¡ˆ</h2><p>å…³äºæä¾›ä¸€ä¸ªèƒ½è®©ä½¿ç”¨è€…å®šä¹‰å¤æ‚çš„ Bean å¯¹è±¡ï¼ŒåŠŸèƒ½ç‚¹éå¸¸ä¸é”™ï¼Œæ„ä¹‰ä¹Ÿéå¸¸å¤§ï¼Œå› ä¸ºè¿™æ ·åšäº†ä¹‹å Spring çš„ç”Ÿæ€ç§å­å­µåŒ–ç®±å°±æ­¤æä¾›äº†ï¼Œè°å®¶çš„æ¡†æ¶éƒ½å¯ä»¥åœ¨æ­¤æ ‡å‡†ä¸Šå®Œæˆè‡ªå·±æœåŠ¡çš„æ¥å…¥ã€‚</p><p>ä½†è¿™æ ·çš„åŠŸèƒ½é€»è¾‘è®¾è®¡ä¸Šå¹¶ä¸å¤æ‚ï¼Œå› ä¸ºæ•´ä¸ª Spring æ¡†æ¶åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­å°±å·²ç»æä¾›äº†å„é¡¹æ‰©å±•èƒ½åŠ›çš„<code>æ¥èŒ¬</code>ï¼Œä½ åªéœ€è¦åœ¨åˆé€‚çš„ä½ç½®æä¾›ä¸€ä¸ªæ¥èŒ¬çš„å¤„ç†æ¥å£è°ƒç”¨å’Œç›¸åº”çš„åŠŸèƒ½é€»è¾‘å®ç°å³å¯ï¼Œåƒè¿™é‡Œçš„ç›®æ ‡å®ç°å°±æ˜¯å¯¹å¤–æä¾›ä¸€ä¸ªå¯ä»¥äºŒæ¬¡ä» FactoryBean çš„ getObject æ–¹æ³•ä¸­è·å–å¯¹è±¡çš„åŠŸèƒ½å³å¯ï¼Œè¿™æ ·æ‰€æœ‰å®ç°æ­¤æ¥å£çš„å¯¹è±¡ç±»ï¼Œå°±å¯ä»¥æ‰©å……è‡ªå·±çš„å¯¹è±¡åŠŸèƒ½äº†ã€‚<em>MyBatis å°±æ˜¯å®ç°äº†ä¸€ä¸ª MapperFactoryBean ç±»ï¼Œåœ¨ getObject æ–¹æ³•ä¸­æä¾› SqlSession å¯¹æ‰§è¡Œ CRUD æ–¹æ³•çš„æ“ä½œ</em> æ•´ä½“è®¾è®¡ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://bugstack.cn/assets/images/spring/spring-10-01.png" alt=""></p><ul><li>æ•´ä¸ªçš„å®ç°è¿‡ç¨‹åŒ…æ‹¬äº†ä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªè§£å†³å•ä¾‹è¿˜æ˜¯åŸå‹å¯¹è±¡ï¼Œå¦å¤–ä¸€ä¸ªå¤„ç† FactoryBean ç±»å‹å¯¹è±¡åˆ›å»ºè¿‡ç¨‹ä¸­å…³äºè·å–å…·ä½“è°ƒç”¨å¯¹è±¡çš„ <code>getObject</code> æ“ä½œã€‚</li><li><code>SCOPE_SINGLETON</code>ã€<code>SCOPE_PROTOTYPE</code>ï¼Œå¯¹è±¡ç±»å‹çš„åˆ›å»ºè·å–æ–¹å¼ï¼Œä¸»è¦åŒºåˆ†åœ¨äº <code>AbstractAutowireCapableBeanFactory#createBean</code> åˆ›å»ºå®Œæˆå¯¹è±¡åæ˜¯å¦æ”¾å…¥åˆ°å†…å­˜ä¸­ï¼Œå¦‚æœä¸æ”¾å…¥åˆ™æ¯æ¬¡è·å–éƒ½ä¼šé‡æ–°åˆ›å»ºã€‚</li><li>createBean æ‰§è¡Œå¯¹è±¡åˆ›å»ºã€å±æ€§å¡«å……ã€ä¾èµ–åŠ è½½ã€å‰ç½®åç½®å¤„ç†ã€åˆå§‹åŒ–ç­‰æ“ä½œåï¼Œå°±è¦å¼€å§‹åšæ‰§è¡Œåˆ¤æ–­æ•´ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯ä¸€ä¸ª FactoryBean å¯¹è±¡ï¼Œå¦‚æœæ˜¯è¿™æ ·çš„å¯¹è±¡ï¼Œå°±éœ€è¦å†ç»§ç»­æ‰§è¡Œè·å– FactoryBean å…·ä½“å¯¹è±¡ä¸­çš„ <code>getObject</code> å¯¹è±¡äº†ã€‚æ•´ä¸ª getBean è¿‡ç¨‹ä¸­éƒ½ä¼šæ–°å¢ä¸€ä¸ªå•ä¾‹ç±»å‹çš„åˆ¤æ–­<code>factory.isSingleton()</code>ï¼Œç”¨äºå†³å®šæ˜¯å¦ä½¿ç”¨å†…å­˜å­˜æ”¾å¯¹è±¡ä¿¡æ¯ã€‚</li></ul><h2 id="å››ã€å®ç°" tabindex="-1"><a class="header-anchor" href="#å››ã€å®ç°" aria-hidden="true">#</a> å››ã€å®ç°</h2><h3 id="_1-å·¥ç¨‹ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-å·¥ç¨‹ç»“æ„" aria-hidden="true">#</a> 1. å·¥ç¨‹ç»“æ„</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>small<span class="token operator">-</span>spring<span class="token operator">-</span>step<span class="token operator">-</span><span class="token number">09</span>
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework
    â”‚           â”œâ”€â”€ beans
    â”‚           â”‚   â”œâ”€â”€ factory
    â”‚           â”‚   â”‚   â”œâ”€â”€ config
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanReference</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">SingletonBeanRegistry</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractBeanDefinitionReader</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanDefinitionReader</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">CglibSubclassingInstantiationStrategy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DefaultSingletonBeanRegistry</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">FactoryBeanRegistrySupport</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">InstantiationStrategy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">SimpleInstantiationStrategy</span><span class="token punctuation">.</span>java  
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">Aware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanClassLoaderAware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanFactoryAware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanNameAware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DisposableBean</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">FactoryBean</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">HierarchicalBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">InitializingBean</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">ListableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">BeansException</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">PropertyValue</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">PropertyValues</span><span class="token punctuation">.</span>java 
    â”‚           â”œâ”€â”€ context
    â”‚           â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractRefreshableApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractXmlApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContextAwareProcessor</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContextAware</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span>java
    â”‚           â”œâ”€â”€ core<span class="token punctuation">.</span>io
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ClassPathResource</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">DefaultResourceLoader</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">FileSystemResource</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">Resource</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ResourceLoader</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">UrlResource</span><span class="token punctuation">.</span>java
    â”‚           â””â”€â”€ utils
    â”‚               â””â”€â”€ <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span>java
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test
                â”œâ”€â”€ bean
                â”‚   â”œâ”€â”€ <span class="token class-name">UserDao</span><span class="token punctuation">.</span>java
                â”‚   â””â”€â”€ <span class="token class-name">UserService</span><span class="token punctuation">.</span>java
                â””â”€â”€ <span class="token class-name">ApiTest</span><span class="token punctuation">.</span>java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å·¥ç¨‹æºç </strong>ï¼š<code>å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šSpring ä¸“æ ï¼Œè·å–å®Œæ•´æºç </code></p><p>Spring å•ä¾‹ã€åŸå‹ä»¥åŠ <code>FactoryBean</code> åŠŸèƒ½å®ç°ç±»å…³ç³»ï¼Œå¦‚å›¾ 10-2</p><p><img src="https://bugstack.cn/assets/images/spring/spring-10-02.png" alt="å›¾ 10-2"></p><ul><li>ä»¥ä¸Šæ•´ä¸ªç±»å…³ç³»å›¾å±•ç¤ºçš„å°±æ˜¯æ·»åŠ  Bean çš„å®ä¾‹åŒ–æ˜¯å•ä¾‹è¿˜æ˜¯åŸå‹æ¨¡å¼ä»¥åŠ FactoryBean çš„å®ç°ã€‚</li><li>å…¶å®æ•´ä¸ªå®ç°çš„è¿‡ç¨‹å¹¶ä¸å¤æ‚ï¼Œåªæ˜¯åœ¨ç°æœ‰çš„ AbstractAutowireCapableBeanFactory ç±»ä»¥åŠç»§æ‰¿çš„æŠ½è±¡ç±» AbstractBeanFactory ä¸­è¿›è¡Œæ‰©å±•ã€‚</li><li>ä¸è¿‡è¿™æ¬¡æˆ‘ä»¬æŠŠ AbstractBeanFactory ç»§æ‰¿çš„ DefaultSingletonBeanRegistry ç±»ï¼Œä¸­é—´åŠ äº†ä¸€å±‚ FactoryBeanRegistrySupportï¼Œè¿™ä¸ªç±»åœ¨ Spring æ¡†æ¶ä¸­ä¸»è¦æ˜¯å¤„ç†å…³äº FactoryBean æ³¨å†Œçš„æ”¯æ’‘æ“ä½œã€‚</li></ul><h3 id="_2-beançš„ä½œç”¨èŒƒå›´å®šä¹‰å’Œxmlè§£æ" tabindex="-1"><a class="header-anchor" href="#_2-beançš„ä½œç”¨èŒƒå›´å®šä¹‰å’Œxmlè§£æ" aria-hidden="true">#</a> 2. Beançš„ä½œç”¨èŒƒå›´å®šä¹‰å’Œxmlè§£æ</h3><p><strong>cn.bugstack.springframework.beans.factory.config.BeanDefinition</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanDefinition</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> <span class="token constant">SCOPE_SINGLETON</span> <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">SCOPE_SINGLETON</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> <span class="token constant">SCOPE_PROTOTYPE</span> <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">SCOPE_PROTOTYPE</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Class</span> beanClass<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">PropertyValues</span> propertyValues<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> initMethodName<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> destroyMethodName<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> scope <span class="token operator">=</span> <span class="token constant">SCOPE_SINGLETON</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> singleton <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> prototype <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token comment">//åœ¨xmlæ³¨å†ŒBeanå®šä¹‰æ—¶ï¼Œé€šè¿‡scopeå­—æ®µæ¥åˆ¤æ–­æ˜¯å•ä¾‹è¿˜æ˜¯åŸå‹</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setScope</span><span class="token punctuation">(</span><span class="token class-name">String</span> scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scope <span class="token operator">=</span> scope<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>singleton <span class="token operator">=</span> <span class="token constant">SCOPE_SINGLETON</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token constant">SCOPE_PROTOTYPE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...get/set</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>singletonã€prototypeï¼Œæ˜¯æœ¬æ¬¡åœ¨ BeanDefinition ç±»ä¸­æ–°å¢åŠ çš„ä¸¤ä¸ªå±æ€§ä¿¡æ¯ï¼Œç”¨äºæŠŠä» spring.xml ä¸­è§£æåˆ°çš„ Bean å¯¹è±¡ä½œç”¨èŒƒå›´å¡«å……åˆ°å±æ€§ä¸­ã€‚</li></ul><p><strong>cn.bugstack.springframework.beans.factory.xml.XmlBeanDefinitionReader</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XmlBeanDefinitionReader</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBeanDefinitionReader</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doLoadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
      
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childNodes<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ¤æ–­å…ƒç´ </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>childNodes<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ¤æ–­å¯¹è±¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;bean&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>childNodes<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token comment">// è§£ææ ‡ç­¾</span>
            <span class="token class-name">Element</span> bean <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token punctuation">)</span> childNodes<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> id <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> className <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> initMethod <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;init-method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> destroyMethodName <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;destroy-method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> beanScope <span class="token operator">=</span> bean<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;scope&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// è·å– Classï¼Œæ–¹ä¾¿è·å–ç±»ä¸­çš„åç§°</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ä¼˜å…ˆçº§ id &gt; name</span>
            <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">?</span> id <span class="token operator">:</span> name<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                beanName <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">lowerFirst</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// å®šä¹‰Bean</span>
            <span class="token class-name">BeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefinition<span class="token punctuation">.</span><span class="token function">setInitMethodName</span><span class="token punctuation">(</span>initMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefinition<span class="token punctuation">.</span><span class="token function">setDestroyMethodName</span><span class="token punctuation">(</span>destroyMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>beanScope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                beanDefinition<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>beanScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">// ...</span>
            
            <span class="token comment">// æ³¨å†Œ BeanDefinition</span>
            <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨è§£æ XML å¤„ç†ç±» XmlBeanDefinitionReader ä¸­ï¼Œæ–°å¢åŠ äº†å…³äº Bean å¯¹è±¡é…ç½®ä¸­ scope çš„è§£æï¼Œå¹¶æŠŠè¿™ä¸ªå±æ€§ä¿¡æ¯å¡«å……åˆ° Bean å®šä¹‰ä¸­ã€‚<code>beanDefinition.setScope(beanScope)</code></li></ul><h3 id="_3-åˆ›å»ºå’Œä¿®æ”¹å¯¹è±¡æ—¶å€™åˆ¤æ–­å•ä¾‹å’ŒåŸå‹æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_3-åˆ›å»ºå’Œä¿®æ”¹å¯¹è±¡æ—¶å€™åˆ¤æ–­å•ä¾‹å’ŒåŸå‹æ¨¡å¼" aria-hidden="true">#</a> 3. åˆ›å»ºå’Œä¿®æ”¹å¯¹è±¡æ—¶å€™åˆ¤æ–­å•ä¾‹å’ŒåŸå‹æ¨¡å¼</h3><p><strong>cn.bugstack.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractAutowireCapableBeanFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBeanFactory</span> <span class="token keyword">implements</span> <span class="token class-name">AutowireCapableBeanFactory</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">InstantiationStrategy</span> instantiationStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CglibSubclassingInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            bean <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç»™ Bean å¡«å……å±æ€§</span>
            <span class="token function">applyPropertyValues</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•</span>
            bean <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeansException</span><span class="token punctuation">(</span><span class="token string">&quot;Instantiation of bean failed&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æ³¨å†Œå®ç°äº† DisposableBean æ¥å£çš„ Bean å¯¹è±¡</span>
        <span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ¤æ–­ SCOPE_SINGLETONã€SCOPE_PROTOTYPE</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinition<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">addSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é Singleton ç±»å‹çš„ Bean ä¸æ‰§è¡Œé”€æ¯æ–¹æ³•</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanDefinition<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">DisposableBean</span> <span class="token operator">||</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">.</span><span class="token function">getDestroyMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">registerDisposableBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ... å…¶ä»–åŠŸèƒ½</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å•ä¾‹æ¨¡å¼å’ŒåŸå‹æ¨¡å¼çš„åŒºåˆ«å°±åœ¨äºæ˜¯å¦å­˜æ”¾åˆ°å†…å­˜ä¸­ï¼Œå¦‚æœæ˜¯åŸå‹æ¨¡å¼é‚£ä¹ˆå°±ä¸ä¼šå­˜æ”¾åˆ°å†…å­˜ä¸­ï¼Œæ¯æ¬¡è·å–éƒ½é‡æ–°åˆ›å»ºå¯¹è±¡ï¼Œå¦å¤–é Singleton ç±»å‹çš„ Bean ä¸éœ€è¦æ‰§è¡Œé”€æ¯æ–¹æ³•ã€‚</li><li>æ‰€ä»¥è¿™é‡Œçš„ä»£ç ä¼šæœ‰ä¸¤å¤„ä¿®æ”¹ï¼Œä¸€å¤„æ˜¯ createBean ä¸­åˆ¤æ–­æ˜¯å¦æ·»åŠ åˆ° addSingleton(beanName, bean);ï¼Œå¦å¤–ä¸€å¤„æ˜¯ registerDisposableBeanIfNecessary é”€æ¯æ³¨å†Œä¸­çš„åˆ¤æ–­ <code>if (!beanDefinition.isSingleton()) return;</code>ã€‚</li></ul><h3 id="_4-å®šä¹‰-factorybean-æ¥å£" tabindex="-1"><a class="header-anchor" href="#_4-å®šä¹‰-factorybean-æ¥å£" aria-hidden="true">#</a> 4. å®šä¹‰ FactoryBean æ¥å£</h3><p><strong>cn.bugstack.springframework.beans.factory.FactoryBean</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token class-name">T</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>FactoryBean ä¸­éœ€è¦æä¾›3ä¸ªæ–¹æ³•ï¼Œè·å–å¯¹è±¡ã€å¯¹è±¡ç±»å‹ï¼Œä»¥åŠæ˜¯å¦æ˜¯å•ä¾‹å¯¹è±¡ï¼Œå¦‚æœæ˜¯å•ä¾‹å¯¹è±¡ä¾ç„¶ä¼šè¢«æ”¾åˆ°å†…å­˜ä¸­ã€‚</li></ul><h3 id="_5-å®ç°ä¸€ä¸ª-factorybean-æ³¨å†ŒæœåŠ¡" tabindex="-1"><a class="header-anchor" href="#_5-å®ç°ä¸€ä¸ª-factorybean-æ³¨å†ŒæœåŠ¡" aria-hidden="true">#</a> 5. å®ç°ä¸€ä¸ª FactoryBean æ³¨å†ŒæœåŠ¡</h3><p><strong>cn.bugstack.springframework.beans.factory.support.FactoryBeanRegistrySupport</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">FactoryBeanRegistrySupport</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultSingletonBeanRegistry</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * Cache of singleton objects created by FactoryBeans: FactoryBean name --&gt; object
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> factoryBeanObjectCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getCachedObjectForFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>object <span class="token operator">!=</span> <span class="token constant">NULL_OBJECT</span> <span class="token operator">?</span> object <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getObjectFromFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">FactoryBean</span> factory<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>factory<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                object <span class="token operator">=</span> <span class="token function">doGetObjectFromFactoryBean</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span>object <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> object <span class="token operator">:</span> <span class="token constant">NULL_OBJECT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>object <span class="token operator">!=</span> <span class="token constant">NULL_OBJECT</span> <span class="token operator">?</span> object <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">doGetObjectFromFactoryBean</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">doGetObjectFromFactoryBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">FactoryBean</span> factory<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeansException</span><span class="token punctuation">(</span><span class="token string">&quot;FactoryBean threw exception on object[&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;] creation&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>FactoryBeanRegistrySupport ç±»ä¸»è¦å¤„ç†çš„å°±æ˜¯å…³äº FactoryBean æ­¤ç±»å¯¹è±¡çš„æ³¨å†Œæ“ä½œï¼Œä¹‹æ‰€ä»¥æ”¾åˆ°è¿™æ ·ä¸€ä¸ªå•ç‹¬çš„ç±»é‡Œï¼Œå°±æ˜¯å¸Œæœ›åšåˆ°ä¸åŒé¢†åŸŸæ¨¡å—ä¸‹åªè´Ÿè´£å„è‡ªéœ€è¦å®Œæˆçš„åŠŸèƒ½ï¼Œé¿å…å› ä¸ºæ‰©å±•å¯¼è‡´ç±»è†¨èƒ€åˆ°éš¾ä»¥ç»´æŠ¤ã€‚</li><li>åŒæ ·è¿™é‡Œä¹Ÿå®šä¹‰äº†ç¼“å­˜æ“ä½œ factoryBeanObjectCacheï¼Œç”¨äºå­˜æ”¾å•ä¾‹ç±»å‹çš„å¯¹è±¡ï¼Œé¿å…é‡å¤åˆ›å»ºã€‚<em>åœ¨æ—¥å¸¸ä½¿ç”¨ç”¨ï¼ŒåŸºæœ¬ä¹Ÿéƒ½æ˜¯åˆ›å»ºçš„å•ä¾‹å¯¹è±¡</em></li><li>doGetObjectFromFactoryBean æ˜¯å…·ä½“çš„è·å– FactoryBean#getObject() æ–¹æ³•ï¼Œå› ä¸ºæ—¢æœ‰ç¼“å­˜çš„å¤„ç†ä¹Ÿæœ‰å¯¹è±¡çš„è·å–ï¼Œæ‰€ä»¥é¢å¤–æä¾›äº† getObjectFromFactoryBean è¿›è¡Œé€»è¾‘åŒ…è£…ï¼Œè¿™éƒ¨åˆ†çš„æ“ä½œæ–¹å¼æ˜¯ä¸å’Œä½ æ—¥å¸¸åšçš„ä¸šåŠ¡é€»è¾‘å¼€å‘éå¸¸ç›¸ä¼¼ã€‚<em>ä»Rediså–æ•°æ®ï¼Œå¦‚æœä¸ºç©ºå°±ä»æ•°æ®åº“è·å–å¹¶å†™å…¥Redis</em></li></ul><h3 id="_6-æ‰©å±•-abstractbeanfactory-åˆ›å»ºå¯¹è±¡é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#_6-æ‰©å±•-abstractbeanfactory-åˆ›å»ºå¯¹è±¡é€»è¾‘" aria-hidden="true">#</a> 6. æ‰©å±• AbstractBeanFactory åˆ›å»ºå¯¹è±¡é€»è¾‘</h3><p><strong>cn.bugstack.springframework.beans.factory.support.AbstractBeanFactory</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBeanFactory</span> <span class="token keyword">extends</span> <span class="token class-name">FactoryBeanRegistrySupport</span> <span class="token keyword">implements</span> <span class="token class-name">ConfigurableBeanFactory</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœæ˜¯ FactoryBeanï¼Œåˆ™éœ€è¦è°ƒç”¨ FactoryBean#getObject</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">BeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
   
    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span><span class="token class-name">Object</span> beanInstance<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanInstance <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token function">getCachedObjectForFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factoryBean <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> beanInstance<span class="token punctuation">;</span>
            object <span class="token operator">=</span> <span class="token function">getObjectFromFactoryBean</span><span class="token punctuation">(</span>factoryBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> object<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
        
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é¦–å…ˆè¿™é‡ŒæŠŠ AbstractBeanFactory åŸæ¥ç»§æ‰¿çš„ DefaultSingletonBeanRegistryï¼Œä¿®æ”¹ä¸ºç»§æ‰¿ FactoryBeanRegistrySupportã€‚å› ä¸ºéœ€è¦æ‰©å±•å‡ºåˆ›å»º FactoryBean å¯¹è±¡çš„èƒ½åŠ›ï¼Œæ‰€ä»¥è¿™å°±æƒ³ä¸€ä¸ªé“¾æ¡æœåŠ¡ä¸Šï¼Œæˆªå‡ºä¸€ä¸ªæ®µæ¥å¤„ç†é¢å¤–çš„æœåŠ¡ï¼Œå¹¶æŠŠé“¾æ¡å†é“¾æ¥ä¸Šã€‚</li><li>æ­¤å¤„æ–°å¢åŠ çš„åŠŸèƒ½ä¸»è¦æ˜¯åœ¨ doGetBean æ–¹æ³•ä¸­ï¼Œæ·»åŠ äº†è°ƒç”¨ <code>(T) getObjectForBeanInstance(sharedInstance, name)</code> å¯¹è·å– FactoryBean çš„æ“ä½œã€‚</li><li>åœ¨ getObjectForBeanInstance æ–¹æ³•ä¸­åšå…·ä½“çš„ instanceof åˆ¤æ–­ï¼Œå¦å¤–è¿˜ä¼šä» FactoryBean çš„ç¼“å­˜ä¸­è·å–å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è°ƒç”¨ FactoryBeanRegistrySupport#getObjectFromFactoryBeanï¼Œæ‰§è¡Œå…·ä½“çš„æ“ä½œã€‚</li></ul><h2 id="äº”ã€æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#äº”ã€æµ‹è¯•" aria-hidden="true">#</a> äº”ã€æµ‹è¯•</h2><h3 id="_1-äº‹å…ˆå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#_1-äº‹å…ˆå‡†å¤‡" aria-hidden="true">#</a> 1. äº‹å…ˆå‡†å¤‡</h3><p><strong>cn.bugstack.springframework.test.bean.IUserDao</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserDao</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> <span class="token function">queryUserName</span><span class="token punctuation">(</span><span class="token class-name">String</span> uId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™ä¸ªç« èŠ‚æˆ‘ä»¬åˆ æ‰ UserDaoï¼Œå®šä¹‰ä¸€ä¸ª IUserDao æ¥å£ï¼Œä¹‹æ‰€è¿™æ ·åšæ˜¯ä¸ºäº†é€šè¿‡ FactoryBean åšä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡çš„ä»£ç†æ“ä½œã€‚</li></ul><p><strong>cn.bugstack.springframework.test.bean.UserService</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> uId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> company<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> location<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">IUserDao</span> userDao<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userDao<span class="token punctuation">.</span><span class="token function">queryUserName</span><span class="token punctuation">(</span>uId<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> company <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> location<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...get/set</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨ UserService æ–°ä¿®æ”¹äº†ä¸€ä¸ªåŸæœ‰ UserDao å±æ€§ä¸º IUserDaoï¼Œåé¢æˆ‘ä»¬ä¼šç»™è¿™ä¸ªå±æ€§æ³¨å…¥ä»£ç†å¯¹è±¡ã€‚</li></ul><h3 id="_2-å®šä¹‰-factorybean-å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_2-å®šä¹‰-factorybean-å¯¹è±¡" aria-hidden="true">#</a> 2. å®šä¹‰ FactoryBean å¯¹è±¡</h3><p><strong>cn.bugstack.springframework.test.bean.ProxyBeanFactory</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxyBeanFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IUserDao</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">IUserDao</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;10001&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;å°å‚…å“¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;10002&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;å…«æ¯æ°´&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;10003&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;é˜¿æ¯›&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">return</span> <span class="token string">&quot;ä½ è¢«ä»£ç†äº† &quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ï¼š&quot;</span> <span class="token operator">+</span> hashMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">IUserDao</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">IUserDao</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">IUserDao</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™æ˜¯ä¸€ä¸ªå®ç°æ¥å£ FactoryBean çš„ä»£ç†ç±» ProxyBeanFactory åç§°ï¼Œä¸»è¦æ˜¯æ¨¡æ‹Ÿäº† UserDao çš„åŸæœ‰åŠŸèƒ½ï¼Œç±»ä¼¼äº MyBatis æ¡†æ¶ä¸­çš„ä»£ç†æ“ä½œã€‚</li><li>getObject() ä¸­æä¾›çš„å°±æ˜¯ä¸€ä¸ª InvocationHandler çš„ä»£ç†å¯¹è±¡ï¼Œå½“æœ‰æ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼Œåˆ™æ‰§è¡Œä»£ç†å¯¹è±¡çš„åŠŸèƒ½ã€‚</li></ul><h3 id="_3-é…ç½®æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#_3-é…ç½®æ–‡ä»¶" aria-hidden="true">#</a> 3. é…ç½®æ–‡ä»¶</h3><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cn.bugstack.springframework.test.bean.UserService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prototype<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>uId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>10001<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>company<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>è…¾è®¯<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>location<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>æ·±åœ³<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>proxyUserDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>proxyUserDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cn.bugstack.springframework.test.bean.ProxyBeanFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æŠŠ proxyUserDao è¿™ä¸ªä»£ç†å¯¹è±¡ï¼Œæ³¨å…¥åˆ° userService çš„ userDao ä¸­ã€‚<em>ä¸ä¸Šä¸€ç« èŠ‚ç›¸æ¯”ï¼Œå»æ‰äº† UserDao å®ç°ç±»ï¼Œè½¬è€Œç”¨ä»£ç†ç±»æ›¿æ¢</em></li></ul><h3 id="_4-å•å…ƒæµ‹è¯•-å•ä¾‹-åŸå‹" tabindex="-1"><a class="header-anchor" href="#_4-å•å…ƒæµ‹è¯•-å•ä¾‹-åŸå‹" aria-hidden="true">#</a> 4. å•å…ƒæµ‹è¯•(å•ä¾‹&amp;åŸå‹)</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_prototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.åˆå§‹åŒ– BeanFactory</span>
    <span class="token class-name">ClassPathXmlApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:spring.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    applicationContext<span class="token punctuation">.</span><span class="token function">registerShutdownHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   

    <span class="token comment">// 2. è·å–Beanå¯¹è±¡è°ƒç”¨æ–¹æ³•</span>
    <span class="token class-name">UserService</span> userService01 <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">,</span> <span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserService</span> userService02 <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">,</span> <span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 3. é…ç½® scope=&quot;prototype/singleton&quot;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userService01<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userService02<span class="token punctuation">)</span><span class="token punctuation">;</span>    

    <span class="token comment">// 4. æ‰“å°åå…­è¿›åˆ¶å“ˆå¸Œ</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userService01 <span class="token operator">+</span> <span class="token string">&quot; åå…­è¿›åˆ¶å“ˆå¸Œï¼š&quot;</span> <span class="token operator">+</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>userService01<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>userService01<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨ spring.xml é…ç½®æ–‡ä»¶ä¸­ï¼Œè®¾ç½®äº† scope=&quot;prototype&quot; è¿™æ ·å°±æ¯æ¬¡è·å–åˆ°çš„å¯¹è±¡éƒ½åº”è¯¥æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</li><li>è¿™é‡Œåˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºä¸€ä¸ªä¼šçœ‹åˆ°æ‰“å°çš„ç±»å¯¹è±¡çš„å“ˆå¸Œå€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠåå…­è¿›åˆ¶å“ˆå¸Œæ‰“å°å‡ºæ¥ã€‚</li></ul><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>UserService</span>$$<span class="token class-name">EnhancerByCGLIB</span>$$<span class="token number">4</span>cabb984<span class="token annotation punctuation">@1b0375b3</span>
<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>UserService</span>$$<span class="token class-name">EnhancerByCGLIB</span>$$<span class="token number">4</span>cabb984<span class="token annotation punctuation">@2f7c7260</span>
<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>UserService</span>$$<span class="token class-name">EnhancerByCGLIB</span>$$<span class="token number">4</span>cabb984<span class="token annotation punctuation">@1b0375b3</span> åå…­è¿›åˆ¶å“ˆå¸Œï¼š<span class="token number">1</span>b0375b3
<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>UserService</span>$$<span class="token class-name">EnhancerByCGLIB</span>$$<span class="token number">4</span>cabb984 object internals<span class="token operator">:</span>
 <span class="token constant">OFFSET</span>  <span class="token constant">SIZE</span>                                             <span class="token constant">TYPE</span> <span class="token constant">DESCRIPTION</span>                                               <span class="token constant">VALUE</span>
      <span class="token number">0</span>     <span class="token number">4</span>                                                  <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                                           <span class="token number">01</span> b3 <span class="token number">75</span> <span class="token number">03</span> <span class="token punctuation">(</span><span class="token number">00000001</span> <span class="token number">10110011</span> <span class="token number">01110101</span> <span class="token number">00000011</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">58045185</span><span class="token punctuation">)</span>
      <span class="token number">4</span>     <span class="token number">4</span>                                                  <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                                           <span class="token number">1</span>b <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00011011</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">27</span><span class="token punctuation">)</span>
      <span class="token number">8</span>     <span class="token number">4</span>                                                  <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                                           <span class="token number">9f</span> e1 <span class="token number">01</span> f8 <span class="token punctuation">(</span><span class="token number">10011111</span> <span class="token number">11100001</span> <span class="token number">00000001</span> <span class="token number">11111000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">134094433</span><span class="token punctuation">)</span>
     <span class="token number">12</span>     <span class="token number">4</span>                                 <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token class-name">UserService</span><span class="token punctuation">.</span>uId                                           <span class="token punctuation">(</span>object<span class="token punctuation">)</span>
     <span class="token number">16</span>     <span class="token number">4</span>                                 <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token class-name">UserService</span><span class="token punctuation">.</span>company                                       <span class="token punctuation">(</span>object<span class="token punctuation">)</span>
     <span class="token number">20</span>     <span class="token number">4</span>                                 <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token class-name">UserService</span><span class="token punctuation">.</span>location                                      <span class="token punctuation">(</span>object<span class="token punctuation">)</span>
     <span class="token number">24</span>     <span class="token number">4</span>   <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>IUserDao</span> <span class="token class-name">UserService</span><span class="token punctuation">.</span>userDao                                       <span class="token punctuation">(</span>object<span class="token punctuation">)</span>
     <span class="token number">28</span>     <span class="token number">1</span>                                          <span class="token keyword">boolean</span> <span class="token class-name">UserService</span>$$<span class="token class-name">EnhancerByCGLIB</span>$$<span class="token number">4</span>cabb984<span class="token punctuation">.</span><span class="token constant">CGLIB</span>$<span class="token constant">BOUND</span>        <span class="token boolean">true</span>
     <span class="token number">29</span>     <span class="token number">3</span>                                                  <span class="token punctuation">(</span>alignment<span class="token operator">/</span>padding gap<span class="token punctuation">)</span>                                  
     <span class="token number">32</span>     <span class="token number">4</span>                          <span class="token class-name"><span class="token namespace">net<span class="token punctuation">.</span>sf<span class="token punctuation">.</span>cglib<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span></span>NoOp</span> <span class="token class-name">UserService</span>$$<span class="token class-name">EnhancerByCGLIB</span>$$<span class="token number">4</span>cabb984<span class="token punctuation">.</span><span class="token constant">CGLIB</span>$<span class="token constant">CALLBACK_0</span>   <span class="token punctuation">(</span>object<span class="token punctuation">)</span>
     <span class="token number">36</span>     <span class="token number">4</span>                                                  <span class="token punctuation">(</span>loss due <span class="token keyword">to</span> <span class="token namespace">the</span> next object alignment<span class="token punctuation">)</span>
<span class="token class-name">Instance</span> size<span class="token operator">:</span> <span class="token number">40</span> bytes
<span class="token class-name">Space</span> losses<span class="token operator">:</span> <span class="token number">3</span> bytes internal <span class="token operator">+</span> <span class="token number">4</span> bytes external <span class="token operator">=</span> <span class="token number">7</span> bytes total


<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://bugstack.cn/assets/images/spring/spring-10-03.png" alt=""></p><ul><li>å¯¹è±¡åé¢çš„è¿™ä¸€å°æ®µå­—ç¬¦ä¸²å°±æ˜¯16è¿›åˆ¶å“ˆå¸Œå€¼ï¼Œåœ¨å¯¹è±¡å¤´å“ˆå¸Œå€¼å­˜æ”¾çš„ç»“æœä¸Šçœ‹ï¼Œä¹Ÿæœ‰å¯¹åº”çš„æ•°å€¼ã€‚åªä¸è¿‡è¿™ä¸ªç»“æœæ˜¯å€’è¿‡æ¥çš„ã€‚</li><li>å¦å¤–å¯ä»¥çœ‹åˆ° cabb984@1b0375b3ã€cabb984@2f7c7260ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡çš„ç»“å°¾16è¿›åˆ¶å“ˆå¸Œå€¼å¹¶ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„åŸå‹æ¨¡å¼æ˜¯ç”Ÿæ•ˆçš„ã€‚</li></ul><h3 id="_5-å•å…ƒæµ‹è¯•-ä»£ç†å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_5-å•å…ƒæµ‹è¯•-ä»£ç†å¯¹è±¡" aria-hidden="true">#</a> 5. å•å…ƒæµ‹è¯•(ä»£ç†å¯¹è±¡)</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_factory_bean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.åˆå§‹åŒ– BeanFactory</span>
    <span class="token class-name">ClassPathXmlApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:spring.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    applicationContext<span class="token punctuation">.</span><span class="token function">registerShutdownHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token comment">// 2. è°ƒç”¨ä»£ç†æ–¹æ³•</span>
    <span class="token class-name">UserService</span> userService <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">,</span> <span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š&quot;</span> <span class="token operator">+</span> userService<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å…³äº FactoryBean çš„è°ƒç”¨å¹¶æ²¡æœ‰å¤ªå¤šä¸ä¸€æ ·ï¼Œå› ä¸ºæ‰€æœ‰çš„ä¸åŒéƒ½å·²ç»è¢« spring.xml é…ç½®è¿›å»äº†ã€‚å½“ç„¶ä½ å¯ä»¥ç›´æ¥è°ƒç”¨ spring.xml é…ç½®çš„å¯¹è±¡ <code>cn.bugstack.springframework.test.bean.ProxyBeanFactory</code></li></ul><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>æµ‹è¯•ç»“æœï¼šä½ è¢«ä»£ç†äº† queryUserNameï¼šå°å‚…å“¥<span class="token punctuation">,</span>è…¾è®¯<span class="token punctuation">,</span>æ·±åœ³

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,72),b=n("li",null,"ä»æµ‹è¯•ç»“æœæ¥çœ‹ï¼Œæˆ‘ä»¬çš„ä»£ç†ç±» ProxyBeanFactory å·²ç»å®Œç¾æ›¿æ¢æ‰äº† UserDao çš„åŠŸèƒ½ã€‚",-1),g={href:"https://bugstack.cn/itstack-ark-middleware/2021/03/31/SpringBoot-%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%AE%BE%E8%AE%A1%E5%92%8C%E5%BC%80%E5%8F%91-%E4%B8%93%E6%A0%8F%E5%B0%8F%E5%86%8C%E4%B8%8A%E7%BA%BF%E5%95%A6.html",target:"_blank",rel:"noopener noreferrer"},y=n("h2",{id:"å…­ã€æ€»ç»“",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#å…­ã€æ€»ç»“","aria-hidden":"true"},"#"),s(" å…­ã€æ€»ç»“")],-1),f=n("ul",null,[n("li",null,"åœ¨ Spring æ¡†æ¶æ•´ä¸ªå¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œå‰æœŸçš„å„ä¸ªåŠŸèƒ½æ¥å£ç±»æ‰©å±•çš„åƒè†¨èƒ€äº†ä¼¼çš„ï¼Œä½†åˆ°åæœŸåœ¨å®Œå–„åŠŸèƒ½æ—¶ï¼Œå°±æ²¡æœ‰é‚£ä¹ˆéš¾äº†ï¼Œåè€Œæ·±å…¥ç†è§£åä¼šè§‰å¾—åŠŸèƒ½çš„è¡¥å……ï¼Œéƒ½æ¯”è¾ƒç®€å•ã€‚åªéœ€è¦å†æ‰€é‡é¢†åŸŸèŒƒå›´å†…è¿›è¡Œæ‰©å±•ç›¸åº”çš„æœåŠ¡å®ç°å³å¯ã€‚"),n("li",null,"å½“ä½ ä»”ç»†é˜…è¯»å®Œå…³äº FactoryBean çš„å®ç°ä»¥åŠæµ‹è¯•è¿‡ç¨‹çš„ä½¿ç”¨ï¼Œä»¥åå†éœ€è¦ä½¿ç”¨ FactoryBean å¼€å‘ç›¸åº”çš„ç»„ä»¶æ—¶å€™ï¼Œä¸€å®šä¼šéå¸¸æ¸…æ¥šå®ƒæ˜¯å¦‚ä½•åˆ›å»ºè‡ªå·±çš„å¤æ‚ Bean å¯¹è±¡ä»¥åŠåœ¨ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–å’Œè°ƒç”¨çš„ã€‚é‡åˆ°é—®é¢˜ä¹Ÿå¯ä»¥å¿«é€Ÿçš„æ’æŸ¥ã€å®šä½å’Œè§£å†³ã€‚"),n("li",null,[s("å¦‚æœä½ åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­æ„Ÿè§‰è¿™äº›ç±»ã€æ¥å£ã€å®ç°ã€ç»§æ‰¿ï¼Œç©¿æ¢­çš„å¾ˆå¤æ‚ï¼Œä¸€æ—¶åŠä¼šè„‘å­è¿˜ååº”ä¸è¿‡æ¥ã€‚é‚£ä¹ˆä½ æœ€å¥½çš„æ–¹å¼æ˜¯åŠ¨æ‰‹å»ç”»ç”»è¿™äº›ç±»å…³ç³»å›¾ï¼Œæ¢³ç†ä¸‹å®ç°çš„ç»“æ„ï¼Œçœ‹çœ‹æ¯ä¸ªç±»åœ¨å¹²ä»€ä¹ˆã€‚"),n("em",null,"çœ‹åªèƒ½æ˜¯çŸ¥é“ï¼ŒåŠ¨æ‰‹æ‰èƒ½å­¦ä¼šï¼")])],-1),h=n("h2",{id:"ä¸ƒã€ä¼˜ç§€ä½œä¸š",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ä¸ƒã€ä¼˜ç§€ä½œä¸š","aria-hidden":"true"},"#"),s(" ä¸ƒã€ä¼˜ç§€ä½œä¸š")],-1),B={href:"https://t.zsxq.com/057IyZj2r",target:"_blank",rel:"noopener noreferrer"},w={href:"https://t.zsxq.com/05eiIMFMj",target:"_blank",rel:"noopener noreferrer"},j={href:"https://t.zsxq.com/05MFubAA6",target:"_blank",rel:"noopener noreferrer"},S={href:"https://t.zsxq.com/067ufmeaE",target:"_blank",rel:"noopener noreferrer"},q={href:"https://t.zsxq.com/07cc83Mh2",target:"_blank",rel:"noopener noreferrer"},x={href:"https://t.zsxq.com/0828L68ac",target:"_blank",rel:"noopener noreferrer"},F={href:"https://t.zsxq.com/08Hv720j8",target:"_blank",rel:"noopener noreferrer"},_={href:"https://t.zsxq.com/09Mibk2Uj",target:"_blank",rel:"noopener noreferrer"},C={href:"https://t.zsxq.com/0buWRXssk",target:"_blank",rel:"noopener noreferrer"},D={href:"https://t.zsxq.com/0blxKjTp3",target:"_blank",rel:"noopener noreferrer"};function O(N,E){const a=p("ExternalLinkIcon");return c(),o("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),r,s("åšå®¢ï¼š"),n("a",k,[s("https://bugstack.cn"),t(a)]),d,s("åŸæ–‡ï¼š"),n("a",v,[s("https://mp.weixin.qq.com/s/npVKYqHVTDgYWa2Jq8PB-A"),t(a)])]),m,n("ul",null,[b,n("li",null,[s("è™½ç„¶çœ‹ä¸Šå»è¿™ä¸€ç‚¹å®ç°å¹¶ä¸å¤æ‚ï¼Œç”šè‡³æœ‰ç‚¹ç®€å•ã€‚ä½†å°±æ˜¯è¿™æ ·ä¸€ç‚¹ç‚¹æ ¸å¿ƒå†…å®¹çš„è®¾è®¡äº†ï¼Œè§£å†³äº†æ‰€æœ‰éœ€è¦å’Œ Spring ç»“åˆçš„å…¶ä»–æ¡†æ¶äº¤äº’é“¾æ¥é—®é¢˜ã€‚"),n("em",null,[s("å¦‚æœå¯¹æ­¤ç±»å†…å®¹æ„Ÿå…´è¶£ï¼Œä¹Ÿå¯ä»¥é˜…è¯»å°å‚…å“¥"),n("a",g,[s("ã€Šä¸­é—´ä»¶è®¾è®¡å’Œå¼€å‘ã€‹"),t(a)])])])]),y,f,h,n("ul",null,[n("li",null,[n("a",B,[s("å•ä¾‹åˆ¤æ–­ä»¥åŠé€šè¿‡ç”¨æˆ·åˆ›å»ºçš„FactoryBeanå®ç°å¤æ‚Beanå¯¹è±¡çš„åˆ›å»º @Ray"),t(a)])]),n("li",null,[n("a",w,[s("Bean å¯¹è±¡ä½œç”¨åŸŸèŒƒå›´å…¨è²Œæ¢³ç† @W"),t(a)])]),n("li",null,[n("a",j,[s("å¦å¼€ä¸€ä¸­é¢å¤–çš„prototypeç±»å‹çš„beanï¼Œå¹¶è¿›è¡Œç‰¹æ®Šå¤„ç† @Chin"),t(a)])]),n("li",null,[n("a",S,[s("èµ·åˆå¯¹äº FactoryBean æ¨¡å—å…¶å®ç†è§£çš„ä¸æ˜¯å¾ˆå……åˆ†ï¼Œè”æƒ³åˆ° mybatis çš„ä½¿ç”¨ç¡®å®ç¨å¾®èƒ½ get åˆ°å…¶è®¾è®¡çš„æ„ä¹‰æ‰€åœ¨ @Weirdo"),t(a)])]),n("li",null,[n("a",q,[s("å¯¹è±¡ä½œç”¨åŸŸå’ŒBeanFactory @liuc"),t(a)])]),n("li",null,[n("a",x,[s("AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯æŒ‡é€šè¿‡é¢„ç¼–è¯‘çš„æ–¹å¼å’Œè¿è¡ŒæœŸé—´åŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤ @liuc"),t(a)])]),n("li",null,[n("a",F,[s("ä¸ä»…ä»…åªç”± Spring æœ¬èº«ç±»åˆ›å»º Beanï¼Œä»¿ç…§ Mybatis æ¡†æ¶ï¼Œé€šè¿‡æ¥å£å®šä¹‰ @æ°´ä¸­ææœˆ"),t(a)])]),n("li",null,[n("a",_,[s("ApplicationEventMulticasterå…³é”®ç±»ï¼Œä¸»è¦æ˜¯é€šè¿‡è¯¥ç±»å‘å¸ƒçš„äº‹ä»¶ @Liuliuliu"),t(a)])]),n("li",null,[n("a",C,[s("äº‹ä»¶ç›‘å¬å™¨ï¼Œç…§å­—é¢æ„æ€ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªæœºåˆ¶ @lucien"),t(a)])]),n("li",null,[n("a",D,[s("Spring IoC å®¹å™¨é€šè¿‡åå°„æˆ–å­—èŠ‚ç å¢å¼ºçš„æ–¹å¼å®ä¾‹åŒ– Bean @çˆ±å¥‹æ–—çš„å°é²¨é±¼"),t(a)])])])])}const A=e(i,[["render",O],["__file","2021-06-30-di10zhangï¼šhengdaoyuemaï¼ŒguanyuBeanduixiangzuoyongyuyijiFactoryBeandeshixianheshiyong.html.vue"]]);export{A as default};
