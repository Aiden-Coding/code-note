import{_ as p,r as t,o as e,c as o,a as n,b as s,d as c,e as l}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"é¢ç»æ‰‹å†Œ-Â·-ç¬¬21ç¯‡ã€Šæ‰‹å†™çº¿ç¨‹æ± -å¯¹ç…§å­¦ä¹ threadpoolexecutorçº¿ç¨‹æ± å®ç°åŸç†-ã€‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#é¢ç»æ‰‹å†Œ-Â·-ç¬¬21ç¯‡ã€Šæ‰‹å†™çº¿ç¨‹æ± -å¯¹ç…§å­¦ä¹ threadpoolexecutorçº¿ç¨‹æ± å®ç°åŸç†-ã€‹","aria-hidden":"true"},"#"),s(" é¢ç»æ‰‹å†Œ Â· ç¬¬21ç¯‡ã€Šæ‰‹å†™çº¿ç¨‹æ± ï¼Œå¯¹ç…§å­¦ä¹ ThreadPoolExecutorçº¿ç¨‹æ± å®ç°åŸç†ï¼ã€‹")],-1),k=n("br",null,null,-1),r={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=l(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>äººçœ‹æ‰‹æœºï¼Œæœºå™¨å­¦ä¹ ï¼</code></p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-21-0.png" alt=""></p><p>æ­£å¥½æ˜¯2020å¹´ï¼Œçœ‹åˆ°è¿™å¼ å›¾è¿˜æ˜¯è›®æœ‰æ„æ€çš„ã€‚ä»¥å‰å°æ—¶å€™æ€»ä¼šçœ‹åˆ°ä¸€äº›ç§‘æŠ€ç”µå½±ï¼Œè®²åˆ°æœºå™¨äººä¼šæ€æ ·æ€æ ·ï¼Œä½†æ²¡æƒ³åˆ°äººä¼¼ä¹è¢«å¨±ä¹åŒ–çš„ä¸œè¥¿ï¼Œææˆäº†ä½å¤´æ—ã€å¤§è‚šå­ï¼</p><p>å½“æ„è¯†åˆ°è¿™ä¸€ç‚¹æ—¶ï¼Œå…¶å®éå¸¸æ€€å¿µå°æ—¶å€™ã€‚æ”¾å‡çš„æ—©ä¸Šè·‘å‡ºå»ï¼Œå–Šä¸Šä¸‰äº”ä¸ªä¼™ä¼´ï¼Œè¦ä¸ä¸‹æ²³æ‘¸æ‘¸é±¼ã€å¼¹å¼¹ç»ç’ƒçƒã€æ‰“æ‰“piaã€è·³è·³æˆ¿å­ï¼ä¸€å¤©ä¸‹æ¥çœŸçš„ä¸ä¼šæ„Ÿè§‰ç´¯ï¼Œä½†ç°åœ¨å¦‚æœæ˜¯æ”¾å‡çš„ä¸€å¤©ï¼Œä½ çš„å¨±ä¹å®‰æ’ï¼Œå¾ˆå¤šæ—¶å€™ä¼šè®©å¤´å¾ˆç´¯ï¼</p><p><strong>å°±åƒ</strong>ï¼Œä½ æœ‰è¯•è¿‡å­¦ä¹ ä¸€å¤©è‹±è¯­å¤´ç–¼ï¼Œè¿˜æ˜¯åˆ·ä¸€å¤©æŠ–éŸ³å¤´ç–¼å—ï¼Ÿæˆ–è€…ç©ä¸€å¤©æ¸¸æˆä¸æ‰“ä¸€å¤©çƒï¼<code>å¦‚æœä½ æ„è¯†åˆ°äº†ï¼Œé‚£ä¹ˆäº‰å–æ”¾ä¸‹ä¸€ä¼šæ‰‹æœºï¼Œé€‚å½“å¨±ä¹ï¼Œé”»ç‚¼ä¿æŒä¸ªå¥½èº«ä½“ï¼</code></p><h2 id="äºŒã€é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#äºŒã€é¢è¯•é¢˜" aria-hidden="true">#</a> äºŒã€é¢è¯•é¢˜</h2><p><code>è°¢é£æœºï¼Œå°è®°ï¼</code>ï¼Œä¸Šæ¬¡åƒäºåœ¨çº¿ç¨‹ä¸Šï¼Œè¿™æ¬¡å¯èƒ½ä¸€æ¬¡å‘æ‰ä¸¤æ¬¡äº†ï¼</p><p><strong>è°¢é£æœº</strong>ï¼šä½ é—®å§ï¼Œæˆ‘å‡†å¤‡å¥½äº†ï¼ï¼ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šå—¯ï¼Œçº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦‚ä½•è®¾è®¡å­˜å‚¨çš„ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šè¿™ï¼ä¸‹ä¸€ä¸ªï¼Œä¸‹ä¸€ä¸ªï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šWorker çš„å®ç°ç±»ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨ ReentrantLock æ¥å®ç°å‘¢ï¼Œè€Œæ˜¯è‡ªå·±ç»§æ‰¿AQSï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šæˆ‘...ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šé‚£ä½ ç®€è¿°ä¸‹ï¼Œexecute çš„æ‰§è¡Œè¿‡ç¨‹å§ï¼</p><p><strong>è°¢é£æœº</strong>ï¼šå†è§ï¼</p><h2 id="ä¸‰ã€çº¿ç¨‹æ± è®²è§£" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€çº¿ç¨‹æ± è®²è§£" aria-hidden="true">#</a> ä¸‰ã€çº¿ç¨‹æ± è®²è§£</h2><h3 id="_1-å…ˆçœ‹ä¸ªä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_1-å…ˆçœ‹ä¸ªä¾‹å­" aria-hidden="true">#</a> 1. å…ˆçœ‹ä¸ªä¾‹å­</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
threadPoolExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hi çº¿ç¨‹æ± ï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
threadPoolExecutor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Executors.newFixedThreadPool(10);</span>
<span class="token comment">// Executors.newCachedThreadPool();</span>
<span class="token comment">// Executors.newScheduledThreadPool(10);</span>
<span class="token comment">// Executors.newSingleThreadExecutor();</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯ä¸€æ®µç”¨äºåˆ›å»ºçº¿ç¨‹æ± çš„ä¾‹å­ï¼Œç›¸ä¿¡ä½ å·²ç»ç”¨äº†å¾ˆå¤šæ¬¡äº†ã€‚</p><p>çº¿ç¨‹æ± çš„æ ¸å¿ƒç›®çš„å°±æ˜¯èµ„æºçš„åˆ©ç”¨ï¼Œé¿å…é‡å¤åˆ›å»ºçº¿ç¨‹å¸¦æ¥çš„èµ„æºæ¶ˆè€—ã€‚å› æ­¤å¼•å…¥ä¸€ä¸ªæ± åŒ–æŠ€æœ¯çš„æ€æƒ³ï¼Œé¿å…é‡å¤åˆ›å»ºã€é”€æ¯å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚</p><p><strong>é‚£ä¹ˆ</strong>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡å®è·µçš„æ–¹å¼åˆ†æä¸‹è¿™ä¸ª<code>æ± å­</code>çš„æ„é€ ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å¤„ç†<code>çº¿ç¨‹</code>çš„ã€‚</p><h3 id="_2-æ‰‹å†™ä¸€ä¸ªçº¿ç¨‹æ± " tabindex="-1"><a class="header-anchor" href="#_2-æ‰‹å†™ä¸€ä¸ªçº¿ç¨‹æ± " aria-hidden="true">#</a> 2. æ‰‹å†™ä¸€ä¸ªçº¿ç¨‹æ± </h3><h4 id="_2-1-å®ç°æµç¨‹" tabindex="-1"><a class="header-anchor" href="#_2-1-å®ç°æµç¨‹" aria-hidden="true">#</a> 2.1 å®ç°æµç¨‹</h4><p>ä¸ºäº†æ›´å¥½çš„ç†è§£å’Œåˆ†æå…³äºçº¿ç¨‹æ± çš„æºç ï¼Œæˆ‘ä»¬å…ˆæ¥æŒ‰ç…§çº¿ç¨‹æ± çš„æ€æƒ³ï¼Œæ‰‹å†™ä¸€ä¸ªéå¸¸ç®€å•çš„çº¿ç¨‹æ± ã€‚</p><p><em>å…¶å®å¾ˆå¤šæ—¶å€™ä¸€æ®µåŠŸèƒ½ä»£ç çš„æ ¸å¿ƒä¸»é€»è¾‘å¯èƒ½å¹¶æ²¡æœ‰å¤šå¤æ‚ï¼Œä½†ä¸ºäº†è®©æ ¸å¿ƒæµç¨‹é¡ºåˆ©è¿è¡Œï¼Œå°±éœ€è¦é¢å¤–æ·»åŠ å¾ˆå¤šåˆ†æ”¯çš„è¾…åŠ©æµç¨‹ã€‚å°±åƒæˆ‘å¸¸è¯´çš„ï¼Œä¸ºäº†ä¿æŠ¤æ‰‹æ‰æŠŠæ“¦å±å±çº¸å¼„é‚£ä¹ˆå¤§ï¼</em></p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-21-1.png" alt="å›¾ 21-1 çº¿ç¨‹æ± ç®€åŒ–æµç¨‹"></p><p>å…³äºå›¾ 21-1ï¼Œè¿™ä¸ªæ‰‹å†™çº¿ç¨‹æ± çš„å®ç°ä¹Ÿéå¸¸ç®€å•ï¼Œåªä¼šä½“ç°å‡ºæ ¸å¿ƒæµç¨‹ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>æœ‰nä¸ªä¸€ç›´åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œç›¸å½“äºæˆ‘ä»¬åˆ›å»ºçº¿ç¨‹æ± æ—¶å…è®¸çš„çº¿ç¨‹æ± å¤§å°ã€‚</li><li>æŠŠçº¿ç¨‹æäº¤ç»™çº¿ç¨‹æ± è¿è¡Œã€‚</li><li>å¦‚æœè¿è¡Œçº¿ç¨‹æ± å·²æ»¡ï¼Œåˆ™æŠŠçº¿ç¨‹æ”¾å…¥é˜Ÿåˆ—ä¸­ã€‚</li><li>æœ€åå½“æœ‰ç©ºé—²æ—¶ï¼Œåˆ™è·å–é˜Ÿåˆ—ä¸­çº¿ç¨‹è¿›è¡Œè¿è¡Œã€‚</li></ol><h4 id="_2-2-å®ç°ä»£ç " tabindex="-1"><a class="header-anchor" href="#_2-2-å®ç°ä»£ç " aria-hidden="true">#</a> 2.2 å®ç°ä»£ç </h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolTrader</span> <span class="token keyword">implements</span> <span class="token class-name">Executor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> corePoolSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolTrader</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> workQueue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> maximumPoolSize<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token class-name">Worker</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        worker<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctl<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token keyword">final</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
        <span class="token class-name">Runnable</span> firstTask<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>firstTask <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Runnable</span> task <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> maximumPoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                ctl<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;workQueue.sizeï¼š&quot;</span> <span class="token operator">+</span> workQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;Errorï¼ctl.countï¼š&quot;</span> <span class="token operator">+</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; workQueue.sizeï¼š&quot;</span> <span class="token operator">+</span> workQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolTrader</span> threadPoolTrader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTrader</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> finalI <span class="token operator">=</span> i<span class="token punctuation">;</span>
            threadPoolTrader<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä»»åŠ¡ç¼–å·ï¼š&quot;</span> <span class="token operator">+</span> finalI<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">// æµ‹è¯•ç»“æœ</span>

ä»»åŠ¡ç¼–å·ï¼š<span class="token number">1</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">0</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">8</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">8</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">3</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">6</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">2</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">5</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">5</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">4</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">4</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">3</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">7</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">2</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">6</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">1</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">8</span>
ä»»åŠ¡ç¼–å·ï¼š<span class="token number">9</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">0</span>
workQueue<span class="token punctuation">.</span>sizeï¼š<span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä»¥ä¸Š</strong>ï¼Œå…³äºçº¿ç¨‹æ± çš„å®ç°è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œä»æµ‹è¯•ç»“æœä¸Šå·²ç»å¯ä»¥æŠŠæœ€æ ¸å¿ƒçš„æ± åŒ–æ€æƒ³ä½“ç°å‡ºæ¥äº†ã€‚ä¸»è¦åŠŸèƒ½é€»è¾‘åŒ…æ‹¬ï¼š</p><ul><li><code>ctl</code>ï¼Œç”¨äºè®°å½•çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡ã€‚</li><li><code>corePoolSize</code>ã€<code>maximumPoolSize</code>ï¼Œç”¨äºé™åˆ¶çº¿ç¨‹æ± å®¹é‡ã€‚</li><li><code>workQueue</code>ï¼Œçº¿ç¨‹æ± é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯é‚£äº›è¿˜ä¸èƒ½è¢«åŠæ—¶è¿è¡Œçš„çº¿ç¨‹ï¼Œä¼šè¢«è£…å…¥åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ã€‚</li><li><code>execute</code>ï¼Œç”¨äºæäº¤çº¿ç¨‹ï¼Œè¿™ä¸ªæ˜¯é€šç”¨çš„æ¥å£æ–¹æ³•ã€‚åœ¨è¿™ä¸ªæ–¹æ³•é‡Œä¸»è¦å®ç°çš„å°±æ˜¯ï¼Œå½“å‰æäº¤çš„çº¿ç¨‹æ˜¯åŠ å…¥åˆ°workerã€é˜Ÿåˆ—è¿˜æ˜¯æ”¾å¼ƒã€‚</li><li><code>addWorker</code>ï¼Œä¸»è¦æ˜¯ç±» <code>Worker</code> çš„å…·ä½“æ“ä½œï¼Œåˆ›å»ºå¹¶æ‰§è¡Œçº¿ç¨‹ã€‚è¿™é‡Œè¿˜åŒ…æ‹¬äº† <code>getTask() </code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä»é˜Ÿåˆ—ä¸­ä¸æ–­çš„è·å–æœªè¢«æ‰§è¡Œçš„çº¿ç¨‹ã€‚</li></ul><p><strong>å¥½</strong>ï¼Œé‚£ä¹ˆä»¥ä¸Šå‘¢ï¼Œå°±æ˜¯è¿™ä¸ªç®€å•çº¿ç¨‹æ± å®ç°çš„å…·ä½“ä½“ç°ã€‚ä½†å¦‚æœæ·±æ€ç†Ÿè™‘å°±ä¼šå‘ç°è¿™é‡Œéœ€è¦å¾ˆå¤šå®Œå–„ï¼Œæ¯”å¦‚ï¼š<code>çº¿ç¨‹æ± çŠ¶æ€å‘¢ï¼Œä¸å¯èƒ½ä¸€ç›´å¥”è·‘å‘€ï¼ï¼Ÿ</code>ã€<code>çº¿ç¨‹æ± çš„é”å‘¢ï¼Œä¸ä¼šæœ‰å¹¶å‘é—®é¢˜å—ï¼Ÿ</code>ã€<code>çº¿ç¨‹æ± æ‹’ç»åçš„ç­–ç•¥å‘¢ï¼Ÿ</code>ï¼Œè¿™äº›é—®é¢˜éƒ½æ²¡æœ‰åœ¨ä¸»æµç¨‹è§£å†³ï¼Œ<em>ä¹Ÿæ­£å› ä¸ºæ²¡æœ‰è¿™äº›æµç¨‹ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç æ‰æ›´å®¹æ˜“ç†è§£ã€‚</em></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¼€å§‹åˆ†æçº¿ç¨‹æ± çš„æºç ï¼Œä¸æˆ‘ä»¬å®ç°çš„ç®€å•çº¿ç¨‹æ± å‚è€ƒå¯¹æ¯”ï¼Œä¼šæ›´åŠ å®¹æ˜“ç†è§£ğŸ˜„ï¼</p><h3 id="_3-çº¿ç¨‹æ± æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_3-çº¿ç¨‹æ± æºç åˆ†æ" aria-hidden="true">#</a> 3. çº¿ç¨‹æ± æºç åˆ†æ</h3><h4 id="_3-1-çº¿ç¨‹æ± ç±»å…³ç³»å›¾" tabindex="-1"><a class="header-anchor" href="#_3-1-çº¿ç¨‹æ± ç±»å…³ç³»å›¾" aria-hidden="true">#</a> 3.1 çº¿ç¨‹æ± ç±»å…³ç³»å›¾</h4><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-21-2.png" alt="å›¾ 21-2 çº¿ç¨‹æ± ç±»å…³ç³»å›¾"></p><p>ä»¥å›´ç»•æ ¸å¿ƒç±» <code>ThreadPoolExecutor</code> çš„å®ç°å±•å¼€çš„ç±»ä¹‹é—´å®ç°å’Œç»§æ‰¿å…³ç³»ï¼Œå¦‚å›¾ 21-2 çº¿ç¨‹æ± ç±»å…³ç³»å›¾ã€‚</p><ul><li>æ¥å£ <code>Executor</code>ã€<code>ExecutorService</code>ï¼Œå®šä¹‰çº¿ç¨‹æ± çš„åŸºæœ¬æ–¹æ³•ã€‚å°¤å…¶æ˜¯ <code> execute(Runnable command)</code> æäº¤çº¿ç¨‹æ± æ–¹æ³•ã€‚</li><li>æŠ½è±¡ç±» <code>AbstractExecutorService</code>ï¼Œå®ç°äº†åŸºæœ¬é€šç”¨çš„æ¥å£æ–¹æ³•ã€‚</li><li><code>ThreadPoolExecutor</code>ï¼Œæ˜¯æ•´ä¸ªçº¿ç¨‹æ± æœ€æ ¸å¿ƒçš„å·¥å…·ç±»æ–¹æ³•ï¼Œæ‰€æœ‰çš„å…¶ä»–ç±»å’Œæ¥å£ï¼Œä¸ºå›´ç»•è¿™ä¸ªç±»æ¥æä¾›å„è‡ªçš„åŠŸèƒ½ã€‚</li><li><code>Worker</code>ï¼Œæ˜¯ä»»åŠ¡ç±»ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆæ‰§è¡Œçš„çº¿ç¨‹çš„æ–¹æ³•ã€‚</li><li><code>RejectedExecutionHandler</code>ï¼Œæ˜¯æ‹’ç»ç­–ç•¥æ¥å£ï¼Œæœ‰å››ä¸ªå®ç°ç±»ï¼›<code>AbortPolicy(æŠ›å¼‚å¸¸æ–¹å¼æ‹’ç»)</code>ã€<code>DiscardPolicy(ç›´æ¥ä¸¢å¼ƒ)</code>ã€<code>DiscardOldestPolicy(ä¸¢å¼ƒå­˜æ´»æ—¶é—´æœ€é•¿çš„ä»»åŠ¡)</code>ã€<code>CallerRunsPolicy(è°æäº¤è°æ‰§è¡Œ)</code>ã€‚</li><li><code>Executors</code>ï¼Œæ˜¯ç”¨äºåˆ›å»ºæˆ‘ä»¬å¸¸ç”¨çš„ä¸åŒç­–ç•¥çš„çº¿ç¨‹æ± ï¼Œ<code>newFixedThreadPool</code>ã€<code>newCachedThreadPool</code>ã€<code>newScheduledThreadPool</code>ã€<code>newSingleThreadExecutor</code>ã€‚</li></ul><h4 id="_3-2-é«˜3ä½ä¸ä½29ä½" tabindex="-1"><a class="header-anchor" href="#_3-2-é«˜3ä½ä¸ä½29ä½" aria-hidden="true">#</a> 3.2 é«˜3ä½ä¸ä½29ä½</h4><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-21-3.png" alt="å›¾ 22-3 çº¿ç¨‹çŠ¶æ€ï¼Œé«˜3ä½ä¸ä½29ä½"></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token constant">RUNNING</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COUNT_BITS</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">SIZE</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CAPACITY</span>   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RUNNING</span>    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SHUTDOWN</span>   <span class="token operator">=</span>  <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STOP</span>       <span class="token operator">=</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TIDYING</span>    <span class="token operator">=</span>  <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TERMINATED</span> <span class="token operator">=</span>  <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ <code>ThreadPoolExecutor</code> çº¿ç¨‹æ± å®ç°ç±»ä¸­ï¼Œä½¿ç”¨ AtomicInteger ç±»å‹çš„ ctl è®°å½•çº¿ç¨‹æ± çŠ¶æ€å’Œçº¿ç¨‹æ± æ•°é‡ã€‚åœ¨ä¸€ä¸ªç±»å‹ä¸Šè®°å½•å¤šä¸ªå€¼ï¼Œå®ƒé‡‡ç”¨çš„åˆ†å‰²æ•°æ®åŒºåŸŸï¼Œ<code>é«˜3ä½</code>è®°å½•çŠ¶æ€ï¼Œ<code>ä½29ä½</code>å­˜å‚¨çº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤ RUNNING çŠ¶æ€ï¼Œçº¿ç¨‹æ•°ä¸º0ä¸ªã€‚</p><h4 id="_3-2-çº¿ç¨‹æ± çŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#_3-2-çº¿ç¨‹æ± çŠ¶æ€" aria-hidden="true">#</a> 3.2 çº¿ç¨‹æ± çŠ¶æ€</h4><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-21-4.png" alt="å›¾ 22-4 çº¿ç¨‹æ± çŠ¶æ€æµè½¬"></p><p>å›¾ 22-4 æ˜¯çº¿ç¨‹æ± ä¸­çš„çŠ¶æ€æµè½¬å…³ç³»ï¼ŒåŒ…æ‹¬å¦‚ä¸‹çŠ¶æ€ï¼š</p><ul><li><code>RUNNING</code>ï¼šè¿è¡ŒçŠ¶æ€ï¼Œæ¥å—æ–°çš„ä»»åŠ¡å¹¶ä¸”å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li><li><code>SHUTDOWN</code>ï¼šå…³é—­çŠ¶æ€(è°ƒç”¨äº†shutdownæ–¹æ³•)ã€‚ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œ,ä½†æ˜¯è¦å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li><li><code>STOP</code>ï¼šåœæ­¢çŠ¶æ€(è°ƒç”¨äº†shutdownNowæ–¹æ³•)ã€‚ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå¹¶ä¸”è¦ä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ã€‚</li><li><code>TIDYING</code>ï¼šæ‰€æœ‰çš„ä»»åŠ¡éƒ½å·²ç»ˆæ­¢äº†ï¼ŒworkerCountä¸º0ï¼Œçº¿ç¨‹æ± è¿›å…¥è¯¥çŠ¶æ€åä¼šè°ƒ terminated() æ–¹æ³•è¿›å…¥TERMINATED çŠ¶æ€ã€‚</li><li><code>TERMINATED</code>ï¼šç»ˆæ­¢çŠ¶æ€ï¼Œterminated() æ–¹æ³•è°ƒç”¨ç»“æŸåçš„çŠ¶æ€ã€‚</li></ul><h4 id="_3-3-æäº¤çº¿ç¨‹-execute" tabindex="-1"><a class="header-anchor" href="#_3-3-æäº¤çº¿ç¨‹-execute" aria-hidden="true">#</a> 3.3 æäº¤çº¿ç¨‹(execute)</h4><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-21-5.png" alt="å›¾ 22-5 æäº¤çº¿ç¨‹æµç¨‹å›¾"></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨é˜…è¯»è¿™éƒ¨åˆ†æºç çš„æ—¶å€™ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¬è‡ªå·±å®ç°çš„çº¿ç¨‹æ± ã€‚å…¶å®æœ€ç»ˆçš„ç›®çš„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯è¿™æ®µè¢«æäº¤çš„çº¿ç¨‹ï¼Œ<code>å¯åŠ¨æ‰§è¡Œ</code>ã€<code>åŠ å…¥é˜Ÿåˆ—</code>ã€<code>å†³ç­–ç­–ç•¥</code>ï¼Œè¿™ä¸‰ç§æ–¹å¼ã€‚</p><ul><li><code>ctl.get()</code>ï¼Œå–çš„æ˜¯è®°å½•çº¿ç¨‹çŠ¶æ€å’Œçº¿ç¨‹ä¸ªæ•°çš„å€¼ï¼Œæœ€ç»ˆéœ€è¦ä½¿ç”¨æ–¹æ³• <code>workerCountOf()</code>ï¼Œæ¥è·å–å½“å‰çº¿ç¨‹æ•°é‡ã€‚<em>\`workerCountOf æ‰§è¡Œçš„æ˜¯ c &amp; CAPACITY è¿ç®—</em></li><li>æ ¹æ®å½“å‰çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡ï¼Œä¸æ ¸å¿ƒçº¿ç¨‹æ•° <code>corePoolSize</code> åšå¯¹æ¯”ï¼Œå°äºåˆ™è¿›è¡Œæ·»åŠ çº¿ç¨‹åˆ°ä»»åŠ¡æ‰§è¡Œé˜Ÿåˆ—ã€‚</li><li>å¦‚æœè¯´æ­¤æ—¶çº¿ç¨‹æ•°å·²æ»¡ï¼Œé‚£ä¹ˆåˆ™éœ€è¦åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦ä¸ºè¿è¡ŒçŠ¶æ€ <code>isRunning(c)</code>ã€‚å¦‚æœæ˜¯è¿è¡ŒçŠ¶æ€åˆ™æŠŠä¸èƒ½è¢«æ‰§è¡Œçš„çº¿ç¨‹æ”¾å…¥çº¿ç¨‹é˜Ÿåˆ—ä¸­ã€‚</li><li>æ”¾å…¥çº¿ç¨‹é˜Ÿåˆ—ä»¥åï¼Œè¿˜éœ€è¦é‡æ–°åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¿è¡Œä»¥åŠç§»é™¤æ“ä½œï¼Œå¦‚æœéè¿è¡Œä¸”ç§»é™¤ï¼Œåˆ™è¿›è¡Œæ‹’ç»ç­–ç•¥ã€‚å¦åˆ™åˆ¤æ–­çº¿ç¨‹æ•°é‡ä¸º0åæ·»åŠ æ–°çº¿ç¨‹ã€‚</li><li>æœ€åå°±æ˜¯å†æ¬¡å°è¯•æ·»åŠ ä»»åŠ¡æ‰§è¡Œï¼Œæ­¤æ—¶æ–¹æ³• addWorker çš„ç¬¬äºŒä¸ªå…¥å‚æ˜¯ falseï¼Œæœ€ç»ˆä¼šå½±å“æ·»åŠ æ‰§è¡Œä»»åŠ¡æ•°é‡åˆ¤æ–­ã€‚å¦‚æœæ·»åŠ å¤±è´¥åˆ™è¿›è¡Œæ‹’ç»ç­–ç•¥ã€‚</li></ul><h4 id="_3-5-æ·»åŠ æ‰§è¡Œä»»åŠ¡-addworker" tabindex="-1"><a class="header-anchor" href="#_3-5-æ·»åŠ æ‰§è¡Œä»»åŠ¡-addworker" aria-hidden="true">#</a> 3.5 æ·»åŠ æ‰§è¡Œä»»åŠ¡(addWorker)</h4><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-21-6.png" alt="å›¾ 22-6 æ·»åŠ æ‰§è¡Œä»»åŠ¡é€»è¾‘æµç¨‹"></p><p><strong>private boolean addWorker(Runnable firstTask, boolean core)</strong></p><p><strong>ç¬¬ä¸€éƒ¨åˆ†ã€å¢åŠ çº¿ç¨‹æ•°é‡</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>retry<span class="token operator">:</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Check if queue empty only if necessary.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span>
           firstTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
           <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;=</span> <span class="token constant">CAPACITY</span> <span class="token operator">||</span>
            wc <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>core <span class="token operator">?</span> corePoolSize <span class="token operator">:</span> maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span> retry<span class="token punctuation">;</span>
        c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Re-read ctl</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> rs<span class="token punctuation">)</span>
            <span class="token keyword">continue</span> retry<span class="token punctuation">;</span>
        <span class="token comment">// else CAS failed due to workerCount change; retry inner loop</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç¬¬ä¸€éƒ¨åˆ†ã€åˆ›å»ºå¯åŠ¨çº¿ç¨‹</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">boolean</span> workerStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> workerAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token class-name">Worker</span> w <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
        mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">||</span>
                <span class="token punctuation">(</span>rs <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// precheck that t is startable</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> s <span class="token operator">=</span> workers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;</span> largestPoolSize<span class="token punctuation">)</span>
                    largestPoolSize <span class="token operator">=</span> s<span class="token punctuation">;</span>
                workerAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workerAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            workerStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> workerStarted<span class="token punctuation">)</span>
        <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> workerStarted<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ·»åŠ æ‰§è¡Œä»»åŠ¡çš„æµç¨‹å¯ä»¥åˆ†ä¸ºä¸¤å—çœ‹ï¼Œä¸Šé¢ä»£ç éƒ¨åˆ†æ˜¯ç”¨äºè®°å½•çº¿ç¨‹æ•°é‡ã€ä¸‹é¢ä»£ç éƒ¨åˆ†æ˜¯åœ¨ç‹¬å é”é‡Œåˆ›å»ºæ‰§è¡Œçº¿ç¨‹å¹¶å¯åŠ¨ã€‚<em>è¿™éƒ¨åˆ†ä»£ç åœ¨ä¸çœ‹é”ã€CASç­‰æ“ä½œï¼Œé‚£ä¹ˆå°±å’Œæˆ‘ä»¬æœ€å¼€å§‹æ‰‹å†™çš„çº¿ç¨‹æ± åŸºæœ¬ä¸€æ ·äº†</em></p><ul><li><code>if (rs &gt;= SHUTDOWN &amp;&amp;! (rs == SHUTDOWN &amp;&amp;firstTask == null &amp;&amp;! workQueue.isEmpty()))</code>ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€ï¼Œæ˜¯å¦ä¸º <code>SHUTDOWN</code>ã€<code>STOP</code>ã€<code>TIDYING</code>ã€<code>TERMINATED</code>ä¸­çš„ä¸€ä¸ªã€‚å¹¶ä¸”å½“å‰çŠ¶æ€ä¸º <code>SHUTDOWN</code>ã€ä¸”ä¼ å…¥çš„ä»»åŠ¡ä¸º nullï¼ŒåŒæ—¶é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚é‚£ä¹ˆå°±è¿”å› falseã€‚</li><li><code>compareAndIncrementWorkerCount</code>ï¼ŒCAS æ“ä½œï¼Œå¢åŠ çº¿ç¨‹æ•°é‡ï¼ŒæˆåŠŸå°±ä¼šè·³å‡ºæ ‡è®°çš„å¾ªç¯ä½“ã€‚</li><li><code>runStateOf(c) != rs</code>ï¼Œæœ€åæ˜¯çº¿ç¨‹æ± çŠ¶æ€åˆ¤æ–­ï¼Œå†³å®šæ˜¯å¦å¾ªç¯ã€‚</li><li>åœ¨çº¿ç¨‹æ± æ•°é‡è®°å½•æˆåŠŸåï¼Œåˆ™éœ€è¦è¿›å…¥åŠ é”ç¯èŠ‚ï¼Œåˆ›å»ºæ‰§è¡Œçº¿ç¨‹ï¼Œå¹¶è®°å½•çŠ¶æ€ã€‚åœ¨æœ€åå¦‚æœåˆ¤æ–­æ²¡æœ‰å¯åŠ¨æˆåŠŸï¼Œåˆ™éœ€è¦æ‰§è¡Œ addWorkerFailed æ–¹æ³•ï¼Œå‰”é™¤åˆ°çº¿ç¨‹æ–¹æ³•ç­‰æ“ä½œã€‚</li></ul><h4 id="_3-6-æ‰§è¡Œçº¿ç¨‹-runworker" tabindex="-1"><a class="header-anchor" href="#_3-6-æ‰§è¡Œçº¿ç¨‹-runworker" aria-hidden="true">#</a> 3.6 æ‰§è¡Œçº¿ç¨‹(runWorker)</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">Worker</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> w<span class="token punctuation">.</span>firstTask<span class="token punctuation">;</span>
    w<span class="token punctuation">.</span>firstTask <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å…è®¸ä¸­æ–­</span>
    <span class="token keyword">boolean</span> completedAbruptly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
            w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">STOP</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                 <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                  <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">STOP</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span>wt<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                wt<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">beforeExecute</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Throwable</span> thrown <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token function">afterExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                task <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                w<span class="token punctuation">.</span>completedTasks<span class="token operator">++</span><span class="token punctuation">;</span>
                w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        completedAbruptly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> completedAbruptly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å…¶å®</strong>ï¼Œæœ‰äº†æ‰‹å†™çº¿ç¨‹æ± çš„åŸºç¡€ï¼Œåˆ°è¿™ä¹Ÿå°±åŸºæœ¬äº†è§£äº†ï¼Œçº¿ç¨‹æ± åœ¨å¹²å˜›ã€‚åˆ°è¿™æœ€æ ¸å¿ƒçš„ç‚¹å°±æ˜¯ <code>task.run()</code> è®©çº¿ç¨‹è·‘èµ·æ¥ã€‚é¢å¤–å†é™„å¸¦ä¸€äº›å…¶ä»–æµç¨‹å¦‚ä¸‹ï¼›</p><ul><li><code>beforeExecute</code>ã€<code>afterExecute</code>ï¼Œçº¿ç¨‹æ‰§è¡Œçš„å‰ååšä¸€äº›ç»Ÿè®¡ä¿¡æ¯ã€‚</li><li>å¦å¤–è¿™é‡Œçš„é”æ“ä½œæ˜¯ Worker ç»§æ‰¿ AQS è‡ªå·±å®ç°çš„ä¸å¯é‡å…¥çš„ç‹¬å é”ã€‚</li><li><code>processWorkerExit</code>ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œç±»ä¼¼è¿™æ ·çš„æ–¹æ³•ä¹Ÿå¯ä»¥æ·±å…¥äº†è§£ä¸‹ã€‚<em>åœ¨çº¿ç¨‹é€€å‡ºæ—¶å€™workersåšåˆ°ä¸€äº›ç§»é™¤å¤„ç†ä»¥åŠå®Œæˆä»»åŠ¡æ•°ç­‰ï¼Œä¹Ÿéå¸¸æœ‰æ„æ€</em></li></ul><h4 id="_3-7-é˜Ÿåˆ—è·å–ä»»åŠ¡-gettask" tabindex="-1"><a class="header-anchor" href="#_3-7-é˜Ÿåˆ—è·å–ä»»åŠ¡-gettask" aria-hidden="true">#</a> 3.7 é˜Ÿåˆ—è·å–ä»»åŠ¡(getTask)</h4><p>å¦‚æœä½ å·²ç»å¼€å§‹é˜…è¯»æºç ï¼Œå¯ä»¥åœ¨ runWorker æ–¹æ³•ä¸­ï¼Œçœ‹åˆ°è¿™æ ·ä¸€å¥å¾ªç¯ä»£ç  <code>while (task != null || (task = getTask()) != null)</code>ã€‚è¿™ä¸æˆ‘ä»¬æ‰‹å†™çº¿ç¨‹æ± ä¸­æ“ä½œçš„æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œæ ¸å¿ƒç›®çš„å°±æ˜¯ä»é˜Ÿåˆ—ä¸­è·å–çº¿ç¨‹æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// Did the last poll() time out?</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Check if queue empty only if necessary.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">STOP</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Are workers subject to culling?</span>
        <span class="token keyword">boolean</span> timed <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">||</span> wc <span class="token operator">&gt;</span> corePoolSize<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wc <span class="token operator">&gt;</span> maximumPoolSize <span class="token operator">||</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> timedOut<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Runnable</span> r <span class="token operator">=</span> timed <span class="token operator">?</span>
                workQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>getTask æ–¹æ³•ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ç­‰å¾…è¢«æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¡æ¡å¾€å‡ºæ‹¿çº¿ç¨‹æ–¹æ³•ã€‚</li><li><code>if (rs &gt;= SHUTDOWN ...</code>ï¼Œåˆ¤æ–­çº¿ç¨‹æ˜¯å¦å…³é—­ã€‚</li><li><code>wc = workerCountOf(c)ï¼Œwc &gt; corePoolSize</code>ï¼Œå¦‚æœå·¥ä½œçº¿ç¨‹æ•°è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°é‡ <code>corePoolSize</code> å¹¶ä¸” workQueue ä¸ä¸ºç©ºï¼Œåˆ™å¢åŠ å·¥ä½œçº¿ç¨‹ã€‚ä½†å¦‚æœè¶…æ—¶æœªè·å–åˆ°çº¿ç¨‹ï¼Œåˆ™ä¼šæŠŠå¤§äº corePoolSize çš„çº¿ç¨‹é”€æ¯æ‰ã€‚</li><li><code>timed</code>ï¼Œæ˜¯ <code>allowCoreThreadTimeOut</code> å¾—æ¥çš„ã€‚æœ€ç»ˆ <code>timed</code> ä¸º true æ—¶ï¼Œåˆ™é€šè¿‡é˜»å¡é˜Ÿåˆ—çš„pollæ–¹æ³•è¿›è¡Œè¶…æ—¶æ§åˆ¶ã€‚</li><li>å¦‚æœåœ¨ <code>keepAliveTime</code> æ—¶é—´å†…æ²¡æœ‰è·å–åˆ°ä»»åŠ¡ï¼Œåˆ™è¿”å›nullã€‚å¦‚æœä¸ºfalseï¼Œåˆ™é˜»å¡ã€‚</li></ul><h2 id="å››ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å››ã€æ€»ç»“" aria-hidden="true">#</a> å››ã€æ€»ç»“</h2><ul><li>è¿™ä¸€ç« èŠ‚å¹¶æ²¡æœ‰å®Œå…¨æŠŠçº¿ç¨‹æ± çš„æ‰€æœ‰çŸ¥è¯†ç‚¹éƒ½ä»‹ç»å®Œï¼Œå¦åˆ™ä¸€ç¯‡å†…å®¹ä¼šæœ‰äº›è‡ƒè‚¿ã€‚åœ¨è¿™ä¸€ç« èŠ‚æˆ‘ä»¬ä»æ‰‹å†™çº¿ç¨‹æ± å¼€å§‹ï¼Œé€æ­¥çš„åˆ†æè¿™äº›ä»£ç åœ¨Javaçš„çº¿ç¨‹æ± ä¸­æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹ä¹Ÿå‡ ä¹æ˜¯æˆ‘ä»¬ä»¥å‰ä»‹ç»è¿‡çš„å†…å®¹ï¼ŒåŒ…æ‹¬ï¼šé˜Ÿåˆ—ã€CASã€AQSã€é‡å…¥é”ã€ç‹¬å é”ç­‰å†…å®¹ã€‚æ‰€ä»¥è¿™äº›çŸ¥è¯†ä¹ŸåŸºæœ¬æ˜¯ç¯ç¯ç›¸æ‰£çš„ï¼Œæœ€å¥½æœ‰ä¸€äº›æ ¹åŸºå¦åˆ™ä¼šæœ‰äº›ä¸å¥½ç†è§£ã€‚</li><li>é™¤äº†æœ¬ç« ä»‹ç»çš„ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è®²åˆ°çº¿ç¨‹çš„é”€æ¯è¿‡ç¨‹ã€å››ç§çº¿ç¨‹æ± æ–¹æ³•çš„é€‰æ‹©å’Œä½¿ç”¨ã€ä»¥åŠåœ¨<code>CPUå¯†é›†å‹ä»»åŠ¡</code>ã€<code>IO å¯†é›†å‹ä»»åŠ¡</code>æ—¶è¯¥æ€ä¹ˆé…ç½®ã€‚å¦å¤–åœ¨Springä¸­ä¹Ÿæœ‰è‡ªå·±å®ç°çš„çº¿ç¨‹æ± æ–¹æ³•ã€‚è¿™äº›çŸ¥è¯†ç‚¹éƒ½éå¸¸è´´è¿‘å®é™…æ“ä½œã€‚</li><li>å¥½äº†ï¼Œä»Šå¤©çš„å†…å®¹å…ˆæ‰¯åˆ°è¿™ï¼Œåç»­çš„å†…å®¹é™†ç»­å®Œå–„ã€‚å¦‚æœä»¥ä¸Šå†…å®¹æœ‰é”™å­—ã€æµç¨‹ç¼ºå¤±ã€æˆ–è€…ä¸å¥½ç†è§£ä»¥åŠæè¿°é”™è¯¯ï¼Œæ¬¢è¿ç•™è¨€ã€‚äº’ç›¸å­¦ä¹ ã€äº’ç›¸è¿›æ­¥ã€‚</li></ul>`,72);function v(m,b){const a=t("ExternalLinkIcon");return e(),o("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),k,s("åšå®¢ï¼š"),n("a",r,[s("https://bugstack.cn"),c(a)])]),d])}const y=p(i,[["render",v],["__file","2020-12-09-mianjingshouce Â· di21pianã€Šshouxiexianchengchiï¼ŒduizhaoxuexiThreadPoolExecutorxianchengchishixianyuanliï¼ã€‹.html.vue"]]);export{y as default};
