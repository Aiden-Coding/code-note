import{_ as t,r as p,o as e,c as o,a as n,b as s,d as c,e as l}from"./app-3RcBQnkC.js";const u={},i=n("h1",{id:"websocket与下位机通过netty方式通信传输行为信息",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#websocket与下位机通过netty方式通信传输行为信息","aria-hidden":"true"},"#"),s(" websocket与下位机通过netty方式通信传输行为信息")],-1),k=n("br",null,null,-1),r={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=l(`<blockquote><p>沉淀、分享、成长，让自己和他人都能有所收获！😄</p></blockquote><h2 id="前言介绍" tabindex="-1"><a class="header-anchor" href="#前言介绍" aria-hidden="true">#</a> 前言介绍</h2><p>在物联网开发中，常常需要通过网页端来控制设备，包括；获取信息、执行操作、启动停止等，就像我们在手机上会控制家里的小米盒子、路由器、电饭煲或者在线养狗等一些设备一样。在这里所有的下层设备都可以通过socket通信链接到服务端，而用户一端在通过http链接或者websocket链接到服务端，通过发送和接收数据来做出相应的行为操作。如下图； <img src="https://bugstack.cn/assets/images/pic-content/2019/09/netty-3-01.png" alt="微信公众号：bugstack虫洞栈 &amp; 执行流程"></p><h2 id="案例目标" tabindex="-1"><a class="header-anchor" href="#案例目标" aria-hidden="true">#</a> 案例目标</h2><ol><li>本章节整合Springboot+Netty，通过部署nettySocket与webSocket两套服务端，来接收转发行为消息。</li><li>客户端采用js链接websocket，用于接收服务端反馈与发送指令，用于获取下位机信息。</li><li>在test中启动一个模拟下位机，用于反馈信息数据。在真实开发中下位机与服务端通信通常是定义好的字节码，需要自己编写解码器。</li></ol><h2 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备" aria-hidden="true">#</a> 环境准备</h2><ol><li>jdk 1.8.0</li><li>IntelliJ IDEA Community Edition 2018.3.1 x64</li><li>Netty 4.1.36.Final</li></ol><h2 id="代码示例" tabindex="-1"><a class="header-anchor" href="#代码示例" aria-hidden="true">#</a> 代码示例</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>itstack<span class="token operator">-</span>demo<span class="token operator">-</span>netty<span class="token operator">-</span><span class="token number">3</span><span class="token operator">-</span><span class="token number">01</span>
└── src
    ├── main
    │   ├── java
    │   │   └── org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>ark
    │   │       ├── domain
    │   │       │	├── msgobj
    │   │       │	│   ├── <span class="token class-name">Feedback</span><span class="token punctuation">.</span>java
    │   │       │	│   ├── <span class="token class-name">QueryInfoReq</span><span class="token punctuation">.</span>java
    │   │       │	│   └── <span class="token class-name">Text</span><span class="token punctuation">.</span>java
    │   │       │	├── <span class="token class-name">Device</span><span class="token punctuation">.</span>java
    │   │       │	├── <span class="token class-name">EasyResult</span><span class="token punctuation">.</span>java	
    │   │       │	├── <span class="token class-name">InfoProtocol</span><span class="token punctuation">.</span>java
    │   │       │	└── <span class="token class-name">ServerInfo</span><span class="token punctuation">.</span>java	
    │   │       ├── server
    │   │       │	├── socket
    │   │       │	│   ├── <span class="token class-name">MyChannelInitializer</span><span class="token punctuation">.</span>java
    │   │       │	│   ├── <span class="token class-name">MyServerHandler</span><span class="token punctuation">.</span>java
    │   │       │	│   └── <span class="token class-name">NettyServer</span><span class="token punctuation">.</span>java	
    │   │       │	└── websocket
    │   │       │	    ├── <span class="token class-name">MyWsChannelInitializer</span><span class="token punctuation">.</span>java
    │   │       │	    ├── <span class="token class-name">MyWsServerHandler</span><span class="token punctuation">.</span>java
    │   │       │	    └── <span class="token class-name">WsNettyServer</span><span class="token punctuation">.</span>java
    │   │       ├── util
    │   │       │	├── <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span>java
    │   │       │	├── <span class="token class-name">MsgUtil</span><span class="token punctuation">.</span>java
    │   │       │	└── <span class="token class-name">MsgUtil</span><span class="token punctuation">.</span>java
    │   │       ├── web
    │   │       │	└── <span class="token class-name">NettyController</span><span class="token punctuation">.</span>java	
    │   │       └── <span class="token class-name">Application</span><span class="token punctuation">.</span>java
    │   └── resources	
    │   │   └── application<span class="token punctuation">.</span>yml
    │   └── webapp
    │       ├── arkWs
    │       │	├── js
    │       │	│   └── ws<span class="token punctuation">.</span>js	
    │       │   └── arkWsControlCenter<span class="token punctuation">.</span>html	
    │       ├── res		
    │       └── <span class="token constant">WEB</span><span class="token operator">-</span><span class="token constant">INF</span>
    │        	└── index<span class="token punctuation">.</span>jsp	
    │
    └── test
        └── java
            └── org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>test
                └── <span class="token class-name">ApiTest</span><span class="token punctuation">.</span>java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>演示部分重点代码块，完整代码下载关注公众号；bugstack虫洞栈，回复Netty案例</strong></p><blockquote><p>server/socket/MyServerHandler.java &amp; socket数据处理</p></blockquote><ul><li>当有下位机链接服务端时，构建下位机信息，实际使用可以通过注册方式进行链接验证。</li><li>当收到下位机信息后转发到websocket端，使网页端收到下位机信息反馈</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">MyServerHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 当客户端主动链接服务端的链接后，这个通道就是活跃的了。也就是客户端与服务端建立了通信通道并且可以传输数据
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SocketChannel</span> channel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> channelId <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;链接报告开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;链接报告信息：有一客户端链接到本服务端。channelId：&quot;</span> <span class="token operator">+</span> channelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;链接报告IP:&quot;</span> <span class="token operator">+</span> channel<span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;链接报告Port:&quot;</span> <span class="token operator">+</span> channel<span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;链接报告完毕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//构建设备信息｛下位机、中继器、IO板卡｝</span>
        <span class="token class-name">Device</span> device <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        device<span class="token punctuation">.</span><span class="token function">setChannelId</span><span class="token punctuation">(</span>channelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        device<span class="token punctuation">.</span><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        device<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        device<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        device<span class="token punctuation">.</span><span class="token function">setConnectTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//添加设备信息</span>
        deviceGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>channelId<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span>cacheClientChannel<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>channelId<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> objMsgJsonStr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//接收设备发来信息</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 接收到消息内容：&quot;</span> <span class="token operator">+</span> objMsgJsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//转发消息到Ws</span>
        <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span>wsChannelGroup<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextWebSocketFrame</span><span class="token punctuation">(</span>objMsgJsonStr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>server/websocket/MyWsServerHandler.java &amp; websocket数据处理</p></blockquote><ul><li>websocket数据需要转换后使用，可以支持文本消息，本案例中使用json字符串，方便对象传输</li><li>channelRead转发数据，当收到数据后发送给下位机，主要通过内容中channel控制</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyWsServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">//ws</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">WebSocketFrame</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">WebSocketFrame</span> webSocketFrame <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WebSocketFrame</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
            <span class="token comment">//关闭请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>webSocketFrame <span class="token keyword">instanceof</span> <span class="token class-name">CloseWebSocketFrame</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                handshaker<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">CloseWebSocketFrame</span><span class="token punctuation">)</span> webSocketFrame<span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//ping请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>webSocketFrame <span class="token keyword">instanceof</span> <span class="token class-name">PingWebSocketFrame</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PongWebSocketFrame</span><span class="token punctuation">(</span>webSocketFrame<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">retain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//只支持文本格式，不支持二进制消息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>webSocketFrame <span class="token keyword">instanceof</span> <span class="token class-name">TextWebSocketFrame</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;仅支持文本格式&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TextWebSocketFrame</span><span class="token punctuation">)</span> webSocketFrame<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端收到：&quot;</span> <span class="token operator">+</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InfoProtocol</span> infoProtocol <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">InfoProtocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//socket转发消息</span>
            <span class="token class-name">String</span> channelId <span class="token operator">=</span> infoProtocol<span class="token punctuation">.</span><span class="token function">getChannelId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span>cacheClientChannel<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>channelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> channel<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">MsgUtil</span><span class="token punctuation">.</span><span class="token function">buildMsg</span><span class="token punctuation">(</span>infoProtocol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//websocket消息反馈发送成功</span>
            ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">MsgUtil</span><span class="token punctuation">.</span><span class="token function">buildWsMsgText</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;向下位机传达消息success！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>web/NettyController.java &amp; 控制层方便获取服务端信息</p></blockquote><ul><li>控制层提供了查询服务列表、链接设备信息、以及主动触发信息发送</li><li>另外如果需要将服务端的启动关闭进行手动控制，可以在这里面提供方法供调用</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyController</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">NettyController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/queryNettyServerList&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryNettyServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerInfo</span><span class="token punctuation">&gt;</span></span> serverInfos <span class="token operator">=</span> <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span>serverInfoMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;查询服务端列表。{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>serverInfos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> serverInfos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;查询服务端列表失败。&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/queryDeviceList&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Device</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryDeviceList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Device</span><span class="token punctuation">&gt;</span></span> deviceInfos <span class="token operator">=</span> <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span>deviceGroup<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;查询设备链接列表。{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>deviceInfos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> deviceInfos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;查询设备链接列表失败。&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/doSendMsg&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">EasyResult</span> <span class="token function">doSendMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> reqStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;向设备发送信息[可以通过另外一个Web服务调用本接口发送信息]：{}&quot;</span><span class="token punctuation">,</span> reqStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InfoProtocol</span> infoProtocol <span class="token operator">=</span> <span class="token class-name">MsgUtil</span><span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span>reqStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> channelId <span class="token operator">=</span> infoProtocol<span class="token punctuation">.</span><span class="token function">getChannelId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span>cacheClientChannel<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>channelId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">MsgUtil</span><span class="token punctuation">.</span><span class="token function">buildMsg</span><span class="token punctuation">(</span>infoProtocol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">EasyResult</span><span class="token punctuation">.</span><span class="token function">buildSuccessResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;向设备发送信息失败：{}&quot;</span><span class="token punctuation">,</span> reqStr<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">EasyResult</span><span class="token punctuation">.</span><span class="token function">buildErrResult</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>Application.java &amp; 启动层</p></blockquote><ul><li>通过继承CommandLineRunner方法，在服务就绪后启动socket服务</li><li>启动后需要循环验证是否启动完成</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token string">&quot;org.itstack.demo.ark&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token keyword">implements</span> <span class="token class-name">CommandLineRunner</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${netty.socket.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> nettyServerPort<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${netty.websocket.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> nettyWsServerPort<span class="token punctuation">;</span>
    <span class="token comment">//默认线程池</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//启动NettyServer-socket</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;启动NettyServer服务，启动端口：{}&quot;</span><span class="token punctuation">,</span> nettyServerPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NettyServer</span> nettyServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>nettyServerPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>nettyServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;netty server-s open error channel is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>channel<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;启动NettyServer服务，循环等待启动...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;启动NettyServer服务，完成：{}&quot;</span><span class="token punctuation">,</span> channel<span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span>serverInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>nettyServerPort<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ServerInfo</span><span class="token punctuation">(</span><span class="token string">&quot;NettySocket&quot;</span><span class="token punctuation">,</span> <span class="token class-name">NetUtil</span><span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nettyServerPort<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//启动NettyServer-websocket</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;启动NettyWsServer服务，启动端口：{}&quot;</span><span class="token punctuation">,</span> nettyWsServerPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WsNettyServer</span> wsNettyServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsNettyServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>nettyWsServerPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span> wsFuture <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>wsNettyServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Channel</span> wsChannel <span class="token operator">=</span> wsFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> wsChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;netty server-ws open error channel is null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>wsChannel<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;启动NettyWsServer服务，循环等待启动...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;启动NettyWsServer服务，完成：{}&quot;</span><span class="token punctuation">,</span> wsChannel<span class="token punctuation">.</span><span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CacheUtil</span><span class="token punctuation">.</span>serverInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>nettyServerPort<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ServerInfo</span><span class="token punctuation">(</span><span class="token string">&quot;NettyWsSocket&quot;</span><span class="token punctuation">,</span> <span class="token class-name">NetUtil</span><span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nettyServerPort<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>webapp/arkWs/js/ws.js &amp; 链接websocket服务端</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://localhost:7398/websocket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	socket<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">{</span>

		<span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		$<span class="token punctuation">(</span><span class="token string">&quot;#msgBox&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token string">&quot;#msgBox&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token string">&quot;\\r\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="案例测试" tabindex="-1"><a class="header-anchor" href="#案例测试" aria-hidden="true">#</a> 案例测试</h2><ol><li>分别启动如下内容； <ol><li>Application.java，Plugins/spring-boot/spring-boot:run</li><li>ApiTest.java，右键启动模拟下位机</li></ol></li><li>打开服务端链接；http://localhost:8080/ http://localhost:8080/arkWs/arkWsControlCenter.html <img src="https://bugstack.cn/assets/images/pic-content/2019/09/netty-3-02.png" alt="微信公众号：bugstack虫洞栈 &amp; 服务端与监控"></li><li>发送模拟信息，观察执行结果；<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">49.965</span>  <span class="token constant">INFO</span> <span class="token number">7620</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>a<span class="token punctuation">.</span>c<span class="token punctuation">.</span>c<span class="token punctuation">.</span></span>C</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token class-name">Tomcat</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>localhost<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token operator">/</span><span class="token punctuation">]</span>       <span class="token operator">:</span> <span class="token class-name">Initializing</span> <span class="token class-name">Spring</span> <span class="token class-name">FrameworkServlet</span> &#39;dispatcherServlet&#39;
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">49.965</span>  <span class="token constant">INFO</span> <span class="token number">7620</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span>DispatcherServlet</span>        <span class="token operator">:</span> <span class="token class-name">FrameworkServlet</span> &#39;dispatcherServlet&#39;<span class="token operator">:</span> initialization started
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">49.980</span>  <span class="token constant">INFO</span> <span class="token number">7620</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span>DispatcherServlet</span>        <span class="token operator">:</span> <span class="token class-name">FrameworkServlet</span> &#39;dispatcherServlet&#39;<span class="token operator">:</span> initialization completed in <span class="token number">15</span> ms
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">51.157</span>  <span class="token constant">INFO</span> <span class="token number">7620</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>ark<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span>NettyController</span>   <span class="token operator">:</span> 查询设备链接列表。<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;channelId&quot;</span><span class="token operator">:</span><span class="token string">&quot;281d1279&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;connectTime&quot;</span><span class="token operator">:</span><span class="token number">1575184302964</span><span class="token punctuation">,</span><span class="token string">&quot;ip&quot;</span><span class="token operator">:</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;number&quot;</span><span class="token operator">:</span><span class="token string">&quot;74de0967-c0b4-4426-a9d1-183feaff2acf&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;port&quot;</span><span class="token operator">:</span><span class="token number">3972</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">51.162</span>  <span class="token constant">INFO</span> <span class="token number">7620</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>ark<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span>NettyController</span>   <span class="token operator">:</span> 查询服务端列表。<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;ip&quot;</span><span class="token operator">:</span><span class="token string">&quot;10.13.70.50&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;openDate&quot;</span><span class="token operator">:</span><span class="token number">1575184290501</span><span class="token punctuation">,</span><span class="token string">&quot;port&quot;</span><span class="token operator">:</span><span class="token number">7397</span><span class="token punctuation">,</span><span class="token string">&quot;typeInfo&quot;</span><span class="token operator">:</span><span class="token string">&quot;NettyWsSocket&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">58.476</span>  <span class="token constant">INFO</span> <span class="token number">7620</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>ntLoopGroup<span class="token operator">-</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>d<span class="token punctuation">.</span>a<span class="token punctuation">.</span>s<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span>MyWsServerHandler</span>    <span class="token operator">:</span> 链接报告开始
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">58.476</span>  <span class="token constant">INFO</span> <span class="token number">7620</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>ntLoopGroup<span class="token operator">-</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>d<span class="token punctuation">.</span>a<span class="token punctuation">.</span>s<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span>MyWsServerHandler</span>    <span class="token operator">:</span> 链接报告信息：有一客户端链接到本服务端
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">58.476</span>  <span class="token constant">INFO</span> <span class="token number">7620</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>ntLoopGroup<span class="token operator">-</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>d<span class="token punctuation">.</span>a<span class="token punctuation">.</span>s<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span>MyWsServerHandler</span>    <span class="token operator">:</span> 链接报告<span class="token constant">IP</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">1</span>
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">58.476</span>  <span class="token constant">INFO</span> <span class="token number">7620</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>ntLoopGroup<span class="token operator">-</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>d<span class="token punctuation">.</span>a<span class="token punctuation">.</span>s<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span>MyWsServerHandler</span>    <span class="token operator">:</span> 链接报告<span class="token class-name">Port</span><span class="token operator">:</span><span class="token number">7398</span>
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">58.476</span>  <span class="token constant">INFO</span> <span class="token number">7620</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>ntLoopGroup<span class="token operator">-</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>d<span class="token punctuation">.</span>a<span class="token punctuation">.</span>s<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span>MyWsServerHandler</span>    <span class="token operator">:</span> 链接报告完毕
 服务端收到：<span class="token punctuation">{</span><span class="token string">&quot;channelId&quot;</span><span class="token operator">:</span><span class="token string">&quot;281d1279&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;msgType&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;msgObj&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;stateType&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">05</span> 接收到消息内容：<span class="token punctuation">{</span><span class="token string">&quot;msgObj&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;stateMsg&quot;</span><span class="token operator">:</span><span class="token string">&quot;温度信息：91.31334894176383°C&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;stateType&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;channelId&quot;</span><span class="token operator">:</span><span class="token string">&quot;93c1120a&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;msgType&quot;</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;channelId&quot;</span><span class="token operator">:</span><span class="token string">&quot;93c1120a&quot;</span><span class="token punctuation">}</span>
 服务端收到：<span class="token punctuation">{</span><span class="token string">&quot;channelId&quot;</span><span class="token operator">:</span><span class="token string">&quot;281d1279&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;msgType&quot;</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;msgObj&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;stateType&quot;</span><span class="token operator">:</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
 <span class="token number">2019</span><span class="token operator">-</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">05</span> 接收到消息内容：<span class="token punctuation">{</span><span class="token string">&quot;msgObj&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;stateMsg&quot;</span><span class="token operator">:</span><span class="token string">&quot;温度信息：44.83794772946285°C&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;stateType&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;channelId&quot;</span><span class="token operator">:</span><span class="token string">&quot;93c1120a&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;msgType&quot;</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;channelId&quot;</span><span class="token operator">:</span><span class="token string">&quot;93c1120a&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h2 id="综上总结" tabindex="-1"><a class="header-anchor" href="#综上总结" aria-hidden="true">#</a> 综上总结</h2><ol><li>在使用springboot与netty结合，开发一个简便的服务端还是很方便的，而且在集合一些springcloud的服务，可以使项目工程更加完善。</li><li>可以尝试做一些设备控制服务，在我们不在家的时候也可以通过一个h5链接控制家里的设备，比如快到家将热水器打开。</li><li>本案例还偏向于模拟，在实际开发过程中还是会出现很多业务问题需要解决，尤其是服务端与下位机的通信，需要编写编码器与解码器。</li></ol><p>微信搜索「<strong>bugstack虫洞栈</strong>」公众号，关注后回复「<strong>netty案例</strong>」获取本文源码&amp;更多原创专题案例！</p>`,29);function v(m,b){const a=p("ExternalLinkIcon");return e(),o("div",null,[i,n("p",null,[s("作者：小傅哥 "),k,s("博客："),n("a",r,[s("https://bugstack.cn"),c(a)])]),d])}const y=t(u,[["render",v],["__file","2019-12-01-websocketyuxiaweijitongguonettyfangshitongxinchuanshuxingweixinxi.html.vue"]]);export{y as default};
