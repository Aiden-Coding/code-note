import{_ as t,r as p,o as e,c as o,a as n,b as s,d as c,e as l}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"nettyæ¡ˆä¾‹-netty4-1æºç åˆ†æç¯‡äºŒã€Šserverbootstrapé…ç½®ä¸ç»‘å®šå¯åŠ¨ã€‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#nettyæ¡ˆä¾‹-netty4-1æºç åˆ†æç¯‡äºŒã€Šserverbootstrapé…ç½®ä¸ç»‘å®šå¯åŠ¨ã€‹","aria-hidden":"true"},"#"),s(" nettyæ¡ˆä¾‹ï¼Œnetty4.1æºç åˆ†æç¯‡äºŒã€ŠServerBootstrapé…ç½®ä¸ç»‘å®šå¯åŠ¨ã€‹")],-1),k=n("br",null,null,-1),r={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=l(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><p>ç»“åˆä¸Šä¸€ç« èŠ‚ä»‹ç»NioEventLoopGroupï¼Œæœ¬ç« èŠ‚ç»§ç»­ä»‹ç»ServerBootstrapç›¸å…³ä»£ç ã€‚</p><blockquote><p>å¯åŠ¨NettyServerçš„æ¨¡ç‰ˆä»£ç </p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">bing</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">EventLoopGroup</span> parentGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token class-name">EventLoopGroup</span> childGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>parentGroup<span class="token punctuation">,</span> childGroup<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>    <span class="token comment">//éé˜»å¡æ¨¡å¼</span>
                <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyChannelInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;itstack-demo-netty server start done. {å…³æ³¨å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆï¼Œè·å–æºç }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        childGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        parentGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="serverbootstrapä¸bootstrap" tabindex="-1"><a class="header-anchor" href="#serverbootstrapä¸bootstrap" aria-hidden="true">#</a> ServerBootstrapä¸Bootstrap</h2><ul><li>å®ƒä»¬éƒ½æ˜¯ç»§æ‰¿äºAbstractBootstrapï¼Œåˆ†åˆ«è´Ÿè´£æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯ï¼›</li><li>ServerBootstrapï¼ŒæœåŠ¡ç«¯ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥å¹¶ä¸ºæ¥æ”¶è¿æ¥çš„ç”¨æˆ·åˆ›å»ºChannelé€šé“</li><li>BootStrapï¼Œå®¢æˆ·ç«¯ä¸æ¥æ”¶è¿æ¥ï¼Œå¹¶ä¸”æ˜¯åœ¨çˆ¶é€šé“å®Œæˆç³»åˆ—æ“ä½œã€‚</li></ul><p>** ç±»ç»§æ‰¿ç»“æ„å›¾ï¼š**</p><p><img src="https://bugstack.cn/assets/images/pic-content/2019/08/netty-4-2-2.png" alt=""></p><h2 id="serverbootstrapå¯åŠ¨æµç¨‹æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#serverbootstrapå¯åŠ¨æµç¨‹æºç åˆ†æ" aria-hidden="true">#</a> ServerBootstrapå¯åŠ¨æµç¨‹æºç åˆ†æ</h2><p>1ã€ å¤„ç†è¯´æ˜</p><ul><li>æ–°å»ºNioEventLoopGroupç±»å‹çš„bossGroupå’Œgroupã€‚bossGroupä¸»è¦å¤„ç†æœåŠ¡ç«¯æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥å¤„ç†ï¼Œgroupä¸»è¦å¤„ç†è¯»å†™ç­‰I/Oäº‹ä»¶åŠä»»åŠ¡ç­‰ï¼›</li><li>åˆ›å»ºServerBootstrapï¼Œå…¶ä¸»è¦å¯¹ä¸€äº›å¤„ç†è¿›è¡Œä»£ç†ï¼Œå¦‚bind()ç­‰æ“ä½œï¼Œå…¶æ˜¯å…¶ä»–ç±»çš„ä¸€ä¸ªç®€å•é—¨é¢ï¼›</li><li>channel()æ–¹æ³•è®¾ç½®æœåŠ¡ç«¯çš„ServerSocketChannelå®ç°ç±»ï¼Œæœ¬å¤„å®ç°ç±»ä¸ºNioServerSocketChannelã€‚</li><li>option()æ–¹æ³•è®¾ç½®Channelçš„ç›¸å…³é€‰é¡¹ï¼Œå…·ä½“æŸ¥çœ‹ChannelOptionä¸­çš„å®šä¹‰ï¼›</li><li>localAddress()è®¾ç½®æœåŠ¡ç«¯ç»‘å®šçš„æœ¬åœ°åœ°å€åŠç«¯å£ï¼›</li><li>handler()è®¾ç½®æœåŠ¡ç«¯çš„å¯¹åº”Channelçš„Handler;</li><li>childHandler()è®¾ç½®å­è¿æ¥çš„Channelçš„Handlerï¼›</li><li>bind()åŠsync()ç»‘å®šæœ¬åœ°åœ°å€å¹¶åŒæ­¥è¿”å›ç»‘å®šç»“æœï¼›</li></ul><p>2ã€ bing()è°ƒç”¨æµç¨‹ <img src="https://bugstack.cn/assets/images/pic-content/2019/08/netty-4-2-1.png" alt=""></p><ul><li>è°ƒç”¨ServerBootstrap.bind()ï¼šåº”ç”¨è°ƒç”¨ServerBootstrapçš„bind()æ“ä½œï¼›</li><li>è°ƒç”¨AbstractBootstrap.bind()ï¼šè°ƒç”¨doBind()å¯¹è¿›è¡Œbindæ“ä½œï¼›</li><li>è°ƒç”¨AbstractBootstrap.initAndRegister()ï¼šåˆ©ç”¨ChannelFactory.newChannel()å®ä¾‹åŒ–NioServerSocketChannelï¼›</li><li>è°ƒç”¨ServerBootstrap.init()ï¼šå¯¹NioServerSocketChannelè¿›è¡Œåˆå§‹åŒ–ï¼Œä¸»è¦æ“ä½œå¦‚è®¾ç½®Channelç›¸å…³çš„é€‰é¡¹åŠå±æ€§ã€è®¾ç½®ChannelHandlerä¸ºServerBootstrapAcceptorç­‰ï¼ŒServerBootstrapAcceptorä¸ºinboundç±»å‹çš„ChannelHandlerï¼Œå…¶ä¸ºServerBootstrapçš„å†…éƒ¨ç±»ï¼Œå…¶ä¸»è¦å®ç°ChannelRead()æ“ä½œï¼Œå°†å®¢æˆ·ç«¯çš„è¿æ¥æ³¨å†Œåˆ°EventLoopGroupçš„EventLoopä¸­ã€‚</li><li>è°ƒç”¨NioEventLoop.register()ï¼šå°†NioServerSocketChannelæ³¨å†Œåˆ°bossGroupä¸­ã€‚</li><li>è°ƒç”¨AbstractBootstrap.doBind0ï¼šå°†å®é™…çš„bindæ“ä½œä»¥ä»»åŠ¡çš„å½¢å¼æ·»åŠ åˆ°bossGroupçš„EventLoopä¸­ã€‚</li><li>è°ƒç”¨NioServerSocketChannel.bind()ï¼šåœ¨EventLoopä¸­ä»¥ä»»åŠ¡çš„å½¢å¼è°ƒç”¨æ­¤æ–¹æ³•è¿›è¡Œå®é™…çš„bind()æ“ä½œã€‚</li></ul><h2 id="æºç æ–¹æ³•åˆ†æ" tabindex="-1"><a class="header-anchor" href="#æºç æ–¹æ³•åˆ†æ" aria-hidden="true">#</a> æºç æ–¹æ³•åˆ†æ</h2><h3 id="_1ã€dobind-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_1ã€dobind-æºç åˆ†æ" aria-hidden="true">#</a> 1ã€doBind()æºç åˆ†æ</h3><blockquote><p>AbstractBootstrap.java | AbstractBootstrap.doBind()</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ChannelFuture</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Channel</span> channel <span class="token operator">=</span> regFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// At this point we know that the registration was complete and successful.</span>
		<span class="token class-name">ChannelPromise</span> promise <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> promise<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// Registration future is almost always fulfilled already, but just in case it&#39;s not.</span>
		<span class="token keyword">final</span> <span class="token class-name">PendingRegistrationPromise</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingRegistrationPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
		regFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
				<span class="token class-name">Throwable</span> cause <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an</span>
					<span class="token comment">// IllegalStateException once we try to access the EventLoop of the Channel.</span>
					promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token comment">// Registration was successful, so set the correct executor to use.</span>
					<span class="token comment">// See https://github.com/netty/netty/issues/2586</span>
					promise<span class="token punctuation">.</span><span class="token function">registered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> promise<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>** ä¸»è¦æµç¨‹å¤„ç† **</p><ul><li>è°ƒç”¨initAndRegister()åˆå§‹åŒ–Channelå¹¶å°†å…¶æ³¨å†Œåˆ°bossGroupä¸­çš„NioEventLoopä¸­ï¼›</li><li>è‹¥æ³¨å†ŒæˆåŠŸï¼Œåˆ™è°ƒç”¨doBind0()è¿›è¡Œå®é™…çš„bindæ“ä½œï¼›</li><li>è‹¥è¿˜æœªæ³¨å†Œï¼Œåˆ™åˆ›å»ºæ³¨å†Œç»“æœçš„ç›‘å¬å™¨åŠdoBind0()çš„å¼‚æ­¥ç»“æœï¼Œè‹¥Channelæ³¨å†ŒæˆåŠŸï¼Œåˆ™åœ¨ç»“æœç›‘å¬å™¨ä¸­è¿›è¡ŒdoBind0()æ“ä½œï¼Œå¹¶å°†bind()å¼‚æ­¥ç»“æœè¿™ç§ä¸ºæˆåŠŸï¼›å¦åˆ™å°†åœ¨ç›‘å¬å™¨ä¸­è®¾ç½®å¼‚æ­¥ç»“æœä¸ºå¤±è´¥ï¼›</li></ul><h3 id="_2ã€-initandregister-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_2ã€-initandregister-æºç åˆ†æ" aria-hidden="true">#</a> 2ã€ initAndRegister()æºç åˆ†æ</h3><blockquote><p>AbstractBootstrap.java | AbstractBootstrap.initAndRegister()</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		channel <span class="token operator">=</span> channelFactory<span class="token punctuation">.</span><span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">init</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// channel can be null if newChannel crashed (eg SocketException(&quot;too many open files&quot;))</span>
			channel<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeForcibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token class-name">GlobalEventExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FailedChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">GlobalEventExecutor</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">isRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			channel<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeForcibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// If we are here and the promise is not failed, it&#39;s one of the following cases:</span>
	<span class="token comment">// 1) If we attempted registration from the event loop, the registration has been completed at this point.</span>
	<span class="token comment">//    i.e. It&#39;s safe to attempt bind() or connect() now because the channel has been registered.</span>
	<span class="token comment">// 2) If we attempted registration from the other thread, the registration request has been successfully</span>
	<span class="token comment">//    added to the event loop&#39;s task queue for later execution.</span>
	<span class="token comment">//    i.e. It&#39;s safe to attempt bind() or connect() now:</span>
	<span class="token comment">//         because bind() or connect() will be executed *after* the scheduled registration task is executed</span>
	<span class="token comment">//         because register(), bind(), and connect() are all bound to the same thread.</span>

	<span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>** ä¸»è¦å¤„ç†æµç¨‹ **</p><ul><li>é€šè¿‡ChannelFactoryæ–°åˆ›å»ºä¸€ä¸ªChannelï¼›</li><li>è°ƒç”¨ServerBootstrapçš„init()æ–¹æ³•å¯¹Channelè¿›è¡Œåˆå§‹åŒ–ï¼›</li></ul><h3 id="_3ã€init-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_3ã€init-æºç åˆ†æ" aria-hidden="true">#</a> 3ã€init()æºç åˆ†æ</h3><blockquote><p>AbstractBootstrap.java | AbstractBootstrap.init()</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> options <span class="token operator">=</span> <span class="token function">options0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">setChannelOptions</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> options<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attrs <span class="token operator">=</span> <span class="token function">attrs0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> e<span class="token operator">:</span> attrs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
			<span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			channel<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> currentChildGroup <span class="token operator">=</span> childGroup<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">ChannelHandler</span> currentChildHandler <span class="token operator">=</span> childHandler<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentChildOptions<span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> currentChildAttrs<span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		currentChildOptions <span class="token operator">=</span> childOptions<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token function">newOptionArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>childAttrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		currentChildAttrs <span class="token operator">=</span> childAttrs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token function">newAttrArray</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Channel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Channel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
			<span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ChannelHandler</span> handler <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			ch<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token annotation punctuation">@Override</span>
				<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerBootstrapAcceptor</span><span class="token punctuation">(</span>
							ch<span class="token punctuation">,</span> currentChildGroup<span class="token punctuation">,</span> currentChildHandler<span class="token punctuation">,</span> currentChildOptions<span class="token punctuation">,</span> currentChildAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>** ä¸»è¦å¤„ç†æµç¨‹ **</p><ul><li>å¦‚æœè®¾ç½®äº†Channelé€‰é¡¹ï¼Œåˆ™è°ƒç”¨setChannelOptions()å¯¹Channelè¿›è¡Œé€‰é¡¹è®¾ç½®ï¼›</li><li>å¦‚æœè®¾ç½®äº†å±æ€§ï¼Œåˆ™å°†å¯¹åº”å±æ€§è®¾ç½®ä¸ºChannelçš„å±æ€§ï¼›</li><li>è®¾ç½®å­Channelçš„é€‰é¡¹åŠå±æ€§ï¼›</li><li>åˆå§‹åŒ–NioServerSocketChannelçš„ChannelHandlerä¸ºServerBootstrapAcceptorï¼ŒServerBootstrapAcceptorä¸ºinboundç±»å‹çš„ChannelHandlerï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯å°†å·²ç»æ¥å—è¿æ¥çš„å­Channelæ³¨å†Œåˆ°workerGroupçš„NioEventLoopä¸­ï¼›</li></ul><h3 id="_4ã€-dobind0-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_4ã€-dobind0-æºç åˆ†æ" aria-hidden="true">#</a> 4ã€ doBind0()æºç åˆ†æ</h3><blockquote><p>AbstractBootstrap.java | AbstractBootstrap.doBind0()</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doBind0</span><span class="token punctuation">(</span>
            <span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span>
            <span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span>
        <span class="token comment">// the pipeline in its channelRegistered() implementation.</span>
        channel<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    channel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token class-name">ChannelFutureListener</span><span class="token punctuation">.</span><span class="token constant">CLOSE_ON_FAILURE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>** ä¸»è¦å¤„ç†æµç¨‹ **</p><ul><li>å°†NioServerSocketChannel.bind()æ“ä½œå°è£…ä¸ºä»»åŠ¡ï¼Œå¹¶å°†ä»»åŠ¡æäº¤ç»™å…¶å¯¹åº”çš„EventLoopè¿›è¡Œå¤„ç†ï¼›</li></ul><h3 id="_5ã€-serverbootstrapacceptoræºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_5ã€-serverbootstrapacceptoræºç åˆ†æ" aria-hidden="true">#</a> 5ã€ ServerBootstrapAcceptoræºç åˆ†æ</h3><p>ServerBootstrapAcceptorä¸ºNioServerSocketChannelçš„ - ChannelHandlerï¼Œå…¶ç±»å‹ä¸ºInboundç±»å‹ï¼›</p><blockquote><p>ServerBootstrapAcceptor.java</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ServerBootstrapAcceptor</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> childOptions<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> childAttrs<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Runnable</span> enableAutoReadTask<span class="token punctuation">;</span>

	<span class="token class-name">ServerBootstrapAcceptor</span><span class="token punctuation">(</span>
			<span class="token keyword">final</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">,</span>
			<span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelOption</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> childOptions<span class="token punctuation">,</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> childAttrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>childGroup <span class="token operator">=</span> childGroup<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>childHandler <span class="token operator">=</span> childHandler<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>childOptions <span class="token operator">=</span> childOptions<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>childAttrs <span class="token operator">=</span> childAttrs<span class="token punctuation">;</span>

		<span class="token comment">// Task which is scheduled to re-enable auto-read.</span>
		<span class="token comment">// It&#39;s important to create this Runnable before we try to submit it as otherwise the URLClassLoader may</span>
		<span class="token comment">// not be able to load the class because of the file limit it already reached.</span>
		<span class="token comment">//</span>
		<span class="token comment">// See https://github.com/netty/netty/issues/1328</span>
		enableAutoReadTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				channel<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoRead</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">final</span> <span class="token class-name">Channel</span> child <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Channel</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>

		child<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>childHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">setChannelOptions</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> childOptions<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttributeKey</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> e<span class="token operator">:</span> childAttrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			child<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			childGroup<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token annotation punctuation">@Override</span>
				<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">forceClose</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> child<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		child<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeForcibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to register an accepted channel: {}&quot;</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
		<span class="token keyword">final</span> <span class="token class-name">ChannelConfig</span> config <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isAutoRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// stop accept new connections for 1 second to allow the channel to recover</span>
			<span class="token comment">// See https://github.com/netty/netty/issues/1328</span>
			config<span class="token punctuation">.</span><span class="token function">setAutoRead</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>enableAutoReadTask<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// still let the exceptionCaught event flow through the pipeline to give the user</span>
		<span class="token comment">// a chance to do something with it</span>
		ctx<span class="token punctuation">.</span><span class="token function">fireExceptionCaught</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>** ServerBootstrapAcceptorä¸»è¦å®ç°äº†ä»¥ä¸‹æ–¹æ³•ï¼š **</p><ul><li>channelRead()ï¼šè®¾ç½®å­è¿æ¥çš„ChannelHandlerã€è®¾ç½®å­è¿æ¥çš„Channelé€‰é¡¹ï¼Œè®¾ç½®å­è¿æ¥çš„Channelå±æ€§ï¼Œå°†å­è¿æ¥æ³¨å†Œçš„childå¯¹åº”çš„EventLoopä¸­ï¼ˆå³workerGroupçš„EventLoopä¸­ï¼‰ï¼›</li><li>exceptionCaught()ï¼šè‹¥ServerSocketChannelåœ¨acceptå­è¿æ¥æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œè‹¥ServerSocketChannelçš„autoReadä¸ºtrueï¼Œåˆ™è®¾ç½®å…¶ä¸ºfalseï¼Œå³ä¸å…è®¸è‡ªåŠ¨æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œå¹¶å»¶è¿Ÿ1såå†è®¾ç½®å…¶ä¸ºtrueï¼Œä½¿å…¶å…è®¸è‡ªåŠ¨æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼›</li></ul><p>å¾®ä¿¡æœç´¢ã€Œ<strong>bugstackè™«æ´æ ˆ</strong>ã€å…¬ä¼—å·ï¼Œå…³æ³¨åå›å¤ã€Œ<strong>rpcæ¡ˆä¾‹æºç </strong>ã€è·å–æœ¬æ–‡æºç &amp;æ›´å¤šåŸåˆ›ä¸“é¢˜æ¡ˆä¾‹ï¼</p>`,41);function v(m,b){const a=p("ExternalLinkIcon");return e(),o("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),k,s("åšå®¢ï¼š"),n("a",r,[s("https://bugstack.cn"),c(a)])]),d])}const f=t(i,[["render",v],["__file","2019-09-11-nettyanliï¼Œnetty4.1yuanmafenxipianerã€ŠServerBootstrappeizhiyubangdingqidongã€‹.html.vue"]]);export{f as default};
