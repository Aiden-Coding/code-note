import{_ as e,r as o,o as c,c as l,a as n,b as s,d as p,e as t}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"é¢ç»æ‰‹å†Œ-Â·-ç¬¬12ç¯‡ã€Šé¢è¯•å®˜-threadlocal-ä½ è¦è¿™ä¹ˆé—®-æˆ‘å°±æŒ‚äº†-ã€‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#é¢ç»æ‰‹å†Œ-Â·-ç¬¬12ç¯‡ã€Šé¢è¯•å®˜-threadlocal-ä½ è¦è¿™ä¹ˆé—®-æˆ‘å°±æŒ‚äº†-ã€‹","aria-hidden":"true"},"#"),s(" é¢ç»æ‰‹å†Œ Â· ç¬¬12ç¯‡ã€Šé¢è¯•å®˜ï¼ŒThreadLocal ä½ è¦è¿™ä¹ˆé—®ï¼Œæˆ‘å°±æŒ‚äº†ï¼ã€‹")],-1),r=n("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=t(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>è¯´åˆ°åº•ï¼Œä½ çœŸçš„ä¼šé€ ç«ç®­å—ï¼Ÿ</code></p><p>å¸¸è¯´é¢è¯•é€ ç«ç®­ï¼Œå…¥èŒæ‹§èºä¸ã€‚ä½†ä½ çœŸçš„æœ‰é€ ç«ç®­çš„æœ¬äº‹å—ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ä¸æ•¢æ‰¿è®¤è‡ªå·±çš„çŸ¥è¯†ç›²åŒºå’ŒæŠ€æœ¯ç“¶é¢ˆä»¥åŠç»éªŒä¸è¶³çš„è‡ªå˜²ã€‚</p><p><strong>é¢è¯•æ—¶</strong>ï¼š</p><ul><li>æˆ‘å¸Œæœ›ä½ æ‡‚æ•°æ®ç»“æ„ï¼Œå› ä¸ºè¿™æ ·çš„ä½ åœ¨ä½¿ç”¨HashMapã€ArrayListã€LinkedListï¼Œæ›´åŠ å¾—å¿ƒåº”æ‰‹ã€‚</li><li>æˆ‘å¸Œæœ›ä½ æ‡‚æ•£åˆ—ç®—æ³•ï¼Œå› ä¸ºè¿™æ ·çš„ä½ åœ¨è®¾è®¡è·¯ç”±æ—¶ï¼Œä¼šæœ‰å¾ˆå¤šé€‰æ‹©ï¼›<code>é™¤æ³•æ•£åˆ—æ³•</code>ã€<code>å¹³æ–¹æ•£åˆ—æ³•</code>ã€<code>æ–æ³¢é‚£å¥‘ï¼ˆFibonacciï¼‰æ•£åˆ—æ³•</code>ç­‰ã€‚</li><li>æˆ‘å¸Œæœ›ä½ æ‡‚å¼€æºä»£ç ï¼Œå› ä¸ºè¿™æ ·çš„ä½ åœ¨é‡åˆ°é—®é¢˜æ—¶ï¼Œå¯ä»¥å¿«é€Ÿå®šä½ï¼Œè¿˜å¯èƒ½åˆ›é€ å‡ºä¸€äº›ç³»ç»ŸæœåŠ¡çš„ä¸­é—´ä»¶ï¼Œæ¥æ›´å¥½çš„è§£è€¦ç³»ç»Ÿã€‚</li><li>æˆ‘å¸Œæœ›ä½ æ‡‚è®¾è®¡æ¨¡å¼ï¼Œå› ä¸ºè¿™æ ·çš„ä½ å¯ä»¥å†™å‡ºå¯æ‰©å±•ã€æ˜“ç»´æŠ¤çš„ç¨‹åºï¼Œè®©æ•´ä¸ªå›¢é˜Ÿéƒ½èƒ½å‘æ›´å¥½çš„æ–¹å‘å‘å±•ã€‚</li></ul><p><strong>æ‰€ä»¥</strong>ï¼Œä»ä¸æ˜¯CRUDé€‰æ‹©äº†ä½ ï¼Œä¹Ÿä¸æ˜¯é€ èºä¸è®©ä½ æˆä¸ºå·¥å…·äººã€‚è€Œæ˜¯ä½ çš„æŠ€æœ¯èƒ½åŠ›å†³å®šä½ çš„çœ¼ç•Œï¼Œçœ¼ç•Œåˆå†³å®šäº†ä½ å†™å‡ºçš„ä»£ç ï¼</p><h2 id="äºŒã€é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#äºŒã€é¢è¯•é¢˜" aria-hidden="true">#</a> äºŒã€é¢è¯•é¢˜</h2><p><code>è°¢é£æœºï¼Œå°è®°</code> è¿˜æ²¡æœ‰æ‹¿åˆ° offer çš„é£æœºï¼Œæ—©æ—©èµ·äº†åºŠï¼Œåƒå®Œä¸¤æ ¹æ²¹æ¡ï¼Œåˆè·‘åˆ°å…¬å¸æ‰¾é¢è¯•å®˜å–ç»ï¼</p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-13-01.png" alt="çµé­‚ç”»æ‰‹ &amp; è€çºª"></p><p><strong>é¢è¯•å®˜</strong>ï¼šé£æœºï¼Œå¬å¦å…‹è¯´ï¼Œä½ æœ€è¿‘è´ªé»‘èµ·æ—©çš„å­¦ä¹ å‘€ã€‚</p><p><strong>è°¢é£æœº</strong>ï¼šå—¯å—¯ï¼Œæ˜¯çš„ï¼Œæœ€è¿‘å¤´å‘éƒ½å¿«æ‰æ²¡äº†ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šé‚£ä»Šå¤©æˆ‘ä»¬èŠèŠ <code>ThreadLocal</code>ï¼Œä¸€èˆ¬å¯ä»¥ç”¨åœ¨ä»€ä¹ˆåœºæ™¯ä¸­ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šå—¯ï¼Œ<code>ThreadLocal</code> è¦è§£å†³çš„æ˜¯çº¿ç¨‹å†…èµ„æºå…±äº« (<em>This class provides thread-local variables.</em>)ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šç”¨åœ¨å…¨é“¾è·¯ç›‘æ§ä¸­ï¼Œæˆ–è€…æ˜¯åƒæ—¥å¿—æ¡†æ¶ <code>MDC</code> è¿™æ ·çš„ç»„ä»¶é‡Œã€‚</p><p><strong>é¢è¯•å®˜</strong>ï¼šé£æœºä¸é”™å“ˆï¼Œæœ€è¿‘ç¡®å®å­¦ä¹ äº†ã€‚é‚£ä½ çŸ¥é“ <code>ThreadLocal</code>æ˜¯æ€æ ·çš„æ•°æ®ç»“æ„å—ï¼Œé‡‡ç”¨çš„æ˜¯ä»€ä¹ˆæ•£åˆ—æ–¹å¼ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šæ•°ç»„ï¼Ÿå—¯ï¼Œæ€ä¹ˆæ•£åˆ—çš„ä¸æ¸…æ¥š...</p><p><strong>é¢è¯•å®˜</strong>ï¼šé‚£ <code>ThreadLocal</code> æœ‰å†…å­˜æ³„æ¼çš„é£é™©ï¼Œæ˜¯æ€ä¹ˆå‘ç”Ÿçš„å‘¢ï¼Ÿå¦å¤–ä½ äº†è§£åœ¨è¿™ä¸ªè¿‡ç¨‹çš„ï¼Œæ¢æµ‹å¼æ¸…ç†å’Œå¯å‘å¼æ¸…ç†å—ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šè¿™...ï¼Œç›²åŒºäº†ï¼Œç›²åŒºäº†ï¼Œ<code>å¯ä¹</code>æˆ‘æ”¾æ¡Œä¸Šäº†ï¼Œæˆ‘å›å®¶å†çœ‹çœ‹ä¹¦ï¼</p><h2 id="ä¸‰ã€threadlocal-åˆ†æ" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€threadlocal-åˆ†æ" aria-hidden="true">#</a> ä¸‰ã€ThreadLocal åˆ†æ</h2><p><code>ThreadLocal</code>ï¼Œä½œè€…ï¼š<code>Josh Bloch</code> and <code>Doug Lea</code>ï¼Œä¸¤ä½å¤§ç¥ğŸ‘</p><p>å¦‚æœä»…æ˜¯æ—¥å¸¸ä¸šåŠ¡å¼€å‘æ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå†·é—¨çš„ç±»ï¼Œä½¿ç”¨é¢‘ç‡å¹¶ä¸é«˜ã€‚å¹¶ä¸”å®ƒæä¾›çš„æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œä¸€ä¸ªåŠŸèƒ½åªæ˜¯æ½¦æ½¦æ•°è¡Œä»£ç ã€‚<strong>ä½†</strong>ï¼Œå¦‚æœæ·±æŒ–å®ç°éƒ¨åˆ†çš„æºç ï¼Œå°±ä¼šå‘ç°äº‹æƒ…å¹¶ä¸é‚£ä¹ˆç®€å•ã€‚è¿™é‡Œæ¶‰åŠäº†å¤ªå¤šçš„çŸ¥è¯†ç‚¹ï¼ŒåŒ…æ‹¬ï¼›<code>æ•°æ®ç»“æ„</code>ã€<code>æ‹‰é“¾å­˜å‚¨</code>ã€<code>æ–æ³¢é‚£å¥‘æ•£åˆ—</code>ã€<code>ç¥å¥‡çš„0x61c88647</code>ã€<code>å¼±å¼•ç”¨Reference</code>ã€<code>è¿‡æœŸkeyæ¢æµ‹æ¸…ç†å’Œå¯å‘å¼æ¸…ç†</code>ç­‰ç­‰ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±é€æ­¥å­¦ä¹ è¿™äº›<strong>ç›²åŒºçŸ¥è¯†</strong>ã€‚æœ¬æ–‡æ¶‰åŠäº†è¾ƒå¤šçš„ä»£ç å’Œå®è·µéªŒè¯å›¾ç¨¿ï¼Œæ¬¢è¿å…³æ³¨å…¬ä¼—å·ï¼š<code>bugstackè™«æ´æ ˆ</code>ï¼Œå›å¤ä¸‹è½½å¾—åˆ°ä¸€ä¸ªé“¾æ¥æ‰“å¼€åï¼Œæ‰¾åˆ°IDï¼š19ğŸ¤«è·å–ï¼*</p><h3 id="_1-åº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#_1-åº”ç”¨åœºæ™¯" aria-hidden="true">#</a> 1. åº”ç”¨åœºæ™¯</h3><h4 id="_1-1-simpledateformat" tabindex="-1"><a class="header-anchor" href="#_1-1-simpledateformat" aria-hidden="true">#</a> 1.1 SimpleDateFormat</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">SimpleDateFormat</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">seckillSku</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> dateStr <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¸šåŠ¡æµç¨‹</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ å†™è¿‡è¿™æ ·çš„ä»£ç å—ï¼Ÿå¦‚æœè¿˜åœ¨è¿™ä¹ˆå†™ï¼Œé‚£å°±å·²ç»çŠ¯äº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é”™è¯¯ã€‚<code>SimpleDateFormat</code>ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ç±»ã€‚</p><h5 id="_1-1-1-çº¿ç¨‹ä¸å®‰å…¨éªŒè¯" tabindex="-1"><a class="header-anchor" href="#_1-1-1-çº¿ç¨‹ä¸å®‰å…¨éªŒè¯" aria-hidden="true">#</a> 1.1.1 çº¿ç¨‹ä¸å®‰å…¨éªŒè¯</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">SimpleDateFormat</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> dateStr <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Date</span> parseDate <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> dateStrCheck <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>parseDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> equals <span class="token operator">=</span> dateStr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dateStrCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>equals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>equals <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> dateStr <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> dateStrCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>equals<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹ä¸‹ <code>SimpleDateFormat</code> çš„éªŒè¯ä»£ç ã€‚å½“ <code>equals ä¸ºfalse</code> æ—¶ï¼Œè¯æ˜çº¿ç¨‹ä¸å®‰å…¨ã€‚è¿è¡Œç»“æœå¦‚ä¸‹ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token boolean">true</span>
<span class="token boolean">true</span>
<span class="token boolean">false</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">42</span> <span class="token number">2230</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">42</span>
<span class="token boolean">true</span>
<span class="token boolean">true</span>
<span class="token boolean">false</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">42</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">00</span>
<span class="token boolean">false</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">42</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">00</span>
<span class="token boolean">false</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">00</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">42</span>
<span class="token boolean">true</span>
<span class="token boolean">false</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">09</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">42</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">11</span><span class="token operator">:</span><span class="token number">40</span><span class="token operator">:</span><span class="token number">42</span>
<span class="token boolean">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-1-2-ä½¿ç”¨-threadlocal-ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_1-1-2-ä½¿ç”¨-threadlocal-ä¼˜åŒ–" aria-hidden="true">#</a> 1.1.2 ä½¿ç”¨ ThreadLocal ä¼˜åŒ–</h5><p>ä¸ºäº†çº¿ç¨‹å®‰å…¨æœ€ç›´æ¥çš„æ–¹å¼ï¼Œå°±æ˜¯æ¯æ¬¡è°ƒç”¨éƒ½ç›´æ¥ <code>new SimpleDateFormat</code>ã€‚ä½†è¿™æ ·çš„æ–¹å¼ç»ˆç©¶ä¸æ˜¯æœ€å¥½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ <code>ThreadLocal</code> ï¼Œæ¥ä¼˜åŒ–è¿™æ®µä»£ç ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">&gt;</span></span> threadLocal <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> dateStr <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Date</span> parseDate <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> dateStrCheck <span class="token operator">=</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>parseDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> equals <span class="token operator">=</span> dateStr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dateStrCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>equals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>equals <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> dateStr <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> dateStrCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>equals<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚ä¸Šæˆ‘ä»¬æŠŠ <code>SimpleDateFormat</code> ï¼Œæ”¾åˆ° <code>ThreadLocal</code> ä¸­è¿›è¡Œä½¿ç”¨ï¼Œå³ä¸éœ€è¦é‡å¤newå¯¹è±¡ï¼Œä¹Ÿé¿å…äº†çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ã€‚æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token boolean">true</span>
<span class="token boolean">true</span>
<span class="token boolean">true</span>
<span class="token boolean">true</span>
<span class="token boolean">true</span>
<span class="token boolean">true</span>
<span class="token boolean">true</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2-é“¾è·¯è¿½è¸ª" tabindex="-1"><a class="header-anchor" href="#_1-2-é“¾è·¯è¿½è¸ª" aria-hidden="true">#</a> 1.2 é“¾è·¯è¿½è¸ª</h4>`,36),v={href:"https://bigbully.github.io/Dapper-translation/",target:"_blank",rel:"noopener noreferrer"},m=n("code",null,"Dapper",-1),b=n("code",null,"javaagent + å­—èŠ‚ç ",-1),h={href:"https://bugstack.cn/itstack-demo-agent/itstack-demo-agent.html",target:"_blank",rel:"noopener noreferrer"},g=n("strong",null,"é‡ç‚¹",-1),y=n("code",null,"ThreadLocal",-1),w={href:"https://bugstack.cn/itstack-demo-agent/itstack-demo-agent.html",target:"_blank",rel:"noopener noreferrer"},f=n("code",null,"å­—èŠ‚ç æ’æ¡©",-1),_=n("code",null,"ThreadLocal",-1),S=n("code",null,"ThreadLocal",-1),x=t(`<h5 id="_1-2-1-è¿½è¸ªä»£ç " tabindex="-1"><a class="header-anchor" href="#_1-2-1-è¿½è¸ªä»£ç " aria-hidden="true">#</a> 1.2.1 è¿½è¸ªä»£ç </h5><p><strong>è¿™é‡Œä¸¾ä¾‹å…¨é“¾è·¯æ–¹æ³•è°ƒç”¨é“¾è¿½è¸ªï¼Œéƒ¨åˆ†ä»£ç </strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrackContext</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> trackLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        trackLocal<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getLinkId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> trackLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setLinkId</span><span class="token punctuation">(</span><span class="token class-name">String</span> linkId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        trackLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>linkId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Advice.OnMethodEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enter</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Advice.Origin</span><span class="token punctuation">(</span><span class="token string">&quot;#t&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token annotation punctuation">@Advice.Origin</span><span class="token punctuation">(</span><span class="token string">&quot;#m&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> methodName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Span</span> currentSpan <span class="token operator">=</span> <span class="token class-name">TrackManager</span><span class="token punctuation">.</span><span class="token function">getCurrentSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> currentSpan<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> linkId <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TrackContext</span><span class="token punctuation">.</span><span class="token function">setLinkId</span><span class="token punctuation">(</span>linkId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">TrackManager</span><span class="token punctuation">.</span><span class="token function">createEntrySpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Advice.OnMethodExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Advice.Origin</span><span class="token punctuation">(</span><span class="token string">&quot;#t&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token annotation punctuation">@Advice.Origin</span><span class="token punctuation">(</span><span class="token string">&quot;#m&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> methodName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Span</span> exitSpan <span class="token operator">=</span> <span class="token class-name">TrackManager</span><span class="token punctuation">.</span><span class="token function">getExitSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> exitSpan<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;é“¾è·¯è¿½è¸ª(MQ)ï¼š&quot;</span> <span class="token operator">+</span> exitSpan<span class="token punctuation">.</span><span class="token function">getLinkId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">&quot; è€—æ—¶ï¼š&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> exitSpan<span class="token punctuation">.</span><span class="token function">getEnterTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4),E={href:"https://bugstack.cn/itstack-demo-agent/itstack-demo-agent.html",target:"_blank",rel:"noopener noreferrer"},L=n("li",null,[s("è¿™ä¹Ÿåªæ˜¯å…¶ä¸­ä¸€ä¸ªå®ç°æ–¹å¼ï¼Œå­—èŠ‚ç æ’æ¡©ä½¿ç”¨çš„æ˜¯ "),n("code",null,"byte-buddy"),s("ï¼Œå…¶å®è¿˜æ˜¯ä½¿ç”¨ï¼Œ"),n("code",null,"ASM"),s(" æˆ–è€… "),n("code",null,"Javassist"),s("ã€‚")],-1),T=t(`<h5 id="_1-2-2-æµ‹è¯•ç»“æœ" tabindex="-1"><a class="header-anchor" href="#_1-2-2-æµ‹è¯•ç»“æœ" aria-hidden="true">#</a> 1.2.2 æµ‹è¯•ç»“æœ</h5><p><strong>æµ‹è¯•æ–¹æ³•</strong></p><p>é…ç½®å‚æ•°ï¼š<code>-javaagent:E:\\itstack\\GIT\\itstack.org\\itstack-demo-agent\\itstack-demo-agent-06\\target\\itstack-demo-agent-06-1.0.0-SNAPSHOT.jar=testargs</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">http_lt1</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼šhi1 &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">http_lt2</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">http_lt2</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼šhi2 &quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">http_lt3</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è¿è¡Œç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>onTransformationï¼š<span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>ApiTest</span>
æµ‹è¯•ç»“æœï¼šhi2 æ‚Ÿç©º
æµ‹è¯•ç»“æœï¼šhi3 æ‚Ÿç©º
é“¾è·¯è¿½è¸ª<span class="token punctuation">(</span><span class="token constant">MQ</span><span class="token punctuation">)</span>ï¼š<span class="token number">90</span>c7d543<span class="token operator">-</span>c7b8<span class="token operator">-</span><span class="token number">4</span>ec3<span class="token operator">-</span>af4d<span class="token operator">-</span>b4d4f5cff760 <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>ApiTest</span><span class="token punctuation">.</span>http_lt3 è€—æ—¶ï¼š<span class="token number">104</span>ms

init<span class="token operator">:</span> <span class="token number">256</span><span class="token constant">MB</span>	 max<span class="token operator">:</span> <span class="token number">3614</span><span class="token constant">MB</span>	 used<span class="token operator">:</span> <span class="token number">44</span><span class="token constant">MB</span>	 committed<span class="token operator">:</span> <span class="token number">245</span><span class="token constant">MB</span>	 use rate<span class="token operator">:</span> <span class="token number">18</span><span class="token operator">%</span>
init<span class="token operator">:</span> <span class="token number">2</span><span class="token constant">MB</span>	 max<span class="token operator">:</span> <span class="token number">0</span><span class="token constant">MB</span>	 used<span class="token operator">:</span> <span class="token number">13</span><span class="token constant">MB</span>	 committed<span class="token operator">:</span> <span class="token number">14</span><span class="token constant">MB</span>	 use rate<span class="token operator">:</span> <span class="token number">95</span><span class="token operator">%</span>

name<span class="token operator">:</span> <span class="token constant">PS</span> <span class="token class-name">Scavenge</span>	 count<span class="token operator">:</span><span class="token number">0</span>	 took<span class="token operator">:</span><span class="token number">0</span>	 pool name<span class="token operator">:</span><span class="token punctuation">[</span><span class="token constant">PS</span> <span class="token class-name">Eden</span> <span class="token class-name">Space</span><span class="token punctuation">,</span> <span class="token constant">PS</span> <span class="token class-name">Survivor</span> <span class="token class-name">Space</span><span class="token punctuation">]</span>
name<span class="token operator">:</span> <span class="token constant">PS</span> <span class="token class-name">MarkSweep</span>	 count<span class="token operator">:</span><span class="token number">0</span>	 took<span class="token operator">:</span><span class="token number">0</span>	 pool name<span class="token operator">:</span><span class="token punctuation">[</span><span class="token constant">PS</span> <span class="token class-name">Eden</span> <span class="token class-name">Space</span><span class="token punctuation">,</span> <span class="token constant">PS</span> <span class="token class-name">Survivor</span> <span class="token class-name">Space</span><span class="token punctuation">,</span> <span class="token constant">PS</span> <span class="token class-name">Old</span> <span class="token class-name">Gen</span><span class="token punctuation">]</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
é“¾è·¯è¿½è¸ª<span class="token punctuation">(</span><span class="token constant">MQ</span><span class="token punctuation">)</span>ï¼š<span class="token number">90</span>c7d543<span class="token operator">-</span>c7b8<span class="token operator">-</span><span class="token number">4</span>ec3<span class="token operator">-</span>af4d<span class="token operator">-</span>b4d4f5cff760 <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>ApiTest</span><span class="token punctuation">.</span>http_lt2 è€—æ—¶ï¼š<span class="token number">233</span>ms

init<span class="token operator">:</span> <span class="token number">256</span><span class="token constant">MB</span>	 max<span class="token operator">:</span> <span class="token number">3614</span><span class="token constant">MB</span>	 used<span class="token operator">:</span> <span class="token number">44</span><span class="token constant">MB</span>	 committed<span class="token operator">:</span> <span class="token number">245</span><span class="token constant">MB</span>	 use rate<span class="token operator">:</span> <span class="token number">18</span><span class="token operator">%</span>
init<span class="token operator">:</span> <span class="token number">2</span><span class="token constant">MB</span>	 max<span class="token operator">:</span> <span class="token number">0</span><span class="token constant">MB</span>	 used<span class="token operator">:</span> <span class="token number">13</span><span class="token constant">MB</span>	 committed<span class="token operator">:</span> <span class="token number">14</span><span class="token constant">MB</span>	 use rate<span class="token operator">:</span> <span class="token number">96</span><span class="token operator">%</span>

name<span class="token operator">:</span> <span class="token constant">PS</span> <span class="token class-name">Scavenge</span>	 count<span class="token operator">:</span><span class="token number">0</span>	 took<span class="token operator">:</span><span class="token number">0</span>	 pool name<span class="token operator">:</span><span class="token punctuation">[</span><span class="token constant">PS</span> <span class="token class-name">Eden</span> <span class="token class-name">Space</span><span class="token punctuation">,</span> <span class="token constant">PS</span> <span class="token class-name">Survivor</span> <span class="token class-name">Space</span><span class="token punctuation">]</span>
name<span class="token operator">:</span> <span class="token constant">PS</span> <span class="token class-name">MarkSweep</span>	 count<span class="token operator">:</span><span class="token number">0</span>	 took<span class="token operator">:</span><span class="token number">0</span>	 pool name<span class="token operator">:</span><span class="token punctuation">[</span><span class="token constant">PS</span> <span class="token class-name">Eden</span> <span class="token class-name">Space</span><span class="token punctuation">,</span> <span class="token constant">PS</span> <span class="token class-name">Survivor</span> <span class="token class-name">Space</span><span class="token punctuation">,</span> <span class="token constant">PS</span> <span class="token class-name">Old</span> <span class="token class-name">Gen</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä»¥ä¸Šæ˜¯é“¾è·¯è¿½è¸ªçš„æµ‹è¯•ç»“æœï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šæ‰“å‡ºç›¸åº”çš„ç¼–ç IDï¼š<code>90c7d543-c7b8-4ec3-af4d-b4d4f5cff760 </code>ã€‚</li><li>è¿™éƒ¨åˆ†ä¹Ÿå°±æ˜¯å…¨é“¾è·¯è¿½è¸ªçš„æ ¸å¿ƒåº”ç”¨ï¼Œè€Œä¸”è¿˜å¯ä»¥çœ‹åˆ°è¿™é‡Œæ‰“å°äº†ä¸€äº›ç³»ç»Ÿç®€å•çš„JVMç›‘æ§æŒ‡æ ‡ï¼Œè¿™ä¹Ÿæ˜¯ç›‘æ§çš„ä¸€éƒ¨åˆ†ã€‚</li></ul><p><strong>å’³å’³</strong>ï¼Œé™¤æ­¤ä¹‹å¤–æ‰€æœ‰éœ€è¦æ´»åŠ¨æ–¹æ³•è°ƒç”¨é“¾çš„ï¼Œéƒ½éœ€è¦ä½¿ç”¨åˆ° <code>ThreadLocal</code>ï¼Œä¾‹å¦‚ <code>MDC</code> æ—¥å¿—æ¡†æ¶ç­‰ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹è¯¦ç»†åˆ†æ <code>ThreadLocal</code> çš„å®ç°ã€‚</p><h3 id="_2-æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_2-æ•°æ®ç»“æ„" aria-hidden="true">#</a> 2. æ•°æ®ç»“æ„</h3><p>äº†è§£ä¸€ä¸ªåŠŸèƒ½å‰ï¼Œå…ˆäº†è§£å®ƒçš„æ•°æ®ç»“æ„ã€‚è¿™å°±ç›¸å½“äºå…ˆçœ‹çœ‹å®ƒçš„åœ°åŸºï¼Œæœ‰äº†è¿™ä¸ªæ ¹æœ¬ä¹Ÿå°±å¥½å¾€åç†è§£äº†ã€‚ä»¥ä¸‹æ˜¯ <code>ThreadLocal</code> çš„ç®€å•ä½¿ç”¨ä»¥åŠéƒ¨åˆ†æºç ã€‚</p><p><code>new ThreadLocal&lt;String&gt;().set(&quot;å°å‚…å“¥&quot;);</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
 	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                 e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                 e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»è¿™éƒ¨åˆ†æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>ThreadLocal</code> åº•å±‚é‡‡ç”¨çš„æ˜¯æ•°ç»„ç»“æ„å­˜å‚¨æ•°æ®ï¼ŒåŒæ—¶è¿˜æœ‰å“ˆå¸Œå€¼è®¡ç®—ä¸‹æ ‡ï¼Œè¿™è¯´æ˜å®ƒæ˜¯ä¸€ä¸ªæ•£åˆ—è¡¨çš„æ•°ç»„ç»“æ„ï¼Œæ¼”ç¤ºå¦‚ä¸‹å›¾ï¼›</p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-13-02.png" alt="å°å‚…å“¥ &amp; threadLocal æ•°æ®ç»“æ„"></p><p>å¦‚ä¸Šå›¾æ˜¯ <code>ThreadLocal</code> å­˜æ”¾æ•°æ®çš„åº•å±‚æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼›</p><ol><li>å®ƒæ˜¯ä¸€ä¸ªæ•°ç»„ç»“æ„ã€‚</li><li><code>Entry</code>ï¼Œè¿™é‡Œæ²¡ç”¨å†æ‰“å¼€ï¼Œå…¶å®å®ƒæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨å®ç°ï¼Œ<code>static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code>ã€‚è¿™è¯´æ˜åªè¦æ²¡ç”¨å¼ºå¼•ç”¨å­˜åœ¨ï¼Œå‘ç”ŸGCæ—¶å°±ä¼šè¢«åƒåœ¾å›æ”¶ã€‚</li><li>æ•°æ®å…ƒç´ é‡‡ç”¨å“ˆå¸Œæ•£åˆ—æ–¹å¼è¿›è¡Œå­˜å‚¨ï¼Œä¸è¿‡è¿™é‡Œçš„æ•£åˆ—ä½¿ç”¨çš„æ˜¯ <code>æ–æ³¢é‚£å¥‘ï¼ˆFibonacciï¼‰æ•£åˆ—æ³•</code>ï¼Œåé¢ä¼šå…·ä½“åˆ†æã€‚</li><li>å¦å¤–ç”±äºè¿™é‡Œä¸åŒäºHashMapçš„æ•°æ®ç»“æ„ï¼Œå‘ç”Ÿå“ˆå¸Œç¢°æ’ä¸ä¼šå­˜æˆé“¾è¡¨æˆ–çº¢é»‘æ ‘ï¼Œè€Œæ˜¯ä½¿ç”¨å¼€æ”¾å¯»å€è¿›è¡Œå­˜å‚¨ã€‚ä¹Ÿå°±æ˜¯åŒä¸€ä¸ªä¸‹æ ‡ä½ç½®å‘ç”Ÿå†²çªæ—¶ï¼Œåˆ™<code>+1å‘åå¯»å€</code>ï¼Œç›´åˆ°æ‰¾åˆ°ç©ºä½ç½®æˆ–åƒåœ¾å›æ”¶ä½ç½®è¿›è¡Œå­˜å‚¨ã€‚</li></ol><h3 id="_3-æ•£åˆ—ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#_3-æ•£åˆ—ç®—æ³•" aria-hidden="true">#</a> 3. æ•£åˆ—ç®—æ³•</h3>`,17),j=n("code",null,"ThreadLocal",-1),A=n("code",null,"HashMap",-1),M={href:"https://bugstack.cn/interview/2020/08/13/%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C-%E7%AC%AC4%E7%AF%87-HashMap%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5-%E6%9F%A5%E6%89%BE-%E5%88%A0%E9%99%A4-%E9%81%8D%E5%8E%86-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html",target:"_blank",rel:"noopener noreferrer"},C={href:"https://bugstack.cn/interview/2020/08/07/%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C-%E7%AC%AC3%E7%AF%87-HashMap%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86-%E6%89%B0%E5%8A%A8%E5%87%BD%E6%95%B0-%E8%B4%9F%E8%BD%BD%E5%9B%A0%E5%AD%90-%E6%89%A9%E5%AE%B9%E9%93%BE%E8%A1%A8%E6%8B%86%E5%88%86-%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0.html",target:"_blank",rel:"noopener noreferrer"},q=t(`<h4 id="_3-1-ç¥ç§˜çš„æ•°å­—-0x61c88647" tabindex="-1"><a class="header-anchor" href="#_3-1-ç¥ç§˜çš„æ•°å­—-0x61c88647" aria-hidden="true">#</a> 3.1 ç¥ç§˜çš„æ•°å­— 0x61c88647</h4><p>å½“æˆ‘ä»¬æŸ¥çœ‹ <code>ThreadLocal</code> æ‰§è¡Œè®¾ç½®å…ƒç´ æ—¶ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µè®¡ç®—å“ˆå¸Œå€¼çš„ä»£ç ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HASH_INCREMENT</span> <span class="token operator">=</span> <span class="token number">0x61c88647</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nextHashCode<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token constant">HASH_INCREMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>çœ‹åˆ°è¿™é‡Œä½ ä¸€å®šä¼šæœ‰è¿™æ ·çš„ç–‘é—®ï¼Œè¿™æ˜¯ä»€ä¹ˆæ–¹å¼è®¡ç®—å“ˆå¸Œï¼Ÿè¿™ä¸ªæ•°å­—æ€ä¹ˆæ¥çš„ï¼Ÿ</strong></p><p>è®²åˆ°è¿™é‡Œï¼Œå…¶å®è®¡ç®—å“ˆå¸Œçš„æ–¹å¼ï¼Œç»ä¸æ­¢æ˜¯æˆ‘ä»¬å¹³å¸¸çœ‹åˆ° String è·å–å“ˆå¸Œå€¼çš„ä¸€ç§æ–¹å¼ï¼Œè¿˜åŒ…æ‹¬ï¼›<code>é™¤æ³•æ•£åˆ—æ³•</code>ã€<code>å¹³æ–¹æ•£åˆ—æ³•</code>ã€<code>æ–æ³¢é‚£å¥‘ï¼ˆFibonacciï¼‰æ•£åˆ—æ³•</code>ã€<code>éšæœºæ•°æ³•</code>ç­‰ã€‚</p><p>è€Œ <code>ThreadLocal</code> ä½¿ç”¨çš„å°±æ˜¯ <code>æ–æ³¢é‚£å¥‘ï¼ˆFibonacciï¼‰æ•£åˆ—æ³•</code> + æ‹‰é“¾æ³•å­˜å‚¨æ•°æ®åˆ°æ•°ç»„ç»“æ„ä¸­ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œæ˜¯ä¸ºäº†è®©æ•°æ®æ›´åŠ æ•£åˆ—ï¼Œå‡å°‘å“ˆå¸Œç¢°æ’ã€‚å…·ä½“æ¥è‡ªæ•°å­¦å…¬å¼çš„è®¡ç®—æ±‚å€¼ï¼Œ<strong>å…¬å¼</strong>ï¼š<code>f(k) = ((k * 2654435769) &gt;&gt; X) &lt;&lt; Yå¯¹äºå¸¸è§çš„32ä½æ•´æ•°è€Œè¨€ï¼Œä¹Ÿå°±æ˜¯ f(k) = (k * 2654435769) &gt;&gt; 28</code></p><p><strong>ç¬¬äºŒä¸ªé—®é¢˜</strong>ï¼Œæ•°å­— <code>0x61c88647</code>ï¼Œæ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ</p><p>å…¶å®è¿™æ˜¯ä¸€ä¸ªå“ˆå¸Œå€¼çš„é»„é‡‘åˆ†å‰²ç‚¹ï¼Œä¹Ÿå°±æ˜¯ <code>0.618</code>ï¼Œä½ è¿˜è®°å¾—ä½ å­¦è¿‡çš„æ•°å­¦å—ï¼Ÿè®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// é»„é‡‘åˆ†å‰²ç‚¹ï¼š(âˆš5 - 1) / 2 = 0.6180339887     1.618:1 == 1:0.618</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.6180339887</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//-1640531527</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å­¦è¿‡æ•°å­¦éƒ½åº”è¯¥çŸ¥é“ï¼Œé»„é‡‘åˆ†å‰²ç‚¹æ˜¯ï¼Œ<code>(âˆš5 - 1) / 2</code>ï¼Œå–10ä½è¿‘ä¼¼ <code>0.6180339887</code>ã€‚</li><li>ä¹‹åç”¨ 2 ^ 32 * 0.6180339887ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ï¼š<code>-1640531527</code>ï¼Œä¹Ÿå°±æ˜¯ 16 è¿›åˆ¶çš„ï¼Œ0x61c88647ã€‚<em>è¿™ä¸ªæ•°å‘¢ä¹Ÿå°±æ˜¯è¿™ä¹ˆæ¥çš„</em></li></ul><h4 id="_3-2-éªŒè¯æ•£åˆ—" tabindex="-1"><a class="header-anchor" href="#_3-2-éªŒè¯æ•£åˆ—" aria-hidden="true">#</a> 3.2 éªŒè¯æ•£åˆ—</h4><p>æ—¢ç„¶ï¼Œ<code>Josh Bloch</code> å’Œ <code>Doug Lea</code>ï¼Œä¸¤ä½è€çˆ·å­é€‰æ‹©ä½¿ç”¨æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œè®¡ç®—å“ˆå¸Œå€¼ã€‚é‚£ä¸€å®šæœ‰å®ƒçš„è¿‡äººä¹‹å¤„ï¼Œä¹Ÿå°±æ˜¯èƒ½æ›´å¥½çš„æ•£åˆ—ï¼Œå‡å°‘å“ˆå¸Œç¢°æ’ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‰ç…§æºç ä¸­è·å–å“ˆå¸Œå€¼å’Œè®¡ç®—ä¸‹æ ‡çš„æ–¹å¼ï¼ŒæŠŠè¿™éƒ¨åˆ†ä»£ç æå‡ºå‡ºæ¥åšéªŒè¯ã€‚</p><h5 id="_3-2-1-éƒ¨åˆ†æºç " tabindex="-1"><a class="header-anchor" href="#_3-2-1-éƒ¨åˆ†æºç " aria-hidden="true">#</a> 3.2.1 éƒ¨åˆ†æºç </h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicInteger</span> nextHashCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HASH_INCREMENT</span> <span class="token operator">=</span> <span class="token number">0x61c88647</span><span class="token punctuation">;</span>

<span class="token comment">// è®¡ç®—å“ˆå¸Œ</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nextHashCode<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token constant">HASH_INCREMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è·å–ä¸‹æ ‡</span>
<span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚ä¸Šï¼Œæºç éƒ¨åˆ†é‡‡ç”¨çš„æ˜¯ <code>AtomicInteger</code>ï¼ŒåŸå­æ–¹æ³•è®¡ç®—ä¸‹æ ‡ã€‚æˆ‘ä»¬ä¸éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåªéœ€è¦ç®€å•å®ç°å³å¯ã€‚å¦å¤– <code>ThreadLocal</code> åˆå§‹åŒ–æ•°ç»„é•¿åº¦æ˜¯16ï¼Œæˆ‘ä»¬ä¹Ÿåˆå§‹åŒ–è¿™ä¸ªé•¿åº¦ã€‚</p><h5 id="_3-2-2-å•å…ƒæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_3-2-2-å•å…ƒæµ‹è¯•" aria-hidden="true">#</a> 3.2.2 å•å…ƒæµ‹è¯•</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_idx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> hashCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hashCode <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token constant">HASH_INCREMENT</span> <span class="token operator">+</span> <span class="token constant">HASH_INCREMENT</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> idx <span class="token operator">=</span> hashCode <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š&quot;</span> <span class="token operator">+</span> idx <span class="token operator">+</span> <span class="token string">&quot; æ™®é€šæ•£åˆ—ï¼š&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æµ‹è¯•ä»£ç éƒ¨åˆ†ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼ŒåŒæ—¶æˆ‘ä»¬åŠ å…¥æ™®é€šå“ˆå¸Œç®—æ³•è¿›è¡Œæ¯”å¯¹æ•£åˆ—æ•ˆæœã€‚<em>å½“ç„¶String è¿™ä¸ªå“ˆå¸Œå¹¶æ²¡æœ‰åƒ HashMap ä¸­è¿›è¡Œæ‰°åŠ¨</em></p><p><strong>æµ‹è¯•ç»“æœ</strong>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">7</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">0</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">14</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">1</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">5</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">2</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">12</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">3</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">3</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">4</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">10</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">5</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">1</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">6</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">8</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">7</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">15</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">8</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">6</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">9</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">13</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">15</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">4</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">0</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">11</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">1</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">2</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">2</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">9</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">3</span>
æ–æ³¢é‚£å¥‘æ•£åˆ—ï¼š<span class="token number">0</span> æ™®é€šæ•£åˆ—ï¼š<span class="token number">4</span>

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å‘ç°æ²¡ï¼Ÿ</strong>ï¼Œæ–æ³¢é‚£å¥‘æ•£åˆ—çš„éå¸¸å‡åŒ€ï¼Œæ™®é€šæ•£åˆ—åˆ°15ä¸ªä»¥åå·²ç»å¼€å‘ç”Ÿäº§ç¢°æ’ã€‚è¿™ä¹Ÿå°±æ˜¯æ–æ³¢é‚£å¥‘æ•£åˆ—çš„é­…åŠ›ï¼Œå‡å°‘ç¢°æ’ä¹Ÿå°±å¯ä»¥è®©æ•°æ®å­˜å‚¨çš„æ›´åŠ åˆ†æ•£ï¼Œè·å–æ•°æ®çš„æ—¶é—´å¤æ‚åº¦åŸºæœ¬ä¿æŒåœ¨O(1)ã€‚</p><h3 id="_4-æºç è§£è¯»" tabindex="-1"><a class="header-anchor" href="#_4-æºç è§£è¯»" aria-hidden="true">#</a> 4. æºç è§£è¯»</h3><h4 id="_4-1-åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#_4-1-åˆå§‹åŒ–" aria-hidden="true">#</a> 4.1 åˆå§‹åŒ–</h4><p><code>new ThreadLocal&lt;&gt;()</code></p><p>åˆå§‹åŒ–çš„è¿‡ç¨‹ä¹Ÿå¾ˆç®€å•ï¼Œå¯ä»¥æŒ‰ç…§è‡ªå·±éœ€è¦çš„æ³›å‹è¿›è¡Œè®¾ç½®ã€‚ä½†åœ¨ <code>ThreadLocal</code> çš„æºç ä¸­æœ‰ä¸€ç‚¹éå¸¸é‡è¦ï¼Œå°±æ˜¯è·å– <code>threadLocal</code> çš„å“ˆå¸Œå€¼çš„è·å–ï¼Œ<code>threadLocalHashCode</code>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadLocalHashCode <span class="token operator">=</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Returns the next hash code.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nextHashCode<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token constant">HASH_INCREMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æºç ä¸­ï¼Œåªè¦å®ä¾‹åŒ–ä¸€ä¸ª <code>ThreadLocal</code> ï¼Œå°±ä¼šè·å–ä¸€ä¸ªç›¸åº”çš„å“ˆå¸Œå€¼ï¼Œåˆ™ä¾‹æˆ‘ä»¬åšä¸€ä¸ªä¾‹å­ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_threadLocalHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> objectThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span> threadLocalHashCode <span class="token operator">=</span> objectThreadLocal<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;threadLocalHashCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadLocalHashCode<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;objectThreadLocalï¼š&quot;</span> <span class="token operator">+</span> threadLocalHashCode<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>objectThreadLocal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› ä¸º <code>threadLocalHashCode</code> ï¼Œæ˜¯ä¸€ä¸ªç§æœ‰å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬å®ä¾‹åŒ–åé€šè¿‡ä¸Šé¢çš„æ–¹å¼è¿›è¡Œè·å–å“ˆå¸Œå€¼ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>objectThreadLocalï¼š<span class="token operator">-</span><span class="token number">1401181199</span>
objectThreadLocalï¼š<span class="token number">239350328</span>
objectThreadLocalï¼š<span class="token number">1879881855</span>
objectThreadLocalï¼š<span class="token operator">-</span><span class="token number">774553914</span>
objectThreadLocalï¼š<span class="token number">865977613</span>

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå€¼çš„è·å–ï¼Œä¹Ÿå°±æ˜¯è®¡ç®— <code>ThreadLocalMap</code>ï¼Œå­˜å‚¨æ•°æ®æ—¶ï¼Œ<code>ThreadLocal</code> çš„æ•°ç»„ä¸‹æ ‡ã€‚åªè¦æ˜¯è¿™åŒä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨<code>set</code>ã€<code>get</code>æ—¶ï¼Œå°±å¯ä»¥è®¾ç½®å’Œè·å–å¯¹åº”çš„å€¼ã€‚</p><h4 id="_4-2-è®¾ç½®å…ƒç´ " tabindex="-1"><a class="header-anchor" href="#_4-2-è®¾ç½®å…ƒç´ " aria-hidden="true">#</a> 4.2 è®¾ç½®å…ƒç´ </h4><h5 id="_4-2-1-æµç¨‹å›¾è§£" tabindex="-1"><a class="header-anchor" href="#_4-2-1-æµç¨‹å›¾è§£" aria-hidden="true">#</a> 4.2.1 æµç¨‹å›¾è§£</h5><p><code>new ThreadLocal&lt;&gt;().set(&quot;å°å‚…å“¥&quot;);</code></p><p>è®¾ç½®å…ƒç´ çš„æ–¹æ³•ï¼Œä¹Ÿå°±è¿™ä¹ˆä¸€å¥ä»£ç ã€‚ä½†è®¾ç½®å…ƒç´ çš„æµç¨‹å´æ¶‰åŠçš„æ¯”è¾ƒå¤šï¼Œåœ¨è¯¦ç»†åˆ†æä»£ç å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€å¼ è®¾ç½®å…ƒç´ çš„æµç¨‹å›¾ï¼Œä»å›¾ä¸­å…ˆäº†è§£ä¸åŒæƒ…å†µçš„æµç¨‹ä¹‹åå†å¯¹æ¯”ç€å­¦ä¹ æºç ã€‚æµç¨‹å›¾å¦‚ä¸‹ï¼›</p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-13-03.png" alt="å°å‚…å“¥ &amp; è®¾ç½®å…ƒç´ æµç¨‹å›¾"></p><p>ä¹ä¸€çœ‹å¯èƒ½æ„Ÿè§‰æœ‰ç‚¹æ™•ï¼Œæˆ‘ä»¬ä»å·¦å¾€å³çœ‹ï¼Œåˆ†åˆ«æœ‰å¦‚ä¸‹çŸ¥è¯†ç‚¹ï¼› 0. ä¸­é—´æ˜¯ <code>ThreadLocal</code> çš„æ•°ç»„ç»“æ„ï¼Œä¹‹ååœ¨è®¾ç½®å…ƒç´ æ—¶åˆ†ä¸ºå››ç§ä¸åŒçš„æƒ…å†µï¼Œå¦å¤–å…ƒç´ çš„æ’å…¥æ˜¯é€šè¿‡æ–æ³¢é‚£å¥‘æ•£åˆ—è®¡ç®—ä¸‹æ ‡å€¼ï¼Œè¿›è¡Œå­˜æ”¾çš„ã€‚</p><ol><li>æƒ…å†µ1ï¼Œå¾…æ’å…¥çš„ä¸‹æ ‡ï¼Œæ˜¯ç©ºä½ç½®ç›´æ¥æ’å…¥ã€‚</li><li>æƒ…å†µ2ï¼Œå¾…æ’å…¥çš„ä¸‹æ ‡ï¼Œä¸ä¸ºç©ºï¼Œkey ç›¸åŒï¼Œç›´æ¥æ›´æ–°</li><li>æƒ…å†µ3ï¼Œå¾…æ’å…¥çš„ä¸‹æ ‡ï¼Œä¸ä¸ºç©ºï¼Œkey ä¸ç›¸åŒï¼Œå¼€æ”¾å¯»å€</li><li>æƒ…å†µ4ï¼Œä¸ä¸ºç©ºï¼Œkey ä¸ç›¸åŒï¼Œç¢°åˆ°è¿‡æœŸkeyã€‚å…¶å®æƒ…å†µ4ï¼Œé‡åˆ°çš„æ˜¯å¼±å¼•ç”¨å‘ç”ŸGCæ—¶ï¼Œäº§ç”Ÿçš„æƒ…å†µã€‚ç¢°åˆ°è¿™ç§æƒ…å†µï¼Œ<code>ThreadLocal</code> ä¼šè¿›è¡Œæ¢æµ‹æ¸…ç†è¿‡æœŸkeyï¼Œè¿™éƒ¨åˆ†æ¸…ç†å†…å®¹åç»­è®²è§£ã€‚</li></ol><h5 id="_4-2-2-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_4-2-2-æºç åˆ†æ" aria-hidden="true">#</a> 4.2.2 æºç åˆ†æ</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
         e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">replaceStaleEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token operator">++</span>size<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sz <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span>
        <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æœ‰äº†ä¸Šé¢çš„å›¾è§£æµç¨‹ï¼Œå†çœ‹ä»£ç éƒ¨åˆ†å°±æ¯”è¾ƒå®¹æ˜“ç†è§£äº†ï¼Œä¸ä¹‹å¯¹åº”çš„å†…å®¹åŒ…æ‹¬ï¼Œå¦‚ä¸‹ï¼›</p><ol><li><code>key.threadLocalHashCode &amp; (len-1);</code>ï¼Œæ–æ³¢é‚£å¥‘æ•£åˆ—ï¼Œè®¡ç®—æ•°ç»„ä¸‹æ ‡ã€‚</li><li><code>Entry</code>ï¼Œæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨å¯¹è±¡çš„å®ç°ç±»ï¼Œ<code>static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code>ï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨ä¸‹ï¼Œä¼šå‘ç”ŸGCï¼Œåˆ é™¤keyã€‚</li><li>forå¾ªç¯åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå½“å‰ä¸‹æ ‡ä¸å­˜åœ¨å…ƒç´ æ—¶ï¼Œç›´æ¥è®¾ç½®å…ƒç´  <code>tab[i] = new Entry(key, value);</code>ã€‚</li><li>å¦‚æœå…ƒç´ å­˜åœ¨ï¼Œåˆ™ä¼šåˆ¤æ–­æ˜¯å¦keyå€¼ç›¸ç­‰ <code>if (k == key)</code>ï¼Œç›¸ç­‰åˆ™æ›´æ–°å€¼ã€‚</li><li>å¦‚æœä¸ç›¸ç­‰ï¼Œå°±åˆ°äº†æˆ‘ä»¬çš„ <code>replaceStaleEntry</code>ï¼Œä¹Ÿå°±æ˜¯ä¸Šå›¾è¯´åˆ°çš„æ¢æµ‹å¼æ¸…ç†è¿‡æœŸå…ƒç´ ã€‚</li></ol><p><strong>ç»¼ä¸Š</strong>ï¼Œå°±æ˜¯å…ƒç´ å­˜æ”¾çš„å…¨éƒ¨è¿‡ç¨‹ï¼Œæ•´ä½“ç»“æ„çš„è®¾è®¡æ–¹å¼éå¸¸èµğŸ‘ï¼Œæå¤§çš„åˆ©ç”¨äº†æ•£åˆ—æ•ˆæœï¼Œä¹ŸæŠŠå¼±å¼•ç”¨ä½¿ç”¨çš„éå¸¸6ï¼</p><h4 id="_4-3-æ‰©å®¹æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#_4-3-æ‰©å®¹æœºåˆ¶" aria-hidden="true">#</a> 4.3 æ‰©å®¹æœºåˆ¶</h4><h5 id="_4-3-1-æ‰©å®¹æ¡ä»¶" tabindex="-1"><a class="header-anchor" href="#_4-3-1-æ‰©å®¹æ¡ä»¶" aria-hidden="true">#</a> 4.3.1 æ‰©å®¹æ¡ä»¶</h5><p><code>åªè¦ä½¿ç”¨åˆ°æ•°ç»„ç»“æ„ï¼Œå°±ä¸€å®šä¼šæœ‰æ‰©å®¹</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sz <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span>
    <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æˆ‘ä»¬é˜…è¯»è®¾ç½®å…ƒç´ æ—¶ï¼Œæœ‰ä»¥ä¸Šè¿™ä¹ˆä¸€å—ä»£ç ï¼Œåˆ¤æ–­æ˜¯å¦æ‰©å®¹ã€‚</p><ul><li>é¦–å…ˆï¼Œè¿›è¡Œ<code>å¯å‘å¼æ¸…ç†*cleanSomeSlots*</code>ï¼ŒæŠŠè¿‡æœŸå…ƒç´ æ¸…ç†æ‰ï¼Œçœ‹ç©ºé—´æ˜¯å¦</li><li>ä¹‹åï¼Œåˆ¤æ–­<code>sz &gt;= threshold</code>ï¼Œå…¶ä¸­ <code>threshold = len * 2 / 3</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°ç»„ä¸­å¤©å¡«å……çš„å…ƒç´ ï¼Œå¤§äº <code>len * 2 / 3</code>ï¼Œå°±éœ€è¦æ‰©å®¹äº†ã€‚</li><li>æœ€åï¼Œå°±æ˜¯æˆ‘ä»¬è¦åˆ†æçš„é‡ç‚¹ï¼Œ<code>rehash();</code>ï¼Œæ‰©å®¹é‡æ–°è®¡ç®—å…ƒç´ ä½ç½®ã€‚</li></ul><h5 id="_4-3-2-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_4-3-2-æºç åˆ†æ" aria-hidden="true">#</a> 4.3.2 æºç åˆ†æ</h5><p><strong>æ¢æµ‹å¼æ¸…ç†å’Œæ ¡éªŒ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">expungeStaleEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Use lower threshold for doubling to avoid hysteresis</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;=</span> threshold <span class="token operator">-</span> threshold <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">expungeStaleEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™éƒ¨åˆ†æ˜¯ä¸»è¦æ˜¯æ¢æµ‹å¼æ¸…ç†è¿‡æœŸå…ƒç´ ï¼Œä»¥åŠåˆ¤æ–­æ¸…ç†åæ˜¯å¦æ»¡è¶³æ‰©å®¹æ¡ä»¶ï¼Œsize &gt;= threshold * 3/4</li><li>æ»¡è¶³åæ‰§è¡Œæ‰©å®¹æ“ä½œï¼Œå…¶å®æ‰©å®¹å®Œçš„æ ¸å¿ƒæ“ä½œå°±æ˜¯é‡æ–°è®¡ç®—å“ˆå¸Œå€¼ï¼ŒæŠŠå…ƒç´ å¡«å……åˆ°æ–°çš„æ•°ç»„ä¸­ã€‚</li></ul><p><strong>resize() æ‰©å®¹</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldLen <span class="token operator">=</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> newLen <span class="token operator">=</span> oldLen <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>newLen<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span> e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Help the GC</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> h <span class="token operator">=</span> k<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>newTab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    h <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> newLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                newTab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">setThreshold</span><span class="token punctuation">(</span>newLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size <span class="token operator">=</span> count<span class="token punctuation">;</span>
    table <span class="token operator">=</span> newTab<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä»¥ä¸Š</strong>ï¼Œä»£ç å°±æ˜¯æ‰©å®¹çš„æ•´ä½“æ“ä½œï¼Œå…·ä½“åŒ…æ‹¬å¦‚ä¸‹æ­¥éª¤ï¼›</p><ol><li>é¦–å…ˆæŠŠæ•°ç»„é•¿åº¦æ‰©å®¹åˆ°åŸæ¥çš„2å€ï¼Œ<code>oldLen * 2</code>ï¼Œå®ä¾‹åŒ–æ–°æ•°ç»„ã€‚</li><li>éå†forï¼Œæ‰€æœ‰çš„æ—§æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œé‡æ–°æ”¾åˆ°æ–°æ•°ç»„ä¸­ã€‚</li><li>åœ¨æ”¾ç½®æ•°ç»„çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç”Ÿå“ˆå¸Œç¢°æ’ï¼Œåˆ™é“¾å¼æ³•é¡ºå»¶ã€‚</li><li>åŒæ—¶è¿™è¿˜æœ‰æ£€æµ‹keyå€¼çš„æ“ä½œ <code>if (k == null)</code>ï¼Œæ–¹ä¾¿GCã€‚</li></ol><h4 id="_4-4-è·å–å…ƒç´ " tabindex="-1"><a class="header-anchor" href="#_4-4-è·å–å…ƒç´ " aria-hidden="true">#</a> 4.4 è·å–å…ƒç´ </h4><h5 id="_4-4-1-æµç¨‹å›¾è§£" tabindex="-1"><a class="header-anchor" href="#_4-4-1-æµç¨‹å›¾è§£" aria-hidden="true">#</a> 4.4.1 æµç¨‹å›¾è§£</h5><p><code>new ThreadLocal&lt;&gt;().get();</code></p><p>åŒæ ·è·å–å…ƒç´ ä¹Ÿå°±è¿™ä¹ˆä¸€å¥ä»£ç ï¼Œå¦‚æœæ²¡æœ‰åˆ†ææºç ä¹‹å‰ï¼Œä½ èƒ½è€ƒè™‘åˆ°å®ƒåœ¨ä¸åŒçš„æ•°æ®ç»“æ„ä¸‹ï¼Œè·å–å…ƒç´ æ—¶å€™éƒ½åšäº†ä»€ä¹ˆæ“ä½œå—ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å›¾ï¼Œåˆ†ä¸ºå¦‚ä¸‹ç§æƒ…å†µï¼›</p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-13-05.png" alt="å°å‚…å“¥ &amp; è·å–å…ƒç´ å›¾è§£"></p><p>æŒ‰ç…§ä¸åŒçš„æ•°æ®å…ƒç´ å­˜å‚¨æƒ…å†µï¼ŒåŸºæœ¬åŒ…æ‹¬å¦‚ä¸‹æƒ…å†µï¼›</p><ol><li>ç›´æ¥å®šä½åˆ°ï¼Œæ²¡æœ‰å“ˆå¸Œå†²çªï¼Œç›´æ¥è¿”å›å…ƒç´ å³å¯ã€‚</li><li>æ²¡æœ‰ç›´æ¥å®šä½åˆ°äº†ï¼Œkeyä¸åŒï¼Œéœ€è¦æ‹‰é“¾å¼å¯»æ‰¾ã€‚</li><li>æ²¡æœ‰ç›´æ¥å®šä½åˆ°äº†ï¼Œkeyä¸åŒï¼Œæ‹‰é“¾å¼å¯»æ‰¾ï¼Œé‡åˆ°GCæ¸…ç†å…ƒç´ ï¼Œéœ€è¦æ¢æµ‹å¼æ¸…ç†ï¼Œå†å¯»æ‰¾å…ƒç´ ã€‚</li></ol><h5 id="_4-4-2-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_4-4-2-æºç åˆ†æ" aria-hidden="true">#</a> 4.4.2 æºç åˆ†æ</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Entry</span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> e<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token function">getEntryAfterMiss</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">getEntryAfterMiss</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">Entry</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span>
            <span class="token keyword">return</span> e<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¥½äº†</strong>ï¼Œè¿™éƒ¨åˆ†å°±æ˜¯è·å–å…ƒç´ çš„æºç éƒ¨åˆ†ï¼Œå’Œæˆ‘ä»¬å›¾ä¸­åˆ—ä¸¾çš„æƒ…å†µæ˜¯ä¸€è‡´çš„ã€‚<code>expungeStaleEntry</code>ï¼Œæ˜¯å‘ç°æœ‰ <code>key == null</code> æ—¶ï¼Œè¿›è¡Œæ¸…ç†è¿‡æœŸå…ƒç´ ï¼Œå¹¶æŠŠåç»­ä½ç½®çš„å…ƒç´ ï¼Œå‰ç§»ã€‚</p><h4 id="_4-5-å…ƒç´ æ¸…ç†" tabindex="-1"><a class="header-anchor" href="#_4-5-å…ƒç´ æ¸…ç†" aria-hidden="true">#</a> 4.5 å…ƒç´ æ¸…ç†</h4><h5 id="_4-5-1-æ¢æµ‹å¼æ¸…ç†-expungestaleentry" tabindex="-1"><a class="header-anchor" href="#_4-5-1-æ¢æµ‹å¼æ¸…ç†-expungestaleentry" aria-hidden="true">#</a> 4.5.1 æ¢æµ‹å¼æ¸…ç†[expungeStaleEntry]</h5><p>æ¢æµ‹å¼æ¸…ç†ï¼Œæ˜¯ä»¥å½“å‰é‡åˆ°çš„ GC å…ƒç´ å¼€å§‹ï¼Œå‘åä¸æ–­çš„æ¸…ç†ã€‚ç›´åˆ°é‡åˆ° null ä¸ºæ­¢ï¼Œæ‰åœæ­¢ rehash è®¡ç®—<code>Rehash until we encounter null</code>ã€‚</p><p><strong>expungeStaleEntry</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span><span class="token keyword">int</span> staleSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// expunge entry at staleSlot</span>
    tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    size<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token comment">// Rehash until we encounter null</span>
    <span class="token class-name">Entry</span> e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>staleSlot<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            size<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> h <span class="token operator">=</span> k<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// Unlike Knuth 6.4 Algorithm R, we must scan until</span>
                <span class="token comment">// null because multiple entries could have been stale.</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>tab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    h <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                tab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä»¥ä¸Š</strong>ï¼Œæ¢æµ‹å¼æ¸…ç†åœ¨è·å–å…ƒç´ ä¸­ä½¿ç”¨åˆ°ï¼› <code>new ThreadLocal&lt;&gt;().get() -&gt; map.getEntry(this) -&gt; getEntryAfterMiss(key, i, e) -&gt; expungeStaleEntry(i)</code></p><h5 id="_4-5-2-å¯å‘å¼æ¸…ç†-cleansomeslots" tabindex="-1"><a class="header-anchor" href="#_4-5-2-å¯å‘å¼æ¸…ç†-cleansomeslots" aria-hidden="true">#</a> 4.5.2 å¯å‘å¼æ¸…ç†[cleanSomeSlots]</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Heuristically</span> scan some cells looking <span class="token keyword">for</span> stale <span class="token class-name"><span class="token namespace">entries<span class="token punctuation">.</span></span>
This</span> is invoked when either a <span class="token keyword">new</span> element is added<span class="token punctuation">,</span> or
another stale one has been <span class="token class-name"><span class="token namespace">expunged<span class="token punctuation">.</span></span> It</span> performs a
logarithmic number of scans<span class="token punctuation">,</span> as a balance between no
scanning <span class="token punctuation">(</span>fast but retains garbage<span class="token punctuation">)</span> and a number of scans
proportional <span class="token keyword">to</span> <span class="token namespace">number</span> of elements<span class="token punctuation">,</span> that would find all
garbage but would cause some insertions <span class="token keyword">to</span> <span class="token namespace">take</span> <span class="token class-name">O</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> time<span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¯å‘å¼æ¸…ç†</strong>ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µæ³¨é‡Šï¼Œå¤§æ¦‚æ„æ€æ˜¯ï¼›è¯•æ¢çš„æ‰«æä¸€äº›å•å…ƒæ ¼ï¼Œå¯»æ‰¾è¿‡æœŸå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯è¢«åƒåœ¾å›æ”¶çš„å…ƒç´ ã€‚<em>å½“æ·»åŠ æ–°å…ƒç´ æˆ–åˆ é™¤å¦ä¸€ä¸ªè¿‡æ—¶å…ƒç´ æ—¶ï¼Œå°†è°ƒç”¨æ­¤å‡½æ•°ã€‚å®ƒæ‰§è¡Œå¯¹æ•°æ‰«ææ¬¡æ•°ï¼Œä½œä¸ºä¸æ‰«æï¼ˆå¿«é€Ÿä½†ä¿ç•™åƒåœ¾ï¼‰å’Œä¸å…ƒç´ æ•°é‡æˆæ¯”ä¾‹çš„æ‰«ææ¬¡æ•°ä¹‹é—´çš„å¹³è¡¡ï¼Œè¿™å°†æ‰¾åˆ°æ‰€æœ‰åƒåœ¾ï¼Œä½†ä¼šå¯¼è‡´ä¸€äº›æ’å…¥èŠ±è´¹Oï¼ˆnï¼‰æ—¶é—´ã€‚</em></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> removed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            n <span class="token operator">=</span> len<span class="token punctuation">;</span>
            removed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            i <span class="token operator">=</span> <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> removed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>while å¾ªç¯ä¸­ä¸æ–­çš„å³ç§»è¿›è¡Œå¯»æ‰¾éœ€è¦è¢«æ¸…ç†çš„è¿‡æœŸå…ƒç´ ï¼Œæœ€ç»ˆéƒ½ä¼šä½¿ç”¨ <code>expungeStaleEntry</code> è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œè¿˜åŒ…æ‹¬å…ƒç´ çš„ç§»ä½ã€‚</p><h2 id="å››ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å››ã€æ€»ç»“" aria-hidden="true">#</a> å››ã€æ€»ç»“</h2><ul><li>å†™åˆ°è¿™ç®—æ˜¯æŠŠ <code>ThreadLocal</code> çŸ¥è¯†ç‚¹çš„ä¸€è§’åˆ†æå®Œäº†ï¼Œåœ¨ <code>ThreadLocal</code> çš„å®¶æ—é‡Œè¿˜æœ‰ <code>Netty</code> ä¸­ç”¨åˆ°çš„ï¼Œ<code>FastThreadLocal</code>ã€‚åœ¨å…¨é“¾è·¯è·¨æœåŠ¡çº¿ç¨‹é—´è·å–è°ƒç”¨é“¾è·¯ï¼Œè¿˜æœ‰ <code>TransmittableThreadLocal</code>ï¼Œå¦å¤–è¿˜æœ‰ JDK æœ¬èº«è‡ªå¸¦çš„ä¸€ç§çº¿ç¨‹ä¼ é€’è§£å†³æ–¹æ¡ˆ <code>InheritableThreadLocal</code>ã€‚ä½†ç«™åœ¨æœ¬æ–‡çš„åŸºç¡€ä¸Šï¼Œäº†è§£äº†æœ€åŸºç¡€çš„åŸç†ï¼Œåœ¨ç†è§£å…¶ä»–çš„æ‹“å±•è®¾è®¡ï¼Œå°±æ›´å®¹æ˜“æ¥å—äº†ã€‚</li><li>æ­¤å¤–åœ¨æˆ‘ä»¬æ–‡ä¸­åˆ†ææ—¶ç»å¸¸ä¼šçœ‹åˆ°æ¢æµ‹å¼æ¸…ç†ï¼Œå…¶å®è¿™ä¹Ÿæ˜¯éå¸¸è€—æ—¶ã€‚ä¸ºæ­¤æˆ‘ä»¬åœ¨ä½¿ç”¨ ThreadLocal ä¸€å®šè¦è®°å¾— <code>new ThreadLocal&lt;&gt;().remove();</code> æ“ä½œã€‚é¿å…å¼±å¼•ç”¨å‘ç”ŸGCåï¼Œå¯¼è‡´å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚</li><li><strong>æœ€å</strong>ï¼Œä½ å‘ç°äº†å—ï¼æˆ‘ä»¬å­¦ä¹ è¿™æ ·çš„åº•å±‚åŸç†æ€§çŸ¥è¯†ï¼Œéƒ½ç¦»ä¸å¼€æ•°æ®ç»“æ„å’Œè‰¯å¥½çš„è®¾è®¡æ–¹æ¡ˆï¼Œæˆ–è€…è¯´æ˜¯ç®—æ³•çš„èº«å½±ã€‚è¿™äº›ä»£ç æ‰æ˜¯æ”¯æ’‘æ•´ä¸ªç³»ç»Ÿè‰¯å¥½è¿è¡Œçš„åœ°åŸºï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›æ€è·¯æŠ½å–åˆ°æˆ‘ä»¬å¼€å‘çš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹ä¸­ï¼Œä¹Ÿæ˜¯å¯ä»¥å¤§å¤§æå‡æ€§èƒ½çš„ã€‚</li></ul>`,81);function H(B,D){const a=o("ExternalLinkIcon");return c(),l("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),r,s("åšå®¢ï¼š"),n("a",k,[s("https://bugstack.cn"),p(a)])]),d,n("p",null,[s("è¿‘å‡ å¹´åŸºäº"),n("a",v,[s("è°·æ­Œ"),m,p(a)]),s("è®ºæ–‡å®ç°éå…¥ä¾µå…¨é“¾è·¯è¿½è¸ªï¼Œä½¿ç”¨çš„è¶Šæ¥è¶Šå¹¿äº†ã€‚ç®€å•è¯´è¿™å°±æ˜¯ä¸€å¥—ç›‘æ§ç³»ç»Ÿï¼Œä½†ä¸éœ€è¦ä½ ç¡¬ç¼–ç çš„æ–¹å¼è¿›è¡Œç›‘æ§æ–¹æ³•ï¼Œè€Œæ˜¯åŸºäºå®ƒçš„è®¾è®¡æ–¹æ¡ˆé‡‡ç”¨ "),b,s(" æ’æ¡©çš„æ–¹å¼ï¼ŒåŠ¨æ€é‡‡é›†æ–¹æ³•æ‰§è¡Œä¿¡æ¯ã€‚"),n("em",null,[s("å¦‚æœä½ æƒ³äº†è§£å­—èŠ‚ç æ’æ¡©æŠ€æœ¯ï¼Œå¯ä»¥é˜…è¯»æˆ‘çš„å­—èŠ‚ç ç¼–ç¨‹ä¸“æ ï¼š"),n("a",h,[s("https://bugstack.cn/itstack-demo-agent/itstack-demo-agent.html"),p(a)])])]),n("p",null,[g,s("ï¼ŒåŠ¨æ€é‡‡é›†æ–¹æ³•æ‰§è¡Œä¿¡æ¯ã€‚è¿™å—æ˜¯ä¸»è¦éƒ¨åˆ†ï¼Œè·Ÿ "),y,s(" ç›¸å…³ã€‚"),n("a",w,[f,p(a)]),s("è§£å†³çš„æ˜¯éå…¥ä¾µå¼ç¼–ç¨‹ï¼Œé‚£ä¹ˆåœ¨ä¸€æ¬¡æœåŠ¡è°ƒç”¨æ—¶ï¼Œåœ¨å„ä¸ªç³»ç»Ÿé—´ä»¥åŠç³»ç»Ÿå†…å¤šä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œéƒ½éœ€è¦è¿›è¡Œé‡‡é›†ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨ "),_,s(" è®°å½•æ–¹æ³•æ‰§è¡ŒIDï¼Œå½“ç„¶è¿™é‡Œè¿˜æœ‰è·¨çº¿ç¨‹è°ƒç”¨ä½¿ç”¨çš„ä¹Ÿæ˜¯å¢å¼ºç‰ˆæœ¬çš„ "),S,s("ï¼Œä½†æ— è®ºå¦‚ä½•åŸºæœ¬åŸç†ä¸å˜ã€‚")]),x,n("ul",null,[n("li",null,[s("ä»¥ä¸Šè¿™éƒ¨åˆ†å°±æ˜¯éå…¥ä¾µç›‘æ§ä¸­ï¼Œé“¾è·¯è¿½è¸ªçš„è¿‡ç¨‹ã€‚å…·ä½“çš„æ¡ˆä¾‹å’Œä»£ç å¯ä»¥å‚è€ƒé˜…è¯»ï¼Œç³»åˆ—ä¸“é¢˜æ–‡ç« "),n("a",E,[s("ã€ŠåŸºäºJavaAgentçš„å…¨é“¾è·¯ç›‘æ§ã€‹"),p(a)])]),L]),T,n("p",null,[s("æ—¢ç„¶ "),j,s(" æ˜¯åŸºäºæ•°ç»„ç»“æ„çš„å¼€æ”¾å¯»å€æ–¹å¼å­˜å‚¨ï¼Œé‚£å°±ä¸€å®šä¼šæœ‰å“ˆå¸Œçš„è®¡ç®—ã€‚ä½†æˆ‘ä»¬ç¿»é˜…æºç åï¼Œå‘ç°è¿™ä¸ªå“ˆå¸Œè®¡ç®—ä¸ "),A,s(" ä¸­çš„æ•£åˆ—æ±‚æ•°ç»„ä¸‹æ ‡è®¡ç®—çš„å“ˆå¸Œæ–¹å¼ä¸ä¸€æ ·ã€‚å¦‚æœä½ å¿˜è®°äº†HashMapï¼Œå¯ä»¥ç¿»é˜…æ–‡ç« "),n("a",M,[s("ã€ŠHashMap æºç åˆ†æï¼Œæ’å…¥ã€æŸ¥æ‰¾ã€‹"),p(a)]),s("ã€"),n("a",C,[s("ã€ŠHashMap æ‰°åŠ¨å‡½æ•°ã€è´Ÿè½½å› å­ã€‹"),p(a)])]),q])}const F=e(i,[["render",H],["__file","2020-09-23-mianjingshouce Â· di12pianã€Šmianshiguanï¼ŒThreadLocal niyaozhemewenï¼Œwojiugualiaoï¼ã€‹.html.vue"]]);export{F as default};
