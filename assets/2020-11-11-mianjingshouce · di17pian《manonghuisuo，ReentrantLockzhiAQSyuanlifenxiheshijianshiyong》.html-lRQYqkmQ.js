import{_ as e,r as t,o as p,c as o,a as n,b as s,d as c,e as l}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"é¢ç»æ‰‹å†Œ-Â·-ç¬¬17ç¯‡ã€Šç å†œä¼šé”-reentrantlockä¹‹aqsåŸç†åˆ†æå’Œå®è·µä½¿ç”¨ã€‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#é¢ç»æ‰‹å†Œ-Â·-ç¬¬17ç¯‡ã€Šç å†œä¼šé”-reentrantlockä¹‹aqsåŸç†åˆ†æå’Œå®è·µä½¿ç”¨ã€‹","aria-hidden":"true"},"#"),s(" é¢ç»æ‰‹å†Œ Â· ç¬¬17ç¯‡ã€Šç å†œä¼šé”ï¼ŒReentrantLockä¹‹AQSåŸç†åˆ†æå’Œå®è·µä½¿ç”¨ã€‹")],-1),r=n("br",null,null,-1),d={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},k=l(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>å¦‚æœä½ ç›¸ä¿¡ä½ åšä»€ä¹ˆéƒ½èƒ½æˆï¼Œä½ ä¼šè‡ªä¿¡çš„å¤šï¼</code></p><p>åƒä¸‡ä¸è¦æ€»è‡ªæˆ‘å¦å®šï¼Œå°¤å…¶æ˜¯èŒåœºçš„æ‰“å·¥äººã€‚å¦‚æœä½ ç»å¸¸æ„Ÿè§‰ï¼Œè¿™ä¸ªåšä¸å¥½ï¼Œé‚£ä¸ªå­¦ä¸ä¼šï¼Œåˆ«çš„ä¹Ÿä¸æ‡‚ï¼Œé‚£ä¹ˆä¹…è€Œä¹…ä¹‹ä¼šè¶Šæ¥è¶Šç¼ºä¹è‡ªä¿¡ã€‚</p><p>ä¸€èˆ¬è¯´èƒ½æˆäº‹çš„äººéƒ½å…·æœ‰<code>èµŒå¾’</code>ç²¾ç¥ï¼Œåœ¨ä»–ä»¬çœ¼é‡Œåªè¦åšè¿™äº‹é‚£å°±ä¸€å®šèƒ½æˆï¼Œå½“ç„¶ä¹Ÿæœ‰å¯èƒ½æœ€åå°±æ²¡æˆï¼Œä½†åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­äººçš„å¿ƒæ€æ˜¯è‰¯å¥½çš„ï¼Œæ¯å¤©éƒ½æœ‰ä¸€ä¸ªé¥±æ»¡çš„ç²¾ç¥çŠ¶æ€ï¼Œå­œå­œä¸å€¦çš„å¥‹æ–—ç€ã€‚æœ€åä¹Ÿå°±æ˜¯è¿™æ ·çš„æ–—å¿—è®©èµ°åœ¨ä¸€ä¸ªèµ·ç‚¹çš„å°ä¼™ä¼´ï¼Œæœ‰äº†å·®è·ã€‚</p><h2 id="äºŒã€é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#äºŒã€é¢è¯•é¢˜" aria-hidden="true">#</a> äºŒã€é¢è¯•é¢˜</h2><p><code>è°¢é£æœºï¼Œå°è®°</code>ï¼Œä»Šå¤©æ‰“å·¥äººå‘€ï¼Œæ˜å¤©æ—©ä¸Šå›°å‘€ï¼Œå˜Ÿå˜Ÿå˜Ÿï¼Œå–‚ï¼Ÿè°å‘€ï¼Œæ‰“å†œè¯å‘¢ï¼ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šå“å‘¦ï¼Œé¢è¯•å®˜å¤§å“¥ï¼Œå’‹äº†ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šå·å·å‘Šè¯‰ä½ å“ˆï¼Œä½ ä¸€é¢è¿‡äº†ã€‚</p><p><strong>è°¢é£æœº</strong>ï¼šå˜¿å˜¿ï¼ŒçœŸçš„å‘€ï¼å¤ªå¥½äº†ï¼å“ˆå“ˆå“ˆï¼Œé‚£æˆ‘è¿˜å‡†å¤‡ç‚¹ä»€ä¹ˆå‘¢ï¼ï¼Ÿ</p><p><strong>é¢è¯•å®˜</strong>ï¼šäºŒé¢ä¼šæ¯”è¾ƒéš¾å–½ï¼Œå—¯ï¼Œæˆ‘é¡ºä¾¿é—®ä½ ä¸€ä¸ªå“ˆã€‚AQS ä½ äº†è§£å—ï¼ŒReentrantLock è·å–é”çš„è¿‡ç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿä»€ä¹ˆæ˜¯ CASï¼Ÿ...</p><p><strong>è°¢é£æœº</strong>ï¼šæˆ‘æˆ‘æˆ‘ï¼Œ<em>è„‘å­è¿˜åœ¨åç¾¿å°„ç®­é‡Œ</em>ï¼Œæˆ‘ä¸€ä¼šå°±çœ‹çœ‹ï¼ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šå¥½å¥½å‡†å¤‡ä¸‹å§ï¼Œæ‰“å·¥äººï¼Œæ‰“å·¥é­‚ï¼</p><h2 id="ä¸‰ã€reentrantlock-å’Œ-aqs" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€reentrantlock-å’Œ-aqs" aria-hidden="true">#</a> ä¸‰ã€ReentrantLock å’Œ AQS</h2><h3 id="_1-reentrantlock-çŸ¥è¯†é“¾" tabindex="-1"><a class="header-anchor" href="#_1-reentrantlock-çŸ¥è¯†é“¾" aria-hidden="true">#</a> 1. ReentrantLock çŸ¥è¯†é“¾</h3><p>ReentrantLock å¯é‡å…¥ç‹¬å é”æ¶‰åŠçš„çŸ¥è¯†ç‚¹è¾ƒå¤šï¼Œä¸ºäº†æ›´å¥½çš„å­¦ä¹ è¿™äº›çŸ¥è¯†ï¼Œåœ¨ä¸Šä¸€ç« èŠ‚å…ˆåˆ†ææºç å’Œå­¦ä¹ å®ç°äº†å…¬å¹³é”çš„å‡ ç§æ–¹æ¡ˆã€‚åŒ…æ‹¬ï¼šCLHã€MCSã€Ticketï¼Œé€šè¿‡è¿™éƒ¨åˆ†å†…å®¹çš„å­¦ä¹ ï¼Œå†æ¥ç†è§£ ReentrantLock ä¸­å…³äº CLH çš„å˜ä½“å®ç°å’Œç›¸åº”çš„åº”ç”¨å°±æ¯”è¾ƒå®¹æ˜“äº†ã€‚</p><p>æ¥ä¸‹æ¥æ²¿ç€ ReentrantLock çš„çŸ¥è¯†é“¾ï¼Œç»§ç»­åˆ†æ AQS ç‹¬å é”çš„ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œå¦‚å›¾ 17-1</p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-17-1.png" alt="å›¾ 17-1 ReentrantLock çš„çŸ¥è¯†é“¾"></p><p>åœ¨è¿™éƒ¨åˆ†çŸ¥è¯†å­¦ä¹ ä¸­ï¼Œä¼šä¸»è¦å›´ç»• ReentrantLock ä¸­å…³äº AQS çš„ä½¿ç”¨è¿›è¡Œå±•å¼€ï¼Œé€æ­¥åˆ†ææºç äº†è§£åŸç†ã€‚</p><p>AQS æ˜¯ AbstractQueuedSynchronizer çš„ç¼©å†™ï¼Œå‡ ä¹æ‰€æœ‰ Lock éƒ½æ˜¯åŸºäº AQS æ¥å®ç°äº†ï¼Œå…¶åº•å±‚å¤§é‡ä½¿ç”¨ CAS æä¾›ä¹è§‚é”æœåŠ¡ï¼Œåœ¨å†²çªæ—¶é‡‡ç”¨è‡ªæ—‹æ–¹å¼è¿›è¡Œé‡è¯•ï¼Œä»¥æ­¤å®ç°è½»é‡çº§å’Œé«˜æ•ˆçš„è·å–é”ã€‚</p><p>å¦å¤– AbstractQueuedSynchronizer æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½†å¹¶æ²¡æœ‰å®šä¹‰ç›¸åº”çš„æŠ½è±¡æ–¹æ³•ï¼Œè€Œæ˜¯æä¾›äº†å¯ä»¥è¢«å­—ç±»ç»§æ‰¿æ—¶è¦†ç›–çš„ protected çš„æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„æ”¯æŒç»§æ‰¿ç±»çš„ä½¿ç”¨ã€‚</p><h3 id="_2-å†™ä¸€ä¸ªç®€å•çš„-aqs-åŒæ­¥ç±»" tabindex="-1"><a class="header-anchor" href="#_2-å†™ä¸€ä¸ªç®€å•çš„-aqs-åŒæ­¥ç±»" aria-hidden="true">#</a> 2. å†™ä¸€ä¸ªç®€å•çš„ AQS åŒæ­¥ç±»</h3><p>åœ¨å­¦ä¹  ReentrantLock ä¸­åº”ç”¨çš„ AQS ä¹‹å‰ï¼Œå…ˆå®ç°ä¸€ä¸ªç®€å•çš„åŒæ­¥ç±»ï¼Œæ¥ä½“ä¼šä¸‹ AQS çš„ä½œç”¨ã€‚</p><h4 id="_2-1-ä»£ç å®ç°" tabindex="-1"><a class="header-anchor" href="#_2-1-ä»£ç å®ç°" aria-hidden="true">#</a> 2.1 ä»£ç å®ç°</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncLock</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SyncLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºï¼Œåªæœ‰ç”¨åˆ° Condition æ‰éœ€è¦å»å®ç°</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå®ç°çš„è¿‡ç¨‹å±äº ReentrantLock ç®€ç‰ˆï¼Œä¸»è¦åŒ…æ‹¬å¦‚ä¸‹å†…å®¹ï¼š</p><ol><li>Sync ç±»ç»§æ‰¿ AbstractQueuedSynchronizerï¼Œå¹¶é‡å†™æ–¹æ³•ï¼štryAcquireã€tryReleaseã€isHeldExclusivelyã€‚</li><li>è¿™ä¸‰ä¸ªæ–¹æ³•åŸºæœ¬æ˜¯å¿…é¡»é‡å†™çš„ï¼Œå¦‚æœä¸é‡å†™åœ¨ä½¿ç”¨çš„æ—¶å€™å°±ä¼šæŠ›å¼‚å¸¸ <code>UnsupportedOperationException</code>ã€‚</li><li>é‡å†™çš„è¿‡ç¨‹ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯ä½¿ç”¨ AQS æä¾›çš„ CAS æ–¹æ³•ã€‚ä»¥é¢„æœŸå€¼ä¸º 0ï¼Œå†™å…¥æ›´æ–°å€¼ 1ï¼Œå†™å…¥æˆåŠŸåˆ™è·å–é”æˆåŠŸã€‚å…¶å®è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯å¯¹ state ä½¿ç”¨ <code>unsafe</code> æœ¬åœ°æ–¹æ³•ï¼Œä¼ é€’åç§»é‡ stateOffset ç­‰å‚æ•°ï¼Œè¿›è¡Œå€¼äº¤æ¢æ“ä½œã€‚<code>unsafe.compareAndSwapInt(this, stateOffset, expect, update)</code></li><li>æœ€åæä¾› lockã€unlock ä¸¤ä¸ªæ–¹æ³•ï¼Œå®é™…çš„ç±»ä¸­ä¼šå®ç° Lock æ¥å£ä¸­çš„ç›¸åº”æ–¹æ³•ï¼Œè¿™é‡Œä¸ºäº†ç®€åŒ–ç›´æ¥è‡ªå®šä¹‰è¿™æ ·ä¸¤ä¸ªæ–¹æ³•ã€‚</li></ol><h4 id="_2-2-å•å…ƒæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_2-2-å•å…ƒæµ‹è¯•" aria-hidden="true">#</a> 2.2 å•å…ƒæµ‹è¯•</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_SyncLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">SyncLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TestLock</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestLock</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">SyncLock</span> lock<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">TestLock</span><span class="token punctuation">(</span><span class="token class-name">SyncLock</span> lock<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> lock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            
            <span class="token comment">//éœ€è¦è®¾ç½®ä¸€ä¸ªéšæœºä¼‘çœ æ—¶é—´æ¥éªŒè¯ç»“æœï¼Œçº¿ç¨‹æ˜¯æ¯200æ¯«ç§’åˆ›å»ºä¸€ä¸ªï¼Œ</span>
            <span class="token comment">// å¦‚æœæ¯ä¸ªçº¿ç¨‹éƒ½ä¼‘çœ ç›¸åŒçš„æ—¶é—´ï¼Œå…ˆåˆ›å»ºçš„çº¿ç¨‹è‚¯å®šä¼šå…ˆæ‰§è¡Œå®Œçš„ï¼Œå°±ç®—ä¸åŠ å…¬å¹³é”ï¼Œç»“æœä»ç„¶æ˜¯é¡ºåºè¾“å‡º</span>
            <span class="token keyword">int</span> randomNumber <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>randomNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Thread %s Completed&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä»¥ä¸Šè¿™ä¸ªå•å…ƒæµ‹è¯•å’Œæˆ‘ä»¬åœ¨ä¸Šä¸€ç« èŠ‚ä»‹ç»å…¬å¹³é”æ—¶æ˜¯ä¸€æ ·çš„ï¼ŒéªŒè¯é¡ºåºè¾“å‡ºã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©å¤šçº¿ç¨‹æ“ä½œä¸€ä¸ªæ–¹æ³•è¿›è¡ŒåŠ å’Œè¿ç®—ã€‚</li><li>åœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­å¯ä»¥å°è¯•æŠŠåŠ é”ä»£ç æ³¨é‡Šæ‰ï¼Œè¿›è¡Œæ¯”å¯¹ã€‚å¦‚æœå¯ä»¥é¡ºåºè¾“å‡ºï¼Œé‚£ä¹ˆå°±æ˜¯é¢„æœŸç»“æœã€‚</li></ul><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Thread</span> <span class="token number">0</span> <span class="token class-name">Completed</span>
<span class="token class-name">Thread</span> <span class="token number">1</span> <span class="token class-name">Completed</span>
<span class="token class-name">Thread</span> <span class="token number">2</span> <span class="token class-name">Completed</span>
<span class="token class-name">Thread</span> <span class="token number">3</span> <span class="token class-name">Completed</span>
<span class="token class-name">Thread</span> <span class="token number">4</span> <span class="token class-name">Completed</span>
<span class="token class-name">Thread</span> <span class="token number">5</span> <span class="token class-name">Completed</span>
<span class="token class-name">Thread</span> <span class="token number">6</span> <span class="token class-name">Completed</span>
<span class="token class-name">Thread</span> <span class="token number">7</span> <span class="token class-name">Completed</span>
<span class="token class-name">Thread</span> <span class="token number">8</span> <span class="token class-name">Completed</span>
<span class="token class-name">Thread</span> <span class="token number">9</span> <span class="token class-name">Completed</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä»æµ‹è¯•ç»“æœçœ‹ï¼Œä»¥ä¸Š AQS å®ç°çš„åŒæ­¥ç±»ï¼Œæ»¡è¶³é¢„æœŸæ•ˆæœã€‚</li><li>æœ‰äº†è¿™æ®µä»£ç çš„æ¦‚å¿µç»“æ„ï¼Œæ¥ä¸‹æ¥åœ¨åˆ†æ ReentrantLock ä¸­çš„ AQS ä½¿ç”¨å°±æœ‰ä¸€å®šçš„æ„Ÿè§‰äº†ï¼</li></ul><h3 id="_3-cas-ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#_3-cas-ä»‹ç»" aria-hidden="true">#</a> 3. CAS ä»‹ç»</h3><p>CAS æ˜¯ compareAndSet çš„ç¼©å†™ï¼Œå®ƒçš„åº”ç”¨åœºæ™¯å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œå€¼å˜æ›´ï¼Œåœ¨å˜æ›´æ—¶ä¼šä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªæ˜¯é¢„æœŸå€¼ã€å¦å¤–ä¸€ä¸ªæ˜¯æ›´æ–°å€¼ã€‚å¦‚æœè¢«æ›´æ–°çš„å˜é‡é¢„æœŸå€¼ä¸ä¼ å…¥å€¼ä¸€è‡´ï¼Œåˆ™å¯ä»¥å˜æ›´ã€‚</p><p>CAS çš„å…·ä½“æ“ä½œä½¿ç”¨åˆ°äº† <code>unsafe</code> ç±»ï¼Œåº•å±‚ç”¨åˆ°äº†æœ¬åœ°æ–¹æ³• <code>unsafe.compareAndSwapInt</code> æ¯”è¾ƒäº¤æ¢æ–¹æ³•ã€‚</p><p>CAS æ˜¯ä¸€ç§æ— é”ç®—æ³•ï¼Œè¿™ç§æ“ä½œæ˜¯ CPU æŒ‡ä»¤é›†æ“ä½œï¼Œåªæœ‰ä¸€æ­¥åŸå­æ“ä½œï¼Œé€Ÿåº¦éå¸¸å¿«ã€‚è€Œä¸” CAS é¿å…äº†è¯·æ±‚æ“ä½œç³»ç»Ÿæ¥è£å®šé”é—®é¢˜ï¼Œç›´æ¥ç”± CPU æå®šï¼Œä½†ä¹Ÿä¸æ˜¯æ²¡æœ‰å¼€é”€ï¼Œæ¯”å¦‚ Cache Missï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œäº†è§£ CPU ç¡¬ä»¶ç›¸å…³çŸ¥è¯†ã€‚</p><h3 id="_4-aqs-æ ¸å¿ƒæºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_4-aqs-æ ¸å¿ƒæºç åˆ†æ" aria-hidden="true">#</a> 4. AQS æ ¸å¿ƒæºç åˆ†æ</h3><h4 id="_4-1-è·å–é”æµç¨‹å›¾" tabindex="-1"><a class="header-anchor" href="#_4-1-è·å–é”æµç¨‹å›¾" aria-hidden="true">#</a> 4.1 è·å–é”æµç¨‹å›¾</h4><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-17-2.png" alt="å›¾ 17-2 è·å–é”æµç¨‹å›¾"></p><p>å›¾ 17-2 å°±æ˜¯æ•´ä¸ª ReentrantLock ä¸­è·å–é”çš„æ ¸å¿ƒæµç¨‹ï¼ŒåŒ…æ‹¬éå…¬å¹³é”å’Œå…¬å¹³é”çš„ä¸€äº›äº¤å‰æµç¨‹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»¥æ­¤æŒ‰ç…§æ­¤æµç¨‹æ¥è®²è§£ç›¸åº”çš„æºç éƒ¨åˆ†ã€‚</p><h4 id="_4-2-lock" tabindex="-1"><a class="header-anchor" href="#_4-2-lock" aria-hidden="true">#</a> 4.2 lock</h4><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-17-3.png" alt="å›¾ 17-3 lock -&gt; CAS"></p><p>ReentrantLock å®ç°äº†éå…¬å¹³é”å’Œå…¬å¹³é”ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ <code>lock.lock();</code> æ—¶ï¼Œä¼šæœ‰ä¸åŒçš„å®ç°ç±»ï¼š</p><ol><li>éå…¬å¹³é”ï¼Œä¼šç›´æ¥ä½¿ç”¨ CAS è¿›è¡ŒæŠ¢å ï¼Œä¿®æ”¹å˜é‡ state å€¼ã€‚å¦‚æœæˆåŠŸåˆ™ç›´æ¥æŠŠè‡ªå·±çš„çº¿ç¨‹è®¾ç½®åˆ° exclusiveOwnerThreadï¼Œä¹Ÿå°±æ˜¯è·å¾—é”æˆåŠŸã€‚<em>ä¸æˆåŠŸåç»­åˆ†æ</em></li><li>å…¬å¹³é”ï¼Œåˆ™ä¸ä¼šè¿›è¡ŒæŠ¢å ï¼Œè€Œæ˜¯è§„è§„çŸ©çŸ©çš„è¿›è¡Œæ’é˜Ÿã€‚<em>è€å®äºº</em></li></ol><h4 id="_4-3-compareandsetstate" tabindex="-1"><a class="header-anchor" href="#_4-3-compareandsetstate" aria-hidden="true">#</a> 4.3 compareAndSetState</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨éå…¬å¹³é”çš„å®ç°ç±»é‡Œï¼Œè·å–é”çš„è¿‡ç¨‹ï¼Œæœ‰è¿™æ ·ä¸€æ®µ CAS æ“ä½œçš„ä»£ç ã€‚<code>compareAndSetState</code> èµ‹å€¼æˆåŠŸåˆ™è·å–é”ã€‚é‚£ä¹ˆ CAS è¿™é‡Œé¢åšäº†ä»€ä¹ˆæ“ä½œï¼Ÿ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// See below for intrinsics setup to support this</span>
    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¾€ä¸‹ç¿»æˆ‘ä»¬çœ‹åˆ°è¿™æ ·ä¸€æ®µä»£ç ï¼Œè¿™é‡Œæ˜¯ unsafe åŠŸèƒ½ç±»çš„ä½¿ç”¨ï¼Œä¸¤ä¸ªå‚æ•°åˆ°è¿™é‡Œå˜æˆå››ä¸ªå‚æ•°ã€‚å¤šäº† thisã€stateOffsetã€‚this æ˜¯å¯¹è±¡æœ¬èº«ï¼Œé‚£ä¹ˆ stateOffset æ˜¯ä»€ä¹ˆï¼Ÿ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>stateOffset <span class="token operator">=</span> unsafe<span class="token punctuation">.</span>objectFieldOffset
    <span class="token punctuation">(</span><span class="token class-name">AbstractQueuedSynchronizer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å†å¾€ä¸‹çœ‹æˆ‘ä»¬æ‰¾åˆ°ï¼ŒstateOffset æ˜¯åç§»é‡å€¼ï¼Œåç§»é‡æ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹è¿™ä¸ªå€¼åˆ°åº•æ˜¯å¤šå°‘ï¼</p><p><strong>å¼•ç”¨POM jol-cli</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.openjdk.jol/jol-cli --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jol<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jol-cli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.14<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å•å…ƒæµ‹è¯•</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_stateOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token function">getUnsafeInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> state <span class="token operator">=</span> unsafe<span class="token punctuation">.</span>objectFieldOffset
            <span class="token punctuation">(</span><span class="token class-name">AbstractQueuedSynchronizer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 16</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é€šè¿‡ getUnsafeInstance æ–¹æ³•è·å– Unsafeï¼Œè¿™æ˜¯ä¸€ä¸ªå›ºå®šçš„æ–¹æ³•ã€‚</li><li>åœ¨è·å– AQS ç±»ä¸­çš„å±æ€§å­—æ®µ state çš„åç§»é‡ï¼Œ16ã€‚</li><li>é™¤äº†è¿™ä¸ªå±æ€§å¤–ä½ è¿˜å¯ä»¥æ‹¿åˆ°ï¼šheadOffsetã€tailOffsetã€waitStatusOffsetã€nextOffsetï¼Œçš„å€¼ï¼Œæœ€ç»ˆè‡ªæ—‹æ¥å˜æ›´è¿™äº›å˜é‡çš„å€¼ã€‚</li></ul><h4 id="_4-4-aqs-acquire" tabindex="-1"><a class="header-anchor" href="#_4-4-aqs-acquire" aria-hidden="true">#</a> 4.4 (AQS)acquire</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ•´ä¸ªè¿™å—ä»£ç é‡Œé¢åŒ…å«äº†å››ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œå¦‚ä¸‹ï¼š</p><ol><li><strong>tryAcquire</strong>ï¼Œåˆ†åˆ«ç”±ç»§æ‰¿ AQS çš„å…¬å¹³é”ï¼ˆFairSyncï¼‰ã€éå…¬å¹³é”ï¼ˆNonfairSyncï¼‰å®ç°ã€‚</li><li><strong>addWaiter</strong>ï¼Œè¯¥æ–¹æ³•æ˜¯ AQS çš„ç§æœ‰æ–¹æ³•ï¼Œä¸»è¦ç”¨é€”æ˜¯æ–¹æ³• <strong>tryAcquire</strong> è¿”å› false ä»¥åï¼Œä¹Ÿå°±æ˜¯è·å–é”å¤±è´¥ä»¥åï¼ŒæŠŠå½“å‰è¯·æ±‚é”çš„çº¿ç¨‹æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¹¶è¿”å› Node èŠ‚ç‚¹ã€‚</li><li><strong>acquireQueued</strong>ï¼Œè´Ÿè´£æŠŠ addWaiter è¿”å›çš„ Node èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—ç»“å°¾ï¼Œå¹¶ä¼šæ‰§è¡Œè·å–é”æ“ä½œä»¥åŠåˆ¤æ–­æ˜¯å¦æŠŠå½“å‰çº¿ç¨‹æŒ‚èµ·ã€‚</li><li><strong>selfInterrupt</strong>ï¼Œæ˜¯ AQS ä¸­çš„ <code>Thread.currentThread().interrupt()</code> æ–¹æ³•è°ƒç”¨ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯åœ¨æ‰§è¡Œå®Œ acquire ä¹‹å‰è‡ªå·±æ‰§è¡Œä¸­æ–­æ“ä½œã€‚</li></ol><h4 id="_4-5-tryacquire" tabindex="-1"><a class="header-anchor" href="#_4-5-tryacquire" aria-hidden="true">#</a> 4.5 tryAcquire</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™éƒ¨åˆ†è·å–é”çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š</p><ol><li>å¦‚æœ <code>c == 0</code>ï¼Œé”æ²¡æœ‰è¢«å ç”¨ï¼Œå°è¯•ä½¿ç”¨ CAS æ–¹å¼è·å–é”ï¼Œå¹¶è¿”å› trueã€‚</li><li>å¦‚æœ <code>current == getExclusiveOwnerThread()</code>ï¼Œä¹Ÿå°±æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰é”ï¼Œåˆ™éœ€è¦è°ƒç”¨ <code>setState</code> è¿›è¡Œé”é‡å…¥æ“ä½œã€‚<em>setState ä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºæ˜¯åœ¨è‡ªå·±çš„å½“å‰çº¿ç¨‹ä¸‹ã€‚</em></li><li>æœ€åå¦‚æœä¸¤ç§éƒ½ä¸æ»¡è¶³ğŸ˜Œï¼Œåˆ™è¿”å› falseã€‚</li></ol><h4 id="_4-6-addwaiter" tabindex="-1"><a class="header-anchor" href="#_4-6-addwaiter" aria-hidden="true">#</a> 4.6 addWaiter</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Node</span> pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©º, ä½¿ç”¨ CAS æ–¹å¼å°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºå°¾èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
            <span class="token keyword">return</span> node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// é˜Ÿåˆ—ä¸ºç©ºã€CASå¤±è´¥ï¼Œå°†èŠ‚ç‚¹æ’å…¥é˜Ÿåˆ—</span>
    <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å½“æ‰§è¡Œæ–¹æ³• <code>addWaiter</code>ï¼Œé‚£ä¹ˆå°±æ˜¯ <code>!tryAcquire = true</code>ï¼Œä¹Ÿå°±æ˜¯ tryAcquire è·å–é”å¤±è´¥äº†ã€‚</li><li>æ¥ä¸‹æ¥å°±æ˜¯æŠŠå½“å‰çº¿ç¨‹å°è£…åˆ° Node èŠ‚ç‚¹ä¸­ï¼ŒåŠ å…¥åˆ° FIFO é˜Ÿåˆ—ä¸­ã€‚<em>å› ä¸ºå…ˆè¿›å…ˆå‡ºï¼Œæ‰€ä»¥åæ¥çš„é˜Ÿåˆ—åŠ å…¥åˆ°é˜Ÿå°¾</em></li><li><code>compareAndSetTail</code> ä¸ä¸€å®šä¸€å®šæˆåŠŸï¼Œå› ä¸ºåœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°æ“ä½œå¤±è´¥ã€‚é‚£ä¹ˆå¤±è´¥åï¼Œåˆ™éœ€è¦è°ƒç”¨ enq æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè‡ªæ—‹æ“ä½œï¼ŒæŠŠèŠ‚ç‚¹å…¥é˜Ÿåˆ—ã€‚</li></ul><p><strong>enq</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">enq</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Must initialize</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetHead</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                tail <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                t<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token keyword">return</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è‡ªæ—‹è½¬<code>forå¾ªç¯</code> + CAS å…¥é˜Ÿåˆ—ã€‚</li><li>å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œåˆ™ä¼šæ–°åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŠŠå°¾èŠ‚ç‚¹æŒ‡å‘å¤´èŠ‚ç‚¹ï¼Œç„¶åç»§ç»­å¾ªç¯ã€‚</li><li>ç¬¬äºŒæ¬¡å¾ªç¯æ—¶ï¼Œåˆ™ä¼šæŠŠå½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿå°¾ã€‚<em>head èŠ‚æ˜¯ä¸€ä¸ªæ— ç”¨èŠ‚ç‚¹ï¼Œè¿™å’Œæˆ‘ä»¬åšCLHå®ç°æ—¶ç±»ä¼¼</em></li></ul><p><strong>æ³¨æ„ï¼Œä»å°¾èŠ‚ç‚¹é€†å‘éå†</strong></p><ol><li>é¦–å…ˆè¿™é‡Œçš„èŠ‚ç‚¹è¿æ¥æ“ä½œå¹¶ä¸æ˜¯åŸå­ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸ªåˆ«èŠ‚ç‚¹å¹¶æ²¡æœ‰è®¾ç½® next å€¼ï¼Œå°±å¤±è´¥äº†ã€‚</li><li>ä½†è¿™äº›èŠ‚ç‚¹çš„ prev æ˜¯æœ‰å€¼çš„ï¼Œæ‰€ä»¥éœ€è¦é€†å‘éå†ï¼Œè®© prev å±æ€§é‡æ–°æŒ‡å‘æ–°çš„å°¾èŠ‚ç‚¹ï¼Œç›´è‡³å…¨éƒ¨è‡ªæ—‹å…¥é˜Ÿåˆ—ã€‚</li></ol><h4 id="_4-7-acquirequeued" tabindex="-1"><a class="header-anchor" href="#_4-7-acquirequeued" aria-hidden="true">#</a> 4.7 acquireQueued</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å½“å‰èŠ‚ç‚¹çš„å‰é©±å°±æ˜¯headèŠ‚ç‚¹æ—¶, å†æ¬¡å°è¯•è·å–é”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
                failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è·å–é”å¤±è´¥å, åˆ¤æ–­æ˜¯å¦æŠŠå½“å‰çº¿ç¨‹æŒ‚èµ·</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“è·å–é”æµç¨‹èµ°åˆ°è¿™ï¼Œè¯´æ˜èŠ‚ç‚¹å·²ç»åŠ å…¥é˜Ÿåˆ—å®Œæˆã€‚çœ‹æºç ä¸­æ¥ä¸‹æ¥å°±æ˜¯è®©è¯¥æ–¹æ³•å†æ¬¡å°è¯•è·å–é”ï¼Œå¦‚æœè·å–é”å¤±è´¥ä¼šåˆ¤æ–­æ˜¯å¦æŠŠçº¿ç¨‹æŒ‚èµ·ã€‚</p><p><strong>setHead</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setHead</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    head <span class="token operator">=</span> node<span class="token punctuation">;</span>
    node<span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    node<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å­¦ä¹  CLH å…¬å¹³é”æ•°æ®ç»“æ„ä¸­è®²åˆ°HeadèŠ‚ç‚¹æ˜¯ä¸€ä¸ªè™šèŠ‚ç‚¹ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯HeadèŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¯´æ˜æ­¤æ—¶NodeèŠ‚ç‚¹æ’åœ¨é˜Ÿåˆ—æœ€å‰é¢ï¼Œå¯ä»¥å°è¯•è·å–é”ã€‚</p><p>è·å–é”åè®¾ç½®HeadèŠ‚ç‚¹ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªå‡ºé˜Ÿåˆ—è¿‡ç¨‹ï¼ŒåŸæ¥èŠ‚ç‚¹è®¾ç½®Nullæ–¹ä¾¿GCã€‚</p><p><strong>shouldParkAfterFailedAcquire</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span><span class="token class-name">Node</span> pred<span class="token punctuation">,</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span>
    	<span class="token comment">// SIGNAL è®¾ç½®äº†å‰ä¸€ä¸ªèŠ‚ç‚¹å®Œç»“å”¤é†’ï¼Œå®‰å¿ƒå¹²åˆ«çš„å»äº†ï¼Œè¿™é‡Œæ˜¯ç¡ã€‚</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ æ˜¯å¦è¿˜CANCELLEDã€SIGNALã€CONDITION ã€PROPAGATE ï¼Œè¿™å››ç§çŠ¶æ€ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ç”¨åˆ°äº†ä¸¤ç§å¦‚ä¸‹ï¼š</p><ol><li><strong>CANCELLED</strong>ï¼Œå–æ¶ˆæ’é˜Ÿï¼Œæ”¾å¼ƒè·å–é”ã€‚</li><li><strong>SIGNAL</strong>ï¼Œæ ‡è¯†å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€å·²ç»è¢«æŒ‚èµ·ï¼Œæ„æ€å°±æ˜¯å¤§å®¶ä¸€èµ·æ’é˜Ÿä¸Šå•æ‰€ï¼Œé˜Ÿä¼å¤ªé•¿äº†ï¼Œåé¢çš„è°¢é£æœºè¯´ï¼Œæˆ‘å»ä¹°ä¸ªæ²¹æ¡å“ˆï¼Œä¸€ä¼šåˆ°æˆ‘äº†ï¼Œä½ å¾®ä¿¡æˆ‘å“ˆã€‚å…¶å®å°±æ˜¯å½“å‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œéœ€è¦é¢å¤–æ‰§è¡Œå”¤é†’åç»§èŠ‚ç‚¹æ“ä½œã€‚</li></ol><p><strong>é‚£ä¹ˆ</strong>ï¼Œä»¥ä¸Šè¿™æ®µä»£ç ä¸»è¦çš„æ‰§è¡Œå†…å®¹åŒ…æ‹¬ï¼š</p><ol><li>å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€æ˜¯ <code>SIGNAL</code>ï¼Œåˆ™è¿”å› trueã€‚<em>å®‰å¿ƒç¡è§‰ğŸ˜ªç­‰ç€è¢«å«é†’</em></li><li>å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€æ˜¯ <code>CANCELLED</code>ï¼Œå°±æ˜¯å®ƒæ”¾å¼ƒäº†ï¼Œåˆ™ç»§ç»­å‘å‰å¯»æ‰¾å…¶ä»–èŠ‚ç‚¹ã€‚</li><li>æœ€åå¦‚æœä»€ä¹ˆéƒ½æ²¡æ‰¾åˆ°ï¼Œå°±ç»™å‰ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸ªé—¹é’Ÿ <code>SIGNAL</code>ï¼Œç­‰ç€è¢«é€šçŸ¥ã€‚</li></ol><h4 id="_4-8-parkandcheckinterrupt" tabindex="-1"><a class="header-anchor" href="#_4-8-parkandcheckinterrupt" aria-hidden="true">#</a> 4.8 parkAndCheckInterrupt</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">// çº¿ç¨‹æŒ‚èµ·ç­‰å¾…è¢«å”¤é†’    </span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å½“æ–¹æ³• <code>shouldParkAfterFailedAcquire</code> è¿”å› false æ—¶ï¼Œä»£è¡¨åŒæ­¥å™¨æ”¹å˜äº†å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º <code>SIGNAL</code>ï¼Œåœ¨ä¸‹ä¸€æ¬¡å¾ªç¯ä¸­ï¼Œ <code>shouldParkAfterFailedAcquire</code> è¿”å› trueï¼Œå†æ‰§è¡Œ parkAndCheckInterrupt() æ–¹æ³•ã€‚</li><li>é‚£ä¹ˆï¼Œè¿™ä¸€æ®µä»£ç å°±æ˜¯å¯¹çº¿ç¨‹çš„æŒ‚èµ·æ“ä½œï¼Œ<code>LockSupport.park(this);</code>ã€‚</li><li><code>Thread.interrupted()</code> æ£€æŸ¥å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è¯†ã€‚</li></ul><h2 id="å››ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å››ã€æ€»ç»“" aria-hidden="true">#</a> å››ã€æ€»ç»“</h2><ul><li>ReentrantLock çš„çŸ¥è¯†æ¯”è¾ƒå¤šï¼Œæ¶‰åŠçš„ä»£ç é€»è¾‘ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œåœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­éœ€è¦å¯¹ç…§æºç å’Œç›¸å…³å¹¶å‘ä¹¦ç±å’Œèµ„æ–™ä¸€èµ·å­¦ä¹ ï¼Œä»¥åŠæœ€å¥½çš„æ˜¯è‡ªèº«å®è·µã€‚</li><li>AQS çš„å®ç°éƒ¨åˆ†æ¶‰åŠçš„å†…å®¹è¾ƒå¤šï¼Œä¾‹å¦‚ï¼šstate å±æ€§ä½¿ç”¨ unsafe æä¾›çš„æœ¬åœ°æ–¹æ³•è¿›è¡Œ CAS æ“ä½œï¼ŒæŠŠåˆå§‹å€¼ 0 æ”¹ä¸º 1ï¼Œåˆ™è·å¾—äº†é”ã€‚addWaiterã€acquireQueuedã€shouldParkAfterFailedAcquireã€parkAndCheckInterruptç­‰ï¼Œå¯ä»¥ç»†è‡´æ€»ç»“ã€‚</li><li>æ‰€æœ‰çš„ Lock éƒ½æ˜¯åŸºäº AQS æ¥å®ç°äº†ã€‚AQS å’Œ Condition å„è‡ªç»´æŠ¤äº†ä¸åŒçš„é˜Ÿåˆ—ï¼Œåœ¨ä½¿ç”¨ Lock å’Œ Condition çš„æ—¶å€™ï¼Œå°±æ˜¯ä¸¤ä¸ªé˜Ÿåˆ—çš„äº’ç›¸ç§»åŠ¨ã€‚è¿™å¥è¯å¯ä»¥ç»†ç»†ä½“ä¼šã€‚<em>å¯èƒ½æ–‡ä¸­ä¼šæœ‰ä¸€äº›ä¸å‡†ç¡®æˆ–è€…é”™å­—ï¼Œæ¬¢è¿ç•™è¨€ï¼Œæˆ‘ä¼šä¸æ–­çš„æ›´æ–°åšå®¢ã€‚</em></li></ul>`,91);function v(m,b){const a=t("ExternalLinkIcon");return p(),o("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),r,s("åšå®¢ï¼š"),n("a",d,[s("https://bugstack.cn"),c(a)])]),k])}const f=e(i,[["render",v],["__file","2020-11-11-mianjingshouce Â· di17pianã€Šmanonghuisuoï¼ŒReentrantLockzhiAQSyuanlifenxiheshijianshiyongã€‹.html.vue"]]);export{f as default};
