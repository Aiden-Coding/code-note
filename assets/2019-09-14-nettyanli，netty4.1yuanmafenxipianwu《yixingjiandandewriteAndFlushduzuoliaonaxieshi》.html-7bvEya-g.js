import{_ as p,r as t,o as e,c as o,a as n,b as s,d as c,e as l}from"./app-3RcBQnkC.js";const r={},i=n("h1",{id:"nettyæ¡ˆä¾‹-netty4-1æºç åˆ†æç¯‡äº”ã€Šä¸€è¡Œç®€å•çš„writeandflushéƒ½åšäº†å“ªäº›äº‹ã€‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#nettyæ¡ˆä¾‹-netty4-1æºç åˆ†æç¯‡äº”ã€Šä¸€è¡Œç®€å•çš„writeandflushéƒ½åšäº†å“ªäº›äº‹ã€‹","aria-hidden":"true"},"#"),s(" nettyæ¡ˆä¾‹ï¼Œnetty4.1æºç åˆ†æç¯‡äº”ã€Šä¸€è¡Œç®€å•çš„writeAndFlushéƒ½åšäº†å“ªäº›äº‹ã€‹")],-1),u=n("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=l(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="å‰è¨€ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#å‰è¨€ä»‹ç»" aria-hidden="true">#</a> å‰è¨€ä»‹ç»</h2><p>å¯¹äºä½¿ç”¨nettyçš„å°ä¼™ä¼´æ¥è¯´ï¼Œctx.writeAndFlush()å†ç†Ÿæ‚‰ä¸è¿‡äº†ï¼Œå®ƒå¯ä»¥å°†æˆ‘ä»¬çš„æ¶ˆæ¯å‘é€å‡ºå»ã€‚é‚£ä¹ˆå®ƒéƒ½æ‰§è¡Œäº†é‚£äº›è¡Œä¸ºå‘¢ï¼Œæ˜¯æ€ä¹ˆå°†æ¶ˆæ¯å‘é€å‡ºå»çš„å‘¢ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>                                                <span class="token class-name">I</span><span class="token operator">/</span><span class="token class-name">O</span> <span class="token class-name">Request</span>
                                           via <span class="token punctuation">{</span><span class="token annotation punctuation">@link</span> <span class="token class-name">Channel</span><span class="token punctuation">}</span> or
                                       <span class="token punctuation">{</span><span class="token annotation punctuation">@link</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">}</span>
                                                     <span class="token operator">|</span>
 <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
 <span class="token operator">|</span>                           <span class="token class-name">ChannelPipeline</span>         <span class="token operator">|</span>               <span class="token operator">|</span>
 <span class="token operator">|</span>                                                  \\<span class="token operator">|</span><span class="token operator">/</span>              <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token class-name">Inbound</span> <span class="token class-name">Handler</span>  <span class="token class-name">N</span>  <span class="token operator">|</span>            <span class="token operator">|</span> <span class="token class-name">Outbound</span> <span class="token class-name">Handler</span>  <span class="token number">1</span>  <span class="token operator">|</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>              <span class="token operator">/</span><span class="token operator">|</span>\\                                  <span class="token operator">|</span>               <span class="token operator">|</span>
 <span class="token operator">|</span>               <span class="token operator">|</span>                                  \\<span class="token operator">|</span><span class="token operator">/</span>              <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token class-name">Inbound</span> <span class="token class-name">Handler</span> <span class="token class-name">N</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">|</span>            <span class="token operator">|</span> <span class="token class-name">Outbound</span> <span class="token class-name">Handler</span>  <span class="token number">2</span>  <span class="token operator">|</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>              <span class="token operator">/</span><span class="token operator">|</span>\\                                  <span class="token punctuation">.</span>               <span class="token operator">|</span>
 <span class="token operator">|</span>               <span class="token punctuation">.</span>                                   <span class="token punctuation">.</span>               <span class="token operator">|</span>
 <span class="token operator">|</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">fireIN_EVT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">OUT_EVT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">|</span>
 <span class="token operator">|</span>        <span class="token punctuation">[</span> method call<span class="token punctuation">]</span>                       <span class="token punctuation">[</span>method call<span class="token punctuation">]</span>         <span class="token operator">|</span>
 <span class="token operator">|</span>               <span class="token punctuation">.</span>                                   <span class="token punctuation">.</span>               <span class="token operator">|</span>
 <span class="token operator">|</span>               <span class="token punctuation">.</span>                                  \\<span class="token operator">|</span><span class="token operator">/</span>              <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token class-name">Inbound</span> <span class="token class-name">Handler</span>  <span class="token number">2</span>  <span class="token operator">|</span>            <span class="token operator">|</span> <span class="token class-name">Outbound</span> <span class="token class-name">Handler</span> <span class="token class-name">M</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">|</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>              <span class="token operator">/</span><span class="token operator">|</span>\\                                  <span class="token operator">|</span>               <span class="token operator">|</span>
 <span class="token operator">|</span>               <span class="token operator">|</span>                                  \\<span class="token operator">|</span><span class="token operator">/</span>              <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token class-name">Inbound</span> <span class="token class-name">Handler</span>  <span class="token number">1</span>  <span class="token operator">|</span>            <span class="token operator">|</span> <span class="token class-name">Outbound</span> <span class="token class-name">Handler</span>  <span class="token class-name">M</span>  <span class="token operator">|</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>    <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>            <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>    <span class="token operator">|</span>
 <span class="token operator">|</span>              <span class="token operator">/</span><span class="token operator">|</span>\\                                  <span class="token operator">|</span>               <span class="token operator">|</span>
 <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
                 <span class="token operator">|</span>                                  \\<span class="token operator">|</span><span class="token operator">/</span>
 <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
 <span class="token operator">|</span>               <span class="token operator">|</span>                                   <span class="token operator">|</span>               <span class="token operator">|</span>
 <span class="token operator">|</span>       <span class="token punctuation">[</span> <span class="token class-name">Socket</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>                    <span class="token punctuation">[</span> <span class="token class-name">Socket</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>     <span class="token operator">|</span>
 <span class="token operator">|</span>                                                                   <span class="token operator">|</span>
 <span class="token operator">|</span>  <span class="token class-name">Netty</span> <span class="token class-name">Internal</span> <span class="token class-name">I</span><span class="token operator">/</span><span class="token class-name">O</span> <span class="token class-name">Threads</span> <span class="token punctuation">(</span><span class="token class-name">Transport</span> <span class="token class-name">Implementation</span><span class="token punctuation">)</span>            <span class="token operator">|</span>
 <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#æºç åˆ†æ" aria-hidden="true">#</a> æºç åˆ†æ</h2><blockquote><p>1ã€ç”±ä¸€è¡Œç®€å•å‘é€æ¶ˆæ¯å¼€å§‹</p></blockquote><p>å‘é€æ¶ˆæ¯çš„ä»£ç éå¸¸ç®€å•ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬éå¸¸å¸¸ç”¨çš„å‘é€æ¶ˆæ¯çš„æ–¹å¼ctx.writeAndFlush</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token comment">//æ¥æ”¶msgæ¶ˆæ¯{ä¸ä¸Šä¸€ç« èŠ‚ç›¸æ¯”ï¼Œæ­¤å¤„å·²ç»ä¸éœ€è¦è‡ªå·±è¿›è¡Œè§£ç }</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//é€šçŸ¥å®¢æˆ·ç«¯é“¾æ¶ˆæ¯å‘é€æˆåŠŸ</span>
	<span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;å®¢æˆ·ç«¯æ”¶åˆ°[å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ]ï¼š&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;\\r\\n&quot;</span><span class="token punctuation">;</span>
	ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>2ã€è·Ÿè¿›writeAndFlush | ChannelHandlerContext.writeAndFlush</p></blockquote><p><strong>AbstractChannelHandlerContext.java</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelFuture</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelPromise</span> <span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelPromise</span><span class="token punctuation">(</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™æ®µä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒwriteAndFlushæ–¹æ³•é‡Œæä¾›äº†ä¸€ä¸ªé»˜è®¤çš„newPromise()ä½œä¸ºå‚æ•°ä¼ é€’ã€‚ï½›promiseï¼šv. è®¸è¯º;æ‰¿è¯º;ç­”åº”;ä¿è¯;ä½¿å¾ˆå¯èƒ½;é¢„ç¤ºï½åœ¨Nettyä¸­å‘é€æ¶ˆæ¯æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡å¾€hannelPromiseä¸­æ³¨å†Œå›è°ƒç›‘å¬listeneræ¥å¾—åˆ°è¯¥æ“ä½œæ˜¯å¦æˆåŠŸã€‚</p><p><strong>åœ¨å‘é€æ¶ˆæ¯æ—¶æ·»åŠ ç›‘å¬</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span><span class="token string">&quot;hi å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ¬¢è¿å…³æ³¨&amp;è·å–ä¸“é¢˜æºç &quot;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">newProgressivePromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>3ã€ç»§ç»­å‘ä¸‹ä¸€å±‚è·Ÿè¿›ä»£ç  | AbstractChannelHandlerContext.invokeWriteAndFlush</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeWriteAndFlush</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invokeWrite0</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">invokeFlush0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">writeAndFlush</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.1ã€é¦–å…ˆé€šè¿‡invokeHandler()åˆ¤æ–­é€šé“å¤„ç†å™¨å·²æ·»åŠ åˆ°ç®¡é“</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Makes</span> best possible effort <span class="token keyword">to</span> <span class="token namespace">detect</span> <span class="token keyword">if</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@link</span> <span class="token class-name">ChannelHandler</span>#<span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">)</span><span class="token punctuation">}</span> was called
<span class="token class-name"><span class="token namespace">yet<span class="token punctuation">.</span></span> If</span> not <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@code</span> <span class="token boolean">false</span><span class="token punctuation">}</span> and <span class="token keyword">if</span> called or could not detect <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token annotation punctuation">@code</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">.</span>
<span class="token class-name">If</span> <span class="token keyword">this</span> method returns <span class="token punctuation">{</span><span class="token annotation punctuation">@code</span> <span class="token boolean">false</span><span class="token punctuation">}</span> we will not invoke the <span class="token punctuation">{</span><span class="token annotation punctuation">@link</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">}</span> but just forward the <span class="token class-name"><span class="token namespace">event<span class="token punctuation">.</span></span>
This</span> is needed as <span class="token punctuation">{</span><span class="token annotation punctuation">@link</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">}</span> may already put the <span class="token punctuation">{</span><span class="token annotation punctuation">@link</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">}</span> in the linked<span class="token operator">-</span>list
but not called <span class="token punctuation">{</span><span class="token annotation punctuation">@link</span> <span class="token class-name">ChannelHandler</span>#<span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3.2ã€æ‰§è¡Œæ¶ˆæ¯å¤„ç† invokeWrite0ï¼›é¦–å…ˆå°†æ¶ˆæ¯å†…å®¹æ”¾å…¥è¾“å‡ºç¼“å†²åŒºä¸­[ChannelOutboundBuffer] invokeFlush0ï¼›ç„¶åå°†è¾“å‡ºç¼“å†²åŒºä¸­çš„æ•°æ®é€šè¿‡socketå‘é€åˆ°ç½‘ç»œä¸­</p><blockquote><p>4ã€åˆ†æinvokeWrite0æ‰§è¡Œå†…å®¹ | AbstractChannelHandlerContext.invokeWrite0</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeWrite0</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyOutboundHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>((ChannelOutboundHandler) handler()).writeæ˜¯ä¸€ä¸ªå‡ºç«™äº‹ä»¶[ChannelOutboundHandler]ï¼Œä¼šç”±ChannelOutboundHandlerAdapterå¤„ç†ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Calls <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">#</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> to forward
 * to the next <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ChannelOutboundHandler</span></span><span class="token punctuation">}</span> in the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ChannelPipeline</span></span><span class="token punctuation">}</span>.
 *
 * Sub-classes may override this method to change behavior.
 */</span>
<span class="token annotation punctuation">@Skip</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ä¼šèµ°åˆ°ChannelPipelineä¸­ï¼Œæ¥æ‰§è¡Œç½‘ç»œæ•°æ®å‘é€ï¼›| DefaultChannelPipeline &gt; HeadContext.write</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unsafe<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>5ã€unsafe.writeæ‰§è¡Œåˆ†æ</p></blockquote><p>unsafeæ˜¯æˆ‘ä»¬æ„å»ºNioServerSocketChannelæˆ–NioSocketChannelå¯¹è±¡æ—¶ï¼Œä¸€å¹¶æ„å»ºä¸€ä¸ªæˆå‘˜å±æ€§ï¼Œå®ƒä¼šå®Œæˆåº•å±‚çœŸæ­£çš„ç½‘ç»œæ“ä½œç­‰ã€‚NioServerSocketChannelä¸­æŒæœ‰çš„unsafeæˆå‘˜å˜é‡æ˜¯NioMessageUnsafeå¯¹è±¡ï¼Œè€ŒNioSocketChannelä¸­æŒæœ‰çš„unsafeæˆå‘˜å˜é‡æ˜¯NioSocketChannelUnsafeå¯¹è±¡ã€‚è¿™é‡Œæˆ‘ä»¬è¦çœ‹çš„æ˜¯NioSocketChannelçš„writeæµç¨‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assertEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ChannelOutboundBuffer</span> outboundBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outboundBuffer<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outboundBuffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the outboundBuffer is null we know the channel was closed and so</span>
        <span class="token comment">// need to fail the future right away. If it is not null the handling of th</span>
        <span class="token comment">// will be done in flush0()</span>
        <span class="token comment">// See https://github.com/netty/netty/issues/2362</span>
        <span class="token function">safeSetFailure</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token function">newWriteException</span><span class="token punctuation">(</span>initialCloseCause<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// release message now to prevent resource-leak</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        msg <span class="token operator">=</span> <span class="token function">filterOutboundMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">estimatorHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">safeSetFailure</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    outboundBuffer<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> size<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>https://github.com/netty/netty/issues/2362</strong></p><p><img src="https://bugstack.cn/assets/images/pic-content/2019/09/netty4-1.png" alt=""></p><ul><li>è·å–è¯¥NioSocketChannelçš„ChannelOutboundBufferæˆå‘˜å±æ€§ã€‚ï¼ˆç¡®åˆ‡åœ°æ¥è¯´ChannelOutboundBufferæ˜¯NioSocketChannelUnsafeå¯¹è±¡ä¸­çš„æˆå‘˜å±æ€§ï¼Œè€ŒNioSocketChannelUnsafeæ‰æ˜¯NioSocketChannelçš„æˆå‘˜å±æ€§ã€‚ï¼‰æ¯ä¸€ä¸ªNioSocketChannelä¼šç»´æŠ¤ä¸€ä¸ªå®ƒä»¬è‡ªå·±çš„ChannelOutboundBufferï¼Œç”¨äºå­˜å‚¨å¾…å‡ºç«™å†™è¯·æ±‚ã€‚ åˆ¤æ–­è¯¥outboundBufferæ˜¯å¦ä¸ºnullï¼Œå¦‚æœä¸ºnullåˆ™è¯´æ˜è¯¥NioSocketChannelå·²ç»å…³é—­äº†ï¼Œé‚£ä¹ˆå°±ä¼šæ ‡å¿—è¯¥å¼‚æ­¥å†™æ“ä½œä¸ºå¤±è´¥å®Œæˆï¼Œå¹¶é‡Šæ”¾å†™æ¶ˆæ¯åè¿”å›ã€‚</li></ul><p><strong>AbstractNioByteChannel.java</strong> | filterOutboundMessageè¿‡æ»¤å¾…å‘é€çš„æ¶ˆæ¯ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token function">filterOutboundMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteBuf</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">isDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">newDirectBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">FileRegion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;unsupported message type: &quot;</span> <span class="token operator">+</span> <span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">simpleClassName</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">EXPECTED_TYPES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿‡æ»¤å¾…å‘é€çš„æ¶ˆæ¯ï¼Œåªæœ‰ByteBufï¼ˆå † or éå †ï¼‰ä»¥åŠ FileRegionå¯ä»¥è¿›è¡Œæœ€ç»ˆçš„Socketç½‘ç»œä¼ è¾“ï¼Œå…¶ä»–ç±»å‹çš„æ•°æ®æ˜¯ä¸æ”¯æŒçš„ï¼Œä¼šæŠ›UnsupportedOperationExceptionå¼‚å¸¸ã€‚å¹¶ä¸”ä¼šæŠŠå †ByteBufè½¬æ¢ä¸ºä¸€ä¸ªéå †çš„ByteBufè¿”å›ã€‚ä¹Ÿå°±è¯´ï¼Œæœ€åä¼šé€šè¿‡socketä¼ è¾“çš„å¯¹è±¡æ—¶éå †çš„ByteBufå’ŒFileRegionã€‚ [size = pipeline.estimatorHandle().size(msg);]ä¼°è®¡å¾…å‘é€æ•°æ®çš„å¤§å°ï¼š</p><p><strong>DefaultMessageSizeEstimator.java</strong> | é€šè¿‡ByteBuf.readableBytes()åˆ¤æ–­æ¶ˆæ¯å†…å®¹å¤§å°ï¼Œä¼°è®¡å¾…å‘é€æ¶ˆæ¯æ•°æ®çš„å¤§å°ï¼Œå¦‚æœæ˜¯FileRegionçš„è¯ç›´æ¥é¥­0ï¼Œå¦åˆ™è¿”å›ByteBufä¸­å¯è¯»å–å­—èŠ‚æ•°ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HandleImpl</span> <span class="token keyword">implements</span> <span class="token class-name">Handle</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> unknownSize<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">HandleImpl</span><span class="token punctuation">(</span><span class="token keyword">int</span> unknownSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>unknownSize <span class="token operator">=</span> unknownSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ByteBuf</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">ByteBufHolder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ByteBufHolder</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readableBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">FileRegion</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> unknownSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ChannelOutboundBuffer.java</strong> | ChannelOutboundBuffer.addMessageå°†æ¶ˆæ¯åŠ å…¥outboundBufferä¸­ç­‰å¾…å‘é€</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Add given message to this <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ChannelOutboundBuffer</span></span><span class="token punctuation">}</span>. The given <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ChannelPromise</span></span><span class="token punctuation">}</span> will be notified once
 * the message was written.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">Entry</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token function">total</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tailEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flushedEntry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span> tail <span class="token operator">=</span> tailEntry<span class="token punctuation">;</span>
        tail<span class="token punctuation">.</span>next <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tailEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>unflushedEntry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        unflushedEntry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// increment pending bytes after adding message to the unflushed arrays.</span>
    <span class="token comment">// See https://github.com/netty/netty/issues/1619</span>
    <span class="token function">incrementPendingOutboundBytes</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>pendingSize<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>6ã€ChannelOutboundBufferå‡ºæ ˆ</p></blockquote><p>ä¸€ä¸ªå†…éƒ¨çš„æ•°æ®ç»“æ„ï¼Œè¢«AbstractChannelç”¨äºå­˜å‚¨å®ƒçš„å¾…å‡ºç«™å†™è¯·æ±‚ã€‚ ChannelOutboundBufferä¸­æœ‰ä¸¤ä¸ªå±æ€§private Entry unflushedEntryã€private Entry flushedEntryã€‚å®ƒä»¬éƒ½æ˜¯ç”¨Entryå¯¹è±¡é€šè¿‡nextæŒ‡é’ˆæ¥ç»´æŠ¤çš„ä¸€ä¸ªå•å‘é“¾è¡¨ã€‚ä»¥åŠä¸€ä¸ªprivate Entry tailEntry;å¯¹è±¡è¡¨ç¤ºå§‹ç»ˆæŒ‡å‘æœ€åä¸€ä¸ªEntryå¯¹è±¡ï¼ˆå³ï¼Œæœ€ååŠ å…¥åˆ°è¯¥ChannelOutboundBufferä¸­çš„å†™è¯·æ±‚çš„æ•°æ®æ¶ˆæ¯ï¼‰ unflushedEntryè¡¨ç¤ºè¿˜æœªåˆ·æ–°çš„ByteBufçš„é“¾è¡¨å¤´ï¼›flushedEntryè¡¨ç¤ºè°ƒç”¨flush()æ“ä½œæ—¶å°†ä¼šè¿›è¡Œåˆ·æ–°çš„ByteBufçš„é“¾è¡¨å¤´ã€‚</p><blockquote><p>7ã€Entryå¯¹è±¡</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Recycler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> <span class="token constant">RECYCLER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Recycler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">protected</span> <span class="token class-name">Entry</span> <span class="token function">newObject</span><span class="token punctuation">(</span><span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">;</span>
	<span class="token class-name">Entry</span> next<span class="token punctuation">;</span>
	<span class="token class-name">Object</span> msg<span class="token punctuation">;</span>
	<span class="token class-name">ByteBuffer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bufs<span class="token punctuation">;</span>
	<span class="token class-name">ByteBuffer</span> buf<span class="token punctuation">;</span>
	<span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">;</span>
	<span class="token keyword">long</span> progress<span class="token punctuation">;</span>
	<span class="token keyword">long</span> total<span class="token punctuation">;</span>
	<span class="token keyword">int</span> pendingSize<span class="token punctuation">;</span>
	<span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">boolean</span> cancelled<span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">Handle</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Entry</span><span class="token punctuation">&gt;</span></span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">static</span> <span class="token class-name">Entry</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">long</span> total<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token constant">RECYCLER</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		entry<span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
		entry<span class="token punctuation">.</span>pendingSize <span class="token operator">=</span> size <span class="token operator">+</span> <span class="token constant">CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</span><span class="token punctuation">;</span>
		entry<span class="token punctuation">.</span>total <span class="token operator">=</span> total<span class="token punctuation">;</span>
		entry<span class="token punctuation">.</span>promise <span class="token operator">=</span> promise<span class="token punctuation">;</span>
		<span class="token keyword">return</span> entry<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">int</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			cancelled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
			<span class="token keyword">int</span> pSize <span class="token operator">=</span> pendingSize<span class="token punctuation">;</span>

			<span class="token comment">// release message and replace with an empty buffer</span>
			<span class="token class-name">ReferenceCountUtil</span><span class="token punctuation">.</span><span class="token function">safeRelease</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
			msg <span class="token operator">=</span> <span class="token class-name">Unpooled</span><span class="token punctuation">.</span><span class="token constant">EMPTY_BUFFER</span><span class="token punctuation">;</span>

			pendingSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			progress <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			bufs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			buf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> pSize<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">void</span> <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		bufs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		buf <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		promise <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		progress <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		pendingSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		count <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
		cancelled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		handle<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token class-name">Entry</span> <span class="token function">recycleAndGetNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Entry</span> next <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>next<span class="token punctuation">;</span>
		<span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> next<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Entryæ˜¯ChannelOutboundBunfferçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå®ƒæ˜¯å¯¹çœŸå®çš„å†™æ¶ˆæ¯æ•°æ®ä»¥åŠå…¶ç›¸å…³ä¿¡æ¯çš„ä¸€ä¸ªå°è£…ã€‚å¤§è‡´å°è£…äº†å¦‚ä¸‹ä¿¡æ¯ï¼š a) pendingSizeï¼šè®°å½•æœ‰è¯¥ByteBuf or ByteBufs ä¸­å¾…å‘é€æ•°æ®å¤§å° å’Œ å¯¹è±¡æœ¬èº«å†…å­˜å¤§å° çš„ç´¯åŠ å’Œ; b) promiseï¼šè¯¥å¼‚æ­¥å†™æ“ä½œçš„ChannelPromiseï¼ˆç”¨äºåœ¨å®ŒæˆçœŸæ˜¯çš„ç½‘ç»œå±‚writeåå»æ ‡è¯†å¼‚æ­¥æ“ä½œçš„å®Œæˆä»¥åŠå›è°ƒå·²ç»æ³¨å†Œåˆ°è¯¥promiseä¸Šçš„listenersï¼‰; c) totalï¼šå¾…å‘é€æ•°æ®åŒ…çš„æ€»å¤§å°ï¼ˆè¯¥å±æ€§ä¸pendingSizeçš„åŒºåˆ«åœ¨äºï¼Œå¦‚æœæ˜¯å¾…å‘é€çš„æ˜¯FileRegionæ•°æ®å¯¹è±¡ï¼Œåˆ™pengdingSizeä¸­åªæœ‰å¯¹è±¡å†…å­˜çš„å¤§å°ï¼Œå³çœŸå®çš„æ•°æ®å¤§å°è¢«è®°å½•ä¸º0ï¼›ä½†totalå±æ€§åˆ™æ˜¯ä¼šè®°å½•FileRegionä¸­æ•°æ®å¤§å°ï¼Œå¹¶ä¸”totalå±æ€§æ˜¯ä¸åŒ…å«å¯¹è±¡å†…å­˜å¤§å°ï¼Œä»…ä»…æ˜¯å¯¹æ•°æ®æœ¬èº«å¤§å°çš„è®°å½•ï¼‰; e) msgï¼šåŸå§‹æ¶ˆæ¯å¯¹è±¡çš„å¼•ç”¨; f) countï¼šå†™æ¶ˆæ¯æ•°æ®ä¸ªæ•°çš„è®°å½•ï¼ˆå¦‚æœå†™æ¶ˆæ¯æ•°æ®æ˜¯ä¸ªæ•°ç»„çš„è¯ï¼Œè¯¥å€¼ä¼šå¤§äº1ï¼‰ è¿™é‡Œè¯´æ˜ä¸‹ï¼ŒpendingSizeå±æ€§è®°å½•çš„ä¸å•å•æ˜¯å†™è¯·æ±‚æ•°æ®çš„å¤§å°ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ªå†™è¯·æ±‚å¯¹è±¡çš„å¤§å°ã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€äº†ï¼Ÿè¿™é‡Œåšä¸ªç®€å•çš„ä»‹ç»ï¼š ä¸€ä¸ªå¯¹è±¡å ç”¨çš„å†…å­˜å¤§å°é™¤äº†å®ä¾‹æ•°æ®ï¼ˆinstance dataï¼‰ï¼Œè¿˜åŒ…æ‹¬å¯¹è±¡å¤´ï¼ˆheaderï¼‰ä»¥åŠå¯¹é½å¡«å……ï¼ˆpaddingï¼‰ã€‚æ‰€ä»¥ä¸€ä¸ªå¯¹è±¡æ‰€å çš„å†…å­˜å¤§å°ä¸ºã€å¯¹è±¡å¤´ + å®ä¾‹æ•°æ® + å¯¹é½å¡«å……ã€ï¼Œå³</p><p><strong>CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// Assuming a 64-bit JVM:</span>
<span class="token comment">//  - 16 bytes object header</span>
<span class="token comment">//  - 8 reference fields</span>
<span class="token comment">//  - 2 long fields</span>
<span class="token comment">//  - 2 int fields</span>
<span class="token comment">//  - 1 boolean field</span>
<span class="token comment">//  - padding</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</span> <span class="token operator">=</span>
        <span class="token class-name">SystemPropertyUtil</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">&quot;io.netty.transport.outboundBufferEntrySizeOverhead&quot;</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡è®¾çš„æ˜¯64ä½æ“ä½œç³»ç»Ÿä¸‹ï¼Œä¸”æ²¡æœ‰ä½¿ç”¨å„ç§å‹ç¼©é€‰é¡¹çš„æƒ…å†µã€‚å¯¹è±¡å¤´çš„é•¿åº¦å 16å­—èŠ‚ï¼›å¼•ç”¨å±æ€§å 8å­—èŠ‚ï¼›longç±»å‹å 8å­—èŠ‚ï¼›intç±»å‹å 4å­—èŠ‚ï¼›booleanç±»å‹å 1å­—èŠ‚ã€‚åŒæ—¶ï¼Œç”±äºHotSpot VMçš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹è±¡çš„å¤§å°å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ï¼Œå¦‚æœæœ€ç»ˆå­—èŠ‚æ•°ä¸ä¸º8çš„å€æ•°ï¼Œåˆ™paddingä¼šè¡¥è¶³è‡³8çš„å€æ•°ã€‚</p><p>addMessageæ–¹æ³•ä¸»è¦å°±æ˜¯å°†è¯·æ±‚å†™å‡ºçš„æ•°æ®å°è£…ä¸ºEntryå¯¹è±¡ï¼Œç„¶ååŠ å…¥åˆ°tailEntryå’ŒunflushedEntryä¸­ã€‚ ç„¶åè°ƒç”¨ã€incrementPendingOutboundBytes(entry.pendingSize, false);ã€å¯¹totalPendingSizeå±æ€§ä»¥åŠunwritableå­—æ®µåšè°ƒæ•´ã€‚ totalPendingSizeå­—æ®µè®°å½•äº†è¯¥ChannelOutboundBufferä¸­æ‰€æœ‰å¸¦å‘é€Entryå¯¹è±¡çš„å çš„æ€»å†…å­˜å¤§å°å’Œæ‰€æœ‰å¸¦å‘é€æ•°æ®çš„å¤§å°ã€‚unwritableç”¨æ¥æ ‡ç¤ºå½“å‰è¯¥Channelè¦å‘é€çš„æ•°æ®æ˜¯å¦å·²ç»è¶…è¿‡äº†è®¾å®š or é»˜è®¤çš„WriteBufferWaterMarkçš„highå€¼ã€‚å¦‚æœå½“å‰æ“ä½œå¯¼è‡´äº†å¾…å†™å‡ºçš„æ•°æ®ï¼ˆåŒ…æ‹¬Entryå¯¹è±¡å¤§å°ä»¥åŠçœŸå®éœ€è¦ä¼ è¾“æ•°æ®çš„å¤§å°ï¼‰è¶…è¿‡äº†è®¾ç½®å†™ç¼“å†²åŒºçš„é«˜æ°´ä½ï¼Œé‚£ä¹ˆå°†ä¼šè§¦å‘fireChannelWritabilityChangedäº‹ä»¶ã€‚</p><p>å¾®ä¿¡æœç´¢ã€Œ<strong>bugstackè™«æ´æ ˆ</strong>ã€å…¬ä¼—å·ï¼Œå…³æ³¨åå›å¤ã€Œ<strong>rpcæ¡ˆä¾‹æºç </strong>ã€è·å–æœ¬æ–‡æºç &amp;æ›´å¤šåŸåˆ›ä¸“é¢˜æ¡ˆä¾‹ï¼</p>`,48);function v(m,b){const a=t("ExternalLinkIcon");return e(),o("div",null,[i,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),u,s("åšå®¢ï¼š"),n("a",k,[s("https://bugstack.cn"),c(a)])]),d])}const f=p(r,[["render",v],["__file","2019-09-14-nettyanliï¼Œnetty4.1yuanmafenxipianwuã€ŠyixingjiandandewriteAndFlushduzuoliaonaxieshiã€‹.html.vue"]]);export{f as default};
