import{_ as e,r as p,o as c,c as o,a as n,b as s,d as t,e as l}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"ç¬¬-16-ç« -æˆ˜æ— ä¸èƒœ-ç»™ä»£ç†å¯¹è±¡çš„å±æ€§è®¾ç½®å€¼",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ç¬¬-16-ç« -æˆ˜æ— ä¸èƒœ-ç»™ä»£ç†å¯¹è±¡çš„å±æ€§è®¾ç½®å€¼","aria-hidden":"true"},"#"),s(" ç¬¬ 16 ç« ï¼šæˆ˜æ— ä¸èƒœï¼Œç»™ä»£ç†å¯¹è±¡çš„å±æ€§è®¾ç½®å€¼")],-1),r=n("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=n("br",null,null,-1),v={href:"https://articles.zsxq.com/id_w629m13v0hni.html",target:"_blank",rel:"noopener noreferrer"},m=n("blockquote",null,[n("p",null,"æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„")],-1),b=n("h2",{id:"é›¶ã€ä¼˜ç§€ä½œä¸š",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#é›¶ã€ä¼˜ç§€ä½œä¸š","aria-hidden":"true"},"#"),s(" é›¶ã€ä¼˜ç§€ä½œä¸š")],-1),g={href:"https://t.zsxq.com/06v7aIQRV",target:"_blank",rel:"noopener noreferrer"},h={href:"https://t.zsxq.com/06niaEAYz",target:"_blank",rel:"noopener noreferrer"},f={href:"https://t.zsxq.com/084lgJpDk",target:"_blank",rel:"noopener noreferrer"},y={href:"https://t.zsxq.com/08X7yWOw4",target:"_blank",rel:"noopener noreferrer"},w={href:"https://t.zsxq.com/0a8bAchto",target:"_blank",rel:"noopener noreferrer"},j=l(`<h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>æ€ä¹ˆäº†ï¼Œè¿è¡Œçš„å¥½å¥½çš„æ”¾åœ¨åˆ«äººç”µè„‘ä¸Šå°±å‡ºé”™ï¼Ÿ</code></p><p>æ˜¯ä¸æ˜¯æœ‰æ—¶å€™ä½ è§‰å¾—æäº¤çš„ä»£ç ï¼ŒåŠŸèƒ½å®Œå–„ã€é€»è¾‘æ­£ç¡®ã€æ ¼å¼æ¼‚äº®ï¼Œä½†ä¸ç®¡æ˜¯å°å“¥å“¥è¿˜æ˜¯å°å§å§ï¼Œåªè¦æµ‹è¯•äººå‘˜ä¸€ä¸Šæ‰‹ï¼Œå°±ä¼šå‘ç° <strong>è¿™æœ‰Bugã€é‚£æœ‰Bugã€ä½ å›å»æ”¹æ”¹åˆ«è€½è¯¯æˆ‘æ—¶é—´ï¼</strong> è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢?</p><p>å› ä¸ºæµ‹è¯•äººå‘˜çš„è¾“å…¥çš„æ•°æ®å¯ä¸æ˜¯ä½ å·²ç»è·‘äº†å‡ åéèƒ½é€šè¿‡è¿è¡Œçš„ç®€å•æ•°æ®ï¼Œä»–ä»¬çš„æ•°æ®æ›´åå‘äºç”¨æˆ·çœŸå®ä½¿ç”¨æ—¶å€™çš„è¾“å…¥æ•ˆæœã€‚å°±åƒæˆ‘ä»¬åœ¨ä½¿ç”¨ Spring çš„æ—¶å€™ï¼Œè°è§„å®šç”¨æˆ·ä¸€å®šä¼šä½¿ç”¨æ™®é€šçš„ç±»å¯¹è±¡å‘¢ï¼Œåªè¦æ˜¯ Java çš„ JDK ä¸­èƒ½æä¾›çš„<code>éªšæ“ä½œ</code>å°±éƒ½æœ‰å¯èƒ½åœ¨ Spring æ¡†æ¶ä¸‹ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šMyBatis ç”¨äº†ä»£ç†ç±»ã€RPC é“¾æ¥äº†æ³¨å†Œä¸­å¿ƒã€åˆ†åº“åˆ†è¡¨åˆ‡æ¢äº†æ•°æ®æºï¼Œé‚£è¿™äº›å°±éƒ½éœ€è¦ Spring æ¥æ”¯æŒã€‚è€Œå¦‚æœä½ åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­æ²¡æœ‰è€ƒè™‘åˆ°è¿™äº›ï¼Œå¯èƒ½ä¹Ÿå°±å¿½ç•¥äº†æ­¤ç±»åŠŸèƒ½çš„å®ç°ï¼Œ<strong>è¿™å¥½äº†</strong>ï¼Œæµ‹è¯•é‚£ä¸Šæ‰‹è‚¯å®šå°±å‡º Bug äº†ï¼</p><h2 id="äºŒã€ç›®æ ‡" tabindex="-1"><a class="header-anchor" href="#äºŒã€ç›®æ ‡" aria-hidden="true">#</a> äºŒã€ç›®æ ‡</h2><p>å…¶å®æœ¬ç« èŠ‚è¦è§£å†³çš„é—®é¢˜å°±æ˜¯å…³äºå¦‚ä½•ç»™ä»£ç†å¯¹è±¡ä¸­çš„å±æ€§å¡«å……ç›¸åº”çš„å€¼ï¼Œå› ä¸ºåœ¨ä¹‹å‰æŠŠ<code>AOPåŠ¨æ€ä»£ç†ï¼Œèå…¥åˆ°Beançš„ç”Ÿå‘½å‘¨æœŸ</code>æ—¶ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡æ˜¯åœ¨æ•´ä¸ªåˆ›å»º Bean å¯¹è±¡ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªä»£ç†å¯¹è±¡çš„åˆ›å»ºå¹¶ä¸æ˜¯åœ¨ Bean ç”Ÿå‘½å‘¨æœŸä¸­ã€‚</p><p>æ‰€ä»¥æœ¬ç« èŠ‚ä¸­æˆ‘ä»¬è¦æŠŠä»£ç†å¯¹è±¡çš„åˆ›å»ºèå…¥åˆ° Bean çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æŠŠåˆ›å»ºä»£ç†å¯¹è±¡çš„é€»è¾‘è¿ç§»åˆ° Bean å¯¹è±¡æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ä¹‹åï¼Œåœ¨æ‰§è¡Œä»£ç†å¯¹è±¡çš„åˆ›å»ºã€‚</p><h2 id="ä¸‰ã€æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€æ–¹æ¡ˆ" aria-hidden="true">#</a> ä¸‰ã€æ–¹æ¡ˆ</h2><p>æŒ‰ç…§åˆ›å»ºä»£ç†å¯¹è±¡çš„æ“ä½œ <code>DefaultAdvisorAutoProxyCreator</code> å®ç°çš„ <code>InstantiationAwareBeanPostProcessor</code> æ¥å£ï¼Œé‚£ä¹ˆåŸæœ¬åœ¨ Before ä¸­çš„æ“ä½œï¼Œåˆ™éœ€è¦æ”¾åˆ° After ä¸­å¤„ç†ã€‚æ•´ä½“è®¾è®¡å¦‚ä¸‹ï¼š</p><p><img src="https://bugstack.cn/assets/images/spring/spring-16-01.png" alt=""></p><ul><li>åœ¨åˆ›å»º Bean å¯¹è±¡ <code>createBean</code> çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæœ‰ä¸€ä¸ªé˜¶æ®µæ˜¯åœ¨ Bean å¯¹è±¡å±æ€§å¡«å……å®Œæˆä»¥åï¼Œæ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†ï¼Œä¾‹å¦‚ï¼šæ„ŸçŸ¥ Aware å¯¹è±¡ã€å¤„ç† init-method æ–¹æ³•ç­‰ã€‚é‚£ä¹ˆåœ¨è¿™ä¸ªé˜¶æ®µçš„ <code>BeanPostProcessor After</code> å°±å¯ä»¥ç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡æ“ä½œã€‚</li><li>åœ¨ DefaultAdvisorAutoProxyCreator ç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡çš„æ“ä½œä¸­ï¼Œéœ€è¦æŠŠåˆ›å»ºæ“ä½œä» postProcessBeforeInstantiation æ–¹æ³•ä¸­è¿ç§»åˆ° postProcessAfterInitializationï¼Œè¿™æ ·æ‰èƒ½æ»¡è¶³ Bean å±æ€§å¡«å……åçš„åˆ›å»ºæ“ä½œã€‚</li></ul><h2 id="å››ã€å®ç°" tabindex="-1"><a class="header-anchor" href="#å››ã€å®ç°" aria-hidden="true">#</a> å››ã€å®ç°</h2><h3 id="_1-å·¥ç¨‹ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-å·¥ç¨‹ç»“æ„" aria-hidden="true">#</a> 1. å·¥ç¨‹ç»“æ„</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>small<span class="token operator">-</span>spring<span class="token operator">-</span>step<span class="token operator">-</span><span class="token number">15</span>
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework
    â”‚           â”œâ”€â”€ aop
    â”‚           â”‚   â”œâ”€â”€ aspectj
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">AspectJExpressionPointcut</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">AspectJExpressionPointcutAdvisor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ framework 
    â”‚           â”‚   â”‚   â”œâ”€â”€ adapter
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">MethodBeforeAdviceInterceptor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ autoproxy
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">MethodBeforeAdviceInterceptor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AopProxy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">Cglib2AopProxy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ProxyFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">AdvisedSupport</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">Advisor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">BeforeAdvice</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ClassFilter</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">MethodBeforeAdvice</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">Pointcut</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">PointcutAdvisor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">TargetSource</span><span class="token punctuation">.</span>java
    â”‚           â”œâ”€â”€ beans
    â”‚           â”‚   â”œâ”€â”€ factory  
    â”‚           â”‚   â”‚   â”œâ”€â”€ annotation
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">Autowired</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AutowiredAnnotationBeanPostProcessor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">Qualifier</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">Value</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ config
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanReference</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">SingletonBeanRegistry</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractBeanDefinitionReader</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanDefinitionReader</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">CglibSubclassingInstantiationStrategy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DefaultSingletonBeanRegistry</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">FactoryBeanRegistrySupport</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">InstantiationStrategy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">SimpleInstantiationStrategy</span><span class="token punctuation">.</span>java  
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">Aware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanClassLoaderAware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanFactoryAware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanNameAware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DisposableBean</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">FactoryBean</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">HierarchicalBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">InitializingBean</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ListableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">PropertyPlaceholderConfigurer</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">BeansException</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">PropertyValue</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">PropertyValues</span><span class="token punctuation">.</span>java 
    â”‚           â”œâ”€â”€ context
    â”‚           â”‚   â”œâ”€â”€ annotation
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ClassPathScanningCandidateComponentProvider</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">Scope</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ event
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractApplicationEventMulticaster</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContextEvent</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationEventMulticaster</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ContextClosedEvent</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ContextRefreshedEvent</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">SimpleApplicationEventMulticaster</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractRefreshableApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractXmlApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContextAwareProcessor</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContextAware</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationEvent</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationEventPublisher</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationListener</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span>java
    â”‚           â”œâ”€â”€ core<span class="token punctuation">.</span>io
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ClassPathResource</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">DefaultResourceLoader</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">FileSystemResource</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">Resource</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ResourceLoader</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">UrlResource</span><span class="token punctuation">.</span>java
    â”‚           â”œâ”€â”€ stereotype
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">Component</span><span class="token punctuation">.</span>java
    â”‚           â””â”€â”€ utils
    â”‚               â”œâ”€â”€ <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span>java
    â”‚               â””â”€â”€ <span class="token class-name">StringValueResolver</span><span class="token punctuation">.</span>java
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test
                â”œâ”€â”€ bean
                â”‚   â”œâ”€â”€ <span class="token class-name">IUserService</span><span class="token punctuation">.</span>java
                â”‚   â””â”€â”€ <span class="token class-name">UserService</span><span class="token punctuation">.</span>java
                â””â”€â”€ <span class="token class-name">ApiTest</span><span class="token punctuation">.</span>java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å·¥ç¨‹æºç </strong>ï¼š<code>å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šSpring ä¸“æ ï¼Œè·å–å®Œæ•´æºç </code></p><p>åœ¨Beançš„ç”Ÿå‘½å‘¨æœŸä¸­åˆ›å»ºä»£ç†å¯¹è±¡çš„ç±»å…³ç³»ï¼Œå¦‚å›¾ 16-2</p><p><img src="https://bugstack.cn/assets/images/spring/spring-16-02.png" alt="å›¾ 16-2"></p><ul><li>è™½ç„¶æœ¬ç« èŠ‚è¦å®Œæˆçš„æ˜¯å…³äºä»£ç†å¯¹è±¡ä¸­å±æ€§çš„å¡«å……é—®é¢˜ï¼Œä½†å®é™…è§£å†³çš„æ€è·¯æ˜¯å¤„ç†åœ¨ Bean çš„ç”Ÿå‘½å‘¨æœŸä¸­åˆé€‚çš„ä½ç½®ï¼ˆ<code>åˆå§‹åŒ– initializeBean</code>ï¼‰ä¸­å¤„ç†ä»£ç†ç±»çš„åˆ›å»ºã€‚</li><li>æ‰€ä»¥ä»¥ä¸Šçš„æ”¹åŠ¨å¹¶ä¸ä¼šæ¶‰åŠå¤ªå¤šå†…å®¹ï¼Œä¸»è¦åŒ…æ‹¬ï¼šDefaultAdvisorAutoProxyCreator ç±»åˆ›å»ºä»£ç†å¯¹è±¡çš„æ“ä½œæ”¾ç½®åœ¨ postProcessAfterInitialization æ–¹æ³•ä¸­ä»¥åŠå¯¹åº”åœ¨ AbstractAutowireCapableBeanFactory å®Œæˆåˆå§‹åŒ–æ–¹æ³•çš„è°ƒç”¨æ“ä½œã€‚</li><li>å¦å¤–è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå°±æ˜¯ç›®å‰æˆ‘ä»¬åœ¨ Spring æ¡†æ¶ä¸­ï¼ŒAbstractAutowireCapableBeanFactory ç±»é‡Œä½¿ç”¨çš„æ˜¯ CglibSubclassingInstantiationStrategy åˆ›å»ºå¯¹è±¡ï¼Œæ‰€ä»¥æœ‰éœ€è¦åˆ¤æ–­å¯¹è±¡è·å–æ¥å£çš„æ–¹æ³•ä¸­ï¼Œä¹Ÿéƒ½éœ€è¦åˆ¤æ–­æ˜¯å¦ä¸º CGlibåˆ›å»ºï¼Œå¦åˆ™æ˜¯ä¸èƒ½æ­£ç¡®è·å–åˆ°æ¥å£çš„ã€‚å¦‚ï¼š<code>ClassUtils.isCglibProxyClass(clazz) ? clazz.getSuperclass() : clazz;</code></li></ul><h3 id="_2-åˆ¤æ–­cglibå¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_2-åˆ¤æ–­cglibå¯¹è±¡" aria-hidden="true">#</a> 2. åˆ¤æ–­CGlibå¯¹è±¡</h3><p><strong>cn.bugstack.springframework.aop.TargetSource</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TargetSource</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> target<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Return the type of targets returned by this <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TargetSource</span></span><span class="token punctuation">}</span>.
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Can return <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token keyword">null</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>, although certain usages of a
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token class-name">TargetSource</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span> might just work with a predetermined
     * target class.
     *
     * <span class="token keyword">@return</span> the type of targets returned by this <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TargetSource</span></span><span class="token punctuation">}</span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clazz <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isCglibProxyClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">?</span> clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> clazz<span class="token punctuation">;</span>
        <span class="token keyword">return</span> clazz<span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨ TargetSource#getTargetClass æ˜¯ç”¨äºè·å– target å¯¹è±¡çš„æ¥å£ä¿¡æ¯çš„ï¼Œé‚£ä¹ˆè¿™ä¸ª target å¯èƒ½æ˜¯ <code>JDKä»£ç†</code> åˆ›å»ºä¹Ÿå¯èƒ½æ˜¯ <code>CGlibåˆ›å»º</code>ï¼Œä¸ºäº†ä¿è¯éƒ½èƒ½æ­£ç¡®çš„è·å–åˆ°ç»“æœï¼Œè¿™é‡Œéœ€è¦å¢åŠ åˆ¤è¯» <code>ClassUtils.isCglibProxyClass(clazz)</code></li></ul><h3 id="_3-è¿ç§»åˆ›å»ºaopä»£ç†æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_3-è¿ç§»åˆ›å»ºaopä»£ç†æ–¹æ³•" aria-hidden="true">#</a> 3. è¿ç§»åˆ›å»ºAOPä»£ç†æ–¹æ³•</h3><p><strong>cn.bugstack.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultAdvisorAutoProxyCreator</span> <span class="token keyword">implements</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">,</span> <span class="token class-name">BeanFactoryAware</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">DefaultListableBeanFactory</span> beanFactory<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> bean<span class="token punctuation">;</span>

        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AspectJExpressionPointcutAdvisor</span><span class="token punctuation">&gt;</span></span> advisors <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">AspectJExpressionPointcutAdvisor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AspectJExpressionPointcutAdvisor</span> advisor <span class="token operator">:</span> advisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ClassFilter</span> classFilter <span class="token operator">=</span> advisor<span class="token punctuation">.</span><span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è¿‡æ»¤åŒ¹é…ç±»</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>classFilter<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token class-name">AdvisedSupport</span> advisedSupport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AdvisedSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">TargetSource</span> targetSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
            advisedSupport<span class="token punctuation">.</span><span class="token function">setTargetSource</span><span class="token punctuation">(</span>targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            advisedSupport<span class="token punctuation">.</span><span class="token function">setMethodInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">)</span> advisor<span class="token punctuation">.</span><span class="token function">getAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            advisedSupport<span class="token punctuation">.</span><span class="token function">setMethodMatcher</span><span class="token punctuation">(</span>advisor<span class="token punctuation">.</span><span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            advisedSupport<span class="token punctuation">.</span><span class="token function">setProxyTargetClass</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// è¿”å›ä»£ç†å¯¹è±¡</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span>advisedSupport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å…³äº DefaultAdvisorAutoProxyCreator ç±»çš„æ“ä½œä¸»è¦å°±æ˜¯æŠŠåˆ›å»º AOP ä»£ç†çš„æ“ä½œä» postProcessBeforeInstantiation ç§»åŠ¨åˆ° postProcessAfterInitialization ä¸­å»ã€‚</li><li>é€šè¿‡è®¾ç½®ä¸€äº› AOP çš„å¿…å¤‡å‚æ•°åï¼Œè¿”å›ä»£ç†å¯¹è±¡ <code>new ProxyFactory(advisedSupport).getProxy()</code> è¿™ä¸ªä»£ç†å¯¹è±¡ä¸­å°±åŒ…æ‹¬é—´æ¥è°ƒç”¨äº† TargetSource ä¸­å¯¹ getTargetClass() çš„è·å–ã€‚</li></ul><h3 id="_4-åœ¨beançš„ç”Ÿå‘½å‘¨æœŸä¸­åˆå§‹åŒ–æ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#_4-åœ¨beançš„ç”Ÿå‘½å‘¨æœŸä¸­åˆå§‹åŒ–æ‰§è¡Œ" aria-hidden="true">#</a> 4. åœ¨Beançš„ç”Ÿå‘½å‘¨æœŸä¸­åˆå§‹åŒ–æ‰§è¡Œ</h3><p><strong>cn.bugstack.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractAutowireCapableBeanFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBeanFactory</span> <span class="token keyword">implements</span> <span class="token class-name">AutowireCapableBeanFactory</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">InstantiationStrategy</span> instantiationStrategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CglibSubclassingInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>

            <span class="token comment">// æ‰§è¡Œ Bean çš„åˆå§‹åŒ–æ–¹æ³•å’Œ BeanPostProcessor çš„å‰ç½®å’Œåç½®å¤„ç†æ–¹æ³•</span>
            bean <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeansException</span><span class="token punctuation">(</span><span class="token string">&quot;Instantiation of bean failed&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// ...</span>

        wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> wrappedBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> existingBean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> result <span class="token operator">=</span> existingBean<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> processor <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> current <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            result <span class="token operator">=</span> current<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨ AbstractAutowireCapableBeanFactory#createBean æ–¹æ³•ä¸­ï¼Œå…¶å®å…³æ³¨ç‚¹å°±åœ¨äº initializeBean -&gt; applyBeanPostProcessorsAfterInitialization è¿™ä¸€å—é€»è¾‘çš„è°ƒç”¨ï¼Œæœ€ç»ˆå®Œæˆ AOP ä»£ç†å¯¹è±¡çš„åˆ›å»ºæ“ä½œã€‚</li></ul><h2 id="äº”ã€æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#äº”ã€æµ‹è¯•" aria-hidden="true">#</a> äº”ã€æµ‹è¯•</h2><h3 id="_1-äº‹å…ˆå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#_1-äº‹å…ˆå‡†å¤‡" aria-hidden="true">#</a> 1. äº‹å…ˆå‡†å¤‡</h3><p><strong>UserService æ·»åŠ å±æ€§å­—æ®µ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">implements</span> <span class="token class-name">IUserService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> token<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;å°å‚…å“¥ï¼Œ100001ï¼Œæ·±åœ³ï¼Œ&quot;</span> <span class="token operator">+</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>token æ˜¯åœ¨ UserService ä¸­æ–°å¢çš„å±æ€§ä¿¡æ¯ï¼Œç”¨äºæµ‹è¯•ä»£ç†å¯¹è±¡çš„å±æ€§å¡«å……æ“ä½œã€‚</li></ul><h3 id="_2-å±æ€§é…ç½®æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#_2-å±æ€§é…ç½®æ–‡ä»¶" aria-hidden="true">#</a> 2. å±æ€§é…ç½®æ–‡ä»¶</h3><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans
	         http://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cn.bugstack.springframework.test.bean.UserService<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>token<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>RejDlI78hu223Opo983Ds<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cn.bugstack.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beforeAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cn.bugstack.springframework.test.bean.UserServiceBeforeAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>methodInterceptor<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cn.bugstack.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>advice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beforeAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pointcutAdvisor<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cn.bugstack.springframework.aop.aspectj.AspectJExpressionPointcutAdvisor<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>expression<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* cn.bugstack.springframework.test.bean.IUserService.*(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>advice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>methodInterceptor<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä¸æˆ‘ä»¬å¯¹ AOP çš„æµ‹è¯•æ¥è¯´ï¼Œå”¯ä¸€æ–°å¢åŠ çš„å°±æ˜¯ property çš„é…ç½®ï¼š<code>&lt;property name=&quot;token&quot; value=&quot;RejDlI78hu223Opo983Ds&quot;/&gt;</code></li></ul><h3 id="_3-å•å…ƒæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_3-å•å…ƒæµ‹è¯•" aria-hidden="true">#</a> 3. å•å…ƒæµ‹è¯•</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_autoProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ClassPathXmlApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:spring.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IUserService</span> userService <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">,</span> <span class="token class-name">IUserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š&quot;</span> <span class="token operator">+</span> userService<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://bugstack.cn/assets/images/spring/spring-16-03.png" alt=""></p><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>æ‹¦æˆªæ–¹æ³•ï¼šqueryUserInfo
æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œ<span class="token number">100001</span>ï¼Œæ·±åœ³ï¼Œ<span class="token class-name">RejDlI78hu223Opo983Ds</span>

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡å¯¹ Bean ç”Ÿå‘½å‘¨æœŸçš„è°ƒæ•´ï¼Œåœ¨åˆ›å»º AOP ä»£ç†å¯¹è±¡å°±å¯ä»¥æŠŠä»£ç†å¯¹è±¡çš„å±æ€§ä¿¡æ¯å¡«å……è¿›å»äº†ã€‚</li><li>å¦å¤–è¿™é‡Œè¿˜æœ‰ä¸€å—æ˜¯å…³äºåœ¨ TargetSource#getTargetClass ä¸­å…³äºæ˜¯å¦ä¸º CGlib çš„æ–¹æ³•åˆ¤æ–­ï¼Œåªæœ‰è¿™æ ·æ“ä½œæ‰å¯ä»¥è·å–åˆ°äº‰å–çš„ç±»ä¿¡æ¯ã€‚</li></ul><h2 id="å…­ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å…­ã€æ€»ç»“" aria-hidden="true">#</a> å…­ã€æ€»ç»“</h2><ul><li>æœ¬ç« èŠ‚çš„æ ¸å¿ƒçŸ¥è¯†å†…å®¹ä¸»è¦æ˜¯å®Œå–„äº† Bean çš„ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨åˆ›å»ºç±»çš„æ“ä½œä¸­å®Œæˆä»£ç†å¯¹è±¡çš„åˆ›å»ºï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼å°±å¯ä»¥è®©ä»£ç†å¯¹è±¡ä¸­çš„å±æ€§ä¹Ÿå¯ä»¥éšç€åˆ›å»ºè¿‡ç¨‹è¢«å¡«å……è¿›å»ã€‚</li><li>é™¤äº†æ ¸å¿ƒåŠŸèƒ½çš„å®ç°å¤–ä¹Ÿè¦å…³æ³¨åˆ°å¯¹è±¡çš„åˆå§‹åŒ–æ“ä½œæ˜¯ CglibSubclassingInstantiationStrategyã€SimpleInstantiationStrategyï¼Œè¿™ä¸¤ç§æ–¹å¼ä¸­çš„ CGlib åˆ›å»ºå¯¹è±¡ï¼Œä¼šå½±å“åˆ°å¾ˆå¤šåœ°æ–¹ç”¨äºæ¥å£è·å–çš„æ“ä½œï¼Œå› ä¸º CGlib åˆ›å»ºå¯¹è±¡èµ°çš„æ˜¯ ASM å­—èŠ‚ç ç”Ÿæˆçš„æ“ä½œï¼Œæ‰€ä»¥å’Œæ™®é€šçš„ JDK ä»£ç†ç”Ÿæˆå¯¹è±¡æ˜¯ä¸ä¸€æ ·ï¼Œéœ€è¦æ³¨æ„ã€‚</li><li>ç¨‹åºçš„Bugå¾€å¾€æ˜¯å¯¹éœ€æ±‚çš„ä½¿ç”¨åœºæ™¯ç†è§£ä¸è¶³ï¼ŒåŠŸèƒ½çš„å®Œå–„æ˜¯å¯¹ä¸€ä¸ªç»†åŒ–åœºæ™¯çš„ç¨‹åºç²¾é›•ï¼Œå¼€å‘ç¨‹åºçš„è¿‡ç¨‹è¿œè¿œä¸åªæ˜¯å†™ä»£ç é‚£ä¹ˆå›äº‹ï¼Œæ›´é‡è¦çš„æ˜¯æ€è€ƒ<code>è¿™æ˜¯ä»€ä¹ˆåœºæ™¯</code>ã€<code>é‡åˆ°äº†å“ªäº›é—®é¢˜</code>ã€<code>è¦æ€ä¹ˆè§£å†³</code>ã€<code>å¯ä»¥å­¦åˆ°ä»€ä¹ˆ</code>ä¸­ä¸æ–­çš„é”¤ç‚¼è‡ªå·±çš„ç¨‹åºé€»è¾‘ã€‚</li></ul>`,46);function A(x,B){const a=p("ExternalLinkIcon");return c(),o("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),r,s("åšå®¢ï¼š"),n("a",k,[s("https://bugstack.cn"),t(a)]),d,s("æ˜Ÿçƒï¼š"),n("a",v,[s("https://articles.zsxq.com/id_w629m13v0hni.html"),t(a)])]),m,b,n("ul",null,[n("li",null,[n("a",g,[s("è°ƒæ•´ AOP ä»£ç†å¯¹è±¡ç”Ÿæˆçš„æ—¶æœº å®ç°å…¶å±æ€§æ³¨å…¥ @Rechie"),t(a)])]),n("li",null,[n("a",h,[s("è§£å†³ä»£ç†å¯¹è±¡çš„å±æ€§æ³¨å…¥ï¼ŒæŠŠä»£ç†å¯¹è±¡åŠ å…¥ç”Ÿå‘½å‘¨æœŸ @Chin"),t(a)])]),n("li",null,[n("a",f,[s("ç»™ä»£ç†å¯¹è±¡çš„å±æ€§è®¾ç½®å€¼ @liuc"),t(a)])]),n("li",null,[n("a",y,[s("MyBatis å°±æ˜¯ä¸»è¦ä½¿ç”¨ä»£ç†ç±»ï¼Œå› æ­¤ Spring å°±éœ€è¦æ”¯æŒä»£ç†ç±»çš„åˆå§‹åŒ–ã€‚@æ°´ä¸­ææœˆ"),t(a)])]),n("li",null,[n("a",w,[s("è°ƒæ•´AOPä»£ç†å¯¹è±¡çš„ç»“æ„ï¼Œä½¿ä¹‹å¯ä»¥è¢«æ³¨å…¥å±æ€§ @åœ¨ä¹æœˆ"),t(a)])])]),j])}const q=e(i,[["render",A],["__file","2021-08-05-di16zhangï¼šzhanwubushengï¼Œgeidailiduixiangdeshuxingshezhizhi.html.vue"]]);export{q as default};
