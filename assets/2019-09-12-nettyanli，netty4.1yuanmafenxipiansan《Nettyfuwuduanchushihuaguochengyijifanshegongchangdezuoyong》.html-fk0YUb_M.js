import{_ as t,r as p,o as e,c as o,a as n,b as s,d as c,e as l}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"nettyæ¡ˆä¾‹-netty4-1æºç åˆ†æç¯‡ä¸‰ã€ŠnettyæœåŠ¡ç«¯åˆå§‹åŒ–è¿‡ç¨‹ä»¥åŠåå°„å·¥å‚çš„ä½œç”¨ã€‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#nettyæ¡ˆä¾‹-netty4-1æºç åˆ†æç¯‡ä¸‰ã€ŠnettyæœåŠ¡ç«¯åˆå§‹åŒ–è¿‡ç¨‹ä»¥åŠåå°„å·¥å‚çš„ä½œç”¨ã€‹","aria-hidden":"true"},"#"),s(" nettyæ¡ˆä¾‹ï¼Œnetty4.1æºç åˆ†æç¯‡ä¸‰ã€ŠNettyæœåŠ¡ç«¯åˆå§‹åŒ–è¿‡ç¨‹ä»¥åŠåå°„å·¥å‚çš„ä½œç”¨ã€‹")],-1),k=n("br",null,null,-1),r={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=l(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><p>æœ¬ç« èŠ‚ä¸»è¦åˆ†æNettyåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­çš„é…ç½®å†…å®¹ä»¥åŠæœ€ç»ˆè°ƒç”¨bindæ–¹æ³•æ˜¯å¦‚ä½•å¯åŠ¨NettyæœåŠ¡ç«¯çš„ã€‚</p><blockquote><p>NettyæœåŠ¡å¯åŠ¨æ¨¡æ¿ä»£ç </p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">bing</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//é…ç½®æœåŠ¡ç«¯NIOçº¿ç¨‹ç»„</span>
	<span class="token class-name">EventLoopGroup</span> parentGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//NioEventLoopGroup extends MultithreadEventLoopGroup Math.max(1, SystemPropertyUtil.getInt(&quot;io.netty.eventLoopThreads&quot;, NettyRuntime.availableProcessors() * 2));</span>
	<span class="token class-name">EventLoopGroup</span> childGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token class-name">ServerBootstrap</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		b<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>parentGroup<span class="token punctuation">,</span> childGroup<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>    <span class="token comment">//éé˜»å¡æ¨¡å¼</span>
				<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token punctuation">.</span><span class="token constant">SO_BACKLOG</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyChannelInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ChannelFuture</span> f <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;itstack-demo-netty server start done. {å…³æ³¨å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆï¼Œè·å–æºç }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		f<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
		childGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		parentGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>** ServerBootstrap **</p><ul><li>è®¾å®šç›¸å…³å±æ€§çš„æœåŠ¡ç±»</li><li>å®ç°äº†AbstractBootstrapæ–¹æ³•ï¼Œé‡Œé¢çš„æ³›å‹ServerChannelæ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œä¸åšå®é™…æ–¹æ³•</li><li>ServerSocketChannelæä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼›é…ç½®ã€æœ¬åœ°åœ°å€ã€è¿œç¨‹åœ°å€ï¼Œç”¨äºæ¥æ”¶å¤„ç†TCP/IPè¿æ¥</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServerSocketChannel</span> <span class="token keyword">extends</span> <span class="token class-name">ServerChannel</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token class-name">ServerSocketChannelConfig</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token class-name">InetSocketAddress</span> <span class="token function">localAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token class-name">InetSocketAddress</span> <span class="token function">remoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨Nettyå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«é€šè¿‡è°ƒç”¨.groupã€.channelã€.optionã€.childHandleræ¥é…ç½®æœåŠ¡ç«¯ä¿¡æ¯ï¼Œæœ€åè°ƒç”¨.bind()æ¥å¯åŠ¨æœåŠ¡ã€‚</p><blockquote><p>.group | ç”¨äºå¤„ç†äº‹ä»¶å¾ªç¯ç»„çš„æ–¹æ³•</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ServerBootstrap</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token class-name">EventLoopGroup</span> parentGroup<span class="token punctuation">,</span> <span class="token class-name">EventLoopGroup</span> childGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>parentGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>childGroup <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;childGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;childGroup set already&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>childGroup <span class="token operator">=</span> childGroup<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>groupæ–¹æ³•é€šè¿‡ä¸ºparentGroupã€childGroupè®¾ç½®äº‹ä»¶å¾ªç¯ç»„ï¼ˆEventLoopGroupï¼‰ï¼Œç”¨äºå¤„ç†äº‹ä»¶å†…å®¹ä¸IOè¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç”¨äºç­‰å¾…æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ä¸ä¿¡æ¯å†…å®¹äº¤äº’ã€‚</p><blockquote><p>.channel | é€šè¿‡åå°„æ–¹å¼åˆ›å»ºé€šä¿¡é€šé“çš„æ–¹æ³•</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">B</span> <span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">C</span><span class="token punctuation">&gt;</span></span> channelClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>channelClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;channelClass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">channelFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReflectiveChannelFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">C</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>channelClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ReflectiveChannelFactoryåå°„å·¥å‚ç±»é€šè¿‡æ„é€ å‡½æ•°ï¼Œä¼ é€’channelClassè¿™ä¸ªå‚æ•°ï¼Œæ¥å®ä¾‹åŒ–åå°„å·¥å‚ã€‚è¿™ä¸ªchannelClassç±»ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨é…ç½®ä¸­ä¼ é€’çš„å¼‚æ­¥NIOæµçš„æœåŠ¡ç«¯Socketç®¡é“ï¼ŒNioServerSocketChannelã€‚æœ€åå°†å·¥å‚ä¿¡æ¯ä¼ é€’åˆ°channelä¸­ï¼Œç”¨äºåç»­å®ä¾‹åŒ–æ— å‚çš„æ„é€ å‡½æ•°ï¼Œå¹¶åœ¨åç»­æä¾›è°ƒç”¨NioServerSocketChannelæ–¹æ³•çš„èƒ½åŠ›ã€‚</p><p>ReflectiveChannelFactoryç±»ä¸­ä»…æ˜¯æä¾›äº†ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ³•ï¼Œç”¨äºè·å–å®ä¾‹åŒ–ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">newChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to create Channel from class &quot;</span> <span class="token operator">+</span> constructor<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>.option | æ˜¯ä¸€ä¸ªé€‰é¡¹é…ç½®ç±»ï¼Œå¯ä»¥å¢åŠ ä¸€äº›é…ç½®å‚æ•°</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">B</span> <span class="token function">option</span><span class="token punctuation">(</span><span class="token class-name">ChannelOption</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> option<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>option <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;option&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            options<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            options<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>option<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>optionæ˜¯Nettyä¸ºæˆ‘ä»¬æä¾›çš„é…ç½®é€‰é¡¹ï¼Œå®ƒåŒ…å«ä½†ä¸é™äºï¼›ChannelOption.SO_BACKLOGã€ChannelOption.SO_TIMEOUTã€ChannelOption.TCP_NODELAYç­‰ï¼Œoptionå¹¶ä¸æ˜¯éçš„é…ç½®ï¼Œå¦‚æœä¸é…ç½®ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸å¯åŠ¨çš„ã€‚</p><hr><p>1ã€ChannelOption.SO_BACKLOG ChannelOption.SO_BACKLOGå¯¹åº”çš„æ˜¯tcp/ipåè®®listenå‡½æ•°ä¸­çš„backlogå‚æ•°ï¼Œå‡½æ•°listen(int socketfd,int backlog)ç”¨æ¥åˆå§‹åŒ–æœåŠ¡ç«¯å¯è¿æ¥é˜Ÿåˆ—ï¼ŒæœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ˜¯é¡ºåºå¤„ç†çš„ï¼Œæ‰€ä»¥åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œå¤šä¸ªå®¢æˆ·ç«¯æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯å°†ä¸èƒ½å¤„ç†çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ”¾åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†ï¼Œbacklogå‚æ•°æŒ‡å®šäº†é˜Ÿåˆ—çš„å¤§å°</p><p>2ã€ChannelOption.SO_REUSEADDR ChanneOption.SO_REUSEADDRå¯¹åº”äºå¥—æ¥å­—é€‰é¡¹ä¸­çš„SO_REUSEADDRï¼Œè¿™ä¸ªå‚æ•°è¡¨ç¤ºå…è®¸é‡å¤ä½¿ç”¨æœ¬åœ°åœ°å€å’Œç«¯å£ï¼Œ æ¯”å¦‚ï¼ŒæŸä¸ªæœåŠ¡å™¨è¿›ç¨‹å ç”¨äº†TCPçš„80ç«¯å£è¿›è¡Œç›‘å¬ï¼Œæ­¤æ—¶å†æ¬¡ç›‘å¬è¯¥ç«¯å£å°±ä¼šè¿”å›é”™è¯¯ï¼Œä½¿ç”¨è¯¥å‚æ•°å°±å¯ä»¥è§£å†³é—®é¢˜ï¼Œè¯¥å‚æ•°å…è®¸å…±ç”¨è¯¥ç«¯å£ï¼Œè¿™ä¸ªåœ¨æœåŠ¡å™¨ç¨‹åºä¸­æ¯”è¾ƒå¸¸ä½¿ç”¨ï¼Œ æ¯”å¦‚æŸä¸ªè¿›ç¨‹éæ­£å¸¸é€€å‡ºï¼Œè¯¥ç¨‹åºå ç”¨çš„ç«¯å£å¯èƒ½è¦è¢«å ç”¨ä¸€æ®µæ—¶é—´æ‰èƒ½å…è®¸å…¶ä»–è¿›ç¨‹ä½¿ç”¨ï¼Œè€Œä¸”ç¨‹åºæ­»æ‰ä»¥åï¼Œå†…æ ¸ä¸€éœ€è¦ä¸€å®šçš„æ—¶é—´æ‰èƒ½å¤Ÿé‡Šæ”¾æ­¤ç«¯å£ï¼Œä¸è®¾ç½®SO_REUSEADDRå°±æ— æ³•æ­£å¸¸ä½¿ç”¨è¯¥ç«¯å£ã€‚</p><p>3ã€ChannelOption.SO_KEEPALIVE Channeloption.SO_KEEPALIVEå‚æ•°å¯¹åº”äºå¥—æ¥å­—é€‰é¡¹ä¸­çš„SO_KEEPALIVEï¼Œè¯¥å‚æ•°ç”¨äºè®¾ç½®TCPè¿æ¥ï¼Œå½“è®¾ç½®è¯¥é€‰é¡¹ä»¥åï¼Œè¿æ¥ä¼šæµ‹è¯•é“¾æ¥çš„çŠ¶æ€ï¼Œè¿™ä¸ªé€‰é¡¹ç”¨äºå¯èƒ½é•¿æ—¶é—´æ²¡æœ‰æ•°æ®äº¤æµçš„è¿æ¥ã€‚å½“è®¾ç½®è¯¥é€‰é¡¹ä»¥åï¼Œå¦‚æœåœ¨ä¸¤å°æ—¶å†…æ²¡æœ‰æ•°æ®çš„é€šä¿¡æ—¶ï¼ŒTCPä¼šè‡ªåŠ¨å‘é€ä¸€ä¸ªæ´»åŠ¨æ¢æµ‹æ•°æ®æŠ¥æ–‡ã€‚</p><p>4ã€ChannelOption.SO_SNDBUFå’ŒChannelOption.SO_RCVBUF ChannelOption.SO_SNDBUFå‚æ•°å¯¹åº”äºå¥—æ¥å­—é€‰é¡¹ä¸­çš„SO_SNDBUFï¼ŒChannelOption.SO_RCVBUFå‚æ•°å¯¹åº”äºå¥—æ¥å­—é€‰é¡¹ä¸­çš„SO_RCVBUFè¿™ä¸¤ä¸ªå‚æ•°ç”¨äºæ“ä½œæ¥æ”¶ç¼“å†²åŒºå’Œå‘é€ç¼“å†²åŒºçš„å¤§å°ï¼Œæ¥æ”¶ç¼“å†²åŒºç”¨äºä¿å­˜ç½‘ç»œåè®®ç«™å†…æ”¶åˆ°çš„æ•°æ®ï¼Œç›´åˆ°åº”ç”¨ç¨‹åºè¯»å–æˆåŠŸï¼Œå‘é€ç¼“å†²åŒºç”¨äºä¿å­˜å‘é€æ•°æ®ï¼Œç›´åˆ°å‘é€æˆåŠŸã€‚</p><p>5ã€ChannelOption.SO_LINGER ChannelOption.SO_LINGERå‚æ•°å¯¹åº”äºå¥—æ¥å­—é€‰é¡¹ä¸­çš„SO_LINGER,Linuxå†…æ ¸é»˜è®¤çš„å¤„ç†æ–¹å¼æ˜¯å½“ç”¨æˆ·è°ƒç”¨closeï¼ˆï¼‰æ–¹æ³•çš„æ—¶å€™ï¼Œå‡½æ•°è¿”å›ï¼Œåœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œå°½é‡å‘é€æ•°æ®ï¼Œä¸ä¸€å®šä¿è¯ä¼šå‘ç”Ÿå‰©ä½™çš„æ•°æ®ï¼Œé€ æˆäº†æ•°æ®çš„ä¸ç¡®å®šæ€§ï¼Œä½¿ç”¨SO_LINGERå¯ä»¥é˜»å¡close()çš„è°ƒç”¨æ—¶é—´ï¼Œç›´åˆ°æ•°æ®å®Œå…¨å‘é€</p><p>6ã€ChannelOption.TCP_NODELAY ChannelOption.TCP_NODELAYå‚æ•°å¯¹åº”äºå¥—æ¥å­—é€‰é¡¹ä¸­çš„TCP_NODELAY,è¯¥å‚æ•°çš„ä½¿ç”¨ä¸Nagleç®—æ³•æœ‰å…³,Nagleç®—æ³•æ˜¯å°†å°çš„æ•°æ®åŒ…ç»„è£…ä¸ºæ›´å¤§çš„å¸§ç„¶åè¿›è¡Œå‘é€ï¼Œè€Œä¸æ˜¯è¾“å…¥ä¸€æ¬¡å‘é€ä¸€æ¬¡,å› æ­¤åœ¨æ•°æ®åŒ…ä¸è¶³çš„æ—¶å€™ä¼šç­‰å¾…å…¶ä»–æ•°æ®çš„åˆ°äº†ï¼Œç»„è£…æˆå¤§çš„æ•°æ®åŒ…è¿›è¡Œå‘é€ï¼Œè™½ç„¶è¯¥æ–¹å¼æœ‰æ•ˆæé«˜ç½‘ç»œçš„æœ‰æ•ˆè´Ÿè½½ï¼Œä½†æ˜¯å´é€ æˆäº†å»¶æ—¶ï¼Œè€Œè¯¥å‚æ•°çš„ä½œç”¨å°±æ˜¯ç¦æ­¢ä½¿ç”¨Nagleç®—æ³•ï¼Œä½¿ç”¨äºå°æ•°æ®å³æ—¶ä¼ è¾“ï¼ŒäºTCP_NODELAYç›¸å¯¹åº”çš„æ˜¯TCP_CORKï¼Œè¯¥é€‰é¡¹æ˜¯éœ€è¦ç­‰åˆ°å‘é€çš„æ•°æ®é‡æœ€å¤§çš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§å‘é€æ•°æ®ï¼Œé€‚ç”¨äºæ–‡ä»¶ä¼ è¾“ã€‚</p><p>7ã€IP_TOS IPå‚æ•°ï¼Œè®¾ç½®IPå¤´éƒ¨çš„Type-of-Serviceå­—æ®µï¼Œç”¨äºæè¿°IPåŒ…çš„ä¼˜å…ˆçº§å’ŒQoSé€‰é¡¹ã€‚</p><p>8ã€ALLOW_HALF_CLOSURE Nettyå‚æ•°ï¼Œä¸€ä¸ªè¿æ¥çš„è¿œç«¯å…³é—­æ—¶æœ¬åœ°ç«¯æ˜¯å¦å…³é—­ï¼Œé»˜è®¤å€¼ä¸ºFalseã€‚å€¼ä¸ºFalseæ—¶ï¼Œè¿æ¥è‡ªåŠ¨å…³é—­ï¼›ä¸ºTrueæ—¶ï¼Œè§¦å‘ChannelInboundHandlerçš„userEventTriggered()æ–¹æ³•ï¼Œäº‹ä»¶ä¸ºChannelInputShutdownEventã€‚</p><hr><blockquote><p>.childHandler | è®¾ç½®è‡ªå·±çš„ç®¡é“æœåŠ¡ï¼Œæ¥æ”¶ä¿¡æ¯å¤„ç† ï¼ˆå¦å¤–è¿˜æœ‰ä¸€ä¸ªhandleræ–¹æ³•æ˜¯è¢«parentGroupæ‰€ä½¿ç”¨ï¼‰</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ServerBootstrap</span> <span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span> childHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>childHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;childHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>childHandler <span class="token operator">=</span> childHandler<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>** ä»¥ä¸Šä¿¡æ¯é…ç½®å®Œæˆåï¼Œæˆ‘ä»¬çš„æœåŠ¡ç«¯é€šè¿‡è°ƒç”¨bind()æ–¹æ³•æ¥å¯åŠ¨æœåŠ¡ç«¯ **</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>b<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ChannelFuture</span> <span class="token function">doBind</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">final</span> <span class="token class-name">ChannelFuture</span> regFuture <span class="token operator">=</span> <span class="token function">initAndRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">final</span> <span class="token class-name">Channel</span> channel <span class="token operator">=</span> regFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> regFuture<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>regFuture<span class="token punctuation">.</span><span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// At this point we know that the registration was complete and successful.</span>
		<span class="token class-name">ChannelPromise</span> promise <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">newPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> promise<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// Registration future is almost always fulfilled already, but just in case it&#39;s not.</span>
		<span class="token keyword">final</span> <span class="token class-name">PendingRegistrationPromise</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingRegistrationPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
		regFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
				<span class="token class-name">Throwable</span> cause <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an</span>
					<span class="token comment">// IllegalStateException once we try to access the EventLoop of the Channel.</span>
					promise<span class="token punctuation">.</span><span class="token function">setFailure</span><span class="token punctuation">(</span>cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token comment">// Registration was successful, so set the correct executor to use.</span>
					<span class="token comment">// See https://github.com/netty/netty/issues/2586</span>
					promise<span class="token punctuation">.</span><span class="token function">registered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token function">doBind0</span><span class="token punctuation">(</span>regFuture<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> localAddress<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> promise<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œé¢çš„ç¬¬ä¸€è¡Œä»£ç initAndRegisterï¼Œé‡Œé¢é€šè¿‡åå°„å·¥å‚ä½¿ç”¨äº†æˆ‘ä»¬çš„é…ç½®çš„NioServerSocketChannel.classï¼Œæ¥å®ä¾‹åŒ–NioServerSocketChannelã€‚å®ä¾‹åŒ–åNioServerSocketChannelä¼šéšä¹‹å¯åŠ¨NettyæœåŠ¡ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ServerSocketChannel</span> <span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token class-name">SelectorProvider</span> provider<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token doc-comment comment">/**
		 *  Use the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SelectorProvider</span></span><span class="token punctuation">}</span> to open <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SocketChannel</span></span><span class="token punctuation">}</span> and so remove condition in
		 *  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SelectorProvider</span><span class="token punctuation">#</span><span class="token function">provider</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> which is called by each ServerSocketChannel.open() otherwise.
		 *
		 *  See <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://github.com/netty/netty/issues/2308<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>#2308<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>.
		 */</span>
		<span class="token keyword">return</span> provider<span class="token punctuation">.</span><span class="token function">openServerSocketChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChannelException</span><span class="token punctuation">(</span>
				<span class="token string">&quot;Failed to open a server socket.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ServerSocketChannelImpl</span><span class="token punctuation">(</span><span class="token class-name">SelectorProvider</span> sp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
	<span class="token keyword">super</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span>  <span class="token class-name">Net</span><span class="token punctuation">.</span><span class="token function">serverSocket</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>fdVal <span class="token operator">=</span> <span class="token class-name">IOUtil</span><span class="token punctuation">.</span><span class="token function">fdVal</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">ST_INUSE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¾®ä¿¡æœç´¢ã€Œ<strong>bugstackè™«æ´æ ˆ</strong>ã€å…¬ä¼—å·ï¼Œå…³æ³¨åå›å¤ã€Œ<strong>rpcæ¡ˆä¾‹æºç </strong>ã€è·å–æœ¬æ–‡æºç &amp;æ›´å¤šåŸåˆ›ä¸“é¢˜æ¡ˆä¾‹ï¼</p>`,38);function v(m,b){const a=p("ExternalLinkIcon");return e(),o("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),k,s("åšå®¢ï¼š"),n("a",r,[s("https://bugstack.cn"),c(a)])]),d])}const y=t(i,[["render",v],["__file","2019-09-12-nettyanliï¼Œnetty4.1yuanmafenxipiansanã€ŠNettyfuwuduanchushihuaguochengyijifanshegongchangdezuoyongã€‹.html.vue"]]);export{y as default};
