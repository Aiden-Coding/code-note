import{_ as p,r as o,o as c,c as l,a as n,b as s,d as t,e}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"è°ƒç ”å­—èŠ‚ç æ’æ¡©æŠ€æœ¯-ç”¨äºç³»ç»Ÿç›‘æ§è®¾è®¡å’Œå®ç°",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#è°ƒç ”å­—èŠ‚ç æ’æ¡©æŠ€æœ¯-ç”¨äºç³»ç»Ÿç›‘æ§è®¾è®¡å’Œå®ç°","aria-hidden":"true"},"#"),s(" è°ƒç ”å­—èŠ‚ç æ’æ¡©æŠ€æœ¯ï¼Œç”¨äºç³»ç»Ÿç›‘æ§è®¾è®¡å’Œå®ç°")],-1),r=n("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=n("br",null,null,-1),m={href:"https://mp.weixin.qq.com/s/9g7O3MSxh5q3F6z-Mxalzg",target:"_blank",rel:"noopener noreferrer"},v=e('<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€æ¥è‡ªæ·±å¤œçš„ç”µè¯" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€æ¥è‡ªæ·±å¤œçš„ç”µè¯" aria-hidden="true">#</a> ä¸€ã€æ¥è‡ªæ·±å¤œçš„ç”µè¯ï¼</h2><p><code>å’‹æ»´ï¼Œä½ é‚£ä¸Šçº¿çš„ç³»ç»Ÿæ˜¯è£¸å¥”å‘¢ï¼Ÿ</code></p><p><img src="https://bugstack.cn/assets/images/framework/framework-6-1.png" alt=""></p><p>å‘¨æœ«ç†Ÿç¡çš„æ·±å¤œï¼Œçªç„¶æ¥åˆ°è€æ¿ç”µè¯â˜çš„å‚¬ä¿ƒã€‚â€œèµ¶ç´§çœ‹å¾®ä¿¡ã€çœ‹å¾®ä¿¡ï¼Œå’‹ç³»ç»Ÿå‡ºé—®é¢˜äº†ï¼Œæˆ‘ä»¬éƒ½ä¸çŸ¥é“ï¼Œè¿˜å¾—ç”¨æˆ·åé¦ˆæ‰çŸ¥é“çš„ï¼ï¼ï¼â€æ·±å¤œçˆ¬èµ·æ¥ï¼Œæ‰“å¼€ç”µè„‘è¿ä¸Š VPN ï¼Œæ‰“ç€å“ˆæ¬ ã€çå¼€æœ¦èƒ§çš„çœ¼ç›ï¼ŒæŸ¥æŸ¥ç³»ç»Ÿæ—¥å¿—ï¼ŒåŸæ¥æ˜¯ç³»ç»ŸæŒ‚äº†ï¼Œèµ¶ç´§é‡å¯æ¢å¤ï¼</p><p>è™½ç„¶é‡å¯æ¢å¤äº†ç³»ç»Ÿï¼Œä¹Ÿé‡ç½®äº†è€æ¿æ‰­æ›²çš„è¡¨æƒ…ã€‚ä½†ç³»ç»Ÿæ˜¯æ€ä¹ˆæŒ‚çš„å‘¢ï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸ªç›‘æ§ç³»ç»Ÿï¼Œä¹Ÿä¸çŸ¥é“æ˜¯æµé‡å¤ªå¤§å¯¼è‡´ï¼Œè¿˜æ˜¯å› ä¸ºç¨‹åºé—®é¢˜å¼•èµ·ï¼Œé€šè¿‡ä¸€ç‰‡ç‰‡çš„æ—¥å¿—ï¼Œä¹Ÿä»…èƒ½ç²—ç•¥ä¼°è®¡å‡ºä¸€äº›æ‰“ç€<code>å¥½åƒçš„æ ‡ç­¾</code>ç»™è€æ¿æ±‡æŠ¥ã€‚ä¸è¿‡è€æ¿<em>ä¹Ÿä¸å‚»</em>ï¼ŒèŠæ¥èŠå»ï¼Œè®©æŠŠæ‰€æœ‰çš„ç³»ç»Ÿè¿è¡ŒçŠ¶å†µéƒ½ç›‘æ§å‡ºæ¥ã€‚</p>',6),b=n("strong",null,"éš¾é“åœ¨æ¯ä¸ªæ–¹æ³•ä¸Šéƒ½ç¡¬ç¼–ç ä¸Šæ‰§è¡Œè€—æ—¶è®¡ç®—",-1),g={href:"https://echarts.apache.org/zh/index.html",target:"_blank",rel:"noopener noreferrer"},h=e(`<p><img src="https://bugstack.cn/assets/images/framework/framework-6-2.png" alt=""></p><ul><li>ä½†è¿™ä¹ˆç¡¬ç¼–ç ä¹Ÿä¸å«ç©æ„å‘€ï¼Œè¿™ä¸æŠŠæˆ‘ä»¬éƒ¨é—¨æ¬ç –çš„ç å†œç´¯å²”æ°”å‘€ï¼å†è¯´äº†ï¼Œè¿™ä¹ˆå¹²ä»–ä»¬è‚¯å®šç§ä¸èµ·æˆ‘ã€‚<em>å•¥æ¶æ„å¸ˆï¼Œè¦ç›‘æ§ç³»ç»Ÿï¼Œè¿˜å¾—ç¡¬ç¼–ç ï¼Œå‚»äº†ä¸æ˜¯ï¼ï¼ï¼</em></li><li>è¿™ä¹ˆä¸€æƒ³æ•´çš„æ²¡æ³•ç¡è§‰ï¼Œå¾—æ‰¾æ‰¾èµ„æ–™ï¼Œæ˜å¤©ç»™è€æ¿æ±‡æŠ¥ï¼</li></ul><hr><p>å…¶å®ä¸€å¥—çº¿ä¸Šç³»ç»Ÿæ˜¯å¦ç¨³å®šè¿è¡Œï¼Œå–å†³äºå®ƒçš„è¿è¡Œå¥åº·åº¦ï¼Œè€Œè¿™åŒ…æ‹¬ï¼›è°ƒç”¨é‡ã€å¯ç”¨ç‡ã€å½±å“æ—¶é•¿ä»¥åŠæœåŠ¡å™¨æ€§èƒ½ç­‰å„é¡¹æŒ‡æ ‡çš„ä¸€ä¸ªç»¼åˆå€¼ã€‚å¹¶ä¸”åœ¨ç³»ç»Ÿå‡ºç°å¼‚å¸¸é—®é¢˜æ—¶ï¼Œå¯ä»¥æŠ“å–æ•´ä¸ªä¸šåŠ¡æ–¹æ³•æ‰§è¡Œé“¾è·¯å¹¶è¾“å‡ºï¼›å½“æ—¶çš„å…¥å‚ã€å‡ºå‚ã€å¼‚å¸¸ä¿¡æ¯ç­‰ç­‰ã€‚å½“ç„¶è¿˜åŒ…æ‹¬ä¸€äº›JVMã€Redisã€Mysqlçš„å„é¡¹æ€§èƒ½æŒ‡æ ‡ï¼Œä»¥ç”¨äºå¿«é€Ÿå®šä½å¹¶è§£å†³é—®é¢˜ã€‚</p><p>é‚£ä¹ˆè¦åšåˆ°è¿™æ ·çš„äº‹æƒ…æœ‰ä»€ä¹ˆå¤„ç†æ–¹æ¡ˆå‘¢ï¼Œå…¶å®åšæ³•è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œæ¯”å¦‚ï¼›</p><ol><li>æœ€ç®€å•ç²—æš´çš„å°±æ˜¯ç¡¬ç¼–ç åœ¨æ–¹æ³•ä¸­ï¼Œæ”¶å–æ‰§è¡Œè€—æ—¶ä»¥åŠå‡ºå…¥å‚å’Œå¼‚å¸¸ä¿¡æ¯ã€‚ä½†è¿™æ ·çš„ç¼–ç æˆæœ¬å®åœ¨å¤ªå¤§ï¼Œè€Œä¸”ç¡¬ç¼–ç å®Œè¿˜éœ€è¦å¤§é‡å›å½’æµ‹è¯•ï¼Œå¯èƒ½ç»™ç³»ç»Ÿå¸¦æ¥ä¸€å®šçš„é£é™©ã€‚<em>ä¸‡ä¸€è°æ‰‹æŠ–ç»™å¤åˆ¶ç²˜è´´é”™äº†å‘¢ï¼</em></li><li>å¯ä»¥é€‰æ‹©åˆ‡é¢æ–¹å¼åšä¸€å¥—ç»Ÿä¸€ç›‘æ§çš„ç»„ä»¶ï¼Œç›¸å¯¹æ¥è¯´è¿˜æ˜¯å¥½ä¸€äº›çš„ã€‚ä½†ä¹Ÿéœ€è¦ç¡¬ç¼–ç ï¼Œæ¯”å¦‚å†™å…¥æ³¨è§£ï¼ŒåŒæ—¶ç»´æŠ¤æˆæœ¬ä¹Ÿä¸ä½ã€‚</li><li>å…¶å®å¸‚é¢ä¸Šå¯¹äºè¿™æ ·çš„ç›‘æ§å…¶å®æ˜¯æœ‰æ•´å¥—çš„éå…¥ä¾µç›‘æ§æ–¹æ¡ˆçš„ï¼Œæ¯”å¦‚ï¼›Google Dapperã€Zipkinç­‰éƒ½å¯ä»¥å®ç°ç›‘æ§ç³»ç»Ÿéœ€æ±‚ï¼Œä»–ä»¬éƒ½æ˜¯åŸºäºæ¢é’ˆæŠ€æœ¯éå…¥ä¾µçš„é‡‡ç”¨å­—èŠ‚ç å¢å¼ºçš„æ–¹å¼é‡‡é›†ç³»ç»Ÿè¿è¡Œä¿¡æ¯è¿›è¡Œåˆ†æå’Œç›‘æ§è¿è¡ŒçŠ¶æ€ã€‚</li></ol><p>å¥½ï¼Œé‚£ä¹ˆæœ¬æ–‡å°±æ¥å¸¦ç€å¤§å®¶æ¥å°è¯•ä¸‹å‡ ç§ä¸åŒæ–¹å¼ï¼Œç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€çš„å®ç°æ€è·¯ã€‚</p><h2 id="äºŒã€å‡†å¤‡å·¥ä½œ" tabindex="-1"><a class="header-anchor" href="#äºŒã€å‡†å¤‡å·¥ä½œ" aria-hidden="true">#</a> äºŒã€å‡†å¤‡å·¥ä½œ</h2><p>æœ¬æ–‡ä¼šåŸºäº <code>AOP</code>ã€å­—èŠ‚ç æ¡†æ¶(<code>ASM</code>ã€<code>Javassist</code>ã€<code>Byte-Buddy</code>)ï¼Œåˆ†åˆ«å®ç°ä¸åŒçš„ç›‘æ§å®ç°ä»£ç ã€‚æ•´ä¸ªå·¥ç¨‹ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">MonitorDesign</span>
â”œâ”€â”€ cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>aop
â”œâ”€â”€ cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>asm
â”œâ”€â”€ cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>bytebuddy
â”œâ”€â”€ cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>javassist
â”œâ”€â”€ cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>test
â””â”€â”€	pom<span class="token punctuation">.</span>xml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,10),y={href:"https://github.com/fuzhengwei/MonitorDesign",target:"_blank",rel:"noopener noreferrer"},f=n("li",null,"ç®€å•ä»‹ç»ï¼šaopã€asmã€bytebuddyã€javassistï¼Œåˆ†åˆ«æ˜¯å››ç§ä¸åŒçš„å®ç°æ–¹æ¡ˆã€‚test æ˜¯ä¸€ä¸ªåŸºäº SpringBoot çš„ç®€å•æµ‹è¯•å·¥ç¨‹ã€‚",-1),w=n("li",null,"æŠ€æœ¯ä½¿ç”¨ï¼šSpringBootã€asmã€byte-buddyã€javassist",-1),q=e(`<p><strong>cn-bugstack-middleware-test</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">UserController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æµ‹è¯•ï¼šhttp://localhost:8081/api/queryUserInfo?userId=aaa
     */</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/api/queryUserInfo&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">UserInfo</span> <span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒuserIdï¼š{}&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token string">&quot;è™«è™«:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">&quot;å¤©æ´¥å¸‚ä¸œä¸½åŒºä¸‡ç§‘èµæºªè‹‘14-0000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ¥ä¸‹æ¥çš„å„ç±»ç›‘æ§ä»£ç å®ç°ï¼Œéƒ½ä¼šä»¥ç›‘æ§ <code>UserController#queryUserInfo</code> çš„æ–¹æ³•æ‰§è¡Œä¿¡æ¯ä¸ºä¸»ï¼Œçœ‹çœ‹å„ç±»æŠ€æœ¯éƒ½æ˜¯æ€ä¹ˆæ“ä½œçš„ã€‚</li></ul><h2 id="ä¸‰ã€ä½¿ç”¨-aop-åšä¸ªåˆ‡é¢ç›‘æ§" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€ä½¿ç”¨-aop-åšä¸ªåˆ‡é¢ç›‘æ§" aria-hidden="true">#</a> ä¸‰ã€ä½¿ç”¨ AOP åšä¸ªåˆ‡é¢ç›‘æ§</h2><h3 id="_1-å·¥ç¨‹ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-å·¥ç¨‹ç»“æ„" aria-hidden="true">#</a> 1. å·¥ç¨‹ç»“æ„</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>aop
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â”œâ”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>monitor
    â”‚       â”‚   â”œâ”€â”€ annotation
    â”‚       â”‚   â”‚   â””â”€â”€ <span class="token class-name">DoMonitor</span><span class="token punctuation">.</span>java
    â”‚       â”‚   â”œâ”€â”€ config
    â”‚       â”‚   â”‚   â””â”€â”€ <span class="token class-name">MonitorAutoConfigure</span><span class="token punctuation">.</span>java
    â”‚       â”‚   â””â”€â”€ <span class="token class-name">DoJoinPoint</span><span class="token punctuation">.</span>java
    â”‚       â””â”€â”€ resources
    â”‚           â””â”€â”€ <span class="token constant">META</span><span class="token operator">-</span><span class="token constant">INF</span> 
    â”‚               â””â”€â”€ spring<span class="token punctuation">.</span>factories
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>test
                â””â”€â”€ <span class="token class-name">ApiTest</span><span class="token punctuation">.</span>java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºäº AOP å®ç°çš„ç›‘æ§ç³»ç»Ÿï¼Œæ ¸å¿ƒé€»è¾‘çš„ä»¥ä¸Šå·¥ç¨‹å¹¶ä¸å¤æ‚ï¼Œå…¶æ ¸å¿ƒç‚¹åœ¨äºå¯¹åˆ‡é¢çš„ç†è§£å’Œè¿ç”¨ï¼Œä»¥åŠä¸€äº›é…ç½®é¡¹éœ€è¦æŒ‰ç…§ SpringBoot ä¸­çš„å®ç°æ–¹å¼è¿›è¡Œå¼€å‘ã€‚</p><ul><li>DoMonitorï¼Œæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£ã€‚å®ƒä½œç”¨å°±æ˜¯åœ¨éœ€è¦ä½¿ç”¨åˆ°çš„æ–¹æ³•ç›‘æ§æ¥å£ä¸Šï¼Œæ·»åŠ æ­¤æ³¨è§£å¹¶é…ç½®å¿…è¦çš„ä¿¡æ¯ã€‚</li><li>MonitorAutoConfigureï¼Œé…ç½®ä¸‹æ˜¯å¯ä»¥å¯¹ SpringBoot yml æ–‡ä»¶çš„ä½¿ç”¨ï¼Œå¯ä»¥å¤„ç†ä¸€äº› Bean çš„åˆå§‹åŒ–æ“ä½œã€‚</li><li>DoJoinPointï¼Œæ˜¯æ•´ä¸ªä¸­é—´ä»¶çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒè´Ÿè´£å¯¹æ‰€æœ‰æ·»åŠ è‡ªå®šä¹‰æ³¨è§£çš„æ–¹æ³•è¿›è¡Œæ‹¦æˆªå’Œé€»è¾‘å¤„ç†ã€‚</li></ul><h3 id="_2-å®šä¹‰ç›‘æ§æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#_2-å®šä¹‰ç›‘æ§æ³¨è§£" aria-hidden="true">#</a> 2. å®šä¹‰ç›‘æ§æ³¨è§£</h3><p><strong>cn.bugstack.middleware.monitor.annotation.DoMonitor</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">DoMonitor</span> <span class="token punctuation">{</span>

   <span class="token class-name">String</span> <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> <span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>@Retention(RetentionPolicy.RUNTIME)ï¼Œ<code>Annotations are to be recorded in the class file by the compiler and retained by the VM at run time, so they may be read reflectively.</code></li><li>@Retention æ˜¯æ³¨è§£çš„æ³¨è§£ï¼Œä¹Ÿç§°ä½œå…ƒæ³¨è§£ã€‚è¿™ä¸ªæ³¨è§£é‡Œé¢æœ‰ä¸€ä¸ªå…¥å‚ä¿¡æ¯ <code>RetentionPolicy.RUNTIME</code> åœ¨å®ƒçš„æ³¨é‡Šä¸­æœ‰è¿™æ ·ä¸€æ®µæè¿°ï¼š<code>Annotations are to be recorded in the class file by the compiler and retained by the VM at run time, so they may be read reflectively.</code> å…¶å®è¯´çš„å°±æ˜¯åŠ äº†è¿™ä¸ªæ³¨è§£ï¼Œå®ƒçš„ä¿¡æ¯ä¼šè¢«å¸¦åˆ°JVMè¿è¡Œæ—¶ï¼Œå½“ä½ åœ¨è°ƒç”¨æ–¹æ³•æ—¶å¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°æ³¨è§£ä¿¡æ¯ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRetentionPolicy è¿˜æœ‰ä¸¤ä¸ªå±æ€§ <code>SOURCE</code>ã€<code>CLASS</code>ï¼Œå…¶å®è¿™ä¸‰ä¸ªæšä¸¾æ­£å¼å¯¹åº”äº†Javaä»£ç çš„åŠ è½½å’Œè¿è¡Œé¡ºåºï¼ŒJavaæºç æ–‡ä»¶ -&gt; .classæ–‡ä»¶ -&gt; å†…å­˜å­—èŠ‚ç ã€‚å¹¶ä¸”åè€…èŒƒå›´å¤§äºå‰è€…ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹åªéœ€è¦ä½¿ç”¨ RetentionPolicy.RUNTIME å³å¯ã€‚</li><li>@Target ä¹Ÿæ˜¯å…ƒæ³¨è§£èµ·åˆ°æ ‡è®°ä½œç”¨ï¼Œå®ƒçš„æ³¨è§£åç§°å°±æ˜¯å®ƒçš„å«ä¹‰ï¼Œ<strong>ç›®æ ‡</strong>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™ä¸ªè‡ªå®šä¹‰æ³¨è§£ DoWhiteList è¦æ”¾åœ¨ç±»ã€æ¥å£è¿˜æ˜¯æ–¹æ³•ä¸Šã€‚<em>åœ¨ JDK1.8 ä¸­ ElementType ä¸€å…±æä¾›äº†10ä¸­ç›®æ ‡æšä¸¾ï¼ŒTYPEã€FIELDã€METHODã€PARAMETERã€CONSTRUCTORã€LOCAL_VARIABLEã€ANNOTATION_TYPEã€PACKAGEã€TYPE_PARAMETERã€TYPE_USEï¼Œå¯ä»¥å‚è€ƒè‡ªå·±çš„è‡ªå®šä¹‰æ³¨è§£ä½œç”¨åŸŸè¿›è¡Œè®¾ç½®</em></li><li>è‡ªå®šä¹‰æ³¨è§£ @DoMonitor æä¾›äº†ç›‘æ§çš„ key å’Œ descæè¿°ï¼Œè¿™ä¸ªä¸»è¦è®°å½•ä½ ç›‘æ§æ–¹æ³•çš„ä¸ºå”¯ä¸€å€¼é…ç½®å’Œå¯¹ç›‘æ§æ–¹æ³•çš„æ–‡å­—æè¿°ã€‚</li></ul><h3 id="_3-å®šä¹‰åˆ‡é¢æ‹¦æˆª" tabindex="-1"><a class="header-anchor" href="#_3-å®šä¹‰åˆ‡é¢æ‹¦æˆª" aria-hidden="true">#</a> 3. å®šä¹‰åˆ‡é¢æ‹¦æˆª</h3><p><strong>cn.bugstack.middleware.monitor.DoJoinPoint</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DoJoinPoint</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(cn.bugstack.middleware.monitor.annotation.DoMonitor)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">aopPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;aopPoint() &amp;&amp; @annotation(doMonitor)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doRouter</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> jp<span class="token punctuation">,</span> <span class="token class-name">DoMonitor</span> doMonitor<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token function">getMethod</span><span class="token punctuation">(</span>jp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> jp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘æ§ - Begin By AOP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘æ§ç´¢å¼•ï¼š&quot;</span> <span class="token operator">+</span> doMonitor<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘æ§æè¿°ï¼š&quot;</span> <span class="token operator">+</span> doMonitor<span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–¹æ³•åç§°ï¼š&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–¹æ³•è€—æ—¶ï¼š&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘æ§ - End\\r\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Method</span> <span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> jp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Signature</span> sig <span class="token operator">=</span> jp<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodSignature</span> methodSignature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> sig<span class="token punctuation">;</span>
        <span class="token keyword">return</span> jp<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>methodSignature<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodSignature<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä½¿ç”¨æ³¨è§£ @Aspectï¼Œå®šä¹‰åˆ‡é¢ç±»ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„åˆ‡é¢å®šä¹‰æ–¹å¼ã€‚</li><li><code>@Pointcut(&quot;@annotation(cn.bugstack.middleware.monitor.annotation.DoMonitor)&quot;)</code>ï¼Œå®šä¹‰åˆ‡ç‚¹ã€‚åœ¨ Pointcut ä¸­æä¾›äº†å¾ˆå¤šçš„åˆ‡ç‚¹å¯»æ‰¾æ–¹å¼ï¼Œæœ‰æŒ‡å®šæ–¹æ³•åç§°çš„ã€æœ‰èŒƒå›´ç­›é€‰è¡¨è¾¾å¼çš„ï¼Œä¹Ÿæœ‰æˆ‘ä»¬ç°åœ¨é€šè¿‡è‡ªå®šä¹‰æ³¨è§£æ–¹å¼çš„ã€‚ä¸€èˆ¬åœ¨ä¸­é—´ä»¶å¼€å‘ä¸­ï¼Œè‡ªå®šä¹‰æ³¨è§£æ–¹å¼ä½¿ç”¨çš„æ¯”è¾ƒå¤šï¼Œå› ä¸ºå®ƒå¯ä»¥æ›´åŠ çµæ´»çš„è¿ç”¨åˆ°å„ä¸ªä¸šåŠ¡ç³»ç»Ÿä¸­ã€‚</li><li><code>@Around(&quot;aopPoint() &amp;&amp; @annotation(doMonitor)&quot;)</code>ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯å¯¹æ–¹æ³•å¢å¼ºçš„ç»‡å…¥åŠ¨ä½œï¼Œæœ‰äº†è¿™ä¸ªæ³¨è§£çš„æ•ˆæœå°±æ˜¯åœ¨ä½ è°ƒç”¨å·²ç»åŠ äº†è‡ªå®šä¹‰æ³¨è§£ @DoMonitor çš„æ–¹æ³•æ—¶ï¼Œä¼šå…ˆè¿›å…¥åˆ°æ­¤åˆ‡ç‚¹å¢å¼ºçš„æ–¹æ³•ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±ä½ å¯ä»¥åšä¸€äº›å¯¹æ–¹æ³•çš„æ“ä½œåŠ¨ä½œäº†ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦åšä¸€äº›æ–¹æ³•ç›‘æ§å’Œæ—¥å¿—æ‰“å°ç­‰ã€‚</li><li>æœ€ååœ¨ <code>doRouter</code> æ–¹æ³•ä½“ä¸­è·å–æŠŠæ–¹æ³•æ‰§è¡Œ <code>jp.proceed();</code> ä½¿ç”¨ <code>try finally</code> åŒ…è£…èµ·æ¥ï¼Œå¹¶æ‰“å°ç›¸å…³çš„ç›‘æ§ä¿¡æ¯ã€‚è¿™äº›ç›‘æ§ä¿¡æ¯çš„è·å–æœ€åéƒ½æ˜¯å¯ä»¥é€šè¿‡å¼‚æ­¥æ¶ˆæ¯çš„æ–¹å¼å‘é€ç»™æœåŠ¡ç«¯ï¼Œå†ç”±æœåŠ¡å™¨è¿›è¡Œå¤„ç†ç›‘æ§æ•°æ®å’Œå¤„ç†å±•ç¤ºåˆ°ç›‘æ§é¡µé¢ã€‚</li></ul><h3 id="_4-åˆå§‹åŒ–åˆ‡é¢ç±»" tabindex="-1"><a class="header-anchor" href="#_4-åˆå§‹åŒ–åˆ‡é¢ç±»" aria-hidden="true">#</a> 4. åˆå§‹åŒ–åˆ‡é¢ç±»</h3><p><strong>cn.bugstack.middleware.monitor.config.MonitorAutoConfigure</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MonitorAutoConfigure</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
    <span class="token keyword">public</span> <span class="token class-name">DoJoinPoint</span> <span class="token function">point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DoJoinPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>@Configurationï¼Œå¯ä»¥ç®—ä½œæ˜¯ä¸€ä¸ªç»„ä»¶æ³¨è§£ï¼Œåœ¨ SpringBoot å¯åŠ¨æ—¶å¯ä»¥è¿›è¡ŒåŠ è½½åˆ›å»ºå‡º Bean æ–‡ä»¶ã€‚<em>å› ä¸º @Configuration æ³¨è§£æœ‰ä¸€ä¸ª @Component æ³¨è§£</em></li><li>MonitorAutoConfigure å¯ä»¥å¤„ç†è‡ªå®šä¹‰åœ¨ yml ä¸­çš„é…ç½®ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ç”¨äºåˆå§‹åŒ– Bean å¯¹è±¡ï¼Œæ¯”å¦‚åœ¨è¿™é‡Œæˆ‘ä»¬å®ä¾‹åŒ–äº† DoJoinPoint åˆ‡é¢å¯¹è±¡ã€‚</li></ul><h3 id="_5-è¿è¡Œæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_5-è¿è¡Œæµ‹è¯•" aria-hidden="true">#</a> 5. è¿è¡Œæµ‹è¯•</h3><h4 id="_5-1-å¼•å…¥-pom-é…ç½®" tabindex="-1"><a class="header-anchor" href="#_5-1-å¼•å…¥-pom-é…ç½®" aria-hidden="true">#</a> 5.1 å¼•å…¥ POM é…ç½®</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> ç›‘æ§æ–¹å¼ï¼š<span class="token constant">AOP</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>aop<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.0</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-æ–¹æ³•ä¸Šé…ç½®ç›‘æ§æ³¨å†Œ" tabindex="-1"><a class="header-anchor" href="#_5-2-æ–¹æ³•ä¸Šé…ç½®ç›‘æ§æ³¨å†Œ" aria-hidden="true">#</a> 5.2 æ–¹æ³•ä¸Šé…ç½®ç›‘æ§æ³¨å†Œ</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@DoMonitor</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;cn.bugstack.middleware.UserController.queryUserInfo&quot;</span><span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">&quot;æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/api/queryUserInfo&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">UserInfo</span> <span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒuserIdï¼š{}&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span><span class="token string">&quot;è™«è™«:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">&quot;å¤©æ´¥å¸‚ä¸œä¸½åŒºä¸‡ç§‘èµæºªè‹‘14-0000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨é€šè¿‡ POM å¼•å…¥è‡ªå·±çš„å¼€å‘çš„ç»„ä»¶åï¼Œå°±å¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„æ³¨è§£ï¼Œæ‹¦æˆªæ–¹æ³•è·å–ç›‘æ§ä¿¡æ¯ã€‚</li></ul><h4 id="_5-3-æµ‹è¯•ç»“æœ" tabindex="-1"><a class="header-anchor" href="#_5-3-æµ‹è¯•ç»“æœ" aria-hidden="true">#</a> 5.3 æµ‹è¯•ç»“æœ</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">2021</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">21</span><span class="token operator">:</span><span class="token number">10.710</span>  <span class="token constant">INFO</span> <span class="token number">19376</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8081</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">c<span class="token punctuation">.</span>b<span class="token punctuation">.</span>m<span class="token punctuation">.</span>test<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span></span>UserController</span>     <span class="token operator">:</span> æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ŒuserIdï¼šaaa
ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">Begin</span> <span class="token class-name">By</span> <span class="token constant">AOP</span>
ç›‘æ§ç´¢å¼•ï¼š<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span></span>UserController</span><span class="token punctuation">.</span>queryUserInfo
ç›‘æ§æè¿°ï¼šæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
æ–¹æ³•åç§°ï¼šqueryUserInfo
æ–¹æ³•è€—æ—¶ï¼š<span class="token number">6</span>ms
ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">End</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é€šè¿‡å¯åŠ¨ SpringBoot ç¨‹åºï¼Œåœ¨ç½‘é¡µä¸­æ‰“å¼€ URL åœ°å€ï¼š<code>http://localhost:8081/api/queryUserInfo?userId=aaa</code>ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»å¯ä»¥æŠŠç›‘æ§ä¿¡æ¯æ‰“å°åˆ°æ§åˆ¶å°äº†ã€‚</li><li>æ­¤ç§é€šè¿‡è‡ªå®šä¹‰æ³¨è§£çš„é…ç½®æ–¹å¼ï¼Œèƒ½è§£å†³ä¸€å®šçš„ç¡¬ç¼–ç å·¥ä½œï¼Œä½†å¦‚æœåœ¨æ–¹æ³•ä¸Šå¤§é‡çš„æ·»åŠ æ³¨è§£ï¼Œä¹Ÿæ˜¯éœ€è¦ä¸€å®šçš„å¼€å‘å·¥ä½œçš„ã€‚</li></ul><hr><p><strong>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ä»‹ç»å…³äºä½¿ç”¨å­—èŠ‚ç æ’æ¡©éå…¥ä¾µçš„æ–¹å¼è¿›è¡Œç³»ç»Ÿç›‘æ§ï¼Œå…³äºå­—èŠ‚ç æ’æ¡©å¸¸ç”¨çš„æœ‰ä¸‰ä¸ªç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼šASMã€Javassitã€Byte-Buddyï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«ä»‹ç»å®ƒä»¬æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚</strong></p><h2 id="å››ã€asm" tabindex="-1"><a class="header-anchor" href="#å››ã€asm" aria-hidden="true">#</a> å››ã€ASM</h2><blockquote><p>ASM æ˜¯ä¸€ä¸ª Java å­—èŠ‚ç æ“æ§æ¡†æ¶ã€‚å®ƒèƒ½è¢«ç”¨æ¥åŠ¨æ€ç”Ÿæˆç±»æˆ–è€…å¢å¼ºæ—¢æœ‰ç±»çš„åŠŸèƒ½ã€‚ASM å¯ä»¥ç›´æ¥äº§ç”ŸäºŒè¿›åˆ¶ class æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨ç±»è¢«åŠ è½½å…¥ Java è™šæ‹Ÿæœºä¹‹å‰åŠ¨æ€æ”¹å˜ç±»è¡Œä¸ºã€‚Java class è¢«å­˜å‚¨åœ¨ä¸¥æ ¼æ ¼å¼å®šä¹‰çš„ .class æ–‡ä»¶é‡Œï¼Œè¿™äº›ç±»æ–‡ä»¶æ‹¥æœ‰è¶³å¤Ÿçš„å…ƒæ•°æ®æ¥è§£æç±»ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼šç±»åç§°ã€æ–¹æ³•ã€å±æ€§ä»¥åŠ Java å­—èŠ‚ç ï¼ˆæŒ‡ä»¤ï¼‰ã€‚ASM ä»ç±»æ–‡ä»¶ä¸­è¯»å…¥ä¿¡æ¯åï¼Œèƒ½å¤Ÿæ”¹å˜ç±»è¡Œä¸ºï¼Œåˆ†æç±»ä¿¡æ¯ï¼Œç”šè‡³èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·è¦æ±‚ç”Ÿæˆæ–°ç±»ã€‚</p></blockquote><h3 id="_1-å…ˆæ¥ä¸ªæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_1-å…ˆæ¥ä¸ªæµ‹è¯•" aria-hidden="true">#</a> 1. å…ˆæ¥ä¸ªæµ‹è¯•</h3><p><strong>cn.bugstack.middleware.monitor.test.ApiTest</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ClassWriter</span> classWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å®šä¹‰å¯¹è±¡å¤´ï¼›ç‰ˆæœ¬å·ã€ä¿®é¥°ç¬¦ã€å…¨ç±»åã€ç­¾åã€çˆ¶ç±»ã€å®ç°çš„æ¥å£</span>
    classWriter<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">V1_7</span><span class="token punctuation">,</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ACC_PUBLIC</span><span class="token punctuation">,</span> <span class="token string">&quot;cn/bugstack/demo/asm/AsmHelloWorld&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ·»åŠ æ–¹æ³•ï¼›ä¿®é¥°ç¬¦ã€æ–¹æ³•åã€æè¿°ç¬¦ã€ç­¾åã€å¼‚å¸¸</span>
    <span class="token class-name">MethodVisitor</span> methodVisitor <span class="token operator">=</span> classWriter<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ACC_PUBLIC</span> <span class="token operator">+</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ACC_STATIC</span><span class="token punctuation">,</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;([Ljava/lang/String;)V&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ‰§è¡ŒæŒ‡ä»¤ï¼›è·å–é™æ€å±æ€§</span>
    methodVisitor<span class="token punctuation">.</span><span class="token function">visitFieldInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">GETSTATIC</span><span class="token punctuation">,</span> <span class="token string">&quot;java/lang/System&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;out&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Ljava/io/PrintStream;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åŠ è½½å¸¸é‡ load constant</span>
    methodVisitor<span class="token punctuation">.</span><span class="token function">visitLdcInsn</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World ASM!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è°ƒç”¨æ–¹æ³•</span>
    methodVisitor<span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">INVOKEVIRTUAL</span><span class="token punctuation">,</span> <span class="token string">&quot;java/io/PrintStream&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;println&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;(Ljava/lang/String;)V&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å›</span>
    methodVisitor<span class="token punctuation">.</span><span class="token function">visitInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">RETURN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®æ“ä½œæ•°æ ˆçš„æ·±åº¦å’Œå±€éƒ¨å˜é‡çš„å¤§å°</span>
    methodVisitor<span class="token punctuation">.</span><span class="token function">visitMaxs</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ–¹æ³•ç»“æŸ</span>
    methodVisitor<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç±»å®Œæˆ</span>
    classWriter<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç”Ÿæˆå­—èŠ‚æ•°ç»„</span>
    <span class="token keyword">return</span> classWriter<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>ä»¥ä¸Šè¿™æ®µä»£ç å°±æ˜¯åŸºäº ASM ç¼–å†™çš„ HelloWorldï¼Œæ•´ä¸ªè¿‡ç¨‹åŒ…æ‹¬ï¼šå®šä¹‰ä¸€ä¸ªç±»çš„ç”Ÿæˆ ClassWriterã€è®¾å®šç‰ˆæœ¬ã€ä¿®é¥°ç¬¦ã€å…¨ç±»åã€ç­¾åã€çˆ¶ç±»ã€å®ç°çš„æ¥å£ï¼Œå…¶å®ä¹Ÿå°±æ˜¯é‚£å¥ï¼›<code>public class HelloWorld</code></p></li><li><p>ç±»å‹æè¿°ç¬¦ï¼š</p><table><thead><tr><th style="text-align:left;">Java ç±»å‹</th><th style="text-align:left;">ç±»å‹æè¿°ç¬¦</th></tr></thead><tbody><tr><td style="text-align:left;">boolean</td><td style="text-align:left;">Z</td></tr><tr><td style="text-align:left;">char</td><td style="text-align:left;">C</td></tr><tr><td style="text-align:left;">byte</td><td style="text-align:left;">B</td></tr><tr><td style="text-align:left;">short</td><td style="text-align:left;">S</td></tr><tr><td style="text-align:left;">int</td><td style="text-align:left;">I</td></tr><tr><td style="text-align:left;">float</td><td style="text-align:left;">F</td></tr><tr><td style="text-align:left;">long</td><td style="text-align:left;">J</td></tr><tr><td style="text-align:left;">double</td><td style="text-align:left;">D</td></tr><tr><td style="text-align:left;">Object</td><td style="text-align:left;">Ljava/lang/Object;</td></tr><tr><td style="text-align:left;">int[]</td><td style="text-align:left;">[I</td></tr><tr><td style="text-align:left;">Object[][]</td><td style="text-align:left;">[[Ljava/lang/Object;</td></tr></tbody></table></li><li><p>æ–¹æ³•æè¿°ç¬¦ï¼š</p><table><thead><tr><th style="text-align:left;">æºæ–‡ä»¶ä¸­çš„æ–¹æ³•å£°æ˜</th><th style="text-align:left;">æ–¹æ³•æè¿°ç¬¦</th></tr></thead><tbody><tr><td style="text-align:left;">void m(int i, float f)</td><td style="text-align:left;">(IF)V</td></tr><tr><td style="text-align:left;">int m(Object o)</td><td style="text-align:left;">(Ljava/lang/Object;)I</td></tr><tr><td style="text-align:left;">int[] m(int i, String s)</td><td style="text-align:left;">(ILjava/lang/String;)[I</td></tr><tr><td style="text-align:left;">Object m(int[] i)</td><td style="text-align:left;">([I)Ljava/lang/Object;</td></tr></tbody></table></li><li><p>æ‰§è¡ŒæŒ‡ä»¤ï¼›è·å–é™æ€å±æ€§ã€‚ä¸»è¦æ˜¯è·å¾— System.out</p></li><li><p>åŠ è½½å¸¸é‡ load constantï¼Œè¾“å‡ºæˆ‘ä»¬çš„HelloWorld <code>methodVisitor.visitLdcInsn(&quot;Hello World&quot;);</code></p></li><li><p>æœ€åæ˜¯è°ƒç”¨è¾“å‡ºæ–¹æ³•å¹¶è®¾ç½®ç©ºè¿”å›ï¼ŒåŒæ—¶åœ¨ç»“å°¾è¦è®¾ç½®æ“ä½œæ•°æ ˆçš„æ·±åº¦å’Œå±€éƒ¨å˜é‡çš„å¤§å°ã€‚</p></li><li><p>è¿™æ ·è¾“å‡ºä¸€ä¸ª <code>HelloWorld</code> æ˜¯ä¸è¿˜æ˜¯è›®æœ‰æ„æ€çš„ï¼Œè™½ç„¶ä½ å¯èƒ½è§‰å¾—è¿™ç¼–ç èµ·æ¥å®åœ¨å¤ªéš¾äº†å§ï¼Œä¹Ÿéå¸¸éš¾ç†è§£ã€‚ä¸è¿‡ä½ å¯ä»¥å®‰è£…ä¸€ä¸ª ASM åœ¨ IDEA ä¸­çš„æ’ä»¶ ASM Bytecode Outlineï¼Œèƒ½æ›´åŠ æ–¹ä¾¿çš„æŸ¥çœ‹ä¸€ä¸ªæ™®é€šçš„ä»£ç åœ¨ä½¿ç”¨ ASM çš„æ–¹å¼è¯¥å¦‚ä½•å¤„ç†ã€‚</p></li><li><p>å¦å¤–ä»¥ä¸Šè¿™æ®µä»£ç çš„æµ‹è¯•ç»“æœï¼Œä¸»è¦æ˜¯ç”Ÿæˆä¸€ä¸ª class æ–‡ä»¶å’Œè¾“å‡º <code>Hello World ASM!</code> ç»“æœã€‚</p></li></ul><h3 id="_2-ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_2-ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„" aria-hidden="true">#</a> 2. ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>asm
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>monitor
    â”‚   â”‚       â”œâ”€â”€ config
    â”‚   â”‚       â”‚   â”œâ”€â”€ <span class="token class-name">MethodInfo</span><span class="token punctuation">.</span>java
    â”‚   â”‚       â”‚   â””â”€â”€ <span class="token class-name">ProfilingFilter</span><span class="token punctuation">.</span>java
    â”‚   â”‚       â”œâ”€â”€ probe
    â”‚   â”‚       â”‚   â”œâ”€â”€ <span class="token class-name">ProfilingAspect</span><span class="token punctuation">.</span>java
    â”‚   â”‚       â”‚   â”œâ”€â”€ <span class="token class-name">ProfilingClassAdapter</span><span class="token punctuation">.</span>java
    â”‚   â”‚       â”‚   â”œâ”€â”€ <span class="token class-name">ProfilingMethodVisitor</span><span class="token punctuation">.</span>java
    â”‚   â”‚       â”‚   â””â”€â”€ <span class="token class-name">ProfilingTransformer</span><span class="token punctuation">.</span>java
    â”‚   â”‚       â””â”€â”€ <span class="token class-name">PreMain</span><span class="token punctuation">.</span>java
    â”‚   â””â”€â”€ resources	
    â”‚       â””â”€â”€ <span class="token constant">META_INF</span>
    â”‚           â””â”€â”€ <span class="token constant">MANIFEST</span><span class="token punctuation">.</span><span class="token constant">MF</span>
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>test
                â””â”€â”€ <span class="token class-name">ApiTest</span><span class="token punctuation">.</span>java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šå·¥ç¨‹ç»“æ„æ˜¯ä½¿ç”¨ ASM æ¡†æ¶ç»™ç³»ç»Ÿæ–¹æ³•åšå¢å¼ºæ“ä½œï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºé€šè¿‡æ¡†æ¶å®Œæˆç¡¬ç¼–ç å†™å…¥æ–¹æ³•å‰åçš„ç›‘æ§ä¿¡æ¯ã€‚ä¸è¿‡è¿™ä¸ªè¿‡ç¨‹è½¬ç§»åˆ°äº† Java ç¨‹åºå¯åŠ¨æ—¶åœ¨ Javaagent#premain è¿›è¡Œå¤„ç†ã€‚</p><ul><li>MethodInfo æ˜¯æ–¹æ³•çš„å®šä¹‰ï¼Œä¸»è¦æ˜¯æè¿°ç±»åã€æ–¹æ³•åã€æè¿°ã€å…¥å‚ã€å‡ºå‚ä¿¡æ¯ã€‚</li><li>ProfilingFilter æ˜¯ç›‘æ§çš„é…ç½®ä¿¡æ¯ï¼Œä¸»è¦æ˜¯è¿‡æ»¤ä¸€äº›ä¸éœ€è¦å­—èŠ‚ç å¢å¼ºæ“ä½œçš„æ–¹æ³•ï¼Œæ¯”å¦‚mainã€hashCodeã€javax/ç­‰</li><li>ProfilingAspectã€ProfilingClassAdapterã€ProfilingMethodVisitorã€ProfilingTransformerï¼Œè¿™å››ä¸ªç±»ä¸»è¦æ˜¯å®Œæˆå­—èŠ‚ç æ’è£…æ“ä½œå’Œè¾“å‡ºç›‘æ§ç»“æœçš„ç±»ã€‚</li><li>PreMain æä¾›äº† Javaagent çš„å…¥å£ï¼ŒJVM é¦–å…ˆå°è¯•åœ¨ä»£ç†ç±»ä¸Šè°ƒç”¨ premain æ–¹æ³•ã€‚</li><li>MANIFEST.MF æ˜¯é…ç½®ä¿¡æ¯ï¼Œä¸»è¦æ˜¯æ‰¾åˆ° Premain-Class <code>Premain-Class: cn.bugstack.middleware.monitor.PreMain</code></li></ul><h3 id="_3-ç›‘æ§ç±»å…¥å£" tabindex="-1"><a class="header-anchor" href="#_3-ç›‘æ§ç±»å…¥å£" aria-hidden="true">#</a> 3. ç›‘æ§ç±»å…¥å£</h3><p><strong>cn.bugstack.middleware.monitor.PreMain</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreMain</span> <span class="token punctuation">{</span>

    <span class="token comment">//JVM é¦–å…ˆå°è¯•åœ¨ä»£ç†ç±»ä¸Šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        inst<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProfilingTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//å¦‚æœä»£ç†ç±»æ²¡æœ‰å®ç°ä¸Šé¢çš„æ–¹æ³•ï¼Œé‚£ä¹ˆ JVM å°†å°è¯•è°ƒç”¨è¯¥æ–¹æ³•</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™ä¸ªæ˜¯ Javaagent æŠ€æœ¯çš„å›ºå®šå…¥å£æ–¹æ³•ç±»ï¼ŒåŒæ—¶è¿˜éœ€è¦æŠŠè¿™ä¸ªç±»çš„è·¯å¾„é…ç½®åˆ° MANIFEST.MF ä¸­ã€‚</li></ul><h3 id="_4-å­—èŠ‚ç æ–¹æ³•å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_4-å­—èŠ‚ç æ–¹æ³•å¤„ç†" aria-hidden="true">#</a> 4. å­—èŠ‚ç æ–¹æ³•å¤„ç†</h3><p><strong>cn.bugstack.middleware.monitor.probe.ProfilingTransformer</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProfilingTransformer</span> <span class="token keyword">implements</span> <span class="token class-name">ClassFileTransformer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span> <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ProfilingFilter</span><span class="token punctuation">.</span><span class="token function">isNotNeedInject</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">getBytes</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> className<span class="token punctuation">,</span> classfileBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassReader</span> cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>classfileBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span>cr<span class="token punctuation">,</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span><span class="token constant">COMPUTE_MAXS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassVisitor</span> cv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProfilingClassAdapter</span><span class="token punctuation">(</span>cw<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cr<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>cv<span class="token punctuation">,</span> <span class="token class-name">ClassReader</span><span class="token punctuation">.</span><span class="token constant">EXPAND_FRAMES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,48),j=n("li",null,"ä½¿ç”¨ ASM æ ¸å¿ƒç±» ClassReaderã€ClassWriterã€ClassVisitorï¼Œå¤„ç†ä¼ å…¥è¿›è¡Œçš„ç±»åŠ è½½å™¨ã€ç±»åã€å­—èŠ‚ç ç­‰ï¼Œè´Ÿè´£å­—èŠ‚ç çš„å¢å¼ºæ“ä½œã€‚",-1),M={href:"https://bugstack.cn/itstack/itstack-demo-bytecode.html",target:"_blank",rel:"noopener noreferrer"},C=e(`<h3 id="_5-å­—èŠ‚ç æ–¹æ³•è§£æ" tabindex="-1"><a class="header-anchor" href="#_5-å­—èŠ‚ç æ–¹æ³•è§£æ" aria-hidden="true">#</a> 5.å­—èŠ‚ç æ–¹æ³•è§£æ</h3><p><strong>cn.bugstack.middleware.monitor.probe.ProfilingMethodVisitor</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProfilingMethodVisitor</span> <span class="token keyword">extends</span> <span class="token class-name">AdviceAdapter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameterTypeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> parameterTypeCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// å‚æ•°ä¸ªæ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> startTimeIdentifier<span class="token punctuation">;</span>        <span class="token comment">// å¯åŠ¨æ—¶é—´æ ‡è®°</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> parameterIdentifier<span class="token punctuation">;</span>        <span class="token comment">// å…¥å‚å†…å®¹æ ‡è®°</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> methodId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>              <span class="token comment">// æ–¹æ³•å…¨å±€å”¯ä¸€æ ‡è®°</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> currentLocal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>           <span class="token comment">// å½“å‰å±€éƒ¨å˜é‡å€¼</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isStaticMethod<span class="token punctuation">;</span>   <span class="token comment">// trueï¼›é™æ€æ–¹æ³•ï¼Œfalseï¼›éé™æ€æ–¹æ³•</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> className<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">ProfilingMethodVisitor</span><span class="token punctuation">(</span><span class="token keyword">int</span> access<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token class-name">String</span> desc<span class="token punctuation">,</span> <span class="token class-name">MethodVisitor</span> mv<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">String</span> fullClassName<span class="token punctuation">,</span> <span class="token class-name">String</span> simpleClassName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token constant">ASM5</span><span class="token punctuation">,</span> mv<span class="token punctuation">,</span> access<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>className <span class="token operator">=</span> className<span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­æ˜¯å¦ä¸ºé™æ€æ–¹æ³•ï¼Œéé™æ€æ–¹æ³•ä¸­å±€éƒ¨å˜é‡ç¬¬ä¸€ä¸ªå€¼æ˜¯thisï¼Œé™æ€æ–¹æ³•æ˜¯ç¬¬ä¸€ä¸ªå…¥å‚å‚æ•°</span>
        isStaticMethod <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>access <span class="token operator">&amp;</span> <span class="token constant">ACC_STATIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//(String var1,Object var2,String var3,int var4,long var5,int[] var6,Object[][] var7,Req var8)==&quot;(Ljava/lang/String;Ljava/lang/Object;Ljava/lang/String;IJ[I[[Ljava/lang/Object;Lorg/itstack/test/Req;)V&quot;</span>
        <span class="token class-name">Matcher</span> matcher <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">&quot;(L.*?;|\\\\[{0,2}L.*?;|[ZCBSIFJD]|\\\\[{0,2}[ZCBSIFJD]{1})&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>desc<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> desc<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">&#39;)&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parameterTypeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>matcher<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        parameterTypeCount <span class="token operator">=</span> parameterTypeList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        methodId <span class="token operator">=</span> <span class="token class-name">ProfilingAspect</span><span class="token punctuation">.</span><span class="token function">generateMethodId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MethodInfo</span><span class="token punctuation">(</span>fullClassName<span class="token punctuation">,</span> simpleClassName<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> parameterTypeList<span class="token punctuation">,</span> desc<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>desc<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token char">&#39;)&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>     

    <span class="token comment">//... ä¸€äº›å­—èŠ‚ç æ’æ¡©æ“ä½œ </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å½“ç¨‹åºå¯åŠ¨åŠ è½½çš„æ—¶å€™ï¼Œæ¯ä¸ªç±»çš„æ¯ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šè¢«ç›‘æ§åˆ°ã€‚ç±»çš„åç§°ã€æ–¹æ³•çš„åç§°ã€æ–¹æ³•å…¥å‚å‡ºå‚çš„æè¿°ç­‰ï¼Œéƒ½å¯ä»¥åœ¨è¿™é‡Œè·å–ã€‚</li><li>ä¸ºäº†å¯ä»¥åœ¨åç»­ç›‘æ§å¤„ç†ä¸è‡³äºæ¯ä¸€æ¬¡éƒ½å»ä¼ å‚ï¼ˆæ–¹æ³•ä¿¡æ¯ï¼‰æµªè´¹æ¶ˆè€—æ€§èƒ½ï¼Œä¸€èˆ¬è¿™é‡Œéƒ½ä¼šç»™æ¯ä¸ªæ–¹æ³•ç”Ÿäº§ä¸€ä¸ªå…¨å±€é˜²é‡çš„ <code>id</code> ï¼Œé€šè¿‡è¿™ä¸ª <code>id</code> å°±å¯ä»¥æŸ¥è¯¢åˆ°å¯¹åº”çš„æ–¹æ³•ã€‚</li><li>å¦å¤–ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°çš„æ–¹æ³•çš„å…¥å‚å’Œå‡ºå‚è¢«æè¿°æˆä¸€æ®µæŒ‡å®šçš„ç ï¼Œ<code>(II)Ljava/lang/String;</code> ï¼Œä¸ºäº†æˆ‘ä»¬åç»­å¯¹å‚æ•°è¿›è¡Œè§£æï¼Œé‚£ä¹ˆéœ€è¦å°†è¿™æ®µå­—ç¬¦ä¸²è¿›è¡Œæ‹†è§£ã€‚</li></ul><h3 id="_6-è¿è¡Œæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_6-è¿è¡Œæµ‹è¯•" aria-hidden="true">#</a> 6. è¿è¡Œæµ‹è¯•</h3><h4 id="_6-1-é…ç½®-vm-å‚æ•°-javaagent" tabindex="-1"><a class="header-anchor" href="#_6-1-é…ç½®-vm-å‚æ•°-javaagent" aria-hidden="true">#</a> 6.1 é…ç½® VM å‚æ•° Javaagent</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">-</span>javaagent<span class="token operator">:</span><span class="token class-name">E</span><span class="token operator">:</span>\\itstack\\git\\github<span class="token punctuation">.</span>com\\<span class="token class-name">MonitorDesign</span>\\cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>asm\\target\\cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>asm<span class="token punctuation">.</span>jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>IDEA è¿è¡Œæ—¶å€™é…ç½®åˆ° <code>VM options</code> ä¸­ï¼ŒjaråŒ…åœ°å€æŒ‰ç…§è‡ªå·±çš„è·¯å¾„è¿›è¡Œé…ç½®ã€‚</li></ul><h4 id="_6-2-æµ‹è¯•ç»“æœ" tabindex="-1"><a class="header-anchor" href="#_6-2-æµ‹è¯•ç»“æœ" aria-hidden="true">#</a> 6.2 æµ‹è¯•ç»“æœ</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">Begin</span> <span class="token class-name">By</span> <span class="token constant">ASM</span>
æ–¹æ³•ï¼š<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>test<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span></span>UserController</span>$$<span class="token class-name">EnhancerBySpringCGLIB</span>$$<span class="token number">8f</span><span class="token number">5</span>a18ca<span class="token punctuation">.</span>queryUserInfo
å…¥å‚ï¼š<span class="token keyword">null</span> å…¥å‚ç±»å‹ï¼š<span class="token punctuation">[</span><span class="token string">&quot;Ljava/lang/String;&quot;</span><span class="token punctuation">]</span> å…¥æ•°<span class="token punctuation">[</span>å€¼<span class="token punctuation">]</span>ï¼š<span class="token punctuation">[</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">]</span>
å‡ºå‚ï¼š<span class="token class-name">Lcn</span><span class="token operator">/</span>bugstack<span class="token operator">/</span>middleware<span class="token operator">/</span>test<span class="token operator">/</span>interfaces<span class="token operator">/</span>dto<span class="token operator">/</span><span class="token class-name">UserInfo</span><span class="token punctuation">;</span> å‡ºå‚<span class="token punctuation">[</span>å€¼<span class="token punctuation">]</span>ï¼š<span class="token punctuation">{</span><span class="token string">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;å¤©æ´¥å¸‚ä¸œä¸½åŒºä¸‡ç§‘èµæºªè‹‘14-0000&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token string">&quot;code&quot;</span><span class="token operator">:</span><span class="token string">&quot;0000&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;info&quot;</span><span class="token operator">:</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;è™«è™«:aaa&quot;</span><span class="token punctuation">}</span>
è€—æ—¶ï¼š<span class="token function">54</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">End</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä»è¿è¡Œæµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä½¿ç”¨ ASM ç›‘æ§åï¼Œå°±ä¸éœ€è¦ç¡¬ç¼–ç ä¹Ÿä¸éœ€è¦ AOP çš„æ–¹å¼åœ¨ä»£ç ä¸­æ“ä½œäº†ã€‚åŒæ—¶è¿˜å¯ä»¥ç›‘æ§åˆ°æ›´å®Œæ•´çš„æ–¹æ³•æ‰§è¡Œä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¥å‚ç±»å‹ã€å…¥å‚å€¼å’Œå‡ºå‚ä¿¡æ¯ã€å‡ºå‚å€¼ã€‚</li><li>ä½†å¯èƒ½å¤§å®¶ä¼šå‘ç° ASM æ“ä½œèµ·æ¥è¿˜æ˜¯æŒºéº»çƒ¦çš„ï¼Œå°¤å…¶æ˜¯ä¸€äº›å¾ˆå¤æ‚çš„ç¼–ç é€»è¾‘ä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°å„ç§å„æ ·é—®é¢˜ï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜ä¼šä»‹ç»ä¸€äº›åŸºäº ASM å¼€å‘çš„ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¹Ÿå¯ä»¥å®ç°åŒæ ·çš„åŠŸèƒ½ã€‚</li></ul><h2 id="äº”ã€javassist" tabindex="-1"><a class="header-anchor" href="#äº”ã€javassist" aria-hidden="true">#</a> äº”ã€Javassist</h2><blockquote><p>Javassistæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»ºJavaå­—èŠ‚ç çš„ç±»åº“ã€‚æ˜¯ç”±ä¸œäº¬å·¥ä¸šå¤§å­¦çš„æ•°å­¦å’Œè®¡ç®—æœºç§‘å­¦ç³»çš„ Shigeru Chiba ï¼ˆåƒå¶ æ»‹ï¼‰æ‰€åˆ›å»ºçš„ã€‚å®ƒå·²åŠ å…¥äº†å¼€æ”¾æºä»£ç JBoss åº”ç”¨æœåŠ¡å™¨é¡¹ç›®ï¼Œé€šè¿‡ä½¿ç”¨Javassistå¯¹å­—èŠ‚ç æ“ä½œä¸ºJBosså®ç°åŠ¨æ€&quot;AOP&quot;æ¡†æ¶ã€‚</p></blockquote><h3 id="_1-å…ˆæ¥ä¸ªæµ‹è¯•-1" tabindex="-1"><a class="header-anchor" href="#_1-å…ˆæ¥ä¸ªæµ‹è¯•-1" aria-hidden="true">#</a> 1. å…ˆæ¥ä¸ªæµ‹è¯•</h3><p><strong>cn.bugstack.middleware.monitor.test.ApiTest</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">&quot;cn.bugstack.middleware.javassist.MathUtil&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å±æ€§å­—æ®µ</span>
        <span class="token class-name">CtField</span> ctField <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtField</span><span class="token punctuation">(</span><span class="token class-name">CtClass</span><span class="token punctuation">.</span>doubleType<span class="token punctuation">,</span> <span class="token string">&quot;Ï€&quot;</span><span class="token punctuation">,</span> ctClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctField<span class="token punctuation">.</span><span class="token function">setModifiers</span><span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span> <span class="token operator">+</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">STATIC</span> <span class="token operator">+</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">FINAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">addField</span><span class="token punctuation">(</span>ctField<span class="token punctuation">,</span> <span class="token string">&quot;3.14&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ–¹æ³•ï¼šæ±‚åœ†é¢ç§¯</span>
        <span class="token class-name">CtMethod</span> calculateCircularArea <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtMethod</span><span class="token punctuation">(</span><span class="token class-name">CtClass</span><span class="token punctuation">.</span>doubleType<span class="token punctuation">,</span> <span class="token string">&quot;calculateCircularArea&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CtClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">CtClass</span><span class="token punctuation">.</span>doubleType<span class="token punctuation">}</span><span class="token punctuation">,</span> ctClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        calculateCircularArea<span class="token punctuation">.</span><span class="token function">setModifiers</span><span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">PUBLIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        calculateCircularArea<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">&quot;{return Ï€ * $1 * $1;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">addMethod</span><span class="token punctuation">(</span>calculateCircularArea<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ–¹æ³•ï¼›ä¸¤æ•°ä¹‹å’Œ</span>
        <span class="token class-name">CtMethod</span> sumOfTwoNumbers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtMethod</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;sumOfTwoNumbers&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CtClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">CtClass</span><span class="token punctuation">.</span>doubleType<span class="token punctuation">,</span> <span class="token class-name">CtClass</span><span class="token punctuation">.</span>doubleType<span class="token punctuation">}</span><span class="token punctuation">,</span> ctClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sumOfTwoNumbers<span class="token punctuation">.</span><span class="token function">setModifiers</span><span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">PUBLIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sumOfTwoNumbers<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span><span class="token string">&quot;{return Double.valueOf($1 + $2);}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">addMethod</span><span class="token punctuation">(</span>sumOfTwoNumbers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¾“å‡ºç±»çš„å†…å®¹</span>
        ctClass<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æµ‹è¯•è°ƒç”¨</span>
        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Method</span> method_calculateCircularArea <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;calculateCircularArea&quot;</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj_01 <span class="token operator">=</span> method_calculateCircularArea<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">1.23</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;åœ†é¢ç§¯ï¼š&quot;</span> <span class="token operator">+</span> obj_01<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Method</span> method_sumOfTwoNumbers <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;sumOfTwoNumbers&quot;</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj_02 <span class="token operator">=</span> method_sumOfTwoNumbers<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä¸¤æ•°å’Œï¼š&quot;</span> <span class="token operator">+</span> obj_02<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Javassist ç”Ÿæˆçš„æ±‚åœ†é¢ç§¯å’ŒæŠ½è±¡çš„ç±»å’Œæ–¹æ³•å¹¶è¿è¡Œç»“æœçš„è¿‡ç¨‹ï¼Œå¯ä»¥çœ‹åˆ° Javassist ä¸»è¦æ˜¯ ClassPoolã€CtClassã€CtFieldã€CtMethod ç­‰æ–¹æ³•çš„ä½¿ç”¨ã€‚</li><li>æµ‹è¯•ç»“æœä¸»è¦åŒ…æ‹¬ä¼šç”Ÿæˆä¸€ä¸ªæŒ‡å®šè·¯å¾„ä¸‹çš„ç±» <code>cn.bugstack.middleware.javassist.MathUtil</code>ï¼ŒåŒæ—¶è¿˜ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºç»“æœã€‚</li></ul><p><strong>ç”Ÿæˆçš„ç±»</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MathUtil</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> Ï€ <span class="token operator">=</span> <span class="token number">3.14D</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">calculateCircularArea</span><span class="token punctuation">(</span><span class="token keyword">double</span> var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">3.14D</span> <span class="token operator">*</span> var1 <span class="token operator">*</span> var1<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">Double</span> <span class="token function">sumOfTwoNumbers</span><span class="token punctuation">(</span><span class="token keyword">double</span> var1<span class="token punctuation">,</span> <span class="token keyword">double</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> var1 <span class="token operator">+</span> var3<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">MathUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>åœ†é¢ç§¯ï¼š<span class="token number">4.750506</span>
ä¸¤æ•°å’Œï¼š<span class="token number">3.0</span>

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„-1" tabindex="-1"><a class="header-anchor" href="#_2-ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„-1" aria-hidden="true">#</a> 2. ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>javassist
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>monitor
    â”‚   â”‚       â”œâ”€â”€ config
    â”‚   â”‚       â”‚   â””â”€â”€ <span class="token class-name">MethodDescription</span><span class="token punctuation">.</span>java
    â”‚   â”‚       â”œâ”€â”€ probe
    â”‚   â”‚       â”‚   â”œâ”€â”€ <span class="token class-name">Monitor</span><span class="token punctuation">.</span>java
    â”‚   â”‚       â”‚   â””â”€â”€ <span class="token class-name">MyMonitorTransformer</span><span class="token punctuation">.</span>java
    â”‚   â”‚       â””â”€â”€ <span class="token class-name">PreMain</span><span class="token punctuation">.</span>java
    â”‚   â””â”€â”€ resources
    â”‚       â””â”€â”€ <span class="token constant">META_INF</span>
    â”‚           â””â”€â”€ <span class="token constant">MANIFEST</span><span class="token punctuation">.</span><span class="token constant">MF</span>
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>test
                â””â”€â”€ <span class="token class-name">ApiTest</span><span class="token punctuation">.</span>java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ•´ä¸ªä½¿ç”¨ javassist å®ç°çš„ç›‘æ§æ¡†æ¶æ¥çœ‹ï¼Œä¸ ASM çš„ç»“æ„éå¸¸ç›¸ä¼¼ï¼Œä½†å¤§éƒ¨åˆ†æ“ä½œå­—èŠ‚ç çš„å·¥ä½œéƒ½äº¤ç»™äº† javassist æ¡†æ¶æ¥å¤„ç†ï¼Œæ‰€ä»¥æ•´ä¸ªä»£ç ç»“æ„çœ‹ä¸Šå»æ›´ç®€å•äº†ã€‚</li></ul><h3 id="_3-ç›‘æ§æ–¹æ³•æ’æ¡©" tabindex="-1"><a class="header-anchor" href="#_3-ç›‘æ§æ–¹æ³•æ’æ¡©" aria-hidden="true">#</a> 3. ç›‘æ§æ–¹æ³•æ’æ¡©</h3><p><strong>cn.bugstack.middleware.monitor.probe.MyMonitorTransformer</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMonitorTransformer</span> <span class="token keyword">implements</span> <span class="token class-name">ClassFileTransformer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> classNameSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        classNameSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;cn.bugstack.middleware.test.interfaces.UserController&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span> <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> currentClassName <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>classNameSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>currentClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// æå‡classNameSetä¸­å«æœ‰çš„ç±»</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// è·å–ç±»</span>
            <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> clazzName <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// è·å–æ–¹æ³•</span>
            <span class="token class-name">CtMethod</span> ctMethod <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;queryUserInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> methodName <span class="token operator">=</span> ctMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ–¹æ³•ä¿¡æ¯ï¼šmethodInfo.getDescriptor();</span>
            <span class="token class-name">MethodInfo</span> methodInfo <span class="token operator">=</span> ctMethod<span class="token punctuation">.</span><span class="token function">getMethodInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ–¹æ³•ï¼šå…¥å‚ä¿¡æ¯</span>
            <span class="token class-name">CodeAttribute</span> codeAttribute <span class="token operator">=</span> methodInfo<span class="token punctuation">.</span><span class="token function">getCodeAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">LocalVariableAttribute</span> attr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LocalVariableAttribute</span><span class="token punctuation">)</span> codeAttribute<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">LocalVariableAttribute</span><span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CtClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes <span class="token operator">=</span> ctMethod<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> isStatic <span class="token operator">=</span> <span class="token punctuation">(</span>methodInfo<span class="token punctuation">.</span><span class="token function">getAccessFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">AccessFlag</span><span class="token punctuation">.</span><span class="token constant">STATIC</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// åˆ¤æ–­æ˜¯å¦ä¸ºé™æ€æ–¹æ³•</span>
            <span class="token keyword">int</span> parameterSize <span class="token operator">=</span> isStatic <span class="token operator">?</span> attr<span class="token punctuation">.</span><span class="token function">tableLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> attr<span class="token punctuation">.</span><span class="token function">tableLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// é™æ€ç±»å‹å–å€¼</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameterNameList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>parameterSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// å…¥å‚åç§°</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameterTypeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>parameterSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// å…¥å‚ç±»å‹</span>
            <span class="token class-name">StringBuilder</span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment">// å‚æ•°ç»„è£…ï¼›$1ã€$2...ï¼Œ$$å¯ä»¥è·å–å…¨éƒ¨ï¼Œä½†æ˜¯ä¸èƒ½æ”¾åˆ°æ•°ç»„åˆå§‹åŒ–</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> parameterSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                parameterNameList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span><span class="token function">variableName</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token punctuation">(</span>isStatic <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é™æ€ç±»å‹å»æ‰ç¬¬ä¸€ä¸ªthiså‚æ•°</span>
                parameterTypeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>parameterTypes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">==</span> parameterSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    parameters<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    parameters<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// æ–¹æ³•ï¼šå‡ºå‚ä¿¡æ¯</span>
            <span class="token class-name">CtClass</span> returnType <span class="token operator">=</span> ctMethod<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> returnTypeName <span class="token operator">=</span> returnType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ–¹æ³•ï¼šç”Ÿæˆæ–¹æ³•å”¯ä¸€æ ‡è¯†ID</span>
            <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token class-name">Monitor</span><span class="token punctuation">.</span><span class="token function">generateMethodId</span><span class="token punctuation">(</span>clazzName<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> parameterNameList<span class="token punctuation">,</span> parameterTypeList<span class="token punctuation">,</span> returnTypeName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// å®šä¹‰å±æ€§</span>
            ctMethod<span class="token punctuation">.</span><span class="token function">addLocalVariable</span><span class="token punctuation">(</span><span class="token string">&quot;startNanos&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CtClass</span><span class="token punctuation">.</span>longType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ctMethod<span class="token punctuation">.</span><span class="token function">addLocalVariable</span><span class="token punctuation">(</span><span class="token string">&quot;parameterValues&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ–¹æ³•å‰åŠ å¼º</span>
            ctMethod<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token string">&quot;{ startNanos = System.nanoTime(); parameterValues = new Object[]{&quot;</span> <span class="token operator">+</span> parameters<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;}; }&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ–¹æ³•ååŠ å¼º</span>
            ctMethod<span class="token punctuation">.</span><span class="token function">insertAfter</span><span class="token punctuation">(</span><span class="token string">&quot;{ cn.bugstack.middleware.monitor.probe.Monitor.point(&quot;</span> <span class="token operator">+</span> idx <span class="token operator">+</span> <span class="token string">&quot;, startNanos, parameterValues, $_);}&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¦‚æœè¿”å›ç±»å‹éå¯¹è±¡ç±»å‹ï¼Œ$_ éœ€è¦è¿›è¡Œç±»å‹è½¬æ¢</span>

            <span class="token comment">// æ–¹æ³•ï¼›æ·»åŠ TryCatch</span>
            ctMethod<span class="token punctuation">.</span><span class="token function">addCatch</span><span class="token punctuation">(</span><span class="token string">&quot;{ cn.bugstack.middleware.monitor.probe.Monitor.point(&quot;</span> <span class="token operator">+</span> idx <span class="token operator">+</span> <span class="token string">&quot;, $e); throw $e; }&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;java.lang.Exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// æ·»åŠ å¼‚å¸¸æ•è·</span>

            <span class="token keyword">return</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä¸ ASM å®ç°ç›¸æ¯”ï¼Œæ•´ä½“çš„ç›‘æ§æ–¹æ³•éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæ‰€ä»¥è¿™é‡Œåªå±•ç¤ºä¸‹ä¸åŒçš„åœ°æ–¹ã€‚</li><li>é€šè¿‡ Javassist çš„æ“ä½œï¼Œä¸»è¦æ˜¯å®ç°ä¸€ä¸ª <code>ClassFileTransformer</code> æ¥å£çš„ transform æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è·å–å­—èŠ‚ç å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚</li><li>å¤„ç†è¿‡ç¨‹åŒ…æ‹¬ï¼šè·å–ç±»ã€è·å–æ–¹æ³•ã€è·å–å…¥å‚ä¿¡æ¯ã€è·å–å‡ºå‚ä¿¡æ¯ã€ç»™æ–¹æ³•ç”Ÿæˆå”¯ä¸€IDã€ä¹‹åå¼€å§‹è¿›è¡Œæ–¹æ³•çš„å‰åå¢å¼ºæ“ä½œï¼Œè¿™ä¸ªå¢å¼ºä¹Ÿå°±æ˜¯åœ¨æ–¹æ³•å—ä¸­æ·»åŠ ç›‘æ§ä»£ç ã€‚</li><li>æœ€åè¿”å›å­—èŠ‚ç ä¿¡æ¯ <code>return ctClass.toBytecode();</code> ç°åœ¨ä½ æ–°åŠ å…¥çš„å­—èŠ‚ç å°±å·²ç»å¯ä»¥è¢«ç¨‹åºåŠ è½½å¤„ç†äº†ã€‚</li></ul><h3 id="_4-è¿è¡Œæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_4-è¿è¡Œæµ‹è¯•" aria-hidden="true">#</a> 4. è¿è¡Œæµ‹è¯•</h3><h4 id="_4-1-é…ç½®-vm-å‚æ•°-javaagent" tabindex="-1"><a class="header-anchor" href="#_4-1-é…ç½®-vm-å‚æ•°-javaagent" aria-hidden="true">#</a> 4.1 é…ç½® VM å‚æ•° Javaagent</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">-</span>javaagent<span class="token operator">:</span><span class="token class-name">E</span><span class="token operator">:</span>\\itstack\\git\\github<span class="token punctuation">.</span>com\\<span class="token class-name">MonitorDesign</span>\\cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>javassist\\target\\cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>javassist<span class="token punctuation">.</span>jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>IDEA è¿è¡Œæ—¶å€™é…ç½®åˆ° <code>VM options</code> ä¸­ï¼ŒjaråŒ…åœ°å€æŒ‰ç…§è‡ªå·±çš„è·¯å¾„è¿›è¡Œé…ç½®ã€‚</li></ul><h4 id="_4-2-æµ‹è¯•ç»“æœ" tabindex="-1"><a class="header-anchor" href="#_4-2-æµ‹è¯•ç»“æœ" aria-hidden="true">#</a> 4.2 æµ‹è¯•ç»“æœ</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>ç›‘æ§ <span class="token operator">-</span>  <span class="token class-name">Begin</span> <span class="token class-name">By</span> <span class="token class-name">Javassist</span>
æ–¹æ³•ï¼š<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>test<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span></span>UserController</span>$$<span class="token class-name">EnhancerBySpringCGLIB</span>$$<span class="token number">8f</span><span class="token number">5</span>a18ca<span class="token punctuation">.</span>queryUserInfo
å…¥å‚ï¼š<span class="token keyword">null</span> å…¥å‚ç±»å‹ï¼š<span class="token punctuation">[</span><span class="token string">&quot;Ljava/lang/String;&quot;</span><span class="token punctuation">]</span> å…¥æ•°<span class="token punctuation">[</span>å€¼<span class="token punctuation">]</span>ï¼š<span class="token punctuation">[</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">]</span>
å‡ºå‚ï¼š<span class="token class-name">Lcn</span><span class="token operator">/</span>bugstack<span class="token operator">/</span>middleware<span class="token operator">/</span>test<span class="token operator">/</span>interfaces<span class="token operator">/</span>dto<span class="token operator">/</span><span class="token class-name">UserInfo</span><span class="token punctuation">;</span> å‡ºå‚<span class="token punctuation">[</span>å€¼<span class="token punctuation">]</span>ï¼š<span class="token punctuation">{</span><span class="token string">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;å¤©æ´¥å¸‚ä¸œä¸½åŒºä¸‡ç§‘èµæºªè‹‘14-0000&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token string">&quot;code&quot;</span><span class="token operator">:</span><span class="token string">&quot;0000&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;info&quot;</span><span class="token operator">:</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;è™«è™«:aaa&quot;</span><span class="token punctuation">}</span>
è€—æ—¶ï¼š<span class="token function">46</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">End</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä»æµ‹è¯•ç»“æœæ¥çœ‹ä¸ ASM åšå­—èŠ‚ç æ’æ¡©çš„æ•ˆæœæ˜¯ä¸€æ ·ï¼Œéƒ½å¯ä»¥åšåˆ°ç›‘æ§ç³»ç»Ÿæ‰§è¡Œä¿¡æ¯ã€‚ä½†æ˜¯è¿™æ ·çš„æ¡†æ¶ä¼šä½¿å¼€å‘æµç¨‹æ›´ç®€å•ï¼Œä¹Ÿæ›´å®¹æ˜“æ§åˆ¶ã€‚</li></ul><h2 id="å…­ã€byte-buddy" tabindex="-1"><a class="header-anchor" href="#å…­ã€byte-buddy" aria-hidden="true">#</a> å…­ã€Byte-Buddy</h2><blockquote><p>2015å¹´10æœˆï¼ŒByte Buddyè¢« Oracle æˆäºˆäº† Duke&#39;s Choiceå¤§å¥–ã€‚è¯¥å¥–é¡¹å¯¹Byte Buddyçš„â€œ JavaæŠ€æœ¯æ–¹é¢çš„å·¨å¤§åˆ›æ–° â€è¡¨ç¤ºèµèµã€‚æˆ‘ä»¬ä¸ºè·å¾—æ­¤å¥–é¡¹æ„Ÿåˆ°éå¸¸è£å¹¸ï¼Œå¹¶æ„Ÿè°¢æ‰€æœ‰å¸®åŠ©Byte Buddyå–å¾—æˆåŠŸçš„ç”¨æˆ·ä»¥åŠå…¶ä»–æ‰€æœ‰äººã€‚æˆ‘ä»¬çœŸçš„å¾ˆæ„Ÿæ¿€ï¼</p></blockquote><p><code>Byte Buddy</code> æ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆå’Œæ“ä½œåº“ï¼Œç”¨äºåœ¨ <code>Java</code> åº”ç”¨ç¨‹åºè¿è¡Œæ—¶åˆ›å»ºå’Œä¿®æ”¹ <code>Java</code> ç±»ï¼Œè€Œæ— éœ€ç¼–è¯‘å™¨çš„å¸®åŠ©ã€‚é™¤äº† <code>Java</code> ç±»åº“é™„å¸¦çš„ä»£ç ç”Ÿæˆå®ç”¨ç¨‹åºå¤–ï¼Œ<code>Byte Buddy</code> è¿˜å…è®¸åˆ›å»ºä»»æ„ç±»ï¼Œå¹¶ä¸”ä¸é™äºå®ç°ç”¨äºåˆ›å»ºè¿è¡Œæ—¶ä»£ç†çš„æ¥å£ã€‚æ­¤å¤–ï¼Œ<code>Byte Buddy</code> æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„ APIï¼Œå¯ä»¥ä½¿ç”¨ <code>Java</code> ä»£ç†æˆ–åœ¨æ„å»ºè¿‡ç¨‹ä¸­æ‰‹åŠ¨æ›´æ”¹ç±»ã€‚</p><ul><li>æ— éœ€ç†è§£å­—èŠ‚ç æŒ‡ä»¤ï¼Œå³å¯ä½¿ç”¨ç®€å•çš„ API å°±èƒ½å¾ˆå®¹æ˜“æ“ä½œå­—èŠ‚ç ï¼Œæ§åˆ¶ç±»å’Œæ–¹æ³•ã€‚</li><li>å·²æ”¯æŒJava 11ï¼Œåº“è½»é‡ï¼Œä»…å–å†³äºJavaå­—èŠ‚ä»£ç è§£æå™¨åº“ASMçš„è®¿é—®è€…APIï¼Œå®ƒæœ¬èº«ä¸éœ€è¦ä»»ä½•å…¶ä»–ä¾èµ–é¡¹ã€‚</li><li>æ¯”èµ·JDKåŠ¨æ€ä»£ç†ã€cglibã€Javassistï¼ŒByte Buddyåœ¨æ€§èƒ½ä¸Šå…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ã€‚</li></ul><h3 id="_1-å…ˆæ¥ä¸ªæµ‹è¯•-2" tabindex="-1"><a class="header-anchor" href="#_1-å…ˆæ¥ä¸ªæµ‹è¯•-2" aria-hidden="true">#</a> 1. å…ˆæ¥ä¸ªæµ‹è¯•</h3><p><strong>cn.bugstack.middleware.monitor.test.ApiTest</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> helloWorld <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBuddy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">subclass</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">&quot;toString&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">FixedValue</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">ApiTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>helloWorld<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ ByteBuddy è¯­æ³•ç”Ÿæˆçš„ &quot;Hello World!&quot; æ¡ˆä¾‹ï¼Œä»–çš„è¿è¡Œç»“æœå°±æ˜¯ä¸€è¡Œï¼Œ<code>Hello World!</code>ï¼Œæ•´ä¸ªä»£ç å—æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯é€šè¿‡ <code>method(named(&quot;toString&quot;))</code>ï¼Œæ‰¾åˆ° <em>toString</em> æ–¹æ³•ï¼Œå†é€šè¿‡æ‹¦æˆª <code>intercept</code>ï¼Œè®¾å®šæ­¤æ–¹æ³•çš„è¿”å›å€¼ã€‚<code>FixedValue.value(&quot;Hello World!&quot;)</code>ã€‚åˆ°è¿™é‡Œå…¶å®ä¸€ä¸ªåŸºæœ¬çš„æ–¹æ³•å°±é€šè¿‡ <code>Byte-buddy</code> ï¼Œæœ€ååŠ è½½ã€åˆå§‹åŒ–å’Œè°ƒç”¨è¾“å‡ºã€‚</li></ul><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Hello</span> <span class="token class-name">World</span><span class="token operator">!</span>

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„-2" tabindex="-1"><a class="header-anchor" href="#_2-ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„-2" aria-hidden="true">#</a> 2. ç›‘æ§è®¾è®¡å·¥ç¨‹ç»“æ„</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>bytebuddy
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>monitor
    â”‚   â”‚       â”œâ”€â”€ <span class="token class-name">MonitorMethod</span>
    â”‚   â”‚       â””â”€â”€ <span class="token class-name">PreMain</span><span class="token punctuation">.</span>java
    â”‚   â””â”€â”€ resources
    â”‚       â””â”€â”€ <span class="token constant">META_INF</span>
    â”‚           â””â”€â”€ <span class="token constant">MANIFEST</span><span class="token punctuation">.</span><span class="token constant">MF</span>
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>test
                â””â”€â”€ <span class="token class-name">ApiTest</span><span class="token punctuation">.</span>java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™æ˜¯æˆ‘ä¸ªäººæœ€å–œæ¬¢çš„ä¸€ä¸ªæ¡†æ¶ï¼Œå› ä¸ºå®ƒæ“ä½œçš„æ–¹ä¾¿æ€§ï¼Œå¯ä»¥åƒä½¿ç”¨æ™®é€šçš„ä¸šåŠ¡ä»£ç ä¸€æ ·ä½¿ç”¨å­—èŠ‚ç å¢å¼ºçš„æ“ä½œã€‚ä»ç°åœ¨çš„å·¥ç¨‹ç»“æ„ä½ èƒ½çœ‹å¾—å‡ºæ¥ï¼Œä»£ç ç±»æ•°é‡è¶Šæ¥è¶Šå°‘äº†ã€‚</li></ul><h3 id="_3-ç›‘æ§æ–¹æ³•æ’æ¡©-1" tabindex="-1"><a class="header-anchor" href="#_3-ç›‘æ§æ–¹æ³•æ’æ¡©-1" aria-hidden="true">#</a> 3. ç›‘æ§æ–¹æ³•æ’æ¡©</h3><p><strong>cn.bugstack.middleware.monitor.MonitorMethod</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MonitorMethod</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RuntimeType</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Origin</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@SuperCall</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">,</span> <span class="token annotation punctuation">@AllArguments</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> resObj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            resObj <span class="token operator">=</span> callable<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> resObj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘æ§ - Begin By Byte-buddy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–¹æ³•åç§°ï¼š&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å…¥å‚ä¸ªæ•°ï¼š&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getParameterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> method<span class="token punctuation">.</span><span class="token function">getParameterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å…¥å‚ Idxï¼š&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ç±»å‹ï¼š&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; å†…å®¹ï¼š&quot;</span> <span class="token operator">+</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å‡ºå‚ç±»å‹ï¼š&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å‡ºå‚ç»“æœï¼š&quot;</span> <span class="token operator">+</span> resObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–¹æ³•è€—æ—¶ï¼š&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘æ§ - End\\r\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>@Origin</code>ï¼Œç”¨äºæ‹¦æˆªåŸæœ‰æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥è·å–åˆ°æ–¹æ³•ä¸­çš„ç›¸å…³ä¿¡æ¯ã€‚</li><li>è¿™ä¸€éƒ¨åˆ†çš„ä¿¡æ¯ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå…¨ï¼Œå°¤å…¶ä¹Ÿè·å–åˆ°äº†å‚æ•°çš„ä¸ªæ•°å’Œç±»å‹ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åç»­çš„å¤„ç†å‚æ•°æ—¶è¿›è¡Œå¾ªç¯è¾“å‡ºã€‚</li></ul><p><strong>å¸¸ç”¨æ³¨è§£è¯´æ˜</strong></p><p>é™¤äº†ä»¥ä¸Šä¸ºäº†è·å–æ–¹æ³•çš„æ‰§è¡Œä¿¡æ¯ä½¿ç”¨åˆ°çš„æ³¨è§£å¤–ï¼ŒByte Buddy è¿˜æä¾›äº†å¾ˆå¤šå…¶ä»–çš„æ³¨è§£ã€‚å¦‚ä¸‹ï¼›</p><table><thead><tr><th style="text-align:left;">æ³¨è§£</th><th style="text-align:left;">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left;">@Argument</td><td style="text-align:left;">ç»‘å®šå•ä¸ªå‚æ•°</td></tr><tr><td style="text-align:left;">@AllArguments</td><td style="text-align:left;">ç»‘å®šæ‰€æœ‰å‚æ•°çš„æ•°ç»„</td></tr><tr><td style="text-align:left;">@This</td><td style="text-align:left;">å½“å‰è¢«æ‹¦æˆªçš„ã€åŠ¨æ€ç”Ÿæˆçš„é‚£ä¸ªå¯¹è±¡</td></tr><tr><td style="text-align:left;">@Super</td><td style="text-align:left;">å½“å‰è¢«æ‹¦æˆªçš„ã€åŠ¨æ€ç”Ÿæˆçš„é‚£ä¸ªå¯¹è±¡çš„çˆ¶ç±»å¯¹è±¡</td></tr><tr><td style="text-align:left;">@Origin</td><td style="text-align:left;">å¯ä»¥ç»‘å®šåˆ°ä»¥ä¸‹ç±»å‹çš„å‚æ•°ï¼šMethod è¢«è°ƒç”¨çš„åŸå§‹æ–¹æ³• Constructor è¢«è°ƒç”¨çš„åŸå§‹æ„é€ å™¨ Class å½“å‰åŠ¨æ€åˆ›å»ºçš„ç±» MethodHandle MethodType String åŠ¨æ€ç±»çš„toString()çš„è¿”å›å€¼ int åŠ¨æ€æ–¹æ³•çš„ä¿®é¥°ç¬¦</td></tr><tr><td style="text-align:left;">@DefaultCall</td><td style="text-align:left;">è°ƒç”¨é»˜è®¤æ–¹æ³•è€Œésuperçš„æ–¹æ³•</td></tr><tr><td style="text-align:left;">@SuperCall</td><td style="text-align:left;">ç”¨äºè°ƒç”¨çˆ¶ç±»ç‰ˆæœ¬çš„æ–¹æ³•</td></tr><tr><td style="text-align:left;">@Super</td><td style="text-align:left;">æ³¨å…¥çˆ¶ç±»å‹å¯¹è±¡ï¼Œå¯ä»¥æ˜¯æ¥å£ï¼Œä»è€Œè°ƒç”¨å®ƒçš„ä»»ä½•æ–¹æ³•</td></tr><tr><td style="text-align:left;">@RuntimeType</td><td style="text-align:left;">å¯ä»¥ç”¨åœ¨è¿”å›å€¼ã€å‚æ•°ä¸Šï¼Œæç¤ºByteBuddyç¦ç”¨ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥</td></tr><tr><td style="text-align:left;">@Empty</td><td style="text-align:left;">æ³¨å…¥å‚æ•°çš„ç±»å‹çš„é»˜è®¤å€¼</td></tr><tr><td style="text-align:left;">@StubValue</td><td style="text-align:left;">æ³¨å…¥ä¸€ä¸ªå­˜æ ¹å€¼ã€‚å¯¹äºè¿”å›å¼•ç”¨ã€voidçš„æ–¹æ³•ï¼Œæ³¨å…¥nullï¼›å¯¹äºè¿”å›åŸå§‹ç±»å‹çš„æ–¹æ³•ï¼Œæ³¨å…¥0</td></tr><tr><td style="text-align:left;">@FieldValue</td><td style="text-align:left;">æ³¨å…¥è¢«æ‹¦æˆªå¯¹è±¡çš„ä¸€ä¸ªå­—æ®µçš„å€¼</td></tr><tr><td style="text-align:left;">@Morph</td><td style="text-align:left;">ç±»ä¼¼äº@SuperCallï¼Œä½†æ˜¯å…è®¸æŒ‡å®šè°ƒç”¨å‚æ•°</td></tr></tbody></table><p><strong>å¸¸ç”¨æ ¸å¿ƒAPI</strong></p><ol><li><p>ByteBuddy</p><ul><li>æµå¼APIæ–¹å¼çš„å…¥å£ç±»</li><li>æä¾›Subclassing/Redefining/Rebasingæ–¹å¼æ”¹å†™å­—èŠ‚ç </li><li>æ‰€æœ‰çš„æ“ä½œä¾èµ–DynamicType.Builderè¿›è¡Œ,åˆ›å»ºä¸å¯å˜çš„å¯¹è±¡</li></ul></li><li><p>ElementMatchers(ElementMatcher)</p><ul><li>æä¾›ä¸€ç³»åˆ—çš„å…ƒç´ åŒ¹é…çš„å·¥å…·ç±»(named/any/nameEndsWithç­‰ç­‰)</li><li>ElementMatcher(æä¾›å¯¹ç±»å‹ã€æ–¹æ³•ã€å­—æ®µã€æ³¨è§£è¿›è¡Œmatchesçš„æ–¹å¼,ç±»ä¼¼äºPredicate)</li><li>Junctionå¯¹å¤šä¸ªElementMatcherè¿›è¡Œäº†and/oræ“ä½œ</li></ul></li><li><p>DynamicType</p><p>(åŠ¨æ€ç±»å‹,æ‰€æœ‰å­—èŠ‚ç æ“ä½œçš„å¼€å§‹,éå¸¸å€¼å¾—å…³æ³¨)</p><ul><li>Unloaded(åŠ¨æ€åˆ›å»ºçš„å­—èŠ‚ç è¿˜æœªåŠ è½½è¿›å…¥åˆ°è™šæ‹Ÿæœº,éœ€è¦ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½)</li><li>Loaded(å·²åŠ è½½åˆ°jvmä¸­å,è§£æå‡ºClassè¡¨ç¤º)</li><li>Default(DynamicTypeçš„é»˜è®¤å®ç°,å®Œæˆç›¸å…³å®é™…æ“ä½œ)</li></ul></li><li><p>\`Implementation</p><p>(ç”¨äºæä¾›åŠ¨æ€æ–¹æ³•çš„å®ç°)</p><ul><li>FixedValue(æ–¹æ³•è°ƒç”¨è¿”å›å›ºå®šå€¼)</li><li>MethodDelegation(æ–¹æ³•è°ƒç”¨å§”æ‰˜,æ”¯æŒä¸¤ç§æ–¹å¼: Classçš„staticæ–¹æ³•è°ƒç”¨ã€objectçš„instance methodæ–¹æ³•è°ƒç”¨)</li></ul></li><li><p>Builder</p><p>(ç”¨äºåˆ›å»ºDynamicType,ç›¸å…³æ¥å£ä»¥åŠå®ç°åç»­å¾…è¯¦è§£)</p><ul><li>MethodDefinition</li><li>FieldDefinition</li><li>AbstractBase</li></ul></li></ol><h3 id="_4-é…ç½®å…¥å£æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_4-é…ç½®å…¥å£æ–¹æ³•" aria-hidden="true">#</a> 4. é…ç½®å…¥å£æ–¹æ³•</h3><p><strong>cn.bugstack.middleware.monitor.PreMain</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreMain</span> <span class="token punctuation">{</span>

    <span class="token comment">//JVM é¦–å…ˆå°è¯•åœ¨ä»£ç†ç±»ä¸Šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AgentBuilder<span class="token punctuation">.</span>Transformer</span> transformer <span class="token operator">=</span> <span class="token punctuation">(</span>builder<span class="token punctuation">,</span> typeDescription<span class="token punctuation">,</span> classLoader<span class="token punctuation">,</span> javaModule<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> builder
                    <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">&quot;queryUserInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// æ‹¦æˆªä»»æ„æ–¹æ³•</span>
                    <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">MethodDelegation</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">MonitorMethod</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å§”æ‰˜</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">AgentBuilder
                <span class="token punctuation">.</span>Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span>agentArgs<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// æŒ‡å®šéœ€è¦æ‹¦æˆªçš„ç±» &quot;cn.bugstack.demo.test&quot;</span>
                <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>transformer<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">installOn</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//å¦‚æœä»£ç†ç±»æ²¡æœ‰å®ç°ä¸Šé¢çš„æ–¹æ³•ï¼Œé‚£ä¹ˆ JVM å°†å°è¯•è°ƒç”¨è¯¥æ–¹æ³•</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>premain æ–¹æ³•ä¸­ä¸»è¦æ˜¯å¯¹å®ç°çš„ MonitorMethod è¿›è¡Œå§”æ‰˜ä½¿ç”¨ï¼ŒåŒæ—¶è¿˜åœ¨ method è®¾ç½®äº†æ‹¦æˆªçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ‹¦æˆªæ–¹æ³•è¿˜å¯ä»¥åˆ°ç±»è·¯å¾„ç­‰ã€‚</li></ul><h3 id="_5-è¿è¡Œæµ‹è¯•-1" tabindex="-1"><a class="header-anchor" href="#_5-è¿è¡Œæµ‹è¯•-1" aria-hidden="true">#</a> 5. è¿è¡Œæµ‹è¯•</h3><h4 id="_5-1-é…ç½®-vm-å‚æ•°-javaagent" tabindex="-1"><a class="header-anchor" href="#_5-1-é…ç½®-vm-å‚æ•°-javaagent" aria-hidden="true">#</a> 5.1 é…ç½® VM å‚æ•° Javaagent</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">-</span>javaagent<span class="token operator">:</span><span class="token class-name">E</span><span class="token operator">:</span>\\itstack\\git\\github<span class="token punctuation">.</span>com\\<span class="token class-name">MonitorDesign</span>\\cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>bytebuddy\\target\\cn<span class="token operator">-</span>bugstack<span class="token operator">-</span>middleware<span class="token operator">-</span>bytebuddy<span class="token punctuation">.</span>jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>IDEA è¿è¡Œæ—¶å€™é…ç½®åˆ° <code>VM options</code> ä¸­ï¼ŒjaråŒ…åœ°å€æŒ‰ç…§è‡ªå·±çš„è·¯å¾„è¿›è¡Œé…ç½®ã€‚</li></ul><h4 id="_5-2-æµ‹è¯•ç»“æœ" tabindex="-1"><a class="header-anchor" href="#_5-2-æµ‹è¯•ç»“æœ" aria-hidden="true">#</a> 5.2 æµ‹è¯•ç»“æœ</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">Begin</span> <span class="token class-name">By</span> <span class="token class-name">Byte</span><span class="token operator">-</span>buddy
æ–¹æ³•åç§°ï¼šqueryUserInfo
å…¥å‚ä¸ªæ•°ï¼š<span class="token number">1</span>
å…¥å‚ <span class="token class-name">Idx</span>ï¼š<span class="token number">1</span> ç±»å‹ï¼š<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> å†…å®¹ï¼šaaa
å‡ºå‚ç±»å‹ï¼š<span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>test<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span>UserInfo</span>
å‡ºå‚ç»“æœï¼šcn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>test<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>@<span class="token number">214</span>b199c
æ–¹æ³•è€—æ—¶ï¼š<span class="token number">1</span>ms
ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">End</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Byte-buddy æ˜¯æˆ‘ä»¬æ•´ä¸ªæµ‹è¯•è¿‡ç¨‹çš„å‡ ä¸ªå­—èŠ‚ç æ¡†æ¶ä¸­ï¼Œæ“ä½œèµ·æ¥æœ€ç®€å•ï¼Œæœ€æ–¹ä¾¿çš„ï¼Œä¹Ÿéå¸¸å®¹æ˜“æ‰©å®¹ä¿¡æ¯ã€‚æ•´ä¸ªè¿‡ç¨‹å°±åƒæœ€åˆä½¿ç”¨ AOP ä¸€æ ·ç®€å•ï¼Œä½†å´æ»¡è¶³äº†éå…¥ä¾µçš„ç›‘æ§éœ€æ±‚ã€‚</li><li>æ‰€ä»¥åœ¨ä½¿ç”¨å­—èŠ‚ç æ¡†æ¶çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘é€‰æ‹©ä½¿ç”¨ Byte-buddy è¿™ä¸ªéå¸¸å¥½ç”¨çš„å­—èŠ‚ç æ¡†æ¶ã€‚</li></ul><h2 id="ä¸ƒã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#ä¸ƒã€æ€»ç»“" aria-hidden="true">#</a> ä¸ƒã€æ€»ç»“</h2>`,69),x=n("li",null,"ASM è¿™ç§å­—èŠ‚ç ç¼–ç¨‹çš„åº”ç”¨æ˜¯éå¸¸å¹¿çš„ï¼Œä½†å¯èƒ½ç¡®å®å¹³æ—¶çœ‹ä¸åˆ°çš„ï¼Œå› ä¸ºä»–éƒ½æ˜¯ä¸å…¶ä»–æ¡†æ¶ç»“åˆä¸€èµ·ä½œä¸ºæ”¯æ’‘æœåŠ¡ä½¿ç”¨ã€‚åƒè¿™æ ·çš„æŠ€æœ¯è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ javassitã€Cglibã€jacocoç­‰ç­‰ã€‚",-1),S=n("li",null,"åœ¨ä¸€äº›å…¨é“¾è·¯ç›‘æ§ä¸­çš„ç»„ä»¶ä¸­ Javassist çš„ä½¿ç”¨éå¸¸å¤šï¼Œå®ƒå³å¯ä½¿ç”¨ç¼–ç çš„æ–¹å¼æ“ä½œå­—èŠ‚ç å¢å¼ºï¼Œä¹Ÿå¯ä»¥åƒ ASM é‚£æ ·è¿›è¡Œå¤„ç†ã€‚",-1),A={href:"https://bytebuddy.net/#/",target:"_blank",rel:"noopener noreferrer"},_=n("code",null,"https://bytebuddy.net",-1),I=n("code",null,"Byte Buddy",-1),T={href:"https://github.com/fuzhengwei/MonitorDesign",target:"_blank",rel:"noopener noreferrer"};function B(P,N){const a=o("ExternalLinkIcon");return c(),l("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),r,s("åšå®¢ï¼š"),n("a",k,[s("https://bugstack.cn"),t(a)]),d,s("åŸæ–‡ï¼š"),n("a",m,[s("https://mp.weixin.qq.com/s/9g7O3MSxh5q3F6z-Mxalzg"),t(a)])]),v,n("p",null,[s("åŒæ‰‹æ‹–ç€å›°å€¦çš„è„‘è¢‹ï¼Œä¸€æ—¶åŠä¼šä¹Ÿæƒ³ä¸å‡ºä»€ä¹ˆå¥½æ–¹æ³•ï¼Œ"),b,s("ã€‚ä¹‹åæŠŠä¿¡æ¯åœ¨ç»Ÿä¸€æ”¶é›†èµ·æ¥ï¼Œå±•ç¤ºåˆ°ä¸€ä¸ªç›‘æ§é¡µé¢å‘¢ï¼Œç›‘æ§é¡µé¢ä½¿ç”¨é˜¿å¸•å¥‡çš„ "),n("a",g,[s("echarts"),t(a)]),s("ï¼Œåˆ«è¯´è¦æ˜¯è¿™æ ·æ˜¾ç¤ºäº†ï¼Œè¿˜çœŸèƒ½æŒºå¥½çœ‹è¿˜å¥½ç”¨ã€‚")]),h,n("ul",null,[n("li",null,[s("æºç åœ°å€ï¼š"),n("a",y,[s("https://github.com/fuzhengwei/MonitorDesign"),t(a)])]),f,w]),q,n("ul",null,[j,n("li",null,[s("æ­¤å¤„ä¸»è¦æ˜¯å…³äº ASM çš„æ“ä½œç±»ï¼ŒClassReaderã€ClassWriterã€ClassVisitorï¼Œå…³äºå­—èŠ‚ç ç¼–ç¨‹çš„æ–‡ç« ï¼š"),n("a",M,[s("ASMã€Javassistã€Byte-bu ç³»åˆ—æ–‡ç« "),t(a)])])]),C,n("ul",null,[x,S,n("li",null,[s("Byte-buddy æ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„æ¡†æ¶ï¼Œç›®å‰ä½¿ç”¨ä¹Ÿè¶Šæ¥è¶Šå¹¿æ³›ï¼Œå¹¶ä¸”ä¸Šæ‰‹ä½¿ç”¨çš„å­¦ä¹ éš¾åº¦ä¹Ÿæ˜¯å‡ ä¸ªæ¡†æ¶ä¸­æœ€ä½çš„ã€‚é™¤äº†æœ¬ç« èŠ‚çš„æ¡ˆä¾‹ä½¿ç”¨ä»‹ç»å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡å®˜ç½‘ï¼š"),n("a",A,[_,t(a)]),s("ï¼Œå»äº†è§£æ›´å¤šå…³äº "),I,s(" çš„å†…å®¹ã€‚")]),n("li",null,[s("æœ¬ç« èŠ‚æ‰€æœ‰çš„æºç å·²ç»ä¸Šä¼ åˆ°GitHubï¼š"),n("a",T,[s("https://github.com/fuzhengwei/MonitorDesign"),t(a)])])])])}const E=p(i,[["render",B],["__file","2021-07-19-diaoyanzijiemachazhuangjishuï¼Œyongyuxitongjiankongshejiheshixian.html.vue"]]);export{E as default};
