import{_ as e,r as o,o as p,c,a as n,b as s,d as t,e as i}from"./app-3RcBQnkC.js";const l={},u=n("h1",{id:"第08节-活动领域的配置与状态",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#第08节-活动领域的配置与状态","aria-hidden":"true"},"#"),s(" 第08节：活动领域的配置与状态")],-1),r=n("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=n("blockquote",null,[n("p",null,"沉淀、分享、成长，让自己和他人都能有所收获！")],-1),v={href:"https://gitcode.net/KnowledgePlanet/Lottery/-/tree/210911_xfg_activity",target:"_blank",rel:"noopener noreferrer"},m=n("li",null,"描述：开发活动领域部分功能，包括：活动创建、活动状态变更。主要以 domain 领域层下添加 activity 为主，并在对应的 service 中添加 deploy(创建活动)、partake(领取活动，待开发)、stateflow(状态流转) 三个模块。以及调整仓储服务实现到基础层。",-1),y=n("h2",{id:"零、优秀作业",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#零、优秀作业","aria-hidden":"true"},"#"),s(" 零、优秀作业")],-1),h={href:"https://t.zsxq.com/06by3jYFe",target:"_blank",rel:"noopener noreferrer"},g={href:"https://t.zsxq.com/06vzNVVfQ",target:"_blank",rel:"noopener noreferrer"},f={href:"https://t.zsxq.com/06mu7qnyJ",target:"_blank",rel:"noopener noreferrer"},b={href:"https://t.zsxq.com/06qzzvBY7",target:"_blank",rel:"noopener noreferrer"},_={href:"https://t.zsxq.com/067MvRjMR",target:"_blank",rel:"noopener noreferrer"},q={href:"https://t.zsxq.com/06BYZrfq3",target:"_blank",rel:"noopener noreferrer"},x={href:"https://t.zsxq.com/06BeEmMJu",target:"_blank",rel:"noopener noreferrer"},w={href:"https://t.zsxq.com/06eMrzNFu",target:"_blank",rel:"noopener noreferrer"},A={href:"https://t.zsxq.com/0ceEsHmkN",target:"_blank",rel:"noopener noreferrer"},z={href:"https://t.zsxq.com/0fl3qvi4d",target:"_blank",rel:"noopener noreferrer"},D=i(`<h2 id="一、开发日志" tabindex="-1"><a class="header-anchor" href="#一、开发日志" aria-hidden="true">#</a> 一、开发日志</h2><ul><li>按照 DDD 模型，调整包引用 lottery-infrastructure 引入 lottery-domain，调整后效果<code>领域层 domain</code> 定义仓储接口，<code>基础层 infrastructure</code> 实现仓储接口。</li><li>活动领域层需要提供的功能包括：活动创建、活动状态处理和用户领取活动操作，本章节先实现前两个需求，下个章节继续开发其他功能。</li><li>活动创建的操作主要会用到事务，因为活动系统提供给运营后台创建活动时，需要包括：活动信息、奖品信息、策略信息、策略明细以及其他额外扩展的内容，这些信息都需要在一个事务下进行落库。</li><li>活动状态的审核，【1编辑、2提审、3撤审、4通过、5运行(审核通过后worker扫描状态)、6拒绝、7关闭、8开启】，这里我们会用到设计模式中的<code>状态模式</code>进行处理。</li></ul><h2 id="二、活动创建" tabindex="-1"><a class="header-anchor" href="#二、活动创建" aria-hidden="true">#</a> 二、活动创建</h2><p><strong>cn.itedus.lottery.domain.activity.service.deploy.impl.ActivityDeployImpl</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityDeployImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IActivityDeploy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ActivityDeployImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IActivityRepository</span> activityRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityConfigReq</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;创建活动配置开始，activityId：{}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ActivityConfigRich</span> activityConfigRich <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getActivityConfigRich</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 添加活动配置</span>
            <span class="token class-name">ActivityVO</span> activity <span class="token operator">=</span> activityConfigRich<span class="token punctuation">.</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activityRepository<span class="token punctuation">.</span><span class="token function">addActivity</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 添加奖品配置</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AwardVO</span><span class="token punctuation">&gt;</span></span> awardList <span class="token operator">=</span> activityConfigRich<span class="token punctuation">.</span><span class="token function">getAwardList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activityRepository<span class="token punctuation">.</span><span class="token function">addAward</span><span class="token punctuation">(</span>awardList<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 添加策略配置</span>
            <span class="token class-name">StrategyVO</span> strategy <span class="token operator">=</span> activityConfigRich<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activityRepository<span class="token punctuation">.</span><span class="token function">addStrategy</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 添加策略明细配置</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StrategyDetailVO</span><span class="token punctuation">&gt;</span></span> strategyDetailList <span class="token operator">=</span> activityConfigRich<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStrategyDetailList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activityRepository<span class="token punctuation">.</span><span class="token function">addStrategyDetailList</span><span class="token punctuation">(</span>strategyDetailList<span class="token punctuation">)</span><span class="token punctuation">;</span>

            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;创建活动配置完成，activityId：{}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DuplicateKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;创建活动配置失败，唯一索引冲突 activityId：{} reqJson：{}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">getActivityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityConfigReq</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO: 非核心功能后续补充</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5);function R(L,I){const a=o("ExternalLinkIcon");return p(),c("div",null,[u,n("p",null,[s("作者：小傅哥 "),r,s("博客："),n("a",k,[s("https://bugstack.cn"),t(a)])]),d,n("ul",null,[n("li",null,[s("分支："),n("a",v,[s("210911_xfg_activity"),t(a)])]),m]),y,n("ul",null,[n("li",null,[n("a",h,[s("为什么仓储接口定义在领域层？@拿笔小星"),t(a)])]),n("li",null,[n("a",g,[s("活动领域的配置与状态 @一点江南"),t(a)])]),n("li",null,[n("a",f,[s("把domain包引入infrastructure包改成infrastructure引入domain，为什么它会更符合DDD领域设计？@我的旅途"),t(a)])]),n("li",null,[n("a",b,[s("活动领域的配置与状态 @BerserkD"),t(a)])]),n("li",null,[n("a",_,[s("更改domain层和基础层结构，第八章是活动领域的部分代码，有创建活动功能以及活动状态处理的实现 @Chin"),t(a)])]),n("li",null,[n("a",q,[s("活动领域的配置与状态 @Geroge Liu"),t(a)])]),n("li",null,[n("a",x,[s("开发活动领域部分功能，包括活动创建（涉及到数据落表，用到事务）、活动状态变更（用到设计模式中的状态模式） @liuc"),t(a)])]),n("li",null,[n("a",w,[s("在应用层编排抽奖过程 @liuc"),t(a)])]),n("li",null,[n("a",A,[s("项目过程中遇到的bug以及经验总结 @锚"),t(a)])]),n("li",null,[n("a",z,[s("活动领域的配置与状态学习总结 @爱幻想"),t(a)])])]),D])}const S=e(l,[["render",R],["__file","di08jie：huodonglingyudepeizhiyuzhuangtai.html.vue"]]);export{S as default};
