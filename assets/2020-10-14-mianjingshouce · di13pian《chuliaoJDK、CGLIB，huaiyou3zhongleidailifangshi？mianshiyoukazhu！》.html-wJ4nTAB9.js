import{_ as e,r as c,o,c as l,a as n,b as s,d as t,e as p}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"é¢ç»æ‰‹å†Œ-Â·-ç¬¬13ç¯‡ã€Šé™¤äº†jdkã€cglib-è¿˜æœ‰3ç§ç±»ä»£ç†æ–¹å¼-é¢è¯•åˆå¡ä½-ã€‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#é¢ç»æ‰‹å†Œ-Â·-ç¬¬13ç¯‡ã€Šé™¤äº†jdkã€cglib-è¿˜æœ‰3ç§ç±»ä»£ç†æ–¹å¼-é¢è¯•åˆå¡ä½-ã€‹","aria-hidden":"true"},"#"),s(" é¢ç»æ‰‹å†Œ Â· ç¬¬13ç¯‡ã€Šé™¤äº†JDKã€CGLIBï¼Œè¿˜æœ‰3ç§ç±»ä»£ç†æ–¹å¼ï¼Ÿé¢è¯•åˆå¡ä½ï¼ã€‹")],-1),k=n("br",null,null,-1),r={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=p('<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>ç¼–ç¨‹å­¦ä¹ ï¼Œå…ˆé“ºå®½åº¦è¿˜æ˜¯æŒ–æ·±åº¦ï¼Ÿ</code></p><p>å…¶å®æŠ€æœ¯å®½åº¦ä¸æŠ€æœ¯æ·±åº¦æ˜¯ç›¸è¾…ç›¸æˆçš„ï¼Œä½ èƒ½äº†è§£å¤šå°‘æŠ€æœ¯æ˜¯å’Œä½ å¯¹ä¸€ä¸ªæŠ€æœ¯çš„ç†è§£æ·±åº¦æœ‰å…³ï¼Œè€Œä½ èƒ½å¯¹ä¸€ä¸ªæŠ€æœ¯æ¢ç©¶çš„å¤šæ·±åˆæ˜¯éœ€è¦ä½ æœ‰ä¸€å®šçš„å¹¿åº¦è®¤çŸ¥ã€‚å¦åˆ™å¦‚æœåªå»äº†è§£çš®æ¯›æˆ–è€…æ­»ç£•ä¸€æ®µä»£ç ï¼Œæ”¶è·éƒ½ä¸ä¸€å®šæœ‰å¤šå¤§ï¼Œæˆ–è€…è¦ä»˜å‡ºå¾ˆå¤§çš„æˆæœ¬ã€‚</p><p><code>æŠ€æœ¯ç“¶é¢ˆï¼Œä¸å¹´é¾„ç›¸å…³è¿˜æ˜¯å¤§å‚ï¼Ÿ</code></p><p>äº²èº«å½“è¿‡é¢è¯•å®˜å¾ˆä¹…ï¼Œä¹Ÿé¢è¯•è¿‡å¾ˆå¤šäººã€‚æœ‰æ—¶å€™ä¸ä¸€å®šå¹´é¾„å¾ˆå¤§å°±æŠ€æœ¯å¥½ï¼Œä¹Ÿä¸ä¸€å®šåˆšå·¥ä½œ2å¹´å·¦å³å°±ä¸è¡Œã€‚å¾€å¾€æˆ‘ä»¬è¯´çš„ä¸€äº›é¢è¯•é€ ç«ç®­ï¼Œä½†æ˜¯åœ¨è¿™äº›æ±‚èŒè€…çš„å›ç­”ä¸­ï¼Œéƒ½èƒ½ç»™å‡ºéå¸¸å‡†ç¡®çš„ç­”æ¡ˆã€‚ä¹Ÿå°±æ˜¯ä»–èƒ½å›ç­”åˆ°ç‚¹ä¸Šï¼Œè¿™æ˜¯æ‡‚äº†æ‰èƒ½åšåˆ°çš„ã€‚</p><p>å·¥ä½œæ—¶é•¿ä¸æ˜¯å¦åœ¨å¤§å‚ï¼Œè¿™äº›éƒ½æ˜¯èƒ½æ¥è§¦åˆ°èµ„æºçš„å¤šå°‘ï¼Œçœ‹åˆ°æŠ€æœ¯è§è¯†çš„é«˜åº¦ã€‚ä½†çœŸçš„æƒ³æŠŠè¿™äº›ä¸œè¥¿å¸æ”¶ç»™è‡ªå·±ï¼Œè¿˜æ˜¯éœ€è¦ä¸ªäººçš„æ‹¼æã€‚å¦åˆ™å¾ˆå¤šä¸œè¥¿å³ä½¿æ‘†åœ¨ä½ é¢å‰ï¼Œä½ ä¹Ÿå¾ˆéš¾çœ‹åˆ°ã€‚<em>ä½ èƒ½çœ‹åˆ°çš„å¤šæ•°æ—¶å€™åªæ˜¯æ ‡é¢˜</em></p><h2 id="äºŒã€é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#äºŒã€é¢è¯•é¢˜" aria-hidden="true">#</a> äºŒã€é¢è¯•é¢˜</h2>',8),v=n("code",null,"è°¢é£æœºï¼Œå°è®°",-1),m={href:"https://bugstack.cn/",target:"_blank",rel:"noopener noreferrer"},b=p(`<p><strong>é¢è¯•å®˜</strong>ï¼šé£æœºï¼Œçœ‹ä½ æ…Œé‡Œæ…Œå¼ çš„å‘¢ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šæ²¡æœ‰ï¼Œæ²¡æœ‰ï¼Œåˆšæ‰æ€•æ¥ä¸åŠè·‘ä¸Šæ¥¼çš„ã€‚</p><p><strong>é¢è¯•å®˜</strong>ï¼šå¥½ï¼æˆ‘çœ‹ä½ çš„ç®€å†ä¹Ÿæ²¡æ›´æ–°ï¼Œé‚£æˆ‘ä»¬è¿™æ¬¡èŠèŠåŠ¨æ€ä»£ç†å’Œåå°„å§ï¼Œä½ äº†è§£æ€ä¹ˆä»£ç†ä¸€ä¸ªç±»å—ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šè¿™ä¸ªæˆ‘çŸ¥é“ï¼Œä½¿ç”¨JDKè‡ªå¸¦çš„ç±»<code>Proxy</code>å¯ä»¥ä»£ç†ä¸€ä¸ªç±»ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨CGLIBä»£ç†ã€‚</p><p><strong>é¢è¯•å®˜</strong>ï¼šå—¯ï¼Œé‚£è¿™ä¸¤ä¸ªä»£ç†æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šå¥½åƒä¸€ä¸ªæ˜¯JDKçš„éœ€è¦æœ‰æ¥å£ï¼ŒCGLIBçš„ä¸éœ€è¦ã€‚</p><p><strong>é¢è¯•å®˜</strong>ï¼šä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šä¸ºä»€ä¹ˆï¼Ÿè¿™...</p><p><strong>é¢è¯•å®˜</strong>ï¼šé‚£ä½ è‡ªå·±å¼€å‘æ—¶ï¼Œç”¨ä»£ç†åšä»€ä¹ˆä¸šåŠ¡å—ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼š... å¥½åƒä¹Ÿæ²¡æœ‰ï¼</p><p><code>é£æœºåªèƒ½æºœæºœçš„å›å®¶äº†ï¼ŒæŠ€æœ¯æ·±åº¦ä¸è¶³ï¼Œä¹Ÿæ²¡æœ‰å®é™…åº”ç”¨è¿‡ï¼Œè¿˜éœ€è¦å¾ˆå¤šè¡¥å…¨çš„å†…å®¹ï¼</code></p><h2 id="ä¸‰ã€äº”ç§ç±»ä»£ç†çš„æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€äº”ç§ç±»ä»£ç†çš„æ–¹å¼" aria-hidden="true">#</a> ä¸‰ã€äº”ç§ç±»ä»£ç†çš„æ–¹å¼</h2><p><code>ä¸å‡ºæ„å¤–</code>ï¼Œä½ å¯èƒ½åªçŸ¥é“ä¸¤ç§ç±»ä»£ç†çš„æ–¹å¼ã€‚ä¸€ç§æ˜¯JDKè‡ªå¸¦çš„ï¼Œå¦å¤–ä¸€ç§æ˜¯CGLIBã€‚</p><p>æˆ‘ä»¬å…ˆå®šä¹‰å‡ºä¸€ä¸ªæ¥å£å’Œç›¸åº”çš„å®ç°ç±»ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ä»£ç†ç±»åœ¨æ–¹æ³•ä¸­æ·»åŠ è¾“å‡ºä¿¡æ¯ã€‚</p><p><strong>å®šä¹‰æ¥å£</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserApi</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> <span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®ç°æ¥å£</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserApi</span> <span class="token keyword">implements</span> <span class="token class-name">IUserApi</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;å°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¥½ï¼æ¥ä¸‹æ¥æˆ‘ä»¬å°±ç»™è¿™ä¸ªç±»æ–¹æ³•ä½¿ç”¨ä»£ç†åŠ å…¥ä¸€è¡Œé¢å¤–è¾“å‡ºçš„ä¿¡æ¯ã€‚</p><h3 id="_0-å…ˆè¡¥å……ä¸€ç‚¹åå°„çš„çŸ¥è¯†" tabindex="-1"><a class="header-anchor" href="#_0-å…ˆè¡¥å……ä¸€ç‚¹åå°„çš„çŸ¥è¯†" aria-hidden="true">#</a> 0. å…ˆè¡¥å……ä¸€ç‚¹åå°„çš„çŸ¥è¯†</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_reflect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserApi</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token class-name">UserApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token class-name">Method</span> queryUserInfo <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;queryUserInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> invoke <span class="token operator">=</span> queryUserInfo<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>invoke<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><ul><li>æŒ‡æ•°ï¼šâ­â­</li><li>ç‚¹è¯„ï¼šæœ‰ä»£ç†åœ°æ–¹å‡ ä¹å°±ä¼šæœ‰åå°„ï¼Œä»–ä»¬æ˜¯ä¸€å¥—äº’ç›¸é…åˆä½¿ç”¨çš„åŠŸèƒ½ç±»ã€‚åœ¨åå°„ä¸­å¯ä»¥è°ƒç”¨æ–¹æ³•ã€è·å–å±æ€§ã€æ‹¿åˆ°æ³¨è§£ç­‰ç›¸å…³å†…å®¹ã€‚è¿™äº›éƒ½å¯ä»¥ä¸æ¥ä¸‹æ¥çš„ç±»ä»£ç†ç»„åˆä½¿ç”¨ï¼Œå®Œæˆå„ç§æ¡†æ¶ä¸­çš„æŠ€æœ¯åœºæ™¯ã€‚</li></ul><h3 id="_1-jdkä»£ç†æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_1-jdkä»£ç†æ–¹å¼" aria-hidden="true">#</a> 1. JDKä»£ç†æ–¹å¼</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JDKProxy</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>clazz<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ä½ è¢«ä»£ç†äº†ï¼ŒBy JDKProxyï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">&quot;å°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_JDKProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">IUserApi</span> userApi <span class="token operator">=</span> <span class="token class-name">JDKProxy</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">IUserApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> invoke <span class="token operator">=</span> userApi<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š{}&quot;</span><span class="token punctuation">,</span> invoke<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * æµ‹è¯•ç»“æœï¼š
 * 
 * queryUserInfo ä½ è¢«ä»£ç†äº†ï¼ŒBy JDKProxyï¼
 * 19:55:47.319 [main] INFO  org.itstack.interview.test.ApiTest - æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 *
 * Process finished with exit code 0
 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><ul><li>æŒ‡æ•°ï¼šâ­â­</li><li>åœºæ™¯ï¼šä¸­é—´ä»¶å¼€å‘ã€è®¾è®¡æ¨¡å¼ä¸­ä»£ç†æ¨¡å¼å’Œè£…é¥°å™¨æ¨¡å¼åº”ç”¨</li><li>ç‚¹è¯„ï¼šè¿™ç§JDKè‡ªå¸¦çš„ç±»ä»£ç†æ–¹å¼æ˜¯éå¸¸å¸¸ç”¨çš„ä¸€ç§ï¼Œä¹Ÿæ˜¯éå¸¸ç®€å•çš„ä¸€ç§ã€‚åŸºæœ¬ä¼šåœ¨ä¸€äº›ä¸­é—´ä»¶ä»£ç é‡Œçœ‹åˆ°ä¾‹å¦‚ï¼šæ•°æ®åº“è·¯ç”±ç»„ä»¶ã€Redisç»„ä»¶ç­‰ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™æ ·çš„æ–¹å¼åº”ç”¨åˆ°è®¾è®¡æ¨¡å¼ä¸­ã€‚</li></ul><h3 id="_2-cglibä»£ç†æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_2-cglibä»£ç†æ–¹å¼" aria-hidden="true">#</a> 2. CGLIBä»£ç†æ–¹å¼</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CglibProxy</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">newInstall</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Enhancer</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>object<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æˆ‘è¢«CglibProxyä»£ç†äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> objects<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_CglibProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">CglibProxy</span> cglibProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CglibProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">UserApi</span> userApi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserApi</span><span class="token punctuation">)</span> cglibProxy<span class="token punctuation">.</span><span class="token function">newInstall</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> invoke <span class="token operator">=</span> userApi<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š{}&quot;</span><span class="token punctuation">,</span> invoke<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * æµ‹è¯•ç»“æœï¼š
 * 
 * queryUserInfo ä½ è¢«ä»£ç†äº†ï¼ŒBy CglibProxyï¼
 * 19:55:47.319 [main] INFO  org.itstack.interview.test.ApiTest - æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 *
 * Process finished with exit code 0
 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><ul><li>æŒ‡æ•°ï¼šâ­â­â­</li><li>åœºæ™¯ï¼šSpringã€AOPåˆ‡é¢ã€é‰´æƒæœåŠ¡ã€ä¸­é—´ä»¶å¼€å‘ã€RPCæ¡†æ¶ç­‰</li><li>ç‚¹è¯„ï¼šCGLIBä¸åŒäºJDKï¼Œå®ƒçš„åº•å±‚ä½¿ç”¨ASMå­—èŠ‚ç æ¡†æ¶åœ¨ç±»ä¸­ä¿®æ”¹æŒ‡ä»¤ç å®ç°ä»£ç†ï¼Œæ‰€ä»¥è¿™ç§ä»£ç†æ–¹å¼ä¹Ÿå°±ä¸éœ€è¦åƒJDKé‚£æ ·éœ€è¦æ¥å£æ‰èƒ½ä»£ç†ã€‚åŒæ—¶å¾—ç›Šäºå­—èŠ‚ç æ¡†æ¶çš„ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™ç§ä»£ç†æ–¹å¼ä¹Ÿä¼šæ¯”ä½¿ç”¨JDKä»£ç†çš„æ–¹å¼å¿«1.5~2.0å€ã€‚</li></ul><h3 id="_3-asmä»£ç†æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_3-asmä»£ç†æ–¹å¼" aria-hidden="true">#</a> 3. ASMä»£ç†æ–¹å¼</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ASMProxy</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">ClassReader</span> classReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassWriter</span> classWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span>classReader<span class="token punctuation">,</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span><span class="token constant">COMPUTE_MAXS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        classReader<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassVisitor</span><span class="token punctuation">(</span><span class="token constant">ASM5</span><span class="token punctuation">,</span> classWriter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">MethodVisitor</span> <span class="token function">visitMethod</span><span class="token punctuation">(</span><span class="token keyword">int</span> access<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> descriptor<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> exceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// æ–¹æ³•è¿‡æ»¤</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;queryUserInfo&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token class-name">MethodVisitor</span> methodVisitor <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AdviceAdapter</span><span class="token punctuation">(</span><span class="token constant">ASM5</span><span class="token punctuation">,</span> methodVisitor<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onMethodEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// æ‰§è¡ŒæŒ‡ä»¤ï¼›è·å–é™æ€å±æ€§</span>
                        methodVisitor<span class="token punctuation">.</span><span class="token function">visitFieldInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">GETSTATIC</span><span class="token punctuation">,</span> <span class="token string">&quot;java/lang/System&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;out&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Ljava/io/PrintStream;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// åŠ è½½å¸¸é‡ load constant</span>
                        methodVisitor<span class="token punctuation">.</span><span class="token function">visitLdcInsn</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot; ä½ è¢«ä»£ç†äº†ï¼ŒBy ASMï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// è°ƒç”¨æ–¹æ³•</span>
                        methodVisitor<span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">INVOKEVIRTUAL</span><span class="token punctuation">,</span> <span class="token string">&quot;java/io/PrintStream&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;println&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;(Ljava/lang/String;)V&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onMethodEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">ClassReader</span><span class="token punctuation">.</span><span class="token constant">EXPAND_FRAMES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> classWriter<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">ASMProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_ASMProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">IUserApi</span> userApi <span class="token operator">=</span> <span class="token class-name">ASMProxy</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">UserApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> invoke <span class="token operator">=</span> userApi<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š{}&quot;</span><span class="token punctuation">,</span> invoke<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * æµ‹è¯•ç»“æœï¼š
 * 
 * queryUserInfo ä½ è¢«ä»£ç†äº†ï¼ŒBy ASMï¼
 * 20:12:26.791 [main] INFO  org.itstack.interview.test.ApiTest - æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 *
 * Process finished with exit code 0
 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><ul><li>æŒ‡æ•°ï¼šâ­â­â­â­â­</li><li>åœºæ™¯ï¼šå…¨é“¾è·¯ç›‘æ§ã€ç ´è§£å·¥å…·åŒ…ã€CGLIBã€Springè·å–ç±»å…ƒæ•°æ®ç­‰</li><li>ç‚¹è¯„ï¼šè¿™ç§ä»£ç†å°±æ˜¯ä½¿ç”¨å­—èŠ‚ç ç¼–ç¨‹çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå®ƒçš„å®ç°æ–¹å¼ç›¸å¯¹å¤æ‚ï¼Œè€Œä¸”éœ€è¦äº†è§£Javaè™šæ‹Ÿæœºè§„èŒƒç›¸å…³çš„çŸ¥è¯†ã€‚å› ä¸ºä½ çš„æ¯ä¸€æ­¥ä»£ç†æ“ä½œï¼Œéƒ½æ˜¯åœ¨æ“ä½œå­—èŠ‚ç æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š<code>Opcodes.GETSTATIC</code>ã€<code>Opcodes.INVOKEVIRTUAL</code>ï¼Œé™¤äº†è¿™äº›è¿˜æœ‰å°200ä¸ªå¸¸ç”¨çš„æŒ‡ä»¤ã€‚ä½†è¿™ç§æœ€æ¥è¿‘åº•å±‚çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯æœ€å¿«çš„æ–¹å¼ã€‚æ‰€ä»¥åœ¨ä¸€äº›ä½¿ç”¨å­—èŠ‚ç æ’è£…çš„å…¨é“¾è·¯ç›‘æ§ä¸­ï¼Œä¼šéå¸¸å¸¸è§ã€‚</li></ul><h3 id="_4-byte-buddyä»£ç†æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_4-byte-buddyä»£ç†æ–¹å¼" aria-hidden="true">#</a> 4. Byte-Buddyä»£ç†æ–¹å¼</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ByteBuddyProxy</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">DynamicType<span class="token punctuation">.</span>Unloaded</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dynamicType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBuddy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">subclass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodDescription</span><span class="token punctuation">&gt;</span></span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">&quot;queryUserInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">MethodDelegation</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> dynamicType<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RuntimeType</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Origin</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@AllArguments</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token annotation punctuation">@SuperCall</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ä½ è¢«ä»£ç†äº†ï¼ŒBy Byte-Buddyï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> callable<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_ByteBuddyProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">IUserApi</span> userApi <span class="token operator">=</span> <span class="token class-name">ByteBuddyProxy</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">UserApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> invoke <span class="token operator">=</span> userApi<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š{}&quot;</span><span class="token punctuation">,</span> invoke<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * æµ‹è¯•ç»“æœï¼š
 * 
 * queryUserInfo ä½ è¢«ä»£ç†äº†ï¼ŒBy Byte-Buddyï¼
 * 20:19:44.498 [main] INFO  org.itstack.interview.test.ApiTest - æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 *
 * Process finished with exit code 0
 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><ul><li>æŒ‡æ•°ï¼šâ­â­â­â­</li><li>åœºæ™¯ï¼šAOPåˆ‡é¢ã€ç±»ä»£ç†ã€ç»„ä»¶ã€ç›‘æ§ã€æ—¥å¿—</li><li>ç‚¹è¯„ï¼š<code>Byte Buddy</code> ä¹Ÿæ˜¯ä¸€ä¸ªå­—èŠ‚ç æ“ä½œçš„ç±»åº“ï¼Œä½† <code>Byte Buddy</code> çš„ä½¿ç”¨æ–¹å¼æ›´åŠ ç®€å•ã€‚æ— éœ€ç†è§£å­—èŠ‚ç æŒ‡ä»¤ï¼Œå³å¯ä½¿ç”¨ç®€å•çš„ API å°±èƒ½å¾ˆå®¹æ˜“æ“ä½œå­—èŠ‚ç ï¼Œæ§åˆ¶ç±»å’Œæ–¹æ³•ã€‚æ¯”èµ·JDKåŠ¨æ€ä»£ç†ã€cglibï¼ŒByte Buddyåœ¨æ€§èƒ½ä¸Šå…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ã€‚<strong>å¦å¤–</strong>ï¼Œ2015å¹´10æœˆï¼ŒByte Buddyè¢« Oracle æˆäºˆäº† Duke&#39;s Choiceå¤§å¥–ã€‚è¯¥å¥–é¡¹å¯¹Byte Buddyçš„â€œ JavaæŠ€æœ¯æ–¹é¢çš„å·¨å¤§åˆ›æ–° â€è¡¨ç¤ºèµèµã€‚</li></ul><h3 id="_5-javassistä»£ç†æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_5-javassistä»£ç†æ–¹å¼" aria-hidden="true">#</a> 5. Javassistä»£ç†æ–¹å¼</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JavassistProxy</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–ç±»</span>
        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–æ–¹æ³•</span>
        <span class="token class-name">CtMethod</span> ctMethod <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;queryUserInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ–¹æ³•å‰åŠ å¼º</span>
        ctMethod<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token string">&quot;{System.out.println(\\&quot;&quot;</span> <span class="token operator">+</span> ctMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ä½ è¢«ä»£ç†äº†ï¼ŒBy Javassist\\&quot;);}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">JavassistProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_JavassistProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">IUserApi</span> userApi <span class="token operator">=</span> <span class="token class-name">JavassistProxy</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">UserApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> invoke <span class="token operator">=</span> userApi<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š{}&quot;</span><span class="token punctuation">,</span> invoke<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * æµ‹è¯•ç»“æœï¼š
 * 
 * queryUserInfo ä½ è¢«ä»£ç†äº†ï¼ŒBy Javassist
 * 20:23:39.139 [main] INFO  org.itstack.interview.test.ApiTest - æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œå…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ | æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼
 *
 * Process finished with exit code 0
 */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><ul><li>æŒ‡æ•°ï¼šâ­â­â­â­</li><li>åœºæ™¯ï¼šå…¨é“¾è·¯ç›‘æ§ã€ç±»ä»£ç†ã€AOP</li><li>ç‚¹è¯„ï¼š<code>Javassist</code> æ˜¯ä¸€ä¸ªä½¿ç”¨éå¸¸å¹¿çš„å­—èŠ‚ç æ’è£…æ¡†æ¶ï¼Œå‡ ä¹ä¸€å¤§éƒ¨åˆ†éå…¥ä¾µçš„å…¨é“¾è·¯ç›‘æ§éƒ½æ˜¯ä¼šé€‰æ‹©ä½¿ç”¨è¿™ä¸ªæ¡†æ¶ã€‚å› ä¸ºå®ƒä¸æƒ³ASMé‚£æ ·æ“ä½œå­—èŠ‚ç å¯¼è‡´é£é™©ï¼ŒåŒæ—¶å®ƒçš„åŠŸèƒ½ä¹Ÿéå¸¸é½å…¨ã€‚å¦å¤–ï¼Œè¿™ä¸ªæ¡†æ¶å³å¯ä½¿ç”¨å®ƒæ‰€æä¾›çš„æ–¹å¼ç›´æ¥ç¼–å†™æ’è£…ä»£ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å­—èŠ‚ç æŒ‡ä»¤è¿›è¡Œæ§åˆ¶ç”Ÿæˆä»£ç ï¼Œæ‰€ä»¥ç»¼åˆæ¥çœ‹ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸ä¸é”™çš„å­—èŠ‚ç æ¡†æ¶ã€‚</li></ul><h2 id="å››ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å››ã€æ€»ç»“" aria-hidden="true">#</a> å››ã€æ€»ç»“</h2><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-14-01.png" alt=""></p><ul><li>ä»£ç†çš„å®é™…ç›®çš„å°±æ˜¯é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µï¼Œæ›¿æ¢æ‰åŸæœ‰çš„å®ç°ç±»æˆ–è€…ç»™åŸæœ‰çš„å®ç°ç±»æ³¨å…¥æ–°çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚è€Œè¿™äº›æŠ€æœ¯æœ€ç»ˆéƒ½ä¼šç”¨åˆ°ä¸€äº›æ¡†æ¶åº”ç”¨ã€ä¸­é—´ä»¶å¼€å‘ä»¥åŠç±»ä¼¼éå…¥ä¾µçš„å…¨é“¾è·¯ç›‘æ§ä¸­ã€‚</li><li>ä¸€ä¸ªæŠ€æœ¯æ ˆæ·±åº¦çš„å­¦ä¹ èƒ½è®©ä½ é€å½»çš„äº†è§£åˆ°ä¸€äº›åŸºæœ¬çš„æ ¹æœ¬åŸç†ï¼Œé€šè¿‡è¿™æ ·çš„å­¦ä¹ å¯ä»¥è§£æƒ‘æ‰ä¸€äº›ä¼¼æ‡‚éæ‡‚çš„ç–‘é—®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è¿™æ ·æŠ€æœ¯çš„æ‹“å±•è®©è‡ªå·±æœ‰æ›´å¥½çš„å·¥ä½œæœºä¼šå’Œè–ªèµ„å¾…é‡ã€‚</li><li>è¿™äº›æŠ€æœ¯å­¦èµ·æ¥å¹¶ä¸ä¼šå¾ˆå®¹æ˜“ï¼Œç”šè‡³å¯èƒ½è¿˜æœ‰ä¸€äº›çƒ§è„‘ã€‚ä½†æ¯ä¸€æ®µå€¼å¾—æ·±å…¥å­¦ä¹ çš„æŠ€æœ¯éƒ½èƒ½å¸®åŠ©ä½ çªç ´ä¸€å®šé˜¶æ®µçš„æŠ€æœ¯ç“¶é¢ˆã€‚</li></ul>`,46);function y(g,h){const a=c("ExternalLinkIcon");return o(),l("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),k,s("åšå®¢ï¼š"),n("a",r,[s("https://bugstack.cn"),t(a)])]),d,n("p",null,[v,s("ï¼Œ10.1å‡æœŸç©å—¨äº†çš„é£æœºï¼Œä¼¼ä¹å·²ç»æ”¾å‡å‰ç»™è‡ªå·±å®šçš„å­¦ä¹ ç›®æ ‡äº†ï¼ä½†ä¸€æƒ³åˆ°è¿˜æœ‰ä¸€åœºé¢è¯•ï¼Œä¸ç”±å¾—ä¸´æ—¶æŠ±ä½›è„šï¼Œå¼€å§‹çœ‹å°å‚…å“¥çš„åšå®¢ï¼š"),n("a",m,[s("bugstack.cn"),t(a)])]),b])}const w=e(i,[["render",y],["__file","2020-10-14-mianjingshouce Â· di13pianã€ŠchuliaoJDKã€CGLIBï¼Œhuaiyou3zhongleidailifangshiï¼Ÿmianshiyoukazhuï¼ã€‹.html.vue"]]);export{w as default};
