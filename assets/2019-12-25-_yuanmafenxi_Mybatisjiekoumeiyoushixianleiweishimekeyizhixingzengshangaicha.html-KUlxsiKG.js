import{_ as p,r as e,o,c,a as n,b as s,d as t,e as l}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"æºç åˆ†æ-mybatisæ¥å£æ²¡æœ‰å®ç°ç±»ä¸ºä»€ä¹ˆå¯ä»¥æ‰§è¡Œå¢åˆ æ”¹æŸ¥",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#æºç åˆ†æ-mybatisæ¥å£æ²¡æœ‰å®ç°ç±»ä¸ºä»€ä¹ˆå¯ä»¥æ‰§è¡Œå¢åˆ æ”¹æŸ¥","aria-hidden":"true"},"#"),s(" æºç åˆ†æ | Mybatisæ¥å£æ²¡æœ‰å®ç°ç±»ä¸ºä»€ä¹ˆå¯ä»¥æ‰§è¡Œå¢åˆ æ”¹æŸ¥")],-1),k=n("br",null,null,-1),r={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=n("blockquote",null,[n("p",null,"æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„")],-1),m={href:"https://github.com/fuzhengwei/itstack-demo-code-mybatis",target:"_blank",rel:"noopener noreferrer"},v=l(`<h2 id="ä¸€ã€å‰è¨€ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€ä»‹ç»" aria-hidden="true">#</a> ä¸€ã€å‰è¨€ä»‹ç»</h2><p>MyBatis æ˜¯ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œç›¸å¯¹äºIBatisæ›´æ˜¯ç²¾è¿›äº†ä¸å°‘ã€‚ä¸æ­¤åŒæ—¶å®ƒè¿˜æä¾›äº†å¾ˆå¤šçš„æ‰©å±•ç‚¹ï¼Œæ¯”å¦‚æœ€å¸¸ç”¨çš„æ’ä»¶ï¼›è¯­è¨€é©±åŠ¨å™¨ï¼Œæ‰§è¡Œå™¨ï¼Œå¯¹è±¡å·¥å‚ï¼Œå¯¹è±¡åŒ…è£…å™¨å·¥å‚ç­‰ç­‰éƒ½å¯ä»¥æ‰©å±•ã€‚é‚£ä¹ˆï¼Œå¦‚æœæƒ³æˆä¸ºä¸€ä¸ªæœ‰æ·±åº¦çš„ç”·äºº(ç¨‹åºçŒ¿)ï¼Œè¿˜æ˜¯åº”è¯¥å¥½å¥½çš„å­¦ä¹ ä¸€ä¸‹è¿™æ¬¾å¼€æºæ¡†æ¶çš„æºç ï¼Œä»¥æ­¤å¯ä»¥æ›´å¥½çš„é¢†ä¼šè®¾è®¡æ¨¡å¼çš„ç²¾é«“(é¢è¯•ï¼Ÿ)ã€‚å…¶å®å¯èƒ½å¹³å¸¸çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œå¹¶ä¸ä¼šå»æ·±ç©¶å„ä¸ªæ¡†æ¶çš„æºä»£ç ï¼Œä¹Ÿå¸¸å¸¸ä¼šå¬åˆ°å³ä½¿ä¸ä¼šä¹Ÿå¯ä»¥å¼€å‘ä»£ç ã€‚ä½†ï¼æ¯ä¸ªäººçš„ç›®æ ‡ä¸åŒï¼Œå°±åƒï¼›ä»£ç å†™çš„å¥½å·¥èµ„åŠ çš„å°‘(æ²¡æœ‰bugæ€ä¹ˆçœ‹å‡ºä½ å·¥ä½œå˜ï¼)ï¼Œå¥½ï¼ä¸ºäº†æ”¹å˜ä¸–ç•Œï¼Œå¼€å§‹åˆ†æå–½ï¼</p><p>åœ¨åˆ†æä¹‹å‰å…ˆå‡ºä¸€ä¸ªé¢˜ï¼Œçœ‹çœ‹ä½ é€‚åˆçœ‹æºç ä¸ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">B</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//æˆ‘çš„è¾“å‡ºç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;A.doScan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;B.doScan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶å®æ— è®ºä½ çš„ç­”æ¡ˆå¯¹é”™ï¼Œéƒ½ä¸å½±å“ä½ å¯¹æºç çš„åˆ†æã€‚åªä¸è¿‡ï¼Œå¾€å¾€åœ¨ä¸€äº›æ¡†æ¶ä¸­ä¼šæœ‰å¾ˆå¤šçš„è®¾è®¡æ¨¡å¼å’Œå¼€å‘æŠ€å·§ï¼Œå¦‚æœä¸Šé¢çš„ä»£ç åœ¨ä½ å¹³æ—¶çš„å¼€å‘ä¸­å‡ ä¹æ²¡ç”¨è¿‡ï¼Œé‚£ä¹ˆå¯èƒ½ä½ æš‚æ—¶æ›´å¤šçš„è¿˜æ˜¯å¼€å‘ç€CRUDçš„åŠŸèƒ½(è«æ…Œï¼Œæˆ‘è¿˜å†™è¿‡PHPå‘¢)ã€‚</p><p>æ¥ä¸‹æ¥å…ˆåˆ†æ Mybatis å•ç‹¬ä½¿ç”¨æ—¶çš„æºç æ‰§è¡Œè¿‡ç¨‹ï¼Œå†åˆ†æ Mybatis+Spring æ•´åˆæºç ï¼Œå¥½ï¼å¼€å§‹ã€‚</p><h2 id="äºŒã€æ¡ˆä¾‹å·¥ç¨‹" tabindex="-1"><a class="header-anchor" href="#äºŒã€æ¡ˆä¾‹å·¥ç¨‹" aria-hidden="true">#</a> äºŒã€æ¡ˆä¾‹å·¥ç¨‹</h2><p>ä¸ºäº†æ›´å¥½çš„åˆ†æï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Mybatis çš„æ¡ˆä¾‹å·¥ç¨‹ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼›Mybatis å•ç‹¬ä½¿ç”¨ã€Mybatis+Spring æ•´åˆä½¿ç”¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>itstack<span class="token operator">-</span>demo<span class="token operator">-</span>mybatis
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo
    â”‚   â”‚       â”œâ”€â”€ dao
    â”‚   â”‚       â”‚	â”œâ”€â”€ <span class="token class-name">ISchool</span><span class="token punctuation">.</span>java		
    â”‚   â”‚       â”‚	â””â”€â”€ <span class="token class-name">IUserDao</span><span class="token punctuation">.</span>java	
    â”‚   â”‚       â””â”€â”€ interfaces     
    â”‚   â”‚         	â”œâ”€â”€ <span class="token class-name">School</span><span class="token punctuation">.</span>java	
    â”‚   â”‚        	â””â”€â”€ <span class="token class-name">User</span><span class="token punctuation">.</span>java
    â”‚   â”œâ”€â”€ resources	
    â”‚   â”‚   â”œâ”€â”€ mapper
    â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">School_Mapper</span><span class="token punctuation">.</span>xml
    â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">User_Mapper</span><span class="token punctuation">.</span>xml
    â”‚   â”‚   â”œâ”€â”€ props	
    â”‚   â”‚   â”‚   â””â”€â”€ jdbc<span class="token punctuation">.</span>properties
    â”‚   â”‚   â”œâ”€â”€ spring
    â”‚   â”‚   â”‚   â”œâ”€â”€ mybatis<span class="token operator">-</span>config<span class="token operator">-</span>datasource<span class="token punctuation">.</span>xml
    â”‚   â”‚   â”‚   â””â”€â”€ spring<span class="token operator">-</span>config<span class="token operator">-</span>datasource<span class="token punctuation">.</span>xml
    â”‚   â”‚   â”œâ”€â”€ logback<span class="token punctuation">.</span>xml
    â”‚   â”‚   â”œâ”€â”€ mybatis<span class="token operator">-</span>config<span class="token punctuation">.</span>xml
    â”‚   â”‚   â””â”€â”€ spring<span class="token operator">-</span>config<span class="token punctuation">.</span>xml
    â”‚   â””â”€â”€ webapp
    â”‚       â””â”€â”€ <span class="token constant">WEB</span><span class="token operator">-</span><span class="token constant">INF</span>
    â””â”€â”€ test
         â””â”€â”€ java
             â””â”€â”€ org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>test
                 â”œâ”€â”€ <span class="token class-name">MybatisApiTest</span><span class="token punctuation">.</span>java
                 â””â”€â”€ <span class="token class-name">SpringApiTest</span><span class="token punctuation">.</span>java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ä¸‰ã€ç¯å¢ƒé…ç½®" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€ç¯å¢ƒé…ç½®" aria-hidden="true">#</a> ä¸‰ã€ç¯å¢ƒé…ç½®</h2><ol><li>JDK1.8</li><li>IDEA 2019.3.1</li><li>mybatis 3.4.6 {ä¸åŒç‰ˆæœ¬æºç ç•¥æœ‰å·®å¼‚å’Œbugä¿®å¤}</li><li>mybatis-spring 1.3.2 ï½›ä»¥ä¸‹æºç åˆ†æä¼šè¯´ä»£ç è¡Œå·ï¼Œæ³¨æ„ä¸åŒç‰ˆæœ¬å¯èƒ½ä¼šæœ‰å·®å¼‚ï½</li></ol><h2 id="å››ã€-mybatis-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#å››ã€-mybatis-æºç åˆ†æ" aria-hidden="true">#</a> å››ã€(mybatis)æºç åˆ†æ</h2><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.4.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Mybatisçš„æ•´ä¸ªæºç è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œä»¥ä¸‹ä¸»è¦å°†éƒ¨åˆ†æ ¸å¿ƒå†…å®¹è¿›è¡Œæ•´ç†åˆ†æï¼Œä»¥ä¾¿äºåç»­åˆ†æMybatisä¸Springæ•´åˆçš„æºç éƒ¨åˆ†ã€‚ç®€è¦åŒ…æ‹¬ï¼›å®¹å™¨åˆå§‹åŒ–ã€é…ç½®æ–‡ä»¶è§£æã€MapperåŠ è½½ä¸åŠ¨æ€ä»£ç†ã€‚</p><h3 id="_1-ä»ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹å¼€å§‹" tabindex="-1"><a class="header-anchor" href="#_1-ä»ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹å¼€å§‹" aria-hidden="true">#</a> 1. ä»ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹å¼€å§‹</h3><p>è¦å­¦ä¹ Mybatisæºç ï¼Œæœ€å¥½çš„æ–¹å¼ä¸€å®šæ˜¯ä»ä¸€ä¸ªç®€å•çš„ç‚¹è¿›å…¥ï¼Œè€Œä¸æ˜¯ä»Springæ•´åˆå¼€å§‹åˆ†æã€‚SqlSessionFactoryæ˜¯æ•´ä¸ªMybatisçš„æ ¸å¿ƒå®ä¾‹å¯¹è±¡ï¼ŒSqlSessionFactoryå¯¹è±¡çš„å®ä¾‹åˆé€šè¿‡SqlSessionFactoryBuilderå¯¹è±¡æ¥è·å¾—ã€‚SqlSessionFactoryBuilderå¯¹è±¡å¯ä»¥ä»XMLé…ç½®æ–‡ä»¶åŠ è½½é…ç½®ä¿¡æ¯ï¼Œç„¶ååˆ›å»ºSqlSessionFactoryã€‚å¦‚ä¸‹ä¾‹å­ï¼š</p><blockquote><p>MybatisApiTest.java</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisApiTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_queryUserInfoById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> resource <span class="token operator">=</span> <span class="token string">&quot;spring/mybatis-config-datasource.xml&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Reader</span> reader<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            reader <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SqlSessionFactory</span> sqlMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SqlSession</span> session <span class="token operator">=</span> sqlMapper<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">User</span> user <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token string">&quot;org.itstack.demo.dao.IUserDao.queryUserInfoById&quot;</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>dao/IUserDao.java</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUserDao</span> <span class="token punctuation">{</span>

     <span class="token class-name">User</span> <span class="token function">queryUserInfoById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>spring/mybatis-config-datasource.xml</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> encoding<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> configuration <span class="token constant">PUBLIC</span> <span class="token string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>
        <span class="token string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span><span class="token operator">&gt;</span>

<span class="token generics"><span class="token punctuation">&lt;</span>configuration<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span>environments <span class="token keyword">default</span><span class="token operator">=</span><span class="token string">&quot;development&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>environment id<span class="token operator">=</span><span class="token string">&quot;development&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>transactionManager type<span class="token operator">=</span><span class="token string">&quot;JDBC&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>dataSource type<span class="token operator">=</span><span class="token string">&quot;POOLED&quot;</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;driver&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;com.mysql.jdbc.Driver&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;url&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;jdbc:mysql://127.0.0.1:3306/itstack?useUnicode=true&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;username&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;password&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;123456&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>dataSource<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>environment<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>environments<span class="token operator">&gt;</span>

    <span class="token generics"><span class="token punctuation">&lt;</span>mappers<span class="token punctuation">&gt;</span></span>
        <span class="token operator">&lt;</span>mapper resource<span class="token operator">=</span><span class="token string">&quot;mapper/User_Mapper.xml&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>mappers<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œé‚£ä¹ˆä¼šæœ‰å¦‚ä¸‹ç»“æœï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token string">&quot;createTime&quot;</span><span class="token operator">:</span><span class="token number">1571376957000</span><span class="token punctuation">,</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;èŠ±èŠ±&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;updateTime&quot;</span><span class="token operator">:</span><span class="token number">1571376957000</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä»ä¸Šé¢çš„ä»£ç å—å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒä»£ç ï¼›<code>SqlSessionFactoryBuilder().build(reader)</code>ï¼Œè´Ÿè´£Mybatisé…ç½®æ–‡ä»¶çš„åŠ è½½ã€è§£æã€æ„å»ºç­‰èŒè´£ï¼Œç›´åˆ°æœ€ç»ˆå¯ä»¥é€šè¿‡SqlSessionæ¥æ‰§è¡Œå¹¶è¿”å›ç»“æœã€‚</p><h3 id="_2-å®¹å™¨åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#_2-å®¹å™¨åˆå§‹åŒ–" aria-hidden="true">#</a> 2. å®¹å™¨åˆå§‹åŒ–</h3><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒSqlSessionFactoryæ˜¯é€šè¿‡SqlSessionFactoryBuilderå·¥å‚ç±»åˆ›å»ºçš„ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨æ„é€ å™¨ã€‚å®¹å™¨çš„é…ç½®æ–‡ä»¶åŠ è½½å’Œåˆå§‹åŒ–æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-01.png" alt="å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ &amp; åˆå§‹åŒ–æµç¨‹"></p><ul><li>æµç¨‹æ ¸å¿ƒç±» <ul><li>SqlSessionFactoryBuilder</li><li>XMLConfigBuilder</li><li>XPathParser</li><li>Configuration</li></ul></li></ul><blockquote><p>SqlSessionFactoryBuilder.java</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SqlSessionFactoryBuilder</span> <span class="token punctuation">{</span>

  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">XMLConfigBuilder</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">&quot;Error building SqlSession.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Intentionally ignore. Prefer previous error.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">,</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">XMLConfigBuilder</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token class-name">ExceptionFactory</span><span class="token punctuation">.</span><span class="token function">wrapException</span><span class="token punctuation">(</span><span class="token string">&quot;Error building SqlSession.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Intentionally ignore. Prefer previous error.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
    
  <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSqlSessionFactory</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢çš„æºç å¯ä»¥çœ‹åˆ°ï¼ŒSqlSessionFactoryæä¾›ä¸‰ç§æ–¹å¼buildæ„å»ºå¯¹è±¡ï¼›</p><ul><li>å­—èŠ‚æµï¼šjava.io.InputStream</li><li>å­—ç¬¦æµï¼šjava.io.Reader</li><li>é…ç½®ç±»ï¼šorg.apache.ibatis.session.Configuration</li></ul><p>é‚£ä¹ˆï¼Œå­—èŠ‚æµã€å­—ç¬¦æµéƒ½ä¼šåˆ›å»ºé…ç½®æ–‡ä»¶è§£æç±»ï¼šXMLConfigBuilderï¼Œå¹¶é€šè¿‡parser.parse()ç”ŸæˆConfigurationï¼Œæœ€åè°ƒç”¨é…ç½®ç±»æ„å»ºæ–¹æ³•ç”ŸæˆSqlSessionFactoryã€‚</p><blockquote><p>XMLConfigBuilder.java</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XMLConfigBuilder</span> <span class="token keyword">extends</span> <span class="token class-name">BaseBuilder</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">boolean</span> parsed<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">XPathParser</span> parser<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> environment<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReflectorFactory</span> localReflectorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">public</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">,</span> <span class="token class-name">Properties</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XPathParser</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperEntityResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> environment<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>XMLConfigBuilderå¯¹äºXMLæ–‡ä»¶çš„åŠ è½½å’Œè§£æéƒ½å§”æ‰˜äºXPathParserï¼Œæœ€ç»ˆä½¿ç”¨JDKè‡ªå¸¦çš„javax.xmlè¿›è¡ŒXMLè§£æ(XPath)</li><li>XPathParser(Reader reader, boolean validation, Properties variables, EntityResolver entityResolver) <ol><li>readerï¼šä½¿ç”¨å­—ç¬¦æµåˆ›å»ºæ–°çš„è¾“å…¥æºï¼Œç”¨äºå¯¹XMLæ–‡ä»¶çš„è¯»å–</li><li>validationï¼šæ˜¯å¦è¿›è¡ŒDTDæ ¡éªŒ</li><li>variablesï¼šå±æ€§é…ç½®ä¿¡æ¯</li><li>entityResolverï¼šMybatisç¡¬ç¼–ç äº†new XMLMapperEntityResolver()æä¾›XMLé»˜è®¤è§£æå™¨</li></ol></li></ol><blockquote><p>XMLMapperEntityResolver.java</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XMLMapperEntityResolver</span> <span class="token keyword">implements</span> <span class="token class-name">EntityResolver</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">IBATIS_CONFIG_SYSTEM</span> <span class="token operator">=</span> <span class="token string">&quot;ibatis-3-config.dtd&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">IBATIS_MAPPER_SYSTEM</span> <span class="token operator">=</span> <span class="token string">&quot;ibatis-3-mapper.dtd&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MYBATIS_CONFIG_SYSTEM</span> <span class="token operator">=</span> <span class="token string">&quot;mybatis-3-config.dtd&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MYBATIS_MAPPER_SYSTEM</span> <span class="token operator">=</span> <span class="token string">&quot;mybatis-3-mapper.dtd&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MYBATIS_CONFIG_DTD</span> <span class="token operator">=</span> <span class="token string">&quot;org/apache/ibatis/builder/xml/mybatis-3-config.dtd&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MYBATIS_MAPPER_DTD</span> <span class="token operator">=</span> <span class="token string">&quot;org/apache/ibatis/builder/xml/mybatis-3-mapper.dtd&quot;</span><span class="token punctuation">;</span>

  <span class="token comment">/*
   * Converts a public DTD into a local one
   * 
   * @param publicId The public id that is what comes after &quot;PUBLIC&quot;
   * @param systemId The system id that is what comes after the public id.
   * @return The InputSource for the DTD
   * 
   * @throws org.xml.sax.SAXException If anything goes wrong
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">InputSource</span> <span class="token function">resolveEntity</span><span class="token punctuation">(</span><span class="token class-name">String</span> publicId<span class="token punctuation">,</span> <span class="token class-name">String</span> systemId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SAXException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>systemId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> lowerCaseSystemId <span class="token operator">=</span> systemId<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token constant">ENGLISH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lowerCaseSystemId<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token constant">MYBATIS_CONFIG_SYSTEM</span><span class="token punctuation">)</span> <span class="token operator">||</span> lowerCaseSystemId<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token constant">IBATIS_CONFIG_SYSTEM</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">getInputSource</span><span class="token punctuation">(</span><span class="token constant">MYBATIS_CONFIG_DTD</span><span class="token punctuation">,</span> publicId<span class="token punctuation">,</span> systemId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lowerCaseSystemId<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token constant">MYBATIS_MAPPER_SYSTEM</span><span class="token punctuation">)</span> <span class="token operator">||</span> lowerCaseSystemId<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token constant">IBATIS_MAPPER_SYSTEM</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">getInputSource</span><span class="token punctuation">(</span><span class="token constant">MYBATIS_MAPPER_DTD</span><span class="token punctuation">,</span> publicId<span class="token punctuation">,</span> systemId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SAXException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">InputSource</span> <span class="token function">getInputSource</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">String</span> publicId<span class="token punctuation">,</span> <span class="token class-name">String</span> systemId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">InputSource</span> source <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputSource</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        source<span class="token punctuation">.</span><span class="token function">setPublicId</span><span class="token punctuation">(</span>publicId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        source<span class="token punctuation">.</span><span class="token function">setSystemId</span><span class="token punctuation">(</span>systemId<span class="token punctuation">)</span><span class="token punctuation">;</span>        
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ignore, null is ok</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> source<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>Mybatisä¾èµ–äºdtdæ–‡ä»¶è¿›è¡Œè¿›è¡Œè§£æï¼Œå…¶ä¸­çš„ibatis-3-config.dtdä¸»è¦æ˜¯ç”¨äºå…¼å®¹ç”¨é€”</li><li>getInputSource(String path, String publicId, String systemId)çš„è°ƒç”¨é‡Œé¢æœ‰ä¸¤ä¸ªå‚æ•°publicIdï¼ˆå…¬å…±æ ‡è¯†ç¬¦ï¼‰å’ŒsystemIdï¼ˆç³»ç»Ÿæ ‡ç¤ºç¬¦ï¼‰</li></ol><blockquote><p>XPathParser.java</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">XPathParser</span><span class="token punctuation">(</span><span class="token class-name">Reader</span> reader<span class="token punctuation">,</span> <span class="token keyword">boolean</span> validation<span class="token punctuation">,</span> <span class="token class-name">Properties</span> variables<span class="token punctuation">,</span> <span class="token class-name">EntityResolver</span> entityResolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">commonConstructor</span><span class="token punctuation">(</span>validation<span class="token punctuation">,</span> variables<span class="token punctuation">,</span> entityResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>document <span class="token operator">=</span> <span class="token function">createDocument</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputSource</span><span class="token punctuation">(</span>reader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">commonConstructor</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> validation<span class="token punctuation">,</span> <span class="token class-name">Properties</span> variables<span class="token punctuation">,</span> <span class="token class-name">EntityResolver</span> entityResolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>validation <span class="token operator">=</span> validation<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>entityResolver <span class="token operator">=</span> entityResolver<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>variables <span class="token operator">=</span> variables<span class="token punctuation">;</span>
  <span class="token class-name">XPathFactory</span> factory <span class="token operator">=</span> <span class="token class-name">XPathFactory</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>xpath <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newXPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Document</span> <span class="token function">createDocument</span><span class="token punctuation">(</span><span class="token class-name">InputSource</span> inputSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// important: this must only be called AFTER common constructor</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">DocumentBuilderFactory</span> factory <span class="token operator">=</span> <span class="token class-name">DocumentBuilderFactory</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factory<span class="token punctuation">.</span><span class="token function">setValidating</span><span class="token punctuation">(</span>validation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    factory<span class="token punctuation">.</span><span class="token function">setNamespaceAware</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factory<span class="token punctuation">.</span><span class="token function">setIgnoringComments</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factory<span class="token punctuation">.</span><span class="token function">setIgnoringElementContentWhitespace</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factory<span class="token punctuation">.</span><span class="token function">setCoalescing</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    factory<span class="token punctuation">.</span><span class="token function">setExpandEntityReferences</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DocumentBuilder</span> builder <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newDocumentBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">setEntityResolver</span><span class="token punctuation">(</span>entityResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">setErrorHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">SAXParseException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SAXException</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> exception<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fatalError</span><span class="token punctuation">(</span><span class="token class-name">SAXParseException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SAXException</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> exception<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">warning</span><span class="token punctuation">(</span><span class="token class-name">SAXParseException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SAXException</span> <span class="token punctuation">{</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">&quot;Error creating document instance.  Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><p>ä»ä¸Šåˆ°ä¸‹å¯ä»¥çœ‹åˆ°ä¸»è¦æ˜¯ä¸ºäº†åˆ›å»ºä¸€ä¸ªMybatisçš„æ–‡æ¡£è§£æå™¨ï¼Œæœ€åæ ¹æ®builder.parse(inputSource)è¿”å›Document</p></li><li><p>å¾—åˆ°XPathParserå®ä¾‹åï¼Œæ¥ä¸‹æ¥åœ¨è°ƒç”¨æ–¹æ³•ï¼š<strong>this</strong>(new XPathParser(reader, true, props, new XMLMapperEntityResolver()), environment, props);</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XPathParser</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> props<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperEntityResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> environment<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">private</span> <span class="token class-name">XMLConfigBuilder</span><span class="token punctuation">(</span><span class="token class-name">XPathParser</span> parser<span class="token punctuation">,</span> <span class="token class-name">String</span> environment<span class="token punctuation">,</span> <span class="token class-name">Properties</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span><span class="token string">&quot;SQL Mapper Configuration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">.</span><span class="token function">setVariables</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>parsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">=</span> environment<span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>parser <span class="token operator">=</span> parser<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å…¶ä¸­è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å‡½æ•°</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseBuilder</span> <span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">TypeAliasRegistry</span> typeAliasRegistry<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">TypeHandlerRegistry</span> typeHandlerRegistry<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">BaseBuilder</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>typeAliasRegistry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">.</span><span class="token function">getTypeAliasRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>typeHandlerRegistry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configuration<span class="token punctuation">.</span><span class="token function">getTypeHandlerRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>XMLConfigBuilderåˆ›å»ºå®Œæˆåï¼ŒsqlSessionFactoryBuildè°ƒç”¨parser.parse()åˆ›å»ºConfiguration</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XMLConfigBuilder</span> <span class="token keyword">extends</span> <span class="token class-name">BaseBuilder</span> <span class="token punctuation">{</span>    
     <span class="token keyword">public</span> <span class="token class-name">Configuration</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>parsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       parsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token function">parseConfiguration</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;/configuration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> configuration<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="_3-é…ç½®æ–‡ä»¶è§£æ" tabindex="-1"><a class="header-anchor" href="#_3-é…ç½®æ–‡ä»¶è§£æ" aria-hidden="true">#</a> 3. é…ç½®æ–‡ä»¶è§£æ</h3><p>è¿™ä¸€éƒ¨åˆ†æ˜¯æ•´ä¸ªXMLæ–‡ä»¶è§£æå’Œè£…è½½çš„æ ¸å¿ƒå†…å®¹ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼›</p><ol><li>å±æ€§è§£æpropertiesElement</li><li>åŠ è½½settingsèŠ‚ç‚¹settingsAsProperties</li><li>è½½è‡ªå®šä¹‰VFS loadCustomVfs</li><li>è§£æç±»å‹åˆ«åtypeAliasesElement</li><li>åŠ è½½æ’ä»¶pluginElement</li><li>åŠ è½½å¯¹è±¡å·¥å‚objectFactoryElement</li><li>åˆ›å»ºå¯¹è±¡åŒ…è£…å™¨å·¥å‚objectWrapperFactoryElement</li><li>åŠ è½½åå°„å·¥å‚reflectorFactoryElement</li><li>å…ƒç´ è®¾ç½®settingsElement</li><li>åŠ è½½ç¯å¢ƒé…ç½®environmentsElement</li><li>æ•°æ®åº“å‚å•†æ ‡è¯†åŠ è½½databaseIdProviderElement</li><li>åŠ è½½ç±»å‹å¤„ç†å™¨typeHandlerElement</li><li>(<strong>æ ¸å¿ƒ</strong>)åŠ è½½mapperæ–‡ä»¶mapperElement</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token function">parseConfiguration</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;/configuration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseConfiguration</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">//issue #117 read properties first</span>
      <span class="token comment">//å±æ€§è§£æpropertiesElement</span>
      <span class="token function">propertiesElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//åŠ è½½settingsèŠ‚ç‚¹settingsAsProperties</span>
      <span class="token class-name">Properties</span> settings <span class="token operator">=</span> <span class="token function">settingsAsProperties</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;settings&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//åŠ è½½è‡ªå®šä¹‰VFS loadCustomVfs</span>
      <span class="token function">loadCustomVfs</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//è§£æç±»å‹åˆ«åtypeAliasesElement</span>
      <span class="token function">typeAliasesElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;typeAliases&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//åŠ è½½æ’ä»¶pluginElement</span>
      <span class="token function">pluginElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;plugins&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//åŠ è½½å¯¹è±¡å·¥å‚objectFactoryElement</span>
      <span class="token function">objectFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;objectFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//åˆ›å»ºå¯¹è±¡åŒ…è£…å™¨å·¥å‚objectWrapperFactoryElement</span>
      <span class="token function">objectWrapperFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;objectWrapperFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//åŠ è½½åå°„å·¥å‚reflectorFactoryElement</span>
      <span class="token function">reflectorFactoryElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;reflectorFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//å…ƒç´ è®¾ç½®</span>
      <span class="token function">settingsElement</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// read it after objectFactory and objectWrapperFactory issue #631</span>
      <span class="token comment">//åŠ è½½ç¯å¢ƒé…ç½®environmentsElement</span>
      <span class="token function">environmentsElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;environments&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//æ•°æ®åº“å‚å•†æ ‡è¯†åŠ è½½databaseIdProviderElement</span>
      <span class="token function">databaseIdProviderElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;databaseIdProvider&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//åŠ è½½ç±»å‹å¤„ç†å™¨typeHandlerElement</span>
      <span class="token function">typeHandlerElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;typeHandlers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//åŠ è½½mapperæ–‡ä»¶mapperElement</span>
      <span class="token function">mapperElement</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">evalNode</span><span class="token punctuation">(</span><span class="token string">&quot;mappers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€æœ‰çš„root.evalNode()åº•å±‚éƒ½æ˜¯è°ƒç”¨XML DOMæ–¹æ³•ï¼šObject evaluate(String expression, Object item, QName returnType)ï¼Œè¡¨è¾¾å¼å‚æ•°expressionï¼Œé€šè¿‡XObject resultObject = eval( expression, item )è¿”å›æœ€ç»ˆèŠ‚ç‚¹å†…å®¹ï¼Œå¯ä»¥å‚è€ƒhttp://mybatis.org/dtd/mybatis-3-config.dtdï¼Œå¦‚ä¸‹ï¼›</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">configuration</span> <span class="token attr-name">(properties?,</span> <span class="token attr-name">settings?,</span> <span class="token attr-name">typeAliases?,</span> <span class="token attr-name">typeHandlers?,</span> <span class="token attr-name">objectFactory?,</span> <span class="token attr-name">objectWrapperFactory?,</span> <span class="token attr-name">reflectorFactory?,</span> <span class="token attr-name">plugins?,</span> <span class="token attr-name">environments?,</span> <span class="token attr-name">databaseIdProvider?,</span> <span class="token attr-name">mappers?)</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">databaseIdProvider</span> <span class="token attr-name">(property*)</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">databaseIdProvider</span>
<span class="token attr-name">type</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">properties</span> <span class="token attr-name">(property*)</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">properties</span>
<span class="token attr-name">resource</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#IMPLIED</span>
<span class="token attr-name">url</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#IMPLIED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">property</span> <span class="token attr-name">EMPTY</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">property</span>
<span class="token attr-name">name</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token attr-name">value</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">settings</span> <span class="token attr-name">(setting+)</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">setting</span> <span class="token attr-name">EMPTY</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">setting</span>
<span class="token attr-name">name</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token attr-name">value</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">typeAliases</span> <span class="token attr-name">(typeAlias*,package*)</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">typeAlias</span> <span class="token attr-name">EMPTY</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">typeAlias</span>
<span class="token attr-name">type</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token attr-name">alias</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#IMPLIED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">typeHandlers</span> <span class="token attr-name">(typeHandler*,package*)</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">typeHandler</span> <span class="token attr-name">EMPTY</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">typeHandler</span>
<span class="token attr-name">javaType</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#IMPLIED</span>
<span class="token attr-name">jdbcType</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#IMPLIED</span>
<span class="token attr-name">handler</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">objectFactory</span> <span class="token attr-name">(property*)</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">objectFactory</span>
<span class="token attr-name">type</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">objectWrapperFactory</span> <span class="token attr-name">EMPTY</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">objectWrapperFactory</span>
<span class="token attr-name">type</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">reflectorFactory</span> <span class="token attr-name">EMPTY</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">reflectorFactory</span>
<span class="token attr-name">type</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">plugins</span> <span class="token attr-name">(plugin+)</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">plugin</span> <span class="token attr-name">(property*)</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">plugin</span>
<span class="token attr-name">interceptor</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">environments</span> <span class="token attr-name">(environment+)</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">environments</span>
<span class="token attr-name">default</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">environment</span> <span class="token attr-name">(transactionManager,dataSource)</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">environment</span>
<span class="token attr-name">id</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">transactionManager</span> <span class="token attr-name">(property*)</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">transactionManager</span>
<span class="token attr-name">type</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">dataSource</span> <span class="token attr-name">(property*)</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">dataSource</span>
<span class="token attr-name">type</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">mappers</span> <span class="token attr-name">(mapper*,package*)</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">mapper</span> <span class="token attr-name">EMPTY</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">mapper</span>
<span class="token attr-name">resource</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#IMPLIED</span>
<span class="token attr-name">url</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#IMPLIED</span>
<span class="token attr-name">class</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#IMPLIED</span>
<span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">package</span> <span class="token attr-name">EMPTY</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ATTLIST</span> <span class="token attr-name">package</span>
<span class="token attr-name">name</span> <span class="token attr-name">CDATA</span> <span class="token attr-name">#REQUIRED</span>
<span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mybatis-3-config.dtd å®šä¹‰æ–‡ä»¶ä¸­æœ‰11ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼›</p><ol><li>properties?,</li><li>settings?,</li><li>typeAliases?,</li><li>typeHandlers?,</li><li>objectFactory?,</li><li>objectWrapperFactory?,</li><li>reflectorFactory?,</li><li>plugins?,</li><li>environments?,</li><li>databaseIdProvider?,</li><li>mappers?</li></ol><p>ä»¥ä¸Šæ¯ä¸ªé…ç½®éƒ½æ˜¯å¯é€‰ã€‚æœ€ç»ˆé…ç½®å†…å®¹ä¼šä¿å­˜åˆ°org.apache.ibatis.session.Configurationï¼Œå¦‚ä¸‹ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Configuration</span> <span class="token punctuation">{</span>

  <span class="token keyword">protected</span> <span class="token class-name">Environment</span> environment<span class="token punctuation">;</span>
  <span class="token comment">// å…è®¸åœ¨åµŒå¥—è¯­å¥ä¸­ä½¿ç”¨åˆ†é¡µï¼ˆRowBoundsï¼‰ã€‚å¦‚æœå…è®¸ä½¿ç”¨åˆ™è®¾ç½®ä¸ºfalseã€‚é»˜è®¤ä¸ºfalse</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> safeRowBoundsEnabled<span class="token punctuation">;</span>
  <span class="token comment">// å…è®¸åœ¨åµŒå¥—è¯­å¥ä¸­ä½¿ç”¨åˆ†é¡µï¼ˆResultHandlerï¼‰ã€‚å¦‚æœå…è®¸ä½¿ç”¨åˆ™è®¾ç½®ä¸ºfalseã€‚</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> safeResultHandlerEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// æ˜¯å¦å¼€å¯è‡ªåŠ¨é©¼å³°å‘½åè§„åˆ™ï¼ˆcamel caseï¼‰æ˜ å°„ï¼Œå³ä»ç»å…¸æ•°æ®åº“åˆ—å A_COLUMN åˆ°ç»å…¸ Java å±æ€§å aColumn çš„ç±»ä¼¼æ˜ å°„ã€‚é»˜è®¤false</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> mapUnderscoreToCamelCase<span class="token punctuation">;</span>
  <span class="token comment">// å½“å¼€å¯æ—¶ï¼Œä»»ä½•æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šåŠ è½½è¯¥å¯¹è±¡çš„æ‰€æœ‰å±æ€§ã€‚å¦åˆ™ï¼Œæ¯ä¸ªå±æ€§ä¼šæŒ‰éœ€åŠ è½½ã€‚é»˜è®¤å€¼false (true in â‰¤3.4.1)</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> aggressiveLazyLoading<span class="token punctuation">;</span>
  <span class="token comment">// æ˜¯å¦å…è®¸å•ä¸€è¯­å¥è¿”å›å¤šç»“æœé›†ï¼ˆéœ€è¦å…¼å®¹é©±åŠ¨ï¼‰ã€‚</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> multipleResultSetsEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// å…è®¸ JDBC æ”¯æŒè‡ªåŠ¨ç”Ÿæˆä¸»é”®ï¼Œéœ€è¦é©±åŠ¨å…¼å®¹ã€‚è¿™å°±æ˜¯insertæ—¶è·å–mysqlè‡ªå¢ä¸»é”®/oracle sequenceçš„å¼€å…³ã€‚æ³¨ï¼šä¸€èˆ¬æ¥è¯´,è¿™æ˜¯å¸Œæœ›çš„ç»“æœ,åº”è¯¥é»˜è®¤å€¼ä¸ºtrueæ¯”è¾ƒåˆé€‚ã€‚</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> useGeneratedKeys<span class="token punctuation">;</span>
  <span class="token comment">// ä½¿ç”¨åˆ—æ ‡ç­¾ä»£æ›¿åˆ—å,ä¸€èˆ¬æ¥è¯´,è¿™æ˜¯å¸Œæœ›çš„ç»“æœ</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> useColumnLabel <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// æ˜¯å¦å¯ç”¨ç¼“å­˜ {é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œå¯èƒ½è¿™ä¹Ÿæ˜¯ä½ çš„é¢è¯•é¢˜}</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> cacheEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// æŒ‡å®šå½“ç»“æœé›†ä¸­å€¼ä¸º null çš„æ—¶å€™æ˜¯å¦è°ƒç”¨æ˜ å°„å¯¹è±¡çš„ setterï¼ˆmap å¯¹è±¡æ—¶ä¸º putï¼‰æ–¹æ³•ï¼Œè¿™å¯¹äºæœ‰ Map.keySet() ä¾èµ–æˆ– null å€¼åˆå§‹åŒ–çš„æ—¶å€™æ˜¯æœ‰ç”¨çš„ã€‚</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> callSettersOnNulls<span class="token punctuation">;</span>
  <span class="token comment">// å…è®¸ä½¿ç”¨æ–¹æ³•ç­¾åä¸­çš„åç§°ä½œä¸ºè¯­å¥å‚æ•°åç§°ã€‚ ä¸ºäº†ä½¿ç”¨è¯¥ç‰¹æ€§ï¼Œä½ çš„å·¥ç¨‹å¿…é¡»é‡‡ç”¨Java 8ç¼–è¯‘ï¼Œå¹¶ä¸”åŠ ä¸Š-parametersé€‰é¡¹ã€‚ï¼ˆä»3.4.1å¼€å§‹ï¼‰</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> useActualParamName <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">//å½“è¿”å›è¡Œçš„æ‰€æœ‰åˆ—éƒ½æ˜¯ç©ºæ—¶ï¼ŒMyBatisé»˜è®¤è¿”å›nullã€‚ å½“å¼€å¯è¿™ä¸ªè®¾ç½®æ—¶ï¼ŒMyBatisä¼šè¿”å›ä¸€ä¸ªç©ºå®ä¾‹ã€‚ è¯·æ³¨æ„ï¼Œå®ƒä¹Ÿé€‚ç”¨äºåµŒå¥—çš„ç»“æœé›† (i.e. collectioin and association)ã€‚ï¼ˆä»3.4.2å¼€å§‹ï¼‰ æ³¨ï¼šè¿™é‡Œåº”è¯¥æ‹†åˆ†ä¸ºä¸¤ä¸ªå‚æ•°æ¯”è¾ƒåˆé€‚, ä¸€ä¸ªç”¨äºç»“æœé›†ï¼Œä¸€ä¸ªç”¨äºå•è®°å½•ã€‚é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›ç»“æœé›†ä¸æ˜¯nullï¼Œå•è®°å½•ä»ç„¶æ˜¯null</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> returnInstanceForEmptyRow<span class="token punctuation">;</span>
  <span class="token comment">// æŒ‡å®š MyBatis å¢åŠ åˆ°æ—¥å¿—åç§°çš„å‰ç¼€ã€‚</span>
  <span class="token keyword">protected</span> <span class="token class-name">String</span> logPrefix<span class="token punctuation">;</span>
  <span class="token comment">// æŒ‡å®š MyBatis æ‰€ç”¨æ—¥å¿—çš„å…·ä½“å®ç°ï¼ŒæœªæŒ‡å®šæ—¶å°†è‡ªåŠ¨æŸ¥æ‰¾ã€‚ä¸€èˆ¬å»ºè®®æŒ‡å®šä¸ºslf4jæˆ–log4j</span>
  <span class="token keyword">protected</span> <span class="token class-name">Class</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Log</span><span class="token punctuation">&gt;</span></span> logImpl<span class="token punctuation">;</span>
   <span class="token comment">// æŒ‡å®šVFSçš„å®ç°, VFSæ˜¯mybatisæä¾›çš„ç”¨äºè®¿é—®ASå†…èµ„æºçš„ä¸€ä¸ªç®€ä¾¿æ¥å£</span>
  <span class="token keyword">protected</span> <span class="token class-name">Class</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> VFS<span class="token punctuation">&gt;</span></span> vfsImpl<span class="token punctuation">;</span>
  <span class="token comment">// MyBatis åˆ©ç”¨æœ¬åœ°ç¼“å­˜æœºåˆ¶ï¼ˆLocal Cacheï¼‰é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼ˆcircular referencesï¼‰å’ŒåŠ é€Ÿé‡å¤åµŒå¥—æŸ¥è¯¢ã€‚ é»˜è®¤å€¼ä¸º SESSIONï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šç¼“å­˜ä¸€ä¸ªä¼šè¯ä¸­æ‰§è¡Œçš„æ‰€æœ‰æŸ¥è¯¢ã€‚ è‹¥è®¾ç½®å€¼ä¸º STATEMENTï¼Œæœ¬åœ°ä¼šè¯ä»…ç”¨åœ¨è¯­å¥æ‰§è¡Œä¸Šï¼Œå¯¹ç›¸åŒ SqlSession çš„ä¸åŒè°ƒç”¨å°†ä¸ä¼šå…±äº«æ•°æ®ã€‚</span>
  <span class="token keyword">protected</span> <span class="token class-name">LocalCacheScope</span> localCacheScope <span class="token operator">=</span> <span class="token class-name">LocalCacheScope</span><span class="token punctuation">.</span><span class="token constant">SESSION</span><span class="token punctuation">;</span>
  <span class="token comment">// å½“æ²¡æœ‰ä¸ºå‚æ•°æä¾›ç‰¹å®šçš„ JDBC ç±»å‹æ—¶ï¼Œä¸ºç©ºå€¼æŒ‡å®š JDBC ç±»å‹ã€‚ æŸäº›é©±åŠ¨éœ€è¦æŒ‡å®šåˆ—çš„ JDBC ç±»å‹ï¼Œå¤šæ•°æƒ…å†µç›´æ¥ç”¨ä¸€èˆ¬ç±»å‹å³å¯ï¼Œæ¯”å¦‚ NULLã€VARCHAR æˆ– OTHERã€‚</span>
  <span class="token keyword">protected</span> <span class="token class-name">JdbcType</span> jdbcTypeForNull <span class="token operator">=</span> <span class="token class-name">JdbcType</span><span class="token punctuation">.</span><span class="token constant">OTHER</span><span class="token punctuation">;</span>
  <span class="token comment">// æŒ‡å®šå¯¹è±¡çš„å“ªä¸ªæ–¹æ³•è§¦å‘ä¸€æ¬¡å»¶è¿ŸåŠ è½½ã€‚</span>
  <span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> lazyLoadTriggerMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token string">&quot;equals&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;clone&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hashCode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;toString&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå®ƒå†³å®šé©±åŠ¨ç­‰å¾…æ•°æ®åº“å“åº”çš„ç§’æ•°ã€‚é»˜è®¤ä¸è¶…æ—¶</span>
  <span class="token keyword">protected</span> <span class="token class-name">Integer</span> defaultStatementTimeout<span class="token punctuation">;</span>
  <span class="token comment">// ä¸ºé©±åŠ¨çš„ç»“æœé›†è®¾ç½®é»˜è®¤è·å–æ•°é‡ã€‚</span>
  <span class="token keyword">protected</span> <span class="token class-name">Integer</span> defaultFetchSize<span class="token punctuation">;</span>
  <span class="token comment">// SIMPLE å°±æ˜¯æ™®é€šçš„æ‰§è¡Œå™¨ï¼›REUSE æ‰§è¡Œå™¨ä¼šé‡ç”¨é¢„å¤„ç†è¯­å¥ï¼ˆprepared statementsï¼‰ï¼› BATCH æ‰§è¡Œå™¨å°†é‡ç”¨è¯­å¥å¹¶æ‰§è¡Œæ‰¹é‡æ›´æ–°ã€‚</span>
  <span class="token keyword">protected</span> <span class="token class-name">ExecutorType</span> defaultExecutorType <span class="token operator">=</span> <span class="token class-name">ExecutorType</span><span class="token punctuation">.</span><span class="token constant">SIMPLE</span><span class="token punctuation">;</span>
  <span class="token comment">// æŒ‡å®š MyBatis åº”å¦‚ä½•è‡ªåŠ¨æ˜ å°„åˆ—åˆ°å­—æ®µæˆ–å±æ€§ã€‚ NONE è¡¨ç¤ºå–æ¶ˆè‡ªåŠ¨æ˜ å°„ï¼›PARTIAL åªä¼šè‡ªåŠ¨æ˜ å°„æ²¡æœ‰å®šä¹‰åµŒå¥—ç»“æœé›†æ˜ å°„çš„ç»“æœé›†ã€‚ FULL ä¼šè‡ªåŠ¨æ˜ å°„ä»»æ„å¤æ‚çš„ç»“æœé›†ï¼ˆæ— è®ºæ˜¯å¦åµŒå¥—ï¼‰ã€‚</span>
  <span class="token keyword">protected</span> <span class="token class-name">AutoMappingBehavior</span> autoMappingBehavior <span class="token operator">=</span> <span class="token class-name">AutoMappingBehavior</span><span class="token punctuation">.</span><span class="token constant">PARTIAL</span><span class="token punctuation">;</span>
  <span class="token comment">// æŒ‡å®šå‘ç°è‡ªåŠ¨æ˜ å°„ç›®æ ‡æœªçŸ¥åˆ—ï¼ˆæˆ–è€…æœªçŸ¥å±æ€§ç±»å‹ï¼‰çš„è¡Œä¸ºã€‚è¿™ä¸ªå€¼åº”è¯¥è®¾ç½®ä¸ºWARNINGæ¯”è¾ƒåˆé€‚</span>
  <span class="token keyword">protected</span> <span class="token class-name">AutoMappingUnknownColumnBehavior</span> autoMappingUnknownColumnBehavior <span class="token operator">=</span> <span class="token class-name">AutoMappingUnknownColumnBehavior</span><span class="token punctuation">.</span><span class="token constant">NONE</span><span class="token punctuation">;</span>
  <span class="token comment">// settingsä¸‹çš„propertieså±æ€§</span>
  <span class="token keyword">protected</span> <span class="token class-name">Properties</span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// é»˜è®¤çš„åå°„å™¨å·¥å‚,ç”¨äºæ“ä½œå±æ€§ã€æ„é€ å™¨æ–¹ä¾¿</span>
  <span class="token keyword">protected</span> <span class="token class-name">ReflectorFactory</span> reflectorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultReflectorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¯¹è±¡å·¥å‚, æ‰€æœ‰çš„ç±»resultMapç±»éƒ½éœ€è¦ä¾èµ–äºå¯¹è±¡å·¥å‚æ¥å®ä¾‹åŒ–</span>
  <span class="token keyword">protected</span> <span class="token class-name">ObjectFactory</span> objectFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultObjectFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¯¹è±¡åŒ…è£…å™¨å·¥å‚,ä¸»è¦ç”¨æ¥åœ¨åˆ›å»ºéåŸç”Ÿå¯¹è±¡,æ¯”å¦‚å¢åŠ äº†æŸäº›ç›‘æ§æˆ–è€…ç‰¹æ®Šå±æ€§çš„ä»£ç†ç±»</span>
  <span class="token keyword">protected</span> <span class="token class-name">ObjectWrapperFactory</span> objectWrapperFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultObjectWrapperFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å»¶è¿ŸåŠ è½½çš„å…¨å±€å¼€å…³ã€‚å½“å¼€å¯æ—¶ï¼Œæ‰€æœ‰å…³è”å¯¹è±¡éƒ½ä¼šå»¶è¿ŸåŠ è½½ã€‚ç‰¹å®šå…³è”å…³ç³»ä¸­å¯é€šè¿‡è®¾ç½®fetchTypeå±æ€§æ¥è¦†ç›–è¯¥é¡¹çš„å¼€å…³çŠ¶æ€ã€‚</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> lazyLoadingEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// æŒ‡å®š Mybatis åˆ›å»ºå…·æœ‰å»¶è¿ŸåŠ è½½èƒ½åŠ›çš„å¯¹è±¡æ‰€ç”¨åˆ°çš„ä»£ç†å·¥å…·ã€‚MyBatis 3.3+ä½¿ç”¨JAVASSIST</span>
  <span class="token keyword">protected</span> <span class="token class-name">ProxyFactory</span> proxyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JavassistProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// #224 Using internal Javassist instead of OGNL</span>
  <span class="token comment">// MyBatis å¯ä»¥æ ¹æ®ä¸åŒçš„æ•°æ®åº“å‚å•†æ‰§è¡Œä¸åŒçš„è¯­å¥ï¼Œè¿™ç§å¤šå‚å•†çš„æ”¯æŒæ˜¯åŸºäºæ˜ å°„è¯­å¥ä¸­çš„ databaseId å±æ€§ã€‚</span>
  <span class="token keyword">protected</span> <span class="token class-name">String</span> databaseId<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒMybatisæŠŠæ‰€æœ‰çš„é…ç½®ï¼›resultMapã€Sqlè¯­å¥ã€æ’ä»¶ã€ç¼“å­˜ç­‰éƒ½ç»´æŠ¤åœ¨Configurationä¸­ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œåœ¨Configurationè¿˜æœ‰ä¸€ä¸ªStrictMapå†…éƒ¨ç±»ï¼Œå®ƒç»§æ‰¿äºHashMapå®Œå–„äº†putæ—¶é˜²é‡ã€getæ—¶å–ä¸åˆ°å€¼çš„å¼‚å¸¸å¤„ç†ï¼Œå¦‚ä¸‹ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StrictMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">4950446264854982944L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">StrictMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">,</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">StrictMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> initialCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>initialCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">StrictMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">StrictMap</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>(æ ¸å¿ƒ)åŠ è½½mapperæ–‡ä»¶mapperElement</strong></p><p>Mapperæ–‡ä»¶å¤„ç†æ˜¯Mybatisæ¡†æ¶çš„æ ¸å¿ƒæœåŠ¡ï¼Œæ‰€æœ‰çš„SQLè¯­å¥éƒ½ç¼–å†™åœ¨Mapperä¸­ï¼Œè¿™å—ä¹Ÿæ˜¯æˆ‘ä»¬åˆ†æçš„é‡ç‚¹ï¼Œå…¶ä»–æ¨¡å—å¯ä»¥åç»­è®²è§£ã€‚</p><blockquote><p>XMLConfigBuilder.parseConfiguration()-&gt;mapperElement(root.evalNode(&quot;mappers&quot;));</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mapperElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> parent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">XNode</span> child <span class="token operator">:</span> parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// å¦‚æœè¦åŒæ—¶ä½¿ç”¨packageè‡ªåŠ¨æ‰«æå’Œé€šè¿‡mapperæ˜ç¡®æŒ‡å®šè¦åŠ è½½çš„mapperï¼Œä¸€å®šè¦ç¡®ä¿packageè‡ªåŠ¨æ‰«æçš„èŒƒå›´ä¸åŒ…å«æ˜ç¡®æŒ‡å®šçš„mapperï¼Œå¦åˆ™åœ¨é€šè¿‡packageæ‰«æçš„interfaceçš„æ—¶å€™ï¼Œå°è¯•åŠ è½½å¯¹åº”xmlæ–‡ä»¶çš„loadXmlResource()çš„é€»è¾‘ä¸­å‡ºç°åˆ¤é‡å‡ºé”™ï¼ŒæŠ¥org.apache.ibatis.binding.BindingExceptionå¼‚å¸¸ï¼Œå³ä½¿xmlæ–‡ä»¶ä¸­åŒ…å«çš„å†…å®¹å’Œmapperæ¥å£ä¸­åŒ…å«çš„è¯­å¥ä¸é‡å¤ä¹Ÿä¼šå‡ºé”™ï¼ŒåŒ…æ‹¬åŠ è½½mapperæ¥å£æ—¶è‡ªåŠ¨åŠ è½½çš„xml mapperä¹Ÿä¸€æ ·ä¼šå‡ºé”™ã€‚</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;package&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">String</span> mapperPackage <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         configuration<span class="token punctuation">.</span><span class="token function">addMappers</span><span class="token punctuation">(</span>mapperPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token class-name">String</span> resource <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;resource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">String</span> url <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">String</span> mapperClass <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">XMLMapperBuilder</span> mapperParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           mapperParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">getUrlAsStream</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token class-name">XMLMapperBuilder</span> mapperParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> configuration<span class="token punctuation">,</span> url<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           mapperParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> url <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mapperClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> mapperInterface <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">classForName</span><span class="token punctuation">(</span>mapperClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
           configuration<span class="token punctuation">.</span><span class="token function">addMapper</span><span class="token punctuation">(</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>Mybatisæä¾›äº†ä¸¤ç±»é…ç½®Mapperçš„æ–¹æ³•ï¼Œç¬¬ä¸€ç±»æ˜¯ä½¿ç”¨packageè‡ªåŠ¨æœç´¢çš„æ¨¡å¼ï¼Œè¿™æ ·æŒ‡å®špackageä¸‹æ‰€æœ‰æ¥å£éƒ½ä¼šè¢«æ³¨å†Œä¸ºmapperï¼Œä¹Ÿæ˜¯åœ¨Springä¸­æ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼ï¼Œä¾‹å¦‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>mappers<span class="token punctuation">&gt;</span></span>
  <span class="token operator">&lt;</span><span class="token keyword">package</span> <span class="token namespace">name</span><span class="token operator">=</span><span class="token string">&quot;org.itstack.demo&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>mappers<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å¦å¤–ä¸€ç±»æ˜¯æ˜ç¡®æŒ‡å®šMapperï¼Œè¿™åˆå¯ä»¥é€šè¿‡resourceã€urlæˆ–è€…classè¿›è¡Œç»†åˆ†ï¼Œä¾‹å¦‚ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>mappers<span class="token punctuation">&gt;</span></span>
    <span class="token operator">&lt;</span>mapper resource<span class="token operator">=</span><span class="token string">&quot;mapper/User_Mapper.xml&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>mapper <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>mapper url<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>mappers<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_4-mapperåŠ è½½ä¸åŠ¨æ€ä»£ç†" tabindex="-1"><a class="header-anchor" href="#_4-mapperåŠ è½½ä¸åŠ¨æ€ä»£ç†" aria-hidden="true">#</a> 4. MapperåŠ è½½ä¸åŠ¨æ€ä»£ç†</h3><p>é€šè¿‡packageæ–¹å¼è‡ªåŠ¨æœç´¢åŠ è½½ï¼Œç”Ÿæˆå¯¹åº”çš„mapperä»£ç†ç±»ï¼Œä»£ç å—å’Œæµç¨‹ï¼Œå¦‚ä¸‹ï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mapperElement</span><span class="token punctuation">(</span><span class="token class-name">XNode</span> parent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">XNode</span> child <span class="token operator">:</span> parent<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;package&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> mapperPackage <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configuration<span class="token punctuation">.</span><span class="token function">addMappers</span><span class="token punctuation">(</span>mapperPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-02.png" alt="å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ &amp; åŠ¨æ€ä»£ç†è¿‡ç¨‹"></p><p>MapperåŠ è½½åˆ°ç”Ÿæˆä»£ç†å¯¹è±¡çš„æµç¨‹ä¸­ï¼Œä¸»è¦çš„æ ¸å¿ƒç±»åŒ…æ‹¬ï¼›</p><ol><li>XMLConfigBuilder</li><li>Configuration</li><li>MapperRegistry</li><li>MapperAnnotationBuilder</li><li>MapperProxyFactory</li></ol><blockquote><p>MapperRegistry.java</p></blockquote><p><strong>è§£æåŠ è½½Mapper</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addMappers</span><span class="token punctuation">(</span><span class="token class-name">String</span> packageName<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> superType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// mybatisæ¡†æ¶æä¾›çš„æœç´¢classpathä¸‹æŒ‡å®špackageä»¥åŠå­packageä¸­ç¬¦åˆæ¡ä»¶(æ³¨è§£æˆ–è€…ç»§æ‰¿äºæŸä¸ªç±»/æ¥å£)çš„ç±»ï¼Œé»˜è®¤ä½¿ç”¨Thread.currentThread().getContextClassLoader()è¿”å›çš„åŠ è½½å™¨,å’Œspringçš„å·¥å…·ç±»æ®Šé€”åŒå½’ã€‚</span>
  <span class="token class-name">ResolverUtil</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resolverUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResolverUtil</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token comment">// æ— æ¡ä»¶çš„åŠ è½½æ‰€æœ‰çš„ç±»,å› ä¸ºè°ƒç”¨æ–¹ä¼ é€’äº†Object.classä½œä¸ºçˆ¶ç±»,è¿™ä¹Ÿç»™ä»¥åçš„æŒ‡å®šmapperæ¥å£é¢„ç•™äº†ä½™åœ°</span>
  resolverUtil<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResolverUtil<span class="token punctuation">.</span>IsA</span><span class="token punctuation">(</span>superType<span class="token punctuation">)</span><span class="token punctuation">,</span> packageName<span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token comment">// æ‰€æœ‰åŒ¹é…çš„calsséƒ½è¢«å­˜å‚¨åœ¨ResolverUtil.matcheså­—æ®µä¸­</span>
  <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mapperSet <span class="token operator">=</span> resolverUtil<span class="token punctuation">.</span><span class="token function">getClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> mapperClass <span class="token operator">:</span> mapperSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token comment">//è°ƒç”¨addMapperæ–¹æ³•è¿›è¡Œå…·ä½“çš„mapperç±»/æ¥å£è§£æ</span>
    <span class="token function">addMapper</span><span class="token punctuation">(</span>mapperClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç”Ÿæˆä»£ç†ç±»ï¼šMapperProxyFactory</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">addMapper</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
  <span class="token comment">// å¯¹äºmybatis mapperæ¥å£æ–‡ä»¶ï¼Œå¿…é¡»æ˜¯interfaceï¼Œä¸èƒ½æ˜¯class</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasMapper</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">&quot;Type &quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot; is already known to the MapperRegistry.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">boolean</span> loadCompleted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>      
      <span class="token comment">// ä¸ºmapperæ¥å£åˆ›å»ºä¸€ä¸ªMapperProxyFactoryä»£ç†</span>
      knownMappers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MapperProxyFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// It&#39;s important that the type is added before the parser is run</span>
      <span class="token comment">// otherwise the binding may automatically be attempted by the</span>
      <span class="token comment">// mapper parser. If the type is already known, it won&#39;t try.</span>
      <span class="token class-name">MapperAnnotationBuilder</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperAnnotationBuilder</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      loadCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        knownMappers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨MapperRegistryä¸­ç»´æŠ¤äº†æ¥å£ç±»ä¸ä»£ç†å·¥ç¨‹çš„æ˜ å°„å…³ç³»ï¼ŒknownMappersï¼›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">MapperProxyFactory</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> knownMappers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">MapperProxyFactory</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>MapperProxyFactory.java</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapperProxyFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperInterface<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">MapperMethod</span><span class="token punctuation">&gt;</span></span> methodCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">MapperMethod</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">MapperProxyFactory</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperInterface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface <span class="token operator">=</span> mapperInterface<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMapperInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mapperInterface<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">MapperMethod</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMethodCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> methodCache<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>mapperInterface<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> mapperInterface <span class="token punctuation">}</span><span class="token punctuation">,</span> mapperProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> mapperInterface<span class="token punctuation">,</span> methodCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">newInstance</span><span class="token punctuation">(</span>mapperProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚ä¸Šæ˜¯Mapperçš„ä»£ç†ç±»å·¥ç¨‹ï¼Œæ„é€ å‡½æ•°ä¸­çš„mapperInterfaceå°±æ˜¯å¯¹åº”çš„æ¥å£ç±»ï¼Œå½“å®ä¾‹åŒ–æ—¶å€™ä¼šè·å¾—å…·ä½“çš„MapperProxyä»£ç†ï¼Œé‡Œé¢ä¸»è¦åŒ…å«äº†SqlSessionã€‚</p><h2 id="äº”ã€-mybatis-spring-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#äº”ã€-mybatis-spring-æºç åˆ†æ" aria-hidden="true">#</a> äº”ã€(mybatis-spring)æºç åˆ†æ</h2><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½œä¸ºä¸€æ¬¾å¥½ç”¨çš„ORMæ¡†æ¶ï¼Œä¸€å®šæ˜¯èè‰è„¸(<strong>å•çº¯</strong>)ã€å¾¡å§å¿ƒ(<strong>å¼ºå¤§</strong>)ï¼Œé“ºçš„äº†åºŠ(<strong>å±è”½ä¸JDBCç›´æ¥æ‰“äº¤é“</strong>)ã€æš–çš„äº†æˆ¿(<strong>é€Ÿåº¦æ€§èƒ½å¥½</strong>)ï¼é‰´äºè¿™äº›ä¼˜ç‚¹å‡ ä¹åœ¨å›½å†…äº’è”ç½‘å¤§éƒ¨åˆ†å¼€å‘æ¡†æ¶éƒ½ä¼šä½¿ç”¨åˆ°Mybatisï¼Œå°¤å…¶åœ¨ä¸€äº›éœ€è¦é«˜æ€§èƒ½çš„åœºæ™¯ä¸‹éœ€è¦ä¼˜åŒ–sqlé‚£ä¹ˆä¸€å®šéœ€è¦æ‰‹å†™sqlåœ¨xmlä¸­ã€‚é‚£ä¹ˆï¼Œå‡†å¤‡å¥½äº†å—ï¼å¼€å§‹åˆ†æåˆ†æå®ƒçš„æºç ï¼›</p><h3 id="_1-ä»ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹å¼€å§‹-1" tabindex="-1"><a class="header-anchor" href="#_1-ä»ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹å¼€å§‹-1" aria-hidden="true">#</a> 1. ä»ä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹å¼€å§‹</h3><p>ä¸åˆ†æmybatisæºç ä¸€æ ·ï¼Œå…ˆåšä¸€ä¸ªç®€å•çš„æ¡ˆä¾‹ï¼›å®šä¹‰daoã€ç¼–å†™é…ç½®æ–‡ä»¶ã€junitå•å…ƒæµ‹è¯•ï¼›</p><blockquote><p>SpringApiTest.java</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:spring-config.xml&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringApiTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SpringApiTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ISchoolDao</span> schoolDao<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IUserDao</span> userDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_queryRuleTreeByTreeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">School</span> ruleTree <span class="token operator">=</span> schoolDao<span class="token punctuation">.</span><span class="token function">querySchoolInfoById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>ruleTree<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">User</span> user <span class="token operator">=</span> userDao<span class="token punctuation">.</span><span class="token function">queryUserInfoById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>spring-config-datasource.xml</p></blockquote><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 1.æ•°æ®åº“è¿æ¥æ± ï¼š DriverManagerDataSource ä¹Ÿå¯ä»¥ä½¿ç”¨DBCP2--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.springframework.jdbc.datasource.DriverManagerDataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>driverClassName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${db.jdbc.driverClassName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>url<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${db.jdbc.url}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${db.jdbc.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${db.jdbc.password}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 2.é…ç½®SqlSessionFactoryå¯¹è±¡ --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sqlSessionFactory<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.mybatis.spring.SqlSessionFactoryBean<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- æ³¨å…¥æ•°æ®åº“è¿æ¥æ±  --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- é…ç½®MyBatieså…¨å±€é…ç½®æ–‡ä»¶:mybatis-config.xml --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>configLocation<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:mybatis-config.xml<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- æ‰«æentityåŒ… ä½¿ç”¨åˆ«å --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>typeAliasesPackage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.itstack.demo.po<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- æ‰«æsqlé…ç½®æ–‡ä»¶:mapperéœ€è¦çš„xmlæ–‡ä»¶ --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mapperLocations<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:mapper/*.xml<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 3.é…ç½®æ‰«æDaoæ¥å£åŒ…ï¼ŒåŠ¨æ€å®ç°Daoæ¥å£ï¼Œæ³¨å…¥åˆ°springå®¹å™¨ä¸­ --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.mybatis.spring.mapper.MapperScannerConfigurer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- æ³¨å…¥sqlSessionFactory --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sqlSessionFactoryBeanName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sqlSessionFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- ç»™å‡ºéœ€è¦æ‰«æDaoæ¥å£åŒ…ï¼Œå¤šä¸ªé€—å·éš”å¼€ --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>basePackage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.itstack.demo.dao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
              
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œé‚£ä¹ˆä¼šæœ‰å¦‚ä¸‹ç»“æœï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">{</span><span class="token string">&quot;address&quot;</span><span class="token operator">:</span><span class="token string">&quot;åŒ—äº¬å¸‚æµ·æ·€åŒºé¢å’Œå›­è·¯5å·&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;createTime&quot;</span><span class="token operator">:</span><span class="token number">1571376957000</span><span class="token punctuation">,</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;åŒ—äº¬å¤§å­¦&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;updateTime&quot;</span><span class="token operator">:</span><span class="token number">1571376957000</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token string">&quot;createTime&quot;</span><span class="token operator">:</span><span class="token number">1571376957000</span><span class="token punctuation">,</span><span class="token string">&quot;id&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;èŠ±èŠ±&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;updateTime&quot;</span><span class="token operator">:</span><span class="token number">1571376957000</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢å•å…ƒæµ‹è¯•çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªæ²¡æœ‰æ–¹æ³•ä½“çš„æ³¨è§£å°±è¿™ä¹ˆç¥å¥‡çš„æ‰§è¡Œäº†æˆ‘ä»¬çš„xmlä¸­çš„é…ç½®è¯­å¥å¹¶è¾“å‡ºäº†ç»“æœã€‚å…¶å®ä¸»è¦å¾—ç›Šäºä»¥ä¸‹ä¸¤ä¸ªç±»ï¼›</p><ul><li>org.mybatis.spring.SqlSessionFactoryBean</li><li>org.mybatis.spring.mapper.MapperScannerConfigurer</li></ul><h3 id="_2-æ‰«æè£…é…æ³¨å†Œ-mapperscannerconfigurer" tabindex="-1"><a class="header-anchor" href="#_2-æ‰«æè£…é…æ³¨å†Œ-mapperscannerconfigurer" aria-hidden="true">#</a> 2. æ‰«æè£…é…æ³¨å†Œ(MapperScannerConfigurer)</h3><p>MapperScannerConfigurerä¸ºæ•´ä¸ªDaoæ¥å£å±‚ç”ŸæˆåŠ¨æ€ä»£ç†ç±»æ³¨å†Œï¼Œå¯åŠ¨åˆ°äº†æ ¸å¿ƒä½œç”¨ã€‚è¿™ä¸ªç±»å®ç°äº†å¦‚ä¸‹æ¥å£ï¼Œç”¨æ¥å¯¹æ‰«æçš„Mapperè¿›è¡Œå¤„ç†ï¼š</p><ul><li>BeanDefinitionRegistryPostProcessor</li><li>InitializingBean</li><li>ApplicationContextAware</li><li>BeanNameAware</li></ul><p>æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼›</p><p><img src="https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-03.png" alt="å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ &amp; MapperScannerConfigurerç±»å›¾"></p><p>æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼›</p><p><img src="https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-04.png" alt="å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ &amp; æ‰§è¡Œæµç¨‹å›¾"></p><p>ä¸Šé¢çš„ç±»å›¾+æµç¨‹å›¾ï¼Œå…¶å®å·²ç»å¾ˆæ¸…æ¥šçš„æè¿°äº†MapperScannerConfigureråˆå§‹åŒ–è¿‡ç¨‹ï¼Œä½†å¯¹äºå¤´ä¸€æ¬¡çœ‹çš„æ–°äººæ¥è¯´ä¾æ—§æ˜¯æˆ‘å¤ªéš¾äº†ï¼Œå¥½ç»§ç»­ï¼</p><blockquote><p>MapperScannerConfigurer.java &amp; éƒ¨åˆ†æˆªå–</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processPropertyPlaceHolders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">processPropertyPlaceHolders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">ClassPathMapperScanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathMapperScanner</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setAddToConfig</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>addToConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setAnnotationClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>annotationClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setMarkerInterface</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>markerInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setSqlSessionFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setSqlSessionTemplate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setSqlSessionFactoryBeanName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactoryBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setSqlSessionTemplateBeanName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplateBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">setBeanNameGenerator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nameGenerator<span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">registerFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>basePackage<span class="token punctuation">,</span> <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span><span class="token constant">CONFIG_LOCATION_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å®ç°äº†BeanDefinitionRegistryPostProcessor.postProcessBeanDefinitionRegistryç”¨äºæ³¨å†ŒBeanåˆ°Springå®¹å™¨ä¸­</li><li><strong>306è¡Œ</strong>ï¼šnew ClassPathMapperScanner(registry); ç¡¬ç¼–ç ç±»è·¯å¾„æ‰«æå™¨ï¼Œç”¨äºè§£æMybatisçš„Mapperæ–‡ä»¶</li><li><strong>317è¡Œ</strong>ï¼šscanner.scan å¯¹Mapperè¿›è¡Œæ‰«æã€‚è¿™é‡ŒåŒ…å«äº†ä¸€ä¸ªç»§æ‰¿ç±»å®ç°å…³ç³»çš„è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯æœ¬æ–‡å¼€å¤´çš„æµ‹è¯•é¢˜ã€‚</li></ul><blockquote><p>ClassPathMapperScanner.java &amp; éƒ¨åˆ†æˆªå–</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doScan</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No MyBatis mapper was found in &#39;&quot;</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39; package. Please check your configuration.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">processBeanDefinitions</span><span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä¼˜å…ˆè°ƒç”¨çˆ¶ç±»çš„super.doScan(basePackages);è¿›è¡Œæ³¨å†ŒBeanä¿¡æ¯</li></ul><blockquote><p>ClassPathBeanDefinitionScanner.java &amp; éƒ¨åˆ†æˆªå–</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">,</span> <span class="token string">&quot;At least one base package must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> basePackage <span class="token operator">:</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span> candidate <span class="token operator">:</span> candidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">ScopeMetadata</span> scopeMetadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
			candidate<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">postProcessBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">BeanDefinitionHolder</span> definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
				definitionHolder <span class="token operator">=</span>
						<span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>regi
				beanDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä¼˜å…ˆè°ƒç”¨äº†çˆ¶ç±»çš„doScanæ–¹æ³•ï¼Œç”¨äºMapperæ‰«æå’ŒBeançš„å®šä¹‰ä»¥åŠæ³¨å†Œåˆ°DefaultListableBeanFactoryã€‚ï½›DefaultListableBeanFactoryæ˜¯Springä¸­IOCå®¹å™¨çš„å§‹ç¥–ï¼Œæ‰€æœ‰éœ€è¦å®ä¾‹åŒ–çš„ç±»éƒ½éœ€è¦æ³¨å†Œè¿›æ¥ï¼Œä¹‹ååœ¨åˆå§‹åŒ–ï½</li><li><strong>272è¡Œ</strong>ï¼šfindCandidateComponents(basePackage)ï¼Œæ‰«æpackageåŒ…è·¯å¾„ï¼Œå¯¹äºæ³¨è§£ç±»çš„æœ‰å¦å¤–çš„æ–¹å¼ï¼Œå¤§åŒå°å¼‚</li><li><strong>288è¡Œ</strong>ï¼šregisterBeanDefinition(definitionHolder, this.registry);æ³¨å†ŒBeanä¿¡æ¯çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°ï¼šorg.springframework.beans.factory.support.DefaultListableBeanFactory</li></ul><blockquote><p>ClassPathMapperScanner.java &amp; éƒ¨åˆ†æˆªå–</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">*</span><span class="token operator">*</span><span class="token function">processBeanDefinitions</span><span class="token punctuation">(</span>beanDefinitions<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefinitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">GenericBeanDefinition</span> definition<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">:</span> beanDefinitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    definition <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">GenericBeanDefinition</span><span class="token punctuation">)</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Creating MapperFactoryBean with name &#39;&quot;</span> <span class="token operator">+</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token operator">+</span> <span class="token string">&quot;&#39; and &#39;&quot;</span> <span class="token operator">+</span> definition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39; mapperInterface&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// the mapper interface is the original class of the bean</span>
    <span class="token comment">// but, the actual class of the bean is MapperFactoryBean</span>
    definition<span class="token punctuation">.</span><span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addGenericArgumentValue</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// issue #59</span>
    definition<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperFactoryBean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;addToConfig&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>addToConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> explicitFactoryUsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactoryBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;sqlSessionFactory&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeBeanReference</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactoryBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      explicitFactoryUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;sqlSessionFactory&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
      explicitFactoryUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplateBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>explicitFactoryUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;sqlSessionTemplate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeBeanReference</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplateBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      explicitFactoryUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>explicitFactoryUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot use both: sqlSessionTemplate and sqlSessionFactory together. sqlSessionFactory is ignored.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      definition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;sqlSessionTemplate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
      explicitFactoryUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>explicitFactoryUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Enabling autowire by type for MapperFactoryBean with name &#39;&quot;</span> <span class="token operator">+</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      definition<span class="token punctuation">.</span><span class="token function">setAutowireMode</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>163è¡Œ</strong>ï¼šsuper.doScan(basePackages);ï¼Œè°ƒç”¨å®Œçˆ¶ç±»æ–¹æ³•åå¼€å§‹æ‰§è¡Œå†…éƒ¨æ–¹æ³•ï¼šprocessBeanDefinitions(beanDefinitions)</li><li><strong>186è¡Œ</strong>ï¼šdefinition.getConstructorArgumentValues().addGenericArgumentValue(definition.getBeanClassName()); è®¾ç½®BeanNameå‚æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ï¼šISchoolDaoã€IUserDao</li><li><strong>187è¡Œ</strong>ï¼šdefinition.setBeanClass(this.mapperFactoryBean.getClass());ï¼Œè®¾ç½®BeanClassï¼Œæ¥å£æœ¬èº«æ˜¯æ²¡æœ‰ç±»çš„ï¼Œé‚£ä¹ˆè¿™é‡Œå°†<strong>MapperFactoryBean</strong>ç±»è®¾ç½®è¿›æ¥ï¼Œæœ€ç»ˆæ‰€æœ‰çš„daoå±‚æ¥å£ç±»éƒ½æ˜¯è¿™ä¸ª<strong>MapperFactoryBean</strong></li></ul><blockquote><p>MapperFactoryBean.java &amp; éƒ¨åˆ†æˆªå–</p></blockquote><p>è¿™ä¸ªç±»æœ‰ç»§æ‰¿ä¹Ÿæœ‰æ¥å£å®ç°ï¼Œæœ€å¥½å…ˆäº†è§£ä¸‹æ•´ä½“ç±»å›¾ï¼Œå¦‚ä¸‹ï¼›</p><p><img src="https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-05.png" alt="å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ &amp; MapperFactoryBeanç±»å›¾"></p><p>è¿™ä¸ªç±»å°±éå¸¸é‡è¦äº†ï¼Œæœ€ç»ˆæ‰€æœ‰çš„sqlä¿¡æ¯æ‰§è¡Œéƒ½ä¼šé€šè¿‡è¿™ä¸ªç±»è·å–getObject()ï¼Œä¹Ÿå°±æ˜¯SqlSessionè·å–mapperçš„ä»£ç†ç±»ï¼š<code>MapperProxyFactory-&gt;MapperProxy</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapperFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">SqlSessionDaoSupport</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperInterface<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">boolean</span> addToConfig <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">MapperFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//intentionally empty </span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token class-name">MapperFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperInterface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface <span class="token operator">=</span> mapperInterface<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**  
   * å½“SpringBeanå®¹å™¨åˆå§‹åŒ–æ—¶å€™ä¼šè°ƒç”¨åˆ°checkDaoConfig()ï¼Œä»–æ˜¯ç»§æ‰¿ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•
   * <span class="token punctuation">{</span><span class="token keyword">@inheritDoc</span><span class="token punctuation">}</span>
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">checkDaoConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">checkDaoConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">,</span> <span class="token string">&quot;Property &#39;mapperInterface&#39; is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token function">getSqlSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>addToConfig <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>configuration<span class="token punctuation">.</span><span class="token function">hasMapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        configuration<span class="token punctuation">.</span><span class="token function">addMapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error while adding the mapper &#39;&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface <span class="token operator">+</span> <span class="token string">&quot;&#39; to configuration.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * <span class="token punctuation">{</span><span class="token keyword">@inheritDoc</span><span class="token punctuation">}</span>
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getSqlSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>72è¡Œ</strong>ï¼šcheckDaoConfig()ï¼Œå½“SpringBeanå®¹å™¨åˆå§‹åŒ–æ—¶å€™ä¼šè°ƒç”¨åˆ°checkDaoConfig()ï¼Œä»–æ˜¯ç»§æ‰¿ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•</li><li><strong>95è¡Œ</strong>ï¼šgetSqlSession().getMapper(this.mapperInterface);ï¼Œé€šè¿‡æ¥å£è·å–Mapper(ä»£ç†ç±»)ï¼Œè°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼› <ul><li><p><code>DefaultSqlSession.getMapper(Class&lt;T&gt; type)</code>ï¼Œè·å–Mapper</p></li><li><p><code>Configuration.getMapper(Class&lt;T&gt; type, SqlSession sqlSession)</code>ï¼Œä»é…ç½®ä¸­è·å–</p></li><li><p><code>MapperRegistry.getMapper(Class&lt;T&gt; type, SqlSession sqlSession)</code>ï¼Œä»æ³¨å†Œä¸­å¿ƒè·å–åˆ°å®ä¾‹åŒ–ç”Ÿæˆ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getMapper</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">MapperProxyFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperProxyFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MapperProxyFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> knownMappers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mapperProxyFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">&quot;Type &quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot; is not known to the MapperRegistry.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> mapperProxyFactory<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">&quot;Error getting mapper instance. Cause: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>mapperProxyFactory.newInstance(sqlSession);ï¼Œé€šè¿‡åå°„å·¥ç¨‹ç”ŸæˆMapperProxy</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>mapperInterface<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> mapperInterface <span class="token punctuation">}</span><span class="token punctuation">,</span> mapperProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> mapperInterface<span class="token punctuation">,</span> methodCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">newInstance</span><span class="token punctuation">(</span>mapperProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul><blockquote><p>MapperProxy.java &amp; éƒ¨åˆ†æˆªå–</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapperProxy</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">6424540398559729838L</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperInterface<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">MapperMethod</span><span class="token punctuation">&gt;</span></span> methodCache<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">MapperProxy</span><span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> mapperInterface<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">MapperMethod</span><span class="token punctuation">&gt;</span></span> methodCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSession <span class="token operator">=</span> sqlSession<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mapperInterface <span class="token operator">=</span> mapperInterface<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>methodCache <span class="token operator">=</span> methodCache<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDefaultMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">invokeDefaultMethod</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">unwrapThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token class-name">MapperMethod</span> mapperMethod <span class="token operator">=</span> <span class="token function">cachedMapperMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> mapperMethod<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">MapperMethod</span> <span class="token function">cachedMapperMethod</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MapperMethod</span> mapperMethod <span class="token operator">=</span> methodCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mapperMethod <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mapperMethod <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperMethod</span><span class="token punctuation">(</span>mapperInterface<span class="token punctuation">,</span> method<span class="token punctuation">,</span> sqlSession<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      methodCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> mapperMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mapperMethod<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@UsesJava7</span>
  <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">invokeDefaultMethod</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span><span class="token punctuation">&gt;</span></span> constructor <span class="token operator">=</span> <span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span><span class="token punctuation">.</span><span class="token keyword">class</span>
        <span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>constructor<span class="token punctuation">.</span><span class="token function">isAccessible</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> declaringClass <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> constructor
        <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>declaringClass<span class="token punctuation">,</span>
            <span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span> <span class="token operator">|</span> <span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span><span class="token punctuation">.</span><span class="token constant">PROTECTED</span>
                <span class="token operator">|</span> <span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span><span class="token punctuation">.</span><span class="token constant">PACKAGE</span> <span class="token operator">|</span> <span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span><span class="token punctuation">.</span><span class="token constant">PUBLIC</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unreflectSpecial</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> declaringClass<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invokeWithArguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong>58è¡Œ</strong>ï¼šfinal MapperMethod mapperMethod = cachedMapperMethod(method);ï¼Œä»ç¼“å­˜ä¸­è·å–MapperMethod</p></li><li><p><strong>59è¡Œ</strong>ï¼šmapperMethod.execute(sqlSession, args);ï¼Œæ‰§è¡ŒSQLè¯­å¥ï¼Œå¹¶è¿”å›ç»“æœ(åˆ°è¿™å…³äºæŸ¥è¯¢è·å–ç»“æœå°±åˆ°éª¨å¤´(å¹²)å±‚äº†)ï¼›INSERTã€UPDATEã€DELETEã€SELECT</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">SqlSession</span> sqlSession<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Object</span> result<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">INSERT</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token constant">UPDATE</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token constant">DELETE</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> <span class="token function">rowCountResult</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token constant">SELECT</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">hasResultHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">executeWithResultHandler</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token function">executeForMany</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token function">executeForMap</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">returnsCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token function">executeForCursor</span><span class="token punctuation">(</span>sqlSession<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">convertArgsToSqlCommandParam</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token constant">FLUSH</span><span class="token operator">:</span>
      result <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">flushStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown execution method for: &quot;</span> <span class="token operator">+</span> command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>method<span class="token punctuation">.</span><span class="token function">returnsVoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">&quot;Mapper method &#39;&quot;</span> <span class="token operator">+</span> command<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token operator">+</span> <span class="token string">&quot; attempted to return null from a method with a primitive return type (&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;).&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>ä»¥ä¸Šå¯¹äºMapperScannerConfigurerè¿™ä¸€å±‚å°±åˆ†æå®Œäº†ï¼Œä»æ‰«æå®šä¹‰æ³¨å…¥åˆ°ä¸ºSpringå®¹å™¨å‡†å¤‡Beançš„ä¿¡æ¯ï¼Œä»£ç†ã€åå°„ã€SQLæ‰§è¡Œï¼ŒåŸºæœ¬å°±åŒ…æ‹¬å…¨éƒ¨æ ¸å¿ƒå†…å®¹äº†ï¼Œæ¥ä¸‹æ¥åœ¨åˆ†æä¸‹SqlSessionFactoryBean</p><h3 id="_3-sqlsessionå®¹å™¨å·¥å‚åˆå§‹åŒ–-sqlsessionfactorybean" tabindex="-1"><a class="header-anchor" href="#_3-sqlsessionå®¹å™¨å·¥å‚åˆå§‹åŒ–-sqlsessionfactorybean" aria-hidden="true">#</a> 3. SqlSessionå®¹å™¨å·¥å‚åˆå§‹åŒ–(SqlSessionFactoryBean)</h3><p>SqlSessionFactoryBeanåˆå§‹åŒ–è¿‡ç¨‹ä¸­éœ€è¦å¯¹ä¸€äº›è‡ªèº«å†…å®¹è¿›è¡Œå¤„ç†ï¼Œå› æ­¤ä¹Ÿéœ€è¦å®ç°å¦‚ä¸‹æ¥å£ï¼›</p><ul><li><code>FactoryBean&lt;SqlSessionFactory&gt;</code></li><li><code>InitializingBean -&gt; void afterPropertiesSet() throws Exception</code></li><li><code>ApplicationListener&lt;ApplicationEvent&gt;</code></li></ul><p><img src="https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-mybatis-06.png" alt="å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ &amp; SqlSessionFactoryBeanåˆå§‹åŒ–æµç¨‹"></p><p>ä»¥ä¸Šçš„æµç¨‹å…¶å®å·²ç»å¾ˆæ¸…æ™°çš„æè¿°æ•´ä¸ªæ ¸å¿ƒæµç¨‹ï¼Œä½†åŒæ ·å¯¹äºæ–°æ‰‹ä¸Šè·¯ä¼šæœ‰éšœç¢ï¼Œé‚£ä¹ˆï¼å¥½ï¼Œç»§ç»­ï¼</p><blockquote><p>SqlSessionFactoryBean.java &amp; éƒ¨åˆ†æˆªå–</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token function">notNull</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> <span class="token string">&quot;Property &#39;dataSource&#39; is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">notNull</span><span class="token punctuation">(</span>sqlSessionFactoryBuilder<span class="token punctuation">,</span> <span class="token string">&quot;Property &#39;sqlSessionFactoryBuilder&#39; is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">(</span>configuration <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> configLocation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>configuration <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> configLocation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;Property &#39;configuration&#39; and &#39;configLocation&#39; can not specified with together&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactory <span class="token operator">=</span> <span class="token function">buildSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>afterPropertiesSet()ï¼ŒInitializingBeanæ¥å£ä¸ºbeanæä¾›äº†åˆå§‹åŒ–æ–¹æ³•çš„æ–¹å¼ï¼Œå®ƒåªåŒ…æ‹¬afterPropertiesSetæ–¹æ³•ï¼Œå‡¡æ˜¯ç»§æ‰¿è¯¥æ¥å£çš„ç±»ï¼Œåœ¨åˆå§‹åŒ–beançš„æ—¶å€™éƒ½ä¼šæ‰§è¡Œè¯¥æ–¹æ³•ã€‚</li><li><strong>380è¡Œ</strong>ï¼šbuildSqlSessionFactory();å†…éƒ¨æ–¹æ³•æ„å»ºï¼Œæ ¸å¿ƒåŠŸèƒ½ç»§ç»­å¾€ä¸‹çœ‹ã€‚</li></ul><blockquote><p>SqlSessionFactoryBean.java &amp; éƒ¨åˆ†æˆªå–</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">buildSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  <span class="token class-name">Configuration</span> configuration<span class="token punctuation">;</span>
  <span class="token class-name">XMLConfigBuilder</span> xmlConfigBuilder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapperLocations<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Resource</span> mapperLocation <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mapperLocations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mapperLocation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">XMLMapperBuilder</span> xmlMapperBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLMapperBuilder</span><span class="token punctuation">(</span>mapperLocation<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            configuration<span class="token punctuation">,</span> mapperLocation<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getSqlFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xmlMapperBuilder<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NestedIOException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to parse mapping resource: &#39;&quot;</span> <span class="token operator">+</span> mapperLocation <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">ErrorContext</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Parsed mapper file: &#39;&quot;</span> <span class="token operator">+</span> mapperLocation <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Property &#39;mapperLocations&#39; was not specified or no matching resources found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionFactoryBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>513è¡Œ</strong>ï¼šfor (Resource mapperLocation : this.mapperLocations) å¾ªç¯è§£æMapperå†…å®¹</li><li><strong>519è¡Œ</strong>ï¼šXMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(...) è§£æXMLMapperBuilder</li><li><strong>521è¡Œ</strong>ï¼šxmlMapperBuilder.parse() æ‰§è¡Œè§£æï¼Œå…·ä½“å¦‚ä¸‹ï¼›</li></ul><blockquote><p>XMLMapperBuilder.java &amp; éƒ¨åˆ†æˆªå–</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XMLMapperBuilder</span> <span class="token keyword">extends</span> <span class="token class-name">BaseBuilder</span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">XPathParser</span> parser<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MapperBuilderAssistant</span> builderAssistant<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">XNode</span><span class="token punctuation">&gt;</span></span> sqlFragments<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> resource<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">bindMapperForNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token class-name">String</span> namespace <span class="token operator">=</span> builderAssistant<span class="token punctuation">.</span><span class="token function">getCurrentNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>namespace <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> boundType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
         boundType <span class="token operator">=</span> <span class="token class-name">Resources</span><span class="token punctuation">.</span><span class="token function">classForName</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">//ignore, bound type is not required</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>boundType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>configuration<span class="token punctuation">.</span><span class="token function">hasMapper</span><span class="token punctuation">(</span>boundType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// Spring may not know the real resource name so we set a flag</span>
           <span class="token comment">// to prevent loading again this resource from the mapper interface</span>
           <span class="token comment">// look at MapperAnnotationBuilder#loadXmlResource</span>
           configuration<span class="token punctuation">.</span><span class="token function">addLoadedResource</span><span class="token punctuation">(</span><span class="token string">&quot;namespace:&quot;</span> <span class="token operator">+</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
           configuration<span class="token punctuation">.</span><span class="token function">addMapper</span><span class="token punctuation">(</span>boundType<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™é‡Œ<strong>413è¡Œ</strong>éå¸¸é‡è¦ï¼Œconfiguration.addMapper(boundType);ï¼ŒçœŸæ­£åˆ°äº†æ·»åŠ Mapperåˆ°é…ç½®ä¸­å¿ƒ</li></ul><blockquote><p>MapperRegistry.java &amp; éƒ¨åˆ†æˆªå–</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapperRegistry</span> <span class="token punctuation">{</span>

  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">addMapper</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasMapper</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BindingException</span><span class="token punctuation">(</span><span class="token string">&quot;Type &quot;</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">&quot; is already known to the MapperRegistry.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">boolean</span> loadCompleted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        knownMappers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MapperProxyFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// It&#39;s important that the type is added before the parser is run</span>
        <span class="token comment">// otherwise the binding may automatically be attempted by the</span>
        <span class="token comment">// mapper parser. If the type is already known, it won&#39;t try.</span>
        <span class="token class-name">MapperAnnotationBuilder</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapperAnnotationBuilder</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loadCompleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loadCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          knownMappers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>67è¡Œ</strong>ï¼šåˆ›å»ºä»£ç†å·¥ç¨‹ <code>knownMappers.put(type, new MapperProxyFactory&lt;T&gt;(type));</code></li></ul><p>æˆªè‡³åˆ°è¿™ï¼ŒMapperScannerConfigurerã€SqlSessionFactoryBeanï¼Œä¸¤ä¸ªç±»å¹²çš„äº‹æƒ…å°±ç›¸èåˆäº†ï¼›</p><ul><li><p>ç¬¬ä¸€ä¸ªç”¨äºæ‰«æDaoæ¥å£è®¾ç½®ä»£ç†ç±»æ³¨å†Œåˆ°IOCä¸­ï¼Œç”¨äºåç»­ç”ŸæˆBeanå®ä½“ç±»ï¼ŒMapperFactoryBeanï¼Œå¹¶å¯ä»¥é€šè¿‡mapperInterfaceä»Configurationè·å–Mapper</p></li><li><p>å¦ä¸€ä¸ªç”¨äºç”ŸæˆSqlSessionå·¥å‚åˆå§‹åŒ–ï¼Œè§£æMapperé‡Œçš„XMLé…ç½®è¿›è¡ŒåŠ¨æ€ä»£ç†MapperProxyFactory-&gt;MapperProxyæ³¨å…¥åˆ°Configurationçš„Mapper</p></li><li><p>æœ€ç»ˆåœ¨æ³¨è§£ç±»çš„å¸®åŠ©ä¸‹è¿›è¡Œæ–¹æ³•æ³¨å…¥ï¼Œç­‰æ‰§è¡Œæ“ä½œæ—¶å€™å³å¯è·å¾—åŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„CRUDæ“ä½œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">ISchoolDao</span> schoolDao<span class="token punctuation">;</span>

schoolDao<span class="token punctuation">.</span><span class="token function">querySchoolInfoById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="å…­ã€ç»¼ä¸Šæ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å…­ã€ç»¼ä¸Šæ€»ç»“" aria-hidden="true">#</a> å…­ã€ç»¼ä¸Šæ€»ç»“</h2>`,139),b=n("li",null,"åˆ†æè¿‡ç¨‹è¾ƒé•¿ç¯‡å¹…ä¹Ÿå¾ˆå¤§ï¼Œä¸ä¸€å®šä¸€å¤©å°±èƒ½çœ‹æ‡‚æ•´ä¸ªæµç¨‹ï¼Œä½†å½“è€ä¸‹å¿ƒæ¥ä¸€ç‚¹ç‚¹ç ”ç©¶ï¼Œè¿˜æ˜¯å¯ä»¥è·å¾—å¾ˆå¤šçš„æ”¶è·çš„ã€‚ä»¥ååœ¨é‡åˆ°è¿™ç±»çš„å¼‚å¸¸å°±å¯ä»¥è¿åˆƒè€Œè§£äº†ï¼ŒåŒæ—¶ä¹Ÿæœ‰åŠ©äºé¢è¯•ã€æ‹›è˜ï¼",-1),g=n("li",null,"ä¹‹æ‰€ä»¥åˆ†æMybatisæœ€å¼€å§‹æ˜¯æƒ³åœ¨Daoä¸ŠåŠ è‡ªå®šä¹‰æ³¨è§£ï¼Œå‘ç°åˆ‡é¢æ‹¦æˆªä¸åˆ°ã€‚æƒ³åˆ°è¿™æ˜¯è¢«åŠ¨æ€ä»£ç†çš„ç±»ï¼Œä¹‹åå±‚å±‚å¾€å¾€ä¸‹æ‰’ç›´åˆ°MapperProxy.invokeï¼å½“ç„¶ï¼ŒMybatisæä¾›äº†è‡ªå®šä¹‰æ’ä»¶å¼€å‘ã€‚",-1),y=n("li",null,"ä»¥ä¸Šçš„æºç åˆ†æåªæ˜¯å¯¹éƒ¨åˆ†æ ¸å¿ƒå†…å®¹è¿›è¡Œåˆ†æï¼Œå¦‚æœå¸Œæœ›äº†è§£å…¨éƒ¨å¯ä»¥å‚è€ƒèµ„æ–™ï¼›MyBatis 3æºç æ·±åº¦è§£æï¼Œå¹¶è°ƒè¯•ä»£ç ã€‚IDEAä¸­è¿˜æ˜¯å¾ˆæ–¹ä¾¿çœ‹æºç çš„ï¼ŒåŒ…æ‹¬å¯ä»¥æŸ¥çœ‹ç±»å›¾ã€è°ƒç”¨é¡ºåºç­‰ã€‚",-1),f=n("li",null,"mybatisã€mybatis-springä¸­å…¶å®æœ€é‡è¦çš„æ˜¯å°†Mapperé…ç½®æ–‡ä»¶è§£æä¸æ¥å£ç±»ç»„è£…æˆä»£ç†ç±»è¿›è¡Œæ˜ å°„ï¼Œä»¥æ­¤æ¥æ–¹ä¾¿å¯¹æ•°æ®åº“çš„CRUDæ“ä½œã€‚ä»æºç åˆ†æåï¼Œå¯ä»¥è·å¾—æ›´å¤šçš„ç¼–ç¨‹ç»éªŒ(å¥—è·¯)ã€‚",-1),w={href:"https://github.com/mybatis/mybatis-3",target:"_blank",rel:"noopener noreferrer"},h={href:"https://mybatis.org/mybatis-3/zh/index.html",target:"_blank",rel:"noopener noreferrer"};function q(S,M){const a=e("ExternalLinkIcon");return o(),c("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),k,s("åšå®¢ï¼š"),n("a",r,[s("https://bugstack.cn"),t(a)])]),d,n("ul",null,[n("li",null,[s("æ¡ˆä¾‹æºç ï¼š"),n("a",m,[s("https://github.com/fuzhengwei/itstack-demo-code-mybatis"),t(a)])])]),v,n("ul",null,[b,g,y,f,n("li",null,[s("Mybatisç›¸å…³é“¾æ¥ï¼› "),n("ul",null,[n("li",null,[n("a",w,[s("https://github.com/mybatis/mybatis-3"),t(a)])]),n("li",null,[n("a",h,[s("https://mybatis.org/mybatis-3/zh/index.html"),t(a)])])])])])])}const T=p(i,[["render",q],["__file","2019-12-25-_yuanmafenxi_Mybatisjiekoumeiyoushixianleiweishimekeyizhixingzengshangaicha.html.vue"]]);export{T as default};
