import{_ as p,r as o,o as c,c as i,a as n,b as s,d as e,e as t}from"./app-3RcBQnkC.js";const l={},u=n("h1",{id:"é¢ç»æ‰‹å†Œ-Â·-ç¬¬18ç¯‡ã€Šaqs-å…±äº«é”-semaphoreã€countdownlatch-å¬è¯´æ•°æ®åº“è¿æ¥æ± å¯ä»¥ç”¨åˆ°-ã€‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#é¢ç»æ‰‹å†Œ-Â·-ç¬¬18ç¯‡ã€Šaqs-å…±äº«é”-semaphoreã€countdownlatch-å¬è¯´æ•°æ®åº“è¿æ¥æ± å¯ä»¥ç”¨åˆ°-ã€‹","aria-hidden":"true"},"#"),s(" é¢ç»æ‰‹å†Œ Â· ç¬¬18ç¯‡ã€ŠAQS å…±äº«é”ï¼ŒSemaphoreã€CountDownLatchï¼Œå¬è¯´æ•°æ®åº“è¿æ¥æ± å¯ä»¥ç”¨åˆ°ï¼ã€‹")],-1),r=n("br",null,null,-1),d={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},k=t(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>å­¦Javaæ€ä¹ˆèƒ½ï¼Œçªé£çŒ›è¿›çš„æˆé•¿ï¼Ÿ</code></p><p>æ˜¯ä¸æ˜¯ä½ çœ‹è§è¿‡çš„çªé£çŒ›è¿›éƒ½æ˜¯åˆ«äººï¼Œä½†è‡ªå·±å´å¾ˆéš¾ï¼</p><p>å…¶å®å¹¶æ²¡æœ‰ä¸€å¤©çš„çªé£çŒ›è¿›ï¼Œä¹Ÿæ²¡æœ‰ä¸€å£åƒå‡ºæ¥çš„èƒ–å­ã€‚æœ‰å¾—æ›´å¤šçš„æ—¶å€™æ—¥ç§¯æœˆç´¯ã€ä¸æ–­æ²‰æ·€ï¼Œæœ€åæ‰èƒ½çˆ†å‘ã€ç ´å±€ï¼</p><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¦‚æœä½ å¤§å­¦æ¯•ä¸šæ—¶å€™å·²ç»å†™äº†40ä¸‡è¡Œä»£ç ï¼Œè¿˜æ‰¾ä¸åˆ°å·¥ä½œå—ï¼Ÿä½†40ä¸‡è¡Œå¹³å‡åˆ°æ¯å¤©å¹¶ä¸ä¼šå¾ˆå¤šï¼Œé‡è¦çš„æ˜¯æŒä¹‹ä»¥æ’çš„åšæŒã€‚</p><h2 id="äºŒã€é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#äºŒã€é¢è¯•é¢˜" aria-hidden="true">#</a> äºŒã€é¢è¯•é¢˜</h2><p><code>è°¢é£æœºï¼Œå°è®°ï¼</code> ä¸œé£å¹ã€æˆ˜é¼“æ“‚ï¼Œä¸åŠ ç­ã€è°æ€•è°ï¼å“ˆå“ˆå“ˆï¼Œæ‰¾æˆ‘å¤§å“¥å»ã€‚</p><p><strong>è°¢é£æœº</strong>ï¼šå–‚ï¼Œå¤§å“¥ã€‚æˆ‘å¥³å‹é¢è¯•å¡ä½äº†ï¼Œå¼ºäºº<code>é”</code>éš¾ï¼Œé”æˆ‘ä¹Ÿä¸ä¼šï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šä½ ä¸åº”è¯¥ä¸ä¼šå‘€ï¼Œé—®ä½ ä¸€ä¸ªï¼ŒåŸºäº AQS å®ç°çš„é”éƒ½æœ‰å“ªäº›ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šå—¯ï¼Œæœ‰ ReentrantLock...</p><p><strong>é¢è¯•å®˜</strong>ï¼šè¿˜æœ‰å‘¢ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šå¥½åƒæƒ³ä¸èµ·æ¥äº†ï¼Œsyncä¹Ÿä¸æ˜¯ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šå“ï¼Œå­¦ç‚¹æ¼ç‚¹ï¼Œä¸æ€è€ƒã€ä¸æ€»ç»“ã€ä¸è®°å½•ã€‚ä½ è¿™æ ·äººå®¶é¢è¯•ä½ å°±æ²¡æ³•èŠäº†ï¼Œæœ€èµ·ç ä½ è¦æœ‰ç‚¹æ·±åº¦ã€‚</p><p><strong>è°¢é£æœº</strong>ï¼šå˜¿å˜¿ï¼Œè®°ä½äº†ã€‚æ¥æˆ‘å®¶åƒç«é”…å§ï¼Œç»†èŠã€‚</p><h2 id="ä¸‰ã€å…±äº«é”-å’Œ-aqs" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€å…±äº«é”-å’Œ-aqs" aria-hidden="true">#</a> ä¸‰ã€å…±äº«é” å’Œ AQS</h2><h3 id="_1-åŸºäº-aqs-å®ç°çš„é”æœ‰å“ªäº›" tabindex="-1"><a class="header-anchor" href="#_1-åŸºäº-aqs-å®ç°çš„é”æœ‰å“ªäº›" aria-hidden="true">#</a> 1. åŸºäº AQS å®ç°çš„é”æœ‰å“ªäº›ï¼Ÿ</h3><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-18-1.png" alt="å›¾ 18-1 åŸºäº AQS å®ç°çš„é”"></p><p>AQSï¼ˆAbstractQueuedSynchronizerï¼‰ï¼Œæ˜¯ Java å¹¶å‘åŒ…ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç±»ï¼Œå¤§éƒ¨åˆ†é”çš„å®ç°ä¹Ÿæ˜¯åŸºäº AQS å®ç°çš„ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li><code>ReentrantLock</code>ï¼Œå¯é‡å…¥é”ã€‚è¿™ä¸ªæ˜¯æˆ‘ä»¬æœ€å¼€å§‹ä»‹ç»çš„é”ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„é”ã€‚é€šå¸¸ä¼šä¸ synchronized åšæ¯”è¾ƒä½¿ç”¨ã€‚</li><li><code>ReentrantReadWriteLock</code>ï¼Œè¯»å†™é”ã€‚è¯»é”æ˜¯å…±äº«é”ã€å†™é”æ˜¯ç‹¬å é”ã€‚</li><li><code>Semaphore</code>ï¼Œä¿¡å·é‡é”ã€‚ä¸»è¦ç”¨äºæ§åˆ¶æµé‡ï¼Œæ¯”å¦‚ï¼šæ•°æ®åº“è¿æ¥æ± ç»™ä½ åˆ†é…10ä¸ªé“¾æ¥ï¼Œé‚£ä¹ˆè®©ä½ æ¥ä¸€ä¸ªè¿ä¸€ä¸ªï¼Œè¿åˆ°10ä¸ªè¿˜æ²¡æœ‰äººé‡Šæ”¾ï¼Œé‚£ä½ å°±ç­‰ç­‰ã€‚</li><li><code>CountDownLatch</code>ï¼Œé—­é”ã€‚Latch é—¨é—©çš„æ„æ€ï¼Œæ¯”å¦‚ï¼šè¯´å››ä¸ªäººä¸€ä¸ªæ¼‚æµè‰‡ï¼Œåæ»¡äº†å°±æ¨ä¸‹æ°´ã€‚</li></ul><p>è¿™ä¸€ç« èŠ‚æˆ‘ä»¬ä¸»è¦æ¥ä»‹ç» Semaphore ï¼Œä¿¡å·é‡é”çš„å®ç°ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä»‹ç»ä¸€ä¸ªå…³äºå…±äº«é”çš„ä½¿ç”¨å’Œæºç åˆ†æã€‚</p><h3 id="_2-semaphore-å…±äº«é”ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_2-semaphore-å…±äº«é”ä½¿ç”¨" aria-hidden="true">#</a> 2. Semaphore å…±äº«é”ä½¿ç”¨</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Semaphore</span> semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ„é€ å‡½æ•°å…¥å‚ï¼Œpermitsï¼šä¿¡å·é‡ã€fairï¼šå…¬å¹³é”/éå…¬å¹³é”</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;è¹²å‘&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;è¹²å‘ç¼–å·ï¼š&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿäº†ä¸€ä¸ªåœ¨é«˜é€ŸæœåŠ¡åŒºï¼Œå•æ‰€æ’é˜Ÿè¹²å‘çš„åœºæ™¯ã€‚ç”±äºå‘ä½æœ‰é™ï¼Œä¸ºäº†é¿å…é€ æˆæ‹¥æŒ¤å’Œè¸©è¸ï¼Œä¿å®‰äººå‘˜åœ¨é—¨å£æ‹¦ç€ï¼Œæ„Ÿè§‰å·®ä¸å¤šï¼Œä¸€æ¬¡é‡Šæ”¾ä¸¤ä¸ªè¿›å»ï¼Œä¸€ç›´åˆ°éƒ½é‡Šæ”¾ã€‚<em>ä½ ä¹Ÿå¯ä»¥æƒ³æˆæ—©ä¸Šååœ°é“ä¸Šç­ï¼Œæˆ–è€…æ—ºå­£å»å…¬å›­ï¼Œéƒ½æ˜¯ä¸€æ‰¹ä¸€æ‰¹çš„æ”¾è¡Œ</em></p><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>è¹²å‘ç¼–å·ï¼š<span class="token number">0</span>è¹²å‘
è¹²å‘ç¼–å·ï¼š<span class="token number">1</span>è¹²å‘

è¹²å‘ç¼–å·ï¼š<span class="token number">2</span>è¹²å‘
è¹²å‘ç¼–å·ï¼š<span class="token number">3</span>è¹²å‘

è¹²å‘ç¼–å·ï¼š<span class="token number">4</span>è¹²å‘
è¹²å‘ç¼–å·ï¼š<span class="token number">5</span>è¹²å‘

è¹²å‘ç¼–å·ï¼š<span class="token number">6</span>è¹²å‘
è¹²å‘ç¼–å·ï¼š<span class="token number">7</span>è¹²å‘

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Semaphore çš„æ„é€ å‡½æ•°å¯ä»¥ä¼ é€’æ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ï¼Œæœ€ç»ˆçš„æµ‹è¯•ç»“æœä¹Ÿä¸åŒï¼Œå¯ä»¥è‡ªè¡Œå°è¯•ã€‚</li><li>æµ‹è¯•è¿è¡Œæ—¶ï¼Œä¼šå…ˆè¾“å‡º<code>0å‘ã€1å‘</code>ï¼Œ<code>ä¹‹å2å‘ã€3å‘</code>...ï¼Œæ¯æ¬¡éƒ½æ˜¯è¿™æ ·ä¸¤ä¸ªï¼Œä¸¤ä¸ªçš„é‡Šæ”¾ã€‚è¿™å°±æ˜¯ Semaphore ä¿¡å·é‡é”çš„ä½œç”¨ã€‚</li></ul><h3 id="_3-semaphore-æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_3-semaphore-æºç åˆ†æ" aria-hidden="true">#</a> 3. Semaphore æºç åˆ†æ</h3><h4 id="_3-1-æ„é€ å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_3-1-æ„é€ å‡½æ•°" aria-hidden="true">#</a> 3.1 æ„é€ å‡½æ•°</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>permitsï¼šn. è®¸å¯è¯ï¼Œç‰¹è®¸è¯(å°¤æŒ‡é™æœŸçš„)</em></p>`,31),v=n("em",null,"åœ¨æˆ‘ä»¬å‰é¢çš„ç« èŠ‚å·²ç»ä»‹ç»äº†å…¬å¹³é”ç›¸å…³å†…å®¹å’Œå®ç°ï¼Œä»¥åŠCLHã€MCS",-1),m={href:"https://bugstack.cn/interview/2020/11/04/%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C-%E7%AC%AC16%E7%AF%87-%E7%A0%81%E5%86%9C%E4%BC%9A%E9%94%81-ReentrantLock%E4%B9%8B%E5%85%AC%E5%B9%B3%E9%94%81%E8%AE%B2%E8%A7%A3%E5%92%8C%E5%AE%9E%E7%8E%B0.html",target:"_blank",rel:"noopener noreferrer"},b=t(`<p><strong>åˆå§‹<code>è®¸å¯è¯</code>æ•°é‡</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">FairSync</span><span class="token operator">/</span><span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">int</span> newState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> newState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ„é€ å‡½æ•°åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæ— è®ºæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ï¼Œéƒ½ä¼šè®¾ç½® AQS ä¸­ state æ•°é‡å€¼ã€‚è¿™ä¸ªå€¼ä¹Ÿå°±æ˜¯ä¸ºäº†ä¸‹æ–‡ä¸­å¯ä»¥è·å–çš„ä¿¡å·é‡æ‰£å‡å’Œå¢åŠ çš„å€¼ã€‚</p><h4 id="_3-2-acquire-è·å–ä¿¡å·é‡" tabindex="-1"><a class="header-anchor" href="#_3-2-acquire-è·å–ä¿¡å·é‡" aria-hidden="true">#</a> 3.2 acquire è·å–ä¿¡å·é‡</h4><table><thead><tr><th>æ–¹æ³•</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>semaphore.acquire()</code></td><td>ä¸€æ¬¡è·å–ä¸€ä¸ªä¿¡å·é‡ï¼Œå“åº”ä¸­æ–­</td></tr><tr><td><code>semaphore.acquire(2)</code></td><td>ä¸€æ¬¡è·å–nä¸ªä¿¡å·é‡ï¼Œå“åº”ä¸­æ–­ï¼ˆä¸€æ¬¡å 2ä¸ªå‘ï¼‰</td></tr><tr><td><code>semaphore.acquireUninterruptibly()</code></td><td>ä¸€æ¬¡è·å–ä¸€ä¸ªä¿¡å·é‡ï¼Œä¸å“åº”ä¸­æ–­</td></tr><tr><td><code>semaphore.acquireUninterruptibly(2)</code></td><td>ä¸€æ¬¡è·å–nä¸ªä¿¡å·é‡ï¼Œä¸å“åº”ä¸­æ–­</td></tr></tbody></table><ul><li>å…¶å®è·å–ä¿¡å·é‡çš„è¿™å››ä¸ªæ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯ï¼Œä¸€æ¬¡è·å–å‡ ä¸ªå’Œæ˜¯å¦å“åº”ä¸­æ–­çš„ç»„åˆã€‚</li><li><code>semaphore.acquire()</code>ï¼Œæºç ä¸­å®é™…è°ƒç”¨çš„æ–¹æ³•æ˜¯ï¼Œ<code> sync.acquireSharedInterruptibly(1)</code>ã€‚ä¹Ÿå°±æ˜¯ç›¸åº”ä¸­æ–­ï¼Œä¸€æ¬¡åªå ä¸€ä¸ªå‘ã€‚</li><li><code>semaphore.acquire(2)</code>ï¼ŒåŒç†è¿™ä¸ªå°±æ˜¯ä¸€æ¬¡è¦å ä¸¤ä¸ªåé¢ï¼Œä¹Ÿå°±æ˜¯è®¸å¯è¯ã€‚<em>ç”Ÿæ´»ä¸­çš„åœºæ™¯å°±æ˜¯æˆ‘ç»™æˆ‘æœ‹å‹æ’çš„å¯¹ï¼Œå¥¹æ¥äº†ï¼Œè¿›æ¥å§ã€‚</em></li></ul><h4 id="_3-3-acquire-é‡Šæ”¾ä¿¡å·é‡" tabindex="-1"><a class="header-anchor" href="#_3-3-acquire-é‡Šæ”¾ä¿¡å·é‡" aria-hidden="true">#</a> 3.3 acquire é‡Šæ”¾ä¿¡å·é‡</h4><table><thead><tr><th>æ–¹æ³•</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>semaphore.release()</code></td><td>ä¸€æ¬¡é‡Šæ”¾ä¸€ä¸ªä¿¡å·é‡</td></tr><tr><td><code>semaphore.release(2)</code></td><td>ä¸€æ¬¡è·å–nä¸ªä¿¡å·é‡</td></tr></tbody></table><p>æœ‰è·å–å°±å¾—æœ‰é‡Šæ”¾ï¼Œè·å–äº†å‡ ä¸ªä¿¡å·é‡å°±è¦é‡Šæ”¾å‡ ä¸ªä¿¡å·é‡ã€‚<em>å½“ç„¶ä½ å¯ä»¥å°è¯•ä¸€ä¸‹ï¼Œè·å–ä¿¡å·é‡ semaphore.acquire(2) ä¸¤ä¸ªï¼Œé‡Šæ”¾ä¿¡å·é‡ semaphore.release(1)ï¼Œçœ‹çœ‹è¿è¡Œæ•ˆæœ</em></p><h4 id="_3-4-å…¬å¹³é”å®ç°" tabindex="-1"><a class="header-anchor" href="#_3-4-å…¬å¹³é”å®ç°" aria-hidden="true">#</a> 3.4 å…¬å¹³é”å®ç°</h4><p><strong>ä¿¡å·é‡è·å–è¿‡ç¨‹</strong>ï¼Œä¸€ç›´åˆ°å…¬å¹³é”å®ç°ã€‚<code>semaphore.acquire</code> -&gt; <code>sync.acquireSharedInterruptibly(permits)</code> -&gt; <code>tryAcquireShared(arg)</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">permits</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sync<span class="token punctuation">.</span><span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">doAcquireSharedInterruptibly</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>FairSync.tryAcquireShared</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> available <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> remaining <span class="token operator">=</span> available <span class="token operator">-</span> acquires<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>remaining <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>available<span class="token punctuation">,</span> remaining<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> remaining<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>hasQueuedPredecessors</code>ï¼Œå…¬å¹³é”çš„ä¸»è¦å®ç°é€»è¾‘éƒ½åœ¨äºè¿™ä¸ªæ–¹æ³•çš„ä½¿ç”¨ã€‚å®ƒçš„ç›®çš„å°±æ˜¯åˆ¤æ–­æœ‰çº¿ç¨‹æ’åœ¨è‡ªå·±å‰é¢æ²¡ï¼Œä»¥åŠæŠŠçº¿ç¨‹æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„é€»è¾‘å®ç°ã€‚<em>åœ¨å‰é¢æˆ‘ä»¬ä»‹ç»è¿‡CLHç­‰å®ç°ï¼Œå¯ä»¥å¾€å‰ä¸€ç« èŠ‚é˜…è¯»</em></li><li><code>for (;;)</code>ï¼Œæ˜¯ä¸€ä¸ªè‡ªæ—‹çš„è¿‡ç¨‹ï¼Œé€šè¿‡ CAS æ¥è®¾ç½® state åç§»é‡å¯¹åº”å€¼ã€‚è¿™æ ·å°±å¯ä»¥é¿å…å¤šçº¿ç¨‹ä¸‹ç«äº‰è·å–ä¿¡å·é‡å†²çªã€‚</li><li><code>getState()</code>ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­å·²ç»åˆå§‹åŒ– state å€¼ï¼Œåœ¨è¿™é‡Œè·å–ä¿¡å·é‡æ—¶å°±æ˜¯ä½¿ç”¨ CAS ä¸æ–­çš„æ‰£å‡ã€‚</li><li>å¦å¤–éœ€è¦æ³¨æ„ï¼Œå…±äº«é”å’Œç‹¬å é”åœ¨è¿™é‡Œæ˜¯æœ‰åŒºåˆ«çš„ï¼Œç‹¬å é”ç›´æ¥è¿”å›true/falseï¼Œå…±äº«é”è¿”å›çš„æ˜¯intå€¼ã€‚ <ul><li>å¦‚æœè¯¥å€¼å°äº0ï¼Œåˆ™å½“å‰çº¿ç¨‹è·å–å…±äº«é”å¤±è´¥ã€‚</li><li>å¦‚æœè¯¥å€¼å¤§äº0ï¼Œåˆ™å½“å‰çº¿ç¨‹è·å–å…±äº«é”æˆåŠŸï¼Œå¹¶ä¸”æ¥ä¸‹æ¥å…¶ä»–çº¿ç¨‹å°è¯•è·å–å…±äº«é”çš„è¡Œä¸ºå¾ˆå¯èƒ½æˆåŠŸã€‚</li><li>å¦‚æœè¯¥å€¼ç­‰äº0ï¼Œåˆ™å½“å‰çº¿ç¨‹è·å–å…±äº«é”æˆåŠŸï¼Œä½†æ˜¯æ¥ä¸‹æ¥å…¶ä»–çº¿ç¨‹å°è¯•è·å–å…±äº«é”çš„è¡Œä¸ºä¼šå¤±è´¥ã€‚</li></ul></li></ul><h4 id="_3-5-éå…¬å¹³é”å®ç°" tabindex="-1"><a class="header-anchor" href="#_3-5-éå…¬å¹³é”å®ç°" aria-hidden="true">#</a> 3.5 éå…¬å¹³é”å®ç°</h4><p><strong>NonfairSync.nonfairTryAcquireShared</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">nonfairTryAcquireShared</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">nonfairTryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> available <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> remaining <span class="token operator">=</span> available <span class="token operator">-</span> acquires<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>remaining <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>available<span class="token punctuation">,</span> remaining<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> remaining<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æœ‰äº†å…¬å¹³é”çš„å®ç°ï¼Œéå…¬å¹³é”çš„ç†è§£å°±æ¯”è¾ƒç®€å•äº†ï¼Œåªæ˜¯æ‹¿å»äº† <code>if (hasQueuedPredecessors())</code> çš„åˆ¤æ–­æ“ä½œã€‚</li><li>å…¶ä»–çš„é€»è¾‘å®ç°éƒ½å’Œå…¬å¹³é”ä¸€è‡´ã€‚</li></ul><h4 id="_3-6-è·å–ä¿¡å·é‡å¤±è´¥-åŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#_3-6-è·å–ä¿¡å·é‡å¤±è´¥-åŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—" aria-hidden="true">#</a> 3.6 è·å–ä¿¡å·é‡å¤±è´¥ï¼ŒåŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—</h4><p>åœ¨å…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°æ­£å¸¸è·å–ä¿¡å·é‡çš„é€»è¾‘ã€‚é‚£ä¹ˆå¦‚æœæ­¤æ—¶ä¸èƒ½æ­£å¸¸è·å–ä¿¡å·é‡å‘¢ï¼Ÿå…¶å®è¿™éƒ¨åˆ†çº¿ç¨‹å°±éœ€è¦åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ã€‚</p><p><strong>doAcquireSharedInterruptibly</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">doAcquireSharedInterruptibly</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SHARED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é¦–å…ˆ <code>doAcquireSharedInterruptibly</code> æ–¹æ³•æ¥è‡ª AQS çš„å†…éƒ¨æ–¹æ³•ï¼Œä¸æˆ‘ä»¬åœ¨å­¦ä¹ ç«äº‰é”æ—¶æœ‰éƒ¨åˆ†çŸ¥è¯†ç‚¹ç›¸åŒï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å·®å¼‚ã€‚æ¯”å¦‚ï¼š<code>addWaiter(Node.SHARED)</code>ï¼Œ<code>tryAcquireShared</code>ï¼Œæˆ‘ä»¬ä¸»è¦ä»‹ç»ä¸‹è¿™å†…å®¹ã€‚</li><li><code>Node.SHARED</code>ï¼Œå…¶å®æ²¡æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæ ‡è®°ä½œç”¨ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å…±äº«ã€‚<code>final boolean isShared() { return nextWaiter == SHARED; }</code></li><li><code>tryAcquireShared</code>ï¼Œä¸»è¦æ˜¯æ¥è‡ª <code>Semaphore</code> å…±äº«é”ä¸­å…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°ã€‚ç”¨æ¥è·å–åŒæ­¥çŠ¶æ€ã€‚</li><li><code>setHeadAndPropagate(node, r)</code>ï¼Œå¦‚æœr &gt; 0ï¼ŒåŒæ­¥æˆåŠŸååˆ™å°†å½“å‰çº¿ç¨‹ç»“ç‚¹è®¾ç½®ä¸ºå¤´ç»“ç‚¹ï¼ŒåŒæ—¶ helpGCï¼Œp.next = nullï¼Œæ–­é“¾æ“ä½œã€‚</li><li><code>shouldParkAfterFailedAcquire(p, node)</code>ï¼Œè°ƒæ•´åŒæ­¥é˜Ÿåˆ—ä¸­ node ç»“ç‚¹çš„çŠ¶æ€ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦åº”è¯¥è¢«æŒ‚èµ·ã€‚è¿™åœ¨æˆ‘ä»¬ä¹‹å‰å…³äºé”çš„æ–‡ç« ä¸­å·²ç»ä»‹ç»ã€‚</li><li><code>parkAndCheckInterrupt()</code>ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¢«ä¸­æ–­ï¼Œå¦‚æœä¸­æ–­ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå½“å‰ç»“ç‚¹è¯·æ±‚ä¹Ÿå°±ç»“æŸã€‚</li><li><code>cancelAcquire(node)</code>ï¼Œå–æ¶ˆè¯¥èŠ‚ç‚¹çš„çº¿ç¨‹è¯·æ±‚ã€‚</li></ul><h3 id="_4-countdownlatch-å…±äº«é”ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_4-countdownlatch-å…±äº«é”ä½¿ç”¨" aria-hidden="true">#</a> 4. CountDownLatch å…±äº«é”ä½¿ç”¨</h3><p>CountDownLatch ä¹Ÿæ˜¯å…±äº«é”çš„ä¸€ç§ç±»å‹ï¼Œä¹‹æ‰€ä»¥åœ¨è¿™é‡Œä½“ç°ä¸‹ï¼Œæ˜¯å› ä¸ºå®ƒå’Œ Semaphore å…±äº«é”ï¼Œæ—¢ç›¸ä¼¼æœ‰ä¸åŒã€‚</p><p>CountDownLatch æ›´å¤šä½“ç°çš„ç»„å›¢ä¸€æ³¢çš„æ€æƒ³ï¼ŒåŒæ ·æ˜¯æ§åˆ¶äººæ•°ï¼Œä½†æ˜¯éœ€è¦å¤Ÿä¸€çªã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬è¯´è¿‡çš„4ä¸ªäººä¸€èµ·ä¸Šçš®åˆ’è‰‡ã€ä¸¤ä¸ªäººä¸€èµ·ä¸Šè··è··æ¿ã€<em>2ä¸ªäººä¸€èµ·è¹²å‘æˆ‘æ²¡è§è¿‡</em>ï¼Œè¿™æ ·çš„æ–¹å¼å°±æ˜¯é—¨é—© CountDownLatch é”çš„æ€æƒ³ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ExecutorService</span> exec <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> millis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š&quot;</span> <span class="token operator">+</span> millis <span class="token operator">+</span> <span class="token string">&quot;(millis)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å®Œäº‹ä¸€ä¸ªæ‰£å‡ä¸€ä¸ªåé¢</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç­‰å¾…æ¸¸å®¢</span>
    latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;èˆ¹é•¿æ€¥èºäº†ï¼Œå¼€èˆ¹!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å…³é—­çº¿ç¨‹æ± </span>
    exec<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™ä¸€ä¸ªå…¬å›­æ¸¸èˆ¹çš„åœºæ™¯æ¡ˆä¾‹ï¼Œç­‰å¾…10ä¸ªä¹˜å®¢ä¸Šä¼ ï¼Œä»–ä»¬æ¯”è¾ƒå¢¨è¿¹ã€‚</li><li>ä¸Šä¸€ä¸ªæ‰£å‡ä¸€ä¸ª <code>latch.countDown()</code></li><li>ç­‰å¾…æ¸¸å®¢éƒ½ä¸Šèˆ¹ <code>latch.await()</code></li><li>æœ€åèˆ¹é•¿å¼€èˆ¹ï¼ï¼<code>æ€¥èºäº†</code></li></ul><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š<span class="token function">6689</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span>
ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š<span class="token function">2303</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span>
ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š<span class="token function">8208</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span>
ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š<span class="token function">435</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span>
ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š<span class="token function">9489</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span>
ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š<span class="token function">4937</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span>
ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š<span class="token function">2771</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span>
ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š<span class="token function">4823</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span>
ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š<span class="token function">1989</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span>
ç­‰å¾…æ¸¸å®¢ä¸Šèˆ¹ï¼Œè€—æ—¶ï¼š<span class="token function">8506</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span>
èˆ¹é•¿æ€¥èºäº†ï¼Œå¼€èˆ¹<span class="token operator">!</span>

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨ä½ å®é™…çš„æµ‹è¯•ä¸­ä¼šå‘ç°ï¼Œ<code>èˆ¹é•¿æ€¥èºäº†ï¼Œå¼€èˆ¹!</code>ï¼Œä¼šéœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ã€‚</li><li>è¿™é‡Œä½“ç°çš„å°±æ˜¯é—¨é—©çš„æ€æƒ³ï¼Œç»„é˜Ÿã€ä¸€æ³¢å¸¦èµ°ã€‚</li><li>CountDownLatch çš„å®ç°ä¸ Semaphore åŸºæœ¬ç›¸åŒã€ç»†èŠ‚ç•¥æœ‰å·®å¼‚ï¼Œå°±ä¸å†åšæºç åˆ†æäº†ã€‚</li></ul><h2 id="å››ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å››ã€æ€»ç»“" aria-hidden="true">#</a> å››ã€æ€»ç»“</h2><ul><li>åœ¨æœ‰äº† AQSã€CLHã€MCSï¼Œç­‰ç›¸å…³é”çš„çŸ¥è¯†äº†è§£åï¼Œåœ¨å­¦ä¹ å…¶ä»–çŸ¥è¯†ç‚¹ä¹Ÿç›¸å¯¹å®¹æ˜“ã€‚åŸºæœ¬ä»¥ä¸Šå’Œå‰å‡ ç« èŠ‚å…³äºé”çš„ä»‹ç»ï¼Œä¹Ÿæ˜¯é¢è¯•ä¸­å®¹æ˜“é—®åˆ°çš„ç‚¹ã€‚<em>å¯èƒ½ç”±äºç›®å‰åˆ†å¸ƒå¼å¼€å‘è¾ƒå¤šï¼Œå•æœºçš„å¤šçº¿ç¨‹æ€§èƒ½å‹æ¦¨ä¸€èˆ¬è¾ƒå°‘ï¼Œä½†æ˜¯å¯¹è¿™éƒ¨åˆ†çŸ¥è¯†çš„äº†è§£éå¸¸é‡è¦</em></li><li>å¾—ç›ŠäºLeeè€çˆ·å­çš„æ“åˆ€ï¼Œå¹¶å‘åŒ…é”çš„è®¾è®¡çœŸçš„éå¸¸ä¼˜ç§€ã€‚æ¯ä¸€å¤„çš„å®ç°éƒ½å¯ä»¥è¯´æ˜¯ç²¾ç›Šæ±‚ç²¾ï¼Œæ‰€ä»¥åœ¨å­¦ä¹ çš„æ—¶å€™å¯ä»¥æŠŠå°å‚…å“¥çš„æ–‡ç« å½“ä½œæŠ›ç –ï¼Œä¹‹åç»§ç»­æ·±æŒ–è®¾è®¡ç²¾é«“ï¼Œä¸æ–­æ·±å…¥ã€‚</li><li>å…±äº«é”çš„ä½¿ç”¨å¯èƒ½å¹³æ—¶å¹¶ä¸å¤šï¼Œä½†å¦‚æœä½ éœ€è¦è®¾è®¡ä¸€æ¬¾ç±»ä¼¼æ•°æ®åº“çº¿ç¨‹æ± çš„è®¾è®¡ï¼Œé‚£ä¹ˆè¿™æ ·çš„ä¿¡å·é‡é”çš„æ€æƒ³å°±éå¸¸é‡è¦äº†ã€‚æ‰€ä»¥åœ¨å­¦ä¹ çš„æ—¶å€™ä¹Ÿéœ€è¦æœ‰æŠ€æœ¯è¿ç§»çš„èƒ½ï¼Œä¸æ–­æŠŠè¿™äº›çŸ¥è¯†å¤ç”¨åˆ°å®é™…çš„ä¸šåŠ¡å¼€å‘ä¸­ã€‚</li></ul>`,34);function h(y,w){const a=o("ExternalLinkIcon");return c(),i("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),r,s("åšå®¢ï¼š"),n("a",d,[s("https://bugstack.cn"),e(a)])]),k,n("p",null,[s("é»˜è®¤æƒ…å†µä¸‹åªéœ€è¦ä¼ å…¥ permits è®¸å¯è¯æ•°é‡å³å¯ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡å…è®¸æ”¾è¡Œå‡ ä¸ªçº¿ç¨‹ã€‚æ„é€ å‡½æ•°ä¼šåˆ›å»ºéå…¬å¹³é”ã€‚å¦‚æœä½ éœ€è¦ä½¿ç”¨ Semaphore å…±äº«é”ä¸­çš„å…¬å¹³é”ï¼Œé‚£ä¹ˆå¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªæ„é€ å‡½æ•°çš„å‚æ•° fair = false/trueã€‚trueï¼šFairSyncï¼Œå…¬å¹³é”ã€‚"),v,s(),n("a",m,[s("ã€Šå…¬å¹³é”ä»‹ç»ã€‹"),e(a)])]),b])}const g=p(l,[["render",h],["__file","2020-11-18-mianjingshouce Â· di18pianã€ŠAQS gongxiangsuoï¼ŒSemaphoreã€CountDownLatchï¼Œtingshuoshujukulianjiechikeyiyongdaoï¼ã€‹.html.vue"]]);export{g as default};
