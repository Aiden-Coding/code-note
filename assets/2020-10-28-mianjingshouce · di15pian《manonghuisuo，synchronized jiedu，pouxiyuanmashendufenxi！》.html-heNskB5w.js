import{_ as t,r as o,o as c,c as l,a as n,b as s,d as p,e}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"é¢ç»æ‰‹å†Œ-Â·-ç¬¬15ç¯‡ã€Šç å†œä¼šé”-synchronized-è§£æ¯’-å‰–ææºç æ·±åº¦åˆ†æ-ã€‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#é¢ç»æ‰‹å†Œ-Â·-ç¬¬15ç¯‡ã€Šç å†œä¼šé”-synchronized-è§£æ¯’-å‰–ææºç æ·±åº¦åˆ†æ-ã€‹","aria-hidden":"true"},"#"),s(" é¢ç»æ‰‹å†Œ Â· ç¬¬15ç¯‡ã€Šç å†œä¼šé”ï¼Œsynchronized è§£æ¯’ï¼Œå‰–ææºç æ·±åº¦åˆ†æï¼ã€‹")],-1),r=n("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=e(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>æ„Ÿè§‰ä»€ä¹ˆéƒ½ä¸ä¼šï¼Œä»å“ªå¼€å§‹å‘€ï¼</code></p><p>è¿™æ˜¯æœ€è¿‘æˆ‘æ€»èƒ½è¢«é—®åˆ°çš„é—®é¢˜ï¼Œä¹Ÿç¡®å®æ˜¯ã€‚ä¸€ä¸ªåˆå…¥ç¼–ç¨‹èŒåœºçš„æ–°äººï¼Œæˆ–æ˜¯ä¸€ä¸ªæƒ³é‡æ–°åŠªåŠ›å­¦ä¹ çš„è€å¸æœºï¼Œè¿™ä¹Ÿä¸ä¼šï¼Œé‚£ä¹Ÿä¸ä¼šï¼Œæ€»ä¼šçŠ¯æ„ä»å“ªå¼€å§‹ã€‚</p><p>è®²é“ç†ï¼Œæ¯•ç«Ÿ Java æ¶‰åŠçš„çŸ¥è¯†å¤ªå¤šäº†ï¼Œè¦å­¦åº”è¯¥æ˜¯å­¦ä¼šå­¦ä¹ çš„èƒ½åŠ›ï¼Œè€Œä¸æ˜¯å»èƒŒé¢˜ã€èƒŒç­”æ¡ˆï¼Œæ‹¾äººç‰™æ…§æ˜¯ä¸ä¼šæœ‰å¤ªå¤šæ”¶ç›Šçš„ã€‚</p><p>å­¦ä¹ çš„è¿‡ç¨‹è¦æ‰¾å¯¹æ–¹æ³•ï¼Œé‡åˆ°é—®é¢˜æ—¶æœ€å¥½èƒ½è‡ªå·±æƒ³æƒ³ï¼Œä½ æœ‰å“ªäº›æ–¹å¼å­¦ä¼šè¿™äº›çŸ¥è¯†ã€‚æ˜¯ä¸æ„Ÿè§‰å³ä½¿è®©ä½ å»ç™¾åº¦æœï¼Œä½ éƒ½ä¸çŸ¥é“åº”è¯¥æ‹¿å“ªä¸ªå…³é”®å­—æœï¼åªèƒ½æ‹¿ç€é—®é¢˜ç›´æ¥æ‰¾äººé—®ï¼Œè¿™æ ·ç¼ºå°‘æ€è€ƒï¼Œç¼ºå°‘å¤§è„‘æ’å—å¢™çš„è¿‡ç¨‹ï¼Œå…¶å®æœ€åä¹Ÿå¾ˆéš¾å­¦ä¼šã€‚</p><p>æ‰€ä»¥ï¼Œä½ è¦å­¦ä¼šçš„æ˜¯è‡ªæˆ‘å­¦ä¹ çš„èƒ½åŠ›ï¼Œä¹‹åæ˜¯ä»å“ªå¼€å§‹éƒ½å¯ä»¥ï¼Œé‡è¦çš„æ˜¯å¼€å§‹å’ŒåšæŒï¼</p><h2 id="äºŒã€é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#äºŒã€é¢è¯•é¢˜" aria-hidden="true">#</a> äºŒã€é¢è¯•é¢˜</h2><p><code>è°¢é£æœºï¼Œå°è®°</code>ï¼Œå‘¨æœ«é€›å®Œå¥¥ç‰¹è±æ–¯ï¼Œå›æ¥å°±è·‘é¢è¯•å®˜å®¶å»äº†ï¼</p><p><strong>è°¢é£æœº</strong>ï¼šduangã€duangã€duangï¼Œæˆ‘æ¥äº†ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šæ¥çš„è¿˜æŒºå‡†æ—¶ï¼Œæ´—æ´—æ‰‹åƒé¥­å§ï¼</p><p><strong>è°¢é£æœº</strong>ï¼šå˜¿å˜¿...</p><p><strong>é¢è¯•å®˜</strong>ï¼šä½ çœ‹æˆ‘è¿™å—é±¼è±†è…ï¼Œåƒä¸åƒ synchronized é”ï¼</p><p><strong>è°¢é£æœº</strong>ï¼šå•Šï¼ï¼Ÿ</p><p><strong>é¢è¯•å®˜</strong>ï¼šé£æœºï¼Œæ­£å¥½é—®ä½ ã€‚synchronizedã€volatileï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«å‘€ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šå—¯ï¼Œvolatile ä¿è¯å¯è§æ€§ï¼Œsynchronized ä¿è¯åŸå­æ€§ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šé‚£ä¸ç”¨ volatileï¼Œåªç”¨ synchronized ä¿®é¥°æ–¹å¼ï¼Œèƒ½ä¿è¯å¯è§æ€§å—ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šè¿™...ï¼Œæˆ‘æ²¡éªŒè¯è¿‡ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šåƒå§ï¼Œåƒå§ï¼ä¸€ä¼šç»™ä½ ä¸ª synchronized å­¦ä¹ å¤§çº²ï¼Œç…§ç€æ•´ç†çŸ¥è¯†ç‚¹ï¼</p><h2 id="ä¸‰ã€synchronized-è§£æ¯’" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€synchronized-è§£æ¯’" aria-hidden="true">#</a> ä¸‰ã€synchronized è§£æ¯’</h2><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-15-00.png" alt="å›¾ 15-0 é¢è¯•å®˜ç»™è°¢é£æœºçš„ï¼Œsynchronized å­¦ä¹ å¤§çº²"></p><h3 id="_1-å¯¹è±¡ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-å¯¹è±¡ç»“æ„" aria-hidden="true">#</a> 1. å¯¹è±¡ç»“æ„</h3><h4 id="_1-1-å¯¹è±¡ç»“æ„ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#_1-1-å¯¹è±¡ç»“æ„ä»‹ç»" aria-hidden="true">#</a> 1.1 å¯¹è±¡ç»“æ„ä»‹ç»</h4><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-15-01.png" alt="å›¾ 15-1 64ä½JVMå¯¹è±¡ç»“æ„æè¿°"></p><p><strong>HotSpotè™šæ‹Ÿæœº</strong> markOop.cpp ä¸­çš„ C++ ä»£ç æ³¨é‡Šç‰‡æ®µï¼Œæè¿°äº† 64bits ä¸‹ mark-word çš„å­˜å‚¨çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯å›¾ 15-1 çš„ç»“æ„ç¤ºæ„ã€‚</p><p>è¿™éƒ¨åˆ†çš„æºç æ³¨é‡Šå¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">64</span> bits<span class="token operator">:</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
unused<span class="token operator">:</span><span class="token number">25</span> hash<span class="token operator">:</span><span class="token number">31</span> <span class="token operator">--</span><span class="token operator">&gt;</span><span class="token operator">|</span> unused<span class="token operator">:</span><span class="token number">1</span>   age<span class="token operator">:</span><span class="token number">4</span>    biased_lock<span class="token operator">:</span><span class="token number">1</span> lock<span class="token operator">:</span><span class="token number">2</span> <span class="token punctuation">(</span>normal object<span class="token punctuation">)</span>
<span class="token class-name">JavaThread</span><span class="token operator">*</span><span class="token operator">:</span><span class="token number">54</span> epoch<span class="token operator">:</span><span class="token number">2</span> unused<span class="token operator">:</span><span class="token number">1</span>   age<span class="token operator">:</span><span class="token number">4</span>    biased_lock<span class="token operator">:</span><span class="token number">1</span> lock<span class="token operator">:</span><span class="token number">2</span> <span class="token punctuation">(</span>biased object<span class="token punctuation">)</span>
<span class="token class-name">PromotedObject</span><span class="token operator">*</span><span class="token operator">:</span><span class="token number">61</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span><span class="token operator">|</span> promo_bits<span class="token operator">:</span><span class="token number">3</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span><span class="token operator">|</span> <span class="token punctuation">(</span><span class="token constant">CMS</span> promoted object<span class="token punctuation">)</span>
size<span class="token operator">:</span><span class="token number">64</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span><span class="token operator">|</span> <span class="token punctuation">(</span><span class="token constant">CMS</span> free block<span class="token punctuation">)</span>

unused<span class="token operator">:</span><span class="token number">25</span> hash<span class="token operator">:</span><span class="token number">31</span> <span class="token operator">--</span><span class="token operator">&gt;</span><span class="token operator">|</span> cms_free<span class="token operator">:</span><span class="token number">1</span> age<span class="token operator">:</span><span class="token number">4</span>    biased_lock<span class="token operator">:</span><span class="token number">1</span> lock<span class="token operator">:</span><span class="token number">2</span> <span class="token punctuation">(</span><span class="token class-name">COOPs</span> <span class="token operator">&amp;&amp;</span> normal object<span class="token punctuation">)</span>
<span class="token class-name">JavaThread</span><span class="token operator">*</span><span class="token operator">:</span><span class="token number">54</span> epoch<span class="token operator">:</span><span class="token number">2</span> cms_free<span class="token operator">:</span><span class="token number">1</span> age<span class="token operator">:</span><span class="token number">4</span>    biased_lock<span class="token operator">:</span><span class="token number">1</span> lock<span class="token operator">:</span><span class="token number">2</span> <span class="token punctuation">(</span><span class="token class-name">COOPs</span> <span class="token operator">&amp;&amp;</span> biased object<span class="token punctuation">)</span>
narrowOop<span class="token operator">:</span><span class="token number">32</span> unused<span class="token operator">:</span><span class="token number">24</span> cms_free<span class="token operator">:</span><span class="token number">1</span> unused<span class="token operator">:</span><span class="token number">4</span> promo_bits<span class="token operator">:</span><span class="token number">3</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span><span class="token operator">|</span> <span class="token punctuation">(</span><span class="token class-name">COOPs</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">CMS</span> promoted object<span class="token punctuation">)</span>
unused<span class="token operator">:</span><span class="token number">21</span> size<span class="token operator">:</span><span class="token number">35</span> <span class="token operator">--</span><span class="token operator">&gt;</span><span class="token operator">|</span> cms_free<span class="token operator">:</span><span class="token number">1</span> unused<span class="token operator">:</span><span class="token number">7</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">&gt;</span><span class="token operator">|</span> <span class="token punctuation">(</span><span class="token class-name">COOPs</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">CMS</span> free block<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,27),m=n("em",null,"æºç åœ°å€",-1),v={href:"http://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/oops/markOop.hpp",target:"_blank",rel:"noopener noreferrer"},b=e(`<p><strong>HotSpotè™šæ‹Ÿæœºä¸­</strong>ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­å­˜å‚¨çš„å¸ƒå±€å¯ä»¥åˆ†ä¸ºä¸‰å—åŒºåŸŸï¼š<code>å¯¹è±¡å¤´ï¼ˆHeaderï¼‰</code>ã€<code>å®ä¾‹æ•°æ®ï¼ˆInstance Dataï¼‰</code>å’Œ<code>å¯¹é½å¡«å……ï¼ˆPaddingï¼‰</code>ã€‚</p><ul><li>mark-wordï¼šå¯¹è±¡æ ‡è®°å­—æ®µå 8ä¸ªå­—èŠ‚ï¼Œç”¨äºå­˜å‚¨ä¸€äº›åˆ—çš„æ ‡è®°ä½ï¼Œæ¯”å¦‚ï¼šå“ˆå¸Œå€¼ã€è½»é‡çº§é”çš„æ ‡è®°ä½ï¼Œåå‘é”æ ‡è®°ä½ã€åˆ†ä»£å¹´é¾„ç­‰ã€‚</li><li>Klass Pointerï¼šClasså¯¹è±¡çš„ç±»å‹æŒ‡é’ˆï¼ŒJdk1.8é»˜è®¤å¼€å¯æŒ‡é’ˆå‹ç¼©åä¸º4å­—èŠ‚ï¼Œå…³é—­æŒ‡é’ˆå‹ç¼©ï¼ˆ<code>-XX:-UseCompressedOops</code>ï¼‰åï¼Œé•¿åº¦ä¸º8å­—èŠ‚ã€‚å…¶æŒ‡å‘çš„ä½ç½®æ˜¯å¯¹è±¡å¯¹åº”çš„Classå¯¹è±¡ï¼ˆå…¶å¯¹åº”çš„å…ƒæ•°æ®å¯¹è±¡ï¼‰çš„å†…å­˜åœ°å€ã€‚</li><li>å¯¹è±¡å®é™…æ•°æ®ï¼šåŒ…æ‹¬å¯¹è±¡çš„æ‰€æœ‰æˆå‘˜å˜é‡ï¼Œå¤§å°ç”±å„ä¸ªæˆå‘˜å˜é‡å†³å®šï¼Œæ¯”å¦‚ï¼šbyteå 1ä¸ªå­—èŠ‚8æ¯”ç‰¹ä½ã€intå 4ä¸ªå­—èŠ‚32æ¯”ç‰¹ä½ã€‚</li><li>å¯¹é½ï¼šæœ€åè¿™æ®µç©ºé—´è¡¥å…¨å¹¶éå¿…é¡»ï¼Œä»…ä»…ä¸ºäº†èµ·åˆ°å ä½ç¬¦çš„ä½œç”¨ã€‚ç”±äºHotSpotè™šæ‹Ÿæœºçš„å†…å­˜ç®¡ç†ç³»ç»Ÿè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ï¼Œæ‰€ä»¥å¯¹è±¡å¤´æ­£å¥½æ˜¯8å­—èŠ‚çš„å€æ•°ã€‚å› æ­¤å½“å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†æ²¡æœ‰å¯¹é½çš„è¯ï¼Œå°±éœ€è¦é€šè¿‡å¯¹é½å¡«å……æ¥è¡¥å…¨ã€‚</li></ul><p><strong>å¦å¤–</strong>ï¼Œåœ¨mark-wordé”ç±»å‹æ ‡è®°ä¸­ï¼Œæ— é”ï¼Œåå‘é”ï¼Œè½»é‡é”ï¼Œé‡é‡é”ï¼Œä»¥åŠGCæ ‡è®°ï¼Œ5ç§ç±»ä¸­æ²¡æ³•ç”¨2æ¯”ç‰¹æ ‡è®°ï¼ˆ2æ¯”ç‰¹æœ€ç»ˆæœ‰4ç§ç»„åˆ<code>00</code>ã€<code>01</code>ã€<code>10</code>ã€<code>11</code>ï¼‰ï¼Œæ‰€ä»¥æ— é”ã€åå‘é”ï¼Œå‰åˆå äº†ä¸€ä½åå‘é”æ ‡è®°ã€‚æœ€ç»ˆï¼š001ä¸ºæ— é”ã€101ä¸ºåå‘é”ã€‚</p><h4 id="_1-2-éªŒè¯å¯¹è±¡ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-2-éªŒè¯å¯¹è±¡ç»“æ„" aria-hidden="true">#</a> 1.2 éªŒè¯å¯¹è±¡ç»“æ„</h4><p>ä¸ºäº†å¯ä»¥æ›´åŠ ç›´è§‚çš„çœ‹åˆ°å¯¹è±¡ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© <code>openjdk</code> æä¾›çš„ <code>jol-core</code> è¿›è¡Œæ‰“å°åˆ†æã€‚</p><p><strong>å¼•å…¥POM</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>mvnrepository<span class="token punctuation">.</span>com<span class="token operator">/</span>artifact<span class="token operator">/</span>org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jol<span class="token operator">/</span>jol<span class="token operator">-</span>cli <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jol<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jol<span class="token operator">-</span>cli<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">0.14</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æµ‹è¯•ä»£ç </strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">VM</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">details</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj <span class="token operator">+</span> <span class="token string">&quot; åå…­è¿›åˆ¶å“ˆå¸Œï¼š&quot;</span> <span class="token operator">+</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-2-1-æŒ‡é’ˆå‹ç¼©å¼€å¯-é»˜è®¤" tabindex="-1"><a class="header-anchor" href="#_1-2-1-æŒ‡é’ˆå‹ç¼©å¼€å¯-é»˜è®¤" aria-hidden="true">#</a> 1.2.1 æŒ‡é’ˆå‹ç¼©å¼€å¯(é»˜è®¤)</h5><p><strong>è¿è¡Œç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code># <span class="token class-name">Running</span> <span class="token number">64</span><span class="token operator">-</span>bit <span class="token class-name">HotSpot</span> <span class="token constant">VM</span><span class="token punctuation">.</span>
# <span class="token class-name">Using</span> compressed oop <span class="token keyword">with</span> <span class="token number">3</span><span class="token operator">-</span>bit shift<span class="token punctuation">.</span>
# <span class="token class-name">Using</span> compressed klass <span class="token keyword">with</span> <span class="token number">3</span><span class="token operator">-</span>bit shift<span class="token punctuation">.</span>
# <span class="token class-name">Objects</span> are <span class="token number">8</span> bytes aligned<span class="token punctuation">.</span>
# <span class="token class-name">Field</span> sizes by type<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">[</span>bytes<span class="token punctuation">]</span>
# <span class="token class-name">Array</span> element sizes<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span> <span class="token punctuation">[</span>bytes<span class="token punctuation">]</span>

<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span> object internals<span class="token operator">:</span>
 <span class="token constant">OFFSET</span>  <span class="token constant">SIZE</span>   <span class="token constant">TYPE</span> <span class="token constant">DESCRIPTION</span>                               <span class="token constant">VALUE</span>
      <span class="token number">0</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000001</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token number">4</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token number">8</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           e5 <span class="token number">01</span> <span class="token number">00</span> f8 <span class="token punctuation">(</span><span class="token number">11100101</span> <span class="token number">00000001</span> <span class="token number">00000000</span> <span class="token number">11111000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">134217243</span><span class="token punctuation">)</span>
     <span class="token number">12</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>loss due <span class="token keyword">to</span> <span class="token namespace">the</span> next object alignment<span class="token punctuation">)</span>
<span class="token class-name">Instance</span> size<span class="token operator">:</span> <span class="token number">16</span> bytes
<span class="token class-name">Space</span> losses<span class="token operator">:</span> <span class="token number">0</span> bytes internal <span class="token operator">+</span> <span class="token number">4</span> bytes external <span class="token operator">=</span> <span class="token number">4</span> bytes total
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-15-02.png" alt="å›¾ 15-2 æŒ‡é’ˆå‹ç¼©å¼€å¯ï¼Œå¯¹è±¡å¤´å¸ƒå±€"></p><ul><li>Objectå¯¹è±¡ï¼Œæ€»å…±å 16å­—èŠ‚</li><li>å¯¹è±¡å¤´å  12 ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­ï¼šmark-down å  8 å­—èŠ‚ã€Klass Point å  4 å­—èŠ‚</li><li>æœ€å 4 å­—èŠ‚ï¼Œç”¨äºæ•°æ®å¡«å……æ‰¾é½</li></ul><h5 id="_1-2-2-æŒ‡é’ˆå‹ç¼©å…³é—­" tabindex="-1"><a class="header-anchor" href="#_1-2-2-æŒ‡é’ˆå‹ç¼©å…³é—­" aria-hidden="true">#</a> 1.2.2 æŒ‡é’ˆå‹ç¼©å…³é—­</h5><p>åœ¨ <code>Run--&gt;Edit Configurations-&gt;VM Options</code> é…ç½®å‚æ•° <code>-XX:-UseCompressedOops</code> å…³é—­æŒ‡é’ˆå‹ç¼©ã€‚</p><p><strong>è¿è¡Œç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span> object internals<span class="token operator">:</span>
 <span class="token constant">OFFSET</span>  <span class="token constant">SIZE</span>   <span class="token constant">TYPE</span> <span class="token constant">DESCRIPTION</span>                               <span class="token constant">VALUE</span>
      <span class="token number">0</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">01</span> <span class="token number">12</span> <span class="token number">0</span>c <span class="token number">53</span> <span class="token punctuation">(</span><span class="token number">00000001</span> <span class="token number">00010010</span> <span class="token number">00001100</span> <span class="token number">01010011</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1393299969</span><span class="token punctuation">)</span>
      <span class="token number">4</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">02</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000010</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token number">8</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">00</span> <span class="token number">1</span>c b9 <span class="token number">1</span>b <span class="token punctuation">(</span><span class="token number">00000000</span> <span class="token number">00011100</span> <span class="token number">10111001</span> <span class="token number">00011011</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">465116160</span><span class="token punctuation">)</span>
     <span class="token number">12</span>     <span class="token number">4</span>        <span class="token punctuation">(</span>object header<span class="token punctuation">)</span>                           <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token punctuation">(</span><span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span> <span class="token number">00000000</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token class-name">Instance</span> size<span class="token operator">:</span> <span class="token number">16</span> bytes
<span class="token class-name">Space</span> losses<span class="token operator">:</span> <span class="token number">0</span> bytes internal <span class="token operator">+</span> <span class="token number">0</span> bytes external <span class="token operator">=</span> <span class="token number">0</span> bytes total
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-15-03.png" alt="å›¾ 15-3 æŒ‡é’ˆå‹ç¼©å…³é—­ï¼Œå¯¹è±¡å¤´å¸ƒå±€"></p><ul><li>å…³é—­æŒ‡é’ˆå‹ç¼©åï¼Œmark-word è¿˜æ˜¯å  8 å­—èŠ‚ä¸å˜ã€‚</li><li>é‡ç‚¹åœ¨ç±»å‹æŒ‡é’ˆ Klass Point çš„å˜åŒ–ï¼Œç”±åŸæ¥çš„ 4 å­—èŠ‚ï¼Œç°åœ¨æ‰©å¢åˆ° 8 å­—èŠ‚ã€‚</li></ul><h5 id="_1-2-3-å¯¹è±¡å¤´å“ˆå¸Œå€¼å­˜å‚¨éªŒè¯" tabindex="-1"><a class="header-anchor" href="#_1-2-3-å¯¹è±¡å¤´å“ˆå¸Œå€¼å­˜å‚¨éªŒè¯" aria-hidden="true">#</a> 1.2.3 å¯¹è±¡å¤´å“ˆå¸Œå€¼å­˜å‚¨éªŒè¯</h5><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è°ƒæ•´ä¸‹æµ‹è¯•ä»£ç ï¼Œçœ‹ä¸‹å“ˆå¸Œå€¼åœ¨å¯¹è±¡å¤´ä¸­å…·ä½“æ˜¯æ€ä¹ˆå­˜æ”¾çš„ã€‚</p><p><strong>æµ‹è¯•ä»£ç </strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token constant">VM</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">details</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj <span class="token operator">+</span> <span class="token string">&quot; åå…­è¿›åˆ¶å“ˆå¸Œï¼š&quot;</span> <span class="token operator">+</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ”¹åŠ¨ä¸å¤šï¼Œåªæ˜¯æŠŠå“ˆå¸Œå€¼å’Œå¯¹è±¡æ‰“å°å‡ºæ¥ï¼Œæ–¹ä¾¿æˆ‘ä»¬éªŒè¯å¯¹è±¡å¤´å…³äºå“ˆå¸Œå€¼çš„å­˜æ”¾ç»“æœã€‚</li></ul><p><strong>è¿è¡Œç»“æœ</strong></p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-15-04.png" alt="å›¾ 15-3 å¯¹è±¡å¤´å“ˆå¸Œå€¼å­˜æ”¾"></p><ul><li>å¦‚å›¾ 15-3ï¼Œå¯¹è±¡çš„å“ˆå¸Œå€¼æ˜¯16è¿›åˆ¶çš„ï¼Œ<code>0x2530c12</code></li><li>åœ¨å¯¹è±¡å¤´å“ˆå¸Œå€¼å­˜æ”¾çš„ç»“æœä¸Šçœ‹ï¼Œä¹Ÿæœ‰å¯¹åº”çš„æ•°å€¼ã€‚åªä¸è¿‡è¿™ä¸ªç»“æœæ˜¯å€’è¿‡æ¥çš„ã€‚</li></ul><p>å…³äºè¿™ä¸ªå€’è¿‡æ¥çš„é—®é¢˜æ˜¯å› ä¸ºï¼Œå¤§å°ç«¯å­˜å‚¨å¯¼è‡´ï¼›</p><ul><li>Big-Endianï¼šé«˜ä½å­—èŠ‚å­˜æ”¾äºå†…å­˜çš„ä½åœ°å€ç«¯ï¼Œä½ä½å­—èŠ‚å­˜æ”¾äºå†…å­˜çš„é«˜åœ°å€ç«¯</li><li>Little-Endianï¼šä½ä½å­—èŠ‚å­˜æ”¾äºå†…å­˜çš„ä½åœ°å€ç«¯ï¼Œé«˜ä½å­—èŠ‚å­˜æ”¾äºå†…å­˜çš„é«˜åœ°å€ç«¯</li></ul><p><strong>mark-downç»“æ„</strong></p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-15-05.png" alt="å›¾ 15-5 æ— é”çŠ¶æ€ï¼Œ64ä½è™šæ‹Ÿæœºmark-downç»“æ„"></p><p>å¦‚å›¾ 15-5 æœ€å³ä¾§çš„ 3 Bitï¼ˆ1 Bitæ ‡è¯†åå‘é”ï¼Œ2 Bitæè¿°é”çš„ç±»å‹ï¼‰æ˜¯è·Ÿé”ç±»å‹å’ŒGCæ ‡è®°ç›¸å…³çš„ï¼Œè€Œ synchronized çš„é”ä¼˜åŒ–å‡çº§è†¨èƒ€å°±æ˜¯ä¿®æ”¹çš„è¿™ä¸‰ä½ä¸Šçš„æ ‡è¯†ï¼Œæ¥åŒºåˆ†ä¸åŒçš„é”ç±»å‹ã€‚ä»è€Œé‡‡å–ä¸åŒçš„ç­–ç•¥æ¥æå‡æ€§èƒ½ã€‚</p><h4 id="_1-3-monitor-å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_1-3-monitor-å¯¹è±¡" aria-hidden="true">#</a> 1.3 Monitor å¯¹è±¡</h4><p>åœ¨HotSpotè™šæ‹Ÿæœºä¸­ï¼Œmonitoræ˜¯ç”±C++ä¸­ObjectMonitorå®ç°ã€‚</p><p>synchronized çš„è¿è¡Œæœºåˆ¶ï¼Œå°±æ˜¯å½“ JVM ç›‘æµ‹åˆ°å¯¹è±¡åœ¨ä¸åŒçš„ç«äº‰çŠ¶å†µæ—¶ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°é€‚åˆçš„é”å®ç°ï¼Œè¿™ç§åˆ‡æ¢å°±æ˜¯é”çš„å‡çº§ã€é™çº§ã€‚</p><p>é‚£ä¹ˆä¸‰ç§ä¸åŒçš„ Monitor å®ç°ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ä¸‰ç§ä¸åŒçš„é”ï¼šåæ–œé”ï¼ˆBiased Lockingï¼‰ã€è½»é‡çº§é”å’Œé‡é‡çº§é”ã€‚å½“ä¸€ä¸ª Monitor è¢«æŸä¸ªçº¿ç¨‹æŒæœ‰åï¼Œå®ƒä¾¿å¤„äºé”å®šçŠ¶æ€ã€‚</p><p><strong>Monitor ä¸»è¦æ•°æ®ç»“æ„å¦‚ä¸‹</strong>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// initialize the monitor, exception the semaphore, all other fields</span>
<span class="token comment">// are simple integers or pointers</span>
<span class="token class-name">ObjectMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _header       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    _count        <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">// è®°å½•ä¸ªæ•°</span>
    _waiters      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    _recursions   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">// çº¿ç¨‹é‡å…¥æ¬¡æ•°</span>
    _object       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token comment">// å­˜å‚¨ Monitor å¯¹è±¡</span>
    _owner        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token comment">// æŒæœ‰å½“å‰çº¿ç¨‹çš„ owner</span>
    _WaitSet      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token comment">// å¤„äºwaitçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¼šè¢«åŠ å…¥åˆ° _WaitSet</span>
    _WaitSetLock  <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    _Responsible  <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    _succ         <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    _cxq          <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>   <span class="token comment">// å•å‘åˆ—è¡¨</span>
    <span class="token class-name">FreeNext</span>      <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    _EntryList    <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>   <span class="token comment">// å¤„äºç­‰å¾…é”blockçŠ¶æ€çš„çº¿ç¨‹ï¼Œä¼šè¢«åŠ å…¥åˆ°è¯¥åˆ—è¡¨</span>
    _SpinFreq     <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    _SpinClock    <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    <span class="token class-name">OwnerIsThread</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    _previous_owner_tid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,39),h=n("em",null,"æºç åœ°å€",-1),g={href:"https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/objectMonitor.hpp",target:"_blank",rel:"noopener noreferrer"},y=e(`<ul><li>ObjectMonitorï¼Œæœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼š<code>_WaitSet</code>ã€<code> _EntryList</code>ï¼Œç”¨æ¥ä¿å­˜ ObjectWaiter å¯¹è±¡åˆ—è¡¨ã€‚</li><li>_ownerï¼Œè·å– Monitor å¯¹è±¡çš„çº¿ç¨‹è¿›å…¥ _owner åŒºæ—¶ï¼Œ _count + 1ã€‚å¦‚æœçº¿ç¨‹è°ƒç”¨äº† wait() æ–¹æ³•ï¼Œæ­¤æ—¶ä¼šé‡Šæ”¾ Monitor å¯¹è±¡ï¼Œ _owner æ¢å¤ä¸ºç©ºï¼Œ _count - 1ã€‚åŒæ—¶è¯¥ç­‰å¾…çº¿ç¨‹è¿›å…¥ _WaitSet ä¸­ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚</li></ul><p><strong>é”ğŸ”’æ‰§è¡Œæ•ˆæœå¦‚ä¸‹</strong>ï¼š</p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-15-06.png" alt="å›¾ 15-06ï¼Œé”ğŸ”’æ‰§è¡Œæ•ˆæœ"></p><p>å¦‚å›¾ 15-06ï¼Œæ¯ä¸ª Java å¯¹è±¡å¤´ä¸­éƒ½åŒ…æ‹¬ Monitor å¯¹è±¡(å­˜å‚¨çš„æŒ‡é’ˆçš„æŒ‡å‘)ï¼Œsynchronized ä¹Ÿå°±æ˜¯é€šè¿‡è¿™ä¸€ç§æ–¹å¼è·å–é”ï¼Œä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ synchronized() æ‹¬å·é‡Œæ”¾ä»»ä½•å¯¹è±¡éƒ½èƒ½è·å¾—é”ğŸ”’ï¼</p><h3 id="_2-synchronized-ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#_2-synchronized-ç‰¹æ€§" aria-hidden="true">#</a> 2. synchronized ç‰¹æ€§</h3><h4 id="_2-1-åŸå­æ€§" tabindex="-1"><a class="header-anchor" href="#_2-1-åŸå­æ€§" aria-hidden="true">#</a> 2.1 åŸå­æ€§</h4><p><strong>åŸå­æ€§</strong>æ˜¯æŒ‡ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¤±è´¥ã€‚</p><p><strong>æ¡ˆä¾‹ä»£ç </strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i1 <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i1<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç­‰10ä¸ªçº¿ç¨‹è¿è¡Œå®Œæ¯•</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    counter<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µä»£ç å¼€å¯äº† 10 ä¸ªçº¿ç¨‹æ¥ç´¯åŠ  counterï¼ŒæŒ‰ç…§é¢„æœŸç»“æœåº”è¯¥æ˜¯ 100000ã€‚ä½†å®é™…è¿è¡Œä¼šå‘ç°ï¼Œcounter å€¼æ¯æ¬¡è¿è¡Œéƒ½å°äº 10000ï¼Œè¿™æ˜¯å› ä¸º volatile å¹¶ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œæ‰€ä»¥æœ€åçš„ç»“æœä¸ä¼šæ˜¯10000ã€‚</p><p>ä¿®æ”¹æ–¹æ³• add()ï¼Œæ·»åŠ  synchronizedï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">AtomicityTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        counter<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™å›æµ‹è¯•ç»“æœå°±æ˜¯ï¼š100000 äº†ï¼</p><p>å› ä¸º synchronized å¯ä»¥ä¿è¯ç»Ÿä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‹¿åˆ°é”ï¼Œè¿›å…¥åˆ°ä»£ç å—æ‰§è¡Œã€‚</p><p><strong>åç¼–è¯‘æŸ¥çœ‹æŒ‡ä»¤ç </strong></p><p><code>javap -v -p AtomicityTest</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">V</span>
    flags<span class="token operator">:</span> <span class="token constant">ACC_PUBLIC</span><span class="token punctuation">,</span> <span class="token constant">ACC_STATIC</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">0</span>
         <span class="token number">0</span><span class="token operator">:</span> ldc           #<span class="token number">12</span>                 <span class="token comment">// class org/itstack/interview/AtomicityTest</span>
         <span class="token number">2</span><span class="token operator">:</span> dup
         <span class="token number">3</span><span class="token operator">:</span> astore_0
         <span class="token number">4</span><span class="token operator">:</span> monitorenter
         <span class="token number">5</span><span class="token operator">:</span> getstatic     #<span class="token number">10</span>                 <span class="token comment">// Field counter:I</span>
         <span class="token number">8</span><span class="token operator">:</span> iconst_1
         <span class="token number">9</span><span class="token operator">:</span> iadd
        <span class="token number">10</span><span class="token operator">:</span> putstatic     #<span class="token number">10</span>                 <span class="token comment">// Field counter:I</span>
        <span class="token number">13</span><span class="token operator">:</span> aload_0
        <span class="token number">14</span><span class="token operator">:</span> monitorexit
        <span class="token number">15</span><span class="token operator">:</span> <span class="token keyword">goto</span>          <span class="token number">23</span>
        <span class="token number">18</span><span class="token operator">:</span> astore_1
        <span class="token number">19</span><span class="token operator">:</span> aload_0
        <span class="token number">20</span><span class="token operator">:</span> monitorexit
        <span class="token number">21</span><span class="token operator">:</span> aload_1
        <span class="token number">22</span><span class="token operator">:</span> athrow
        <span class="token number">23</span><span class="token operator">:</span> <span class="token keyword">return</span>
      <span class="token class-name">Exception</span> table<span class="token operator">:</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>åŒæ­¥æ–¹æ³•</strong></p><p><code>ACC_SYNCHRONIZED</code> è¿™æ˜¯ä¸€ä¸ªåŒæ­¥æ ‡è¯†ï¼Œå¯¹åº”çš„16è¿›åˆ¶å€¼æ˜¯ 0x0020</p><p>è¿™10ä¸ªçº¿ç¨‹è¿›å…¥è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œéƒ½ä¼šåˆ¤æ–­æ˜¯å¦æœ‰æ­¤æ ‡è¯†ï¼Œç„¶åå¼€å§‹ç«äº‰ Monitor å¯¹è±¡ã€‚</p><p><strong>åŒæ­¥ä»£ç </strong></p><ul><li><code>monitorenter</code>ï¼Œåœ¨åˆ¤æ–­æ‹¥æœ‰åŒæ­¥æ ‡è¯† <code>ACC_SYNCHRONIZED</code> æŠ¢å…ˆè¿›å…¥æ­¤æ–¹æ³•çš„çº¿ç¨‹ä¼šä¼˜å…ˆæ‹¥æœ‰ Monitor çš„ owner ï¼Œæ­¤æ—¶è®¡æ•°å™¨ +1ã€‚</li><li><code>monitorexit</code>ï¼Œå½“æ‰§è¡Œå®Œé€€å‡ºåï¼Œè®¡æ•°å™¨ -1ï¼Œå½’ 0 åè¢«å…¶ä»–è¿›å…¥çš„çº¿ç¨‹è·å¾—ã€‚</li></ul><h4 id="_2-2-å¯è§æ€§" tabindex="-1"><a class="header-anchor" href="#_2-2-å¯è§æ€§" aria-hidden="true">#</a> 2.2 å¯è§æ€§</h4><p>åœ¨ä¸Šä¸€ç« èŠ‚ volatile ç¯‡ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒä¿è¯å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹çš„å¯è§æ€§ã€‚æœ€ç»ˆçš„æ•ˆæœå°±æ˜¯åœ¨æ·»åŠ  volatile çš„å±æ€§å˜é‡æ—¶ï¼Œçº¿ç¨‹Aä¿®æ”¹å€¼åï¼Œçº¿ç¨‹Bä½¿ç”¨æ­¤å˜é‡å¯ä»¥åšå‡ºç›¸åº”çš„ååº”ï¼Œæ¯”å¦‚ <code>while(!å˜é‡)</code> é€€å‡ºã€‚</p><p>é‚£ä¹ˆï¼Œ<code>synchronized</code> å…·å¤‡å¯è§æ€§å—ï¼Œæˆ‘ä»¬åšç»™ä¾‹å­ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> sign <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> <span class="token class-name">Thread01</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>sign<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> <span class="token class-name">Thread02</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        sign <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;vt.sign = true  while (!sign)&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread01</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread02</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ˜¯ä¸¤ä¸ªçº¿ç¨‹æ“ä½œä¸€ä¸ªå˜é‡çš„ä¾‹å­ï¼Œå› ä¸ºçº¿ç¨‹é—´å¯¹å˜é‡ <code>sign</code> çš„ä¸å¯è§æ€§ï¼Œçº¿ç¨‹ Thread01 ä¸­çš„ while (!sign) ä¼šä¸€ç›´æ‰§è¡Œï¼Œä¸ä¼šéšç€çº¿ç¨‹ Thread02 ä¿®æ”¹ sign = true è€Œé€€å‡ºå¾ªç¯ã€‚</p><p><strong>ç°åœ¨</strong>æˆ‘ä»¬ç»™æ–¹æ³• add æ·»åŠ  <code>synchronized</code> å…³é”®å­—ä¿®é¥°ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ·»åŠ åè¿è¡Œç»“æœ</strong>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">23</span><span class="token operator">:</span><span class="token number">55</span><span class="token operator">:</span><span class="token number">33.849</span> <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>interview<span class="token punctuation">.</span></span>VisibilityTest</span> <span class="token operator">-</span> vt<span class="token punctuation">.</span>sign <span class="token operator">=</span> <span class="token boolean">true</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>sign<span class="token punctuation">)</span>

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°å½“çº¿ç¨‹ Thread02 æ”¹å˜å˜é‡ sign = true åï¼Œçº¿ç¨‹ Thread01 ç«‹å³é€€å‡ºäº†å¾ªç¯ã€‚</p><p><em>æ³¨æ„ï¼šä¸è¦åœ¨æ–¹æ³•ä¸­æ·»åŠ  System.out.println() ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•ä¸­å«æœ‰ synchronized ä¼šå½±å“æµ‹è¯•ç»“æœï¼</em></p><p><strong>é‚£ä¹ˆä¸ºä»€ä¹ˆæ·»åŠ  synchronized ä¹Ÿèƒ½ä¿è¯å˜é‡çš„å¯è§æ€§å‘¢ï¼Ÿ</strong></p><p>å› ä¸ºï¼š</p><ol><li>çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚</li><li>çº¿ç¨‹åŠ é”å‰ï¼Œå°†æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œä»è€Œä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è¯»å–æœ€æ–°çš„å€¼ã€‚</li><li>volatile çš„å¯è§æ€§éƒ½æ˜¯é€šè¿‡å†…å­˜å±éšœï¼ˆMemnory Barrierï¼‰æ¥å®ç°çš„ã€‚</li><li>synchronized é æ“ä½œç³»ç»Ÿå†…æ ¸äº’æ–¥é”å®ç°ï¼Œç›¸å½“äº JMM ä¸­çš„ lockã€unlockã€‚é€€å‡ºä»£ç å—æ—¶åˆ·æ–°å˜é‡åˆ°ä¸»å†…å­˜ã€‚</li></ol><h4 id="_2-3-æœ‰åºæ€§" tabindex="-1"><a class="header-anchor" href="#_2-3-æœ‰åºæ€§" aria-hidden="true">#</a> 2.3 æœ‰åºæ€§</h4><p><code>as-if-serial</code>ï¼Œä¿è¯ä¸ç®¡ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ä¼šå¦‚ä½•è¿›è¡ŒæŒ‡ä»¤é‡æ’åºï¼Œéƒ½éœ€è¦ä¿è¯å•çº¿ç¨‹ä¸‹çš„è¿è¡Œç»“æœçš„æ­£ç¡®æ€§ã€‚ä¹Ÿå°±æ˜¯å¸¸è¯´çš„ï¼š<strong>å¦‚æœåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚</strong></p><p>è¿™é‡Œæœ‰ä¸€æ®µåŒé‡æ£€éªŒé”ï¼ˆDouble-checked Lockingï¼‰çš„ç»å…¸æ¡ˆä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä¸ºä»€ä¹ˆ</strong>ï¼Œsynchronized ä¹Ÿæœ‰å¯è§æ€§çš„ç‰¹ç‚¹ï¼Œè¿˜éœ€è¦ volatile å…³é”®å­—ï¼Ÿ</p><p>å› ä¸ºï¼Œsynchronized çš„æœ‰åºæ€§ï¼Œä¸æ˜¯ volatile çš„é˜²æ­¢æŒ‡ä»¤é‡æ’åºã€‚</p><p>é‚£å¦‚æœä¸åŠ  volatile å…³é”®å­—å¯èƒ½å¯¼è‡´çš„ç»“æœï¼Œå°±æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨åˆå§‹åŒ–åˆå§‹åŒ–å¯¹è±¡ï¼Œè®¾ç½® instance æŒ‡å‘å†…å­˜åœ°å€æ—¶ã€‚ç¬¬äºŒä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œæœ‰æŒ‡ä»¤é‡æ’ã€‚åœ¨åˆ¤æ–­ if (instance == null) æ—¶å°±ä¼šæœ‰å‡ºé”™çš„å¯èƒ½ï¼Œå› ä¸ºè¿™ä¼šå¯èƒ½ instance å¯èƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–æˆåŠŸã€‚</p><h4 id="_2-4-å¯é‡å…¥æ€§" tabindex="-1"><a class="header-anchor" href="#_2-4-å¯é‡å…¥æ€§" aria-hidden="true">#</a> 2.4 å¯é‡å…¥æ€§</h4><p>synchronized æ˜¯å¯é‡å…¥é”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå…è®¸ä¸€ä¸ªçº¿ç¨‹äºŒæ¬¡è¯·æ±‚è‡ªå·±æŒæœ‰å¯¹è±¡é”çš„ä¸´ç•Œèµ„æºï¼Œè¿™ç§æƒ…å†µç§°ä¸ºå¯é‡å…¥é”ğŸ”’ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å†™ä¸€ä¸ªä¾‹å­ï¼Œæ¥è¯æ˜è¿™æ ·çš„æƒ…å†µã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentryTest</span> <span class="token keyword">extends</span> <span class="token class-name">A</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReentryTest</span> reentry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentryTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reentry<span class="token punctuation">.</span><span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å­ç±»æ–¹æ³•ï¼šReentryTest.doA() ThreadIdï¼š&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">doB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">doB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å­ç±»æ–¹æ³•ï¼šReentryTest.doB() ThreadIdï¼š&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;çˆ¶ç±»æ–¹æ³•ï¼šA.doA() ThreadIdï¼š&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>å­ç±»æ–¹æ³•ï¼š<span class="token class-name">ReentryTest</span><span class="token punctuation">.</span><span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name">ThreadId</span>ï¼š<span class="token number">1</span>
çˆ¶ç±»æ–¹æ³•ï¼š<span class="token class-name">A</span><span class="token punctuation">.</span><span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name">ThreadId</span>ï¼š<span class="token number">1</span>
å­ç±»æ–¹æ³•ï¼š<span class="token class-name">ReentryTest</span><span class="token punctuation">.</span><span class="token function">doB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name">ThreadId</span>ï¼š<span class="token number">1</span>

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µå•ä¾‹ä»£ç æ˜¯é€’å½’è°ƒç”¨å«æœ‰ synchronized é”çš„æ–¹æ³•ï¼Œä»è¿è¡Œæ­£å¸¸çš„æµ‹è¯•ç»“æœçœ‹ï¼Œå¹¶æ²¡æœ‰å‘ç”Ÿæ­»é”ã€‚æ‰€æœ‰å¯ä»¥è¯æ˜ synchronized æ˜¯å¯é‡å…¥é”ã€‚</p><p>synchronizedé”å¯¹è±¡çš„æ—¶å€™æœ‰ä¸ªè®¡æ•°å™¨ï¼Œä»–ä¼šè®°å½•ä¸‹çº¿ç¨‹è·å–é”çš„æ¬¡æ•°ï¼Œåœ¨æ‰§è¡Œå®Œå¯¹åº”çš„ä»£ç å—ä¹‹åï¼Œè®¡æ•°å™¨å°±ä¼š-1ï¼Œç›´åˆ°è®¡æ•°å™¨æ¸…é›¶ï¼Œå°±é‡Šæ”¾é”äº†ã€‚</p><p><strong>ä¹‹æ‰€ä»¥</strong>ï¼Œæ˜¯å¯ä»¥é‡å…¥ã€‚æ˜¯å› ä¸º synchronized é”å¯¹è±¡æœ‰ä¸ªè®¡æ•°å™¨ï¼Œä¼šéšç€çº¿ç¨‹è·å–é”å +1 è®¡æ•°ï¼Œå½“çº¿ç¨‹æ‰§è¡Œå®Œæ¯•å -1ï¼Œç›´åˆ°æ¸…é›¶é‡Šæ”¾é”ã€‚</p><h3 id="_3-é”å‡çº§è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#_3-é”å‡çº§è¿‡ç¨‹" aria-hidden="true">#</a> 3. é”å‡çº§è¿‡ç¨‹</h3><p>å…³äº synchronized é”ğŸ”’å‡çº§æœ‰ä¸€å¼ éå¸¸å®Œæ•´çš„å›¾ï¼Œå¯ä»¥å‚è€ƒï¼š</p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-15-07.png" alt="å›¾ 15-7 synchronized é”å‡çº§è¿‡ç¨‹"></p><p>synchronized é”æœ‰å››ç§äº¤æ›¿å‡çº§çš„çŠ¶æ€ï¼šæ— é”ã€åå‘é”ã€è½»é‡çº§é”å’Œé‡é‡çº§ï¼Œè¿™å‡ ä¸ªçŠ¶æ€éšç€ç«äº‰æƒ…å†µé€æ¸å‡çº§ã€‚</p><h4 id="_3-1-åå‘é”" tabindex="-1"><a class="header-anchor" href="#_3-1-åå‘é”" aria-hidden="true">#</a> 3.1 åå‘é”</h4>`,57),_={href:"https://github.com/JetBrains/jdk8u_hotspot/blob/master/src/share/vm/runtime/synchronizer.cpp",target:"_blank",rel:"noopener noreferrer"},w=e(`<div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// NOTE: must use heavy weight monitor to handle jni monitor exit</span>
<span class="token keyword">void</span> <span class="token class-name">ObjectSynchronizer</span><span class="token operator">::</span><span class="token function">jni_exit</span><span class="token punctuation">(</span>oop obj<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token operator">*</span> <span class="token constant">THREAD</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token constant">TEVENT</span> <span class="token punctuation">(</span>jni_exit<span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UseBiasedLocking</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Handle</span> <span class="token function">h_obj</span><span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BiasedLocking</span><span class="token operator">::</span><span class="token function">revoke_and_rebias</span><span class="token punctuation">(</span>h_obj<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj <span class="token operator">=</span> <span class="token function">h_obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token operator">-&gt;</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">has_bias_pattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;biases should be revoked by now&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">ObjectMonitor</span><span class="token operator">*</span> monitor <span class="token operator">=</span> <span class="token class-name">ObjectSynchronizer</span><span class="token operator">::</span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// If this thread has locked the object, exit the monitor.  Note:  can&#39;t use</span>
  <span class="token comment">// monitor-&gt;check(CHECK); must exit even if an exception is pending.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>monitor<span class="token operator">-&gt;</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     monitor<span class="token operator">-&gt;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token constant">THREAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>UseBiasedLocking æ˜¯ä¸€ä¸ªåå‘é”æ£€æŸ¥ï¼Œ1.6ä¹‹åæ˜¯é»˜è®¤å¼€å¯çš„ï¼Œ1.5ä¸­æ˜¯å…³é—­çš„ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯å‚æ•°æ˜¯ <code>XX:-UseBiasedLocking=false</code></li></ul><p>åæ–œé”ä¼šå»¶ç¼“ JIT é¢„çƒ­è¿›ç¨‹ï¼Œæ‰€ä»¥å¾ˆå¤šæ€§èƒ½æµ‹è¯•ä¸­ä¼šæ˜¾å¼åœ°å…³é—­åæ–œé”ï¼Œåæ–œé”å¹¶ä¸é€‚åˆæ‰€æœ‰åº”ç”¨åœºæ™¯ï¼Œæ’¤é”€æ“ä½œï¼ˆrevokeï¼‰æ˜¯æ¯”è¾ƒé‡çš„è¡Œä¸ºï¼Œåªæœ‰å½“å­˜åœ¨è¾ƒå¤šä¸ä¼šçœŸæ­£ç«äº‰çš„ synchronized å—å„¿æ—¶ï¼Œæ‰èƒ½ä½“ç°å‡ºæ˜æ˜¾æ”¹å–„ã€‚</p><h4 id="_3-2-è½»é‡çº§é”" tabindex="-1"><a class="header-anchor" href="#_3-2-è½»é‡çº§é”" aria-hidden="true">#</a> 3.2 è½»é‡çº§é”</h4><p>å½“é”æ˜¯åå‘é”çš„æ—¶å€™ï¼Œè¢«å¦ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®ï¼Œåå‘é”å°±ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Œå…¶ä»–çº¿ç¨‹ä¼šé€šè¿‡è‡ªæ—‹çš„å½¢å¼å°è¯•è·å–é”ï¼Œä¸ä¼šé˜»å¡ï¼Œæé«˜æ€§èƒ½ã€‚</p><p>åœ¨ä»£ç è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œå¦‚æœåŒæ­¥å¯¹è±¡é”çŠ¶æ€ä¸ºæ— é”çŠ¶æ€ï¼ˆé”æ ‡å¿—ä½ä¸ºâ€œ01â€çŠ¶æ€ï¼Œæ˜¯å¦ä¸ºåå‘é”ä¸ºâ€œ0â€ï¼‰ï¼ŒJVMè™šæ‹Ÿæœºé¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•ï¼ˆLock Recordï¼‰çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordçš„æ‹·è´ï¼Œå®˜æ–¹ç§°ä¹‹ä¸º Displaced Mark Wordã€‚</p><h4 id="_3-3-è‡ªæ—‹é”" tabindex="-1"><a class="header-anchor" href="#_3-3-è‡ªæ—‹é”" aria-hidden="true">#</a> 3.3 è‡ªæ—‹é”</h4><p>è‡ªæ—‹é”æ˜¯æŒ‡å°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPUã€‚</p><p>è‡ªæ—‹é”çš„é»˜è®¤å¤§å°æ˜¯10æ¬¡ï¼Œå¯ä»¥è°ƒæ•´ï¼š<code>-XXï¼šPreBlockSpin</code></p><p>å¦‚æœè‡ªæ—‹næ¬¡å¤±è´¥äº†ï¼Œå°±ä¼šå‡çº§ä¸ºé‡é‡çº§çš„é”ã€‚<code>é‡é‡çº§çš„é”ï¼Œåœ¨ 1.3 Monitor å¯¹è±¡ä¸­å·²ç»ä»‹ç»ã€‚</code></p><h4 id="_3-4-é”ä¼šé™çº§å—" tabindex="-1"><a class="header-anchor" href="#_3-4-é”ä¼šé™çº§å—" aria-hidden="true">#</a> 3.4 é”ä¼šé™çº§å—ï¼Ÿ</h4><p>ä¹‹å‰ä¸€ç›´äº†è§£åˆ° Java ä¸ä¼šè¿›è¡Œé”é™çº§ï¼Œä½†æœ€è¿‘æ•´ç†äº†å¤§é‡çš„èµ„æ–™å‘ç°é”é™çº§ç¡®å®æ˜¯ä¼šå‘ç”Ÿã€‚</p><p><strong>When safepoints are used?</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Below</span> are few reasons <span class="token keyword">for</span> <span class="token class-name">HotSpot</span> <span class="token constant">JVM</span> <span class="token keyword">to</span> <span class="token namespace">initiate</span> a safepoint<span class="token operator">:</span>
<span class="token class-name">Garbage</span> collection pauses
<span class="token class-name">Code</span> deoptimization
<span class="token class-name">Flushing</span> code cache
<span class="token class-name">Class</span> redefinition <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> hot swap or instrumentation<span class="token punctuation">)</span>
<span class="token class-name">Biased</span> lock revocation
<span class="token class-name">Various</span> debug operation <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> deadlock check or stacktrace dump<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,14),f=n("code",null,"Biased lock revocation",-1),j={href:"http://blog.ragozin.info/2012/10/safepoints-in-hotspot-jvm.html",target:"_blank",rel:"noopener noreferrer"},x=n("h2",{id:"å››ã€æ€»ç»“",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#å››ã€æ€»ç»“","aria-hidden":"true"},"#"),s(" å››ã€æ€»ç»“")],-1),T=n("code",null,"synchronized",-1),z={href:"https://github.com/JetBrains/jdk8u_hotspot",target:"_blank",rel:"noopener noreferrer"},S=n("li",null,"å…³äºé”çš„ç»†èŠ‚æŒ–æ˜é™¤äº†æœ¬æ–‡æåˆ°çš„è¿˜æœ‰å¾ˆå¤šçŸ¥è¯†ç‚¹å¯ä»¥ç»§ç»­å­¦ä¹ ï¼Œå¯ä»¥ç»“åˆ ifeveã€å¹¶å‘ç¼–ç¨‹ã€æ·±å…¥ç†è§£JVMè™šæ‹Ÿæœºï¼Œç­‰ç³»åˆ—çŸ¥è¯†æ•´ç†ã€‚",-1),C=n("li",null,"å­¦ä¹ è¿‡ç¨‹ä¸­ç»“åˆC++æºä»£ç ä¸­å…³äºé”çš„å®ç°ï¼Œæ›´å®¹æ˜“ç†è§£å¯èƒ½åŸæœ¬æ™¦æ¶©éš¾æ‡‚çš„æ¦‚å¿µã€‚åœ¨ç»“åˆå®é™…çš„æ¡ˆä¾‹éªŒè¯ï¼Œä¼šå®¹æ˜“æ¥å—è¿™éƒ¨åˆ†çŸ¥è¯†ã€‚",-1),I=n("li",null,"å¥½äº†ï¼Œè¿™ç¯‡å°±å†™åˆ°è¿™é‡Œäº†ï¼Œå¦‚æœæœ‰è§‚ç‚¹å’Œæ–‡ç« ä¸å‡†ç¡®çš„è¡¨è¾¾æ¬¢è¿ç•™è¨€ï¼Œäº’ç›¸å­¦ä¹ ï¼Œäº’ç›¸æ‰«ç›²ï¼Œäº’ç›¸è¿›æ­¥ã€‚",-1),O=n("h2",{id:"äº”ã€å‚…è¯—ä¸€æ‰‹",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#äº”ã€å‚…è¯—ä¸€æ‰‹","aria-hidden":"true"},"#"),s(" äº”ã€å‚…è¯—ä¸€æ‰‹")],-1),M=n("ul",null,[n("li",null,"ä¼šæ‰€ğŸ¢ï¼Œé‡Œçš„ç å†œä¼šé”ã€‚"),n("li",null,"æ‹¥æŒ¤ğŸ¤¼â€â™‚ï¸ï¼Œå°±éœ€åŠ ä»·å‡çº§ã€‚"),n("li",null,"é¡¹ç›®ğŸ¤¯ï¼ŒæŒ‰æ‘©å¯¹è±¡å¤´çš®ã€‚"),n("li",null,"æ•ˆæœğŸ¤¨ï¼Œå¯è§åŸå­æœ‰åºã€‚")],-1);function L(E,A){const a=o("ExternalLinkIcon");return c(),l("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),r,s("åšå®¢ï¼š"),n("a",k,[s("https://bugstack.cn"),p(a)])]),d,n("p",null,[m,s("ï¼š"),n("a",v,[s("jdk8/hotspot/file/vm/oops/markOop.hpp"),p(a)])]),b,n("p",null,[h,s("ï¼š"),n("a",g,[s("jdk8/hotspot/file/vm/runtime/objectMonitor.hpp"),p(a)])]),y,n("p",null,[s("synchronizeræºç ï¼š"),n("a",_,[s("/src/share/vm/runtime/synchronizer.cpp"),p(a)])]),w,n("p",null,[f,s("ï¼Œå½“ JVM è¿›å…¥å®‰å…¨ç‚¹ "),n("a",j,[s("SafePoint"),p(a)]),s("çš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥æ˜¯å¦æœ‰é—²ç½®çš„ Monitorï¼Œç„¶åè¯•å›¾è¿›è¡Œé™çº§ã€‚")]),x,n("ul",null,[n("li",null,[s("æœ¬ç« å…³äº "),T,s(" é”æ¶‰åŠåˆ°äº†è¾ƒå¤šçš„C++æºç åˆ†æå­¦ä¹ ï¼Œæºç åœ°å€ï¼š"),n("a",z,[s("https://github.com/JetBrains/jdk8u_hotspot"),p(a)])]),S,C,I]),O,M])}const N=t(i,[["render",L],["__file","2020-10-28-mianjingshouce Â· di15pianã€Šmanonghuisuoï¼Œsynchronized jieduï¼Œpouxiyuanmashendufenxiï¼ã€‹.html.vue"]]);export{N as default};
