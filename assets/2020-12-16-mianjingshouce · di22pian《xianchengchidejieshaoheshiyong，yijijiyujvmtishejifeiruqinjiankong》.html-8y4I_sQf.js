import{_ as e,r as o,o as c,c as l,a as s,b as n,d as p,e as t}from"./app-3RcBQnkC.js";const u={},i=s("h1",{id:"é¢ç»æ‰‹å†Œ-Â·-ç¬¬22ç¯‡ã€Šçº¿ç¨‹æ± çš„ä»‹ç»å’Œä½¿ç”¨-ä»¥åŠåŸºäºjvmtiè®¾è®¡éå…¥ä¾µç›‘æ§ã€‹",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#é¢ç»æ‰‹å†Œ-Â·-ç¬¬22ç¯‡ã€Šçº¿ç¨‹æ± çš„ä»‹ç»å’Œä½¿ç”¨-ä»¥åŠåŸºäºjvmtiè®¾è®¡éå…¥ä¾µç›‘æ§ã€‹","aria-hidden":"true"},"#"),n(" é¢ç»æ‰‹å†Œ Â· ç¬¬22ç¯‡ã€Šçº¿ç¨‹æ± çš„ä»‹ç»å’Œä½¿ç”¨ï¼Œä»¥åŠåŸºäºjvmtiè®¾è®¡éå…¥ä¾µç›‘æ§ã€‹")],-1),r=s("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=t(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>äº”å¸¸å¤§ç±³å¥½åƒï¼</code></p><p>å“ˆå“ˆå“ˆï¼Œæ˜¯ä¸ä½ æ€»ä¹°äº”å¸¸å¤§ç±³ï¼Œå…¶å®äº”å¸¸å’Œæ¦†æ ‘æ˜¯æŒ¨ç€çš„ï¼Œæ¦†æ ‘å¤§ç±³ä¹Ÿå¥½åƒï¼Œæ¦†æ ‘è¿˜æ˜¯å¤©ä¸‹ç¬¬ä¸€ç²®ä»“å‘¢ï¼ä½†æ˜¯äº”å¸¸å‡ºåï¼Œæ‰€ä»¥åªè®¤è¯†äº”å¸¸ã€‚</p><p>ä¸ºä»€ä¹ˆæè¿™ä¸ªå‘¢ï¼Œå› ä¸ºé˜¿é‡Œä¸å…è®¸ä½¿ç”¨ Executors åˆ›å»ºçº¿ç¨‹æ± ï¼å…¶ä»–å¾ˆå¤šå¤§å‚ä¹Ÿä¸å…è®¸ï¼Œè¿™ä¹ˆåˆ›å»ºçš„è¯ï¼Œæ§åˆ¶ä¸å¥½ä¼šå‡ºç°OOMã€‚</p><p><strong>å¥½</strong>ï¼Œæœ¬ç¯‡å°±å¸¦ä½ å­¦ä¹ å››ç§çº¿ç¨‹æ± çš„ä¸åŒä½¿ç”¨æ–¹å¼ã€ä¸šåŠ¡åœºæ™¯åº”ç”¨ä»¥åŠå¦‚ä½•ç›‘æ§çº¿ç¨‹ã€‚</p><h2 id="äºŒã€é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#äºŒã€é¢è¯•é¢˜" aria-hidden="true">#</a> äºŒã€é¢è¯•é¢˜</h2><p><code>è°¢é£æœºï¼Œå°è®°ï¼</code>ï¼Œä¸Šæ¬¡ä»é¢è¯•å®˜é‚£é€ƒè·‘åï¼Œæ¶è¡¥äº†å¤šçº¿ç¨‹ï¼Œè‡ªå·±å¥½åƒä¹Ÿå†…å·äº†ï¼Œæ‰€ä»¥å‡ºé—¨é€›é€›ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šå—¨ï¼Œé£æœºï¼Œé£æœºï¼Œè¿™è¾¹ï¼</p><p><strong>è°¢é£æœº</strong>ï¼šå—¯ï¼Ÿï¼å“å‘€ï¼Œé¢è¯•å®˜ä½ å’‹æ¥å—æµ·å­å…¬å›­äº†ï¼Ÿ</p><p><strong>é¢è¯•å®˜</strong>ï¼šæˆ‘å®¶å°±é™„è¿‘ï¼Œè·‘æ­¥æ¥äº†ã€‚æœ€è¿‘ä½ å’‹æ ·ï¼Œä¸Šæ¬¡é—®ä½ çš„å¤šçº¿ç¨‹å­¦äº†å—ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šå“ï¼Œçœ‹äº†æ˜¯çœ‹äº†ï¼Œè®°ä¸ä½é¸­ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šå—¯ï¼Œä¸å¸¸ç”¨ç¡®å®è®°ä¸ä½ã€‚ä¸è¿‡ä½ å¯ä»¥é€‰æ‹©è·³æ§½ï¼Œæ¥å¤§å‚ï¼Œå¤§å‚çš„ä¸šåŠ¡ä½“é‡è¾ƒå¤§ï¼</p><p><strong>è°¢é£æœº</strong>ï¼šæˆ‘å°±çº ç»“å‘¢ï¼Œæƒ³å›å®¶è€ƒæ•™å¸ˆèµ„æ ¼è¯äº†ï¼Œæˆ‘ä»¬æ‘å°å­¦è¦æ•™javaäº†ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šå“ˆå“ˆå“ˆå“ˆå“ˆï¼Œä¸€èµ·ï¼</p><h2 id="ä¸‰ã€å››ç§çº¿ç¨‹æ± ä½¿ç”¨ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€å››ç§çº¿ç¨‹æ± ä½¿ç”¨ä»‹ç»" aria-hidden="true">#</a> ä¸‰ã€å››ç§çº¿ç¨‹æ± ä½¿ç”¨ä»‹ç»</h2><p><code>Executors</code> æ˜¯åˆ›å»ºçº¿ç¨‹æ± çš„å·¥å…·ç±»ï¼Œæ¯”è¾ƒå…¸å‹å¸¸è§çš„å››ç§çº¿ç¨‹æ± åŒ…æ‹¬ï¼š<code>newFixedThreadPool</code>ã€<code>newSingleThreadExecutor</code>ã€<code>newCachedThreadPool</code>ã€<code>newScheduledThreadPool</code>ã€‚æ¯ä¸€ç§éƒ½æœ‰è‡ªå·±ç‰¹å®šçš„å…¸å‹ä¾‹å­ï¼Œå¯ä»¥æŒ‰ç…§æ¯ç§çš„ç‰¹æ€§ç”¨åœ¨ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œä¹Ÿå¯ä»¥åšä¸ºå‚ç…§ç²¾ç»†åŒ–åˆ›å»ºçº¿ç¨‹æ± ã€‚</p><h3 id="_1-newfixedthreadpool" tabindex="-1"><a class="header-anchor" href="#_1-newfixedthreadpool" aria-hidden="true">#</a> 1. newFixedThreadPool</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> groupId <span class="token operator">=</span> i<span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ç¬¬ {} ç»„ä»»åŠ¡ï¼Œç¬¬ {} æ¬¡æ‰§è¡Œå®Œæˆ&quot;</span><span class="token punctuation">,</span> groupId<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æµ‹è¯•ç»“æœ</span>
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">24.628</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">24.628</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">24.628</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">25.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">25.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">25.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">26.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">26.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">26.633</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">27.634</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">27.634</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">27.634</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">28.635</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">29.635</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">30.635</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">48</span><span class="token operator">:</span><span class="token number">31.636</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newFixedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å›¾è§£</strong></p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-22-1.png" alt="å›¾ 22-1 newFixedThreadPool æ‰§è¡Œè¿‡ç¨‹"></p><ul><li><strong>ä»£ç </strong>ï¼š<code>new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;())</code></li><li><strong>ä»‹ç»</strong>ï¼šåˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°å¯é‡å¤ä½¿ç”¨çš„çº¿ç¨‹æ± ï¼Œä»¥ <code>LinkedBlockingQueue</code> æ— ç•Œé˜»å¡é˜Ÿåˆ—å­˜æ”¾ç­‰å¾…çº¿ç¨‹ã€‚</li><li><strong>é£é™©</strong>ï¼šéšç€çº¿ç¨‹ä»»åŠ¡ä¸èƒ½è¢«æ‰§è¡Œçš„çš„æ— é™å †ç§¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´OOMã€‚</li></ul><h3 id="_2-newsinglethreadexecutor" tabindex="-1"><a class="header-anchor" href="#_2-newsinglethreadexecutor" aria-hidden="true">#</a> 2. newSingleThreadExecutor</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> groupId <span class="token operator">=</span> i<span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ç¬¬ {} ç»„ä»»åŠ¡ï¼Œç¬¬ {} æ¬¡æ‰§è¡Œå®Œæˆ&quot;</span><span class="token punctuation">,</span> groupId<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æµ‹è¯•ç»“æœ</span>
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">15.066</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">16.069</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">17.070</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">18.070</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">19.071</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">280.071</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">281.072</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">282.072</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">283.073</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">284.074</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">285.074</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">286.075</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">287.075</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">288.075</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">23</span><span class="token operator">:</span><span class="token number">289.076</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">30.076</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newSingleThreadExecutor</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å›¾è§£</strong></p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-22-2.png" alt="å›¾ 22-2 newSingleThreadExecutor æ‰§è¡Œè¿‡ç¨‹"></p><ul><li><strong>ä»£ç </strong>ï¼š<code>new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue&lt;Runnable&gt;())</code></li><li><strong>ä»‹ç»</strong>ï¼šåªåˆ›å»ºä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œå¦‚æœå‡ºç°æ„å¤–ç»ˆæ­¢åˆ™å†åˆ›å»ºä¸€ä¸ªã€‚</li><li><strong>é£é™©</strong>ï¼šåŒæ ·è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—å­˜æ”¾å¾…æ‰§è¡Œçº¿ç¨‹ï¼Œæ— é™å †ç§¯ä¸‹ä¼šå‡ºç°OOMã€‚</li></ul><h3 id="_3-newcachedthreadpool" tabindex="-1"><a class="header-anchor" href="#_3-newcachedthreadpool" aria-hidden="true">#</a> 3. newCachedThreadPool</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> groupId <span class="token operator">=</span> i<span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ç¬¬ {} ç»„ä»»åŠ¡ï¼Œç¬¬ {} æ¬¡æ‰§è¡Œå®Œæˆ&quot;</span><span class="token punctuation">,</span> groupId<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// æµ‹è¯•ç»“æœ</span>
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">59.818</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">59.818</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">59.818</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">59.818</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">1</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">00.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">00.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">00.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">00.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">2</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">01.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">01.823</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">01.824</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">01.824</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">3</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">02.824</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">1</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">02.824</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">4</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">02.825</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">3</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
    <span class="token number">23</span><span class="token operator">:</span><span class="token number">25</span><span class="token operator">:</span><span class="token number">02.825</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>test<span class="token punctuation">.</span></span>Test_newCachedThreadPool</span> <span class="token operator">-</span> ç¬¬ <span class="token number">2</span> ç»„ä»»åŠ¡ï¼Œç¬¬ <span class="token number">4</span> æ¬¡æ‰§è¡Œå®Œæˆ
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å›¾è§£</strong></p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-22-3.png" alt="å›¾ 22-3 newCachedThreadPool æ‰§è¡Œè¿‡ç¨‹"></p><ul><li><strong>ä»£ç </strong>ï¼š<code>new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue&lt;Runnable&gt;())</code></li><li><strong>ä»‹ç»</strong>ï¼šé¦–å…ˆ <code>SynchronousQueue</code> æ˜¯ä¸€ä¸ªç”Ÿäº§æ¶ˆè´¹æ¨¡å¼çš„é˜»å¡ä»»åŠ¡é˜Ÿåˆ—ï¼Œåªè¦æœ‰ä»»åŠ¡å°±éœ€è¦æœ‰çº¿ç¨‹æ‰§è¡Œï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯ä»¥é‡å¤ä½¿ç”¨ã€‚</li><li><strong>é£é™©</strong>ï¼šå¦‚æœçº¿ç¨‹ä»»åŠ¡æ¯”è¾ƒè€—æ—¶ï¼Œåˆå¤§é‡åˆ›å»ºï¼Œä¼šå¯¼è‡´OOM</li></ul><h3 id="_4-newscheduledthreadpool" tabindex="-1"><a class="header-anchor" href="#_4-newscheduledthreadpool" aria-hidden="true">#</a> 4. newScheduledThreadPool</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ScheduledExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;3ç§’åå¼€å§‹æ‰§è¡Œ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;3ç§’åå¼€å§‹æ‰§è¡Œï¼Œä»¥åæ¯2ç§’æ‰§è¡Œä¸€æ¬¡&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    executorService<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;3ç§’åå¼€å§‹æ‰§è¡Œï¼Œåç»­å»¶è¿Ÿ2ç§’&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æµ‹è¯•ç»“æœ</span>
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">32.442</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œ
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">32.444</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œä»¥åæ¯<span class="token number">2</span>ç§’æ‰§è¡Œä¸€æ¬¡
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">32.444</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œåç»­å»¶è¿Ÿ<span class="token number">2</span>ç§’
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">34.441</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œä»¥åæ¯<span class="token number">2</span>ç§’æ‰§è¡Œä¸€æ¬¡
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">34.445</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œåç»­å»¶è¿Ÿ<span class="token number">2</span>ç§’
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">36.440</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œä»¥åæ¯<span class="token number">2</span>ç§’æ‰§è¡Œä¸€æ¬¡
<span class="token number">23</span><span class="token operator">:</span><span class="token number">28</span><span class="token operator">:</span><span class="token number">36.445</span> <span class="token punctuation">[</span>pool<span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>i<span class="token punctuation">.</span>i<span class="token punctuation">.</span>t<span class="token punctuation">.</span></span>Test_newScheduledThreadPool</span> <span class="token operator">-</span> <span class="token number">3</span>ç§’åå¼€å§‹æ‰§è¡Œï¼Œåç»­å»¶è¿Ÿ<span class="token number">2</span>ç§’
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å›¾è§£</strong></p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-22-4.png" alt="å›¾ 22-4 newScheduledThreadPool æ‰§è¡Œè¿‡ç¨‹"></p><ul><li><strong>ä»£ç </strong>ï¼š<code>public ScheduledThreadPoolExecutor(int corePoolSize) { super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS, new ScheduledThreadPoolExecutor.DelayedWorkQueue()); }</code></li><li><strong>ä»‹ç»</strong>ï¼šè¿™å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„çº¿ç¨‹æ± äº†ï¼Œå®ƒå¯ä»¥å»¶è¿Ÿå®šæ—¶æ‰§è¡Œï¼Œæœ‰ç‚¹åƒæˆ‘ä»¬çš„å®šæ—¶ä»»åŠ¡ã€‚åŒæ ·å®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ— é™å¤§å°çš„çº¿ç¨‹æ±  <code>Integer.MAX_VALUE</code>ã€‚å®ƒæä¾›çš„è°ƒç”¨æ–¹æ³•æ¯”è¾ƒå¤šï¼ŒåŒ…æ‹¬ï¼š<code>scheduleAtFixedRate</code>ã€<code>scheduleWithFixedDelay</code>ï¼Œå¯ä»¥æŒ‰éœ€é€‰æ‹©å»¶è¿Ÿæ‰§è¡Œæ–¹å¼ã€‚</li><li><strong>é£é™©</strong>ï¼šåŒæ ·ç”±äºè¿™æ˜¯ä¸€ç»„æ— é™å®¹é‡çš„çº¿ç¨‹æ± ï¼Œæ‰€ä»¥ä¾æ—§æœ‰OOMé£é™©ã€‚</li></ul><h2 id="å››ã€çº¿ç¨‹æ± ä½¿ç”¨åœºæ™¯è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#å››ã€çº¿ç¨‹æ± ä½¿ç”¨åœºæ™¯è¯´æ˜" aria-hidden="true">#</a> å››ã€çº¿ç¨‹æ± ä½¿ç”¨åœºæ™¯è¯´æ˜</h2><p>ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ</p><p>è¯´ç®€å•æ˜¯å½“ä¸ºäº†ç»™è€æ¿çœé’±çš„æ—¶å€™ï¼Œå› ä¸ºä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥é™ä½æœåŠ¡å™¨èµ„æºçš„æŠ•å…¥ï¼Œè®©æ¯å°æœºå™¨å°½å¯èƒ½æ›´å¤§é™åº¦çš„ä½¿ç”¨CPUã€‚</p><p><em>ğŸ˜„é‚£ä½ è¿™ä¹ˆè¯´è‚¯å®šæ²¡åŠæ³•å‡èŒåŠ è–ªäº†ï¼</em></p>`,41),m={href:"https://baike.baidu.com/item/%E7%A7%91%E7%89%B9%E5%B0%94%E6%B3%95%E5%88%99/5496269?fr=aladdin",target:"_blank",rel:"noopener noreferrer"},b={href:"https://baike.baidu.com/item/%E9%98%BF%E5%A7%86%E8%BE%BE%E5%B0%94%E5%AE%9A%E5%BE%8B/10386960?fr=aladdin",target:"_blank",rel:"noopener noreferrer"},v=t(`<p><strong>å‡å¦‚</strong>ï¼šæˆ‘ä»¬æœ‰ä¸€å¥—ç”µå•†æœåŠ¡ï¼Œç”¨æˆ·æµè§ˆå•†å“çš„å¹¶å‘è®¿é—®é€Ÿç‡æ˜¯ï¼š1000å®¢æˆ·/æ¯åˆ†é’Ÿï¼Œå¹³å‡æ¯ä¸ªå®¢æˆ·åœ¨æœåŠ¡å™¨ä¸Šçš„è€—æ—¶0.5åˆ†é’Ÿã€‚æ ¹æ®åˆ©ç‰¹å°”æ³•åˆ™ï¼Œåœ¨ä»»ä½•æ—¶åˆ»ï¼ŒæœåŠ¡ç«¯éƒ½æ‰¿æ‹…ç€1000*0.5=500ä¸ªå®¢æˆ·çš„ä¸šåŠ¡å¤„ç†é‡ã€‚è¿‡æ®µæ—¶é—´å¤§ä¿ƒäº†ï¼Œå¹¶å‘è®¿é—®çš„ç”¨æˆ·æ‰©äº†ä¸€å€2000å®¢æˆ·äº†ï¼Œé‚£æ€ä¹ˆä¿éšœæœåŠ¡æ€§èƒ½å‘¢ï¼Ÿ</p><ol><li>æé«˜æœåŠ¡å™¨å¹¶å‘å¤„ç†çš„ä¸šåŠ¡é‡ï¼Œå³æé«˜åˆ°2000Ã—0.5=1000</li><li>å‡å°‘æœåŠ¡å™¨å¹³å‡å¤„ç†å®¢æˆ·è¯·æ±‚çš„æ—¶é—´ï¼Œå³å‡å°‘åˆ°ï¼š2000Ã—0.25=500</li></ol><p><strong>æ‰€ä»¥</strong>ï¼šåœ¨æœ‰äº›åœºæ™¯ä¸‹ä¼šæŠŠä¸²è¡Œçš„è¯·æ±‚æ¥å£ï¼Œå‹ç¼©æˆå¹¶è¡Œæ‰§è¡Œï¼Œå¦‚å›¾ 22-5</p><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-22-5.png" alt="å›¾22-5 å¤šçº¿ç¨‹æ¥å£æŸ¥è¯¢ä½¿ç”¨"></p><p><strong>ä½†æ˜¯</strong>ï¼Œçº¿ç¨‹æ± çš„ä½¿ç”¨ä¼šéšç€ä¸šåŠ¡åœºæ™¯å˜åŒ–è€Œä¸åŒï¼Œå¦‚æœä½ çš„ä¸šåŠ¡éœ€è¦å¤§é‡çš„ä½¿ç”¨çº¿ç¨‹æ± ï¼Œå¹¶éå¸¸ä¾èµ–çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆå°±ä¸å¯èƒ½ç”¨ <code>Executors</code> å·¥å…·ç±»ä¸­æä¾›çš„æ–¹æ³•ã€‚å› ä¸ºè¿™äº›çº¿ç¨‹æ± çš„åˆ›å»ºéƒ½ä¸å¤Ÿç²¾ç»†åŒ–ï¼Œä¹Ÿéå¸¸å®¹æ˜“é€ æˆOOMé£é™©ï¼Œè€Œä¸”éšç€ä¸šåŠ¡åœºæ™¯é€»è¾‘ä¸åŒï¼Œä¼šæœ‰IOå¯†é›†å‹å’ŒCPUå¯†é›†å‹ã€‚</p><p><strong>æœ€ç»ˆ</strong>ï¼Œå¤§å®¶ä½¿ç”¨çš„çº¿ç¨‹æ± éƒ½æ˜¯ä½¿ç”¨ <code>new ThreadPoolExecutor()</code> åˆ›å»ºçš„ï¼Œå½“ç„¶ä¹Ÿæœ‰åŸºäºSpringçš„çº¿ç¨‹æ± é…ç½® <code>org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor</code>ã€‚</p><p><strong>å¯ä½ æƒ³è¿‡å—</strong>ï¼ŒåŒæ ·ä¸€ä¸ªæ¥å£åœ¨æœ‰æ´»åŠ¨æ—¶å€™æ€ä¹ˆåŠã€æœ‰å¤§ä¿ƒæ—¶å€™æ€ä¹ˆåŠï¼Œå¯èƒ½ä½ å½“æ—¶è®¾ç½®çš„çº¿ç¨‹æ± æ˜¯åˆç†çš„ï¼Œä½†æ˜¯ä¸€åˆ°æµé‡éå¸¸å¤§çš„æ—¶å€™å°±å¾ˆä¸é€‚åˆäº†ï¼Œæ‰€ä»¥å¦‚æœèƒ½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å°±éå¸¸æœ‰å¿…è¦äº†ã€‚è€Œä¸”ä½¿ç”¨ <code>new ThreadPoolExecutor()</code> æ–¹å¼åˆ›å»ºçš„çº¿ç¨‹æ± æ˜¯å¯ä»¥é€šè¿‡æä¾›çš„ set æ–¹æ³•è¿›è¡ŒåŠ¨æ€è°ƒæ•´çš„ã€‚æœ‰äº†è¿™ä¸ªåŠ¨æ€è°ƒæ•´çš„æ–¹æ³•åï¼Œå°±å¯ä»¥æŠŠçº¿ç¨‹æ± åŒ…è£…èµ·æ¥ï¼Œåœ¨é…åˆåŠ¨æ€è°ƒæ•´çš„é¡µé¢ï¼ŒåŠ¨æ€æ›´æ–°çº¿ç¨‹æ± å‚æ•°ï¼Œå°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„è°ƒæ•´çº¿ç¨‹æ± äº†ã€‚</p><h2 id="äº”ã€è·å–çº¿ç¨‹æ± ç›‘æ§ä¿¡æ¯" tabindex="-1"><a class="header-anchor" href="#äº”ã€è·å–çº¿ç¨‹æ± ç›‘æ§ä¿¡æ¯" aria-hidden="true">#</a> äº”ã€è·å–çº¿ç¨‹æ± ç›‘æ§ä¿¡æ¯</h2><p><code>ä½ æ”¶è¿‡æŠ¥è­¦çŸ­ä¿¡å—ï¼Ÿ</code></p><p>æ”¶è¿‡ï¼ŒåŠå¤œè¿˜æœ‰æŠ¥è­¦æœºå™¨äººæ‰“ç”µè¯å‘¢ï¼å´´ï¼Œä½ çš„ç³»ç»Ÿæœ‰ä¸ªæœºå™¨ç¡ç€äº†ï¼Œå¿«èµ·æ¥çœ‹çœ‹ï¼ï¼ï¼</p><p>æ‰€ä»¥ï¼Œå¦‚æœä½ é«˜é¢‘ã€é«˜ä¾èµ–çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ªå®Œæ•´çš„ç›‘æ§ç³»ç»Ÿï¼Œå°±éé‡è¦äº†ã€‚æ€»ä¸èƒ½çº¿ä¸ŠæŒ‚äº†ï¼Œä½ è¿˜ä¸çŸ¥é“ï¼</p><p><strong>å¯ç›‘æ§å†…å®¹</strong></p><table><thead><tr><th><strong>æ–¹æ³•</strong></th><th><strong>å«ä¹‰</strong></th></tr></thead><tbody><tr><td>getActiveCount()</td><td>çº¿ç¨‹æ± ä¸­æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ•°é‡</td></tr><tr><td>getCompletedTaskCount()</td><td>çº¿ç¨‹æ± å·²å®Œæˆçš„ä»»åŠ¡æ•°é‡ï¼Œè¯¥å€¼å°äºç­‰äºtaskCount</td></tr><tr><td>getCorePoolSize()</td><td>çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡</td></tr><tr><td>getLargestPoolSize()</td><td>çº¿ç¨‹æ± æ›¾ç»åˆ›å»ºè¿‡çš„æœ€å¤§çº¿ç¨‹æ•°é‡ã€‚é€šè¿‡è¿™ä¸ªæ•°æ®å¯ä»¥çŸ¥é“çº¿ç¨‹æ± æ˜¯å¦æ»¡è¿‡ï¼Œä¹Ÿå°±æ˜¯è¾¾åˆ°äº†maximumPoolSize</td></tr><tr><td>getMaximumPoolSize()</td><td>çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°é‡</td></tr><tr><td>getPoolSize()</td><td>çº¿ç¨‹æ± å½“å‰çš„çº¿ç¨‹æ•°é‡</td></tr><tr><td>getTaskCount()</td><td>çº¿ç¨‹æ± å·²ç»æ‰§è¡Œçš„å’Œæœªæ‰§è¡Œçš„ä»»åŠ¡æ€»æ•°</td></tr></tbody></table><h3 id="_1-é‡å†™çº¿ç¨‹æ± æ–¹å¼ç›‘æ§" tabindex="-1"><a class="header-anchor" href="#_1-é‡å†™çº¿ç¨‹æ± æ–¹å¼ç›‘æ§" aria-hidden="true">#</a> 1. é‡å†™çº¿ç¨‹æ± æ–¹å¼ç›‘æ§</h3><p>å¦‚æœæˆ‘ä»¬æƒ³ç›‘æ§ä¸€ä¸ªçº¿ç¨‹æ± çš„æ–¹æ³•æ‰§è¡ŒåŠ¨ä½œï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ç»§æ‰¿è¿™ä¸ªç±»ï¼Œé‡å†™æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­æ·»åŠ åŠ¨ä½œæ”¶é›†ä¿¡æ¯ã€‚</p><p><strong>ä¼ªä»£ç </strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolMonitor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç»Ÿè®¡å·²æ‰§è¡Œä»»åŠ¡ã€æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€æœªæ‰§è¡Œä»»åŠ¡æ•°é‡</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç»Ÿè®¡å·²æ‰§è¡Œä»»åŠ¡ã€æ­£åœ¨æ‰§è¡Œä»»åŠ¡ã€æœªæ‰§è¡Œä»»åŠ¡æ•°é‡</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">beforeExecute</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è®°å½•å¼€å§‹æ—¶é—´</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">afterExecute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è®°å½•å®Œæˆè€—æ—¶</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-åŸºäºivmtiæ–¹å¼ç›‘æ§" tabindex="-1"><a class="header-anchor" href="#_2-åŸºäºivmtiæ–¹å¼ç›‘æ§" aria-hidden="true">#</a> 2. åŸºäºIVMTIæ–¹å¼ç›‘æ§</h3><p>è¿™å—æ˜¯ç›‘æ§çš„é‡ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¤ªå¯èƒ½è®©æ¯ä¸€ä¸ªéœ€è¦ç›‘æ§çš„çº¿ç¨‹æ± éƒ½æ¥é‡å†™çš„æ–¹å¼è®°å½•ï¼Œè¿™æ ·çš„æ”¹é€ æˆæœ¬å¤ªé«˜äº†ã€‚</p><p>é‚£ä¹ˆé™¤äº†è¿™ä¸ªç¬¨æ–¹æ³•å¤–ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨åŸºäºJVMTIçš„æ–¹å¼ï¼Œè¿›è¡Œå¼€å‘ç›‘æ§ç»„ä»¶ã€‚</p><p><strong>JVMTI</strong>ï¼šJVMTI(JVM Tool Interface)ä½äºjpdaæœ€åº•å±‚ï¼Œæ˜¯Javaè™šæ‹Ÿæœºæ‰€æä¾›çš„nativeç¼–ç¨‹æ¥å£ã€‚JVMTIå¯ä»¥æä¾›æ€§èƒ½åˆ†æã€debugã€å†…å­˜ç®¡ç†ã€çº¿ç¨‹åˆ†æç­‰åŠŸèƒ½ã€‚</p><p>åŸºäºjvmtiæä¾›çš„æ¥å£æœåŠ¡ï¼Œè¿ç”¨C++ä»£ç (win32-add_library)åœ¨Agent_OnLoadé‡Œå¼€å‘ç›‘æ§æœåŠ¡ï¼Œå¹¶ç”Ÿæˆdllæ–‡ä»¶ã€‚å¼€å‘å®Œæˆååœ¨javaä»£ç ä¸­åŠ å…¥agentpathï¼Œè¿™æ ·å°±å¯ä»¥ç›‘æ§åˆ°æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯å†…å®¹ã€‚</p><p><strong>ç¯å¢ƒå‡†å¤‡</strong>ï¼š</p><ol><li>Dev-C++</li><li>JetBrains CLion 2018.2.3</li><li>IntelliJ IDEA Community Edition 2018.3.1 x64</li><li>jdk1.8.0_45 64ä½</li><li>jvmtiï¼ˆåœ¨jdkå®‰è£…ç›®å½•ä¸‹jdk1.8.0_45\\includeé‡Œï¼ŒæŠŠincludeæ•´ä¸ªæ–‡ä»¶å¤¹å¤åˆ¶åˆ°å’Œå·¥ç¨‹æ¡ˆä¾‹åŒå±‚çº§ç›®å½•ä¸‹ï¼Œä¾¿äº include å¼•ç”¨ï¼‰</li></ol><p><strong>é…ç½®ä¿¡æ¯</strong>ï¼šï¼ˆè·¯å¾„ç›¸å…³ä¿®æ”¹ä¸ºè‡ªå·±çš„ï¼‰</p><ol><li>C++å¼€å‘å·¥å…·Clioné…ç½® 1.é…ç½®ä½ç½®ï¼›Settings-&gt;Build,Execution,Deployment-&gt;Toolchains 2. MinGMé…ç½®ï¼šD:\\Program Files (x86)\\Dev-Cpp\\MinGW64</li><li>javaè°ƒè¯•æ—¶é…ç½® <ol><li>é…ç½®ä½ç½®ï¼šRun/Debug Configurations -&gt;VM options</li><li>é…ç½®å†…å®¹ï¼š-agentpath:E:\\itstack\\git\\github.com\\itstack-jvmti\\cmake-build-debug\\libitstack_jvmti.dll</li></ol></li></ol><h4 id="_2-1-å…ˆåšä¸€ä¸ªç›‘æ§ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_2-1-å…ˆåšä¸€ä¸ªç›‘æ§ä¾‹å­" aria-hidden="true">#</a> 2.1 å…ˆåšä¸€ä¸ªç›‘æ§ä¾‹å­</h4><p><strong>Javaå·¥ç¨‹</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestLocationException</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">&quot;TestLocationException&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">PartnerEggResourceImpl</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PartnerEggResourceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> obj <span class="token operator">=</span> resource<span class="token punctuation">.</span><span class="token function">queryUserInfoById</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š&quot;</span> <span class="token operator">+</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å±è”½å¼‚å¸¸</span>
 <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PartnerEggResourceImpl</span> <span class="token punctuation">{</span>
    <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">&quot;PartnerEggResourceImpl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">queryUserInfoById</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;æ ¹æ®ç”¨æˆ·Idè·å–ç”¨æˆ·ä¿¡æ¯&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">&quot;æ ¹æ®ç”¨æˆ·Idè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œç©ºæŒ‡é’ˆå¼‚å¸¸&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>c++ç›‘æ§</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>#include <span class="token generics"><span class="token punctuation">&lt;</span>iostream<span class="token punctuation">&gt;</span></span>
#include <span class="token generics"><span class="token punctuation">&lt;</span>cstring<span class="token punctuation">&gt;</span></span>
#include <span class="token string">&quot;jvmti.h&quot;</span>

using namespace std<span class="token punctuation">;</span>

<span class="token comment">//å¼‚å¸¸å›è°ƒå‡½æ•°</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">JNICALL</span>
<span class="token function">callbackException</span><span class="token punctuation">(</span>jvmtiEnv <span class="token operator">*</span>jvmti_env<span class="token punctuation">,</span> <span class="token class-name">JNIEnv</span> <span class="token operator">*</span>env<span class="token punctuation">,</span> jthread thr<span class="token punctuation">,</span> jmethodID methodId<span class="token punctuation">,</span> jlocation location<span class="token punctuation">,</span>
jobject exception<span class="token punctuation">,</span> jmethodID catch_method<span class="token punctuation">,</span> jlocation catch_location<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// è·å¾—æ–¹æ³•å¯¹åº”çš„ç±»</span>
jclass clazz<span class="token punctuation">;</span>
jvmti_env<span class="token operator">-&gt;</span><span class="token class-name">GetMethodDeclaringClass</span><span class="token punctuation">(</span>methodId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è·å¾—ç±»çš„ç­¾å</span>
<span class="token keyword">char</span> <span class="token operator">*</span>class_signature<span class="token punctuation">;</span>
jvmti_env<span class="token operator">-&gt;</span><span class="token class-name">GetClassSignature</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>class_signature<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//è¿‡æ»¤éæœ¬å·¥ç¨‹ç±»ä¿¡æ¯</span>
string<span class="token operator">::</span><span class="token function">size_type</span> idx<span class="token punctuation">;</span>
string class_signature_str <span class="token operator">=</span> class_signature<span class="token punctuation">;</span>
idx <span class="token operator">=</span> class_signature_str<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;org/itstack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//å¼‚å¸¸ç±»åç§°</span>
<span class="token keyword">char</span> <span class="token operator">*</span>exception_class_name<span class="token punctuation">;</span>
jclass exception_class <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token class-name">GetObjectClass</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
jvmti_env<span class="token operator">-&gt;</span><span class="token class-name">GetClassSignature</span><span class="token punctuation">(</span>exception_class<span class="token punctuation">,</span> <span class="token operator">&amp;</span>exception_class_name<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è·å¾—æ–¹æ³•åç§°</span>
<span class="token keyword">char</span> <span class="token operator">*</span>method_name_ptr<span class="token punctuation">,</span> <span class="token operator">*</span>method_signature_ptr<span class="token punctuation">;</span>
jvmti_env<span class="token operator">-&gt;</span><span class="token class-name">GetMethodName</span><span class="token punctuation">(</span>methodId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>method_name_ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>method_signature_ptr<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//è·å–ç›®æ ‡æ–¹æ³•çš„èµ·æ­¢åœ°å€å’Œç»“æŸåœ°å€</span>
jlocation start_location_ptr<span class="token punctuation">;</span>    <span class="token comment">//æ–¹æ³•çš„èµ·å§‹ä½ç½®</span>
jlocation end_location_ptr<span class="token punctuation">;</span>      <span class="token comment">//ç”¨äºæ–¹æ³•çš„ç»“æŸä½ç½®</span>
jvmti_env<span class="token operator">-&gt;</span><span class="token class-name">GetMethodLocation</span><span class="token punctuation">(</span>methodId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>start_location_ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>end_location_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//è¾“å‡ºæµ‹è¯•ç»“æœ</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;æµ‹è¯•ç»“æœ - å®šä½ç±»çš„ç­¾åï¼š&quot;</span> <span class="token operator">&lt;&lt;</span> class_signature <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;æµ‹è¯•ç»“æœ - å®šä½æ–¹æ³•ä¿¡æ¯ï¼š&quot;</span> <span class="token operator">&lt;&lt;</span> method_name_ptr <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; -&gt; &quot;</span> <span class="token operator">&lt;&lt;</span> method_signature_ptr <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;æµ‹è¯•ç»“æœ - å®šä½æ–¹æ³•ä½ç½®ï¼š&quot;</span> <span class="token operator">&lt;&lt;</span> start_location_ptr <span class="token operator">&lt;&lt;</span> <span class="token string">&quot; -&gt; &quot;</span> <span class="token operator">&lt;&lt;</span> end_location_ptr <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;æµ‹è¯•ç»“æœ - å¼‚å¸¸ç±»çš„åç§°ï¼š&quot;</span> <span class="token operator">&lt;&lt;</span> exception_class_name <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;æµ‹è¯•ç»“æœ-è¾“å‡ºå¼‚å¸¸ä¿¡æ¯(å¯ä»¥åˆ†æè¡Œå·)ï¼š&quot;</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
jclass throwable_class <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">&quot;java/lang/Throwable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jmethodID print_method <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>throwable_class<span class="token punctuation">,</span> <span class="token string">&quot;printStackTrace&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>exception<span class="token punctuation">,</span> print_method<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>


<span class="token constant">JNIEXPORT</span> jint <span class="token constant">JNICALL</span> <span class="token class-name">Agent_OnLoad</span><span class="token punctuation">(</span><span class="token class-name">JavaVM</span> <span class="token operator">*</span>vm<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>options<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jvmtiEnv <span class="token operator">*</span>gb_jvmti <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    <span class="token comment">//åˆå§‹åŒ–</span>
    vm<span class="token operator">-&gt;</span><span class="token class-name">GetEnv</span><span class="token punctuation">(</span>reinterpret_cast<span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gb_jvmti<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JVMTI_VERSION_1_0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ç¯å¢ƒ</span>
    jvmtiCapabilities caps<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>caps<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>caps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    caps<span class="token punctuation">.</span>can_signal_thread <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    caps<span class="token punctuation">.</span>can_get_owned_monitor_info <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    caps<span class="token punctuation">.</span>can_generate_method_entry_events <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    caps<span class="token punctuation">.</span>can_generate_exception_events <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    caps<span class="token punctuation">.</span>can_generate_vm_object_alloc_events <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    caps<span class="token punctuation">.</span>can_tag_objects <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®å½“å‰ç¯å¢ƒ</span>
    gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">AddCapabilities</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>caps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„å›è°ƒå‡½æ•°</span>
    jvmtiEventCallbacks callbacks<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>callbacks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å¼‚å¸¸å›è°ƒ</span>
    <span class="token class-name"><span class="token namespace">callbacks<span class="token punctuation">.</span></span>Exception</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>callbackException<span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®å›è°ƒå‡½æ•°</span>
    gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">SetEventCallbacks</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>callbacks<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¼€å¯äº‹ä»¶ç›‘å¬(JVMTI_EVENT_EXCEPTION)</span>
    gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">SetEventNotificationMode</span><span class="token punctuation">(</span><span class="token constant">JVMTI_ENABLE</span><span class="token punctuation">,</span> <span class="token constant">JVMTI_EVENT_EXCEPTION</span><span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">JNI_OK</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token constant">JNIEXPORT</span> <span class="token keyword">void</span> <span class="token constant">JNICALL</span> <span class="token class-name">Agent_OnUnload</span><span class="token punctuation">(</span><span class="token class-name">JavaVM</span> <span class="token operator">*</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æµ‹è¯•ç»“æœ</strong></p><p>åœ¨ VM vptions ä¸­é…ç½®ï¼š<code>-agentpath:E:\\itstack\\git\\github.com\\itstack-jvmti\\cmake-build-debug\\libitstack_jvmti.dll</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>åäºŒæœˆ <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2020</span> <span class="token number">23</span><span class="token operator">:</span><span class="token number">53</span><span class="token operator">:</span><span class="token number">27</span> ä¸‹åˆ <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span></span>PartnerEggResourceImpl</span> queryUserInfoById
ä¿¡æ¯<span class="token operator">:</span> æ ¹æ®ç”¨æˆ·<span class="token class-name">Id</span>è·å–ç”¨æˆ·ä¿¡æ¯<span class="token keyword">null</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>NullPointerException</span><span class="token operator">:</span> æ ¹æ®ç”¨æˆ·<span class="token class-name">Id</span>è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œç©ºæŒ‡é’ˆå¼‚å¸¸
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span></span>PartnerEggResourceImpl</span><span class="token punctuation">.</span><span class="token function">queryUserInfoById</span><span class="token punctuation">(</span><span class="token class-name">TestLocationException</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">26</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span></span>TestLocationException</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">TestLocationException</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">)</span>
æµ‹è¯•ç»“æœ<span class="token operator">-</span>å®šä½ç±»çš„ç­¾åï¼š<span class="token class-name">Lorg</span><span class="token operator">/</span>itstack<span class="token operator">/</span>demo<span class="token operator">/</span><span class="token class-name">PartnerEggResourceImpl</span><span class="token punctuation">;</span>
æµ‹è¯•ç»“æœ<span class="token operator">-</span>å®šä½æ–¹æ³•ä¿¡æ¯ï¼šqueryUserInfoById <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Object</span><span class="token punctuation">;</span>
æµ‹è¯•ç»“æœ<span class="token operator">-</span>å®šä½æ–¹æ³•ä½ç½®ï¼š<span class="token number">0</span> <span class="token operator">-&gt;</span> <span class="token number">43</span>
æµ‹è¯•ç»“æœ<span class="token operator">-</span>å¼‚å¸¸ç±»çš„åç§°ï¼š<span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">NullPointerException</span><span class="token punctuation">;</span>
æµ‹è¯•ç»“æœ<span class="token operator">-</span>è¾“å‡ºå¼‚å¸¸ä¿¡æ¯<span class="token punctuation">(</span>å¯ä»¥åˆ†æè¡Œå·<span class="token punctuation">)</span>ï¼š
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™å°±æ˜¯åŸºäºJVMTIçš„æ–¹å¼è¿›è¡Œç›‘æ§ï¼Œè¿™æ ·çš„æ–¹å¼å¯ä»¥åšåˆ°éå…¥ä¾µä»£ç ã€‚ä¸éœ€è¦ç¡¬ç¼–ç ï¼Œä¹Ÿå°±èŠ‚çœäº†äººåŠ›ï¼Œå¦åˆ™æ‰€æœ‰äººéƒ½ä¼šè¿›è¡Œå¼€å‘ç›‘æ§å†…å®¹ï¼Œè€Œè¿™éƒ¨åˆ†å†…å®¹ä¸ä¸šåŠ¡é€»è¾‘å¹¶æ— å…³ç³»ã€‚</li></ul><h4 id="_2-2-æ‰©å±•çº¿ç¨‹ç›‘æ§" tabindex="-1"><a class="header-anchor" href="#_2-2-æ‰©å±•çº¿ç¨‹ç›‘æ§" aria-hidden="true">#</a> 2.2 æ‰©å±•çº¿ç¨‹ç›‘æ§</h4><p>å…¶å®æ–¹æ³•å·®ä¸å¤šï¼Œéƒ½æ˜¯åŸºäºC++å¼€å‘DLLæ–‡ä»¶ï¼Œå¼•å…¥ä½¿ç”¨ã€‚ä¸è¿‡è¿™éƒ¨åˆ†ä»£ç ä¼šç›‘æ§æ–¹æ³•ä¿¡æ¯ï¼Œå¹¶é‡‡é›†çº¿ç¨‹çš„æ‰§è¡Œå†…å®¹ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token class-name">JNICALL</span> <span class="token function">callbackMethodEntry</span><span class="token punctuation">(</span>jvmtiEnv <span class="token operator">*</span>jvmti_env<span class="token punctuation">,</span> <span class="token class-name">JNIEnv</span> <span class="token operator">*</span>env<span class="token punctuation">,</span> jthread thr<span class="token punctuation">,</span> jmethodID method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å¾—æ–¹æ³•å¯¹åº”çš„ç±»</span>
    jclass clazz<span class="token punctuation">;</span>
    jvmti_env<span class="token operator">-&gt;</span><span class="token class-name">GetMethodDeclaringClass</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">&amp;</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è·å¾—ç±»çš„ç­¾å</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>class_signature<span class="token punctuation">;</span>
    jvmti_env<span class="token operator">-&gt;</span><span class="token class-name">GetClassSignature</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>class_signature<span class="token punctuation">,</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//è¿‡æ»¤éæœ¬å·¥ç¨‹ç±»ä¿¡æ¯</span>
    string<span class="token operator">::</span><span class="token function">size_type</span> idx<span class="token punctuation">;</span>
    string class_signature_str <span class="token operator">=</span> class_signature<span class="token punctuation">;</span>
    idx <span class="token operator">=</span> class_signature_str<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;org/itstack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">RawMonitorEnter</span><span class="token punctuation">(</span>gb_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">{</span>
        <span class="token comment">//must be deallocate</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>sig <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>gsig <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        jint thr_hash_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        error <span class="token operator">=</span> gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">GetMethodName</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gsig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        error <span class="token operator">=</span> gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">GetObjectHashCode</span><span class="token punctuation">(</span>thr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thr_hash_code<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;interrupt&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;join&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;stop&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;suspend&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;resume&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">//must be deallocate</span>
            jobject thd_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            jint hash_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">GetLocalObject</span><span class="token punctuation">(</span>thr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>thd_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">GetObjectHashCode</span><span class="token punctuation">(</span>thd_ptr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hash_code<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;[çº¿ç¨‹ç›‘æ§]: thread (%10d) %10s (%10d)\\n&quot;</span><span class="token punctuation">,</span> thr_hash_code<span class="token punctuation">,</span> name<span class="token punctuation">,</span> hash_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">RawMonitorExit</span><span class="token punctuation">(</span>gb_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token constant">JNIEXPORT</span> jint <span class="token constant">JNICALL</span> <span class="token class-name">Agent_OnLoad</span><span class="token punctuation">(</span><span class="token class-name">JavaVM</span> <span class="token operator">*</span>jvm<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>options<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>reserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// åˆå§‹åŒ–</span>
    jvm<span class="token operator">-&gt;</span><span class="token class-name">GetEnv</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>gb_jvmti<span class="token punctuation">,</span> <span class="token constant">JVMTI_VERSION_1_0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ç¯å¢ƒ</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gb_capa<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>jvmtiCapabilities<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_signal_thread <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_get_owned_monitor_info <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_generate_method_exit_events <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_generate_method_entry_events <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_generate_exception_events <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_generate_vm_object_alloc_events <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_tag_objects <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_generate_all_class_hook_events <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_generate_native_method_bind_events <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_access_local_variables <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    gb_capa<span class="token punctuation">.</span>can_get_monitor_info <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®å½“å‰ç¯å¢ƒ</span>
    gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">AddCapabilities</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gb_capa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„å›è°ƒå‡½æ•°</span>
    jvmtiEventCallbacks callbacks<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>callbacks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>jvmtiEventCallbacks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ–¹æ³•å›è°ƒ</span>
    <span class="token class-name"><span class="token namespace">callbacks<span class="token punctuation">.</span></span>MethodEntry</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>callbackMethodEntry<span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®å›è°ƒå‡½æ•°</span>
    gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">SetEventCallbacks</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>callbacks<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">CreateRawMonitor</span><span class="token punctuation">(</span><span class="token string">&quot;XFG&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gb_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ³¨å†Œäº‹ä»¶ç›‘å¬(JVMTI_EVENT_VM_INITã€JVMTI_EVENT_EXCEPTIONã€JVMTI_EVENT_NATIVE_METHOD_BINDã€JVMTI_EVENT_CLASS_FILE_LOAD_HOOKã€JVMTI_EVENT_METHOD_ENTRYã€JVMTI_EVENT_METHOD_EXIT)</span>
    error <span class="token operator">=</span> gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">SetEventNotificationMode</span><span class="token punctuation">(</span><span class="token constant">JVMTI_ENABLE</span><span class="token punctuation">,</span> <span class="token constant">JVMTI_EVENT_VM_INIT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>jthread<span class="token punctuation">)</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    error <span class="token operator">=</span> gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">SetEventNotificationMode</span><span class="token punctuation">(</span><span class="token constant">JVMTI_ENABLE</span><span class="token punctuation">,</span> <span class="token constant">JVMTI_EVENT_EXCEPTION</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>jthread<span class="token punctuation">)</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    error <span class="token operator">=</span> gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">SetEventNotificationMode</span><span class="token punctuation">(</span><span class="token constant">JVMTI_ENABLE</span><span class="token punctuation">,</span> <span class="token constant">JVMTI_EVENT_NATIVE_METHOD_BIND</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>jthread<span class="token punctuation">)</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    error <span class="token operator">=</span> gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">SetEventNotificationMode</span><span class="token punctuation">(</span><span class="token constant">JVMTI_ENABLE</span><span class="token punctuation">,</span> <span class="token constant">JVMTI_EVENT_CLASS_FILE_LOAD_HOOK</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>jthread<span class="token punctuation">)</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    error <span class="token operator">=</span> gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">SetEventNotificationMode</span><span class="token punctuation">(</span><span class="token constant">JVMTI_ENABLE</span><span class="token punctuation">,</span> <span class="token constant">JVMTI_EVENT_METHOD_ENTRY</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>jthread<span class="token punctuation">)</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    error <span class="token operator">=</span> gb_jvmti<span class="token operator">-&gt;</span><span class="token class-name">SetEventNotificationMode</span><span class="token punctuation">(</span><span class="token constant">JVMTI_ENABLE</span><span class="token punctuation">,</span> <span class="token constant">JVMTI_EVENT_METHOD_EXIT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>jthread<span class="token punctuation">)</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token constant">JNI_OK</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä»ç›‘æ§çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰çº¿ç¨‹çš„ startã€stopã€joinã€interrupt ç­‰ï¼Œå¹¶å¯ä»¥è®°å½•æ‰§è¡Œä¿¡æ¯ã€‚</li><li>å¦å¤–è¿™é‡Œç›‘æ§çš„æ–¹æ³•æ‰§è¡Œå›è°ƒï¼Œ<code>SetEventCallbacks(&amp;callbacks, sizeof(callbacks));</code> ä»¥åŠç›¸åº”äº‹ä»¶çš„æ·»åŠ ã€‚</li></ul><h2 id="å…­ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å…­ã€æ€»ç»“" aria-hidden="true">#</a> å…­ã€æ€»ç»“</h2><ul><li>å¦‚æœè¯´ä½ æ‰€ç»å†çš„ä¸šåŠ¡ä½“é‡å¾ˆå°ï¼Œé‚£ä¹ˆå‡ ä¹å¹¶ä¸éœ€è¦å¦‚æ­¤å¤æ‚çš„æŠ€æœ¯æ ˆæ·±åº¦å­¦ä¹ ï¼Œç”šè‡³å‡ ä¹ä¸éœ€è¦æ‰©å±•å„ç±»åŠŸèƒ½ï¼Œä¹Ÿä¸éœ€è¦ç›‘æ§ã€‚ä½†ç»ˆç©¶æœ‰ä¸€äº›éœ€è¦é€ é£æœºçš„å¤§å‚ï¼Œä»–ä»¬çš„ä¸šåŠ¡ä½“é‡åºå¤§ï¼Œå¹¶å‘æ•°é«˜ï¼Œè®©åŸæœ¬å¯èƒ½å°±æ˜¯ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢æ¥å£ï¼Œä¹Ÿè¦åšç†”æ–­ã€é™çº§ã€é™æµã€ç¼“å­˜ã€çº¿ç¨‹ã€å¼‚æ­¥ã€é¢„çƒ­ç­‰ç­‰æ“ä½œã€‚</li><li>çŸ¥å…¶ç„¶æ‰æ•¢ç”¨ï¼Œå¦‚æœå¯¹ä¸€ä¸ªæŠ€æœ¯ç‚¹ä¸æ˜¯å¤ªç†Ÿæ‚‰ï¼Œå°±ä¸è¦èƒ¡ä¹±ä½¿ç”¨ï¼Œå¦åˆ™é‡åˆ°çš„OOMå¹¶ä¸æ˜¯é‚£ä¹ˆå¥½å¤ç°ï¼Œå°¤å…¶æ˜¯åœ¨å¹¶å‘åœºæ™¯ä¸‹ã€‚å½“ç„¶å¦‚æœä½ ä»¬æŠ€æœ¯ä½“ç³»ä¸­æœ‰å„ç§æœåŠ¡ï¼Œæ¯”å¦‚æµé‡å¤ç°ã€é“¾è·¯è¿½è¸ªç­‰ç­‰ï¼Œé‚£ä¹ˆè¿˜å¥½ã€‚</li><li>åˆæ‰¯åˆ°äº†è¿™ï¼Œä¸€ä¸ªåšæŒå­¦ä¹ ã€åˆ†äº«ã€æ²‰æ·€çš„ç”·äººï¼å¥½äº†ï¼Œå¦‚æœæœ‰é”™å­—ã€å†…å®¹ä¸å‡†ç¡®ï¼Œæ¬¢è¿ç›´æ¥æ€¼ç»™æˆ‘ï¼Œæˆ‘å–œæ¬¢æ¥å—ã€‚<em>ä½†ä¸è¦æ¬ºè´Ÿæˆ‘å“¦å“ˆå“ˆå“ˆå“ˆå“ˆï¼</em></li></ul>`,41);function g(h,_){const a=o("ExternalLinkIcon");return c(),l("div",null,[i,s("p",null,[n("ä½œè€…ï¼šå°å‚…å“¥ "),r,n("åšå®¢ï¼š"),s("a",k,[n("https://bugstack.cn"),p(a)])]),d,s("p",null,[n("æ‰€ä»¥å¦‚æœè¯´çš„é«˜å¤§ä¸Šä¸€ç‚¹ï¼Œé‚£ä¹ˆæ˜¯åœ¨ç¬¦åˆ"),s("a",m,[n("ç§‘ç‰¹å°”æ³•åˆ™"),p(a)]),n("å’Œ"),s("a",b,[n("é˜¿å§†è¾¾å°”å®šå¾‹ "),p(a)]),n("çš„æƒ…å†µä¸‹ï¼Œå¼•å…¥çº¿ç¨‹æ± çš„ä½¿ç”¨æœ€ä¸ºåˆç†ã€‚å•¥æ„æ€å‘¢ï¼Œè¿˜å¾—ç®€å•è¯´ï¼")]),v])}const w=e(u,[["render",g],["__file","2020-12-16-mianjingshouce Â· di22pianã€Šxianchengchidejieshaoheshiyongï¼Œyijijiyujvmtishejifeiruqinjiankongã€‹.html.vue"]]);export{w as default};
