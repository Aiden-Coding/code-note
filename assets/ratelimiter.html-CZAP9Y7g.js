import{_ as e,r as o,o as c,c as l,a as n,b as s,d as t,e as p}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"ratelimiter-é™æµ-â€”â€”-é€šè¿‡åˆ‡é¢å¯¹å•ä¸ªç”¨æˆ·è¿›è¡Œé™æµå’Œé»‘åå•å¤„ç†",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ratelimiter-é™æµ-â€”â€”-é€šè¿‡åˆ‡é¢å¯¹å•ä¸ªç”¨æˆ·è¿›è¡Œé™æµå’Œé»‘åå•å¤„ç†","aria-hidden":"true"},"#"),s(" RateLimiter é™æµ â€”â€” é€šè¿‡åˆ‡é¢å¯¹å•ä¸ªç”¨æˆ·è¿›è¡Œé™æµå’Œé»‘åå•å¤„ç†")],-1),r=n("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=n("blockquote",null,[n("p",null,"æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„")],-1),m=n("iframe",{id:"B-Video",src:"//player.bilibili.com/player.html?aid=919588155&bvid=BV1iu4y1G7VQ&cid=1361583047&p=1",scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowfullscreen:"true",width:"100%",height:"480"}," ",-1),v=n("p",null,[s("æœ¬æ–‡çš„å®—æ—¨åœ¨äºé€šè¿‡å¯¹å®é™…åœºæ™¯çš„æ¡ˆä¾‹è¿›è¡ŒæŠ½å¤ç°ï¼Œæ•™ä¼šè¯»è€…å¦‚ä½•å¯¹åº”ç”¨çš„æ¥å£ä»¥"),n("code",null,"æµè§ˆå™¨æŒ‡çº¹ID"),s("ä¸ºç»´åº¦çš„é™æµæ“ä½œï¼ŒåŒæ—¶å¯¹äºé¢‘ç¹é™æµæ‹¦æˆªçš„IDåŠ å…¥é»‘åå•ï¼Œä¸éœ€è¦é™æµè®¡ç®—å°±ğŸˆ²ç¦æ­¢å¯¹åº”ç”¨æ¥å£è®¿é—®ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼æ¥ä¿æŠ¤åº”ç”¨çš„å¯ç”¨æ€§ã€‚")],-1),b=n("p",null,"æœ¬æ–‡æ¶‰åŠçš„å·¥ç¨‹ï¼š",-1),h={href:"https://gitcode.net/KnowledgePlanet/road-map/xfg-dev-tech-ratelimiter",target:"_blank",rel:"noopener noreferrer"},g=p(`<h2 id="ä¸€ã€åœºæ™¯è¯´æ˜" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€åœºæ™¯è¯´æ˜" aria-hidden="true">#</a> ä¸€ã€åœºæ™¯è¯´æ˜</h2><p>å…³äºç™»å½•çš„å®‰å…¨æ€§ç®¡ç†æœ‰è¾ƒå¤šçš„æ‰‹æ®µï¼ŒåŒ…æ‹¬ï¼›è®¾å¤‡ä¿¡æ¯ã€IPä¿¡æ¯ã€ç»‘å®šçš„ä¿¡æ¯ã€éªŒè¯ç ç™»å„ç±»æ–¹å¼ï¼Œä¸è¿‡åœ¨ä¸€äº›ç½‘é¡µç‰ˆçš„ç™»å½•ä¸­ï¼Œæ‰‹æœºéªŒè¯ç æ–¹å¼éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„æé†’ï¼š&quot;è¯·å‹¿å‘ä»–äººæ³„éœ²éªŒè¯ç ä¿¡æ¯&quot;</p><div align="center"><img src="https://bugstack.cn/images/roadmap/tutorial/roadmap-ratelimiter-01.png?raw=true" width="350px"></div><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ æŠŠä½ çš„éªŒè¯ç ç»™æˆ‘ï¼Œæˆ‘å°±å¯ä»¥ç™»å½•ä½ çš„è´¦æˆ·ï¼ŒæŸ¥çœ‹ä½ çš„æ•°æ®ã€‚å¯¹äºä¸€äº›ä¸æ³•åˆ†å­é€šè¿‡è®©ä½ è¿›å…¥æŸäº›åº”ç”¨çš„å½•å±ä¼šè®®åï¼ˆXXXé€€è´§è¿”ç°ï¼‰ï¼Œå°±èƒ½æ‹¿åˆ°ä½ çš„éªŒè¯ç ï¼Œå¹¶åšç™»å½•æ“ä½œã€‚è¿˜æœ‰ä¸€äº›æ˜¯å®Œå…¨æµæ°“å¼åšæ³•ï¼Œå°±ç©å‘½çš„ä¸€äº›å¿«é€’ğŸ“¦æ‰‹æœºå·+éªŒè¯ç é¢‘ç¹çš„æ’æ¥å£ï¼Œä¹Ÿæ˜¯æœ‰æ¦‚ç‡æˆåŠŸç™»å½•çš„ã€‚</p><p>æ‰€ä»¥ï¼Œæœ¬èŠ‚çš„æ¡ˆä¾‹æˆ‘ä»¬æ¥è€ƒè™‘ä¸‹è¯¥å¦‚ä½•åšè¿™æ ·çš„é˜²æŠ¤å¤„ç†ã€‚</p><h2 id="äºŒã€æ–¹æ¡ˆè®¾è®¡" tabindex="-1"><a class="header-anchor" href="#äºŒã€æ–¹æ¡ˆè®¾è®¡" aria-hidden="true">#</a> äºŒã€æ–¹æ¡ˆè®¾è®¡</h2><p>æˆ‘ä»¬å¯ä»¥è€ƒè™‘åœ¨ç™»å½•çš„é˜¶æ®µå¿…é¡»åŠ ä¸€äº›æ¶å¿ƒçš„å›¾ç‰‡æ¯”å¯¹ç ï¼Œæˆ–è€…æ»‘å—éªŒè¯ç ã€‚è¿™ä¹Ÿæ˜¯ä¸€ç§æ–¹å¼ï¼Œèƒ½å°½å¯èƒ½é™ä½ç™»å½•çš„æ’æ¥å£æ“ä½œã€‚ä¹‹åå†è€ƒè™‘æ·»åŠ ä¸€ä¸ªæŒ‡çº¹IDï¼Œå¯¹äºéªŒè¯ç çš„ç”Ÿæˆä¸ç”¨æˆ·ä»æµè§ˆå™¨è®¾å¤‡è¿‡æ¥çš„æŒ‡çº¹åšç»‘å®šã€‚è¿™æ ·å³ä½¿å¯¹æ–¹é€šè¿‡å½•å±æ‹¿åˆ°ä½ çš„éªŒè¯ç ï¼Œä¹Ÿä»ç„¶æ²¡æœ‰åšç™»å½•æ“ä½œã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token comment">// Initialize the agent at application startup.</span>
  <span class="token keyword">const</span> fpPromise <span class="token operator">=</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;https://openfpcdn.io/fingerprintjs/v4&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">FingerprintJS</span> <span class="token operator">=&gt;</span> FingerprintJS<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// Get the visitor identifier when you need it.</span>
  fpPromise
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">fp</span> <span class="token operator">=&gt;</span> fp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is the visitor identifier:</span>
      <span class="token keyword">const</span> visitorId <span class="token operator">=</span> result<span class="token punctuation">.</span>visitorId
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>visitorId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰äº†ä¸Šé¢è¿™ä¸ªæ–¹æ¡ˆï¼Œæˆ‘ä»¬è‡³å°‘å¯ä»¥åšä¸€äº›å®‰å…¨çš„ç®¡æ§äº†ã€‚ä½†è¿˜æœ‰è‡­ä¸è¦è„¸çš„ï¼Œä¸€ç›´åˆ·ä½ æ¥å£ã€‚è¿™æ—¢æœ‰å®‰å…¨é£é™©ï¼Œåˆæœ‰å¯¹æœåŠ¡å™¨çš„å‹åŠ›ã€‚æ‰€ä»¥æˆ‘ä»¬è¦è€ƒè™‘å¯¹äºè¿™æ ·çš„æ¶æ„ç”¨æˆ·è¿›è¡Œ<code>é™æµå’Œè‡ªåŠ¨åŒ–é»‘åå•</code>å¤„ç†ã€‚</p><div align="center"><img src="https://bugstack.cn/images/roadmap/tutorial/roadmap-ratelimiter-02.png?raw=true" width="750px"></div><p>æµè§ˆå™¨æŒ‡çº¹çš„æ–¹æ¡ˆåªéœ€è¦åšä¸€ä¸ªéªŒè¯ç ç»‘å®šå³å¯ï¼Œä¹‹å<code>é™æµå’Œè‡ªåŠ¨åŒ–é»‘åå•</code>ï¼Œåˆ™éœ€è¦åšä¸€äº›ä»£ç çš„å¼€å‘ã€‚é€šè¿‡é…ç½®çš„æ–¹å¼ä¸ºæ¯ä¸€ä¸ªéœ€è¦åšæ­¤ç±»åŠŸèƒ½çš„æ¥å£æ·»åŠ ä¸Š<strong>æœåŠ¡æ²»ç†</strong>ã€‚<em>é€šå¸¸æˆ‘ä»¬æŠŠå¯¹åº”ç”¨çš„ç†”æ–­ã€é™çº§ã€é™æµã€åˆ‡é‡ã€é»‘ç™½åå•ã€äººç¾¤ç­‰ï¼Œéƒ½ç§°ä¸ºæœåŠ¡æ²»ç†</em></p><h2 id="ä¸‰ã€åŠŸèƒ½å®ç°" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€åŠŸèƒ½å®ç°" aria-hidden="true">#</a> ä¸‰ã€åŠŸèƒ½å®ç°</h2><h3 id="_1-å·¥ç¨‹ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-å·¥ç¨‹ç»“æ„" aria-hidden="true">#</a> 1. å·¥ç¨‹ç»“æ„</h3><div align="center"><img src="https://bugstack.cn/images/roadmap/tutorial/roadmap-ratelimiter-03.png?raw=true" width="400px"></div><ul><li>å·¥ç¨‹ä¸­ï¼Œæä¾›äº†ä¸€ä¸ª AOP åˆ‡é¢ä¸“é—¨ç”¨äºå¤„ç†ä½¿ç”¨äº†è‡ªå®šä¹‰æ³¨è§£ <code>AccessInterceptor</code> æ¥å£æ–¹æ³•ã€‚</li><li>è¿™é‡Œçš„è‡ªå®šä¹‰æ³¨è§£ï¼Œåœ¨ DDD åˆ†å±‚æ¶æ„ä¸­ï¼Œè¦æ”¾åˆ° Types å±‚ä¸­ï¼Œè¿™æ ·å…¶ä»–å±‚æ‰èƒ½å¼•å…¥ä½¿ç”¨ã€‚</li></ul><h3 id="_2-é™æµæ‹¦æˆª" tabindex="-1"><a class="header-anchor" href="#_2-é™æµæ‹¦æˆª" aria-hidden="true">#</a> 2. é™æµæ‹¦æˆª</h3><h4 id="_2-1-åˆ‡é¢å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#_2-1-åˆ‡é¢å®šä¹‰" aria-hidden="true">#</a> 2.1 åˆ‡é¢å®šä¹‰</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">AccessInterceptor</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/** ç”¨å“ªä¸ªå­—æ®µä½œä¸ºæ‹¦æˆªæ ‡è¯†ï¼Œæœªé…ç½®åˆ™é»˜è®¤èµ°å…¨éƒ¨ */</span>
    <span class="token class-name">String</span> <span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** é™åˆ¶é¢‘æ¬¡ï¼ˆæ¯ç§’è¯·æ±‚æ¬¡æ•°ï¼‰ */</span>
    <span class="token keyword">double</span> <span class="token function">permitsPerSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** é»‘åå•æ‹¦æˆªï¼ˆå¤šå°‘æ¬¡é™åˆ¶ååŠ å…¥é»‘åå•ï¼‰0 ä¸é™åˆ¶ */</span>
    <span class="token keyword">double</span> <span class="token function">blacklistCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** æ‹¦æˆªåçš„æ‰§è¡Œæ–¹æ³• */</span>
    <span class="token class-name">String</span> <span class="token function">fallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(cn.bugstack.xfg.dev.tech.annotation.AccessInterceptor)&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">aopPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è‡ªå®šä¹‰åˆ‡é¢æ³¨è§£ï¼Œæä¾›äº†æ‹¦æˆªçš„keyã€é™åˆ¶é¢‘æ¬¡ã€é»‘åå•å¤„ç†ã€æ‹¦æˆªåçš„å›è°ƒæ–¹æ³•ã€‚å†é€šè¿‡ @Pointcut åˆ‡å…¥é…ç½®äº†è‡ªå®šä¹‰æ³¨è§£çš„æ¥å£æ–¹æ³•</li></ul><h4 id="_2-2-åˆ‡é¢æ‹¦æˆª" tabindex="-1"><a class="header-anchor" href="#_2-2-åˆ‡é¢æ‹¦æˆª" aria-hidden="true">#</a> 2.2 åˆ‡é¢æ‹¦æˆª</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä¸ªäººé™é¢‘è®°å½•1åˆ†é’Ÿ</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">RateLimiter</span><span class="token punctuation">&gt;</span></span> loginRecord <span class="token operator">=</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ä¸ªäººé™é¢‘é»‘åå•24h - è‡ªèº«çš„åˆ†å¸ƒå¼ä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥è®°å½•åˆ° Redis ä¸­</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> blacklist <span class="token operator">=</span> <span class="token class-name">CacheBuilder</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;aopPoint() &amp;&amp; @annotation(accessInterceptor)&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doRouter</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> jp<span class="token punctuation">,</span> <span class="token class-name">AccessInterceptor</span> accessInterceptor<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> accessInterceptor<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;annotation RateLimiter uId is nullï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// è·å–æ‹¦æˆªå­—æ®µ</span>
    <span class="token class-name">String</span> keyAttr <span class="token operator">=</span> <span class="token function">getAttrValue</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> jp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;aop attr {}&quot;</span><span class="token punctuation">,</span> keyAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token comment">// é»‘åå•æ‹¦æˆª</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>keyAttr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> accessInterceptor<span class="token punctuation">.</span><span class="token function">blacklistCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">null</span> <span class="token operator">!=</span> blacklist<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span>keyAttr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> blacklist<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span>keyAttr<span class="token punctuation">)</span> <span class="token operator">&gt;</span> accessInterceptor<span class="token punctuation">.</span><span class="token function">blacklistCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;é™æµ-é»‘åå•æ‹¦æˆª(24h)ï¼š{}&quot;</span><span class="token punctuation">,</span> keyAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">fallbackMethodResult</span><span class="token punctuation">(</span>jp<span class="token punctuation">,</span> accessInterceptor<span class="token punctuation">.</span><span class="token function">fallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   
    <span class="token comment">// è·å–é™æµ -&gt; Guava ç¼“å­˜1åˆ†é’Ÿ</span>
    <span class="token class-name">RateLimiter</span> rateLimiter <span class="token operator">=</span> loginRecord<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span>keyAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> rateLimiter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rateLimiter <span class="token operator">=</span> <span class="token class-name">RateLimiter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>accessInterceptor<span class="token punctuation">.</span><span class="token function">permitsPerSecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginRecord<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>keyAttr<span class="token punctuation">,</span> rateLimiter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// é™æµæ‹¦æˆª</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rateLimiter<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>accessInterceptor<span class="token punctuation">.</span><span class="token function">blacklistCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> blacklist<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span>keyAttr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                blacklist<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>keyAttr<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                blacklist<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>keyAttr<span class="token punctuation">,</span> blacklist<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span>keyAttr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;é™æµ-è¶…é¢‘æ¬¡æ‹¦æˆªï¼š{}&quot;</span><span class="token punctuation">,</span> keyAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">fallbackMethodResult</span><span class="token punctuation">(</span>jp<span class="token punctuation">,</span> accessInterceptor<span class="token punctuation">.</span><span class="token function">fallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿”å›ç»“æœ</span>
    <span class="token keyword">return</span> jp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é€šè¿‡è‡ªå®šä¹‰æ³¨è§£ä¸­é…ç½®çš„æ‹¦æˆªå­—æ®µï¼Œè·å–å¯¹åº”çš„å€¼ã€‚è¿™é‡Œçš„å€¼ä½œä¸ºç”¨æˆ·çš„æ ‡è¯†ä½¿ç”¨ï¼Œåªå¯¹è¿™ä¸ªç”¨æˆ·è¿›è¡Œæ‹¦æˆªã€‚ã€ä¹Ÿå¯ä»¥æ˜¯ä¸€äº›åˆ—çš„ä¿¡æ¯ç¡®è®¤ï¼ŒåŒ…æ‹¬ç”¨æˆ·IPã€è®¾å¤‡ç­‰ã€‚ã€‘</li><li>è¿™æ®µä»£ç æµç¨‹ä¸­ä¼šæ ¹æ®è‡ªå®šä¹‰æ³¨è§£ä¸­çš„é…ç½®ï¼Œå¯¹è®¿é—®çš„ç”¨æˆ·è¿›è¡Œé™æµæ‹¦æˆªï¼Œå½“æ‹¦å‡»æ¬¡æ•°è¾¾åˆ°åŠ å…¥é»‘åå•çš„æ¬¡æ•°åï¼Œåˆ™ç›´æ¥å­˜èµ·æ¥ï¼ˆGuava/Redisï¼‰åœ¨24hå†…ç›´æ¥èµ°é»‘åå•ã€‚â€”â€” å®é™…çš„åœºæ™¯ä¸­è¿˜ä¼šæœ‰é£æ§çš„æ‰‹æ®µä»‹å…¥ï¼Œä»¥åŠäººå·¥æ¥æ“ä½œé»‘åå•ã€‚</li></ul><h4 id="_2-3-å›è°ƒå¤„ç†" tabindex="-1"><a class="header-anchor" href="#_2-3-å›è°ƒå¤„ç†" aria-hidden="true">#</a> 2.3 å›è°ƒå¤„ç†</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * è°ƒç”¨ç”¨æˆ·é…ç½®çš„å›è°ƒæ–¹æ³•ï¼Œå½“æ‹¦æˆªåï¼Œè¿”å›å›è°ƒç»“æœã€‚
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">fallbackMethodResult</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> jp<span class="token punctuation">,</span> <span class="token class-name">String</span> fallbackMethod<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Signature</span> sig <span class="token operator">=</span> jp<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodSignature</span> methodSignature <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodSignature</span><span class="token punctuation">)</span> sig<span class="token punctuation">;</span>
    <span class="token class-name">Method</span> method <span class="token operator">=</span> jp<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>fallbackMethod<span class="token punctuation">,</span> methodSignature<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>jp<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æœ€ç»ˆå¦‚æœåˆ¤å®šä¸ºæ‹¦æˆªï¼Œåˆ™ä¼šèµ°ç”¨æˆ·é…ç½®çš„å›è°ƒæ–¹æ³•ã€‚å¦‚ login é…ç½®ä¸€ä¸ª loginErrï¼Œå‡ºå…¥å‚éƒ½ä¸€æ ·ï¼Œåªæ˜¯åå­—ä¸ä¸€æ ·ã€‚è¿™æ ·æ‰æ–¹ä¾¿åå°„è°ƒç”¨ã€‚</li></ul><h2 id="å››ã€æµ‹è¯•éªŒè¯" tabindex="-1"><a class="header-anchor" href="#å››ã€æµ‹è¯•éªŒè¯" aria-hidden="true">#</a> å››ã€æµ‹è¯•éªŒè¯</h2><h3 id="_1-æ¥å£é…ç½®" tabindex="-1"><a class="header-anchor" href="#_1-æ¥å£é…ç½®" aria-hidden="true">#</a> 1. æ¥å£é…ç½®</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@AccessInterceptor</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;fingerprint&quot;</span><span class="token punctuation">,</span> fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;loginErr&quot;</span><span class="token punctuation">,</span> permitsPerSecond <span class="token operator">=</span> <span class="token number">1.0d</span><span class="token punctuation">,</span> blacklistCount <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;login&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> fingerprint<span class="token punctuation">,</span> <span class="token class-name">String</span> uId<span class="token punctuation">,</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;æ¨¡æ‹Ÿç™»å½• fingerprint:{}&quot;</span><span class="token punctuation">,</span> fingerprint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;æ¨¡æ‹Ÿç™»å½•ï¼šç™»å½•æˆåŠŸ &quot;</span> <span class="token operator">+</span> uId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginErr</span><span class="token punctuation">(</span><span class="token class-name">String</span> fingerprint<span class="token punctuation">,</span> <span class="token class-name">String</span> uId<span class="token punctuation">,</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;é¢‘æ¬¡é™åˆ¶ï¼Œè¯·å‹¿æ¶æ„è®¿é—®ï¼&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»™ä½ éœ€è¦æ‹¦æˆªçš„æ–¹æ³•ï¼Œæ·»åŠ ä¸Šè‡ªå®šä¹‰æ³¨è§£ã€‚</p><ul><li>key: ä»¥ç”¨æˆ·IDä½œä¸ºæ‹¦æˆªï¼Œè¿™ä¸ªç”¨æˆ·è®¿é—®æ¬¡æ•°é™åˆ¶</li><li>fallbackMethodï¼šå¤±è´¥åçš„å›è°ƒæ–¹æ³•ï¼Œæ–¹æ³•å‡ºå…¥å‚ä¿æŒä¸€æ ·</li><li>permitsPerSecondï¼šæ¯ç§’çš„è®¿é—®é¢‘æ¬¡é™åˆ¶ã€‚1ç§’1æ¬¡</li><li>blacklistCountï¼šè¶…è¿‡10æ¬¡éƒ½è¢«é™åˆ¶äº†ï¼Œè¿˜è®¿é—®çš„ï¼Œæ‰”åˆ°é»‘åå•é‡Œ24å°æ—¶</li></ul><h3 id="_2-æµ‹è¯•éªŒè¯" tabindex="-1"><a class="header-anchor" href="#_2-æµ‹è¯•éªŒè¯" aria-hidden="true">#</a> 2. æµ‹è¯•éªŒè¯</h3>`,31),f={href:"http://localhost:8091/api/ratelimiter/login?fingerprint=uljpplllll01009&uId=1000&token=8790",target:"_blank",rel:"noopener noreferrer"},y=p(`<div align="center"><img src="https://bugstack.cn/images/roadmap/tutorial/roadmap-ratelimiter-05.png?raw=true" width="700px"></div><div align="center"><img src="https://bugstack.cn/images/roadmap/tutorial/roadmap-ratelimiter-04.png?raw=true" width="700px"></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">22</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">47.518</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">8091</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name">RateLimiterAOP</span> <span class="token operator">-</span> é™æµ<span class="token operator">-</span>è¶…é¢‘æ¬¡æ‹¦æˆªï¼šuljpplllll01009
<span class="token number">22</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">47.669</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">8091</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name">RateLimiterAOP</span> <span class="token operator">-</span> aop attr uljpplllll01009
<span class="token number">22</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">49.121</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">8091</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name">RateLimiterAOP</span> <span class="token operator">-</span> aop attr uljpplllll01009
<span class="token number">22</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">49.122</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">8091</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name">RateLimiterAOP</span> <span class="token operator">-</span> é™æµ<span class="token operator">-</span>é»‘åå•æ‹¦æˆª<span class="token punctuation">(</span><span class="token number">24</span>h<span class="token punctuation">)</span>ï¼šuljpplllll01009
<span class="token number">22</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">57.647</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">8091</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name">RateLimiterAOP</span> <span class="token operator">-</span> aop attr uljpplllll01009
<span class="token number">22</span><span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">57.650</span> <span class="token punctuation">[</span>http<span class="token operator">-</span>nio<span class="token operator">-</span><span class="token number">8091</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name">RateLimiterAOP</span> <span class="token operator">-</span> é™æµ<span class="token operator">-</span>é»‘åå•æ‹¦æˆª<span class="token punctuation">(</span><span class="token number">24</span>h<span class="token punctuation">)</span>ï¼šuljpplllll01009
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å¥½å•¦ï¼Œåˆ°è¿™ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·çš„è®¿é—®å·²ç»è¢«æ‹¦æˆªäº†ã€‚</li><li>èµ¶ç´§åˆ°è‡ªå·±çš„åº”ç”¨åŠ ä¸€ä¸‹å§ï¼Œä¸€ä¸ªæŒ‡çº¹IDï¼Œä¸€ä¸ªç”¨æˆ·ç»´æŠ¤é™æµè®¿é—®ã€‚è®©è‡ªå·±çš„åº”ç”¨æ›´åŠ å¯é ï¼</li></ul><hr>`,5),w={href:"https://gaga.plus",target:"_blank",rel:"noopener noreferrer"};function _(I,x){const a=o("ExternalLinkIcon");return c(),l("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),r,s("åšå®¢ï¼š"),n("a",k,[s("https://bugstack.cn"),t(a)])]),d,m,v,b,n("ul",null,[n("li",null,[s("xfg-dev-tech-ratelimiterï¼š"),n("a",h,[s("https://gitcode.net/KnowledgePlanet/road-map/xfg-dev-tech-ratelimiter"),t(a)])])]),g,n("p",null,[s("è®¿é—®ï¼š"),n("a",f,[s("http://localhost:8091/api/ratelimiter/login?fingerprint=uljpplllll01009&uId=1000&token=8790"),t(a)])]),y,n("blockquote",null,[n("p",null,[s("è¿™äº›å„é¡¹å®é™…åœºæ™¯çš„å†…å®¹ï¼Œåœ¨å°å‚…å“¥çš„ã€æ˜Ÿçƒï¼šç å†œä¼šé”ã€‘æœ‰7ä¸ªå®Œç»“çš„é¡¹ç›®å’Œ1ä¸ªè¿›è¡Œçš„é¡¹ç›®ï¼Œéƒ½æœ‰å¤§é‡çš„å®è·µè¿ç”¨ã€‚å¯ä»¥æ‰«ç åŠ å…¥ï¼Œé¡¹ç›®ä½“éªŒåœ°å€ï¼›"),n("a",w,[s("https://gaga.plus"),t(a)])])])])}const q=e(i,[["render",_],["__file","ratelimiter.html.vue"]]);export{q as default};
