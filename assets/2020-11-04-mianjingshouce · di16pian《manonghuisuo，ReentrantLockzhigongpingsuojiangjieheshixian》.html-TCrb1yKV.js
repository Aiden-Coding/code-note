import{_ as p,r as o,o as c,c as l,a as s,b as n,d as e,e as t}from"./app-3RcBQnkC.js";const i={},u=s("h1",{id:"é¢ç»æ‰‹å†Œ-Â·-ç¬¬16ç¯‡ã€Šç å†œä¼šé”-reentrantlockä¹‹å…¬å¹³é”è®²è§£å’Œå®ç°ã€‹",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#é¢ç»æ‰‹å†Œ-Â·-ç¬¬16ç¯‡ã€Šç å†œä¼šé”-reentrantlockä¹‹å…¬å¹³é”è®²è§£å’Œå®ç°ã€‹","aria-hidden":"true"},"#"),n(" é¢ç»æ‰‹å†Œ Â· ç¬¬16ç¯‡ã€Šç å†œä¼šé”ï¼ŒReentrantLockä¹‹å…¬å¹³é”è®²è§£å’Œå®ç°ã€‹")],-1),k=s("br",null,null,-1),r={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=t('<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>Javaå­¦å¤šå°‘æ‰èƒ½æ‰¾åˆ°å·¥ä½œï¼Ÿ</code></p><p>æœ€è¿‘ç»å¸¸æœ‰å°ä¼™ä¼´é—®æˆ‘ï¼Œä»¥ä¸ºæˆ‘çš„ç»éªŒæ¥çœ‹ï¼Œå­¦å¤šå°‘å¤Ÿï¼Œå¥½åƒæ›´å¤šçš„æ˜¯çœ‹ä½ çš„é‡å¿ƒæœ‰å¤šå¤§ã€‚å¦‚æœä½ åªæ˜¯æƒ³æ‰¾ä¸ª10kä»¥å†…çš„äºŒçº¿åŸå¸‚çš„å·¥ä½œï¼Œé‚£è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“çš„ã€‚ä¹Ÿä¸éœ€è¦å­¦æ•°æ®ç»“æ„ã€ä¹Ÿä¸éœ€è¦ä¼šç®—æ³•ã€ä¹Ÿéœ€è¦æ‡‚æºç ã€æ›´ä¸è¦æœ‰å¤šå°‘é¡¹ç›®ç»éªŒã€‚</p><p>ä½†åä¹‹æˆ‘é‡åˆ°ä¸€ä¸ªå›½å†…å¤§å­¦TOP2æ¯•ä¸šçš„å¨ƒï¼Œè¿™è´§å°±æ˜¯Offeræ”¶å‰²æœºï¼šè…¾è®¯ã€é˜¿é‡Œã€å­—èŠ‚è¿˜æœ‰å›½å¤–æ–°åŠ å¡çš„å·¥ä½œæœºä¼šç­‰ç­‰ï¼Œè–ªèµ„å¾…é‡ä¹Ÿæ˜¯è´¼é«˜ï¼Œå¯èƒ½è¶…è¿‡ä½ å¯¹ç™½èœä»·çš„è®¤çŸ¥ã€‚<em>ä¸Šå­¦æ— ç”¨ã€å­¦ä¹ æ— ç”¨ï¼Œçº¯å±æ‰¯æ·¡ï¼</em></p><p>ä½ èƒ½åœ¨è¿™æ¡è·¯ä¸Šèƒ½ä»˜å‡ºçš„è¶Šå¤šï¼Œèƒ½åŠªåŠ›çš„è¶Šæ—©ï¼Œæ”¶è·å°±ä¼šè¶Šå¤§ï¼</p><h2 id="äºŒã€é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#äºŒã€é¢è¯•é¢˜" aria-hidden="true">#</a> äºŒã€é¢è¯•é¢˜</h2><p><code>è°¢é£æœºï¼Œå°è®°</code>ï¼Œåˆšå»å†¬å·´æ‹‰æ³¡å®Œè„šæ”¾æ¾çš„é£æœºï¼Œå› ä¸ºè€å…‹è¢œå­ä¸¢äº†ï¼Œéª‚éª‚å’§å’§çš„èµ´çº¦é¢è¯•å®˜ã€‚</p><p><strong>é¢è¯•å®˜</strong>ï¼šå’‹äº†ï¼Œé£æœºï¼Œæ€ä¹ˆçœ‹ä¸Šå»ä¸é«˜å…´ã€‚</p><p><strong>è°¢é£æœº</strong>ï¼šæ²¡äº‹ï¼Œæ²¡äº‹ï¼Œæˆ‘å¿ƒæ€æˆ‘å­¦çš„ synchronized å‘¢ï¼</p><p><strong>é¢è¯•å®˜</strong>ï¼šé‚£æ­£å¥½ï¼Œé£æœºä½ ä¼šé”å—ï¼Ÿ</p><p><strong>è°¢é£æœº</strong>ï¼šå•Šã€‚ã€‚ã€‚æˆ‘æ²¡å»ä¼šæ‰€å‘€ï¼ï¼ï¼<em>ä½ å’‹çŸ¥é“</em></p><p><strong>é¢è¯•å®˜</strong>ï¼šæˆ‘è¯´ Java é”ï¼Œä½ æƒ³å•¥å‘¢ï¼ä½ äº†è§£å…¬å¹³é”å—ï¼ŒçŸ¥é“æ€ä¹ˆå®ç°çš„å—ï¼Œç»™æˆ‘è¯´è¯´ï¼</p><p><strong>è°¢é£æœº</strong>ï¼šå…¬å¹³é”ï¼ï¼Ÿå—¯ï¼Œæ˜¯ä¸ ReentrantLock ä¸­ç”¨åˆ°äº†ï¼Œæˆ‘æ€ä¹ˆæ„Ÿè§‰ä¼¼ä¹æœ‰å°è±¡ï¼Œä½†æ˜¯ä¸è®°å¾—äº†ã€‚</p><p><strong>é¢è¯•å®˜</strong>ï¼šå“ï¼Œå›å®¶æœæœ CLH å§ï¼</p><h2 id="ä¸‰ã€reentrantlock-å’Œ-å…¬å¹³é”" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€reentrantlock-å’Œ-å…¬å¹³é”" aria-hidden="true">#</a> ä¸‰ã€ReentrantLock å’Œ å…¬å¹³é”</h2><h3 id="_1-reentrantlock-ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#_1-reentrantlock-ä»‹ç»" aria-hidden="true">#</a> 1. ReentrantLock ä»‹ç»</h3>',17),v={href:"https://bugstack.cn/interview/2020/10/28/%E9%9D%A2%E7%BB%8F%E6%89%8B%E5%86%8C-%E7%AC%AC15%E7%AF%87-%E7%A0%81%E5%86%9C%E4%BC%9A%E9%94%81-synchronized-%E8%A7%A3%E6%AF%92-%E5%89%96%E6%9E%90%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90.html",target:"_blank",rel:"noopener noreferrer"},m=t(`<p><strong>ä»‹ç»</strong>ï¼šReentrantLock æ˜¯ä¸€ä¸ªå¯é‡å…¥ä¸”ç‹¬å å¼é”ï¼Œå…·æœ‰ä¸ synchronized ç›‘è§†å™¨(monitor enterã€monitor exit)é”åŸºæœ¬ç›¸åŒçš„è¡Œä¸ºå’Œè¯­æ„ã€‚ä½†ä¸ synchronized ç›¸æ¯”ï¼Œå®ƒæ›´åŠ çµæ´»ã€å¼ºå¤§ã€å¢åŠ äº†è½®è¯¢ã€è¶…æ—¶ã€ä¸­æ–­ç­‰é«˜çº§åŠŸèƒ½ä»¥åŠå¯ä»¥åˆ›å»ºå…¬å¹³å’Œéå…¬å¹³é”ã€‚</p><h3 id="_2-reentrantlock-çŸ¥è¯†é“¾æ¡" tabindex="-1"><a class="header-anchor" href="#_2-reentrantlock-çŸ¥è¯†é“¾æ¡" aria-hidden="true">#</a> 2. ReentrantLock çŸ¥è¯†é“¾æ¡</h3><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-16-01.png" alt="å›¾ 16-1 ReentrantLock é”çŸ¥è¯†é“¾æ¡"></p><p>ReentrantLock æ˜¯åŸºäº Lock å®ç°çš„å¯é‡å…¥é”ï¼Œæ‰€æœ‰çš„ Lock éƒ½æ˜¯åŸºäº AQS å®ç°çš„ï¼ŒAQS å’Œ Condition å„è‡ªç»´æŠ¤ä¸åŒçš„å¯¹è±¡ï¼Œåœ¨ä½¿ç”¨ Lock å’Œ Condition æ—¶ï¼Œå…¶å®å°±æ˜¯ä¸¤ä¸ªé˜Ÿåˆ—çš„äº’ç›¸ç§»åŠ¨ã€‚å®ƒæ‰€æä¾›çš„å…±äº«é”ã€äº’æ–¥é”éƒ½æ˜¯åŸºäºå¯¹ state çš„æ“ä½œã€‚è€Œå®ƒçš„å¯é‡å…¥æ˜¯å› ä¸ºå®ç°äº†åŒæ­¥å™¨ Syncï¼Œåœ¨ Sync çš„ä¸¤ä¸ªå®ç°ç±»ä¸­ï¼ŒåŒ…æ‹¬äº†å…¬å¹³é”å’Œéå…¬å¹³é”ã€‚</p><p>è¿™ä¸ªå…¬å¹³é”çš„å…·ä½“å®ç°ï¼Œå°±æ˜¯æˆ‘ä»¬æœ¬ç« èŠ‚è¦ä»‹ç»çš„é‡ç‚¹ï¼Œäº†è§£ä»€ä¹ˆæ˜¯å…¬å¹³é”ã€å…¬å¹³é”çš„å…·ä½“å®ç°ã€‚<em>å­¦ä¹ å®ŒåŸºç¡€çš„çŸ¥è¯†å¯ä»¥æ›´å¥½çš„ç†è§£ ReentrantLock</em></p><h3 id="_3-reentrantlock-å…¬å¹³é”ä»£ç " tabindex="-1"><a class="header-anchor" href="#_3-reentrantlock-å…¬å¹³é”ä»£ç " aria-hidden="true">#</a> 3. ReentrantLock å…¬å¹³é”ä»£ç </h3><h4 id="_3-1-åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#_3-1-åˆå§‹åŒ–" aria-hidden="true">#</a> 3.1 åˆå§‹åŒ–</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// trueï¼šå…¬å¹³é”</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// todo</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åˆå§‹åŒ–æ„é€ å‡½æ•°å…¥å‚ï¼Œé€‰æ‹©æ˜¯å¦ä¸ºåˆå§‹åŒ–å…¬å¹³é”ã€‚</li><li>å…¶å®ä¸€èˆ¬æƒ…å†µä¸‹å¹¶ä¸éœ€è¦å…¬å¹³é”ï¼Œé™¤éä½ çš„åœºæ™¯ä¸­éœ€è¦ä¿è¯é¡ºåºæ€§ã€‚</li><li>ä½¿ç”¨ ReentrantLock åˆ‡è®°éœ€è¦åœ¨ finally ä¸­å…³é—­ï¼Œ<code>lock.unlock()</code>ã€‚</li></ul><h4 id="_3-2-å…¬å¹³é”ã€éå…¬å¹³é”-é€‰æ‹©" tabindex="-1"><a class="header-anchor" href="#_3-2-å…¬å¹³é”ã€éå…¬å¹³é”-é€‰æ‹©" aria-hidden="true">#</a> 3.2 å…¬å¹³é”ã€éå…¬å¹³é”ï¼Œé€‰æ‹©</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ„é€ å‡½æ•°ä¸­é€‰æ‹©å…¬å¹³é”ï¼ˆFairSyncï¼‰ã€éå…¬å¹³é”ï¼ˆNonfairSyncï¼‰ã€‚</li></ul><h4 id="_3-3-hasqueuedpredecessors" tabindex="-1"><a class="header-anchor" href="#_3-3-hasqueuedpredecessors" aria-hidden="true">#</a> 3.3 hasQueuedPredecessors</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œä¸»è¦æ˜¯åœ¨æ–¹æ³• <code>tryAcquire</code> ä¸­ï¼Œæ˜¯å¦æœ‰ <code>!hasQueuedPredecessors()</code> åˆ¤æ–­ã€‚</li></ul><h4 id="_3-4-é˜Ÿåˆ—é¦–ä½åˆ¤æ–­" tabindex="-1"><a class="header-anchor" href="#_3-4-é˜Ÿåˆ—é¦–ä½åˆ¤æ–­" aria-hidden="true">#</a> 3.4 é˜Ÿåˆ—é¦–ä½åˆ¤æ–­</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span> <span class="token comment">// Read fields in reverse initialization order</span>
    <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token class-name">Node</span> s<span class="token punctuation">;</span>
    <span class="token keyword">return</span> h <span class="token operator">!=</span> t <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> h<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨è¿™ä¸ªåˆ¤æ–­ä¸­ä¸»è¦å°±æ˜¯çœ‹å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯åŒæ­¥é˜Ÿåˆ—çš„é¦–ä½ï¼Œæ˜¯ï¼štrueã€å¦ï¼šfalse</li><li>è¿™éƒ¨åˆ†å°±æ¶‰åŠåˆ°äº†å…¬å¹³é”çš„å®ç°ï¼ŒCLHï¼ˆCraigï¼ŒLandin andHagerstenï¼‰ã€‚<em>ä¸‰ä¸ªä½œè€…çš„é¦–å­—æ¯ç»„åˆ</em></li></ul><h2 id="å››ã€ä»€ä¹ˆæ˜¯å…¬å¹³é”" tabindex="-1"><a class="header-anchor" href="#å››ã€ä»€ä¹ˆæ˜¯å…¬å¹³é”" aria-hidden="true">#</a> å››ã€ä»€ä¹ˆæ˜¯å…¬å¹³é”</h2><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-16-02.png" alt="å›¾ 16-2 å…¬å…±å•æ‰€æ’é˜Ÿå…¥å‘"></p><p>å…¬å¹³é”å°±åƒæ˜¯é©¬è·¯è¾¹ä¸Šçš„å«ç”Ÿé—´ï¼Œä¸Šå•æ‰€éœ€è¦æ’é˜Ÿã€‚å½“ç„¶å¦‚æœæœ‰äººä¸æ’é˜Ÿï¼Œé‚£ä¹ˆå°±æ˜¯éå…¬å¹³é”äº†ï¼Œæ¯”å¦‚é¢†å¯¼è¦å…ˆä¸Šã€‚</p><p>CLH æ˜¯ä¸€ç§åŸºäºå•å‘é“¾è¡¨çš„é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ã€‚AQSä¸­çš„é˜Ÿåˆ—æ˜¯CLHå˜ä½“çš„è™šæ‹ŸåŒå‘é˜Ÿåˆ—ï¼ˆFIFOï¼‰ï¼ŒAQSæ˜¯é€šè¿‡å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ªèŠ‚ç‚¹æ¥å®ç°é”çš„åˆ†é…ã€‚</p><p>ä¸ºäº†æ›´å¥½çš„å­¦ä¹ ç†è§£ CLH çš„åŸç†ï¼Œå°±éœ€è¦æœ‰å®è·µçš„ä»£ç ã€‚æ¥ä¸‹æ¥ä¸€ CLH ä¸ºæ ¸å¿ƒåˆ†åˆ«ä»‹ç»4ç§å…¬å¹³é”çš„å®ç°ï¼Œä»è€ŒæŒæ¡æœ€åŸºæœ¬çš„æŠ€æœ¯æ ˆçŸ¥è¯†ã€‚</p><h2 id="äº”ã€å…¬å¹³é”å®ç°" tabindex="-1"><a class="header-anchor" href="#äº”ã€å…¬å¹³é”å®ç°" aria-hidden="true">#</a> äº”ã€å…¬å¹³é”å®ç°</h2><h3 id="_1-clh" tabindex="-1"><a class="header-anchor" href="#_1-clh" aria-hidden="true">#</a> 1. CLH</h3><h4 id="_1-1-çœ‹å›¾è¯´è¯" tabindex="-1"><a class="header-anchor" href="#_1-1-çœ‹å›¾è¯´è¯" aria-hidden="true">#</a> 1.1 çœ‹å›¾è¯´è¯</h4><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-16-03.png" alt="å›¾ 16-3 CLH å®ç°è¿‡ç¨‹åŸç†å›¾"></p><h4 id="_1-2-ä»£ç å®ç°" tabindex="-1"><a class="header-anchor" href="#_1-2-ä»£ç å®ç°" aria-hidden="true">#</a> 1.2 ä»£ç å®ç°</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CLHLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CLHLock<span class="token punctuation">.</span>Node</span><span class="token punctuation">&gt;</span></span> prev<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CLHLock<span class="token punctuation">.</span>Node</span><span class="token punctuation">&gt;</span></span> node<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CLHLock<span class="token punctuation">.</span>Node</span><span class="token punctuation">&gt;</span></span> tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CLHLock<span class="token punctuation">.</span>Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> locked<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">CLHLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token class-name">CLHLock<span class="token punctuation">.</span>Node</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token punctuation">.</span>locked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">Node</span> pred_node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tail<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>prev<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>pred_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è‡ªæ—‹</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>pred_node<span class="token punctuation">.</span>locked<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token punctuation">.</span>locked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>prev<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-ä»£ç è®²è§£" tabindex="-1"><a class="header-anchor" href="#_1-3-ä»£ç è®²è§£" aria-hidden="true">#</a> 1.3 ä»£ç è®²è§£</h4><p>CLHï¼ˆCraigï¼ŒLandin and Hagerstenï¼‰ï¼Œæ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ã€‚</p><p>åœ¨è¿™æ®µä»£ç çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œç›¸å½“äºæ˜¯è™šæ‹Ÿå‡ºæ¥ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œç”± AtomicReference çš„æ–¹æ³• getAndSet è¿›è¡Œè¡”æ¥ã€‚<em>getAndSet è·å–å½“å‰å…ƒç´ ï¼Œè®¾ç½®æ–°çš„å…ƒç´ </em></p><p><strong>lock()</strong></p><ul><li>é€šè¿‡ <code>this.node.get()</code> è·å–å½“å‰èŠ‚ç‚¹ï¼Œå¹¶è®¾ç½® locked ä¸º trueã€‚</li><li>æ¥ç€è°ƒç”¨ <code>this.tail.getAndSet(node)</code>ï¼Œè·å–å½“å‰å°¾éƒ¨èŠ‚ç‚¹ pred_nodeï¼ŒåŒæ—¶æŠŠæ–°åŠ å…¥çš„èŠ‚ç‚¹è®¾ç½®æˆå°¾éƒ¨èŠ‚ç‚¹ã€‚</li><li>ä¹‹åå°±æ˜¯æŠŠ this.prev è®¾ç½®ä¸ºä¹‹å‰çš„å°¾éƒ¨èŠ‚ç‚¹ï¼Œä¹Ÿå°±ç›¸å½“äºé“¾è·¯çš„æŒ‡å‘ã€‚</li><li>æœ€åå°±æ˜¯è‡ªæ—‹ <code>while (pred_node.locked)</code>ï¼Œç›´è‡³ç¨‹åºé‡Šæ”¾ã€‚</li></ul><p><strong>unlock()</strong></p><ul><li>é‡Šæ”¾é”çš„è¿‡ç¨‹å°±æ˜¯æ‹†é“¾ï¼ŒæŠŠé‡Šæ”¾é”çš„èŠ‚ç‚¹è®¾ç½®ä¸ºfalse <code>node.locked = false</code>ã€‚</li><li>ä¹‹åæœ€é‡è¦çš„æ˜¯æŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ ·å°±ç›¸å½“äºæŠŠè‡ªå·±çš„èŠ‚ç‚¹æ‹†ä¸‹æ¥äº†ï¼Œç­‰ç€åƒåœ¾å›æ”¶ã€‚</li></ul><p><code>CLH</code>é˜Ÿåˆ—é”çš„ä¼˜ç‚¹æ˜¯ç©ºé—´å¤æ‚åº¦ä½ï¼Œåœ¨SMPï¼ˆSymmetric Multi-Processorï¼‰å¯¹ç§°å¤šå¤„ç†å™¨ç»“æ„ï¼ˆä¸€å°è®¡ç®—æœºç”±å¤šä¸ªCPUç»„æˆï¼Œå¹¶å…±äº«å†…å­˜å’Œå…¶ä»–èµ„æºï¼Œæ‰€æœ‰çš„CPUéƒ½å¯ä»¥å¹³ç­‰åœ°è®¿é—®å†…å­˜ã€I/Oå’Œå¤–éƒ¨ä¸­æ–­ï¼‰æ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚ä½†åœ¨ NUMA(Non-Uniform Memory Access) ä¸‹æ•ˆæœå°±ä¸å¤ªå¥½äº†ï¼Œè¿™éƒ¨åˆ†çŸ¥è¯†å¯ä»¥è‡ªè¡Œæ‰©å±•ã€‚</p><h3 id="_2-mcslock" tabindex="-1"><a class="header-anchor" href="#_2-mcslock" aria-hidden="true">#</a> 2. MCSLock</h3><h4 id="_2-1-ä»£ç å®ç°" tabindex="-1"><a class="header-anchor" href="#_2-1-ä»£ç å®ç°" aria-hidden="true">#</a> 2.1 ä»£ç å®ç°</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MCSLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MCSLock<span class="token punctuation">.</span>Node</span><span class="token punctuation">&gt;</span></span> tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MCSLock<span class="token punctuation">.</span>Node</span><span class="token punctuation">&gt;</span></span> node<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> locked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span> next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">MCSLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Node</span> preNode <span class="token operator">=</span> tail<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> preNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>locked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        node<span class="token punctuation">.</span>locked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        preNode<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token punctuation">.</span>locked<span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>next<span class="token punctuation">.</span>locked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            node<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tail<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-1-ä»£ç è®²è§£" tabindex="-1"><a class="header-anchor" href="#_2-1-ä»£ç è®²è§£" aria-hidden="true">#</a> 2.1 ä»£ç è®²è§£</h4><p>MCS æ¥è‡ªäºå‘æ˜äººåå­—çš„é¦–å­—æ¯ï¼š John Mellor-Crummeyå’ŒMichael Scottã€‚</p><p>å®ƒä¹Ÿæ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ï¼Œä½†ä¸ CLH ä¸åŒã€‚å®ƒæ˜¯çœŸçš„æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ nextï¼Œæ·»åŠ è¿™ä¸ªçœŸå®èŠ‚ç‚¹åï¼Œå®ƒå°±å¯ä»¥åªåœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œè€Œ CLH æ˜¯å‰é©±èŠ‚ç‚¹çš„å±æ€§ä¸Šè‡ªæ—‹ã€‚</p><p>å› ä¸ºè‡ªæ—‹èŠ‚ç‚¹çš„ä¸åŒï¼Œå¯¼è‡´ CLH æ›´é€‚åˆäº SMP æ¶æ„ã€MCS å¯ä»¥é€‚åˆ NUMA éä¸€è‡´å­˜å‚¨è®¿é—®æ¶æ„ã€‚ä½ å¯ä»¥æƒ³è±¡æˆ CLH æ›´éœ€è¦çº¿ç¨‹æ•°æ®åœ¨åŒä¸€å—å†…å­˜ä¸Šæ•ˆæœæ‰æ›´å¥½ï¼ŒMCS å› ä¸ºæ˜¯åœ¨æœ¬åº—å˜é‡è‡ªé€‰ï¼Œæ‰€ä»¥æ— è®ºæ•°æ®æ˜¯å¦åˆ†æ•£åœ¨ä¸åŒçš„CPUæ¨¡å—éƒ½æ²¡æœ‰å½±å“ã€‚</p><p>ä»£ç å®ç°ä¸Šä¸ CLH æ²¡æœ‰å¤ªå¤šå·®å¼‚ï¼Œè¿™é‡Œå°±ä¸åœ¨å™è¿°äº†ï¼Œå¯ä»¥çœ‹ä»£ç å­¦ä¹ ã€‚</p><h3 id="_3-ticketlock" tabindex="-1"><a class="header-anchor" href="#_3-ticketlock" aria-hidden="true">#</a> 3. TicketLock</h3><h4 id="_3-1-çœ‹å›¾è¯´è¯" tabindex="-1"><a class="header-anchor" href="#_3-1-çœ‹å›¾è¯´è¯" aria-hidden="true">#</a> 3.1 çœ‹å›¾è¯´è¯</h4><p><img src="https://bugstack.cn/assets/images/2020/interview/interview-16-04.png" alt="å›¾ 16-4 é“¶è¡Œæ’é˜Ÿå«å·å›¾"></p><h4 id="_3-2-ä»£ç å®ç°" tabindex="-1"><a class="header-anchor" href="#_3-2-ä»£ç å®ç°" aria-hidden="true">#</a> 3.2 ä»£ç å®ç°</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TicketLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> serviceCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> ticketCount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> owner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        owner<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ticketCount<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>serviceCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> owner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        serviceCount<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>owner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> owner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        owner<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-ä»£ç è®²è§£" tabindex="-1"><a class="header-anchor" href="#_3-3-ä»£ç è®²è§£" aria-hidden="true">#</a> 3.3 ä»£ç è®²è§£</h4><p>TicketLock å°±åƒä½ å»é“¶è¡Œã€å‘·å“ºç»™ä½ çš„ä¸€ä¸ªæ’å·å¡ä¸€æ ·ï¼Œå«åˆ°ä½ å·ä½ æ‰èƒ½è¿›å»ã€‚å±äºä¸¥æ ¼çš„å…¬å¹³æ€§å®ç°ï¼Œä½†æ˜¯å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šï¼Œæ¯ä¸ªè¿›ç¨‹/çº¿ç¨‹å ç”¨çš„å¤„ç†å™¨éƒ½åœ¨è¯»å†™åŒä¸€ä¸ªå˜é‡ï¼Œæ¯æ¬¡è¯»å†™æ“ä½œéƒ½éœ€è¦è¿›è¡Œå¤šå¤„ç†é—´çš„ç¼“å­˜åŒæ­¥ï¼Œéå¸¸æ¶ˆè€—ç³»ç»Ÿæ€§èƒ½ã€‚</p><p>ä»£ç å®ç°ä¸Šä¹Ÿæ¯”è¾ƒç®€å•ï¼Œlock() ä¸­è®¾ç½®æ‹¥æœ‰è€…çš„å·ç‰Œï¼Œå¹¶è¿›å…¥è‡ªæ—‹æ¯”å¯¹ã€‚unlock() ä¸­ä½¿ç”¨ CAS è¿›è¡Œè§£é”æ“ä½œï¼Œå¹¶å¤„ç†ç§»é™¤ã€‚</p><h2 id="å…­ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å…­ã€æ€»ç»“" aria-hidden="true">#</a> å…­ã€æ€»ç»“</h2><ul><li>ReentrantLock æ˜¯åŸºäº Lock å®ç°çš„å¯é‡å…¥é”ï¼Œå¯¹äºå…¬å¹³é” CLH çš„å®ç°ï¼Œåªæ˜¯è¿™éƒ¨åˆ†çŸ¥è¯†çš„å†°å±±ä¸€è§’ï¼Œä½†æœ‰è¿™ä¸€<strong>è„š</strong>ï¼Œå°±å¯ä»¥å¾ˆå¥½çƒ­èº«ä¾¿äºåç»­çš„å­¦ä¹ ã€‚</li><li>ReentrantLock ä½¿ç”¨èµ·æ¥æ›´åŠ çµæ´»ï¼Œå¯æ“ä½œæ€§ä¹Ÿæ›´å¤§ï¼Œä½†ä¸€å®šè¦åœ¨ finally ä¸­é‡Šæ”¾é”ï¼Œç›®çš„æ˜¯ä¿è¯åœ¨è·å–é”ä¹‹åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¢«é‡Šæ”¾ã€‚åŒæ—¶ä¸è¦å°†è·å–é”çš„è¿‡ç¨‹å†™åœ¨ try é‡Œé¢ã€‚</li><li>å…¬å¹³é”çš„å®ç°ä¾æ®ä¸åŒåœºæ™¯å’ŒSMPã€NUMAçš„ä½¿ç”¨ï¼Œä¼šæœ‰ä¸åŒçš„ä¼˜åŠ£æ•ˆæœã€‚åœ¨å®é™…çš„ä½¿ç”¨ä¸­ä¸€èˆ¬é»˜è®¤ä¼šé€‰æ‹©éå…¬å¹³é”ï¼Œå³ä½¿æ˜¯è‡ªæ—‹ä¹Ÿæ˜¯è€—è´¹æ€§èƒ½çš„ï¼Œä¸€èˆ¬ä¼šç”¨åœ¨è¾ƒå°‘ç­‰å¾…çš„çº¿ç¨‹ä¸­ï¼Œé¿å…è‡ªæ—‹æ—¶è¿‡é•¿ã€‚</li></ul>`,55);function h(b,w){const a=o("ExternalLinkIcon");return c(),l("div",null,[u,s("p",null,[n("ä½œè€…ï¼šå°å‚…å“¥ "),k,n("åšå®¢ï¼š"),s("a",r,[n("https://bugstack.cn"),e(a)])]),d,s("p",null,[n("é‰´äºä¸Šä¸€ç¯‡å°å‚…å“¥å·²ç»åŸºäºï¼ŒHotSpotè™šæ‹Ÿæœºæºç åˆ†æ "),s("a",v,[n("synchronized"),e(a)]),n(" å®ç°å’Œç›¸åº”æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼Œæœ¬æ¥æƒ³åœ¨æœ¬ç« ç›´æ¥ä»‹ç»ä¸‹ ReentrantLockã€‚ä½†å› ä¸º ReentrantLock çŸ¥è¯†ç‚¹è¾ƒå¤šï¼Œå› æ­¤ä¼šåˆ†å‡ ç¯‡åˆ†åˆ«è®²è§£ï¼Œçªå‡ºæ¯ä¸€ç¯‡é‡ç‚¹ï¼Œé¿å…çŒªå…«æˆ’åæ£ã€‚")]),m])}const g=p(i,[["render",h],["__file","2020-11-04-mianjingshouce Â· di16pianã€Šmanonghuisuoï¼ŒReentrantLockzhigongpingsuojiangjieheshixianã€‹.html.vue"]]);export{g as default};
