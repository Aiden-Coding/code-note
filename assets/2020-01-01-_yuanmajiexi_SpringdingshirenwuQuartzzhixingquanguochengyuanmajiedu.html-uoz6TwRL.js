import{_ as p,r as e,o,c,a as n,b as s,d as t,e as l}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"æºç åˆ†æ-springå®šæ—¶ä»»åŠ¡quartzæ‰§è¡Œå…¨è¿‡ç¨‹æºç è§£è¯»",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#æºç åˆ†æ-springå®šæ—¶ä»»åŠ¡quartzæ‰§è¡Œå…¨è¿‡ç¨‹æºç è§£è¯»","aria-hidden":"true"},"#"),s(" æºç åˆ†æ | Springå®šæ—¶ä»»åŠ¡Quartzæ‰§è¡Œå…¨è¿‡ç¨‹æºç è§£è¯»")],-1),r=n("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=l(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€ä»‹ç»" aria-hidden="true">#</a> ä¸€ã€å‰è¨€ä»‹ç»</h2><p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ä¼šç”¨åˆ°å®šæ—¶ä»»åŠ¡ï¼Œç”¨æ¥ï¼›åº“è¡¨æ‰«æå‘é€MQã€T+nè´¦å•ç»“ç®—ã€ç¼“å­˜æ•°æ®æ›´æ–°ã€ç§’æ€æ´»åŠ¨çŠ¶æ€å˜æ›´ï¼Œç­‰ç­‰ã€‚å› ä¸ºæœ‰äº†Springçš„Scheduleæå¤§çš„æ–¹ä¾¿äº†æˆ‘ä»¬å¯¹è¿™ç±»åœºæ™¯çš„ä½¿ç”¨ã€‚é‚£ä¹ˆï¼Œé™¤äº†åº”ç”¨ä½ è¿˜äº†è§£å®ƒå¤šå°‘å‘¢ï¼›</p><ol><li>é»˜è®¤åˆå§‹åŒ–å¤šå°‘ä¸ªä»»åŠ¡çº¿ç¨‹</li><li>JobStoreæœ‰å‡ ç§å®ç°ï¼Œä½ å¹³æ—¶ç”¨çš„éƒ½æ˜¯å“ªä¸ª</li><li>ä¸€ä¸ªå®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæµç¨‹ç®€è¿°ä¸‹</li></ol><p>è’™åœˆäº†å§ï¼Œæ˜¯ä¸æ„Ÿè§‰å¹³æ—¶åªæ˜¯ä½¿ç”¨äº†ï¼Œæ ¹æœ¬æ²¡å…³æ³¨è¿‡è¿™äº›ã€‚æœ‰ç§å†²åŠ¨èµ¶ç´§æœç´¢ç­”æ¡ˆå§ï¼ä½†åªæ˜¯çŸ¥é“ç­”æ¡ˆæ˜¯æ²¡æœ‰å¤šå°‘æ„ä¹‰çš„ï¼Œæ‰›ä¸ä½é—®ä¸è¯´ï¼Œä¹Ÿä¸äº†è§£åŸç†ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³çœŸçš„æå‡è‡ªå·±æŠ€èƒ½ï¼Œè¿˜æ˜¯è¦ä»æ ¹æœ¬æå®šã€‚</p><h2 id="äºŒã€æ¡ˆä¾‹å·¥ç¨‹" tabindex="-1"><a class="header-anchor" href="#äºŒã€æ¡ˆä¾‹å·¥ç¨‹" aria-hidden="true">#</a> äºŒã€æ¡ˆä¾‹å·¥ç¨‹</h2><p>ä¸ºäº†æ›´å¥½çš„åšæºç åˆ†æï¼Œæˆ‘ä»¬å°†å¹³æ—¶ç”¨çš„å®šæ—¶ä»»åŠ¡æœåŠ¡å•ç‹¬æŠ½ç¦»å‡ºæ¥ã€‚å·¥ç¨‹ä¸‹è½½ï¼Œå…³æ³¨å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆï¼Œå›å¤ï¼šæºç åˆ†æ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>itstack<span class="token operator">-</span>demo<span class="token operator">-</span>code<span class="token operator">-</span>schedule
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â”œâ”€â”€ java
    â”‚   â”‚   â””â”€â”€ org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo
    â”‚   â”‚       â”œâ”€â”€ <span class="token class-name">DemoTask</span><span class="token punctuation">.</span>java
    â”‚   â”‚       â””â”€â”€ <span class="token class-name">JobImpl</span><span class="token punctuation">.</span>java   
    â”‚   â””â”€â”€ resources	
    â”‚       â”œâ”€â”€ props	
    â”‚       â”‚   â””â”€â”€ config<span class="token punctuation">.</span>properties
    â”‚       â”œâ”€â”€ spring
    â”‚       â”‚   â””â”€â”€ spring<span class="token operator">-</span>config<span class="token operator">-</span>schedule<span class="token operator">-</span>task<span class="token punctuation">.</span>xml
    â”‚       â”œâ”€â”€ logback<span class="token punctuation">.</span>xml
    â”‚       â””â”€â”€ spring<span class="token operator">-</span>config<span class="token punctuation">.</span>xml
    â””â”€â”€ test
         â””â”€â”€ java
             â””â”€â”€ org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>test
                 â”œâ”€â”€ <span class="token class-name">ApiTest</span><span class="token punctuation">.</span>java
                 â”œâ”€â”€ <span class="token class-name">MyQuartz</span><span class="token punctuation">.</span>java				
                 â””â”€â”€ <span class="token class-name">MyTask</span><span class="token punctuation">.</span>java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ä¸‰ã€ç¯å¢ƒé…ç½®" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€ç¯å¢ƒé…ç½®" aria-hidden="true">#</a> ä¸‰ã€ç¯å¢ƒé…ç½®</h2><ol><li>JDK 1.8</li><li>IDEA 2019.3.1</li><li>Spring 4.3.24.RELEASE</li><li>quartz 2.3.2 ï½›ä¸åŒç‰ˆæœ¬ç•¥æœ‰ä»£ç å·®å¼‚ï½</li></ol><h2 id="å››ã€æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#å››ã€æºç åˆ†æ" aria-hidden="true">#</a> å››ã€æºç åˆ†æ</h2><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.quartz-scheduler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>quartz<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¾èµ–äºSpringç‰ˆæœ¬å‡çº§quartzé€‰æ‹©2.3.2ï¼ŒåŒæ—¶å¦‚æœä½ å¦‚æœ¬æ–‡æ¡ˆä¾‹ä¸­æ‰€ç¤ºä½¿ç”¨xmlé…ç½®ä»»åŠ¡ã€‚é‚£ä¹ˆä¼šæœ‰å¦‚ä¸‹æ›´æ”¹ï¼›</p><blockquote><p>Spring 3.x/org.springframework.scheduling.quart.CronTriggerBean</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">&quot;taskTrigger&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;org.springframework.scheduling.quartz.CronTriggerBean&quot;</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;jobDetail&quot;</span> ref<span class="token operator">=</span><span class="token string">&quot;taskHandler&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;cronExpression&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;0/5 * * * * ?&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>Spring 4.x/org.springframework.scheduling.quartz.CronTriggerFactoryBean</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">&quot;taskTrigger&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;org.springframework.scheduling.quartz.CronTriggerFactoryBean&quot;</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;jobDetail&quot;</span> ref<span class="token operator">=</span><span class="token string">&quot;taskHandler&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">&quot;cronExpression&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;0/5 * * * * ?&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ­£å¼åˆ†æå‰ï¼Œå¯ä»¥çœ‹ä¸‹quartzçš„é»˜è®¤é…ç½®ï¼Œå¾ˆå¤šåˆå§‹åŒ–åŠ¨ä½œéƒ½è¦ä»è¿™é‡Œå–å¾—å‚æ•°ï¼ŒåŒæ ·ä½ å¯ä»¥é…ç½®è‡ªå·±çš„é…ç½®æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œå½“ä½ çš„ä»»åŠ¡å¾ˆå¤šæ—¶ï¼Œé»˜è®¤åˆå§‹åŒ–çš„10ä¸ªçº¿ç¨‹ç»„ä¸æ»¡è¶³ä½ çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå°±å¯ä»¥æŒ‰éœ€è°ƒæ•´ã€‚</p><blockquote><p>quart.properties</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code># <span class="token class-name">Default</span> <span class="token class-name">Properties</span> file <span class="token keyword">for</span> use by <span class="token class-name">StdSchedulerFactory</span>
# <span class="token keyword">to</span> <span class="token namespace">create</span> a <span class="token class-name">Quartz</span> <span class="token class-name">Scheduler</span> <span class="token class-name">Instance</span><span class="token punctuation">,</span> <span class="token keyword">if</span> a different
# properties file is not explicitly specified<span class="token punctuation">.</span>
#

org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>instanceName<span class="token operator">:</span> <span class="token class-name">DefaultQuartzScheduler</span>
org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>export<span class="token operator">:</span> <span class="token boolean">false</span>
org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>proxy<span class="token operator">:</span> <span class="token boolean">false</span>
org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>wrapJobExecutionInUserTransaction<span class="token operator">:</span> <span class="token boolean">false</span>

org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>threadPool<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>simpl<span class="token punctuation">.</span></span>SimpleThreadPool</span>
org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>threadPool<span class="token punctuation">.</span>threadCount<span class="token operator">:</span> <span class="token number">10</span>
org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>threadPool<span class="token punctuation">.</span>threadPriority<span class="token operator">:</span> <span class="token number">5</span>
org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>threadPool<span class="token punctuation">.</span>threadsInheritContextClassLoaderOfInitializingThread<span class="token operator">:</span> <span class="token boolean">true</span>

org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>jobStore<span class="token punctuation">.</span>misfireThreshold<span class="token operator">:</span> <span class="token number">60000</span>

org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>jobStore<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>simpl<span class="token punctuation">.</span></span>RAMJobStore</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-ä»ä¸€ä¸ªç®€å•æ¡ˆä¾‹å¼€å§‹" tabindex="-1"><a class="header-anchor" href="#_1-ä»ä¸€ä¸ªç®€å•æ¡ˆä¾‹å¼€å§‹" aria-hidden="true">#</a> 1. ä»ä¸€ä¸ªç®€å•æ¡ˆä¾‹å¼€å§‹</h3><p>å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨ScheduleåŸºæœ¬éƒ½æ˜¯æ³¨è§£æˆ–è€…xmlé…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯ä¸ºäº†å¯ä»¥æ›´ç®€å•çš„åˆ†æä»£ç ï¼Œæˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„Demoå…¥æ‰‹ï¼Œæ”¾åˆ°mainå‡½æ•°ä¸­ã€‚</p><blockquote><p>DemoTask.java &amp; å®šä¹‰ä¸€ä¸ªç­‰å¾…è¢«æ‰§è¡Œçš„ä»»åŠ¡</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoTask</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DemoTask</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;å®šæ—¶å¤„ç†ç”¨æˆ·ä¿¡æ¯ä»»åŠ¡ï¼š0/5 * * * * ?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>MyTask.java &amp; æµ‹è¯•ç±»ï¼Œå°†é…ç½®åœ¨xmlä¸­çš„ä»£ç æŠ½ç¦»å‡ºæ¥</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTask</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">DemoTask</span> demoTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DemoTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å®šä¹‰äº†ï¼›æ‰§è¡Œçš„å†…å®¹</span>
        <span class="token class-name">MethodInvokingJobDetailFactoryBean</span> methodInvokingJobDetailFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodInvokingJobDetailFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">setTargetObject</span><span class="token punctuation">(</span>demoTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">setTargetMethod</span><span class="token punctuation">(</span><span class="token string">&quot;execute&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">setConcurrent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;demoTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å®šä¹‰äº†ï¼›æ‰§è¡Œçš„è®¡åˆ’</span>
        <span class="token class-name">CronTriggerFactoryBean</span> cronTriggerFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CronTriggerFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cronTriggerFactoryBean<span class="token punctuation">.</span><span class="token function">setJobDetail</span><span class="token punctuation">(</span>methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cronTriggerFactoryBean<span class="token punctuation">.</span><span class="token function">setCronExpression</span><span class="token punctuation">(</span><span class="token string">&quot;0/5 * * * * ?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cronTriggerFactoryBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;demoTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cronTriggerFactoryBean<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å®ç°äº†ï¼›æ‰§è¡Œçš„åŠŸèƒ½</span>
        <span class="token class-name">SchedulerFactoryBean</span> schedulerFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SchedulerFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        schedulerFactoryBean<span class="token punctuation">.</span><span class="token function">setTriggers</span><span class="token punctuation">(</span>cronTriggerFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        schedulerFactoryBean<span class="token punctuation">.</span><span class="token function">setAutoStartup</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        schedulerFactoryBean<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        schedulerFactoryBean<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æš‚åœä½</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œé‚£ä¹ˆä¼šæœ‰å¦‚ä¸‹ç»“æœï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">16.369</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>StdSchedulerFactory</span><span class="token punctuation">[</span><span class="token number">1220</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Using</span> <span class="token keyword">default</span> implementation <span class="token keyword">for</span> <span class="token class-name">ThreadExecutor</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">16.421</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>SchedulerSignalerImpl</span><span class="token punctuation">[</span><span class="token number">61</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Initialized</span> <span class="token class-name">Scheduler</span> <span class="token class-name">Signaller</span> of type<span class="token operator">:</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>SchedulerSignalerImpl</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">16.422</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>QuartzScheduler</span><span class="token punctuation">[</span><span class="token number">229</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Quartz</span> <span class="token class-name">Scheduler</span> v<span class="token punctuation">.</span><span class="token number">2.3</span><span class="token number">.2</span> created<span class="token punctuation">.</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">16.423</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>simpl<span class="token punctuation">.</span></span>RAMJobStore</span><span class="token punctuation">[</span><span class="token number">155</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">RAMJobStore</span> initialized<span class="token punctuation">.</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">16.424</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>QuartzScheduler</span><span class="token punctuation">[</span><span class="token number">294</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Scheduler</span> meta<span class="token operator">-</span>data<span class="token operator">:</span> <span class="token class-name">Quartz</span> <span class="token class-name">Scheduler</span> <span class="token punctuation">(</span>v2<span class="token punctuation">.</span><span class="token number">3.2</span><span class="token punctuation">)</span> &#39;<span class="token class-name">QuartzScheduler</span>&#39; <span class="token keyword">with</span> <span class="token namespace">instanceId</span> &#39;<span class="token constant">NON_CLUSTERED</span>&#39;
  <span class="token class-name">Scheduler</span> <span class="token keyword">class</span><span class="token operator">:</span> &#39;<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>QuartzScheduler</span>&#39; <span class="token operator">-</span> running locally<span class="token punctuation">.</span>
  <span class="token constant">NOT</span> <span class="token class-name">STARTED<span class="token punctuation">.</span>
  Currently</span> in standby <span class="token class-name"><span class="token namespace">mode<span class="token punctuation">.</span></span>
  Number</span> of jobs executed<span class="token operator">:</span> <span class="token number">0</span>
  <span class="token class-name">Using</span> thread pool &#39;<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>simpl<span class="token punctuation">.</span></span>SimpleThreadPool</span>&#39; <span class="token operator">-</span> <span class="token keyword">with</span> <span class="token number">10</span> <span class="token class-name"><span class="token namespace">threads<span class="token punctuation">.</span></span>
  Using</span> job<span class="token operator">-</span>store &#39;<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>simpl<span class="token punctuation">.</span></span>RAMJobStore</span>&#39; <span class="token operator">-</span> which does not support persistence<span class="token punctuation">.</span> and is not clustered<span class="token punctuation">.</span>

<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">16.424</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>StdSchedulerFactory</span><span class="token punctuation">[</span><span class="token number">1374</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Quartz</span> scheduler &#39;<span class="token class-name">QuartzScheduler</span>&#39; initialized from an externally provided properties instance<span class="token punctuation">.</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">16.424</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>StdSchedulerFactory</span><span class="token punctuation">[</span><span class="token number">1378</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Quartz</span> scheduler version<span class="token operator">:</span> <span class="token number">2.3</span><span class="token number">.2</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">16.426</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>QuartzScheduler</span><span class="token punctuation">[</span><span class="token number">2293</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">JobFactory</span> set <span class="token keyword">to</span><span class="token operator">:</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span></span>AdaptableJobFactory</span><span class="token annotation punctuation">@3e9b1010</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">16.651</span> <span class="token punctuation">[</span>main<span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>QuartzScheduler</span><span class="token punctuation">[</span><span class="token number">547</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token class-name">Scheduler</span> <span class="token class-name">QuartzScheduler_</span>$_NON_CLUSTERED started<span class="token punctuation">.</span>
ä¸€æœˆ <span class="token number">04</span><span class="token punctuation">,</span> <span class="token number">2020</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">16</span> ä¸Šåˆ <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span></span>SchedulerFactoryBean</span> startScheduler
ä¿¡æ¯<span class="token operator">:</span> <span class="token class-name">Starting</span> <span class="token class-name">Quartz</span> <span class="token class-name">Scheduler</span> now
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">20.321</span> <span class="token punctuation">[</span><span class="token class-name">QuartzScheduler_Worker</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span></span>DemoTask</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">-</span> å®šæ—¶å¤„ç†ç”¨æˆ·ä¿¡æ¯ä»»åŠ¡ï¼š<span class="token number">0</span><span class="token operator">/</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">?</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">25.001</span> <span class="token punctuation">[</span><span class="token class-name">QuartzScheduler_Worker</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span></span>DemoTask</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">-</span> å®šæ—¶å¤„ç†ç”¨æˆ·ä¿¡æ¯ä»»åŠ¡ï¼š<span class="token number">0</span><span class="token operator">/</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">?</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">30.000</span> <span class="token punctuation">[</span><span class="token class-name">QuartzScheduler_Worker</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span></span>DemoTask</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">-</span> å®šæ—¶å¤„ç†ç”¨æˆ·ä¿¡æ¯ä»»åŠ¡ï¼š<span class="token number">0</span><span class="token operator">/</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">?</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">35.001</span> <span class="token punctuation">[</span><span class="token class-name">QuartzScheduler_Worker</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span></span>DemoTask</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">-</span> å®šæ—¶å¤„ç†ç”¨æˆ·ä¿¡æ¯ä»»åŠ¡ï¼š<span class="token number">0</span><span class="token operator">/</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">?</span>
<span class="token number">2020</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">10</span><span class="token operator">:</span><span class="token number">47</span><span class="token operator">:</span><span class="token number">40.000</span> <span class="token punctuation">[</span><span class="token class-name">QuartzScheduler_Worker</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token constant">INFO</span>  <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>itstack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span></span>DemoTask</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">-</span> å®šæ—¶å¤„ç†ç”¨æˆ·ä¿¡æ¯ä»»åŠ¡ï¼š<span class="token number">0</span><span class="token operator">/</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">*</span> <span class="token operator">?</span>

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token operator">-</span><span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-å®šä¹‰æ‰§è¡Œå†…å®¹-methodinvokingjobdetailfactorybean" tabindex="-1"><a class="header-anchor" href="#_2-å®šä¹‰æ‰§è¡Œå†…å®¹-methodinvokingjobdetailfactorybean" aria-hidden="true">#</a> 2. å®šä¹‰æ‰§è¡Œå†…å®¹(MethodInvokingJobDetailFactoryBean)</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å®šä¹‰äº†ï¼›æ‰§è¡Œçš„å†…å®¹</span>
<span class="token class-name">MethodInvokingJobDetailFactoryBean</span> methodInvokingJobDetailFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodInvokingJobDetailFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">setTargetObject</span><span class="token punctuation">(</span>demoTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">setTargetMethod</span><span class="token punctuation">(</span><span class="token string">&quot;execute&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">setConcurrent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;demoTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™å—å†…å®¹ä¸»è¦å°†æˆ‘ä»¬çš„ä»»åŠ¡ä½“(å³å¾…æ‰§è¡Œä»»åŠ¡DemoTask)äº¤ç»™MethodInvokingJobDetailFactoryBeanç®¡ç†ï¼Œé¦–å…ˆè®¾ç½®å¿…è¦ä¿¡æ¯ï¼›</p><ul><li>targetObjectï¼šç›®æ ‡å¯¹è±¡beanï¼Œä¹Ÿå°±æ˜¯demoTask</li><li>targetMethodï¼šç›®æ ‡æ–¹æ³•nameï¼Œä¹Ÿå°±æ˜¯execute</li><li>concurrentï¼šæ˜¯å¦å¹¶è¡Œæ‰§è¡Œï¼Œéå¹¶è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¸‹ä¸€åˆ»ä¸ä¼šæ‰§è¡Œ</li><li>nameï¼šxmlé…ç½®éå¿…ä¼ ï¼Œæºç ä¸­å¯ä»¥è·å–beanName</li></ul><p>æœ€åæˆ‘ä»¬é€šè¿‡æ‰‹åŠ¨è°ƒç”¨ afterPropertiesSet() æ¥æ¨¡æ‹Ÿåˆå§‹åŒ–ã€‚å¦‚æœæˆ‘ä»¬çš„ç±»æ˜¯äº¤ç»™ Spring ç®¡ç†çš„ï¼Œé‚£ä¹ˆåœ¨å®ç°äº† InitializingBean æ¥å£çš„ç±»ï¼Œåœ¨ç±»é…ç½®ä¿¡æ¯åŠ è½½åä¼šè‡ªåŠ¨æ‰§è¡Œ afterPropertiesSet() ã€‚ä¸€èˆ¬å®ç°äº† InitializingBean æ¥å£çš„ç±»ï¼ŒåŒæ—¶ä¹Ÿä¼šå»å®ç° <code>FactoryBean&lt;T&gt;</code> æ¥å£ï¼Œå› ä¸ºè¿™ä¸ªæ¥å£å®ç°åå°±å¯ä»¥é€šè¿‡ T getObject() è·å–è‡ªå·±è‡ªå®šä¹‰åˆå§‹åŒ–çš„ç±»ã€‚è¿™ä¹Ÿå¸¸å¸¸ç”¨åœ¨ä¸€äº›æ¡†æ¶å¼€å‘ä¸­ã€‚</p><blockquote><p>MethodInvokingJobDetailFactoryBean.afterPropertiesSet()</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">{</span>
	<span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Use specific name if given, else fall back to bean name.</span>
	<span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Consider the concurrent flag to choose between stateful and stateless job.</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> jobClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>concurrent <span class="token operator">?</span> <span class="token class-name">MethodInvokingJob</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">:</span> <span class="token class-name">StatefulMethodInvokingJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Build JobDetail instance.</span>
	<span class="token class-name">JobDetailImpl</span> jdi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobDetailImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	jdi<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	jdi<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
	jdi<span class="token punctuation">.</span><span class="token function">setJobClass</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> jobClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
	jdi<span class="token punctuation">.</span><span class="token function">setDurability</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	jdi<span class="token punctuation">.</span><span class="token function">getJobDataMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;methodInvoker&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>jobDetail <span class="token operator">=</span> jdi<span class="token punctuation">;</span>
	
	<span class="token function">postProcessJobDetail</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>jobDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong>æºç 168è¡Œï¼š</strong> æ ¹æ®æ˜¯å¦å¹¶è¡Œæ‰§è¡Œé€‰æ‹©ä»»åŠ¡ç±»ï¼Œè¿™ä¸¤ä¸ªç±»éƒ½æ˜¯MethodInvokingJobDetailFactoryBeançš„å†…éƒ¨ç±»ï¼Œéå¹¶è¡Œæ‰§è¡Œçš„StatefulMethodInvokingJobåªæ˜¯ç»§æ‰¿MethodInvokingJobæ·»åŠ äº†æ ‡è®°æ³¨è§£ã€‚</p></li><li><p><strong>æºç 171è¡Œï¼š</strong> åˆ›å»ºJobDetailImplï¼Œæ·»åŠ ä»»åŠ¡æ˜ç»†ä¿¡æ¯ï¼Œæ³¨æ„è¿™ç±»çš„jdi.setJobClass((Class) jobClass)å®é™…å°±æ˜¯MethodInvokingJobã€‚MethodInvokingJobä¹Ÿæ˜¯æˆ‘ä»¬æœ€ç»ˆè¦åå°„è°ƒç”¨æ‰§è¡Œçš„å†…å®¹ã€‚</p></li><li><p><strong>æºç 177è¡Œï¼š</strong> åˆå§‹åŒ–ä»»åŠ¡åèµ‹å€¼ç»™this.jobDetail = jdiï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆçš„ç±»å¯¹è±¡</p><blockquote><p>MethodInvokingJobDetailFactoryBean.getObject()</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">JobDetail</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jobDetail<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æºç ï¼š220è¡Œï¼š</strong> è·å–å¯¹è±¡æ—¶è¿”å› this.jobDetailï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ MethodInvokingJobDetailFactoryBean åˆå§‹åŒ–åç›´æ¥èµ‹å€¼ç»™äº†ä¸€ä¸ª JobDetail ï¼›</p><p><img src="https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-code-schedule-01.png" alt="å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ &amp; Schedule.xml"></p></li></ul><h3 id="_3-å®šä¹‰æ‰§è¡Œè®¡åˆ’-crontriggerfactorybeann" tabindex="-1"><a class="header-anchor" href="#_3-å®šä¹‰æ‰§è¡Œè®¡åˆ’-crontriggerfactorybeann" aria-hidden="true">#</a> 3. å®šä¹‰æ‰§è¡Œè®¡åˆ’(CronTriggerFactoryBeann)</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å®šä¹‰äº†ï¼›æ‰§è¡Œçš„è®¡åˆ’</span>
<span class="token class-name">CronTriggerFactoryBean</span> cronTriggerFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CronTriggerFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cronTriggerFactoryBean<span class="token punctuation">.</span><span class="token function">setJobDetail</span><span class="token punctuation">(</span>methodInvokingJobDetailFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cronTriggerFactoryBean<span class="token punctuation">.</span><span class="token function">setCronExpression</span><span class="token punctuation">(</span><span class="token string">&quot;0/5 * * * * ?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cronTriggerFactoryBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;demoTask&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cronTriggerFactoryBean<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸€å—ä¸»è¦å®šä¹‰ä»»åŠ¡çš„æ‰§è¡Œè®¡åˆ’ï¼Œå¹¶å°†ä»»åŠ¡æ‰§è¡Œå†…å®¹äº¤ç»™ CronTriggerFactoryBean ç®¡ç†ï¼ŒåŒæ—¶è®¾ç½®å¿…è¦ä¿¡æ¯ï¼›</p><ul><li>jobDetailï¼šè®¾ç½®ä»»åŠ¡ä½“ï¼Œxml ä¸­å¯ä»¥ç›´æ¥å°†å¯¹è±¡èµ‹å€¼ï¼Œç¡¬ç¼–ç ä¸­è®¾ç½®æ‰§è¡Œçš„ JobDetail å¯¹è±¡ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è®¾ç½®çš„ JobDetailImpl ï¼Œé€šè¿‡ getObject() è·å–å‡ºæ¥ã€‚</li><li>cronExpressionï¼šè®¡åˆ’è¡¨è¾¾å¼ï¼›ç§’ã€åˆ†ã€æ—¶ã€æ—¥ã€æœˆã€å‘¨ã€å¹´</li></ul><blockquote><p>CronTriggerFactoryBean.afterPropertiesSet()</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
    
	<span class="token comment">// ... æ ¡éªŒå±æ€§ä¿¡æ¯</span>
	
	<span class="token class-name">CronTriggerImpl</span> cti <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CronTriggerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cti<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cti<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>jobDetail <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cti<span class="token punctuation">.</span><span class="token function">setJobKey</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>jobDetail<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	cti<span class="token punctuation">.</span><span class="token function">setJobDataMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>jobDataMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cti<span class="token punctuation">.</span><span class="token function">setStartTime</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cti<span class="token punctuation">.</span><span class="token function">setCronExpression</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cronExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cti<span class="token punctuation">.</span><span class="token function">setTimeZone</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeZone<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cti<span class="token punctuation">.</span><span class="token function">setCalendarName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>calendarName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cti<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cti<span class="token punctuation">.</span><span class="token function">setMisfireInstruction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>misfireInstruction<span class="token punctuation">)</span><span class="token punctuation">;</span>
	cti<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>cronTrigger <span class="token operator">=</span> cti<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong>æºç 237è¡Œï¼š</strong> åˆ›å»ºè§¦å‘å™¨ CronTriggerImpl å¹¶è®¾ç½®ç›¸å…³å±æ€§ä¿¡æ¯</p></li><li><p><strong>æºç 245è¡Œï¼š</strong> ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ç±» cti.setCronExpression(this.cronExpression);</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCronExpression</span><span class="token punctuation">(</span><span class="token class-name">String</span> cronExpression<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
	<span class="token class-name">TimeZone</span> origTz <span class="token operator">=</span> <span class="token function">getTimeZone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>cronEx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CronExpression</span><span class="token punctuation">(</span>cronExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>cronEx<span class="token punctuation">.</span><span class="token function">setTimeZone</span><span class="token punctuation">(</span>origTz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>CronExpression.java &amp; è§£æCronè¡¨è¾¾å¼</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">buildExpression</span><span class="token punctuation">(</span><span class="token class-name">String</span> expression<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
	expressionParsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		
		<span class="token comment">// ... åˆå§‹åŒ– TreeSet xxx = new TreeSet&lt;Integer&gt;();</span>
		
		<span class="token keyword">int</span> exprOn <span class="token operator">=</span> <span class="token constant">SECOND</span><span class="token punctuation">;</span>
		<span class="token class-name">StringTokenizer</span> exprsTok <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTokenizer</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> <span class="token string">&quot; \\t&quot;</span><span class="token punctuation">,</span>
				<span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				
		<span class="token keyword">while</span> <span class="token punctuation">(</span>exprsTok<span class="token punctuation">.</span><span class="token function">hasMoreTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> exprOn <span class="token operator">&lt;=</span> <span class="token constant">YEAR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">String</span> expr <span class="token operator">=</span> exprsTok<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			
			<span class="token comment">// ... æ ¡éªŒDAY_OF_MONTHå’ŒDAY_OF_WEEKå­—æ®µçš„ç‰¹æ®Šå­—ç¬¦</span>
			
			<span class="token class-name">StringTokenizer</span> vTok <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTokenizer</span><span class="token punctuation">(</span>expr<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>vTok<span class="token punctuation">.</span><span class="token function">hasMoreTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">String</span> v <span class="token operator">=</span> vTok<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">storeExpressionVals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v<span class="token punctuation">,</span> exprOn<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			exprOn<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// ... æ ¡éªŒDAY_OF_MONTHå’ŒDAY_OF_WEEKå­—æ®µçš„ç‰¹æ®Šå­—ç¬¦</span>
		
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> pe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> pe<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParseException</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal cron expression format (&quot;</span>
				<span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Cronè¡¨è¾¾å¼æœ‰7ä¸ªå­—æ®µï¼ŒCronExpression æŠŠ7ä¸ªå­—æ®µè§£æä¸º7ä¸ª TreeSet å¯¹è±¡ã€‚</li><li>å¡«å……TreeSetå¯¹è±¡å€¼çš„æ—¶å€™ï¼Œè¡¨è¾¾å¼éƒ½ä¼šè½¬æ¢ä¸ºèµ·å§‹å€¼ã€ç»“æŸå€¼å’Œå¢é‡çš„è®¡ç®—æ¨¡å¼ï¼Œç„¶åè®¡ç®—å‡ºåŒ¹é…çš„å€¼æ”¾è¿›TreeSetå¯¹è±¡</li></ul></li></ul><blockquote><p>CronTriggerFactoryBean.getObject()</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">CronTrigger</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cronTrigger<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>æºç 257è¡Œï¼š</strong> è·å–å¯¹è±¡æ—¶è¿”å› this.cronTrigger ï¼Œä¹Ÿå°±æ˜¯ CronTriggerImpl å¯¹è±¡</li></ul><h3 id="_4-è°ƒåº¦æ‰§è¡Œè®¡åˆ’-schedulerfactorybean" tabindex="-1"><a class="header-anchor" href="#_4-è°ƒåº¦æ‰§è¡Œè®¡åˆ’-schedulerfactorybean" aria-hidden="true">#</a> 4. è°ƒåº¦æ‰§è¡Œè®¡åˆ’(SchedulerFactoryBean)</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// è°ƒåº¦äº†ï¼›æ‰§è¡Œçš„è®¡åˆ’(scheduler)</span>
<span class="token class-name">SchedulerFactoryBean</span> schedulerFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SchedulerFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schedulerFactoryBean<span class="token punctuation">.</span><span class="token function">setTriggers</span><span class="token punctuation">(</span>cronTriggerFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schedulerFactoryBean<span class="token punctuation">.</span><span class="token function">setAutoStartup</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schedulerFactoryBean<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

schedulerFactoryBean<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸€éƒ¨åˆ†å¦‚åå­—ä¸€æ ·è°ƒåº¦å·¥å‚ï¼Œç›¸å½“äºä¸€ä¸ªæŒ‡æŒ¥å®˜ï¼Œå¯ä»¥ä»å…¨å±€åšè°ƒåº¦ï¼Œæ¯”å¦‚ç›‘å¬å“ªäº›triggerå·²ç»readyã€åˆ†é…çº¿ç¨‹ç­‰ç­‰ï¼ŒåŒæ ·ä¹Ÿéœ€è¦è®¾ç½®å¿…è¦çš„å±æ€§ä¿¡æ¯ï¼›</p><ul><li>triggersï¼šæŒ‰éœ€å¯ä»¥è®¾ç½®å¤šä¸ªè§¦å‘å™¨ï¼Œæœ¬æ–‡è®¾ç½®äº†ä¸€ä¸ª cronTriggerFactoryBean.getObject() ä¹Ÿå°±æ˜¯ CronTriggerImpl å¯¹è±¡</li><li>autoStartupï¼šé»˜è®¤æ˜¯å¦è‡ªåŠ¨å¯åŠ¨ä»»åŠ¡ï¼Œé»˜è®¤å€¼ä¸ºtrue</li></ul><p>è¿™ä¸ªè¿‡ç¨‹è¾ƒé•¿åŒ…æ‹¬ï¼šè°ƒåº¦å·¥å‚ã€çº¿ç¨‹æ± ã€æ³¨å†Œä»»åŠ¡ç­‰ç­‰ï¼Œæ•´ä½“æ ¸å¿ƒåŠ è½½æµç¨‹å¦‚ä¸‹ï¼›</p><p><img src="https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-code-schedule-02.png" alt="å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ &amp; è°ƒåº¦å·¥ç¨‹åˆå§‹åŒ–æµç¨‹"></p><ul><li>æ•´ä¸ªåŠ è½½è¿‡ç¨‹è¾ƒé•¿ï¼ŒæŠ½å–éƒ¨åˆ†æ ¸å¿ƒä»£ç å—è¿›è¡Œåˆ†æï¼Œå…¶ä¸­åŒ…æ‹¬çš„ç±»ï¼› <ul><li>StdScheduler</li><li>StdSchedulerFactory</li><li>SimpleThreadPool</li><li>QuartzScheduler</li><li>QuartzSchedulerThread</li><li>RAMJobStore</li><li>CronTriggerImpl</li><li>CronExpression</li></ul></li></ul><blockquote><p>SchedulerFactoryBean.afterPropertiesSet()</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nonTransactionalDataSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nonTransactionalDataSource<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Initialize the Scheduler instance...</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>scheduler <span class="token operator">=</span> <span class="token function">prepareScheduler</span><span class="token punctuation">(</span><span class="token function">prepareSchedulerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">registerJobsAndTriggers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Scheduler shutdown exception after registration failure&quot;</span><span class="token punctuation">,</span> ex2<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong>æºç 474è¡Œï¼š</strong> ä¸ºè°ƒåº¦å™¨åšå‡†å¤‡å·¥ä½œ prepareScheduler(prepareSchedulerFactory()) ï¼Œä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹ï¼›</p><ol><li>SchedulerFactoryBean.prepareScheduler(SchedulerFactory schedulerFactory)</li><li>SchedulerFactoryBean.createScheduler(schedulerFactory, this.schedulerName);</li><li>SchedulerFactoryBean.createScheduler(SchedulerFactory schedulerFactory, String schedulerName)</li><li>Scheduler newScheduler = schedulerFactory.getScheduler();</li><li>StdSchedulerFactory.getScheduler();</li><li>sched = instantiate(); <strong>åŒ…æ‹¬ä¸€ç³»åˆ—æ ¸å¿ƒæ“ä½œï¼›</strong></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">1</span>ï¼‰åˆå§‹åŒ–<span class="token function">threadPool</span><span class="token punctuation">(</span>çº¿ç¨‹æ± <span class="token punctuation">)</span>ï¼šå¼€å‘è€…å¯ä»¥é€šè¿‡org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>threadPool<span class="token punctuation">.</span><span class="token keyword">class</span>é…ç½®æŒ‡å®šä½¿ç”¨å“ªä¸ªçº¿ç¨‹æ± ç±»ï¼Œæ¯”å¦‚<span class="token class-name">SimpleThreadPool</span>ã€‚
<span class="token number">2</span>ï¼‰åˆå§‹åŒ–<span class="token function">jobStore</span><span class="token punctuation">(</span>ä»»åŠ¡å­˜å‚¨æ–¹å¼<span class="token punctuation">)</span>ï¼šå¼€å‘è€…å¯ä»¥é€šè¿‡org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>jobStore<span class="token punctuation">.</span><span class="token keyword">class</span>é…ç½®æŒ‡å®šä½¿ç”¨å“ªä¸ªä»»åŠ¡å­˜å‚¨ç±»ï¼Œæ¯”å¦‚<span class="token class-name">RAMJobStore</span>ã€‚
<span class="token number">3</span>ï¼‰åˆå§‹åŒ–<span class="token function">dataSource</span><span class="token punctuation">(</span>æ•°æ®æº<span class="token punctuation">)</span>ï¼šå¼€å‘è€…å¯ä»¥é€šè¿‡org<span class="token punctuation">.</span>quartz<span class="token punctuation">.</span>dataSourceé…ç½®æŒ‡å®šæ•°æ®æºè¯¦æƒ…ï¼Œæ¯”å¦‚å“ªä¸ªæ•°æ®åº“ã€è´¦å·ã€å¯†ç ç­‰ã€‚
<span class="token number">4</span>ï¼‰åˆå§‹åŒ–å…¶ä»–é…ç½®ï¼šåŒ…æ‹¬<span class="token class-name">SchedulerPlugins</span>ã€<span class="token class-name">JobListeners</span>ã€<span class="token class-name">TriggerListeners</span>ç­‰ï¼›
<span class="token number">5</span>ï¼‰åˆå§‹åŒ–<span class="token function">threadExecutor</span><span class="token punctuation">(</span>çº¿ç¨‹æ‰§è¡Œå™¨<span class="token punctuation">)</span>ï¼šé»˜è®¤ä¸º<span class="token class-name">DefaultThreadExecutor</span>ï¼›
<span class="token number">6</span>ï¼‰åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼šæ ¹æ®é…ç½®åˆ›å»º<span class="token class-name">N</span>ä¸ªå·¥ä½œthreadï¼Œæ‰§è¡Œ<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>å¯åŠ¨threadï¼Œå¹¶å°†<span class="token class-name">N</span>ä¸ªthreadé¡ºåºaddè¿›threadPoolå®ä¾‹çš„ç©ºé—²çº¿ç¨‹åˆ—è¡¨availWorkersä¸­ï¼›
<span class="token number">7</span>ï¼‰åˆ›å»ºè°ƒåº¦å™¨çº¿ç¨‹ï¼šåˆ›å»º<span class="token class-name">QuartzSchedulerThread</span>å®ä¾‹ï¼Œå¹¶é€šè¿‡threadExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>å®ä¾‹<span class="token punctuation">)</span>å¯åŠ¨è°ƒåº¦å™¨çº¿ç¨‹ï¼›
<span class="token number">8</span>ï¼‰åˆ›å»ºè°ƒåº¦å™¨ï¼šåˆ›å»º<span class="token class-name">StdScheduler</span>å®ä¾‹ï¼Œå°†ä¸Šé¢æ‰€æœ‰é…ç½®å’Œå¼•ç”¨ç»„åˆè¿›å®ä¾‹ä¸­ï¼Œå¹¶å°†å®ä¾‹å­˜å…¥è°ƒåº¦å™¨æ± ä¸­
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æºç 477è¡Œï¼š</strong> è°ƒç”¨çˆ¶ç±» SchedulerAccessor.registerJobsAndTriggers() æ³¨å†Œä»»åŠ¡å’Œè§¦å‘å™¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Trigger</span> trigger <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>triggers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">addTriggerToScheduler</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><blockquote><p>SchedulerAccessor.addTriggerToScheduler() &amp; SchedulerAccessor æ˜¯SchedulerFactoryBeançš„çˆ¶ç±»</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addTriggerToScheduler</span><span class="token punctuation">(</span><span class="token class-name">Trigger</span> trigger<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SchedulerException</span> <span class="token punctuation">{</span>
	<span class="token keyword">boolean</span> triggerExists <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTrigger</span><span class="token punctuation">(</span>trigger<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>triggerExists <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>overwriteExistingJobs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Check if the Trigger is aware of an associated JobDetail.</span>
	<span class="token class-name">JobDetail</span> jobDetail <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">JobDetail</span><span class="token punctuation">)</span> trigger<span class="token punctuation">.</span><span class="token function">getJobDataMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&quot;jobDetail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>triggerExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>jobDetail <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>jobDetails<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">addJobToScheduler</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>jobDetails<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rescheduleJob</span><span class="token punctuation">(</span>trigger<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ObjectAlreadyExistsException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpectedly encountered existing trigger on rescheduling, assumably due to &quot;</span> <span class="token operator">+</span>
						<span class="token string">&quot;cluster race condition: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; - can safely be ignored&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>jobDetail <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>jobDetails<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
					<span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>overwriteExistingJobs <span class="token operator">||</span> <span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJobDetail</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>jobDetails<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>jobDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ObjectAlreadyExistsException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpectedly encountered existing trigger on job scheduling, assumably due to &quot;</span> <span class="token operator">+</span>
						<span class="token string">&quot;cluster race condition: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; - can safely be ignored&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>overwriteExistingJobs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rescheduleJob</span><span class="token punctuation">(</span>trigger<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong>æºç 299è¡Œï¼š</strong> addJobToScheduler(jobDetail) ä¸€ç›´ä¼šè°ƒç”¨åˆ° RAMJobStore è¿›è¡Œå­˜æ”¾ä»»åŠ¡ä¿¡æ¯åˆ° <code>HashMap&lt;JobKey, JobWrapper&gt;(100)</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">storeJob</span><span class="token punctuation">(</span><span class="token class-name">JobDetail</span> newJob<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> replaceExisting<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ObjectAlreadyExistsException</span> <span class="token punctuation">{</span>
	<span class="token class-name">JobWrapper</span> jw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobWrapper</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JobDetail</span><span class="token punctuation">)</span>newJob<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">boolean</span> repl <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>jobsByKey<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>jw<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>replaceExisting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ObjectAlreadyExistsException</span><span class="token punctuation">(</span>newJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			repl <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>repl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// get job group</span>
			<span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobKey</span><span class="token punctuation">,</span> <span class="token class-name">JobWrapper</span><span class="token punctuation">&gt;</span></span> grpMap <span class="token operator">=</span> jobsByGroup<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newJob<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>grpMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				grpMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobKey</span><span class="token punctuation">,</span> <span class="token class-name">JobWrapper</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				jobsByGroup<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newJob<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> grpMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// add to jobs by group</span>
			grpMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>newJob<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jw<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// add to jobs by FQN map</span>
			jobsByKey<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>jw<span class="token punctuation">.</span>key<span class="token punctuation">,</span> jw<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// update job detail</span>
			<span class="token class-name">JobWrapper</span> orig <span class="token operator">=</span> jobsByKey<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>jw<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
			orig<span class="token punctuation">.</span>jobDetail <span class="token operator">=</span> jw<span class="token punctuation">.</span>jobDetail<span class="token punctuation">;</span> <span class="token comment">// already cloned</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>åˆå§‹åŒ–çº¿ç¨‹ç»„ï¼›</p><ul><li>prepareScheduler</li><li>createScheduler</li><li>schedulerFactory</li><li>StdSchedulerFactory.getScheduler()</li><li>getScheduler()-&gt;instantiate()</li><li><strong>æºç 1323è¡Œï¼š</strong> tp.initialize();</li></ul><blockquote><p>SimpleThreadPool.initialize() &amp; è¿™é‡Œçš„countæ˜¯é»˜è®¤é…ç½®ä¸­çš„æ•°é‡ï¼Œå¯ä»¥æ›´æ”¹</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token comment">// create the worker threads and start them</span>
 <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WorkerThread</span><span class="token punctuation">&gt;</span></span> workerThreads <span class="token operator">=</span> <span class="token function">createWorkerThreads</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span><span class="token punctuation">(</span>workerThreads<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 <span class="token class-name">WorkerThread</span> wt <span class="token operator">=</span> workerThreads<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 wt<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 availWorkers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wt<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_5-å¯åŠ¨å®šæ—¶ä»»åŠ¡" tabindex="-1"><a class="header-anchor" href="#_5-å¯åŠ¨å®šæ—¶ä»»åŠ¡" aria-hidden="true">#</a> 5. å¯åŠ¨å®šæ—¶ä»»åŠ¡</h3><p>æ¡ˆä¾‹ä¸­ä½¿ç”¨ç¡¬ç¼–ç æ–¹å¼è°ƒç”¨ schedulerFactoryBean.start() å¯åŠ¨çº¿ç¨‹æœåŠ¡ã€‚çº¿ç¨‹çš„åä½œé€šè¿‡Object sigLockæ¥å®ç°ï¼Œå…³äºsigLock.wait()æ–¹æ³•éƒ½åœ¨QuartzSchedulerThreadçš„runæ–¹æ³•é‡Œé¢ï¼Œæ‰€ä»¥sigLockå”¤é†’çš„æ˜¯åªæœ‰çº¿ç¨‹QuartzSchedulerThreadã€‚æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼›</p><p><img src="https://bugstack.cn/assets/images/pic-content/2019/11/itstack-demo-code-schedule-03.png" alt="å¾®ä¿¡å…¬ä¼—å·ï¼šbugstackè™«æ´æ ˆ &amp; è°ƒåº¦å¯åŠ¨æµç¨‹"></p><p>è¿™ä¸ªå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæ ¸å¿ƒçš„ä»£ç ç±»ï¼Œå¦‚ä¸‹ï¼›</p><ul><li>StdScheduler</li><li>QuartzScheduler</li><li>QuartzSchedulerThread</li><li>ThreadPool</li><li>RAMJobStore</li><li>CronTriggerImpl</li><li>JobRunShellFactory</li></ul><blockquote><p>QuartzScheduler.start() &amp; å¯åŠ¨</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SchedulerException</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>shuttingDown<span class="token operator">||</span> closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SchedulerException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;The Scheduler cannot be restarted after shutdown() has been called.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">// QTZ-212 : calling new schedulerStarting() method on the listeners</span>
    <span class="token comment">// right after entering start()</span>
    <span class="token function">notifySchedulerListenersStarting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token keyword">if</span> <span class="token punctuation">(</span>initialStart <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        initialStart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resources<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedulerStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token function">startPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        resources<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">schedulerResumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">// å”¤é†’çº¿ç¨‹</span>
	schedThread<span class="token punctuation">.</span><span class="token function">togglePause</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Scheduler &quot;</span> <span class="token operator">+</span> resources<span class="token punctuation">.</span><span class="token function">getUniqueIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">notifySchedulerListenersStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>QuartzSchedulerThread.run() &amp; æ‰§è¡Œè¿‡ç¨‹</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> acquiresFailed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token comment">// åªæœ‰è°ƒç”¨äº†halt()æ–¹æ³•ï¼Œæ‰ä¼šé€€å‡ºè¿™ä¸ªæ­»å¾ªç¯</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>halted<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
			
			<span class="token comment">// ä¸€ã€å¦‚æœæ˜¯æš‚åœçŠ¶æ€ï¼Œåˆ™å¾ªç¯è¶…æ—¶ç­‰å¾…1000æ¯«ç§’</span>

            <span class="token comment">// wait a bit, if reading from job store is consistently failing (e.g. DB is down or restarting)..</span>
           
		    <span class="token comment">// é˜»å¡ç›´åˆ°æœ‰ç©ºé—²çš„çº¿ç¨‹å¯ç”¨å¹¶è¿”å›å¯ç”¨çš„æ•°é‡</span>
            <span class="token keyword">int</span> availThreadCount <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">blockForAvailableThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>availThreadCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OperableTrigger</span><span class="token punctuation">&gt;</span></span> triggers<span class="token punctuation">;</span>
                <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">clearSignaledSchedulingChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
				<span class="token keyword">try</span> <span class="token punctuation">{</span>
					<span class="token comment">// äºŒã€è·å–acquireçŠ¶æ€çš„Triggeråˆ—è¡¨ï¼Œä¹Ÿå°±æ˜¯å³å°†æ‰§è¡Œçš„ä»»åŠ¡</span>
                    triggers <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acquireNextTriggers</span><span class="token punctuation">(</span>
                            now <span class="token operator">+</span> idleWaitTime<span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>availThreadCount<span class="token punctuation">,</span> qsRsrcs<span class="token punctuation">.</span>getMaxBat
                    acquiresFailed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;batch acquisition of &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>triggers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> triggers
                <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//...}</span>
				
                <span class="token keyword">if</span> <span class="token punctuation">(</span>triggers <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>triggers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    
					<span class="token comment">// ä¸‰ï¼šè·å–Listç¬¬ä¸€ä¸ªTriggerçš„ä¸‹æ¬¡è§¦å‘æ—¶åˆ»</span>
					<span class="token keyword">long</span> triggerTime <span class="token operator">=</span> triggers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNextFireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
					<span class="token comment">// å››ï¼šè·å–ä»»åŠ¡è§¦å‘é›†åˆ</span>
					<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TriggerFiredResult</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">triggersFired</span><span class="token punctuation">(</span>triggers<span class="token punctuation">)</span><span class="token punctuation">;</span>
					
					<span class="token comment">// äº”ï¼šè®¾ç½®Triggersä¸º&#39;executing&#39;çŠ¶æ€</span>
					qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">releaseAcquiredTrigger</span><span class="token punctuation">(</span>triggers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    
					<span class="token comment">// å…­ï¼šåˆ›å»ºJobRunShell</span>
					qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobRunShellFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createJobRunShell</span><span class="token punctuation">(</span>bndle<span class="token punctuation">)</span><span class="token punctuation">;</span>
					
					<span class="token comment">// ä¸ƒï¼šæ‰§è¡ŒJob</span>
					qsRsrcs<span class="token punctuation">.</span><span class="token function">getThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">runInThread</span><span class="token punctuation">(</span>shell<span class="token punctuation">)</span>
					
                    <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// while (!halted)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// if(availThreadCount &gt; 0)</span>
                <span class="token comment">// should never happen, if threadPool.blockForAvailableThreads() follows con</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// while (!halted)</span>
            <span class="token punctuation">}</span>
			
            
        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> re<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Runtime error occurred in main trigger firing loop.&quot;</span><span class="token punctuation">,</span> re<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    qs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    qsRsrcs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong>æºç 391è¡Œï¼š</strong> åˆ›å»ºJobRunShellï¼ŒJobRunShellå®ä¾‹åœ¨initialize()æ–¹æ³•å°±ä¼šæŠŠåŒ…å«ä¸šåŠ¡é€»è¾‘ç±»çš„JobDetailImplè®¾ç½®ä¸ºå®ƒçš„æˆå‘˜å±æ€§ï¼Œä¸ºåé¢æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä»£ç åšå‡†å¤‡ã€‚æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä»£ç åœ¨runInThread(shell)æ–¹æ³•é‡Œé¢ã€‚</p><blockquote><p>QuartzSchedulerThread.run() &amp; éƒ¨åˆ†ä»£ç </p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">JobRunShell</span> shell <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
	shell <span class="token operator">=</span> qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobRunShellFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createJobRunShell</span><span class="token punctuation">(</span>bndle<span class="token punctuation">)</span><span class="token punctuation">;</span>
	shell<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>qs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SchedulerException</span> se<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	qsRsrcs<span class="token punctuation">.</span><span class="token function">getJobStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">triggeredJobComplete</span><span class="token punctuation">(</span>triggers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> bndle<span class="token punctuation">.</span><span class="token function">getJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CompletedExecutionInstruction</span><span class="token punctuation">.</span><span class="token constant">SET_ALL_JOB_TRIGGERS_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æºç 398è¡Œï¼š</strong> qsRsrcs.getThreadPool().runInThread(shell)</p><blockquote><p>SimpleThreadPool.runInThread</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä¿å­˜æ‰€æœ‰WorkerThreadçš„é›†åˆ</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WorkerThread</span><span class="token punctuation">&gt;</span></span> workers<span class="token punctuation">;</span>
<span class="token comment">// ç©ºé—²çš„WorkerThreadé›†åˆ</span>
<span class="token keyword">private</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WorkerThread</span><span class="token punctuation">&gt;</span></span> availWorkers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WorkerThread</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ä»»åŠ¡çš„WorkerThreadé›†åˆ</span>
<span class="token keyword">private</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WorkerThread</span><span class="token punctuation">&gt;</span></span> busyWorkers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WorkerThread</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * ç»´æŠ¤workersã€availWorkerså’ŒbusyWorkersä¸‰ä¸ªåˆ—è¡¨æ•°æ®
 * æœ‰ä»»åŠ¡éœ€è¦ä¸€ä¸ªçº¿ç¨‹å‡ºæ¥æ‰§è¡Œï¼šavailWorkers.removeFirst();busyWorkers.add()
 * ç„¶åè°ƒç”¨WorkThread.run(runnable)æ–¹æ³•
 */</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">runInThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>runnable <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>nextRunnableLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		handoffPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

		<span class="token comment">// Wait until a worker thread is available</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>availWorkers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isShutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				nextRunnableLock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isShutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">WorkerThread</span> wt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WorkerThread</span><span class="token punctuation">)</span>availWorkers<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			busyWorkers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wt<span class="token punctuation">)</span><span class="token punctuation">;</span>
			wt<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// If the thread pool is going down, execute the Runnable</span>
			<span class="token comment">// within a new additional worker thread (no thread from the pool).</span>
			
			<span class="token class-name">WorkerThread</span> wt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkerThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> threadGroup<span class="token punctuation">,</span>
					<span class="token string">&quot;WorkerThread-LastJob&quot;</span><span class="token punctuation">,</span> prio<span class="token punctuation">,</span> <span class="token function">isMakeThreadsDaemons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
			busyWorkers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wt<span class="token punctuation">)</span><span class="token punctuation">;</span>
			workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>wt<span class="token punctuation">)</span><span class="token punctuation">;</span>
			wt<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		nextRunnableLock<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		handoffPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æºç 428è¡Œï¼š</strong> WorkerThread ï¼Œæ˜¯ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œä¸»è¦æ˜¯èµ‹å€¼å¹¶å”¤é†’lockå¯¹è±¡çš„ç­‰å¾…çº¿ç¨‹é˜Ÿåˆ—</p><blockquote><p>WorkerThread.run(Runnable newRunnable)</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> newRunnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>runnable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Already running a Runnable!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		runnable <span class="token operator">=</span> newRunnable<span class="token punctuation">;</span>
		lock<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æºç 561è¡Œï¼š</strong> WorkerThread çš„runæ–¹æ³•ï¼Œæ–¹æ³•æ‰§è¡Œlock.notifyAll()åï¼Œå¯¹åº”çš„WorkerThreadå°±ä¼šæ¥åˆ°run()æ–¹æ³•ã€‚åˆ°è¿™ï¼æ¥è¿‘æ›™å…‰äº†ï¼ç»ˆäºæ¥åˆ°äº†æ‰§è¡Œä¸šåŠ¡çš„execute()æ–¹æ³•çš„å€’æ•°ç¬¬äºŒæ­¥ï¼Œrunnableå¯¹è±¡æ˜¯ä¸€ä¸ªJobRunShellå¯¹è±¡ï¼Œä¸‹é¢åœ¨çœ‹JobRunShell.run()æ–¹æ³•ã€‚</p><blockquote><p>WorkerThread.run()</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">boolean</span> ran <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	
	<span class="token keyword">while</span> <span class="token punctuation">(</span>run<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">while</span> <span class="token punctuation">(</span>runnable <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> run<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					lock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>runnable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					ran <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
					<span class="token comment">// å¯åŠ¨çœŸæ­£æ‰§è¡Œçš„å†…å®¹ï¼Œrunnableå°±æ˜¯JobRunShell</span>
					runnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//...}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//if (log.isDebugEnabled())</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;WorkerThread is shut down.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// ignore to help with a tomcat glitch</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><blockquote><p>JobRunShell.run() &amp; ä»ä¸Šé¢WorkerThread.run()ï¼Œè°ƒç”¨åˆ°è¿™é‡Œæ‰§è¡Œ</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    qs<span class="token punctuation">.</span><span class="token function">addInternalSchedulerListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">OperableTrigger</span> trigger <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">OperableTrigger</span><span class="token punctuation">)</span> jec<span class="token punctuation">.</span><span class="token function">getTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JobDetail</span> jobDetail <span class="token operator">=</span> jec<span class="token punctuation">.</span><span class="token function">getJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>

            <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> endTime <span class="token operator">=</span> startTime<span class="token punctuation">;</span>

            <span class="token comment">// execute the job</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Calling execute on job &quot;</span> <span class="token operator">+</span> jobDetail<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
				<span class="token comment">// æ‰§è¡Œä¸šåŠ¡ä»£ç ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„task</span>
				job<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>jec<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
				endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JobExecutionException</span> jee<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                jobExEx <span class="token operator">=</span> jee<span class="token punctuation">;</span>
                <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Job &quot;</span> <span class="token operator">+</span> jobDetail<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token string">&quot; threw a JobExecutionException: &quot;</span><span class="token punctuation">,</span> jobExEx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                endTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Job &quot;</span> <span class="token operator">+</span> jobDetail<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token string">&quot; threw an unhandled Exception: &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SchedulerException</span> se <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SchedulerException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Job threw an unhandled exception.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                qs<span class="token punctuation">.</span><span class="token function">notifySchedulerListenersError</span><span class="token punctuation">(</span><span class="token string">&quot;Job (&quot;</span>
                        <span class="token operator">+</span> jec<span class="token punctuation">.</span><span class="token function">getJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">&quot; threw an exception.&quot;</span><span class="token punctuation">,</span> se<span class="token punctuation">)</span><span class="token punctuation">;</span>
                jobExEx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobExecutionException</span><span class="token punctuation">(</span>se<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            jec<span class="token punctuation">.</span><span class="token function">setJobRunTime</span><span class="token punctuation">(</span>endTime <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// å…¶ä»–ä»£ç </span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        qs<span class="token punctuation">.</span><span class="token function">removeInternalSchedulerListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>QuartzJobBean.execte() &amp; ç»§ç»­å¾€ä¸‹èµ°</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JobExecutionException</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token class-name">BeanWrapper</span> bw <span class="token operator">=</span> <span class="token class-name">PropertyAccessorFactory</span><span class="token punctuation">.</span><span class="token function">forBeanPropertyAccess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">MutablePropertyValues</span> pvs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutablePropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pvs<span class="token punctuation">.</span><span class="token function">addPropertyValues</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pvs<span class="token punctuation">.</span><span class="token function">addPropertyValues</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getMergedJobDataMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		bw<span class="token punctuation">.</span><span class="token function">setPropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SchedulerException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JobExecutionException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">executeInternal</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>MethodInvokingJobDetailFactoryBean-&gt;MethodInvokingJob.executeInternal(JobExecutionContext context)</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">executeInternal</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JobExecutionException</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token comment">// åå°„æ‰§è¡Œä¸šåŠ¡ä»£ç </span>
		context<span class="token punctuation">.</span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>methodInvoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getTargetException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">JobExecutionException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// -&gt; JobExecutionException, to be logged at info level by Quartz</span>
			<span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">JobExecutionException</span><span class="token punctuation">)</span> ex<span class="token punctuation">.</span><span class="token function">getTargetException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// -&gt; &quot;unhandled exception&quot;, to be logged at error level by Quartz</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JobMethodInvocationFailedException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>methodInvoker<span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getTargetException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// -&gt; &quot;unhandled exception&quot;, to be logged at error level by Quartz</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JobMethodInvocationFailedException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>methodInvoker<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="äº”ã€ç»¼ä¸Šæ€»ç»“" tabindex="-1"><a class="header-anchor" href="#äº”ã€ç»¼ä¸Šæ€»ç»“" aria-hidden="true">#</a> äº”ã€ç»¼ä¸Šæ€»ç»“</h2>`,76),v=n("li",null,"quartzï¼Œå³çŸ³è‹±çš„æ„æ€ï¼Œéšå–»å¦‚çŸ³è‹±é’Ÿèˆ¬å¯¹æ—¶é—´çš„å‡†ç¡®æŠŠæ¡ã€‚",-1),m=n("li",null,"æºç åˆ†ææ˜¯ä¸€ä¸ªå¾ˆå¿«ä¹çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªå¿«ä¹æ˜¯åˆ†æå®Œæ‰èƒ½è·å¾—çš„å¿«ä¹ã€‚çºµæ¨ªäº¤äº’çš„èƒŒåæ˜¯é¢å‘å¯¹è±¡çš„é«˜åº¦è§£è€¦ï¼Œå¯¹çº¿ç¨‹ç²¾å½©çš„ä½¿ç”¨ï¼Œå°†ä»»åŠ¡æ‰§è¡Œåšæˆè®¡åˆ’å•ï¼Œç®€ç›´æ˜¯ä¸€ä¸ªè¶…çº§æ£’çš„ä½œå“ã€‚",-1),b=n("li",null,"å¯¹äºquartz.propertiesï¼Œç®€å•åœºæ™¯ä¸‹ï¼Œå¼€å‘è€…ä¸ç”¨è‡ªå®šä¹‰é…ç½®ï¼Œä½¿ç”¨quartzé»˜è®¤é…ç½®å³å¯ï¼Œä½†åœ¨è¦æ±‚è¾ƒé«˜çš„ä½¿ç”¨åœºæ™¯ä¸­è¿˜æ˜¯è¦è‡ªå®šä¹‰é…ç½®ï¼Œæ¯”å¦‚é€šè¿‡org.quartz.threadPool.threadCountè®¾ç½®è¶³å¤Ÿçš„çº¿ç¨‹æ•°å¯æé«˜å¤šjobåœºæ™¯ä¸‹çš„è¿è¡Œæ€§èƒ½ã€‚",-1),g=n("li",null,"quartz å¯¹ä»»åŠ¡å¤„ç†é«˜åº¦è§£è€¦ï¼Œjobä¸triggerè§£è—•ï¼Œå°†ä»»åŠ¡æœ¬èº«å’Œä»»åŠ¡æ‰§è¡Œç­–ç•¥è§£è—•ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿å®ç°Nä¸ªä»»åŠ¡å’ŒMä¸ªæ‰§è¡Œç­–ç•¥è‡ªç”±ç»„åˆã€‚",-1),h=n("li",null,"schedulerå•ç‹¬åˆ†ç¦»å‡ºæ¥ï¼Œç›¸å½“äºä¸€ä¸ªæŒ‡æŒ¥å®˜ï¼Œå¯ä»¥ä»å…¨å±€åšè°ƒåº¦ï¼Œæ¯”å¦‚ç›‘å¬å“ªäº›triggerå·²ç»readyã€åˆ†é…çº¿ç¨‹ç­‰ç­‰ã€‚",-1),y={href:"http://www.quartz-scheduler.org",target:"_blank",rel:"noopener noreferrer"},w={href:"http://www.quartz-scheduler.org/documentation/quartz-2.1.x/configuration/",target:"_blank",rel:"noopener noreferrer"};function f(x,S){const a=e("ExternalLinkIcon");return o(),c("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),r,s("åšå®¢ï¼š"),n("a",k,[s("https://bugstack.cn"),t(a)])]),d,n("ul",null,[v,m,b,g,h,n("li",null,[s("å¤–éƒ¨é“¾æ¥ï¼š "),n("ul",null,[n("li",null,[n("a",y,[s("http://www.quartz-scheduler.org"),t(a)])]),n("li",null,[n("a",w,[s("quartz-2.1.x/configuration"),t(a)])])])])])])}const T=p(i,[["render",f],["__file","2020-01-01-_yuanmajiexi_SpringdingshirenwuQuartzzhixingquanguochengyuanmajiedu.html.vue"]]);export{T as default};
