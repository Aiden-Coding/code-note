import{_ as e,r as p,o as c,c as o,a as n,b as s,d as t,e as l}from"./app-3RcBQnkC.js";const i={},u=n("h1",{id:"ã€Šspring-æ‰‹æ’¸ä¸“æ ã€‹ç¬¬-12-ç« -ç‚‰ç«çº¯é’-åŸºäºjdkå’ŒcglibåŠ¨æ€ä»£ç†-å®ç°aopæ ¸å¿ƒåŠŸèƒ½",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#ã€Šspring-æ‰‹æ’¸ä¸“æ ã€‹ç¬¬-12-ç« -ç‚‰ç«çº¯é’-åŸºäºjdkå’ŒcglibåŠ¨æ€ä»£ç†-å®ç°aopæ ¸å¿ƒåŠŸèƒ½","aria-hidden":"true"},"#"),s(" ã€ŠSpring æ‰‹æ’¸ä¸“æ ã€‹ç¬¬ 12 ç« ï¼šç‚‰ç«çº¯é’ï¼ŒåŸºäºJDKå’ŒCglibåŠ¨æ€ä»£ç†ï¼Œå®ç°AOPæ ¸å¿ƒåŠŸèƒ½")],-1),r=n("br",null,null,-1),k={href:"https://bugstack.cn",target:"_blank",rel:"noopener noreferrer"},d=n("br",null,null,-1),v={href:"https://mp.weixin.qq.com/s/lDL14DMzaY_WzvmizDG-zw",target:"_blank",rel:"noopener noreferrer"},m=l(`<blockquote><p>æ²‰æ·€ã€åˆ†äº«ã€æˆé•¿ï¼Œè®©è‡ªå·±å’Œä»–äººéƒ½èƒ½æœ‰æ‰€æ”¶è·ï¼ğŸ˜„</p></blockquote><h2 id="ä¸€ã€å‰è¨€" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€å‰è¨€" aria-hidden="true">#</a> ä¸€ã€å‰è¨€</h2><p><code>ä¸ºä»€ä¹ˆï¼Œä½ çš„ä»£ç æ€»æ˜¯ç³Šåˆ°çŒªåœˆä¸Šï¼Ÿ</code></p><p>ğŸ™æ€ä¹ˆåŠï¼ŒçŸ¥é“ä½ åœ¨äº’è”ç½‘ï¼Œä¸çŸ¥é“ä½ åœ¨å“ªä¸ªå¤§å‚ã€‚çŸ¥é“ä½ åœ¨åŠ ç­ï¼Œä¸çŸ¥é“ä½ åœ¨å’Œå“ªä¸ªäº§å“äº‰è¾©ã€‚çŸ¥é“ä½ åœ¨å·æ‡’ï¼Œä¸çŸ¥é“ä½ è¦æ‘¸é±¼åˆ°å‡ ç‚¹ã€‚çŸ¥é“ä½ åœ¨æ¬ç –ï¼Œä¸çŸ¥é“ä½ åœ¨ç›–å“ªä¸ªçŒªåœˆã€‚</p><hr><p>å½“ä½ ç‰¹åˆ«è¾›è‹¦å¤œä»¥ç»§æ—¥çš„å®Œæˆç€ï¼Œæ¯å¤©ã€æ¯å‘¨ã€æ¯æœˆé‡å¤æ€§çš„å·¥ä½œæ—¶ï¼Œä½ èƒ½è·å¾—çš„æˆé•¿æ˜¯æœ€å°ï¼Œå¾—åˆ°çš„å›æŠ¥ä¹Ÿæ˜¯å°‘çš„ã€‚<em>ç•™ç€æœ€å¤šçš„æ±—ã€æ‹¿ç€æœ€å°‘çš„é’±</em></p><p>å¯èƒ½ä½ ä¸€æ¿€åŠ¨å¼€å§‹çœ‹æºç ï¼Œä½†ä¸çŸ¥é“çœ‹å®Œçš„æºç èƒ½ç”¨åˆ°ä»€ä¹ˆåœ°æ–¹ã€‚çœ‹è®¾è®¡æ¨¡å¼ï¼Œçœ‹çš„æ—¶å€™æ‡‚ï¼Œä½†æ”¹è‡ªå·±çš„ä»£ç åˆä¸‹ä¸å»æ‰‹ã€‚å…¶å®ä¸€æ–¹é¢æ˜¯æœ¬èº«æŠ€æœ¯æ ˆçš„çŸ¥è¯†é¢ä¸è¶³ï¼Œå¦å¤–ä¸€æ–¹é¢æ˜¯è‡ªå·±å‚¨å¤‡çš„ä»£ç ä¹Ÿä¸å¤Ÿã€‚æœ€ç»ˆä¹Ÿå°±å¯¼è‡´æ ¹æœ¬æ²¡æ³•æŠŠä¸€äº›åˆ—çš„çŸ¥è¯†ä¸²è”èµ·æ¥ï¼Œå°±åƒä½ <code>çœ‹äº† HashMapï¼Œä½†ä¹Ÿè”æƒ³ä¸åˆ°åˆ†åº“åˆ†è¡¨ç»„ä»¶ä¸­çš„æ•°æ®æ•£åˆ—ä¹Ÿä¼šç”¨åˆ°äº† HashMap ä¸­çš„æ‰°åŠ¨å‡½æ•°æ€æƒ³å’Œæ³Šæ¾åˆ†å¸ƒéªŒè¯</code>ã€<code>çœ‹äº†Spring æºç ï¼Œä¹Ÿè¯»ä¸å‡ºæ¥ Mybatis æ˜¯å¦‚ä½•è§£å†³åªå®šä¹‰ Dao æ¥å£å°±èƒ½ä½¿ç”¨é…ç½®æˆ–è€…æ³¨è§£å¯¹æ•°æ®åº“è¿›è¡Œ CRUD æ“ä½œ</code>ã€<code>çœ‹æ¥ JDK çš„åŠ¨æ€ä»£ç†ï¼Œä¹Ÿæƒ³ä¸åˆ° AOP æ˜¯å¦‚ä½•è®¾è®¡çš„</code>ã€‚æ‰€ä»¥æˆä½“ç³»å­¦ä¹ ï¼ŒåŠ å¼ºæŠ€æœ¯æ ˆçŸ¥è¯†çš„å®Œæ•´æ€§ï¼Œæ‰èƒ½æ›´å¥½çš„ç”¨ä¸Šè¿™äº›å­¦ä¹ åˆ°çš„ç¼–ç èƒ½åŠ›ã€‚</p><h2 id="äºŒã€ç›®æ ‡" tabindex="-1"><a class="header-anchor" href="#äºŒã€ç›®æ ‡" aria-hidden="true">#</a> äºŒã€ç›®æ ‡</h2><p>åˆ°æœ¬ç« èŠ‚æˆ‘ä»¬å°†è¦ä» IOC çš„å®ç°ï¼Œè½¬å…¥åˆ°å…³äº AOP(<code>Aspect Oriented Programming</code>) å†…å®¹çš„å¼€å‘ã€‚åœ¨è½¯ä»¶è¡Œä¸šï¼ŒAOP æ„ä¸ºï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œé€šè¿‡é¢„ç¼–è¯‘çš„æ–¹å¼å’Œè¿è¡ŒæœŸé—´åŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½åŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤ã€‚å…¶å® AOP ä¹Ÿæ˜¯ OOP çš„å»¶ç»­ï¼Œåœ¨ Spring æ¡†æ¶ä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å†…å®¹ï¼Œä½¿ç”¨ AOP å¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»ï¼Œä»è€Œä½¿å„æ¨¡å—é—´çš„ä¸šåŠ¡é€»è¾‘è€¦åˆåº¦é™ä½ï¼Œæé«˜ä»£ç çš„å¯å¤ç”¨æ€§ï¼ŒåŒæ—¶ä¹Ÿèƒ½æé«˜å¼€å‘æ•ˆç‡ã€‚</p><p>å…³äº AOP çš„æ ¸å¿ƒæŠ€æœ¯å®ç°ä¸»è¦æ˜¯åŠ¨æ€ä»£ç†çš„ä½¿ç”¨ï¼Œå°±åƒä½ å¯ä»¥ç»™ä¸€ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œä½¿ç”¨ä»£ç†çš„æ–¹å¼æ›¿æ¢æ‰è¿™ä¸ªå®ç°ç±»ï¼Œä½¿ç”¨ä»£ç†ç±»æ¥å¤„ç†ä½ éœ€è¦çš„é€»è¾‘ã€‚æ¯”å¦‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_proxy_class</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">IUserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IUserService</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">IUserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;ä½ è¢«ä»£ç†äº†ï¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»£ç†ç±»çš„å®ç°åŸºæœ¬éƒ½å¤§å®¶éƒ½è§è¿‡ï¼Œé‚£ä¹ˆæœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„æ€è·¯åï¼Œæ¥ä¸‹æ¥å°±éœ€è¦è€ƒè™‘ä¸‹æ€ä¹ˆç»™æ–¹æ³•åšä»£ç†å‘¢ï¼Œè€Œä¸æ˜¯ä»£ç†ç±»ã€‚å¦å¤–æ€ä¹ˆå»ä»£ç†æ‰€æœ‰ç¬¦åˆæŸäº›è§„åˆ™çš„æ‰€æœ‰ç±»ä¸­æ–¹æ³•å‘¢ã€‚å¦‚æœå¯ä»¥ä»£ç†æ‰æ‰€æœ‰ç±»çš„æ–¹æ³•ï¼Œå°±å¯ä»¥åšä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨ï¼Œç»™æ‰€æœ‰è¢«ä»£ç†çš„æ–¹æ³•æ·»åŠ ä¸Šä¸€äº›è‡ªå®šä¹‰å¤„ç†ï¼Œæ¯”å¦‚æ‰“å°æ—¥å¿—ã€è®°å½•è€—æ—¶ã€ç›‘æ§å¼‚å¸¸ç­‰ã€‚</p><h2 id="ä¸‰ã€æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€æ–¹æ¡ˆ" aria-hidden="true">#</a> ä¸‰ã€æ–¹æ¡ˆ</h2><p>åœ¨æŠŠ AOP æ•´ä¸ªåˆ‡é¢è®¾è®¡èåˆåˆ° Spring å‰ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼ŒåŒ…æ‹¬ï¼š<code>å¦‚ä½•ç»™ç¬¦åˆè§„åˆ™çš„æ–¹æ³•åšä»£ç†</code>ï¼Œ<code>ä»¥åŠåšå®Œä»£ç†æ–¹æ³•çš„æ¡ˆä¾‹åï¼ŒæŠŠç±»çš„èŒè´£æ‹†åˆ†å‡ºæ¥</code>ã€‚è€Œè¿™ä¸¤ä¸ªåŠŸèƒ½ç‚¹çš„å®ç°ï¼Œéƒ½æ˜¯ä»¥åˆ‡é¢çš„æ€æƒ³è¿›è¡Œè®¾è®¡å’Œå¼€å‘ã€‚å¦‚æœä¸æ˜¯å¾ˆæ¸…æ¥š AOP æ˜¯å•¥ï¼Œä½ å¯ä»¥æŠŠåˆ‡é¢ç†è§£ä¸ºç”¨åˆ€åˆ‡éŸ­èœï¼Œä¸€æ ¹ä¸€æ ¹åˆ‡æ€»æ˜¯æœ‰ç‚¹æ…¢ï¼Œé‚£ä¹ˆç”¨æ‰‹(<code>ä»£ç†</code>)æŠŠéŸ­èœææˆä¸€æŠŠï¼Œç”¨èœåˆ€æˆ–è€…æ–§å¤´è¿™æ ·ä¸åŒçš„æ‹¦æˆªæ“ä½œæ¥å¤„ç†ã€‚è€Œç¨‹åºä¸­å…¶å®ä¹Ÿæ˜¯ä¸€æ ·ï¼Œåªä¸è¿‡éŸ­èœå˜æˆäº†æ–¹æ³•ï¼Œèœåˆ€å˜æˆäº†æ‹¦æˆªæ–¹æ³•ã€‚æ•´ä½“è®¾è®¡ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://bugstack.cn/assets/images/spring/spring-12-01.png" alt=""></p><ul><li>å°±åƒä½ åœ¨ä½¿ç”¨ Spring çš„ AOP ä¸€æ ·ï¼Œåªå¤„ç†ä¸€äº›éœ€è¦è¢«æ‹¦æˆªçš„æ–¹æ³•ã€‚åœ¨æ‹¦æˆªæ–¹æ³•åï¼Œæ‰§è¡Œä½ å¯¹æ–¹æ³•çš„æ‰©å±•æ“ä½œã€‚</li><li>é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å…ˆæ¥å®ç°ä¸€ä¸ªå¯ä»¥ä»£ç†æ–¹æ³•çš„ Proxyï¼Œå…¶å®ä»£ç†æ–¹æ³•ä¸»è¦æ˜¯ä½¿ç”¨åˆ°æ–¹æ³•æ‹¦æˆªå™¨ç±»å¤„ç†æ–¹æ³•çš„è°ƒç”¨ <code>MethodInterceptor#invoke</code>ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ invoke æ–¹æ³•ä¸­çš„å…¥å‚ Method method è¿›è¡Œ <code>method.invoke(targetObj, args)</code> è¿™å—æ˜¯æ•´ä¸ªä½¿ç”¨æ—¶çš„å·®å¼‚ã€‚</li><li>é™¤äº†ä»¥ä¸Šçš„æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œè¿˜éœ€è¦ä½¿ç”¨åˆ° <code>org.aspectj.weaver.tools.PointcutParser</code> å¤„ç†æ‹¦æˆªè¡¨è¾¾å¼ <code>&quot;execution(* cn.bugstack.springframework.test.bean.IUserService.*(..))&quot;</code>ï¼Œæœ‰äº†æ–¹æ³•ä»£ç†å’Œå¤„ç†æ‹¦æˆªï¼Œæˆ‘ä»¬å°±å¯ä»¥å®Œæˆè®¾è®¡å‡ºä¸€ä¸ª AOP çš„é›å½¢äº†ã€‚</li></ul><h2 id="å››ã€å®ç°" tabindex="-1"><a class="header-anchor" href="#å››ã€å®ç°" aria-hidden="true">#</a> å››ã€å®ç°</h2><h3 id="_1-å·¥ç¨‹ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_1-å·¥ç¨‹ç»“æ„" aria-hidden="true">#</a> 1. å·¥ç¨‹ç»“æ„</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>small<span class="token operator">-</span>spring<span class="token operator">-</span>step<span class="token operator">-</span><span class="token number">11</span>
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework
    â”‚           â”œâ”€â”€ aop
    â”‚           â”‚   â”œâ”€â”€ aspectj
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">AspectJExpressionPointcut</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ framework 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AopProxy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">Cglib2AopProxy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">AdvisedSupport</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ClassFilter</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">Pointcut</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">TargetSource</span><span class="token punctuation">.</span>java
    â”‚           â”œâ”€â”€ beans
    â”‚           â”‚   â”œâ”€â”€ factory
    â”‚           â”‚   â”‚   â”œâ”€â”€ config
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanReference</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">SingletonBeanRegistry</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractAutowireCapableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractBeanDefinitionReader</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanDefinitionReader</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">CglibSubclassingInstantiationStrategy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DefaultSingletonBeanRegistry</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DisposableBeanAdapter</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">FactoryBeanRegistrySupport</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">InstantiationStrategy</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">SimpleInstantiationStrategy</span><span class="token punctuation">.</span>java  
    â”‚           â”‚   â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”‚   â””â”€â”€ <span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">Aware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanClassLoaderAware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanFactoryAware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">BeanNameAware</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">DisposableBean</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">FactoryBean</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">HierarchicalBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">InitializingBean</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">ListableBeanFactory</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">BeansException</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">PropertyValue</span><span class="token punctuation">.</span>java
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">PropertyValues</span><span class="token punctuation">.</span>java 
    â”‚           â”œâ”€â”€ context
    â”‚           â”‚   â”œâ”€â”€ event
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractApplicationEventMulticaster</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContextEvent</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationEventMulticaster</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ContextClosedEvent</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ContextRefreshedEvent</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">SimpleApplicationEventMulticaster</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ support
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractRefreshableApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">AbstractXmlApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContextAwareProcessor</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”‚   â””â”€â”€ <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContext</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationContextAware</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationEvent</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationEventPublisher</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ApplicationListener</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span>java
    â”‚           â”œâ”€â”€ core<span class="token punctuation">.</span>io
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ClassPathResource</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">DefaultResourceLoader</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">FileSystemResource</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">Resource</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â”œâ”€â”€ <span class="token class-name">ResourceLoader</span><span class="token punctuation">.</span>java 
    â”‚           â”‚   â””â”€â”€ <span class="token class-name">UrlResource</span><span class="token punctuation">.</span>java
    â”‚           â””â”€â”€ utils
    â”‚               â””â”€â”€ <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span>java
    â””â”€â”€ test
        â””â”€â”€ java
            â””â”€â”€ cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test
                â”œâ”€â”€ bean
                â”‚   â”œâ”€â”€ <span class="token class-name">IUserService</span><span class="token punctuation">.</span>java
                â”‚   â”œâ”€â”€ <span class="token class-name">UserService</span><span class="token punctuation">.</span>java
                â”‚   â””â”€â”€ <span class="token class-name">UserServiceInterceptor</span><span class="token punctuation">.</span>java
                â””â”€â”€ <span class="token class-name">ApiTest</span><span class="token punctuation">.</span>java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å·¥ç¨‹æºç </strong>ï¼š<code>å…¬ä¼—å·ã€Œbugstackè™«æ´æ ˆã€ï¼Œå›å¤ï¼šSpring ä¸“æ ï¼Œè·å–å®Œæ•´æºç </code></p><p>AOP åˆ‡ç‚¹è¡¨è¾¾å¼å’Œä½¿ç”¨ä»¥åŠåŸºäº JDK å’Œ CGLIB çš„åŠ¨æ€ä»£ç†ç±»å…³ç³»ï¼Œå¦‚å›¾ 12-2</p><p><img src="https://bugstack.cn/assets/images/spring/spring-12-02.png" alt="å›¾ 12-2"></p><ul><li>æ•´ä¸ªç±»å…³ç³»å›¾å°±æ˜¯ AOP å®ç°æ ¸å¿ƒé€»è¾‘çš„åœ°æ–¹ï¼Œä¸Šé¢éƒ¨åˆ†æ˜¯å…³äºæ–¹æ³•çš„åŒ¹é…å®ç°ï¼Œä¸‹é¢ä» AopProxy å¼€å§‹æ˜¯å…³äºæ–¹æ³•çš„ä»£ç†æ“ä½œã€‚</li><li>AspectJExpressionPointcut çš„æ ¸å¿ƒåŠŸèƒ½ä¸»è¦ä¾èµ–äº aspectj ç»„ä»¶å¹¶å¤„ç† Pointcutã€ClassFilter,ã€MethodMatcher æ¥å£å®ç°ï¼Œä¸“é—¨ç”¨äºå¤„ç†ç±»å’Œæ–¹æ³•çš„åŒ¹é…è¿‡æ»¤æ“ä½œã€‚</li><li>AopProxy æ˜¯ä»£ç†çš„æŠ½è±¡å¯¹è±¡ï¼Œå®ƒçš„å®ç°ä¸»è¦æ˜¯åŸºäº JDK çš„ä»£ç†å’Œ Cglib ä»£ç†ã€‚åœ¨å‰é¢ç« èŠ‚å…³äºå¯¹è±¡çš„å®ä¾‹åŒ– CglibSubclassingInstantiationStrategyï¼Œæˆ‘ä»¬ä¹Ÿä½¿ç”¨è¿‡ Cglib æä¾›çš„åŠŸèƒ½ã€‚</li></ul><h3 id="_2-ä»£ç†æ–¹æ³•æ¡ˆä¾‹" tabindex="-1"><a class="header-anchor" href="#_2-ä»£ç†æ–¹æ³•æ¡ˆä¾‹" aria-hidden="true">#</a> 2. ä»£ç†æ–¹æ³•æ¡ˆä¾‹</h3><p>åœ¨å®ç° AOP çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåšä¸€ä¸ªä»£ç†æ–¹æ³•çš„æ¡ˆä¾‹ï¼Œé€šè¿‡è¿™æ ·ä¸€ä¸ªå¯ä»¥æ¦‚æ‹¬ä»£ç†æ–¹æ³•çš„æ ¸å¿ƒå…¨è²Œï¼Œå¯ä»¥è®©å¤§å®¶æ›´å¥½çš„ç†è§£åç»­æ‹†è§£å„ä¸ªæ–¹æ³•ï¼Œè®¾è®¡æˆè§£è€¦åŠŸèƒ½çš„ AOP å®ç°è¿‡ç¨‹ã€‚</p><p><strong>å•å…ƒæµ‹è¯•</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_proxy_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç›®æ ‡å¯¹è±¡(å¯ä»¥æ›¿æ¢æˆä»»ä½•çš„ç›®æ ‡å¯¹è±¡)</span>
    <span class="token class-name">Object</span> targetObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// AOP ä»£ç†</span>
    <span class="token class-name">IUserService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IUserService</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetObj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ–¹æ³•åŒ¹é…å™¨</span>
        <span class="token class-name">MethodMatcher</span> methodMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJExpressionPointcut</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* cn.bugstack.springframework.test.bean.IUserService.*(..))&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>methodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetObj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ–¹æ³•æ‹¦æˆªå™¨</span>
                <span class="token class-name">MethodInterceptor</span> methodInterceptor <span class="token operator">=</span> invocation <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘æ§ - Begin By AOP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–¹æ³•åç§°ï¼š&quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–¹æ³•è€—æ—¶ï¼š&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘æ§ - End\\r\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token comment">// åå°„è°ƒç”¨</span>
                <span class="token keyword">return</span> methodInterceptor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">(</span>targetObj<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>targetObj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> proxy<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é¦–å…ˆæ•´ä¸ªæ¡ˆä¾‹çš„ç›®æ ‡æ˜¯ç»™ä¸€ä¸ª UserService å½“æˆç›®æ ‡å¯¹è±¡ï¼Œå¯¹ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•è¿›è¡Œæ‹¦æˆªæ·»åŠ ç›‘æ§ä¿¡æ¯æ‰“å°å¤„ç†ã€‚</li><li>ä»æ¡ˆä¾‹ä¸­ä½ å¯ä»¥çœ‹åˆ°æœ‰ä»£ç†çš„å®ç° Proxy.newProxyInstanceï¼Œæœ‰æ–¹æ³•çš„åŒ¹é… MethodMatcherï¼Œæœ‰åå°„çš„è°ƒç”¨ invoke(Object proxy, Method method, Object[] args)ï¼Œä¹Ÿç”¨ç”¨æˆ·è‡ªå·±æ‹¦æˆªæ–¹æ³•åçš„æ“ä½œã€‚è¿™æ ·ä¸€çœ‹å…¶å®å’Œæˆ‘ä»¬ä½¿ç”¨çš„ AOP å°±éå¸¸ç±»ä¼¼äº†ï¼Œåªä¸è¿‡ä½ åœ¨ä½¿ç”¨ AOP çš„æ—¶å€™æ˜¯æ¡†æ¶å·²ç»æä¾›æ›´å¥½çš„åŠŸèƒ½ï¼Œè¿™é‡Œæ˜¯æŠŠæ‰€æœ‰çš„æ ¸å¿ƒè¿‡ç¨‹ç»™ä½ å±•ç¤ºå‡ºæ¥äº†ã€‚</li></ul><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">Begin</span> <span class="token class-name">By</span> <span class="token constant">AOP</span>
æ–¹æ³•åç§°ï¼šqueryUserInfo
æ–¹æ³•è€—æ—¶ï¼š<span class="token number">86</span>ms
ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">End</span>

æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œ<span class="token number">100001</span>ï¼Œæ·±åœ³

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»å¯¹ UserService#queryUserInfo æ–¹æ³•è¿›è¡Œäº†æ‹¦æˆªç›‘æ§æ“ä½œï¼Œå…¶å®åé¢æˆ‘ä»¬å®ç°çš„ AOP å°±æ˜¯ç°åœ¨ä½“ç°å‡ºçš„ç»“æœï¼Œåªä¸è¿‡æˆ‘ä»¬éœ€è¦æŠŠè¿™éƒ¨åˆ†æµ‹è¯•çš„æ¡ˆä¾‹è§£è€¦ä¸ºæ›´å…·æœ‰æ‰©å±•æ€§çš„å„ä¸ªæ¨¡å—å®ç°ã€‚</li></ul><p><strong>æ‹†è§£æ¡ˆä¾‹</strong></p><p><img src="https://bugstack.cn/assets/images/spring/spring-12-03.png" alt="å›¾ 12-3"></p><ul><li>æ‹†è§£è¿‡ç¨‹å¯ä»¥å‚è€ƒæˆªå›¾ 12-3ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»£ç†å¯¹è±¡æ‹†è§£å‡ºæ¥ï¼Œå› ä¸ºå®ƒå¯ä»¥æ˜¯ JDK çš„å®ç°ä¹Ÿå¯ä»¥æ˜¯ Cglib çš„å¤„ç†ã€‚</li><li>æ–¹æ³•åŒ¹é…å™¨æ“ä½œå…¶å®å·²ç»æ˜¯ä¸€ä¸ªå•ç‹¬çš„å®ç°ç±»äº†ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜éœ€è¦æŠŠä¼ å…¥çš„ç›®æ ‡å¯¹è±¡ã€æ–¹æ³•åŒ¹é…ã€æ‹¦æˆªæ–¹æ³•ï¼Œéƒ½è¿›è¡Œç»Ÿä¸€çš„åŒ…è£…ï¼Œæ–¹ä¾¿å¤–éƒ¨è°ƒç”¨æ—¶è¿›è¡Œä¸€ä¸ªå…¥å‚é€ä¼ ã€‚</li><li>æœ€åå…¶å®æ˜¯ <code>ReflectiveMethodInvocation</code> çš„ä½¿ç”¨ï¼Œå®ƒç›®å‰å·²ç»æ˜¯å®ç° <code>MethodInvocation</code> æ¥å£çš„ä¸€ä¸ªåŒ…è£…åçš„ç±»ï¼Œå‚æ•°ä¿¡æ¯åŒ…æ‹¬ï¼šè°ƒç”¨çš„å¯¹è±¡ã€è°ƒç”¨çš„æ–¹æ³•ã€è°ƒç”¨çš„å…¥å‚ã€‚</li></ul><h3 id="_3-åˆ‡ç‚¹è¡¨è¾¾å¼" tabindex="-1"><a class="header-anchor" href="#_3-åˆ‡ç‚¹è¡¨è¾¾å¼" aria-hidden="true">#</a> 3. åˆ‡ç‚¹è¡¨è¾¾å¼</h3><p><strong>å®šä¹‰æ¥å£</strong></p><p><strong>cn.bugstack.springframework.aop.Pointcut</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Pointcut</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * Return the ClassFilter for this pointcut.
     * <span class="token keyword">@return</span> the ClassFilter (never <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token keyword">null</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>)
     */</span>
    <span class="token class-name">ClassFilter</span> <span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Return the MethodMatcher for this pointcut.
     * <span class="token keyword">@return</span> the MethodMatcher (never <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token keyword">null</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>)
     */</span>
    <span class="token class-name">MethodMatcher</span> <span class="token function">getMethodMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åˆ‡å…¥ç‚¹æ¥å£ï¼Œå®šä¹‰ç”¨äºè·å– ClassFilterã€MethodMatcher çš„ä¸¤ä¸ªç±»ï¼Œè¿™ä¸¤ä¸ªæ¥å£è·å–éƒ½æ˜¯åˆ‡ç‚¹è¡¨è¾¾å¼æä¾›çš„å†…å®¹ã€‚</li></ul><p><strong>cn.bugstack.springframework.aop.ClassFilter</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ClassFilter</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * Should the pointcut apply to the given interface or target class?
     * <span class="token keyword">@param</span> <span class="token parameter">clazz</span> the candidate target class
     * <span class="token keyword">@return</span> whether the advice should apply to the given target class
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å®šä¹‰ç±»åŒ¹é…ç±»ï¼Œç”¨äºåˆ‡ç‚¹æ‰¾åˆ°ç»™å®šçš„æ¥å£å’Œç›®æ ‡ç±»ã€‚</li></ul><p><strong>cn.bugstack.springframework.aop.MethodMatcher</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MethodMatcher</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * Perform static checking whether the given method matches. If this
     * <span class="token keyword">@return</span> whether or not this method matches statically
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ–¹æ³•åŒ¹é…ï¼Œæ‰¾åˆ°è¡¨è¾¾å¼èŒƒå›´å†…åŒ¹é…ä¸‹çš„ç›®æ ‡ç±»å’Œæ–¹æ³•ã€‚åœ¨ä¸Šæ–‡çš„æ¡ˆä¾‹ä¸­æœ‰æ‰€ä½“ç°ï¼š<code>methodMatcher.matches(method, targetObj.getClass())</code></li></ul><p><strong>å®ç°åˆ‡ç‚¹è¡¨è¾¾å¼ç±»</strong></p><p><strong>cn.bugstack.springframework.aop.aspectj.AspectJExpressionPointcut</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AspectJExpressionPointcut</span> <span class="token keyword">implements</span> <span class="token class-name">Pointcut</span><span class="token punctuation">,</span> <span class="token class-name">ClassFilter</span><span class="token punctuation">,</span> <span class="token class-name">MethodMatcher</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointcutPrimitive</span><span class="token punctuation">&gt;</span></span> <span class="token constant">SUPPORTED_PRIMITIVES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PointcutPrimitive</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token constant">SUPPORTED_PRIMITIVES</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">PointcutPrimitive</span><span class="token punctuation">.</span><span class="token constant">EXECUTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PointcutExpression</span> pointcutExpression<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AspectJExpressionPointcut</span><span class="token punctuation">(</span><span class="token class-name">String</span> expression<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">PointcutParser</span> pointcutParser <span class="token operator">=</span> <span class="token class-name">PointcutParser</span><span class="token punctuation">.</span><span class="token function">getPointcutParserSupportingSpecifiedPrimitivesAndUsingSpecifiedClassLoaderForResolution</span><span class="token punctuation">(</span><span class="token constant">SUPPORTED_PRIMITIVES</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pointcutExpression <span class="token operator">=</span> pointcutParser<span class="token punctuation">.</span><span class="token function">parsePointcutExpression</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pointcutExpression<span class="token punctuation">.</span><span class="token function">couldMatchJoinPointsInType</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pointcutExpression<span class="token punctuation">.</span><span class="token function">matchesMethodExecution</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">alwaysMatches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ClassFilter</span> <span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MethodMatcher</span> <span class="token function">getMethodMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åˆ‡ç‚¹è¡¨è¾¾å¼å®ç°äº† Pointcutã€ClassFilterã€MethodMatcherï¼Œä¸‰ä¸ªæ¥å£å®šä¹‰æ–¹æ³•ï¼ŒåŒæ—¶è¿™ä¸ªç±»ä¸»è¦æ˜¯å¯¹ aspectj åŒ…æä¾›çš„è¡¨è¾¾å¼æ ¡éªŒæ–¹æ³•ä½¿ç”¨ã€‚</li><li>åŒ¹é… matchesï¼š<code>pointcutExpression.couldMatchJoinPointsInType(clazz)</code>ã€<code>pointcutExpression.matchesMethodExecution(method).alwaysMatches()</code>ï¼Œè¿™éƒ¨åˆ†å†…å®¹å¯ä»¥å•ç‹¬æµ‹è¯•éªŒè¯ã€‚</li></ul><p><strong>åŒ¹é…éªŒè¯</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_aop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchMethodException</span> <span class="token punctuation">{</span>
    <span class="token class-name">AspectJExpressionPointcut</span> pointcut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJExpressionPointcut</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* cn.bugstack.springframework.test.bean.UserService.*(..))&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserService</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token class-name">Method</span> method <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;queryUserInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pointcut<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pointcut<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          
    
    <span class="token comment">// trueã€true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿™é‡Œå•ç‹¬æä¾›å‡ºæ¥ä¸€ä¸ªåŒ¹é…æ–¹æ³•çš„éªŒè¯æµ‹è¯•ï¼Œå¯ä»¥çœ‹çœ‹ä½ æ‹¦æˆªçš„æ–¹æ³•ä¸å¯¹åº”çš„å¯¹è±¡æ˜¯å¦åŒ¹é…ã€‚</li></ul><h3 id="_4-åŒ…è£…åˆ‡é¢é€šçŸ¥ä¿¡æ¯" tabindex="-1"><a class="header-anchor" href="#_4-åŒ…è£…åˆ‡é¢é€šçŸ¥ä¿¡æ¯" aria-hidden="true">#</a> 4. åŒ…è£…åˆ‡é¢é€šçŸ¥ä¿¡æ¯</h3><p><strong>cn.bugstack.springframework.aop.AdvisedSupport</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AdvisedSupport</span> <span class="token punctuation">{</span>

    <span class="token comment">// è¢«ä»£ç†çš„ç›®æ ‡å¯¹è±¡</span>
    <span class="token keyword">private</span> <span class="token class-name">TargetSource</span> targetSource<span class="token punctuation">;</span>
    <span class="token comment">// æ–¹æ³•æ‹¦æˆªå™¨</span>
    <span class="token keyword">private</span> <span class="token class-name">MethodInterceptor</span> methodInterceptor<span class="token punctuation">;</span>
    <span class="token comment">// æ–¹æ³•åŒ¹é…å™¨(æ£€æŸ¥ç›®æ ‡æ–¹æ³•æ˜¯å¦ç¬¦åˆé€šçŸ¥æ¡ä»¶)</span>
    <span class="token keyword">private</span> <span class="token class-name">MethodMatcher</span> methodMatcher<span class="token punctuation">;</span>
    
    <span class="token comment">// ...get/set</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>AdvisedSupportï¼Œä¸»è¦æ˜¯ç”¨äºæŠŠä»£ç†ã€æ‹¦æˆªã€åŒ¹é…çš„å„é¡¹å±æ€§åŒ…è£…åˆ°ä¸€ä¸ªç±»ä¸­ï¼Œæ–¹ä¾¿åœ¨ Proxy å®ç°ç±»è¿›è¡Œä½¿ç”¨ã€‚<em>è¿™å’Œä½ çš„ä¸šåŠ¡å¼€å‘ä¸­åŒ…è£…å…¥å‚æ˜¯ä¸€ä¸ªé“ç†</em></li><li>TargetSourceï¼Œæ˜¯ä¸€ä¸ªç›®æ ‡å¯¹è±¡ï¼Œåœ¨ç›®æ ‡å¯¹è±¡ç±»ä¸­æä¾› Object å…¥å‚å±æ€§ï¼Œä»¥åŠè·å–ç›®æ ‡ç±» TargetClass ä¿¡æ¯ã€‚</li><li>MethodInterceptorï¼Œæ˜¯ä¸€ä¸ªå…·ä½“æ‹¦æˆªæ–¹æ³•å®ç°ç±»ï¼Œç”±ç”¨æˆ·è‡ªå·±å®ç° MethodInterceptor#invoke æ–¹æ³•ï¼Œåšå…·ä½“çš„å¤„ç†ã€‚<em>åƒæˆ‘ä»¬æœ¬æ–‡çš„æ¡ˆä¾‹ä¸­æ˜¯åšæ–¹æ³•ç›‘æ§å¤„ç†</em></li><li>MethodMatcherï¼Œæ˜¯ä¸€ä¸ªåŒ¹é…æ–¹æ³•çš„æ“ä½œï¼Œè¿™ä¸ªå¯¹è±¡ç”± AspectJExpressionPointcut æä¾›æœåŠ¡ã€‚</li></ul><h3 id="_5-ä»£ç†æŠ½è±¡å®ç°-jdk-cglib" tabindex="-1"><a class="header-anchor" href="#_5-ä»£ç†æŠ½è±¡å®ç°-jdk-cglib" aria-hidden="true">#</a> 5. ä»£ç†æŠ½è±¡å®ç°(JDK&amp;Cglib)</h3><p><strong>å®šä¹‰æ¥å£</strong></p><p><strong>cn.bugstack.springframework.aop.framework</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AopProxy</span> <span class="token punctuation">{</span>

    <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å®šä¹‰ä¸€ä¸ªæ ‡å‡†æ¥å£ï¼Œç”¨äºè·å–ä»£ç†ç±»ã€‚å› ä¸ºå…·ä½“å®ç°ä»£ç†çš„æ–¹å¼å¯ä»¥æœ‰ JDK æ–¹å¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ Cglib æ–¹å¼ï¼Œæ‰€ä»¥å®šä¹‰æ¥å£ä¼šæ›´åŠ æ–¹ä¾¿ç®¡ç†å®ç°ç±»ã€‚</li></ul><p><strong>cn.bugstack.springframework.aop.framework.JdkDynamicAopProxy</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdkDynamicAopProxy</span> <span class="token keyword">implements</span> <span class="token class-name">AopProxy</span><span class="token punctuation">,</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AdvisedSupport</span> advised<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span> advised<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advised <span class="token operator">=</span> advised<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advised<span class="token punctuation">.</span><span class="token function">getMethodMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">MethodInterceptor</span> methodInterceptor <span class="token operator">=</span> advised<span class="token punctuation">.</span><span class="token function">getMethodInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> methodInterceptor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">(</span>advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åŸºäº JDK å®ç°çš„ä»£ç†ç±»ï¼Œéœ€è¦å®ç°æ¥å£ AopProxyã€InvocationHandlerï¼Œè¿™æ ·å°±å¯ä»¥æŠŠä»£ç†å¯¹è±¡ getProxy å’Œåå°„è°ƒç”¨æ–¹æ³• invoke åˆ†å¼€å¤„ç†äº†ã€‚</li><li>getProxy æ–¹æ³•ä¸­çš„æ˜¯ä»£ç†ä¸€ä¸ªå¯¹è±¡çš„æ“ä½œï¼Œéœ€è¦æä¾›å…¥å‚ ClassLoaderã€AdvisedSupportã€å’Œå½“å‰è¿™ä¸ªç±» thisï¼Œå› ä¸ºè¿™ä¸ªç±»æä¾›äº† invoke æ–¹æ³•ã€‚</li><li>invoke æ–¹æ³•ä¸­ä¸»è¦å¤„ç†åŒ¹é…çš„æ–¹æ³•åï¼Œä½¿ç”¨ç”¨æˆ·è‡ªå·±æä¾›çš„æ–¹æ³•æ‹¦æˆªå®ç°ï¼Œåšåå°„è°ƒç”¨ methodInterceptor.invoke ã€‚</li><li>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ª ReflectiveMethodInvocationï¼Œå…¶ä»–å®ƒå°±æ˜¯ä¸€ä¸ªå…¥å‚çš„åŒ…è£…ä¿¡æ¯ï¼Œæä¾›äº†å…¥å‚å¯¹è±¡ï¼šç›®æ ‡å¯¹è±¡ã€æ–¹æ³•ã€å…¥å‚ã€‚</li></ul><p><strong>cn.bugstack.springframework.aop.framework.Cglib2AopProxy</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Cglib2AopProxy</span> <span class="token keyword">implements</span> <span class="token class-name">AopProxy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AdvisedSupport</span> advised<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Cglib2AopProxy</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span> advised<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advised <span class="token operator">=</span> advised<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setInterfaces</span><span class="token punctuation">(</span>advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DynamicAdvisedInterceptor</span><span class="token punctuation">(</span>advised<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DynamicAdvisedInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
            <span class="token class-name">CglibMethodInvocation</span> methodInvocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CglibMethodInvocation</span><span class="token punctuation">(</span>advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">,</span> objects<span class="token punctuation">,</span> methodProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>advised<span class="token punctuation">.</span><span class="token function">getMethodMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> advised<span class="token punctuation">.</span><span class="token function">getMethodInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>methodInvocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> methodInvocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CglibMethodInvocation</span> <span class="token keyword">extends</span> <span class="token class-name">ReflectiveMethodInvocation</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methodProxy<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åŸºäº Cglib ä½¿ç”¨ Enhancer ä»£ç†çš„ç±»å¯ä»¥åœ¨è¿è¡ŒæœŸé—´ä¸ºæ¥å£ä½¿ç”¨åº•å±‚ ASM å­—èŠ‚ç å¢å¼ºæŠ€æœ¯å¤„ç†å¯¹è±¡çš„ä»£ç†å¯¹è±¡ç”Ÿæˆï¼Œå› æ­¤è¢«ä»£ç†ç±»ä¸éœ€è¦å®ç°ä»»ä½•æ¥å£ã€‚</li><li>å…³äºæ‰©å±•è¿›å»çš„ç”¨æˆ·æ‹¦æˆªæ–¹æ³•ï¼Œä¸»è¦æ˜¯åœ¨ Enhancer#setCallback ä¸­å¤„ç†ï¼Œç”¨æˆ·è‡ªå·±çš„æ–°å¢çš„æ‹¦æˆªå¤„ç†ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ° DynamicAdvisedInterceptor#intercept åŒ¹é…æ–¹æ³•ååšäº†ç›¸åº”çš„åå°„æ“ä½œã€‚</li></ul><h2 id="äº”ã€æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#äº”ã€æµ‹è¯•" aria-hidden="true">#</a> äº”ã€æµ‹è¯•</h2><h3 id="_1-äº‹å…ˆå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#_1-äº‹å…ˆå‡†å¤‡" aria-hidden="true">#</a> 1. äº‹å…ˆå‡†å¤‡</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">implements</span> <span class="token class-name">IUserService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;å°å‚…å“¥ï¼Œ100001ï¼Œæ·±åœ³&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;æ³¨å†Œç”¨æˆ·ï¼š&quot;</span> <span class="token operator">+</span> userName <span class="token operator">+</span> <span class="token string">&quot; successï¼&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åœ¨ UserService ä¸­æä¾›äº†2ä¸ªä¸åŒæ–¹æ³•ï¼Œå¦å¤–ä½ è¿˜å¯ä»¥å¢åŠ æ–°çš„ç±»æ¥åŠ å…¥æµ‹è¯•ã€‚åé¢æˆ‘ä»¬çš„æµ‹è¯•è¿‡ç¨‹ï¼Œä¼šç»™è¿™ä¸ªä¸¤ä¸ªæ–¹æ³•æ·»åŠ æˆ‘ä»¬çš„æ‹¦æˆªå¤„ç†ï¼Œæ‰“å°æ–¹æ³•æ‰§è¡Œè€—æ—¶ã€‚</li></ul><h3 id="_2-è‡ªå®šä¹‰æ‹¦æˆªæ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_2-è‡ªå®šä¹‰æ‹¦æˆªæ–¹æ³•" aria-hidden="true">#</a> 2. è‡ªå®šä¹‰æ‹¦æˆªæ–¹æ³•</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘æ§ - Begin By AOP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–¹æ³•åç§°ï¼š&quot;</span> <span class="token operator">+</span> invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–¹æ³•è€—æ—¶ï¼š&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ç›‘æ§ - End\\r\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ç”¨æˆ·è‡ªå®šä¹‰çš„æ‹¦æˆªæ–¹æ³•éœ€è¦å®ç° MethodInterceptor æ¥å£çš„ invoke æ–¹æ³•ï¼Œä½¿ç”¨æ–¹å¼ä¸ Spring AOP éå¸¸ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯åŒ…è£… invocation.proceed() æ”¾è¡Œï¼Œå¹¶åœ¨ finally ä¸­æ·»åŠ ç›‘æ§ä¿¡æ¯ã€‚</li></ul><h3 id="_3-å•å…ƒæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_3-å•å…ƒæµ‹è¯•" aria-hidden="true">#</a> 3. å•å…ƒæµ‹è¯•</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_dynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç›®æ ‡å¯¹è±¡</span>
    <span class="token class-name">IUserService</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     

    <span class="token comment">// ç»„è£…ä»£ç†ä¿¡æ¯</span>
    <span class="token class-name">AdvisedSupport</span> advisedSupport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AdvisedSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    advisedSupport<span class="token punctuation">.</span><span class="token function">setTargetSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TargetSource</span><span class="token punctuation">(</span>userService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    advisedSupport<span class="token punctuation">.</span><span class="token function">setMethodInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserServiceInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    advisedSupport<span class="token punctuation">.</span><span class="token function">setMethodMatcher</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AspectJExpressionPointcut</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* cn.bugstack.springframework.test.bean.IUserService.*(..))&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ä»£ç†å¯¹è±¡(JdkDynamicAopProxy)</span>
    <span class="token class-name">IUserService</span> proxy_jdk <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IUserService</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>advisedSupport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æµ‹è¯•è°ƒç”¨</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š&quot;</span> <span class="token operator">+</span> proxy_jdk<span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ä»£ç†å¯¹è±¡(Cglib2AopProxy)</span>
    <span class="token class-name">IUserService</span> proxy_cglib <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IUserService</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Cglib2AopProxy</span><span class="token punctuation">(</span>advisedSupport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æµ‹è¯•è°ƒç”¨</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æµ‹è¯•ç»“æœï¼š&quot;</span> <span class="token operator">+</span> proxy_cglib<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">&quot;èŠ±èŠ±&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ•´ä¸ªæ¡ˆä¾‹æµ‹è¯•äº† AOP åœ¨äº Spring ç»“åˆå‰çš„æ ¸å¿ƒä»£ç ï¼ŒåŒ…æ‹¬ä»€ä¹ˆæ˜¯ç›®æ ‡å¯¹è±¡ã€æ€ä¹ˆç»„è£…ä»£ç†ä¿¡æ¯ã€å¦‚ä½•è°ƒç”¨ä»£ç†å¯¹è±¡ã€‚</li><li>AdvisedSupportï¼ŒåŒ…è£…äº†ç›®æ ‡å¯¹è±¡ã€ç”¨æˆ·è‡ªå·±å®ç°çš„æ‹¦æˆªæ–¹æ³•ä»¥åŠæ–¹æ³•åŒ¹é…è¡¨è¾¾å¼ã€‚</li><li>ä¹‹åå°±æ˜¯åˆ†åˆ«è°ƒç”¨ JdkDynamicAopProxyã€Cglib2AopProxyï¼Œä¸¤ä¸ªä¸åŒæ–¹å¼å®ç°çš„ä»£ç†ç±»ï¼Œçœ‹çœ‹æ˜¯å¦å¯ä»¥æˆåŠŸæ‹¦æˆªæ–¹æ³•</li></ul><p><strong>æµ‹è¯•ç»“æœ</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">Begin</span> <span class="token class-name">By</span> <span class="token constant">AOP</span>
æ–¹æ³•åç§°ï¼š<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>IUserService</span><span class="token punctuation">.</span><span class="token function">queryUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
æ–¹æ³•è€—æ—¶ï¼š<span class="token number">86</span>ms
ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">End</span>

æµ‹è¯•ç»“æœï¼šå°å‚…å“¥ï¼Œ<span class="token number">100001</span>ï¼Œæ·±åœ³
ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">Begin</span> <span class="token class-name">By</span> <span class="token constant">AOP</span>
æ–¹æ³•åç§°ï¼š<span class="token keyword">public</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span> <span class="token class-name"><span class="token namespace">cn<span class="token punctuation">.</span>bugstack<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">)</span>
æ–¹æ³•è€—æ—¶ï¼š<span class="token number">97</span>ms
ç›‘æ§ <span class="token operator">-</span> <span class="token class-name">End</span>

æµ‹è¯•ç»“æœï¼šæ³¨å†Œç”¨æˆ·ï¼šèŠ±èŠ± successï¼

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å¦‚ AOP åŠŸèƒ½å®šä¹‰ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™æ ·çš„ä»£ç†æ–¹å¼ã€æ–¹æ³•åŒ¹é…å’Œæ‹¦æˆªåï¼Œåœ¨å¯¹åº”çš„ç›®æ ‡æ–¹æ³•ä¸‹ï¼Œåšäº†æ‹¦æˆªæ“ä½œè¿›è¡Œç›‘æ§ä¿¡æ¯æ‰“å°ã€‚</li></ul><h2 id="å…­ã€æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#å…­ã€æ€»ç»“" aria-hidden="true">#</a> å…­ã€æ€»ç»“</h2><ul><li>ä»æœ¬æ–‡å¯¹ Proxy#newProxyInstanceã€MethodInterceptor#invokeï¼Œçš„ä½¿ç”¨éªŒè¯åˆ‡é¢æ ¸å¿ƒåŸç†ä»¥åŠå†æŠŠåŠŸèƒ½æ‹†è§£åˆ° Spring æ¡†æ¶å®ç°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªè²Œä¼¼å¤æ‚çš„æŠ€æœ¯å…¶å®æ ¸å¿ƒå†…å®¹å¾€å¾€æ²¡æœ‰å¤ªå¤šï¼Œä½†å› ä¸ºéœ€è¦ä¸ºäº†æ»¡è¶³åç»­æ›´å¤šçš„æ‰©å±•å°±éœ€è¦è¿›è¡ŒèŒè´£è§£è€¦å’ŒåŒ…è£…ï¼Œé€šè¿‡è¿™æ ·è®¾è®¡æ¨¡å¼çš„ä½¿ç”¨ï¼Œä»¥æ­¤è®©è°ƒç”¨æ–¹èƒ½æ›´åŠ ç®€åŒ–ï¼Œè‡ªèº«ä¹Ÿå¯ä»¥ä¸æ–­æŒ‰éœ€æ‰©å±•ã€‚</li><li>AOP çš„åŠŸèƒ½å®ç°ç›®å‰è¿˜æ²¡æœ‰ä¸ Spring ç»“åˆï¼Œåªæ˜¯å¯¹åˆ‡é¢æŠ€æœ¯çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œä½ å¯ä»¥å…ˆå­¦ä¹ åˆ°å¦‚ä½•å¤„ç†ä»£ç†å¯¹è±¡ã€è¿‡æ»¤æ–¹æ³•ã€æ‹¦æˆªæ–¹æ³•ï¼Œä»¥åŠä½¿ç”¨ Cglib å’Œ JDK ä»£ç†çš„åŒºåˆ«ï¼Œå…¶å®è¿™ä¸çš„æŠ€æœ¯ä¸åªæ˜¯åœ¨ Spring æ¡†æ¶ä¸­æœ‰æ‰€ä½“ç°ï¼Œåœ¨å…¶ä»–å„ç±»éœ€è¦å‡å°‘äººå·¥ç¡¬ç¼–ç çš„åœºæ™¯ä¸‹ï¼Œéƒ½ä¼šç”¨åˆ°ã€‚<em>æ¯”å¦‚RPCã€Mybatisã€MQã€åˆ†å¸ƒå¼ä»»åŠ¡</em></li><li>ä¸€äº›æ ¸å¿ƒæŠ€æœ¯çš„ä½¿ç”¨ä¸Šï¼Œéƒ½æ˜¯å…·æœ‰å¾ˆå¼ºçš„å…³è”æ€§çš„ï¼Œå®ƒä»¬ä¹Ÿä¸æ˜¯å­¤ç«‹å­˜åœ¨çš„ã€‚è€Œè¿™ä¸ªèƒ½æŠŠæ•´ä¸ªæŠ€æœ¯æ ˆä¸²è”èµ·æ¥çš„è¿‡ç¨‹ï¼Œéœ€è¦ä½ æ¥å¤§é‡çš„å­¦ä¹ ã€ç§¯ç´¯ã€ç”±ç‚¹åˆ°é¢çš„é“ºè®¾ï¼Œæ‰èƒ½åœ¨ä¸€ä¸ªçŸ¥è¯†ç‚¹çš„å­¦ä¹ æ‹“å±•åˆ°ä¸€ä¸ªçŸ¥è¯†é¢å’ŒçŸ¥è¯†ä½“ç³»çš„å»ºè®¾ã€‚</li></ul><h2 id="ä¸ƒã€ä¼˜ç§€ä½œä¸š" tabindex="-1"><a class="header-anchor" href="#ä¸ƒã€ä¼˜ç§€ä½œä¸š" aria-hidden="true">#</a> ä¸ƒã€ä¼˜ç§€ä½œä¸š</h2>`,83),b={href:"https://t.zsxq.com/06feIU3fe",target:"_blank",rel:"noopener noreferrer"},g={href:"https://t.zsxq.com/09CbW8E6P",target:"_blank",rel:"noopener noreferrer"},h={href:"https://t.zsxq.com/0aPKwaowf",target:"_blank",rel:"noopener noreferrer"},y={href:"https://t.zsxq.com/0berIUtme",target:"_blank",rel:"noopener noreferrer"},f={href:"https://t.zsxq.com/0bkVGZTiH",target:"_blank",rel:"noopener noreferrer"};function w(j,x){const a=p("ExternalLinkIcon");return c(),o("div",null,[u,n("p",null,[s("ä½œè€…ï¼šå°å‚…å“¥ "),r,s("åšå®¢ï¼š"),n("a",k,[s("https://bugstack.cn"),t(a)]),d,s("åŸæ–‡ï¼š"),n("a",v,[s("https://mp.weixin.qq.com/s/lDL14DMzaY_WzvmizDG-zw"),t(a)])]),m,n("ul",null,[n("li",null,[n("a",b,[s("jdkå’ŒcglibåŠ¨æ€ä»£ç† @Chin"),t(a)])]),n("li",null,[n("a",g,[s("åœ¨åˆ›å»ºå¯¹è±¡ä¹‹å‰,éœ€è¦å‰åˆ¤æ–­å¯¹è±¡æ˜¯å¦éœ€è¦ä»£ç† @Liuliuliu"),t(a)])]),n("li",null,[n("a",h,[s("å‰æœŸåœ¨Springå½“ä¸­æ¶‰åŠåˆ°äº†JDKå’ŒCglibçš„åŠ¨æ€ä»£ç†ï¼Œä»Šå¤©è¯¦ç»†åœ°è¿›è¡Œäº†ä¸€ä¸ªå­¦ä¹  @åœ¨ä¹æœˆ"),t(a)])]),n("li",null,[n("a",y,[s("æŠŠ AOP æ‰©å±•åˆ° Bean çš„ç”Ÿå‘½å‘¨æœŸé‡Œ @lucien"),t(a)])]),n("li",null,[n("a",f,[s("AOP æ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†ã€é™æ€ä»£ç†ï¼Ÿ @çˆ±å¥‹æ–—çš„å°é²¨é±¼"),t(a)])])])])}const S=e(i,[["render",w],["__file","2021-07-13-di12zhangï¼šluhuochunqingï¼ŒjiyuJDKheCglibdongtaidailiï¼ŒshixianAOPhexingongnen.html.vue"]]);export{S as default};
