import{_ as n,o as a,c as s,e}from"./app-3RcBQnkC.js";const o="data:image/png;base64,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",t={},p=e(`<h1 id="hystrix-隔离策略细粒度控制" tabindex="-1"><a class="header-anchor" href="#hystrix-隔离策略细粒度控制" aria-hidden="true">#</a> Hystrix 隔离策略细粒度控制</h1><p>Hystrix 实现资源隔离，有两种策略：</p><ul><li>线程池隔离</li><li>信号量隔离</li></ul><p>对资源隔离这一块东西，其实可以做一定细粒度的一些控制。</p><h3 id="execution-isolation-strategy" tabindex="-1"><a class="header-anchor" href="#execution-isolation-strategy" aria-hidden="true">#</a> execution.isolation.strategy</h3><p>指定了 HystrixCommand.run() 的资源隔离策略：<code>THREAD</code> or <code>SEMAPHORE</code>，一种基于线程池，一种基于信号量。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// to use thread isolation</span>
<span class="token class-name">HystrixCommandProperties<span class="token punctuation">.</span>Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withExecutionIsolationStrategy</span><span class="token punctuation">(</span><span class="token class-name">ExecutionIsolationStrategy</span><span class="token punctuation">.</span><span class="token constant">THREAD</span><span class="token punctuation">)</span>

<span class="token comment">// to use semaphore isolation</span>
<span class="token class-name">HystrixCommandProperties<span class="token punctuation">.</span>Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withExecutionIsolationStrategy</span><span class="token punctuation">(</span><span class="token class-name">ExecutionIsolationStrategy</span><span class="token punctuation">.</span><span class="token constant">SEMAPHORE</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>线程池机制，每个 command 运行在一个线程中，限流是通过线程池的大小来控制的；信号量机制，command 是运行在调用线程中（也就是 Tomcat 的线程池），通过信号量的容量来进行限流。</p><p>如何在线程池和信号量之间做选择？</p><p><strong>默认的策略</strong>就是线程池。</p><p><strong>线程池</strong>其实最大的好处就是对于网络访问请求，如果有超时的话，可以避免调用线程阻塞住。</p><p>而使用信号量的场景，通常是针对超大并发量的场景下，每个服务实例每秒都几百的 <code>QPS</code>，那么此时你用线程池的话，线程一般不会太多，可能撑不住那么高的并发，如果要撑住，可能要耗费大量的线程资源，那么就是用信号量，来进行限流保护。一般用信号量常见于那种基于纯内存的一些业务逻辑服务，而不涉及到任何网络访问请求。</p><h3 id="command-key-command-group" tabindex="-1"><a class="header-anchor" href="#command-key-command-group" aria-hidden="true">#</a> command key &amp; command group</h3><p>我们使用线程池隔离，要怎么对<strong>依赖服务</strong>、<strong>依赖服务接口</strong>、<strong>线程池</strong>三者做划分呢？</p><p>每一个 command，都可以设置一个自己的名称 command key，同时可以设置一个自己的组 command group。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Setter</span> cachedSetter <span class="token operator">=</span> <span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey<span class="token punctuation">.</span>Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">&quot;ExampleGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                 <span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandKey<span class="token punctuation">.</span>Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">CommandHelloWorld</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>cachedSetter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>command group 是一个非常重要的概念，默认情况下，就是通过 command group 来定义一个线程池的，而且还会通过 command group 来聚合一些监控和报警信息。同一个 command group 中的请求，都会进入同一个线程池中。</p><h3 id="command-thread-pool" tabindex="-1"><a class="header-anchor" href="#command-thread-pool" aria-hidden="true">#</a> command thread pool</h3><p>ThreadPoolKey 代表了一个 HystrixThreadPool，用来进行统一监控、统计、缓存。默认的 ThreadPoolKey 就是 command group 的名称。每个 command 都会跟它的 ThreadPoolKey 对应的 ThreadPool 绑定在一起。</p><p>如果不想直接用 command group，也可以手动设置 ThreadPool 的名称。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Setter</span> cachedSetter <span class="token operator">=</span> <span class="token class-name">Setter</span><span class="token punctuation">.</span><span class="token function">withGroupKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandGroupKey<span class="token punctuation">.</span>Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">&quot;ExampleGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                 <span class="token punctuation">.</span><span class="token function">andCommandKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixCommandKey<span class="token punctuation">.</span>Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                 <span class="token punctuation">.</span><span class="token function">andThreadPoolKey</span><span class="token punctuation">(</span><span class="token class-name">HystrixThreadPoolKey<span class="token punctuation">.</span>Factory</span><span class="token punctuation">.</span><span class="token function">asKey</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorldPool&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">CommandHelloWorld</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>cachedSetter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="command-key-command-group-command-thread-pool" tabindex="-1"><a class="header-anchor" href="#command-key-command-group-command-thread-pool" aria-hidden="true">#</a> command key &amp; command group &amp; command thread pool</h3><p><strong>command key</strong> ，代表了一类 command，一般来说，代表了下游依赖服务的某个接口。</p><p><strong>command group</strong> ，代表了某一个下游依赖服务，这是很合理的，一个依赖服务可能会暴露出来多个接口，每个接口就是一个 command key。command group 在逻辑上对一堆 command key 的调用次数、成功次数、timeout 次数、失败次数等进行统计，可以看到某一个服务整体的一些访问情况。<strong>一般来说，推荐根据一个服务区划分出一个线程池，command key 默认都是属于同一个线程池的。</strong></p><p>比如说有一个服务 A，你估算出来服务 A 每秒所有接口加起来的整体 <code>QPS</code> 在 100 左右，你有一个服务 B 去调用服务 A。你的服务 B 部署了 10 个实例，每个实例上，用 command group 去对应下游服务 A。给一个线程池，量大概是 10 就可以了，这样服务 B 对服务 A 整体的访问 QPS 就大概是每秒 100 了。</p><p>但是，如果说 command group 对应了一个服务，而这个服务暴露出来的几个接口，访问量很不一样，差异非常之大。你可能就希望在这个服务对应 command group 的内部，包含对应多个接口的 command key，做一些细粒度的资源隔离。<strong>就是说，希望对同一个服务的不同接口，使用不同的线程池。</strong></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>command key -&gt; command group

command key -&gt; 自己的 thread pool key
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>逻辑上来说，多个 command key 属于一个 command group，在做统计的时候，会放在一起统计。每个 command key 有自己的线程池，每个接口有自己的线程池，去做资源隔离和限流。</p><p>说白点，就是说如果你的 command key 要用自己的线程池，可以定义自己的 thread pool key，就 ok 了。</p><h3 id="coresize" tabindex="-1"><a class="header-anchor" href="#coresize" aria-hidden="true">#</a> coreSize</h3><p>设置线程池的大小，默认是 10。一般来说，用这个默认的 10 个线程大小就够了。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">HystrixThreadPoolProperties<span class="token punctuation">.</span>Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withCoreSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="queuesizerejectionthreshold" tabindex="-1"><a class="header-anchor" href="#queuesizerejectionthreshold" aria-hidden="true">#</a> queueSizeRejectionThreshold</h3><p>如果说线程池中的 10 个线程都在工作中，没有空闲的线程来做其它的事情，此时再有请求过来，会先进入队列积压。如果说队列积压满了，再有请求过来，就直接 reject，拒绝请求，执行 fallback 降级的逻辑，快速返回。</p><p><img src="`+o+`" alt="hystrix-thread-pool-queue"></p><p>控制 queue 满了之后 reject 的 threshold，因为 maxQueueSize 不允许热修改，因此提供这个参数可以热修改，控制队列的最大大小。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">HystrixThreadPoolProperties<span class="token punctuation">.</span>Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withQueueSizeRejectionThreshold</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="execution-isolation-semaphore-maxconcurrentrequests" tabindex="-1"><a class="header-anchor" href="#execution-isolation-semaphore-maxconcurrentrequests" aria-hidden="true">#</a> execution.isolation.semaphore.maxConcurrentRequests</h3><p>设置使用 SEMAPHORE 隔离策略的时候允许访问的最大并发量，超过这个最大并发量，请求直接被 reject。</p><p>这个并发量的设置，跟线程池大小的设置，应该是类似的，但是基于信号量的话，性能会好很多，而且 Hystrix 框架本身的开销会小很多。</p><p>默认值是 10，尽量设置的小一些，因为一旦设置的太大，而且有延时发生，可能瞬间导致 tomcat 本身的线程资源被占满。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">HystrixCommandProperties<span class="token punctuation">.</span>Setter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withExecutionIsolationSemaphoreMaxConcurrentRequests</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,42),c=[p];function i(l,u){return a(),s("div",null,c)}const d=n(t,[["render",i],["__file","hystrix-execution-isolation.html.vue"]]);export{d as default};
